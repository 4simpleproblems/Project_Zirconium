<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DASHBOARD</title>
    <!-- Local font stylesheet -->
    <link rel="stylesheet" href="fontface.css">
    <link rel="stylesheet" href="main.css">
    <!-- Icon library for widgets -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase for demonstration -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="injector.js"></script>
    <script>
        // Mock Firebase config for demonstration purposes
        const firebaseConfig = {
            apiKey: "AIzaSy...Example",
            authDomain: "example.firebaseapp.com",
            projectId: "example-project"
        };
        firebase.initializeApp(firebaseConfig);
    </script>
</head>
<body class="dark-mode">

    <!-- The main content is the redesigned dashboard -->
    <main id="main-content" class="main-content fade-in p-4 md:p-8">
      <div class="dashboard-header">
        <h2 class="dashboard-title">Dashboard</h2>
      </div>

      <div class="dashboard-grid" id="dashboardGrid">
        <!-- New, redesigned widgets will be dynamically inserted here by the script -->
      </div>
    </main>

    <script src="navbar-loading.js"></script>

    <!-- In-line script to control the new dashboard widgets -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dashboardGrid = document.getElementById('dashboardGrid');

            // --- WIDGET TEMPLATES & LOGIC ---

            const WIDGET_CONFIG = [
                {
                    widgetId: 'greeting_widget',
                    gridSpan: 'md:col-span-2',
                    onMount: (cardElement) => {
                        const timeEl = cardElement.querySelector('.widget-time');
                        const dateEl = cardElement.querySelector('.widget-date');
                        const greetingEl = cardElement.querySelector('.widget-greeting');

                        function updateTime() {
                            const now = new Date();
                            const hour = now.getHours();

                            if (hour < 12) {
                                greetingEl.textContent = 'Good Morning';
                            } else if (hour < 18) {
                                greetingEl.textContent = 'Good Afternoon';
                            } else {
                                greetingEl.textContent = 'Good Evening';
                            }
                            
                            timeEl.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            dateEl.textContent = now.toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' });
                        }
                        updateTime();
                        setInterval(updateTime, 60000); // Update every minute
                    }
                },
                {
                    widgetId: 'weather_widget',
                    gridSpan: 'md:col-span-2',
                    headerContent: `<button class="widget-settings-btn"><i data-lucide="settings-2" class="w-5 h-5"></i></button>`,
                    onMount: (cardElement) => {
                        const locationEl = cardElement.querySelector('.weather-location');
                        const tempEl = cardElement.querySelector('.weather-temp');
                        const iconEl = cardElement.querySelector('.weather-icon');
                        const conditionEl = cardElement.querySelector('.weather-condition');
                        
                        const WMO_ICONS = { 0: 'sun', 1: 'sun', 2: 'cloud-sun', 3: 'cloud', 45: 'cloud-fog', 48: 'cloud-fog', 51: 'cloud-drizzle', 53: 'cloud-drizzle', 55: 'cloud-drizzle', 56: 'cloud-drizzle', 57: 'cloud-drizzle', 61: 'cloud-rain', 63: 'cloud-rain', 65: 'cloud-rain', 66: 'cloud-rain', 67: 'cloud-rain', 71: 'cloud-snow', 73: 'cloud-snow', 75: 'cloud-snow', 77: 'cloud-snow', 80: 'cloud-rain', 81: 'cloud-rain', 82: 'cloud-lightning', 85: 'cloud-snow', 86: 'cloud-snow', 95: 'cloud-lightning', 96: 'cloud-lightning', 99: 'cloud-lightning' };

                        async function fetchWeather(lat, lon, city) {
                            try {
                                const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit`);
                                if (!response.ok) throw new Error('Failed to fetch weather');
                                const data = await response.json();
                                const weather = data.current;
                                
                                locationEl.textContent = city || 'Current Location';
                                tempEl.textContent = `${Math.round(weather.temperature_2m)}Â°F`;
                                conditionEl.textContent = getWeatherDescription(weather.weather_code);
                                iconEl.innerHTML = `<i data-lucide="${WMO_ICONS[weather.weather_code] || 'cloud-question'}"></i>`;
                                lucide.createIcons();

                            } catch (error) {
                                console.error("Weather fetch error:", error);
                                locationEl.textContent = 'Weather Error';
                            }
                        }
                        
                        function getWeatherDescription(code) {
                            const descriptions = {0: "Clear sky",1: "Mainly clear",2: "Partly cloudy",3: "Overcast",45: "Fog",48: "Rime fog",51: "Light drizzle",53: "Drizzle",55: "Dense drizzle",61: "Slight rain",63: "Rain",65: "Heavy rain",71: "Slight snow",73: "Snow",75: "Heavy snow",80: "Rain showers",81: "Rain showers",82: "Violent showers",95: "Thunderstorm",96: "Thunderstorm",99: "Thunderstorm"};
                            return descriptions[code] || "Unknown";
                        }

                        // Get user location
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                fetchWeather(position.coords.latitude, position.coords.longitude);
                            },
                            () => {
                                // Fallback to Massillon, OH if geolocation fails or is denied
                                fetchWeather(40.79, -81.52, 'Massillon, OH');
                            }
                        );
                    }
                },
                {
                    widgetId: 'shortcuts_widget',
                    gridSpan: 'md:col-span-2',
                    headerContent: `<button class="widget-settings-btn"><i data-lucide="settings-2" class="w-5 h-5"></i></button>`,
                    onMount: (cardElement) => { /* Static content */ }
                },
                {
                    widgetId: 'on_this_day_widget',
                    gridSpan: 'md:col-span-3',
                    onMount: (cardElement) => {
                        const eventTextEl = cardElement.querySelector('.event-text');
                        const dateTextEl = cardElement.querySelector('.event-date');
                        
                        const today = new Date();
                        const month = String(today.getMonth() + 1);
                        const day = String(today.getDate());
                        
                        dateTextEl.textContent = today.toLocaleDateString(undefined, { month: 'long', day: 'numeric' });

                        fetch(`https://en.wikipedia.org/api/rest_v1/feed/onthisday/events/${month}/${day}`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.events && data.events.length > 0) {
                                    const randomEvent = data.events[Math.floor(Math.random() * data.events.length)];
                                    eventTextEl.innerHTML = `${randomEvent.text} <span class="text-[var(--text-secondary-dark)] light:text-[var(--text-secondary-light)]">(${randomEvent.year})</span>`;
                                } else {
                                    eventTextEl.textContent = 'No significant events found for today.';
                                }
                            })
                            .catch(error => {
                                console.error('Error fetching On This Day:', error);
                                eventTextEl.textContent = 'Could not load historical event.';
                            });
                    }
                },
                {
                    widgetId: 'quote_widget',
                    gridSpan: 'md:col-span-3',
                    onMount: (cardElement) => {
                        const quoteEl = cardElement.querySelector('blockquote p');
                        const authorEl = cardElement.querySelector('cite');
                        fetch('https://api.quotable.io/random')
                            .then(response => response.json())
                            .then(data => {
                                quoteEl.textContent = `"${data.content}"`;
                                authorEl.textContent = `- ${data.author}`;
                            })
                            .catch(error => {
                                console.error("Quote fetch error:", error);
                                quoteEl.textContent = '"The best way to predict the future is to create it."';
                                authorEl.textContent = '- Peter Drucker';
                            });
                    }
                }
            ];

            function getWidgetContent(widget) {
                const header = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl primary-font">${widget.widgetId.replace('_widget', '').replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase())}</h3>
                        ${widget.headerContent || ''}
                    </div>`;

                let body = '';
                switch (widget.widgetId) {
                    case 'greeting_widget':
                        return `<div class="flex flex-col justify-between h-full"><div><h3 class="widget-greeting text-2xl primary-font">Loading...</h3><p class="secondary-font text-base text-[var(--text-secondary-dark)] light:text-[var(--text-secondary-light)]">Welcome back.</p></div><div class="text-right mt-auto"><div class="widget-time text-5xl primary-font font-bold">--:--</div><div class="widget-date text-lg secondary-font text-[var(--text-secondary-dark)] light:text-[var(--text-secondary-light)]">---</div></div></div>`;
                    case 'weather_widget':
                        return `${header}<div class="flex flex-col h-full"><div class="flex items-start justify-between"><h3 class="weather-location text-2xl primary-font">Loading...</h3><div class="weather-icon w-10 h-10"></div></div><div class="flex items-end justify-between mt-auto"><span class="weather-temp text-6xl primary-font font-bold">--Â°</span><span class="weather-condition text-lg secondary-font text-right">--</span></div></div>`;
                    case 'shortcuts_widget':
                        return `${header}<div class="grid grid-cols-2 gap-3 h-full"><a href="#" class="quick-link-item"><i data-lucide="music-4"></i><span>Soundboard</span></a><a href="#" class="quick-link-item"><i data-lucide="gamepad-2"></i><span>Games</span></a><a href="#" class="quick-link-item"><i data-lucide="list-music"></i><span>Playlists</span></a><a href="#" class="quick-link-item"><i data-lucide="user"></i><span>Account</span></a></div>`;
                    case 'on_this_day_widget':
                        return `${header}<div class="flex flex-col"><p class="event-date secondary-font text-base text-[var(--text-secondary-dark)] light:text-[var(--text-secondary-light)] mb-2">Loading date...</p><p class="event-text primary-font text-lg">Fetching historical event...</p></div>`;
                    case 'quote_widget':
                        return `${header}<blockquote class="text-lg primary-font italic flex-grow"><p>"Loading quote..."</p></blockquote><cite class="secondary-font text-base text-[var(--text-secondary-dark)] light:text-[var(--text-secondary-light)] block text-right mt-2">-</cite>`;
                    default:
                        return '<p>Widget failed to load.</p>';
                }
            }
            
            function renderDashboard() {
                dashboardGrid.innerHTML = '';
                WIDGET_CONFIG.forEach(widget => {
                    const card = document.createElement('div');
                    card.className = `dashboard-card-v2 ${widget.gridSpan}`;
                    card.innerHTML = getWidgetContent(widget);
                    dashboardGrid.appendChild(card);
                    
                    if (widget.onMount) {
                        try {
                            widget.onMount(card);
                        } catch(e) {
                            console.error(`Error mounting widget ${widget.widgetId}:`, e);
                            card.innerHTML = `<p class="text-red-500">Error loading widget.</p>`;
                        }
                    }
                });
                lucide.createIcons(); // Initialize any new icons
            }

            renderDashboard();
        });
    </script>
</body>
</html>


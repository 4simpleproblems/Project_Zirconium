<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - SETTINGS</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <script src="../url-tab-title-changer.js"></script>
    
    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        :root {
            /* The color variable has been removed as navigation.js manages it via --navbar-background */
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* The body padding-top is now handled by the CSS injected in test-navigation.js to account for the fixed navbar height */
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* Full-screen content wrapper */
        .settings-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 0 1rem; 
        }

        /* Header Styling */
        .page-header {
            padding: 2rem 1rem 1rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Settings Grid Layout */
        .settings-layout {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
            flex-grow: 1;
        }

        /* --- UPDATED: Sidebar Styling --- */
        .settings-sidebar {
            width: 100%;
            min-width: 200px;
            max-width: 280px;
            flex-shrink: 0;
            
            /* NEW: Sticky Sidebar Implementation */
            position: sticky;
            /* 4rem for main navbar + 1rem desired gap */
            top: 5rem; 
            /* Aligns item to the start of the flex container, crucial for sticky */
            align-self: flex-start;
            /* Set a MAX-height based on viewport, minus the sticky offset */
            max-height: calc(100vh - 5rem);
            /* Allow sidebar to scroll internally if its content is too tall */
            overflow-y: auto;
        }

        /* --- STYLING UPDATE: Replaced .sidebar-item styles with .nav-tab styles --- */
        .sidebar-item {
            flex-shrink: 0;
            padding: 8px 14px; /* from nav-tab */
            color: var(--tab-text, #9ca3af); /* from nav-tab */
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s, color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
            text-decoration: none;
            line-height: 1.5;
            display: flex; /* keep this */
            align-items: center; /* keep this */
            margin-bottom: 0.25rem; /* keep this */
            border: 1px solid transparent; /* from nav-tab */
            cursor: pointer; /* keep this */
        }
        
        /* FIX: Ensure icon is centered in its box */
        .sidebar-item i {
            text-align: center;
            line-height: 1.5rem; /* Matches h-6 (1.5rem) */
        }

        .sidebar-item:not(.active):hover {
            color: var(--tab-hover-text, #ffffff);
            border-color: var(--tab-hover-border, #d1d5db);
            background-color: var(--tab-hover-bg, rgba(79, 70, 229, 0.05));
        }

        .sidebar-item.active {
            color: var(--tab-active-text, #4f46e5);
            border-color: var(--tab-active-border, #4f46e5);
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            font-weight: 500;
        }
        .sidebar-item.active:hover { /* Add active hover */
            color: var(--tab-active-hover-text, #6366f1);
            border-color: var(--tab-active-hover-border, #6366f1);
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
        }
        /* --- END STYLING UPDATE --- */

        /* Main Content Panel */
        .settings-panel {
            flex-grow: 1;
            background-color: #111111;
            border: 1px solid #252525;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 70vh;
        }
        
        /* --- General Settings UI --- */
        .settings-section {
            border-bottom: 1px solid #252525;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .settings-label {
            display: block;
            font-medium text-white mb-2;
        }
        .settings-input {
            width: 100%;
            max-width: 400px;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-input:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #3b82f640;
        }
        .settings-input:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- STYLING UPDATE: Removed all old button styles --- */
        /* .settings-button, .settings-button-danger, .settings-button-secondary, */
        /* .btn-primary, .btn-secondary, .btn-danger and all hover/disabled states removed */

        /* --- STYLING UPDATE: Added new button styles from notes.html --- */
        .btn-base {
            background: var(--menu-bg, #000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.6rem 1.25rem; /* from old .settings-button */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Added */
            gap: 0.5rem;
        }
        .btn-base:hover {
            background-color: var(--menu-bg, #000000);
            border-color: var(--menu-border, #fff); 
            color: var(--tab-hover-text, #ffffff);
        }
        .btn-base:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #374151;
            color: #9ca3af;
        }

        .btn-primary-style {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .btn-primary-style:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }
        
        .btn-danger-style {
            color: #dc2626; /* red-600 - Darker Red */
        }
        .btn-danger-style:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-600 with 15% opacity */
            border-color: #ef4444; /* red-500 */
            color: #f87171; /* red-400 - Brighter on hover */
        }
        
        /* NEW: Secondary button style with accent */
        .btn-secondary-style {
            color: #60a5fa; /* blue-400 */
        }
        .btn-secondary-style:hover {
            background-color: rgba(96, 165, 250, 0.1); /* blue-400 with 10% opacity */
            border-color: #60a5fa; /* blue-400 */
            color: #93c5fd; /* blue-300 */
        }
        /* --- END STYLING UPDATE --- */


        .settings-description {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.5rem;
            max-width: 600px;
        }
        .message-area {
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }
        .message-error { color: #f87171; /* red-400 */ }
        .message-success { color: #4ade80; /* green-400 */ }
        .message-warning { color: #facc15; /* yellow-400 */ }

        /* Standard loading screen style */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #070707;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* Mobile adjustments: Hide sidebar and adjust layout */
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
                gap: 1rem;
            }
            .settings-sidebar {
                max-width: 100%;
                margin-bottom: 0;
                /* On mobile, un-stick the sidebar */
                position: static;
                height: auto;
                max-height: none; /* Reset max-height for mobile */
                overflow-y: visible;
            }
        }

        /* --- UPDATED CSS for .color-option (Text Centered) --- */

        .color-option {
            /* 1. Wide but not tall / Spacious */
            width: 100%;
            padding: 0.75rem 1.25rem; 
            height: auto; 
            
            /* 2. Slightly more rounded (12px) */
            border-radius: 12px;
            
            /* 3. Less spacing between them */
            margin-bottom: 4px; 
            
            /* Standard button styling */
            cursor: pointer;
            border: 3px solid #374151; /* gray-700 */
            transition: background-color 0.2s, border-color 0.2s; 
            display: flex;
            align-items: center;
            /* CHANGE: Sets the horizontal alignment of the flex items to the center */
            justify-content: center; 
            
            font-size: 0.9rem; 
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-weight: 500;
        }

        .color-option:hover {
            border-color: #6b7280; /* gray-500 */
            background-color: #1f1f1f; 
        }

        .color-option.selected {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px #3b82f680;
            background-color: #18202d;
        }

        /* --- REMOVED: Avatar and Personalization Styles --- */

        .form-select, .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Specific max-width for settings inputs */
        .form-input.settings-input-width, .form-select.settings-input-width {
            max-width: 400px;
        }
        
        /* --- REMOVED: emoji-btn styles --- */

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-header {
            flex: 1;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* --- REMOVED: compact-mode styles --- */
        /* --- REMOVED: crop-canvas styles --- */

        .hidden {
            display: none !important;
        }
        
        /* --- START: NEW STYLES FOR TAB DISGUISER --- */
        
        /* Style for the custom favicon pickers */
        .favicon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
            padding: 10px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            background-color: #374151; /* gray-700 */
            max-height: 150px;
            overflow-y: auto;
        }

        .favicon-picker-item {
            position: relative; /* For the delete button */
            width: 40px;
            height: 40px;
            padding: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            background-color: #4b5563; /* gray-600 */
        }

        .favicon-picker-item:hover {
            background-color: #6b7280; /* gray-500 */
        }

        .favicon-picker-item.selected {
            border-color: #3b82f6; /* blue-500 */
            background-color: #1f2937; /* gray-800 */
        }

        .favicon-picker-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        /* NEW: Delete button for custom favicons */
        .favicon-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            background-color: #dc2626; /* red-600 */
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .favicon-picker-item:hover .favicon-delete-btn {
            opacity: 1;
        }
        .favicon-delete-btn:hover {
            background-color: #b91c1c; /* red-700 */
        }
        
        /* Style for the favicon fetch preview */
        .favicon-fetch-preview {
            width: 46px;
            height: 46px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #374151; /* gray-700 */
            flex-shrink: 0;
            padding: 5px; /* Added padding */
        }
        
        .favicon-fetch-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* --- END: NEW STYLES FOR TAB DISGUISER --- */
        
    </style>
<script async src="https://www.googagletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body>

    <div id="loading-screen">
        <p class="text-xl text-gray-400">Verifying authentication and loading settings...</p>
    </div>

    <main id="page-content" class="settings-wrapper hidden">
        
        <header class="page-header">
            <h1 id="main-title" class="text-3xl text-white font-bold mb-3 tracking-wide">Settings</h1>
            <div class="h-px bg-white/20 w-full"></div>
        </header>

        <div class="settings-layout">
            
            <nav id="settings-sidebar" class="settings-sidebar"></nav>

            <section class="settings-panel">
                <h2 id="panel-title" class="text-2xl font-semibold text-indigo-400 mb-6">General</h2>
                <div id="panel-content" class="text-gray-400">
                    </div>
            </section>
        </div>
    </main>

    <script type="module">
        // --- NEW: Firebase v10 (Modular) Imports ---
        import { firebaseConfig } from '../firebase-config.js';
        // --- Removed JSON import ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            reauthenticateWithCredential,
            reauthenticateWithPopup,
            EmailAuthProvider,
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            updatePassword,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            serverTimestamp,
            collection,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- NEW: Firebase v10 Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: Global State Variables ---
        let currentUser = null;         // Firebase Auth User object
        let currentUserData = null;     // Firestore 'users' document data
        let unsubscribeUserDoc = null;  // Function to stop the onSnapshot listener
        let activeSection = 'general';  // Track the currently loaded section
        
        // --- MODIFICATION: themePalettes and a promise to track its loading ---
        let themePalettes = null;       // Will be populated by fetch()
        let themesPromise = null;       // Will hold the fetch promise

        // --- CONSTANTS AND DOM ELEMENTS ---
        const BASE_TITLE = "Settings";
        // Key for Local Storage - MUST MATCH THEME_STORAGE_KEY in navigation.js
        const NAVBAR_SETTINGS_KEY = 'user-navbar-theme'; 
        const GAME_SAVE_FILENAME = 'strongdog_saves.json'; // New constant for the save file name
        
        // --- [NEW] CONSTANTS FOR PANIC KEY (from panic-key.js) ---
        const PANIC_KEY_DB_NAME = 'userLocalSettingsDB';
        const PANIC_KEY_STORE_NAME = 'panicKeyStore';

        // --- [NEW] CONSTANTS FOR TAB DISGUISER (from url-tab-title-changer.js) ---
        // These are presets *built-in* to the settings page, matching url-tab-title-changer.js
        const TAB_PRESETS_INTERNAL = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'gmm', name: 'GMM', title: 'Get More Math!', favicon: '../favicons/gmm.png', category: 'websites' },
            { id: 'kahoot', name: 'Kahoot', title: 'Kahoot! | Learning games | Make learning awesome!', favicon: '../favicons/kahoot.png', category: 'websites' },
            { id: 'g_classroom', name: 'Google Classroom', title: 'Home', favicon: '../favicons/google-classroom.png', category: 'websites' },
            { id: 'g_docs', name: 'Google Docs', title: 'Google Docs', favicon: '../favicons/google-docs.png', category: 'websites' },
            { id: 'g_slides', name: 'Google Slides', title: 'Google Slides', favicon: '../favicons/google-slides.png', category: 'websites' },
            { id: 'g_drive', name: 'Google Drive', title: 'Home - Google Drive', favicon: '../favicons/google-drive.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'clever', name: 'Clever', title: 'Clever | Connect every student to a world of learning', favicon: '../favicons/clever.png', category: 'websites' },
            // Note: The 'live' preset from url-tab-title-changer.js is also handled.
        ];
        
        const FOURSP_ICONS = [
             { name: '4SP Dark', url: '../images/logo-dark.png' },
             { name: '4SP Light', url: '../images/logo.png' }
        ];
        // --- [END NEW CONSTANTS] ---

        const settingsSections = [
            { id: 'general', title: 'General', icon: 'fa-cog', content: 'Manage your core account settings, username, and password.', color: 'text-yellow-400' },
            { id: 'privacy', title: 'Privacy & Security', icon: 'fa-shield-alt', content: 'Manage your data permissions, account security, and two-factor authentication. Strong security is a priority!', color: 'text-red-400' },
            { id: 'personalization', title: 'Personalization', icon: 'fa-palette', content: 'Customize the look and feel of the application, including colors and layout. Make it truly yours!', color: 'text-pink-400' },
            { id: 'tab-disguiser', title: 'Tab Disguiser', icon: 'fa-mask', content: 'Customize your tab appearance to hide your activity.', color: 'text-purple-400' },
            { id: 'panic-key', title: 'Panic Key', icon: 'fa-hand-paper', content: 'Set up a panic key to quickly hide your current activity.', color: 'text-orange-400' },
            { id: 'notifications', title: 'Notifications', icon: 'fa-bell', content: 'Set your preferences for alerts and communication methods. Never miss an important update.', color: 'text-green-400' },
            { id: 'data', title: 'Data Management', icon: 'fa-database', content: 'View, export, or request deletion of your stored data.', color: 'text-blue-400' },
            { id: 'about', title: 'About 4SP', icon: 'fa-info-circle', content: 'Application version, legal notices, and credits.', color: 'text-gray-400' }
        ];
        
        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const mainTitle = document.getElementById('main-title');
        const sidebarNav = document.getElementById('settings-sidebar');
        const panelTitle = document.getElementById('panel-title');
        const panelContent = document.getElementById('panel-content');
        const pageHtmlTitle = document.getElementById('page-title');

        // --- NEW: AUTHENTICATION & DATA FLOW ---

        function startAuthFlow() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    currentUser = user;
                    
                    // Stop any previous listener
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }
                    
                    // Get the user's document reference
                    const userDocRef = doc(db, 'users', user.uid);
                    
                    // Set up a real-time listener for the user's data
                    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentUserData = docSnap.data();
                        } else {
                            // This case should ideally not happen for a logged-in user
                            // But if it does, we have their basic auth data
                            currentUserData = {
                                email: user.email,
                                username: user.displayName || 'User',
                                authMethod: user.providerData[0]?.providerId || 'unknown'
                            };
                            console.warn("Firestore document not found for user:", user.uid);
                        }
                        
                        // Initial page setup
                        if (loadingScreen.style.display !== 'none') {
                            initializePage();
                        } else {
                            // If page is already loaded, just refresh the active panel
                            // This is for real-time updates (e.g., username cooldown)
                            loadSection(activeSection);
                        }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        // Show page even if Firestore listener fails
                        currentUserData = { email: user.email, username: user.displayName || 'User' };
                        initializePage();
                    });

                } else {
                    // User is signed out.
                    currentUser = null;
                    currentUserData = null;
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }
                    // Redirect to login page
                    console.log("User is not authenticated. Redirecting to login.");
                    window.location.href = '../authentication.html';
                }
            });
        }
        
        /**
         * Runs once after the first successful auth check and data load.
         */
        function initializePage() {
            renderSidebar();
            
            // --- NEW: Hash Routing ---
            let sectionToLoad = 'general';
            const hash = window.location.hash.substring(1); // Get hash (e.g., "personalization")
            if (hash && settingsSections.some(s => s.id === hash)) {
                sectionToLoad = hash;
            }
            loadSection(sectionToLoad); // Load section from hash or default
            // --- END NEW ---
            
            // Hide loading screen and show content
            loadingScreen.style.display = 'none';
            pageContent.classList.remove('hidden');

            // --- MODIFICATION: Start loading themes AFTER auth is complete ---
            // Start loading theme data in the background
            themesPromise = fetch('../themes.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch themes: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    themePalettes = data;
                    // If user somehow got to personalization tab before this finished, re-render it.
                    if (activeSection === 'personalization') {
                        renderPersonalizationSettings();
                    }
                    return data;
                })
                .catch(error => {
                    console.error("Error loading theme data:", error);
                    // If on personalization tab, show an error
                    if (activeSection === 'personalization') {
                        panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                    }
                });
        }
        
        // --- SETTINGS UI LOGIC ---

        function renderSidebar() {
            sidebarNav.innerHTML = ''; // Clear existing content
            settingsSections.forEach(section => {
                const item = document.createElement('div');
                item.className = 'sidebar-item group';
                item.id = `sidebar-${section.id}`;
                item.setAttribute('data-section', section.id);
                item.innerHTML = `
                    <i class="fas ${section.icon} w-6 h-6 mr-3 ${section.color} transition-transform group-hover:scale-110"></i>
                    <span class="text-sm font-medium">${section.title}</span>
                `;
                // --- MODIFICATION: Make click listener async ---
                item.addEventListener('click', async () => await loadSection(section.id));
                sidebarNav.appendChild(item);
            });
        }

        // --- MODIFICATION: Make loadSection async to await theme loading ---
        async function loadSection(sectionId) {
            activeSection = sectionId; // Update global state
            const section = settingsSections.find(s => s.id === sectionId);
            if (!section) return;

            // 1. Update main title and HTML title
            mainTitle.textContent = `${BASE_TITLE} - ${section.title}`;
            pageHtmlTitle.textContent = `4SP - ${BASE_TITLE} - ${section.title}`;

            // 2. Update content panel header
            panelTitle.innerHTML = `<i class="fas ${section.icon} mr-2 ${section.color}"></i> ${section.title}`;
            
            // 3. Render content based on section ID
            if (sectionId === 'general') {
                renderGeneralSettings();
            } 
            else if (sectionId === 'personalization') { 
                // Show loading message while themes are fetched
                panelContent.innerHTML = '<p>Loading themes...</p>';
                
                try {
                    // Wait for the theme data to be loaded (it might already be loaded)
                    if (!themesPromise) {
                        // This should not happen if initializePage ran, but it's a safe fallback.
                        console.warn("Themes promise not initialized, cannot load section.");
                        throw new Error("Theme loading was not initiated.");
                    }
                    
                    await themesPromise; // Wait for the fetch to complete
                    
                    // Now that themePalettes is populated, render the section
                    renderPersonalizationSettings();
                    
                } catch (error) {
                    console.error("Failed to render personalization settings:", error);
                    panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                }
            }
            // --- [MODIFICATION START] ---
            else if (sectionId === 'tab-disguiser') {
                renderTabDisguiserSettings();
            }
            else if (sectionId === 'panic-key') {
                renderPanicKeySettings();
            }
            // NEW: Privacy & Security section rendering
            else if (sectionId === 'privacy') {
                renderPrivacySettings();
            }
            // ADDED: Data Management section rendering
            else if (sectionId === 'data') {
                renderDataManagement();
            }
            // NEW: About section rendering
            else if (sectionId === 'about') {
                renderAboutSection();
            }
            // --- [MODIFICATION END] ---
            else {
                // Render placeholder for all other sections
                // --- [MODIFICATION] Replaced placeholder with "Coming Soon" ---
                panelContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center space-y-4 p-8 min-h-[40vh]">
                        <i class="fas ${section.icon} text-6xl ${section.color} opacity-50"></i>
                        <h3 class="text-2xl font-semibold text-white">${section.title}</h3>
                        <p class="text-lg text-gray-400">This section is coming soon!</p>
                    </div>
                `;
            }
            
            // 4. Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sidebar-${sectionId}`).classList.add('active');
            
            // --- NEW: Hash Routing ---
            // Set hash in URL without reloading
            if (window.location.hash !== `#${sectionId}`) {
                // Use replaceState to avoid cluttering browser history
                history.replaceState(null, '', `#${sectionId}`);
            }
            // --- END NEW ---
        }
        
        // --- NEW: General Settings Implementation (omitted for brevity, remains unchanged) ---
        
        /**
         * Renders the content for the "General" tab
         */
        function renderGeneralSettings() {
            if (!currentUser || !currentUserData) {
                panelContent.innerHTML = '<p>Loading account data...</p>';
                return;
            }

            const primaryAuthMethod = currentUserData.authMethod || 'unknown';
            const isEmailUser = primaryAuthMethod === 'email';
            
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Username</h3>
                    <label for="username-input" class="settings-label">Change Username</label>
                    <div class="flex flex-col sm:flex-row sm:items-start sm:gap-4">
                        <input type="text" id="username-input" class="settings-input" value="${currentUserData.username || ''}" placeholder="Enter new username">
                        <button id="username-save-btn" class="btn-base btn-primary-style mt-3 sm:mt-0 sm:flex-shrink-0">
                            <i class="fas fa-save mr-2"></i> Save
                        </button>
                    </div>
                    <div id="username-message" class="message-area"></div>
                    <p class="settings-description">
                        You can change your username once every 7 days. 
                        Your username must be 4-24 characters and can include: .,-+\\_!?$
                    </p>
                </div>

                ${isEmailUser ? `
                <div class="settings-section" id="password-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Change Password</h3>
                    <form id="password-change-form">
                        <div class="mb-4">
                            <label for="current-password" class="settings-label">Current Password</label>
                            <input type="password" id="current-password" class="settings-input" required autocomplete="current-password">
                            <p class="settings-description">Required to confirm your identity.</p>
                        </div>
                        <div class="mb-4">
                            <label for="new-password" class="settings-label">New Password</label>
                            <input type="password" id="new-password" class="settings-input" required autocomplete="new-password">
                        </div>
                        <div class="mb-4">
                            <label for="confirm-password" class="settings-label">Confirm New Password</label>
                            <input type="password" id="confirm-password" class="settings-input" required autocomplete="new-password">
                        </div>
                        <button type="submit" id="password-save-btn" class="btn-base btn-primary-style">
                            <i class="fas fa-key mr-2"></i> Change Password
                        </button>
                    </form>
                    <div id="password-message" class="message-area"></div>
                </div>
                ` : ''}

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Link Providers</h3>
                    <p class="settings-description mb-4">
                        Link multiple social accounts to sign in.
                    </p>
                    <div id="linking-container" class="space-y-3">
                        </div>
                    <div id="linking-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-red-400 mb-4">Danger Zone</h3>
                    <p class="settings-description mb-4">
                        Deleting your account is permanent and cannot be undone. All your data will be removed.
                    </p>
                    <button id="delete-account-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Account
                    </button>
                </div>
            `;

            setupGeneralEventListeners();
            renderLinkedProviders();
        }

        // Helper function for rendering General settings messages
        function showGeneralMessage(message, type) {
            const messageEl = document.getElementById('username-message');
            if (messageEl) {
                messageEl.textContent = message;
                messageEl.className = `message-area ${type === 'error' ? 'message-error' : 'message-success'}`;
            }
        }
        
        // Helper function to show a global toast message
        function showToastMessage(message, type) {
            let messageEl = document.getElementById('toast-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'toast-message';
                // Positioned top-20 to be below the sticky navbar
                messageEl.className = 'fixed top-20 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300';
                document.body.appendChild(messageEl);
            }
            messageEl.textContent = message;
            messageEl.className = `fixed top-20 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : (type === 'error' ? 'bg-red-600 text-white' : 'bg-yellow-500 text-black')
            }`;

            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (messageEl) {
                    messageEl.remove();
                }
            }, 3000);
        }

        function setupGeneralEventListeners() {
            // Username save button
            document.getElementById('username-save-btn')?.addEventListener('click', saveUsername);

            // Password change form
            document.getElementById('password-change-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                changePassword();
            });

            // Account deletion button
            document.getElementById('delete-account-btn')?.addEventListener('click', deleteAccount);
        }

        // Username validation and saving
        async function saveUsername() {
            const input = document.getElementById('username-input');
            const button = document.getElementById('username-save-btn');
            const messageEl = document.getElementById('username-message');
            const newUsername = input.value.trim();
            const currentUsername = currentUserData.username;
            
            messageEl.textContent = '';
            
            if (newUsername === currentUsername) {
                messageEl.textContent = 'Username is the same as the current one.';
                messageEl.className = 'message-area message-warning';
                return;
            }

            if (newUsername.length < 4 || newUsername.length > 24) {
                showGeneralMessage('Username must be 4-24 characters long.', 'error');
                return;
            }

            // Regular expression for allowed characters
            const allowedCharsRegex = /^[a-zA-Z0-9.,\-+_\!?$]+$/;
            if (!allowedCharsRegex.test(newUsername)) {
                showGeneralMessage('Username contains invalid characters.', 'error');
                return;
            }

            // Check cooldown
            const lastChange = currentUserData.lastUsernameChange?.toDate();
            if (lastChange) {
                const oneWeek = 7 * 24 * 60 * 60 * 1000;
                const timeSinceChange = Date.now() - lastChange.getTime();
                if (timeSinceChange < oneWeek) {
                    const remainingMs = oneWeek - timeSinceChange;
                    const remainingHours = Math.ceil(remainingMs / (1000 * 60 * 60));
                    showGeneralMessage(`You can change your username again in about ${remainingHours} hours.`, 'error');
                    return;
                }
            }

            button.disabled = true;
            button.textContent = 'Saving...';
            showGeneralMessage('Checking availability...', 'warning');

            try {
                // 1. Check if the username is already taken (case-insensitive Firestore query)
                const q = query(collection(db, "users"), where("username", "==", newUsername));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    // Check if the only result is the current user (if capitalization changed)
                    let isConflict = false;
                    querySnapshot.forEach(doc => {
                        if (doc.id !== currentUser.uid) {
                            isConflict = true;
                        }
                    });

                    if (isConflict) {
                        showGeneralMessage('Username is already taken.', 'error');
                        return;
                    }
                }

                // 2. Save the new username and update the cooldown timestamp
                const userDocRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userDocRef, {
                    username: newUsername,
                    lastUsernameChange: serverTimestamp()
                });
                
                showGeneralMessage('Username successfully updated!', 'success');

                // The onSnapshot listener will update currentUserData and re-render if needed
            } catch (error) {
                console.error("Error saving username:", error);
                showGeneralMessage('Failed to update username. Please try again.', 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-save mr-2"></i> Save';
            }
        }

        // Password change logic
        async function changePassword() {
            const form = document.getElementById('password-change-form');
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const messageEl = document.getElementById('password-message');
            const saveBtn = document.getElementById('password-save-btn');

            messageEl.textContent = '';
            
            if (newPass.length < 6) {
                messageEl.textContent = 'New password must be at least 6 characters long.';
                messageEl.className = 'message-area message-error';
                return;
            }
            
            if (newPass !== confirmPass) {
                messageEl.textContent = 'New password and confirmation do not match.';
                messageEl.className = 'message-area message-error';
                return;
            }
            
            saveBtn.disabled = true;
            saveBtn.textContent = 'Processing...';
            
            try {
                // Step 1: Re-authenticate the user
                const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
                await reauthenticateWithCredential(currentUser, credential);

                // Step 2: Update the password
                await updatePassword(currentUser, newPass);
                
                messageEl.textContent = 'Password successfully updated!';
                messageEl.className = 'message-area message-success';
                form.reset(); // Clear the form

            } catch (error) {
                console.error("Error changing password:", error);
                
                let errorMessage = 'Failed to change password. Please check your current password.';
                if (error.code === 'auth/wrong-password') {
                    errorMessage = 'The current password you entered is incorrect.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'The new password is too weak. Choose a stronger one.';
                }

                messageEl.textContent = errorMessage;
                messageEl.className = 'message-area message-error';
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-key mr-2"></i> Change Password';
            }
        }

        // Account deletion logic
        async function deleteAccount() {
            const confirmed = confirm('WARNING: Are you absolutely sure you want to delete your account? This action is irreversible.');
            if (!confirmed) return;

            const secondConfirmation = prompt('To confirm account deletion, please type your email address exactly as it appears below:\n' + currentUser.email);
            if (secondConfirmation !== currentUser.email) {
                showToastMessage('Deletion cancelled. Email mismatch.', 'warning');
                return;
            }

            try {
                // If the user is an email/password user, they need to re-authenticate with their password
                if (currentUserData.authMethod === 'email') {
                    const password = prompt('Please enter your password to confirm deletion:');
                    if (!password) {
                        showToastMessage('Deletion cancelled.', 'warning');
                        return;
                    }
                    const credential = EmailAuthProvider.credential(currentUser.email, password);
                    await reauthenticateWithCredential(currentUser, credential);
                } else {
                    // For social logins, re-authenticate via popup
                    await reauthenticateWithPopup(currentUser, new GoogleAuthProvider());
                }

                // 1. Delete the Firestore user document (optional but good practice)
                const userDocRef = doc(db, 'users', currentUser.uid);
                // Note: Firestore doesn't have a direct 'deleteDoc' available in this modular import set, 
                // but assuming a secure function on the backend handles data cleanup on auth.delete.
                // If a client-side delete is necessary, it would be 'await deleteDoc(userDocRef);'

                // 2. Delete the Firebase Authentication user
                await deleteUser(currentUser);

                // Auth state listener will catch this and redirect to login
                showToastMessage('Account successfully deleted.', 'success');
                // The onAuthStateChanged listener handles the final redirect

            } catch (error) {
                console.error("Error deleting account:", error);
                
                let errorMessage = 'Failed to delete account. You may need to sign in again recently to perform this action (Re-login required).';
                if (error.code === 'auth/requires-recent-login') {
                    errorMessage = 'Security restriction: Please log out and log back in, then try deleting your account immediately.';
                }
                showToastMessage(errorMessage, 'error');
            }
        }

        // Provider linking logic
        function renderLinkedProviders() {
            const container = document.getElementById('linking-container');
            if (!container) return;
            
            container.innerHTML = '';
            const allProviders = [
                { id: 'google.com', name: 'Google', icon: 'fa-google', provider: new GoogleAuthProvider() },
                { id: 'github.com', name: 'GitHub', icon: 'fa-github', provider: new GithubAuthProvider() },
                { id: 'microsoft.com', name: 'Microsoft', icon: 'fa-microsoft', provider: new OAuthProvider('microsoft.com') }
            ];

            const linkedProviders = currentUser.providerData.map(p => p.providerId);
            const isPrimaryEmail = currentUserData.authMethod === 'email';
            
            allProviders.forEach(providerInfo => {
                const isLinked = linkedProviders.includes(providerInfo.id);
                const isPrimary = currentUserData.authMethod === providerInfo.id;
                
                const item = document.createElement('div');
                item.className = 'setting-item';
                item.innerHTML = `
                    <div class="setting-header">
                        <h4 class="text-lg font-medium text-white">${providerInfo.name}</h4>
                        <p class="text-sm text-gray-400">${isLinked ? 'Linked' : 'Not Linked'}${isPrimary ? ' (Primary)' : ''}</p>
                    </div>
                    <div class="setting-control">
                        ${isLinked ? 
                            `<button id="unlink-${providerInfo.id}" class="btn-base btn-danger-style" data-provider-id="${providerInfo.id}" ${linkedProviders.length <= 1 || isPrimary ? 'disabled' : ''}>
                                <i class="fas fa-unlink mr-2"></i> Unlink
                            </button>` :
                            `<button id="link-${providerInfo.id}" class="btn-base btn-primary-style" data-provider-id="${providerInfo.id}">
                                <i class="fab ${providerInfo.icon} mr-2"></i> Link
                            </button>`
                        }
                    </div>
                `;
                container.appendChild(item);
                
                if (isLinked) {
                    document.getElementById(`unlink-${providerInfo.id}`)?.addEventListener('click', () => unlinkProvider(providerInfo.id));
                } else {
                    document.getElementById(`link-${providerInfo.id}`)?.addEventListener('click', () => linkProvider(providerInfo.provider));
                }
            });
            
            // Handle Email/Password linking separately as it's not in the array
            if (!currentUser.providerData.some(p => p.providerId === 'password')) {
                const emailLinkItem = document.createElement('div');
                emailLinkItem.className = 'setting-item';
                emailLinkItem.innerHTML = `
                    <div class="setting-header">
                        <h4 class="text-lg font-medium text-white">Email/Password</h4>
                        <p class="text-sm text-gray-400">Not Linked</p>
                    </div>
                    <div class="setting-control">
                        <button id="link-email" class="btn-base btn-primary-style" disabled>
                            <i class="fas fa-envelope mr-2"></i> Link
                        </button>
                    </div>
                `;
                container.appendChild(emailLinkItem);
                
                // This link button would require a password prompt, so we keep it disabled for this simplified UI
            }
        }

        async function linkProvider(provider) {
            const messageEl = document.getElementById('linking-message');
            messageEl.textContent = '';
            
            try {
                await linkWithPopup(currentUser, provider);
                showToastMessage('Provider successfully linked!', 'success');
                // Re-render the section to update the UI
                renderLinkedProviders(); 
            } catch (error) {
                console.error("Error linking provider:", error);
                
                let errorMessage = 'Failed to link provider.';
                if (error.code === 'auth/credential-already-in-use') {
                    errorMessage = 'This social account is already linked to another user.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = 'Popup closed. Link process cancelled.';
                }
                messageEl.textContent = errorMessage;
                messageEl.className = 'message-area message-error';
            }
        }

        async function unlinkProvider(providerId) {
            const messageEl = document.getElementById('linking-message');
            messageEl.textContent = '';

            try {
                await unlink(currentUser, providerId);
                showToastMessage('Provider successfully unlinked!', 'success');
                // Re-render the section to update the UI
                renderLinkedProviders(); 
            } catch (error) {
                console.error("Error unlinking provider:", error);
                messageEl.textContent = 'Failed to unlink provider. You must keep at least one sign-in method.';
                messageEl.className = 'message-area message-error';
            }
        }

        /* --- END GENERAL SETTINGS FUNCTIONS --- */

        /* --- START PRIVACY & SECURITY FUNCTIONS --- */

        /**
         * Renders the content for the "Privacy & Security" tab
         */
        function renderPrivacySettings() {
             // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Activity and Telemetry</h3>
                    <div class="setting-item">
                        <div class="setting-header">
                            <h4 class="text-lg font-medium text-white">Share Telemetry Data</h4>
                            <p class="text-sm text-gray-400">Allow anonymous usage data to be collected to improve 4SP features and performance.</p>
                        </div>
                        <div class="setting-control">
                            <label class="toggle-switch">
                                <input type="checkbox" id="telemetry-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <p class="settings-description mt-4">
                        We respect your privacy. All collected data is anonymized and used exclusively for service improvement.
                    </p>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Security</h3>
                    <div class="setting-item">
                        <div class="setting-header">
                            <h4 class="text-lg font-medium text-white">Two-Factor Authentication (2FA)</h4>
                            <p class="text-sm text-gray-400">Add an extra layer of security to your account. <strong>(Coming Soon)</strong></p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-base" disabled>Setup 2FA</button>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Active Sessions</h3>
                    <p class="settings-description mb-4">
                        View and manage all devices currently logged into your account.
                    </p>
                    <button id="show-sessions-btn" class="btn-base btn-secondary-style">
                        <i class="fas fa-desktop mr-2"></i> View Active Sessions
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-blue-400 mb-4">Data Management</h3>
                    <p class="settings-description mb-4">
                        For exporting or deleting your data, please visit the Data Management panel.
                    </p>
                    <button id="goto-data-btn" class="btn-base btn-secondary-style">
                        <i class="fas fa-database mr-2"></i> Go to Data Management
                    </button>
                    <button id="goto-general-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-trash-alt mr-2"></i> Go to Account Deletion
                    </button>
                </div>
            `;
             // --- END STYLING UPDATE ---
            
            // Add event listeners for the remaining buttons
            document.getElementById('show-sessions-btn').addEventListener('click', showActiveSessions);
            document.getElementById('goto-data-btn').addEventListener('click', () => loadSection('data'));
            document.getElementById('goto-general-btn').addEventListener('click', () => loadSection('general'));
            
            // Setup Telemetry Toggle logic
            const telemetryToggle = document.getElementById('telemetry-toggle');
            if (telemetryToggle) {
                // Load saved state (defaulting to checked/true)
                const savedState = localStorage.getItem('4sp-telemetry-enabled');
                const isEnabled = savedState === null ? true : savedState === 'true';
                telemetryToggle.checked = isEnabled;

                // Add change listener
                telemetryToggle.addEventListener('change', () => {
                    localStorage.setItem('4sp-telemetry-enabled', telemetryToggle.checked ? 'true' : 'false');
                    showToastMessage(`Telemetry ${telemetryToggle.checked ? 'Enabled' : 'Disabled'}`, 'success');
                });
            }
        }

        function showActiveSessions() {
            showToastMessage('Active Sessions feature coming soon!', 'warning');
        }

        /* --- END PRIVACY & SECURITY FUNCTIONS --- */


        /* --- START PERSONALIZATION FUNCTIONS --- */
        
        /**
         * Renders the content for the "Personalization" tab
         */
        function renderPersonalizationSettings() {
            // Helper function to get the currently saved theme
            function getCurrentTheme() {
                try {
                    const savedThemeString = localStorage.getItem(NAVBAR_SETTINGS_KEY);
                    if (savedThemeString) {
                        return JSON.parse(savedThemeString);
                    }
                    // Default theme is the first one in the array (index 0)
                    return themePalettes[0];
                } catch (error) {
                    console.error("Error retrieving saved theme:", error);
                    return themePalettes[0]; // Fallback to the first theme
                }
            }

            if (!themePalettes || themePalettes.length === 0) {
                 panelContent.innerHTML = '<p class="message-area message-error">No theme data available.</p>';
                 return;
            }

            const currentTheme = getCurrentTheme();
            
            const swatchesHtml = themePalettes.map((theme, index) => {
                // Check if this theme matches the current active theme
                // This is a rough check, comparing the name or the primary color
                const isSelected = (theme.name === currentTheme.name) || 
                                   (index === 0 && !localStorage.getItem(NAVBAR_SETTINGS_KEY));
                
                // Get two colors for the background gradient preview
                const bg = theme['navbar-bg'] || '#000000';
                const text = theme['tab-active-text'] || '#4f46e5';

                return `
                    <div 
                        class="color-option ${isSelected ? 'selected' : ''}" 
                        data-theme-index="${index}" 
                        style="background-color: ${bg}; border-color: ${bg}; color: ${text};"
                        title="${theme.name}"
                    >
                        ${theme.name}
                    </div>
                `;
            }).join('');

            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Navigation Bar Theme</h3>
                    <p class="settings-description mb-4">
                        Choose a theme for the top navigation bar. Your selection will be applied instantly and saved locally in your browser.
                    </p>
                    <div id="theme-palette" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                        ${swatchesHtml}
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Other Preferences</h3>
                    <p class="settings-description mb-4">
                        More interface preferences, like avatar customization, are coming soon!
                    </p>
                </div>
            `;
            // --- END STYLING UPDATE ---
            
            // Attach event listeners
            attachPersonalizationListeners();
        }

        /**
         * Attaches event listeners for the Personalization panel
         */
        function attachPersonalizationListeners() {
            // Swatch click listener (for live preview AND immediate save)
            document.querySelectorAll('#theme-palette .color-option').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    // 1. Remove 'selected' from all and add to clicked
                    document.querySelectorAll('#theme-palette .color-option').forEach(s => s.classList.remove('selected'));
                    const selectedSwatch = e.currentTarget;
                    selectedSwatch.classList.add('selected');

                    // 2. Get theme data
                    const themeIndex = selectedSwatch.dataset.themeIndex;
                    const theme = themePalettes[themeIndex];

                    if (window.applyTheme) {
                        // 3. Apply theme for live preview
                        window.applyTheme(theme);

                        // 4. Save theme to local storage immediately
                        try {
                            // If it's the default theme (index 0), just remove the key (effectively setting default)
                            if (parseInt(themeIndex) === 0) {
                                localStorage.removeItem(NAVBAR_SETTINGS_KEY);
                            } else {
                                // Save the selected theme object
                                localStorage.setItem(NAVBAR_SETTINGS_KEY, JSON.stringify(theme));
                            }
                            showToastMessage(`Theme set to ${theme.name}`, 'success');

                        } catch (error) {
                            console.error("Error saving theme to Local Storage:", error);
                            showToastMessage("Error saving theme to browser storage.", 'error');
                        }
                    } else {
                        console.error("window.applyTheme is not defined. Make sure navigation.js is loaded.");
                        showToastMessage("Error: Theme applier script not found.", 'error');
                    }
                });
            });
        }
        
        /* --- END PERSONALIZATION FUNCTIONS --- */


        /* --- [START] UPDATED TAB DISGUISER FUNCTIONS (to work with url-tab-title-changer.js) --- */
        
        /**
         * Renders the Tab Disguiser settings panel.
         */
        function renderTabDisguiserSettings() {
            if (typeof window.urlChanger === 'undefined') {
                panelContent.innerHTML = '<p class="message-area message-error">Error: The Tab Disguiser script is not loaded.</p>';
                return;
            }

            // Load presets from the urlChanger script
            const websitePresets = window.urlChanger.presets.filter(p => p.category === 'websites' || p.category === 'default');
            const livePresets = window.urlChanger.presets.filter(p => p.category === 'live');
            
            let selectOptions = '<option value="none" data-favicon="">(No Disguise)</option>';
            
            if (websitePresets && websitePresets.length > 0) {
                selectOptions += `<optgroup label="Websites">`;
                websitePresets.forEach(preset => {
                    selectOptions += `<option value="${preset.id}" data-favicon="${preset.favicon}">${preset.name}</option>`;
                });
                selectOptions += `</optgroup>`;
            }
            
            if (livePresets && livePresets.length > 0) {
                selectOptions += `<optgroup label="Live">`;
                livePresets.forEach(preset => {
                    selectOptions += `<option value="${preset.id}" data-favicon="">${preset.name}</option>`;
                });
                selectOptions += `</optgroup>`;
            }
            
            selectOptions += ` <optgroup label="4SP"> `;
            FOURSP_ICONS.forEach((icon, index) => {
                // Use a unique ID for 4SP icons
                const id = `4sp-${index}`;
                selectOptions += `<option value="${id}" data-favicon="${icon.url}">${icon.name}</option>`;
            });
            selectOptions += `</optgroup>`;

            selectOptions += `<option value="custom" data-favicon="">Custom</option>`;

            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Tab Disguiser</h3>
                    <p class="settings-description mb-4">
                        Change the appearance of the browser tab to blend in. This setting is applied instantly and saved locally on this browser.
                    </p>
                    <div class="setting-item">
                        <div class="setting-header">
                            <h4 class="text-lg font-medium text-white">Preset Selection</h4>
                            <p class="text-sm text-gray-400">Choose a preset disguise or create a custom one.</p>
                        </div>
                        <div class="setting-control">
                            <select id="disguise-preset-select" class="form-select settings-input-width">
                                ${selectOptions}
                            </select>
                        </div>
                    </div>
                </div>

                <div id="custom-disguise-options" class="settings-section hidden">
                    <h3 class="text-xl font-semibold text-white mb-4">Customize Your Tab</h3>
                    <div class="space-y-6">
                        <div>
                            <label for="custom-title-input" class="settings-label">Custom Title</label>
                            <input type="text" id="custom-title-input" class="form-input settings-input-width" placeholder="Enter a title...">
                        </div>
                        <div>
                            <label class="settings-label">Custom Favicon</label>
                            <p class="settings-description mb-2">
                                Choose from a preset, upload an image, or fetch one from a website.
                            </p>
                            
                            <div class="space-y-4">
                                <div id="preset-favicon-grid" class="favicon-picker-grid">
                                    </div>
                                
                                <div class="flex items-start gap-4">
                                    <div class="favicon-fetch-preview" id="favicon-fetch-preview">
                                        <img src="" alt="Preview" class="hidden">
                                    </div>
                                    <div class="flex-grow">
                                        <input type="url" id="favicon-fetch-input" class="form-input settings-input-width mb-2" placeholder="Enter URL (e.g., wikipedia.org)">
                                        <button id="fetch-favicon-btn" class="btn-base btn-secondary-style">
                                            <i class="fas fa-globe mr-2"></i> Fetch Favicon
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="mt-4">
                                    <label class="settings-label">Upload Custom Icon</label>
                                    <input type="file" id="favicon-upload-input" accept="image/*" class="form-input settings-input-width" disabled>
                                    <p class="settings-description mt-1">File upload for favicons is coming soon.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="settings-section">
                    <button id="save-disguise-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-mask mr-2"></i> Save Disguise
                    </button>
                    <div id="tab-disguise-message" class="message-area"></div>
                </div>
            `;
            // --- END STYLING UPDATE ---

            renderCustomFaviconGrid();
            loadTabDisguiserSettings();
            attachTabDisguiserListeners();
        }

        /**
         * Renders the grid of favicon picker items (presets and custom uploads)
         */
        function renderCustomFaviconGrid() {
            const container = document.getElementById('preset-favicon-grid');
            if (!container) return; // Not on the tab disguiser page
            
            container.innerHTML = ''; // Clear it
            let html = '';

            // 1. Add 4SP Icons first (using the internal list)
            html += FOURSP_ICONS.map((icon) => `
                <div class="favicon-picker-item" data-favicon-url="${icon.url}" data-picker="4sp" title="${icon.name}">
                    <img src="${icon.url}" alt="${icon.name}">
                </div>
            `).join('');

            // 2. Add standard website presets (loaded from urlChanger)
            const websitePresets = window.urlChanger.presets.filter(p => p.category === 'websites' || p.category === 'default');
            html += websitePresets.map(preset => `
                <div class="favicon-picker-item" data-favicon-url="${preset.favicon}" data-picker="preset" title="${preset.name}">
                    <img src="${preset.favicon}" alt="${preset.name}">
                </div>
            `).join('');

            // 3. Add custom favicons from urlChanger
            // Ensure customFavicons is loaded (it should be by init)
            if (window.urlChanger.customFavicons && window.urlChanger.loadCustomFavicons) {
                window.urlChanger.loadCustomFavicons();
                html += window.urlChanger.customFavicons.map(iconUrl => `
                    <div class="favicon-picker-item" data-favicon-url="${iconUrl}" data-picker="custom" title="Custom Icon">
                        <img src="${iconUrl}" alt="Custom Icon">
                        <button class="favicon-delete-btn" data-favicon-url="${iconUrl}" title="Remove">&times;</button>
                    </div>
                `).join('');
            }

            container.innerHTML = html;
            
            // Re-attach listeners for these new items
            attachPickerItemListeners(container);
        }

        /**
         * Attaches click listeners to all favicon picker items
         */
        function attachPickerItemListeners(container) {
            container.querySelectorAll('.favicon-picker-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('favicon-delete-btn')) {
                        // Handle delete click
                        e.stopPropagation(); // Prevent the parent click handler from running
                        const url = e.target.dataset.faviconUrl;
                        if (window.urlChanger && window.urlChanger.removeCustomFavicon) {
                            window.urlChanger.removeCustomFavicon(url);
                            renderCustomFaviconGrid(); // Re-render grid
                            // After deletion, re-select the current active icon if it wasn't the deleted one
                            loadTabDisguiserSettings(); 
                        }
                        return; // Stop propagation
                    }
                    
                    // Deselect other selected items in *all* pickers
                    document.querySelectorAll('.favicon-picker-item.selected').forEach(selected => {
                        selected.classList.remove('selected');
                    });
                    
                    // Select this item
                    item.classList.add('selected');

                    // Clear fetch input and hide preview
                    document.getElementById('favicon-fetch-input').value = '';
                    document.getElementById('favicon-fetch-preview').querySelector('img').classList.add('hidden');
                });
            });
        }

        /**
         * Attaches listeners for the new Tab Disguiser UI
         */
        function attachTabDisguiserListeners() {
            const presetSelect = document.getElementById('disguise-preset-select');
            const customOptions = document.getElementById('custom-disguise-options');
            const saveBtn = document.getElementById('save-disguise-btn');
            const fetchBtn = document.getElementById('fetch-favicon-btn');

            const toggleCustomOptions = () => {
                if (presetSelect.value === 'custom') {
                    customOptions.classList.remove('hidden');
                } else {
                    customOptions.classList.add('hidden');
                }
            };

            // 1. Preset change listener
            presetSelect.addEventListener('change', toggleCustomOptions);

            // 2. Save button listener
            saveBtn.addEventListener('click', saveTabDisguiserSettings);

            // 3. Favicon fetch listener
            fetchBtn.addEventListener('click', handleFaviconFetch);
            
            // 4. Custom title input listener (auto-save on blur for custom mode)
            document.getElementById('custom-title-input')?.addEventListener('blur', () => {
                 if (presetSelect.value === 'custom') {
                    saveTabDisguiserSettings(false); // Save without showing success message
                 }
            });
        }
        
        /**
         * Loads the current settings from urlChanger and updates the UI
         */
        function loadTabDisguiserSettings() {
            const presetSelect = document.getElementById('disguise-preset-select');
            const customOptions = document.getElementById('custom-disguise-options');
            const customTitleInput = document.getElementById('custom-title-input');
            const messageEl = document.getElementById('tab-disguise-message');
            
            if (!presetSelect || !customOptions || typeof window.urlChanger === 'undefined') return;

            // Clear messages
            messageEl.textContent = '';
            
            // Deselect all swatches first
            document.querySelectorAll('.favicon-picker-item.selected').forEach(selected => {
                selected.classList.remove('selected');
            });
            document.getElementById('favicon-fetch-preview').querySelector('img').classList.add('hidden');
            document.getElementById('favicon-fetch-input').value = '';

            try {
                const settings = window.urlChanger.loadSettings();

                if (settings.type === 'custom') {
                    presetSelect.value = 'custom';
                    customOptions.classList.remove('hidden');
                    customTitleInput.value = settings.title || '';
                    
                    // Find and select the custom favicon if it exists in the grid
                    if (settings.favicon) {
                        const selectedItem = document.querySelector(`.favicon-picker-item[data-favicon-url="${settings.favicon}"]`);
                        if (selectedItem) {
                            selectedItem.classList.add('selected');
                        }
                    }
                } else if (settings.type === 'preset' && settings.id) {
                    customOptions.classList.add('hidden');
                    
                    // Check if it's a 4SP icon
                    const fourspIcon = FOURSP_ICONS.find(icon => icon.url === settings.favicon);
                    if (fourspIcon) {
                        const fourspIndex = FOURSP_ICONS.indexOf(fourspIcon);
                        presetSelect.value = `4sp-${fourspIndex}`;
                    } else {
                        // Check standard presets
                        const option = presetSelect.querySelector(`option[value="${settings.id}"]`);
                        if (option) {
                            presetSelect.value = settings.id;
                        } else {
                            presetSelect.value = 'none';
                        }
                    }
                } else {
                    customOptions.classList.add('hidden');
                    presetSelect.value = 'none';
                }
            } catch (error) {
                console.error('Error loading tab disguiser settings:', error);
            }
        }

        /**
         * Saves the Tab Disguiser settings using urlChanger object
         */
        function saveTabDisguiserSettings(showMessage = true) {
            const messageEl = document.getElementById('tab-disguise-message');
            if (typeof window.urlChanger === 'undefined' || !window.urlChanger.savePreset) {
                if (showMessage) {
                    messageEl.textContent = 'Error: urlChanger script not found or is missing savePreset method.';
                    messageEl.className = 'message-area message-error';
                }
                return;
            }

            try {
                const presetSelect = document.getElementById('disguise-preset-select');
                const selectedOption = presetSelect.options[presetSelect.selectedIndex];
                const value = presetSelect.value;
                let settingsToSave = {};

                if (value === 'custom') {
                    settingsToSave.type = 'custom';
                    settingsToSave.title = document.getElementById('custom-title-input').value.trim();
                    
                    const selectedPickerItem = document.querySelector('.favicon-picker-item.selected');
                    const fetchedPreviewImg = document.getElementById('favicon-fetch-preview').querySelector('img');

                    if (selectedPickerItem) {
                        settingsToSave.favicon = selectedPickerItem.dataset.faviconUrl;
                    } else if (!fetchedPreviewImg.classList.contains('hidden') && fetchedPreviewImg.src) {
                        // If an image was fetched and is displayed, use it
                        settingsToSave.favicon = fetchedPreviewImg.src;
                    } else {
                        settingsToSave.favicon = ''; // Use original favicon
                    }

                } else if (value === 'none') {
                    settingsToSave.type = 'none';
                    settingsToSave.id = 'none';
                } else {
                    // It's a preset (from urlChanger, or one of our 4SP icons)
                    settingsToSave.type = 'preset';
                    settingsToSave.id = value;
                    
                    // Find the favicon URL from the preset
                    let preset = window.urlChanger.presets.find(p => p.id === value);
                    if (!preset) {
                        // Check 4SP icons
                        const fourspMatch = value.match(/^4sp-(\d+)$/);
                        if (fourspMatch) {
                            const index = parseInt(fourspMatch[1], 10);
                            preset = FOURSP_ICONS[index];
                        }
                    }
                    
                    settingsToSave.favicon = preset?.url || preset?.favicon || '';
                    settingsToSave.title = preset?.title || selectedOption.textContent;
                }

                // Apply and Save the settings
                window.urlChanger.savePreset(settingsToSave);

                if (showMessage) {
                    messageEl.textContent = 'Tab disguise settings successfully applied and saved!';
                    messageEl.className = 'message-area message-success';
                }

                // Apply the theme immediately if save was successful
                if (window.applyDisguise) {
                    window.applyDisguise(settingsToSave);
                }

            } catch (error) {
                console.error('Error saving tab disguise settings:', error);
                if (showMessage) {
                    messageEl.textContent = 'Failed to save tab disguise settings.';
                    messageEl.className = 'message-area message-error';
                }
            }
        }
        
        /**
         * Handles the "Fetch Favicon" button click
         */
        async function handleFaviconFetch() {
            if (typeof window.urlChanger === 'undefined' || !window.urlChanger.fetchFavicon || !window.urlChanger.addCustomFavicon) {
                showToastMessage('Error: urlChanger script is missing methods.', 'error');
                return;
            }

            const input = document.getElementById('favicon-fetch-input');
            const button = document.getElementById('fetch-favicon-btn');
            const previewImg = document.getElementById('favicon-fetch-preview').querySelector('img');
            const messageEl = document.getElementById('tab-disguise-message');
            
            let domain = input.value.trim();

            if (!domain) {
                messageEl.textContent = 'Please enter a website URL.';
                messageEl.className = 'message-area message-error';
                return;
            }

            button.disabled = true;
            button.textContent = '...';
            messageEl.textContent = 'Fetching...';
            messageEl.className = 'message-area message-warning';

            try {
                // Use the fetchFavicon method from url-tab-title-changer.js
                const faviconUrl = await window.urlChanger.fetchFavicon(domain);

                previewImg.src = faviconUrl;
                previewImg.classList.remove('hidden');

                // Deselect any picker items
                document.querySelectorAll('.favicon-picker-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add to custom favicons and re-render the grid immediately
                window.urlChanger.addCustomFavicon(faviconUrl);
                renderCustomFaviconGrid(); 

                messageEl.textContent = 'Favicon successfully fetched and added to picker!';
                messageEl.className = 'message-area message-success';

            } catch (error) {
                console.error("Error fetching favicon:", error);
                messageEl.textContent = error.message || 'Failed to fetch favicon. Check the URL and try again.';
                messageEl.className = 'message-area message-error';
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-globe mr-2"></i> Fetch Favicon';
            }
        }

        /* --- [END] UPDATED TAB DISGUISER FUNCTIONS --- */


        /* --- [START] PANIC KEY FUNCTIONS --- */

        // Helper function for IndexedDB interaction
        function openPanicKeyDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(PANIC_KEY_DB_NAME, 1);

                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(PANIC_KEY_STORE_NAME)) {
                        db.createObjectStore(PANIC_KEY_STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };

                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        /**
         * Renders the Panic Key settings panel.
         */
        function renderPanicKeySettings() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Panic Key Configuration</h3>
                    <p class="settings-description mb-4">
                        Set one or more keys and target URLs. When you press the key on any application page, 
                        it will instantly redirect to the specified URL. The settings page itself is excluded.
                    </p>
                    <div id="panic-key-list" class="space-y-4">
                        </div>
                    
                    <div class="flex items-center gap-4 mt-6">
                        <label for="panic-key-count" class="settings-label mb-0">Number of Panic Keys (1-5):</label>
                        <select id="panic-key-count" class="form-select w-20">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>
                
                <div class="settings-section">
                    <button id="save-panic-keys-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-save mr-2"></i> Save Panic Keys
                    </button>
                    <div id="panic-key-message" class="message-area"></div>
                </div>
            `;
            // --- END STYLING UPDATE ---

            // Load saved settings and update UI
            loadPanicKeySettings();

            // Attach listeners
            document.getElementById('panic-key-count').addEventListener('change', updatePanicKeyInputs);
            document.getElementById('save-panic-keys-btn').addEventListener('click', savePanicKeySettings);
        }

        /**
         * Dynamically updates the number of input fields based on the dropdown.
         * @param {Array<Object>} [settings=[]] - Optional array of settings to pre-fill the fields.
         */
        function updatePanicKeyInputs(settings = []) {
            const countSelect = document.getElementById('panic-key-count');
            const listContainer = document.getElementById('panic-key-list');
            if (!countSelect || !listContainer) return;

            const count = parseInt(countSelect.value, 10);
            listContainer.innerHTML = '';

            for (let i = 1; i <= count; i++) {
                const setting = settings[i - 1] || { key: '', url: '' };
                const item = document.createElement('div');
                item.className = 'bg-gray-800 p-4 rounded-lg border border-gray-700 space-y-3';
                item.innerHTML = `
                    <h4 class="text-lg font-medium text-white">Panic Key #${i}</h4>
                    <div class="flex items-center gap-4">
                        <div class="flex-shrink-0 w-24">
                            <label for="panicKey${i}" class="settings-label text-sm">Key (Single Char)</label>
                            <input type="text" id="panicKey${i}" class="form-input w-full" maxlength="1" value="${setting.key}" placeholder="e.g., Q">
                        </div>
                        <div class="flex-grow">
                            <label for="panicUrl${i}" class="settings-label text-sm">Target URL</label>
                            <input type="url" id="panicUrl${i}" class="form-input w-full" value="${setting.url}" placeholder="e.g., google.com/doodles">
                        </div>
                    </div>
                `;
                listContainer.appendChild(item);
            }
        }

        /**
         * Loads panic key settings from IndexedDB and updates the UI
         */
        async function loadPanicKeySettings() {
            try {
                const db = await openPanicKeyDB();
                const transaction = db.transaction(PANIC_KEY_STORE_NAME, 'readonly');
                const store = transaction.objectStore(PANIC_KEY_STORE_NAME);
                const request = store.getAll();

                request.onsuccess = () => {
                    const settings = request.result.sort((a, b) => {
                        // Extract index from id (e.g., "panicKey2") to sort correctly
                        const indexA = parseInt(a.id.match(/\d+$/)?.[0] || '0');
                        const indexB = parseInt(b.id.match(/\d+$/)?.[0] || '0');
                        return indexA - indexB;
                    });
                    
                    const countSelect = document.getElementById('panic-key-count');
                    if (countSelect) {
                        // Set the dropdown to the number of loaded keys, or 1 if none
                        countSelect.value = settings.length > 0 ? settings.length : 1;
                    }
                    
                    // Render the inputs with the loaded data
                    updatePanicKeyInputs(settings);
                };

                request.onerror = (event) => {
                    throw new Error(event.target.error);
                };

            } catch (error) {
                console.error("Error loading panic key settings:", error);
                document.getElementById('panic-key-message').textContent = 'Error loading settings from database.';
                document.getElementById('panic-key-message').className = 'message-area message-error';
            }
        }

        /**
         * Saves panic key settings to IndexedDB
         */
        async function savePanicKeySettings() {
            const messageEl = document.getElementById('panic-key-message');
            const count = parseInt(document.getElementById('panic-key-count').value, 10);
            const saveBtn = document.getElementById('save-panic-keys-btn');
            const settingsToSave = [];
            const keys = new Set();
            
            messageEl.textContent = '';
            
            for (let i = 1; i <= count; i++) {
                const keyInput = document.getElementById(`panicKey${i}`);
                const urlInput = document.getElementById(`panicUrl${i}`);
                
                if (!keyInput || !urlInput) continue;

                const key = keyInput.value.trim().toLowerCase();
                let url = urlInput.value.trim();

                if (!key || !url) {
                    messageEl.textContent = `Panic Key ${i} is incomplete.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }

                // Simplified Key validation: single, non-modifier character (letters, numbers, basic punctuation)
                if (key.length !== 1 || /[^a-z0-9`\-=\[\];',.\/\\ ]/.test(key)) {
                    messageEl.textContent = `Key for Panic Key ${i} is invalid. Use a single, non-special character.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }

                if (keys.has(key)) {
                    messageEl.textContent = `Duplicate key "${key}" found.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }

                // Simple URL regex check (matching old file)
                if (!/^(https?:\/\/)?((www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/i.test(url)) {
                    messageEl.textContent = `URL for Panic Key ${i} is invalid.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }

                keys.add(key);
                
                // Prepend protocol if missing
                if (!/^https?:\/\//i.test(url)) {
                    url = 'https://' + url;
                }

                // Store in the format panic-key.js expects
                settingsToSave.push({ id: `panicKey${i}`, key, url });
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';

            try {
                const db = await openPanicKeyDB();
                const transaction = db.transaction(PANIC_KEY_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(PANIC_KEY_STORE_NAME);
                
                // Clear all existing keys first
                await new Promise((resolve, reject) => {
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => resolve();
                    clearRequest.onerror = (event) => reject(event.target.error);
                });

                // Add the new settings
                for (const setting of settingsToSave) {
                    store.put(setting);
                }

                // Wait for the transaction to complete
                await new Promise((resolve) => {
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => { throw new Error(event.target.error); };
                });

                messageEl.textContent = 'Panic Key settings successfully saved!';
                messageEl.className = 'message-area message-success';

            } catch (error) {
                console.error("Error saving panic key settings:", error);
                messageEl.textContent = 'Error saving settings to database: ' + error.message;
                messageEl.className = 'message-area message-error';
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Panic Keys';
            }
        }

        /* --- [END] PANIC KEY FUNCTIONS --- */


        /* --- [START] DATA MANAGEMENT FUNCTIONS --- */

        /**
         * Renders the content for the "Data Management" tab
         */
        function renderDataManagement() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Export Game Data (strongdogxp)</h3>
                    <p class="settings-description mb-4">
                        Download a local JSON file containing your game's data stored in this browser's Local Storage. 
                        This file can be used to restore your progress on another device or browser.
                    </p>
                    <button id="export-data-btn" class="btn-base btn-secondary-style">
                        <i class="fas fa-download mr-2"></i> Download ${GAME_SAVE_FILENAME}
                    </button>
                    <div id="export-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Import Game Data (strongdogxp)</h3>
                    <p class="settings-description mb-4">
                        Upload a previously downloaded <code>${GAME_SAVE_FILENAME}</code> file to restore your game progress. 
                        <strong>Warning: This will overwrite your current local save for the game.</strong>
                    </p>
                    <div class="flex items-center gap-4">
                        <input type="file" id="import-file-input" accept="application/json" class="settings-input flex-grow">
                        <button id="import-data-btn" class="btn-base btn-primary-style" disabled>
                            <i class="fas fa-upload mr-2"></i> Import
                        </button>
                    </div>
                    <div id="import-message" class="message-area"></div>
                </div>
                
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-red-400 mb-4">Permanent Deletion Request</h3>
                    <p class="settings-description mb-4">
                        To request the permanent deletion of your account and all associated data from our servers (excluding local storage data), please visit the General settings page.
                    </p>
                    <button id="goto-general-delete-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-trash-alt mr-2"></i> Go to Account Deletion
                    </button>
                </div>
            `;
            // --- END STYLING UPDATE ---

            attachDataManagementListeners();
        }

        /**
         * Attaches event listeners for the Data Management panel
         */
        function attachDataManagementListeners() {
            const exportBtn = document.getElementById('export-data-btn');
            const importInput = document.getElementById('import-file-input');
            const importBtn = document.getElementById('import-data-btn');
            const gotoDeleteBtn = document.getElementById('goto-general-delete-btn');

            if (exportBtn) {
                exportBtn.addEventListener('click', downloadSaveFile);
            }
            
            if (gotoDeleteBtn) {
                gotoDeleteBtn.addEventListener('click', () => loadSection('general'));
            }

            if (importInput && importBtn) {
                // Enable/disable import button based on file selection
                importInput.addEventListener('change', () => {
                    importBtn.disabled = !importInput.files.length;
                });

                // Attach file upload handler
                importBtn.addEventListener('click', handleUploadFile);
            }
        }

        /**
         * Collects all keys and values from localStorage to prepare the export file.
         */
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Exclude system keys like the theme
                if (key && !key.startsWith('firebase:') && key !== NAVBAR_SETTINGS_KEY && key !== '4sp-telemetry-enabled') {
                    // Try to parse JSON data back into an object to preserve type, if it was stored as JSON
                    try {
                        const value = localStorage.getItem(key);
                        data[key] = JSON.parse(value);
                    } catch (e) {
                        // If parsing fails, store as string
                        data[key] = localStorage.getItem(key);
                    }
                }
            }
            return data;
        }
        
        /**
         * Initiates the download of the game save file.
         */
        function downloadSaveFile() {
            const message = document.getElementById('export-message');
            message.textContent = 'Preparing file...';
            message.className = 'message-area message-warning';

            try {
                const localStorageData = getAllLocalStorageData();
                
                // Create the final object to download
                const exportData = {
                    version: '1.0',
                    timestamp: new Date().toISOString(),
                    gameName: 'strongdogxp',
                    localStorageBackup: localStorageData
                };

                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = GAME_SAVE_FILENAME;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url); // Clean up the URL object

                message.textContent = 'Game data successfully downloaded!';
                message.className = 'message-area message-success';
                
            } catch (error) {
                console.error("Error during download:", error);
                message.textContent = 'Error: Failed to create or download file.';
                message.className = 'message-area message-error';
            }
        }

        /**
         * Applies the imported data to localStorage.
         * @param {Object} data - The parsed object containing key-value pairs.
         */
        function applyImportedData(data) {
            // Note: This function only updates existing keys or adds new ones. 
            // It does not clear all local storage, preventing loss of settings 
            // from *other* applications that may be sharing the same domain.
            for (const [key, value] of Object.entries(data)) {
                // Check if the key should be skipped (e.g., if we only want strongdogxp data)
                if (key === 'user-navbar-theme' || key === '4sp-telemetry-enabled' || key.startsWith('firebase:')) {
                    continue; 
                }
                
                // localStorage only stores strings, so convert objects back to JSON strings
                if (typeof value === 'object' && value !== null) {
                    localStorage.setItem(key, JSON.stringify(value));
                } else {
                    localStorage.setItem(key, value);
                }
            }
        }
        
        /**
         * Handles the file selection and parsing for import.
         */
        function handleUploadFile() {
            const input = document.getElementById('import-file-input');
            const button = document.getElementById('import-data-btn');
            const message = document.getElementById('import-message');

            if (!input.files.length) {
                message.textContent = 'Please select a file to import.';
                message.className = 'message-area message-error';
                return;
            }

            const confirmed = prompt(`This will overwrite all local game data. To confirm, type "IMPORT":`);
            if (confirmed !== 'IMPORT') {
                message.textContent = 'Import cancelled.';
                message.className = 'message-area message-warning';
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            message.textContent = `Reading ${file.name}...`;
            message.className = 'message-area message-warning';
            button.disabled = true;

            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (!importedData.localStorageBackup) {
                        throw new Error('Invalid save file format. Missing "localStorageBackup" field.');
                    }
                    
                    applyImportedData(importedData.localStorageBackup);
                    
                    message.textContent = 'Game data successfully imported! Please reload the game page to see changes.';
                    message.className = 'message-area message-success';

                } catch (error) {
                    console.error('Error importing file:', error);
                    message.textContent = `Error: Failed to process file. ${error.message}`;
                    message.className = 'message-area message-error';
                } finally {
                    button.disabled = false;
                    input.value = ''; // Clear file input
                }
            };

            reader.onerror = (e) => {
                console.error('Error reading file:', e.target.error);
                message.textContent = 'Error: Failed to read file from disk.';
                message.className = 'message-area message-error';
                button.disabled = false;
            };

            reader.readAsText(file);
        }

        /* --- END DATA MANAGEMENT FUNCTIONS --- */

        
        /* --- [START] NEW ABOUT 4SP FUNCTION --- */

        /**
         * Renders the content for the "About 4SP" tab
         */
        function renderAboutSection() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-2xl font-semibold text-white mb-2">(4SP) 4simpleproblems</h3>
                    <p class="text-sm text-gray-400 mb-4">Version 4.0.0-beta</p>

                    <p class="settings-description">
                        4simpleproblems is an application designed to provide tools and resources for students. 
                        Our mission is to simplify the complex challenges of modern digital learning environments 
                        by offering privacy, customization, and utility features.
                    </p>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Legal & Policies</h3>
                    <p class="settings-description">
                        Please review our legal documents to understand your rights and responsibilities.
                    </p>
                    <div class="space-y-3 mt-4">
                        <a href="../docs/terms-of-service.html" target="_blank" class="btn-base btn-secondary-style">
                            <i class="fas fa-file-contract mr-2"></i> Terms of Service
                        </a>
                        <a href="../docs/privacy-policy.html" target="_blank" class="btn-base btn-secondary-style">
                            <i class="fas fa-user-shield mr-2"></i> Privacy Policy
                        </a>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Stay Connected</h3>
                    <p class="settings-description mb-4">
                        Follow our development and get updates from the community.
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <a href="https://github.com/4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #181717; border-color: #333; color: white;">
                            <i class="fab fa-github fa-fw mr-3 text-lg"></i> GitHub
                        </a>
                        <a href="https://youtube.com/@4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #CD201F; border-color: #CD201F; color: white;">
                            <i class="fab fa-youtube fa-fw mr-3 text-lg"></i> YouTube
                        </a>
                        <a href="https://x.com/4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #1DA1F2; border-color: #1DA1F2; color: white;">
                            <i class="fab fa-twitter fa-fw mr-3 text-lg"></i> Twitter (X)
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #FFDD00; border-color: #FFDD00; color: #000000;">
                            <i class="fas fa-coffee fa-fw mr-3 text-lg"></i> Buy Me a Coffee
                        </a>
                    </div>
                </div>
            `;
            // --- END STYLING UPDATE ---
        }
        
        /* --- [END] NEW ABOUT 4SP FUNCTION --- */


        // --- START APPLICATION ---\
        document.addEventListener('DOMContentLoaded', startAuthFlow);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js" defer></script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
        /* Custom styles for the Beta Tester List */
        .beta-tester-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #111;
            border-radius: 0.5rem;
            border: 1px solid #252525;
        }
        .beta-tester-item:hover {
            background-color: #1a1a1a;
        }
        .message-area { 
            min-height: 20px; 
            margin-top: 0.5rem; 
            font-weight: 400; 
            font-size: 0.875rem; 
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-beta" class="btn-toolbar-style settings-tab hidden" data-tab="beta">
                    <i class="fa-solid fa-vial-virus w-5"></i> <span>Beta Testers</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p id="loadingText">Loading...</p>
    </div>
    
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider, 
            reauthenticateWithCredential, 
            updatePassword,
            // NEW AUTH IMPORTS
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            reauthenticateWithPopup,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            deleteDoc,
            // ADDED IMPORTS FOR BETA ACCESS MANAGEMENT:
            setDoc, // Needed for updating arrays atomically
            onSnapshot, // Needed for real-time list updates
            arrayUnion, // Needed for adding emails to array
            arrayRemove // Needed for removing emails from array
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config (Assumed to exist in a relative file) ---
        import { firebaseConfig } from "../firebase-config.js"; 
        
        // --- NEW: Import Site Mapping (from index.html logic) ---
        // This file MUST exist at ../site-mapping.js for import/export to work
        import { siteMapping } from "../site-mapping.js";


        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object
        
        // --- NEW: Global var for loading overlay (from index.html) ---
        let loadingTimeout = null;
        
        // Constants for validation and limits
        const MIN_LENGTH = 6; 
        const MAX_LENGTH = 24;
        const MAX_CHANGES = 5; 

        // --- NEW: Beta Tester Constants (from beta-settings.html) ---
        const ADMIN_EMAILS = [
            "belkwy30@minerva.sparcc.org",
            "4simpleproblems@gmail.com"
        ];
        const CONFIG_DOC_PATH = ['siteConfig', 'betaTesters']; // Document path for the list of beta testers
        
        // --- NEW: Beta Tester Global State (from beta-settings.html) ---
        let betaTesterList = null;
        let newTesterEmailInput = null;
        let addMessageDiv = null;
        let listMessageDiv = null;
        let testerCountSpan = null;
        let addTesterForm = null;
        let unsubscribe = null; // For onSnapshot listener

        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            // ADDED BETA TAB
            'beta': { title: 'Beta Testers', icon: 'fa-vial-virus' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // Constants for providers (NEW)
        const PROVIDER_CONFIG = {
            'google.com': { 
                name: 'Google', 
                icon: '../images/google-icon.png', 
                instance: () => new GoogleAuthProvider() 
            },
            'github.com': { 
                name: 'GitHub', 
                icon: '../images/github-mark-white.png', 
                instance: () => new GithubAuthProvider() 
            },
            'microsoft.com': { 
                name: 'Microsoft', 
                icon: '../images/microsoft.png', 
                instance: () => new OAuthProvider('microsoft.com') 
            },
            'password': { 
                name: 'Email & Password', 
                icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', 
                isCredential: true
            }
        };

        // --- NEW: Constants for Privacy Settings ---
        
        // IndexedDB Config for Panic Key
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';
        
        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';


        // Presets copied from url-changer.js
        const urlChangerPresets = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'gmm', name: 'GMM', title: 'Get More Math!', favicon: '../favicons/gmm.png', category: 'websites' },
            { id: 'kahoot', name: 'Kahoot', title: 'Kahoot! | Learning games | Make learning awesome!', favicon: '../favicons/kahoot.png', category: 'websites' },
            { id: 'g_classroom', name: 'Google Classroom', title: 'Home', favicon: '../favicons/google-classroom.png', category: 'websites' },
            { id: 'g_docs', name: 'Google Docs', title: 'Google Docs', favicon: '../favicons/google-docs.png', category: 'websites' },
            { id: 'g_slides', name: 'Google Slides', title: 'Google Slides', favicon: '../favicons/google-slides.png', category: 'websites' },
            { id: 'g_drive', name: 'Google Drive', title: 'Home - Google Drive', favicon: '../favicons/google-drive.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'clever', name: 'Clever', title: 'Clever | Connect every student to a world of learning', favicon: '../favicons/clever.png', category: 'websites' },
            { id: '_LIVE_CURRENT_TIME', name: 'Current Time', title: 'Live Time', favicon: '', category: 'live', live: true }
        ];

        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            // Prevent clearing a success message if a warning is generated elsewhere
            if (element && element.innerHTML.includes('success') && type !== 'error') return;
            if (element) {
                element.innerHTML = text;
                element.className = `general-message-area text-sm ${type}-message`;
            }
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };
        
        // --- NEW: IndexedDB Helper Functions ---

        /**
         * Opens the IndexedDB and creates the object store if needed.
         */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        /**
         * Fetches all panic key settings from IndexedDB.
         */
        async function getPanicKeySettings() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const settingsMap = new Map(request.result.map(item => [item.id, item]));
                    db.close();
                    resolve(settingsMap);
                };
                request.onerror = () => {
                     db.close();
                    reject(request.error);
                };
            });
        }
        
        /**
         * Saves panic key settings to IndexedDB.
         */
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                let completed = 0;
                const total = settingsArray.length;

                settingsArray.forEach(setting => {
                    const request = store.put(setting);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = () => {
                         db.close();
                        reject(request.error); // Stop on first error
                    };
                });
                
                // Handle case where array is empty
                if (total === 0) {
                     db.close();
                    resolve();
                }
            });
        }

        // --- NEW: localStorage Helper Functions ---
        
        function getSavedUrlChangerSetting() {
            const savedSettingsJSON = localStorage.getItem(URL_CHANGER_KEY);
            let savedSettings = { type: 'none' };
            if (savedSettingsJSON) {
                try { 
                    savedSettings = JSON.parse(savedSettingsJSON); 
                } catch (e) {
                    console.error("Error parsing URL Changer settings:", e);
                }
            }
            return savedSettings;
        }

        function saveUrlChangerSetting(settings) {
             try {
                localStorage.setItem(URL_CHANGER_KEY, JSON.stringify(settings));
                return true;
            } catch (e) {
                console.error("Error saving URL Changer settings:", e);
                return false;
            }
        }
        
        // --- NEW: Beta Tester Functions (from beta-settings.html) ---

        /**
         * Renders the current list of beta testers.
         * @param {string[]} emailList Array of beta tester emails.
         */
        function renderTesterList(emailList) {
            if (!betaTesterList || !testerCountSpan) return;

            testerCountSpan.textContent = `(${emailList.length} Testers)`;
            
            if (emailList.length === 0) {
                betaTesterList.innerHTML = `<p class="text-gray-400 text-center p-4">No beta testers have been added yet.</p>`;
                return;
            }

            const listHtml = emailList.sort().map(email => `
                <div class="beta-tester-item">
                    <span class="text-white text-sm break-all">${email}</span>
                    <button class="btn-toolbar-style btn-primary-override-danger" 
                            data-email="${email}" 
                            data-action="remove" 
                            style="padding: 0.5rem 0.75rem;">
                        <i class="fa-solid fa-user-minus"></i> Remove
                    </button>
                </div>
            `).join('');

            betaTesterList.innerHTML = listHtml;
            
            // Add listeners for remove buttons
            betaTesterList.querySelectorAll('button[data-action="remove"]').forEach(button => {
                button.addEventListener('click', () => {
                    const emailToRemove = button.dataset.email;
                    if (emailToRemove && confirm(`Are you sure you want to remove ${emailToRemove} from the beta tester list?`)) {
                        removeTester(emailToRemove, button);
                    }
                });
            });
        }

        /**
         * Sets up a real-time listener for the beta tester list in Firestore.
         */
        function setupRealtimeListener() {
            // Unsubscribe from any previous listener
            if (unsubscribe) {
                unsubscribe();
            }

            const docRef = doc(db, ...CONFIG_DOC_PATH);

            unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data() && docSnap.data().emails) {
                    const emails = docSnap.data().emails;
                    renderTesterList(emails);
                } else {
                    // Document doesn't exist or is empty, treat as no testers
                    renderTesterList([]);
                }
            }, (error) => {
                console.error("Error setting up beta tester listener:", error);
                if(listMessageDiv) {
                    showMessage(listMessageDiv, 'Error loading beta tester list.', 'error');
                }
            });
        }

        /**
         * Adds a new email to the beta tester list.
         * @param {string} email The email to add.
         */
        async function addTester(email) {
            if (!addMessageDiv) return;

            const normalizedEmail = email.toLowerCase().trim();
            const docRef = doc(db, ...CONFIG_DOC_PATH);

            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(normalizedEmail)) {
                 showMessage(addMessageDiv, 'Please enter a valid email address.', 'error');
                 return;
            }

            try {
                // Show loading message
                showMessage(addMessageDiv, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Adding tester...', 'warning');

                // Add the email using arrayUnion for atomicity and to prevent duplicates
                await setDoc(docRef, { emails: arrayUnion(normalizedEmail) }, { merge: true });

                showMessage(addMessageDiv, `Successfully added ${normalizedEmail} as a beta tester.`, 'success');
                if (newTesterEmailInput) newTesterEmailInput.value = ''; // Clear input on success
            } catch (error) {
                console.error("Error adding beta tester:", error);
                showMessage(addMessageDiv, 'Failed to add tester. An unexpected error occurred.', 'error');
            }
        }

        /**
         * Removes an email from the beta tester list.
         * @param {string} email The email to remove.
         */
        async function removeTester(email, button) {
            if (!listMessageDiv) return;

            const normalizedEmail = email.toLowerCase().trim();
            const docRef = doc(db, ...CONFIG_DOC_PATH);

            button.disabled = true; // Disable button immediately

            try {
                showMessage(listMessageDiv, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Removing ${normalizedEmail}...`, 'warning');

                // Remove the email using arrayRemove
                await updateDoc(docRef, {
                    emails: arrayRemove(normalizedEmail)
                });

                showMessage(listMessageDiv, `Successfully removed ${normalizedEmail}.`, 'success');
            } catch (error) {
                console.error("Error removing beta tester:", error);
                showMessage(listMessageDiv, 'Failed to remove tester. An unexpected error occurred.', 'error');
            } finally {
                button.disabled = false;
            }
        }
        
        /**
         * Handles the form submission for adding a new tester.
         */
        function handleAddTesterSubmit(e) {
            e.preventDefault();
            if (newTesterEmailInput) {
                const email = newTesterEmailInput.value;
                if (email) {
                    addTester(email);
                }
            }
        }
        
        // --- Tab Content Generator Functions ---
        
        // Existing functions getGeneralContent(), getPrivacyContent(), etc. need to be present here.
        // Assuming they are present but omitted for brevity in the combination.
        // The new function is provided below.
        
        /**
         * NEW: Generates the HTML for the "Beta Testers" section.
         */
        function getBetaTestersContent() {
             return `
                <h2 class="text-3xl font-bold text-white mb-6">Beta Tester Access</h2>
                
                <div class="w-full">
                    <p class="text-sm font-light text-gray-400 mb-4">
                        Manage the list of users who have access to beta features. Only administrators can view and modify this list.
                        <span id="testerCount" class="text-blue-400 font-medium"></span>
                    </p>

                    <h3 class="text-xl font-bold text-white mb-2">Add New Tester (Email)</h3>
                    <div class="settings-box transition-all duration-300 p-4 mb-6">
                        <form id="addTesterForm" class="flex flex-col sm:flex-row gap-3">
                            <input type="email" 
                                id="newTesterEmail" 
                                class="input-text-style flex-grow" 
                                placeholder="Enter user's email address (e.g., example@domain.com)" 
                                required>
                            <button type="submit" 
                                class="btn-toolbar-style btn-primary-override sm:w-48" 
                                style="padding: 0.75rem 1rem;">
                                <i class="fa-solid fa-user-plus mr-1"></i> Add Tester
                            </button>
                        </form>
                        <div id="addMessage" class="message-area"></div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2">Current Beta Testers</h3>
                    <div id="betaTesterListContainer" class="settings-box transition-all duration-300 p-4">
                        <div id="betaTesterList" class="space-y-2 max-h-72 overflow-y-auto pr-2">
                            <p class="text-gray-400 text-center p-4">Loading list...</p>
                        </div>
                        <div id="listMessage" class="message-area"></div>
                    </div>
                </div>
            `;
        }

        /**
         * NEW: Loads data and adds event listeners for the Beta Testers tab.
         */
        function loadBetaTestersTab() {
            // Unsubscribe from any previous listener if switching tabs
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }
            
            // 1. Re-query DOM elements for this panel and attach listeners
            betaTesterList = document.getElementById('betaTesterList');
            newTesterEmailInput = document.getElementById('newTesterEmail');
            addMessageDiv = document.getElementById('addMessage');
            listMessageDiv = document.getElementById('listMessage');
            testerCountSpan = document.getElementById('testerCount');
            addTesterForm = document.getElementById('addTesterForm');

            if(addTesterForm) {
                addTesterForm.addEventListener('submit', handleAddTesterSubmit);
            }

            // 2. Start the real-time data listener
            setupRealtimeListener();
        }

        
        // --- Tab Switching Logic (Modified) ---

        /**
         * Loads content and sets up event listeners for the selected tab.
         * @param {string} tabId The ID of the tab to switch to.
         */
        async function switchTab(tabId) {
            // 1. Clean up/stop previous listeners (IMPORTANT: only stop the one in beta tab)
            if (unsubscribe) {
                unsubscribe();
                unsubscribe = null;
            }

            // 2. Update sidebar active state
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });

            // 3. Load content for the selected tab
            if (tabId === 'general') {
                // ... Existing General logic ...
            } else if (tabId === 'privacy') {
                // ... Existing Privacy logic ...
            } else if (tabId === 'personalization') {
                // ... Existing Personalization logic ...
            } else if (tabId === 'data') {
                // ... Existing Data Management logic ...
            } else if (tabId === 'beta') {
                mainView.innerHTML = getBetaTestersContent();
                loadBetaTestersTab();
            } else if (tabId === 'about') {
                // ... Existing About logic ...
            } else {
                // ... Default coming soon content ...
            }

            // 4. Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load (Modified to show Beta Tab conditionally) ---
        
        /**
         * Hides the beta tab if the current user is not in the ADMIN_EMAILS list.
         */
        function checkAndSetBetaAccess(user) {
            const betaTab = document.getElementById('tab-beta');
            const userEmail = user.email ? user.email.toLowerCase() : '';
            
            if (betaTab) {
                if (ADMIN_EMAILS.includes(userEmail)) {
                    betaTab.classList.remove('hidden');
                } else {
                    betaTab.classList.add('hidden');
                }
            }
        }
        
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    
                    // NEW: Check and set visibility for the Beta Tab
                    checkAndSetBetaAccess(user);
                    
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js" defer></script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p id="loadingText">Loading...</p>
    </div>
    
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider, 
            reauthenticateWithCredential, 
            updatePassword,
            // NEW AUTH IMPORTS
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            reauthenticateWithPopup,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            deleteDoc // NEW FIREBASE IMPORT
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config (Assumed to exist in a relative file) ---
        import { firebaseConfig } from "../firebase-config.js"; 
        
        // --- NEW: Import Site Mapping (from index.html logic) ---
        // This file MUST exist at ../site-mapping.js for import/export to work
        import { siteMapping } from "../site-mapping.js";


        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object
        
        // --- NEW: Global var for loading overlay (from index.html) ---
        let loadingTimeout = null;
        
        // Constants for validation and limits
        const MIN_LENGTH = 6; 
        const MAX_LENGTH = 24;
        const MAX_CHANGES = 5; 


        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // Constants for providers (NEW)
        const PROVIDER_CONFIG = {
            'google.com': { 
                name: 'Google', 
                icon: '../images/google-icon.png', 
                instance: () => new GoogleAuthProvider() 
            },
            'github.com': { 
                name: 'GitHub', 
                icon: '../images/github-mark-white.png', 
                instance: () => new GithubAuthProvider() 
            },
            'microsoft.com': { 
                name: 'Microsoft', 
                icon: '../images/microsoft.png', 
                instance: () => new OAuthProvider('microsoft.com') 
            },
            'password': { 
                name: 'Email & Password', 
                icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', 
                isCredential: true
            }
        };

        // --- NEW: Constants for Privacy Settings ---
        
        // IndexedDB Config for Panic Key
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';
        
        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';


        // Presets copied from url-changer.js
        const urlChangerPresets = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'gmm', name: 'GMM', title: 'Get More Math!', favicon: '../favicons/gmm.png', category: 'websites' },
            { id: 'kahoot', name: 'Kahoot', title: 'Kahoot! | Learning games | Make learning awesome!', favicon: '../favicons/kahoot.png', category: 'websites' },
            { id: 'g_classroom', name: 'Google Classroom', title: 'Home', favicon: '../favicons/google-classroom.png', category: 'websites' },
            { id: 'g_docs', name: 'Google Docs', title: 'Google Docs', favicon: '../favicons/google-docs.png', category: 'websites' },
            { id: 'g_slides', name: 'Google Slides', title: 'Google Slides', favicon: '../favicons/google-slides.png', category: 'websites' },
            { id: 'g_drive', name: 'Google Drive', title: 'Home - Google Drive', favicon: '../favicons/google-drive.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'clever', name: 'Clever', title: 'Clever | Connect every student to a world of learning', favicon: '../favicons/clever.png', category: 'websites' },
            { id: '_LIVE_CURRENT_TIME', name: 'Current Time', title: 'Live Time', favicon: '', category: 'live', live: true }
        ];

        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            // Prevent clearing a success message if a warning is generated elsewhere
            if (element && element.innerHTML.includes('success') && type !== 'error') return;
            if (element) {
                element.innerHTML = text;
                element.className = `general-message-area text-sm ${type}-message`;
            }
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };
        
        // --- NEW: IndexedDB Helper Functions ---

        /**
         * Opens the IndexedDB and creates the object store if needed.
         */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        /**
         * Fetches all panic key settings from IndexedDB.
         */
        async function getPanicKeySettings() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const settingsMap = new Map(request.result.map(item => [item.id, item]));
                    db.close();
                    resolve(settingsMap);
                };
                request.onerror = () => {
                     db.close();
                    reject(request.error);
                };
            });
        }
        
        /**
         * Saves panic key settings to IndexedDB.
         */
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                let completed = 0;
                const total = settingsArray.length;

                settingsArray.forEach(setting => {
                    const request = store.put(setting);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = () => {
                         db.close();
                        reject(request.error); // Stop on first error
                    };
                });
                
                // Handle case where array is empty
                if (total === 0) {
                     db.close();
                    resolve();
                }
            });
        }

        // --- NEW: localStorage Helper Functions ---
        
        function getSavedUrlChangerSetting() {
            const savedSettingsJSON = localStorage.getItem(URL_CHANGER_KEY);
            let savedSettings = { type: 'none' };
            if (savedSettingsJSON) {
                try { 
                    savedSettings = JSON.parse(savedSettingsJSON); 
                } catch (e) { 
                    console.error("Failed to parse saved tab settings, reverting to default.", e); 
                }
            }
            return savedSettings;
        }

        function saveUrlChangerSetting(settings) {
            try {
                localStorage.setItem(URL_CHANGER_KEY, JSON.stringify(settings));
                return true;
            } catch (e) {
                console.error("Failed to save URL changer settings:", e);
                return false;
            }
        }
        
        // --- NEW: Modal and Loading Functions (from index.html) ---
        
        function openModal(text, buttons = []) {
            const modal = document.getElementById('modalPrompt');
            const modalText = document.getElementById('modalText');
            const modalButtons = document.getElementById('modalButtons');
            
            modalText.textContent = text;
            modalButtons.innerHTML = "";
            buttons.forEach(btn => {
                const buttonEl = document.createElement("button");
                // MODIFICATION: Use settings page button styles
                buttonEl.className = "btn-toolbar-style";
                if (btn.text.toLowerCase() === 'yes') {
                    buttonEl.classList.add('btn-primary-override-danger'); // Make 'Yes' destructive
                } else {
                    buttonEl.classList.add('btn-primary-override');
                }
                buttonEl.textContent = btn.text;
                buttonEl.onclick = btn.onclick;
                modalButtons.appendChild(buttonEl);
            });
            modal.style.display = "flex";
        }
        
        function showLoading(text = "Loading...") {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000); // 5 second timeout
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }
        
        // --- NEW: Core Data Functions (from index.html) ---
        
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Skip theme key
                if (key === THEME_STORAGE_KEY) continue;
                // Skip URL changer key
                if (key === URL_CHANGER_KEY) continue;
                
                const value = localStorage.getItem(key);
                data[key] = value;
            }
            return data;
        }

        function setAllLocalStorageData(data) {
            // Don't clear *everything*, just the keys in the data
            // This avoids wiping the user's theme setting
            for (const [key, value] of Object.entries(data)) {
                localStorage.setItem(key, value);
            }
        }

        async function getAllIndexedDBData() {
            if (!indexedDB.databases) return {};
            let dbList = [];
            try {
                dbList = await indexedDB.databases();
            } catch (error) {
                console.error("Error fetching IndexedDB databases:", error);
                return {};
            }
            const result = {};
            for (const dbInfo of dbList) {
                if (!dbInfo.name) continue;
                // Skip our own settings DB
                if (dbInfo.name === DB_NAME) continue; 
                
                result[dbInfo.name] = await getDataFromDatabase(dbInfo.name);
            }
            return result;
        }

        function getDataFromDatabase(dbName) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName);
                request.onsuccess = event => {
                    const db = event.target.result;
                    const storeNames = Array.from(db.objectStoreNames);
                    const dbData = {};
                    let pending = storeNames.length;
                    if (pending === 0) {
                        db.close();
                        resolve(dbData);
                        return;
                    }
                    storeNames.forEach(storeName => {
                        const transaction = db.transaction(storeName, "readonly");
                        const store = transaction.objectStore(storeName);
                        const items = [];
                        const cursorRequest = store.openCursor();
                        cursorRequest.onsuccess = evt => {
                            const cursor = evt.target.result;
                            if (cursor) {
                                items.push({ key: cursor.key, value: cursor.value });
                                cursor.continue();
                            } else {
                                dbData[storeName] = items;
                                pending--;
                                if (pending === 0) {
                                    db.close();
                                    resolve(dbData);
                                }
                            }
                        };
                        cursorRequest.onerror = evt => {
                            pending--;
                            if (pending === 0) {
                                db.close();
                                resolve(dbData);
                            }
                        };
                    });
                };
                request.onerror = event => {
                    reject(event.target.error);
                };
            });
        }

        async function setAllIndexedDBData(indexedData) {
            for (const dbName in indexedData) {
                const storesData = indexedData[dbName];

                // 1. Delete and re-create database to ensure schema/stores are correct
                await new Promise(resolve => {
                    const deleteRequest = indexedDB.deleteDatabase(dbName);
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => resolve();
                    deleteRequest.onblocked = () => resolve();
                });

                const openRequest = indexedDB.open(dbName, 1);
                openRequest.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    for (const storeName in storesData) {
                        if (!db.objectStoreNames.contains(storeName)) {
                            // Assuming all restored stores use out-of-line keys and no autoincrement
                            db.createObjectStore(storeName, { autoIncrement: false }); 
                        }
                    }
                };

                const dbInstance = await new Promise((resolve, reject) => {
                    openRequest.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    openRequest.onerror = event => {
                        reject(event.target.error);
                    };
                });
                
                // 2. Clear stores and put data
                for (const storeName in storesData) {
                    await new Promise(resolve => {
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => resolve();
                        const store = transaction.objectStore(storeName);

                        const clearRequest = store.clear();
                        clearRequest.onsuccess = async () => {
                            for (const record of storesData[storeName]) {
                                await new Promise(r => {
                                    const putRequest = store.put(record.value, record.key);
                                    putRequest.onsuccess = () => r();
                                    putRequest.onerror = () => r();
                                });
                            }
                        };
                    });
                }
                dbInstance.close();
            }
        }
        
        // --- NEW: Domain Key Functions (from index.html) ---

        /**
         * Finds the corresponding key (or 'default') for the current URL.
         */
        function getCurrentSiteKey() {
            const currentURL = window.location.href;
            const keys = Object.keys(siteMapping);
            
            // Sort keys by length descending to match the longest domain first
            keys.sort((a, b) => b.length - a.length);

            for (const key of keys) {
                // Normalize the key for matching
                const normalizedKey = key.replace(/^https?:\/\//, '');

                if (currentURL.includes(normalizedKey)) {
                    return key; // Return the full key including protocol (if present)
                }
            }
            return 'default';
        }

        /**
         * Handles the click on the 'View Legal' button.
         */
        function viewLegal(type) {
             const siteKey = getCurrentSiteKey();
             const map = siteMapping[siteKey] || siteMapping.default;
             
             let legalUrl = '#';
             if (type === 'privacy' && map.privacy_policy) {
                 legalUrl = map.privacy_policy;
             } else if (type === 'tos' && map.terms_of_service) {
                 legalUrl = map.terms_of_service;
             }
             
             if (legalUrl !== '#') {
                 window.open(legalUrl, '_blank');
             } else {
                 openModal(`No ${type === 'privacy' ? 'Privacy Policy' : 'Terms of Service'} defined for this domain.`, [
                     { text: 'Okay', onclick: () => document.getElementById('modalPrompt').style.display = 'none' }
                 ]);
             }
        }

        // --- Tab Content Generator Functions ---
        
        /**
         * Generates the HTML for the Change Password section.
         */
        function getChangePasswordSection() {
            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Change Password</h3>
                <div id="passwordSection" class="settings-box w-full p-4">
                    <p class="text-sm font-light text-gray-400 mb-4">You must re-authenticate with your current password to set a new one.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label for="currentPassword" class="block text-sm font-medium text-gray-400 mb-1">Current Password</label>
                            <input type="password" id="currentPassword" class="input-text-style" placeholder="********" autocomplete="current-password">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-medium text-gray-400 mb-1">New Password</label>
                            <input type="password" id="newPassword" class="input-text-style" placeholder="New Password" autocomplete="new-password">
                            <p class="text-xs text-gray-500 mt-1">Min. ${MIN_LENGTH} characters.</p>
                        </div>
                        <div>
                            <label for="confirmNewPassword" class="block text-sm font-medium text-gray-400 mb-1">Confirm New Password</label>
                            <input type="password" id="confirmNewPassword" class="input-text-style" placeholder="Confirm New Password" autocomplete="new-password">
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-2">
                        <p id="passwordMessage" class="general-message-area text-sm"></p>
                        <button id="changePasswordBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-check mr-1"></i> Apply
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Generates the HTML for the Linked Providers list.
         * @param {Array} providerData - Array of provider objects from Firebase.
         * @returns {string} HTML string.
         */
        function getLinkedProvidersContent(providerData) {
            const primaryProviderId = providerData[0]?.providerId;
            let linkedProvidersHtml = '';
            let availableProvidersHtml = '';
            let unlinkedProviders = [];
            
            // Populate linked and unlinked lists
            for (const [id, config] of Object.entries(PROVIDER_CONFIG)) {
                if (id === 'microsoft.com') continue; // Microsoft provider is currently disabled
                
                const isLinked = providerData.some(p => p.providerId === id);
                const isPrimary = id === primaryProviderId;
                const isOnlyOne = providerData.length === 1;
                
                if (isLinked) {
                    // Linked Providers HTML
                    linkedProvidersHtml += `
                        <div class="flex justify-between items-center py-3 px-4 border-b border-[#1a1a1a] last:border-b-0">
                            <div class="flex items-center">
                                ${config.isCredential ? config.icon : `<img src="${config.icon}" class="w-5 h-5 mr-3" alt="${config.name} icon">`}
                                <span class="text-lg font-medium text-white">${config.name}</span>
                                ${isPrimary ? '<span class="ml-3 text-xs font-light text-blue-400 border border-blue-400 px-2 py-0.5 rounded">Primary</span>' : ''}
                            </div>
                            ${(!isOnlyOne || !isPrimary) ? 
                                `<button class="btn-toolbar-style w-24" data-provider-id="${id}" data-action="unlink" style="padding: 0.5rem 0.75rem;" ${isPrimary ? 'disabled' : ''}>
                                    <i class="fa-solid fa-unlink mr-1"></i> Unlink
                                </button>` 
                                : 
                                '<button class="btn-toolbar-style w-24 opacity-50 cursor-not-allowed" disabled style="padding: 0.5rem 0.75rem;">Primary</button>'
                            }
                        </div>
                    `;
                } else {
                    unlinkedProviders.push({ id, config });
                }
            }

            // Available Providers HTML (only for unlinked ones)
            unlinkedProviders.forEach(({ id, config }) => {
                availableProvidersHtml += `
                    <div class="flex justify-between items-center py-3 px-4 border-b border-[#1a1a1a] last:border-b-0">
                        <div class="flex items-center">
                             ${config.isCredential ? config.icon : `<img src="${config.icon}" class="w-5 h-5 mr-3" alt="${config.name} icon">`}
                            <span class="text-lg font-medium text-white">${config.name}</span>
                        </div>
                        <button class="btn-toolbar-style btn-primary-override w-24" data-provider-id="${id}" data-action="link" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-link mr-1"></i> Link
                        </button>
                    </div>
                `;
            });
            
            // Account Deletion Section
            let deletionContent = getAccountDeletionContent(primaryProviderId);


            // --- Combined HTML for Account Management ---
            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Linked Providers</h3>
                <div class="settings-box w-full mb-4 p-0" data-section="linked-providers">
                    ${linkedProvidersHtml}
                </div>
                <h3 class="text-xl font-bold text-white mb-2">Link New Providers</h3>
                <div class="settings-box w-full flex flex-col gap-0 p-0">
                    ${availableProvidersHtml}
                </div>
                ${deletionContent}
            `;
        }
        
        /**
         * Generates the HTML for the Account Deletion section.
         * @param {string} primaryProviderId - The provider ID used for primary authentication.
         * @returns {string} HTML string.
         */
        function getAccountDeletionContent(primaryProviderId) {
            let reauthInput = '';
            let isEmailPassword = primaryProviderId === 'password';

            if (isEmailPassword) {
                // If primary is Email/Password, prompt for password
                reauthInput = `
                    <div class="w-full md:w-1/2">
                        <label for="deletePasswordInput" class="block text-sm font-medium text-gray-400 mb-1">Enter Current Password</label>
                        <input type="password" id="deletePasswordInput" class="input-text-style" placeholder="********" autocomplete="current-password">
                    </div>
                `;
            }
            // The button logic changes depending on if it's Email/Password or Social
            // Email/Password uses the password input for reauth and the main button
            // Social uses a re-authenticate button to trigger a popup, then a final delete button
            
            // For Email/Password, the Re-authenticate button will actually be the final delete button, 
            // but the text inside the warning will reflect the need for the password.
            
            const reauthenticateBtnId = isEmailPassword ? 'finalDeleteBtn' : 'reauthenticateBtn';
            const finalDeleteBtnClass = isEmailPassword ? 'hidden' : ''; // Social has a separate final button

            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                <div id="deletionSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                    <p class="text-sm font-light text-red-300 mb-3">
                        <i class="fa-solid fa-triangle-exclamation mr-1"></i> WARNING: Deleting your account is permanent. You must re-authenticate with ${PROVIDER_CONFIG[primaryProviderId].name} to proceed.
                    </p>
                    ${reauthInput}
                    <div class="flex justify-between items-center pt-2">
                        <p id="deleteMessage" class="general-message-area text-sm"></p>
                        
                        <button id="reauthenticateBtn" class="btn-toolbar-style w-48 btn-primary-override ${isEmailPassword ? 'hidden' : ''}" data-provider-id="${primaryProviderId}" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-key mr-1"></i> Re-authenticate
                        </button>
                        
                        <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48 ${finalDeleteBtnClass}" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-trash mr-1"></i> Delete Account
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "General Settings" section.
         */
        function getGeneralContent(currentUsername, changesRemaining, changesThisMonth, currentMonthName, isEmailPasswordUser, providerData) {
            const changesUsed = changesThisMonth;
            // Conditionally generate the password section HTML
            let passwordSectionHtml = '';
            if (isEmailPasswordUser) {
                passwordSectionHtml = getChangePasswordSection();
            }
            
            // Generate the Linked Providers section HTML
            const linkedProvidersHtml = getLinkedProvidersContent(providerData);

            return `
                <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Username</h3>
                    <div id="usernameSection" class="settings-box w-full p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">You can change your username ${MAX_CHANGES} times per month.</p>
                        <div class="flex items-end gap-4">
                            <div class="flex-grow">
                                <label for="newUsername" class="block text-sm font-medium text-gray-400 mb-1">New Username</label>
                                <input type="text" id="newUsername" class="input-text-style" value="${currentUsername}" placeholder="Enter new username">
                                <p class="text-xs text-gray-500 mt-1">Changes remaining this month: ${changesRemaining}</p>
                            </div>
                            <button id="changeUsernameBtn" class="btn-toolbar-style btn-primary-override w-36" ${changesRemaining <= 0 ? 'disabled' : ''} style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply
                            </button>
                        </div>
                        <p id="usernameMessage" class="general-message-area text-sm"></p>
                    </div>
                    
                    ${passwordSectionHtml}
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Account Management</h3>
                    <div class="settings-box w-full p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">Manage how you sign in to 4SP by linking or unlinking social accounts.</p>
                        ${linkedProvidersHtml}
                    </div>
                </div>
            `;
        }
        
        /**
         * Generates the HTML for the "Privacy & Security" section.
         */
        function getPrivacySecurityContent() {
            // Generate preset options
            const presetOptions = urlChangerPresets.map(preset => `<option value="${preset.id}">${preset.name}</option>` ).join('');

            return `
                <h2 class="text-3xl font-bold text-white mb-6">Privacy & Security</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Panic Key Settings</h3>
                    <div id="panicKeySection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Configure up to 3 panic keys. Pressing the specified key (without Shift, Ctrl, or Alt) on any page will redirect you to the URL you set.
                            <br>
                            <span class="text-yellow-400">Valid keys:</span> a-z, 0-9, and \` - = [ ] \\ ; ' , . /
                        </p>
                        <div class="flex items-center gap-4 px-2 mb-2">
                            <label class="block text-gray-400 text-sm font-light" style="width: 4rem; text-align: center;">Key</label>
                            <label class="block text-gray-400 text-sm font-light flex-grow">Redirect URL</label>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey1" data-key-id="1" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl1" class="input-text-style" placeholder="e.g., https://google.com">
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey2" data-key-id="2" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl2" class="input-text-style" placeholder="e.g., https://bing.com">
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey3" data-key-id="3" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl3" class="input-text-style" placeholder="e.g., https://news.google.com">
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                            <button id="applyPanicKeyBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Tab Disguise (URL Changer)</h3>
                    <div id="urlChangerSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Change the page title and favicon to disguise this page. This setting is saved locally and applies instantly on page load.
                        </p>
                        <div class="mb-4">
                            <label for="urlChangerMode" class="block text-sm font-medium text-gray-400 mb-1">Disguise Mode</label>
                            <select id="urlChangerMode" class="input-select-style">
                                <option value="none">None (Default 4SP Title/Favicon)</option>
                                <option value="preset">Use Preset Disguise</option>
                                <option value="custom">Use Custom Disguise</option>
                            </select>
                        </div>
                        
                        <div id="presetGroup" class="hidden">
                            <label for="presetSelect" class="block text-sm font-medium text-gray-400 mb-1">Select Preset</label>
                            <select id="presetSelect" class="input-select-style mb-4">
                                ${presetOptions}
                            </select>
                        </div>
                        
                        <div id="customGroup" class="hidden grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="customTitle" class="block text-sm font-medium text-gray-400 mb-1">Custom Tab Title</label>
                                <input type="text" id="customTitle" class="input-text-style mb-4" placeholder="e.g., Google Drive">
                                
                                <label for="customFavicon" class="block text-sm font-medium text-gray-400 mb-1">Custom Favicon URL</label>
                                <input type="url" id="customFavicon" class="input-text-style" placeholder="e.g., https://example.com/favicon.ico">
                                <p class="text-xs text-gray-500 mt-1">Must be a direct link to an image/icon file.</p>
                                
                                <button id="fetchFaviconBtn" class="btn-toolbar-style w-full mt-3" style="padding: 0.5rem 0.75rem;">
                                    <i class="fa-solid fa-cloud-arrow-down mr-1"></i> Preview Favicon
                                </button>
                            </div>
                            <div class="flex flex-col items-center justify-center p-4 border border-[#252525] rounded-lg">
                                <p class="text-sm font-medium text-gray-400 mb-2">Favicon Preview</p>
                                <div class="w-16 h-16 flex items-center justify-center border border-gray-600 rounded-lg overflow-hidden p-1">
                                    <img id="faviconPreviewImg" src="" alt="Preview" class="w-full h-full object-contain" style="display: none;">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="urlChangerMessage" class="general-message-area text-sm"></p>
                            <button id="applyUrlChangerBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Tab
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * NEW: Generates the HTML for the "Personalization" section.
         */
        function getPersonalizationContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Personalization</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Navigation Bar Theme</h3>
                    <div id="themeSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Select a theme for your navigation bar. This setting is saved locally and will apply a live preview.
                        </p>
                        <div id="theme-picker-container">
                            <div class="flex items-center justify-center p-8">
                                <i class="fa-solid fa-spinner fa-spin fa-2x text-gray-500"></i>
                            </div>
                        </div>
                        <div id="themeMessage" class="general-message-area text-sm"></div>
                    </div>
                </div>
            `;
        }

        // --- NEW: Generates the HTML for the "Data Management" section ---
        function getDataManagementContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Data Management</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Local Saves Backup</h3>
                    <div id="saveBackupSection" class="settings-box w-full p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Export or Import a backup of your local website data, including **Local Storage** (e.g., app data) and **IndexedDB** (e.g., Note App entries, other game saves).
                        </p>
                        <div class="flex gap-4">
                            <button id="exportSavesBtn" class="btn-toolbar-style w-full btn-primary-override">
                                <i class="fa-solid fa-cloud-arrow-down mr-1"></i> Export Saves
                            </button>
                            <button id="importSavesBtn" class="btn-toolbar-style w-full">
                                <i class="fa-solid fa-cloud-arrow-up mr-1"></i> Import Saves
                            </button>
                        </div>
                        <p id="dataMessage" class="general-message-area text-sm"></p>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Wipe Local Data</h3>
                    <div id="wipeDataSection" class="settings-box w-full bg-yellow-900/10 border-yellow-700/50 p-4">
                        <p class="text-sm font-light text-yellow-300 mb-4">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> WARNING: This action will permanently delete all local data, including app saves, settings, and credentials stored in **Local Storage** and **IndexedDB**. This action cannot be undone.
                        </p>
                        <div class="flex justify-end">
                            <button id="wipeDataBtn" class="btn-toolbar-style btn-primary-override-danger w-48">
                                <i class="fa-solid fa-bomb mr-1"></i> Wipe All Local Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "About 4SP" section.
         */
        function getAboutContent() {
            // Get the current URL's site mapping to determine the legal links
            const siteKey = getCurrentSiteKey();
            const map = siteMapping[siteKey] || siteMapping.default;
            const tosUrl = map.terms_of_service || '#';
            const privacyUrl = map.privacy_policy || '#';

            return `
                <h2 class="text-3xl font-bold text-white mb-6">About 4SP</h2>
                <div class="about-section-content">
                    <p class="text-lg text-gray-400 leading-relaxed">
                        4SP is an independent, non-profit digital platform dedicated to creating a safe and enriching online environment for students. Our mission is to provide an uncensored, open, and feature-rich digital leisure platform free of advertisements and institutional control.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>
                    
                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Get Connected</h3>
                    <p class="text-sm font-light text-gray-400 mb-2">Connect with the developer and the community.</p>
                    <div class="social-link-group">
                        <a href="https://github.com/4sp-team" target="_blank" class="btn-toolbar-style">
                            <i class="fa-brands fa-github fa-lg"></i> <span>GitHub</span>
                        </a>
                        <a href="#" target="_blank" class="btn-toolbar-style opacity-50 cursor-not-allowed">
                             <i class="fa-brands fa-discord fa-lg"></i> <span>Discord (Soon)</span>
                        </a>
                        </div>

                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Legal Information</h3>
                    <p class="text-sm font-light text-gray-400 mb-2">View the legal documents pertaining to your usage of this site.</p>
                    <div class="legal-buttons">
                        <button onclick="viewLegal('tos')" class="btn-toolbar-style">
                            <i class="fa-solid fa-book-open-reader mr-1"></i> <span>Terms of Service</span>
                        </button>
                        <button onclick="viewLegal('privacy')" class="btn-toolbar-style">
                            <i class="fa-solid fa-user-lock mr-1"></i> <span>Privacy Policy</span>
                        </button>
                    </div>

                    <p class="text-sm text-gray-500 mt-12">
                        &copy; 2024 4SP Team. All rights reserved.
                    </p>
                </div>
            `;
        }
        
        /**
         * Generates a "Coming Soon" placeholder for unbuilt tabs.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">${title}</h2>
                <div class="flex flex-col items-center justify-center w-full h-96 bg-gray-900/50 border border-gray-700 rounded-xl">
                    <i class="fa-solid fa-hourglass-half fa-4x text-gray-500 mb-4"></i>
                    <p class="text-xl text-gray-400 font-medium">Coming Soon</p>
                    <p class="text-sm text-gray-500 mt-2">This section is currently under construction.</p>
                </div>
            `;
        }

        // --- Tab Logic and Event Handlers ---

        /**
         * Loads data and adds event listeners for the General tab.
         */
        async function loadGeneralTab() {
            // Get Elements
            const newUsernameInput = document.getElementById('newUsername');
            const changeUsernameBtn = document.getElementById('changeUsernameBtn');
            const usernameMessage = document.getElementById('usernameMessage');
            const passwordSection = document.getElementById('passwordSection');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const passwordMessage = document.getElementById('passwordMessage');
            const linkedProviderSection = mainView.querySelector('[data-section="linked-providers"]');
            
            showLoading("Fetching user data...");
            
            let userData = {};
            let isEmailPasswordUser = false;
            let providerData = [];
            
            try {
                // 1. Fetch User Data from Firestore
                const userDocRef = getUserDocRef(currentUser.uid);
                const docSnap = await getDoc(userDocRef);
                
                if (docSnap.exists()) {
                    userData = docSnap.data();
                } else {
                    console.error("User document not found!");
                    hideLoading();
                    return;
                }
                
                // 2. Determine Auth Provider Info
                providerData = currentUser.providerData;
                isEmailPasswordUser = providerData.some(p => p.providerId === 'password');
                
                // 3. Initialize Variables
                const currentMonthNumber = new Date().getMonth() + 1; // 1-12
                const lastChangeMonth = userData.lastUsernameChangeMonth || 0;
                let changesThisMonth = userData.usernameChangesThisMonth || 0;
                
                // Reset counter if it's a new month
                if (currentMonthNumber !== lastChangeMonth) {
                    changesThisMonth = 0;
                }
                
                const changesRemaining = MAX_CHANGES - changesThisMonth;
                const currentMonthName = new Date().toLocaleString('default', { month: 'long' });
                
                // 4. Re-render with fresh data and set state
                mainView.innerHTML = getGeneralContent(
                    userData.username, 
                    changesRemaining, 
                    changesThisMonth, 
                    currentMonthName, 
                    isEmailPasswordUser,
                    providerData
                );
                
                hideLoading();

            } catch (error) {
                console.error("Error loading General tab data:", error);
                mainView.innerHTML = `<p class="text-lg text-red-500">Error loading settings: ${error.message}</p>`;
                hideLoading();
                return;
            }
            
            // --- General Event Listeners (Must re-select elements after re-render) ---
            
            const finalUsernameInput = document.getElementById('newUsername');
            const finalChangeUsernameBtn = document.getElementById('changeUsernameBtn');
            const finalUsernameMessage = document.getElementById('usernameMessage');
            
            // Username Change Handler
            if (finalChangeUsernameBtn && finalUsernameInput) {
                finalChangeUsernameBtn.addEventListener('click', async () => {
                    const newUsername = finalUsernameInput.value.trim();
                    finalChangeUsernameBtn.disabled = true;
                    showMessage(finalUsernameMessage, '', 'success'); // Clear previous messages
                    
                    // --- Pre-checks ---
                    if (!newUsername) {
                        showMessage(finalUsernameMessage, 'Username cannot be empty.', 'error');
                        finalChangeUsernameBtn.disabled = false;
                        return;
                    }
                    if (newUsername === userData.username) {
                        showMessage(finalUsernameMessage, 'This is your current username.', 'warning');
                        finalChangeUsernameBtn.disabled = false;
                        return;
                    }
                    if (changesRemaining <= 0) {
                         showMessage(finalUsernameMessage, `You have used all ${MAX_CHANGES} changes for this month.`, 'error');
                         finalChangeUsernameBtn.disabled = false;
                         return;
                    }
                    if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                        showMessage(finalUsernameMessage, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error');
                        finalChangeUsernameBtn.disabled = false;
                        return;
                    }
                    // Character check (includes symbols: .,-+\_!?$)
                    if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                        showMessage(finalUsernameMessage, 'Username contains invalid characters (Allowed symbols: .,-+\\_!?$).', 'error');
                        finalChangeUsernameBtn.disabled = false;
                        return;
                    }
                    
                    // --- Profanity/Taken Checks ---
                    showMessage(finalUsernameMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Checking username...', 'warning');
                    
                    if (await checkProfanity(newUsername)) {
                        showMessage(finalUsernameMessage, 'This username is not allowed (Profanity filter triggered).', 'error');
                        finalChangeUsernameBtn.disabled = false;
                        return;
                    }
                    
                    if (await isUsernameTaken(newUsername)) {
                        showMessage(finalUsernameMessage, 'This username is already taken.', 'error');
                        finalChangeUsernameBtn.disabled = false;
                        return;
                    }
                    
                    // --- Update Logic ---
                    showMessage(finalUsernameMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Updating...', 'warning');

                    try {
                        const userDocRef = getUserDocRef(currentUser.uid);
                        const currentMonthNumber = new Date().getMonth() + 1;
                        const newChangesCount = (changesThisMonth) + 1; // Use the closure variable

                        await updateDoc(userDocRef, {
                            username: newUsername,
                            usernameChangesThisMonth: newChangesCount,
                            lastUsernameChangeMonth: currentMonthNumber
                        });
                        
                        showMessage(finalUsernameMessage, `Username successfully changed to ${newUsername}!`, 'success');
                        
                        // Update the remaining count on the screen
                        const remainingCount = MAX_CHANGES - newChangesCount;
                        finalUsernameInput.nextElementSibling.textContent = `Changes remaining this month: ${remainingCount}`;
                        
                        if (remainingCount <= 0) {
                            finalChangeUsernameBtn.disabled = true;
                        }
                        
                        // Update the global user data for the next time the tab loads
                        userData.username = newUsername;
                        changesThisMonth = newChangesCount; // Update closure variable

                    } catch (error) {
                        console.error("Error updating username:", error);
                        showMessage(finalUsernameMessage, 'An error occurred during update. Please try again.', 'error');
                    }
                    
                    finalChangeUsernameBtn.disabled = false;
                });
            }

            // Password Change Handler (only for email/password users)
            if (isEmailPasswordUser && changePasswordBtn) {
                changePasswordBtn.addEventListener('click', async () => {
                    const currentPasswordInput = document.getElementById('currentPassword');
                    const newPasswordInput = document.getElementById('newPassword');
                    const confirmNewPasswordInput = document.getElementById('confirmNewPassword');
                    const currentPassword = currentPasswordInput.value;
                    const newPassword = newPasswordInput.value;
                    const confirmNewPassword = confirmNewPasswordInput.value;
                    
                    changePasswordBtn.disabled = true;
                    showMessage(passwordMessage, '', 'success');
                    
                    // --- Validation ---
                    if (!currentPassword || !newPassword || !confirmNewPassword) {
                        showMessage(passwordMessage, 'All password fields must be filled.', 'error');
                        changePasswordBtn.disabled = false;
                        return;
                    }
                    if (newPassword !== confirmNewPassword) {
                        showMessage(passwordMessage, 'New passwords do not match.', 'error');
                        changePasswordBtn.disabled = false;
                        return;
                    }
                    if (newPassword.length < MIN_LENGTH) {
                        showMessage(passwordMessage, `New password must be at least ${MIN_LENGTH} characters.`, 'error');
                        changePasswordBtn.disabled = false;
                        return;
                    }
                    
                    showMessage(passwordMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating...', 'warning');

                    try {
                        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                        await reauthenticateWithCredential(currentUser, credential);
                        
                        showMessage(passwordMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Updating password...', 'warning');
                        await updatePassword(currentUser, newPassword);
                        
                        showMessage(passwordMessage, 'Password successfully updated!', 'success');
                        
                        // Clear inputs
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmNewPasswordInput.value = '';
                        
                    } catch (error) {
                        console.error("Error changing password:", error);
                        let msg = 'An unknown error occurred.';
                        if (error.code === 'auth/wrong-password') {
                            msg = 'Incorrect current password.';
                        } else if (error.code === 'auth/weak-password') {
                            msg = 'Password is too weak. Choose a stronger password.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please sign out and sign in again immediately to proceed.';
                        }
                        showMessage(passwordMessage, msg, 'error');
                    }
                    
                    changePasswordBtn.disabled = false;
                });
            }
            
            // --- Account Management (Link/Unlink) Handlers ---
            if (linkedProviderSection) {
                const linkButtons = linkedProviderSection.parentElement.querySelectorAll('[data-action="link"]');
                const unlinkButtons = linkedProviderSection.querySelectorAll('[data-action="unlink"]');
                const deleteMessage = document.getElementById('deleteMessage');
                
                // Link Provider Handler
                linkButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        const providerId = button.dataset.providerId;
                        const config = PROVIDER_CONFIG[providerId];
                        const providerInstance = config.instance();
                        
                        button.disabled = true;
                        showMessage(deleteMessage, '', 'success'); // Use deleteMessage area for link/unlink status
                        showMessage(deleteMessage, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Linking with ${config.name}...`, 'warning');

                        try {
                            await linkWithPopup(currentUser, providerInstance);
                            showMessage(deleteMessage, `${config.name} successfully linked! Refreshing...`, 'success');
                            setTimeout(() => location.reload(), 1500); // Reload to update UI
                        } catch (error) {
                            console.error("Error linking provider:", error);
                            let msg = 'Link failed. Please try again.';
                            if (error.code === 'auth/popup-closed-by-user') {
                                msg = 'Link cancelled by user.';
                            } else if (error.code === 'auth/credential-already-in-use') {
                                msg = 'This account is already linked to another 4SP user.';
                            }
                            showMessage(deleteMessage, msg, 'error');
                        }
                        button.disabled = false;
                    });
                });
                
                // Unlink Provider Handler
                unlinkButtons.forEach(button => {
                    button.addEventListener('click', () => {
                         const providerId = button.dataset.providerId;
                         const config = PROVIDER_CONFIG[providerId];
                         
                         openModal(`Are you sure you want to unlink your ${config.name} account? You must have at least one provider linked to sign in.`, [
                            { 
                                text: 'Yes', 
                                onclick: async () => {
                                    document.getElementById('modalPrompt').style.display = 'none';
                                    button.disabled = true;
                                    showMessage(deleteMessage, '', 'success');
                                    showMessage(deleteMessage, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Unlinking ${config.name}...`, 'warning');
                                    
                                    try {
                                        await unlink(currentUser, providerId);
                                        showMessage(deleteMessage, `${config.name} successfully unlinked! Refreshing...`, 'success');
                                        setTimeout(() => location.reload(), 1500);
                                    } catch (error) {
                                        console.error("Error unlinking provider:", error);
                                        let msg = 'Unlink failed. Please try again.';
                                        if (error.code === 'auth/no-such-provider') {
                                            msg = 'Provider not found.';
                                        } else if (error.code === 'auth/requires-recent-login') {
                                            msg = 'Please sign out and sign in again immediately to proceed.';
                                        }
                                        showMessage(deleteMessage, msg, 'error');
                                    }
                                    button.disabled = false;
                                }
                            },
                            { text: 'No', onclick: () => document.getElementById('modalPrompt').style.display = 'none' }
                        ]);
                    });
                });
            }
            
            // --- Account Deletion Handlers ---
            const finalDeleteBtn = document.getElementById('finalDeleteBtn');
            const reauthenticateBtn = document.getElementById('reauthenticateBtn');
            const deletePasswordInput = document.getElementById('deletePasswordInput');
            const deleteMessage = document.getElementById('deleteMessage');
            const primaryProviderId = providerData[0]?.providerId;
            const isEmailPassword = primaryProviderId === 'password';
            
            async function performAccountDeletion() {
                openModal("This is a permanent action. All your user data, including Note App entries, will be deleted. Do you wish to proceed?", [
                    { 
                        text: 'Yes, Delete', 
                        onclick: async () => {
                            document.getElementById('modalPrompt').style.display = 'none';
                            showLoading("Deleting account and data...");
                            
                            try {
                                // 1. Delete Firestore user document
                                const userDocRef = getUserDocRef(currentUser.uid);
                                await deleteDoc(userDocRef);
                                
                                // 2. Delete Firebase Auth user
                                await deleteUser(currentUser);
                                
                                hideLoading();
                                // Redirect to a page or root after successful deletion
                                window.location.href = '../authentication.html'; 
                            } catch (error) {
                                console.error("Error deleting account:", error);
                                hideLoading();
                                let msg = 'Account deletion failed. You may need to sign in again immediately and try the final step one last time.';
                                if (error.code === 'auth/requires-recent-login') {
                                     msg = 'Account deletion failed because your session is too old. Please sign out and sign in again immediately to proceed with deletion.';
                                }
                                openModal(msg, [{ text: 'Okay', onclick: () => document.getElementById('modalPrompt').style.display = 'none' }]);
                            }
                        }
                    },
                    { text: 'Cancel', onclick: () => document.getElementById('modalPrompt').style.display = 'none' }
                ]);
            }
            
            // --- Email/Password Primary Deletion Logic ---
            if (isEmailPassword && finalDeleteBtn && deletePasswordInput) {
                finalDeleteBtn.addEventListener('click', async () => {
                    const password = deletePasswordInput.value;
                    if (!password) {
                        showMessage(deleteMessage, 'Please enter your current password to proceed.', 'error');
                        return;
                    }
                    
                    finalDeleteBtn.disabled = true;
                    showMessage(deleteMessage, '', 'success');
                    showMessage(deleteMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating...', 'warning');

                    try {
                        const credential = EmailAuthProvider.credential(currentUser.email, password);
                        await reauthenticateWithCredential(currentUser, credential);
                        
                        // If re-authentication is successful, proceed to final deletion prompt
                        performAccountDeletion();
                        
                    } catch (error) {
                        console.error("Error during email/password re-authentication for deletion:", error);
                        let msg = 'Re-authentication failed. Incorrect password.';
                        if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please sign out and sign in again immediately to proceed with deletion.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                        finalDeleteBtn.disabled = false;
                    }
                });
            }
            // --- Social Provider Primary Deletion Logic ---
            else if (reauthenticateBtn) {
                reauthenticateBtn.addEventListener('click', async () => {
                    const providerInstance = PROVIDER_CONFIG[primaryProviderId].instance();
                    reauthenticateBtn.disabled = true;
                    showMessage(deleteMessage, '', 'success');
                    showMessage(deleteMessage, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating with ${PROVIDER_CONFIG[primaryProviderId].name}...`, 'warning');

                    try {
                        // Re-authenticate using the social provider popup
                        await reauthenticateWithPopup(auth.currentUser, providerInstance); 

                        // Re-authentication successful: change button to final delete button
                        reauthenticateBtn.classList.add('hidden');
                        finalDeleteBtn.classList.remove('hidden');
                        showMessage(deleteMessage, 'Authentication successful. Click "Delete Account" one last time to confirm.', 'success');

                    } catch (error) {
                        console.error("Error during social re-authentication for deletion:", error);
                        let msg = 'Re-authentication failed. Please try again.';
                        if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Re-authentication cancelled by user.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please sign out and sign in again immediately to proceed with deletion.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                        reauthenticateBtn.disabled = false;
                    }
                    
                    if (reauthenticateBtn.classList.contains('hidden') === false) {
                        reauthenticateBtn.disabled = false;
                    }
                });
                
                // Final Delete button click
                finalDeleteBtn.addEventListener('click', performAccountDeletion);
            }
        }
        
        /**
         * Loads data and adds event listeners for the Privacy & Security tab.
         */
        async function loadPrivacySecurityTab() {
            // Get Elements
            const panicKeyInputs = document.querySelectorAll('.panic-key-input');
            const panicUrlInputs = [
                document.getElementById('panicUrl1'),
                document.getElementById('panicUrl2'),
                document.getElementById('panicUrl3')
            ];
            const applyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
            const panicKeyMessage = document.getElementById('panicKeyMessage');
            
            const modeSelect = document.getElementById('urlChangerMode');
            const presetGroup = document.getElementById('presetGroup');
            const presetSelect = document.getElementById('presetSelect');
            const customGroup = document.getElementById('customGroup');
            const customTitle = document.getElementById('customTitle');
            const customFavicon = document.getElementById('customFavicon');
            const fetchFaviconBtn = document.getElementById('fetchFaviconBtn');
            const previewImg = document.getElementById('faviconPreviewImg');
            const applyUrlChangerBtn = document.getElementById('applyUrlChangerBtn');
            const urlChangerMessage = document.getElementById('urlChangerMessage');
            
            showLoading("Loading settings...");

            // 1. Render HTML
            mainView.innerHTML = getPrivacySecurityContent();
            
            // Re-select elements after render
            const finalPanicKeyInputs = document.querySelectorAll('.panic-key-input');
            const finalPanicUrlInputs = [
                document.getElementById('panicUrl1'),
                document.getElementById('panicUrl2'),
                document.getElementById('panicUrl3')
            ];
            const finalApplyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
            const finalPanicKeyMessage = document.getElementById('panicKeyMessage');
            
            const finalModeSelect = document.getElementById('urlChangerMode');
            const finalPresetGroup = document.getElementById('presetGroup');
            const finalPresetSelect = document.getElementById('presetSelect');
            const finalCustomGroup = document.getElementById('customGroup');
            const finalCustomTitle = document.getElementById('customTitle');
            const finalCustomFavicon = document.getElementById('customFavicon');
            const finalFetchFaviconBtn = document.getElementById('fetchFaviconBtn');
            const finalPreviewImg = document.getElementById('faviconPreviewImg');
            const finalApplyUrlChangerBtn = document.getElementById('applyUrlChangerBtn');
            const finalUrlChangerMessage = document.getElementById('urlChangerMessage');


            // 2. Load Panic Key Settings
            try {
                const savedSettingsMap = await getPanicKeySettings();
                finalPanicKeyInputs.forEach((input, index) => {
                    const id = index + 1;
                    const setting = savedSettingsMap.get(`key${id}`);
                    if (setting) {
                        input.value = setting.key || '';
                        finalPanicUrlInputs[index].value = setting.url || '';
                    }
                });
            } catch (e) {
                console.error("Error loading panic key settings:", e);
                showMessage(finalPanicKeyMessage, 'Error loading panic key settings.', 'error');
            }
            
            // 3. Load URL Changer Settings
            const savedUrlSettings = getSavedUrlChangerSetting();
            finalModeSelect.value = savedUrlSettings.type;

            if (savedUrlSettings.type === 'preset') {
                finalPresetGroup.classList.remove('hidden');
                finalPresetSelect.value = savedUrlSettings.id;
            } else if (savedUrlSettings.type === 'custom') {
                finalCustomGroup.classList.remove('hidden');
                finalCustomTitle.value = savedUrlSettings.title || '';
                // NEW logic to load saved custom favicon into the preview
                if (savedUrlSettings.favicon) {
                    finalPreviewImg.src = savedUrlSettings.favicon;
                    finalPreviewImg.style.display = 'block';
                }
            }
            
            hideLoading();
            
            // --- 4. Add Event Listeners ---
            
            // Panic Key Input Validation (Whitelist)
            const validKeyRegex = /^[a-z0-9`\-=\[\]\\;',\.\/]$/;
            finalPanicKeyInputs.forEach(input => {
                input.addEventListener('keydown', e => {
                    // Allow control keys like Tab, Backspace, Arrow keys
                    if (e.key.length > 1 && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' && e.key !== 'Tab') {
                        e.preventDefault();
                        return;
                    }
                    const lowerKey = e.key.toLowerCase();
                    if (lowerKey.length === 1 && !validKeyRegex.test(lowerKey)) {
                        e.preventDefault(); // Block invalid key
                        showMessage(finalPanicKeyMessage, `Invalid key. Only a-z, 0-9, and \` - = [ ] \\ ; ' , . / are allowed.`, 'error');
                        // Clear the message after a short delay
                        setTimeout(() => { showMessage(finalPanicKeyMessage, '', 'success'); }, 2000); 
                    } else if (lowerKey.length === 1) {
                         // Only accept the key that was pressed, effectively making it a single-key field
                        input.value = lowerKey; 
                        e.preventDefault(); // Prevent default text input
                    }
                });
                // Ensure key is only one character and lower case on paste/manual input
                input.addEventListener('input', () => {
                    let val = input.value.toLowerCase();
                    if (val.length > 1) {
                        val = val.slice(-1); // Keep only the last character entered
                    }
                    if (val.length === 1 && !validKeyRegex.test(val)) {
                         val = ''; // Clear if invalid
                         showMessage(finalPanicKeyMessage, `Invalid key entered. Only a-z, 0-9, and \` - = [ ] \\ ; ' , . / are allowed.`, 'error');
                         setTimeout(() => { showMessage(finalPanicKeyMessage, '', 'success'); }, 2000);
                    }
                    input.value = val;
                });
            });

            // Panic Key Apply Handler
            finalApplyPanicKeyBtn.addEventListener('click', async () => {
                const settingsToSave = [];
                let hasError = false;
                showMessage(finalPanicKeyMessage, '', 'success'); // Clear message

                for (let i = 0; i < finalPanicKeyInputs.length; i++) {
                    const keyInput = finalPanicKeyInputs[i];
                    const urlInput = finalPanicUrlInputs[i];
                    const id = `key${i + 1}`;
                    const key = keyInput.value.trim().toLowerCase();
                    let url = urlInput.value.trim();

                    // If key is empty, URL must also be empty (to clear the setting)
                    if (!key) {
                        if (url) {
                            showMessage(finalPanicKeyMessage, `Panic Key ${i+1} is missing a key but has a URL. Please clear the URL or enter a key.`, 'error');
                            hasError = true;
                            break;
                        }
                        // Continue to next, settingsToSave will not include this one
                        continue; 
                    }
                    
                    // If key is present, URL must be present
                    if (!url) {
                         showMessage(finalPanicKeyMessage, `Panic Key ${i+1} has a key but is missing a URL.`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // Key must be valid (already checked by input listeners, but double-check here)
                    if (!validKeyRegex.test(key)) {
                         showMessage(finalPanicKeyMessage, `Panic Key ${i+1} has an invalid key character.`, 'error');
                         hasError = true;
                         break;
                    }
                    
                    // URL: Check for relative path (which will break key.js)
                    if (url.startsWith('./') || url.startsWith('../') || url.startsWith('/')) {
                        showMessage(finalPanicKeyMessage, `Panic Key ${i+1} has an invalid URL. Please use a full external URL (e.g., https://google.com), not a relative path.`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // NEW: Prepend https:// if it's missing
                    if (!url.startsWith('https://') && !url.startsWith('http://')) {
                        url = 'https://' + url;
                    }
                    
                    // NEW: Validate URL
                    try {
                        new URL(url); // This will validate "https://google.com" and "https://youtube.com/page.html"
                    } catch (e) {
                        showMessage(finalPanicKeyMessage, `Panic Key ${i+1} has an invalid URL. Please enter a valid web address (e.g., google.com).`, 'error');
                        hasError = true;
                        break;
                    }

                    // Add valid setting
                    settingsToSave.push({ id, key, url }); // Push the (potentially modified) URL
                }

                if (hasError) return;
                
                // Check for duplicate keys
                const filledKeys = settingsToSave.map(s => s.key).filter(k => k);
                if (new Set(filledKeys).size !== filledKeys.length) {
                    showMessage(finalPanicKeyMessage, 'Duplicate panic keys found. Each key must be unique.', 'error');
                    return;
                }

                // Save to IndexedDB
                try {
                    finalApplyPanicKeyBtn.disabled = true;
                    showMessage(finalPanicKeyMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...', 'warning');
                    
                    await savePanicKeySettings(settingsToSave);

                    showMessage(finalPanicKeyMessage, 'Panic key settings saved successfully!', 'success');
                    
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000); 

                } catch (e) {
                    console.error("Error saving panic key settings:", e);
                    showMessage(finalPanicKeyMessage, 'An error occurred while saving.', 'error');
                }
                
                finalApplyPanicKeyBtn.disabled = false;
            });
            
            // URL Changer Mode Change Handler
            finalModeSelect.addEventListener('change', () => {
                finalPresetGroup.classList.add('hidden');
                finalCustomGroup.classList.add('hidden');
                finalUrlChangerMessage.innerHTML = '';
                
                const mode = finalModeSelect.value;
                if (mode === 'preset') {
                    finalPresetGroup.classList.remove('hidden');
                } else if (mode === 'custom') {
                    finalCustomGroup.classList.remove('hidden');
                }
            });
            
            // Favicon Fetch/Preview Handler
            finalFetchFaviconBtn.addEventListener('click', async () => {
                const url = finalCustomFavicon.value.trim();
                finalUrlChangerMessage.innerHTML = '';
                
                if (!url) {
                    showMessage(finalUrlChangerMessage, 'Please enter a URL for the favicon first.', 'error');
                    return;
                }
                
                finalFetchFaviconBtn.disabled = true;
                finalPreviewImg.style.display = 'none';
                finalPreviewImg.src = '';

                let faviconUrl = url;
                if (!faviconUrl.startsWith('http')) {
                    faviconUrl = 'https://' + faviconUrl;
                }

                showMessage(finalUrlChangerMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Fetching favicon...', 'warning');
                
                try {
                    // Try to fetch as a direct URL
                    const response = await fetch(faviconUrl);
                    if (!response.ok) throw new Error('Direct fetch failed');
                    
                    // Check if content type is an image
                    const contentType = response.headers.get("content-type");
                    if (contentType && !contentType.startsWith("image/")) {
                         // Attempt to construct a Google S2 URL which is more robust
                         const domainMatch = faviconUrl.match(/^(?:https?:\/\/)?(?:[^@\n]+@)?(?:www\.)?([^:\/\n]+)/im);
                         if (domainMatch && domainMatch[1]) {
                             const domain = domainMatch[1];
                             const s2Url = `https://t1.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${domain}&size=64`;
                             const s2Response = await fetch(s2Url);
                             if (s2Response.ok) {
                                  finalPreviewImg.src = s2Url;
                                  finalPreviewImg.style.display = 'block';
                                  showMessage(finalUrlChangerMessage, 'Favicon preview updated using fallback.', 'success');
                             } else {
                                  throw new Error('Fallback fetch failed');
                             }
                         } else {
                             throw new Error('Not a valid image or domain URL');
                         }
                    } else {
                        // Direct URL is fine
                        finalPreviewImg.src = faviconUrl;
                        finalPreviewImg.style.display = 'block';
                        showMessage(finalUrlChangerMessage, 'Favicon preview updated.', 'success');
                    }
                } catch (error) {
                    console.error("Favicon fetch error:", error);
                    showMessage(finalUrlChangerMessage, 'Could not fetch a valid favicon from that URL. Try a direct image link or another website.', 'error');
                }

                finalFetchFaviconBtn.disabled = false;
            });

            // URL Changer Apply Handler
            finalApplyUrlChangerBtn.addEventListener('click', () => {
                const mode = finalModeSelect.value;
                let settingsToSave = { type: 'none' };
                finalUrlChangerMessage.innerHTML = '';

                if (mode === 'preset') {
                    const presetId = finalPresetSelect.value;
                    if (!presetId) {
                        showMessage(finalUrlChangerMessage, 'Please select a preset.', 'error');
                        return;
                    }
                    settingsToSave = { type: 'preset', id: presetId };
                } else if (mode === 'custom') {
                    const title = finalCustomTitle.value.trim();
                    // NEW: Get favicon from preview image
                    const favicon = (finalPreviewImg.src && finalPreviewImg.style.display !== 'none') ? finalPreviewImg.src : '';
                    
                    if (!title && !favicon) { // Check against new favicon variable
                        showMessage(finalUrlChangerMessage, 'Please provide at least a custom title or fetch a favicon.', 'error'); // Update message
                        return;
                    }
                    
                    settingsToSave = { type: 'custom', title: title, favicon: favicon }; // Use new favicon variable
                }

                // Save to localStorage
                if (saveUrlChangerSetting(settingsToSave)) {
                    showMessage(finalUrlChangerMessage, 'Tab Disguise settings saved! They will be applied on the next page you load.', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000); 
                } else {
                    showMessage(finalUrlChangerMessage, 'An error occurred while saving.', 'error');
                }
            });
        }
        
        /**
         * NEW: Loads data and adds event listeners for the Personalization tab.
         */
        async function loadPersonalizationTab() {
            const themePickerContainer = document.getElementById('theme-picker-container');
            const themeMessage = document.getElementById('themeMessage');
            if (!themePickerContainer) return;
            
            // From navigation.js
            const lightThemeNames = ['Light', 'Lavender', 'Rose Gold', 'Mint'];

            try {
                // 1. Fetch themes
                const response = await fetch('../themes.json');
                if (!response.ok) throw new Error('Failed to fetch themes.json');
                const themes = await response.json();
                
                if (!themes || themes.length === 0) {
                     themePickerContainer.innerHTML = '<p class="text-gray-400">No themes found.</p>';
                     return;
                }
                
                // 2. Prepare themes (add is-light property)
                const modifiedThemes = themes.map(theme => ({
                    ...theme,
                    isLight: lightThemeNames.includes(theme.name)
                }));
                
                // 3. Render theme buttons
                const savedThemeJSON = localStorage.getItem(THEME_STORAGE_KEY);
                let activeThemeName = 'Default'; // Assuming the first theme is 'Default' or 'Dark'

                if (savedThemeJSON) {
                    try {
                        const savedTheme = JSON.parse(savedThemeJSON);
                        activeThemeName = savedTheme.name;
                    } catch (e) {
                         console.error("Error parsing saved theme:", e);
                    }
                }
                
                let themeButtonsHtml = '';
                for (const theme of modifiedThemes) {
                    const isActive = theme.name === activeThemeName;
                    
                    // === MODIFICATION START: Use theme properties for preview ===
                    // Get the theme's background and text colors for the preview
                    const previewBg = theme.isLight ? '#f3f4f6' : theme.background_color || '#111';
                    const previewText = theme.isLight ? '#1f2937' : theme.text_color || '#e0e0e0';
                    // Get the theme's accent border color
                    const previewBorder = theme['tab-active-border'] || '#4f46e5';

                    themeButtonsHtml += `
                        <button class="theme-button ${isActive ? 'active' : ''}" data-theme-name="${theme.name}" style="background-color: ${previewBg}; border-color: ${previewBorder};" >
                            <div class="theme-button-name" style="color: ${previewText};">${theme.name}</div>
                        </button>
                    `;
                    // === MODIFICATION END ===
                }

                // Inject buttons into the DOM
                themePickerContainer.innerHTML = themeButtonsHtml;
                
                // 4. Add event listeners
                const themeButtons = themePickerContainer.querySelectorAll('.theme-button');
                themeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const themeName = button.dataset.themeName;
                        const themeToApply = modifiedThemes.find(t => t.name === themeName);

                        if (themeToApply) {
                            // 1. Save to localStorage
                            localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(themeToApply));
                            
                            // === MODIFICATION START ===
                            // 2. Apply theme for live preview (ENABLED per user request)
                            if (window.applyTheme) {
                                window.applyTheme(themeToApply);
                            } else {
                                console.error('window.applyTheme not found. Theme will apply on next page load.');
                            }

                            // 3. Update active state
                            themeButtons.forEach(b => b.classList.remove('active'));
                            button.classList.add('active');
                            
                            showMessage(themeMessage, `Theme set to ${themeName}!`, 'success');
                            // === MODIFICATION END ===
                        }
                    });
                });

            } catch (error) {
                 console.error("Error loading themes:", error);
                 themePickerContainer.innerHTML = `<p class="text-red-500">Error loading themes: ${error.message}</p>`;
            }
        }
        
        /**
         * NEW: Loads data and adds event listeners for the Data Management tab.
         */
        async function loadDataTab() {
             const exportSavesBtn = document.getElementById('exportSavesBtn');
             const importSavesBtn = document.getElementById('importSavesBtn');
             const wipeDataBtn = document.getElementById('wipeDataBtn');
             const dataMessage = document.getElementById('dataMessage');
             
             // --- Core Data Handlers (from index.html) ---

             async function downloadAllSaves() {
                 showLoading("Preparing download...");
                 const localData = getAllLocalStorageData();
                 const indexedData = await getAllIndexedDBData();

                 const dataToDownload = {
                     localStorageBackup: localData,
                     indexedDBBackup: indexedData,
                     version: 1, // Add versioning for future compatibility
                     timestamp: serverTimestamp() // Placeholder, won't be in the JSON
                 };
                 
                 hideLoading();

                 const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], { type: "application/json", });
                 const url = URL.createObjectURL(blob);
                 const a = document.createElement("a");
                 a.href = url;
                 a.download = "4sp_saves.json"; // Changed name
                 document.body.appendChild(a);
                 a.click();
                 a.remove();
                 URL.revokeObjectURL(url);
             }

             function handleFileUpload() {
                 const input = document.createElement("input");
                 input.type = "file";
                 input.accept = ".json";
                 input.onchange = async e => {
                     const file = e.target.files[0];
                     if (!file) return;

                     if (file.size > 5 * 1024 * 1024) { // 5MB limit
                         showMessage(dataMessage, 'File is too large (max 5MB).', 'error');
                         return;
                     }

                     const reader = new FileReader();
                     reader.onload = async event => {
                         try {
                             showLoading("Importing data...");
                             const data = JSON.parse(event.target.result);
                             
                             if (!data.localStorageBackup || !data.indexedDBBackup) {
                                  throw new Error("Invalid backup file structure.");
                             }

                             // Perform import (will overwrite existing data)
                             setAllLocalStorageData(data.localStorageBackup);
                             await setAllIndexedDBData(data.indexedDBBackup);

                             hideLoading();
                             showMessage(dataMessage, 'Data imported successfully! Reloading page in 2 seconds...', 'success');
                             setTimeout(() => location.reload(), 2000);
                             
                         } catch (error) {
                             hideLoading();
                             console.error("Error during data import:", error);
                             showMessage(dataMessage, `Error importing file: ${error.message}`, 'error');
                         }
                     };
                     reader.onerror = () => {
                         hideLoading();
                         showMessage(dataMessage, 'Error reading file.', 'error');
                     };
                     reader.readAsText(file);
                 };
                 input.click();
             }
             
             async function wipeAllLocalData() {
                 showLoading("Wiping local data...");
                 try {
                     // Clear localStorage (skip theme and url changer keys for a moment)
                     const keysToKeep = [THEME_STORAGE_KEY, URL_CHANGER_KEY];
                     const allKeys = [];
                     for (let i = 0; i < localStorage.length; i++) {
                         allKeys.push(localStorage.key(i));
                     }
                     allKeys.forEach(key => {
                         if (!keysToKeep.includes(key)) {
                              localStorage.removeItem(key);
                         }
                     });

                     // Clear IndexedDBs (a more aggressive approach)
                     if (indexedDB.databases) {
                        const dbList = await indexedDB.databases();
                        for (const dbInfo of dbList) {
                            await new Promise(resolve => {
                                const deleteRequest = indexedDB.deleteDatabase(dbInfo.name);
                                deleteRequest.onsuccess = () => resolve();
                                deleteRequest.onerror = () => resolve();
                                deleteRequest.onblocked = () => resolve();
                            });
                        }
                     }
                     
                     hideLoading();
                     showMessage(dataMessage, 'All local data successfully wiped! Reloading page in 2 seconds...', 'success');
                     setTimeout(() => location.reload(), 2000);

                 } catch (error) {
                     hideLoading();
                     console.error("Error wiping local data:", error);
                     showMessage(dataMessage, `Error wiping data: ${error.message}`, 'error');
                 }
             }
             
             // --- Event Listener Assignments ---
             exportSavesBtn.addEventListener('click', downloadAllSaves);
             importSavesBtn.addEventListener('click', handleFileUpload);
             
             wipeDataBtn.addEventListener('click', () => {
                 openModal("This is a permanent action. All local app data and settings will be deleted. Do you wish to proceed?", [
                    { text: 'Yes, Wipe Data', onclick: () => {
                        document.getElementById('modalPrompt').style.display = 'none';
                        wipeAllLocalData();
                    }},
                    { text: 'Cancel', onclick: () => document.getElementById('modalPrompt').style.display = 'none' }
                 ]);
             });
        }


        /**
         * Main function to handle tab switching.
         */
        async function switchTab(tabId) {
            // 1. Update active tab state in sidebar
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });

            // 2. Load content into the main view
            if (tabId === 'general') {
                mainView.innerHTML = ''; // Clear view before async load
                await loadGeneralTab();
            } else if (tabId === 'privacy') {
                mainView.innerHTML = getPrivacySecurityContent(); // Render HTML first
                await loadPrivacySecurityTab(); // Load data and add listeners
            } else if (tabId === 'personalization') {
                // --- NEW: Load Personalization Tab ---
                mainView.innerHTML = getPersonalizationContent(); // Render HTML
                await loadPersonalizationTab(); // Load data and add listeners
            } else if (tabId === 'data') {
                // --- NEW: Load Data Management Tab ---
                mainView.innerHTML = getDataManagementContent(); // Render HTML
                await loadDataTab(); // Load data and add listeners
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });

        // Add listener to modal close button
        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('modalPrompt').style.display = 'none';
        });

        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

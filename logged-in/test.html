<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../injector.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p id="loadingText" class="text-lg font-normal">Loading...</p>
    </div>
    

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    
    <script src="../firebase-config.js"></script> 
    <script>
        // --- Firebase Imports (Changed to 'var' to prevent redeclaration errors if external scripts define them globally) ---
        var auth = firebase.auth();
        var db = firebase.firestore();
        const { 
            onAuthStateChanged, 
            signOut, 
            EmailAuthProvider,
            reauthenticateWithCredential,
            updatePassword,
            updateEmail,
            linkWithPopup,
            unlink,
            deleteUser,
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider 
        } = firebase.auth;

        const { doc, getDoc, updateDoc, collection, query, where, getDocs, writeBatch } = firebase.firestore;


        // --- CONSTANTS ---
        const MIN_LENGTH = 3; 
        const MAX_LENGTH = 15;
        const MAX_CHANGES = 3;
        
        // --- DOM Elements ---
        const mainView = document.getElementById('settings-main-view');
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        
        // --- Global State ---
        let currentUser = null; 
        let loadingTimeout = null;
        let authPopup = null; 
        
        // Provider configuration
        // NOTE: 'google.com' and 'github.com' are standard Firebase provider IDs.
        const PROVIDER_CONFIG = {
            'google.com': { name: 'Google', icon: '../images/google.png', instance: () => new GoogleAuthProvider() },
            'github.com': { name: 'GitHub', icon: '../images/github.png', instance: () => new GithubAuthProvider() },
            'microsoft.com': { name: 'Microsoft', icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', instance: () => new OAuthProvider('microsoft.com') },
            'password': { name: 'Email & Password', icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', isCredential: true }
        };

        // --- NEW: Constants for Privacy Settings ---
        // IndexedDB Config for Panic Key (These constants are often also in external scripts, keeping them here as the central control for the settings page)
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';
        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';

        // Presets copied from url-changer.js
        const urlChangerPresets = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'google_doc', name: 'Google Doc', title: 'Untitled document', favicon: '../favicons/google_doc.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia, the free encyclopedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'gn', name: 'GN-Math', title: 'Sign in to your account', favicon: '../favicons/gn.png', category: 'games' },
            { id: 'strongdogxp', name: 'StrongdogXP', title: 'Welcome Back!', favicon: '../favicons/strongdogxp.png', category: 'games' },
            { id: 'blank', name: 'Blank', title: '', favicon: '' },
        ];


        // --- UTILITY FUNCTIONS ---
        
        function showMessage(element, text, type) {
            element.textContent = text;
            element.className = 'general-message-area text-sm';
            if (type === 'success') {
                element.classList.add('success-message');
            } else if (type === 'error') {
                element.classList.add('error-message');
            } else if (type === 'warning') {
                element.classList.add('warning-message');
            }
        }

        // --- Firebase Utility ---

        function getUserDocRef(uid) {
            return db.collection('users').doc(uid);
        }

        async function isUsernameTaken(username) {
            const usersRef = db.collection('users');
            // Case-insensitive query (requires Firestore indexes)
            const q = usersRef.where('username', '==', username); 
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        }

        // --- Simple Profanity Check (Client-Side) ---
        // Note: For a real app, this should be server-side or use a comprehensive library.
        const simpleProfanityList = ['fuck', 'shit', 'cunt', 'piss', 'asshole', 'bitch', 'cock', 'dick', 'fag', 'retard'];
        async function checkProfanity(text) {
            const lowerText = text.toLowerCase();
            return simpleProfanityList.some(word => lowerText.includes(word));
        }
        
        // --- Modal Functions (Copied from index.html) ---
        let modalResolve = null; 

        function showModal(text, buttons) {
          const modalPrompt = document.getElementById('modalPrompt');
          const modalText = document.getElementById('modalText');
          const modalButtons = document.getElementById('modalButtons');
          const modalClose = document.getElementById('modalClose');

          modalText.textContent = text;
          modalButtons.innerHTML = ''; 

          return new Promise(resolve => {
            modalResolve = resolve;

            // Handle close button click
            modalClose.onclick = () => {
              hideModal();
              modalResolve(false); // Resolve with false if closed without a button
            };

            // Handle button clicks
            buttons.forEach(btn => {
              const buttonElement = document.createElement('button');
              buttonElement.textContent = btn.text;
              buttonElement.className = `btn-toolbar-style ${btn.style || ''}`;
              buttonElement.onclick = () => {
                hideModal();
                modalResolve(btn.value);
              };
              modalButtons.appendChild(buttonElement);
            });

            modalPrompt.style.display = "flex";
          });
        }

        function hideModal() {
          document.getElementById('modalPrompt').style.display = "none";
        }
        
        // --- Loading Overlay Functions (Copied from index.html) ---
        function showLoading(text = "Loading...") {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000); // 5 second timeout
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }

        // --- NEW: Core Data Functions (from index.html) ---

        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Skip navigation/theme/url-changer settings
                if (key !== THEME_STORAGE_KEY && key !== URL_CHANGER_KEY) { 
                    try {
                        data[key] = localStorage.getItem(key);
                    } catch (e) {
                        console.warn(`Could not read localStorage key ${key}:`, e);
                    }
                }
            }
            return data;
        }

        async function getAllIndexedDBData() {
            const data = {};
            const databases = await indexedDB.databases();
            for (const dbInfo of databases) {
                // Skip our own settings DB
                if (dbInfo.name && dbInfo.name !== DB_NAME) { 
                    try {
                        const dbName = dbInfo.name;
                        const openRequest = indexedDB.open(dbName);
                        
                        // We need to wait for the DB to open
                        const dbInstance = await new Promise((resolve, reject) => {
                            openRequest.onsuccess = event => resolve(event.target.result);
                            openRequest.onerror = event => reject(event.target.error);
                        });

                        const storeNames = Array.from(dbInstance.objectStoreNames);
                        data[dbName] = {};

                        for (const storeName of storeNames) {
                            // Read all objects from the store
                            const storeData = await new Promise((resolve, reject) => {
                                const transaction = dbInstance.transaction(storeName, "readonly");
                                const store = transaction.objectStore(storeName);
                                const request = store.getAll();
                                
                                request.onsuccess = () => resolve(request.result);
                                request.onerror = event => reject(event.target.error);
                            });

                            data[dbName][storeName] = storeData;
                        }
                        
                        dbInstance.close();

                    } catch (e) {
                        console.error(`Error reading IndexedDB ${dbInfo.name}:`, e);
                    }
                }
            }
            return data;
        }
        
        async function setAllIndexedDBData(storesData) {
            for (const dbName in storesData) {
                await new Promise(resolve => {
                    const deleteRequest = indexedDB.deleteDatabase(dbName);
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => resolve();
                    deleteRequest.onblocked = () => resolve();
                });
                
                const openRequest = indexedDB.open(dbName, 1);
                openRequest.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    for (const storeName in storesData[dbName]) {
                        if (!db.objectStoreNames.contains(storeName)) {
                            db.createObjectStore(storeName, { autoIncrement: false });
                        }
                    }
                };

                const dbInstance = await new Promise((resolve, reject) => {
                    openRequest.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    openRequest.onerror = event => {
                        reject(event.target.error);
                    };
                });

                for (const storeName in storesData[dbName]) {
                    await new Promise(resolve => {
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => {
                             console.error(`Transaction failed for store ${storeName}:`, event.target.error);
                            resolve(); // Resolve anyway to proceed
                        };
                        const store = transaction.objectStore(storeName);
                        
                        storesData[dbName][storeName].forEach(item => {
                            // Note: IndexedDB doesn't allow keys on put/add if using autoIncrement
                            // We are assuming the stores are simple key/value or have a known keyPath (which we assume to be the object itself if no key is provided)
                            if (item && item.key) { 
                                store.put(item.value, item.key);
                            } else if (item && item.id) { // Assume 'id' is a keyPath for simplicity
                                store.put(item);
                            } else {
                                store.put(item);
                            }
                        });
                    });
                }
                
                dbInstance.close();
            }
        }
        
        // --- Data Management Handlers (from index.html) ---

        async function downloadAllSaves() {
            showLoading("Preparing download...");
            const localData = getAllLocalStorageData();
            const indexedData = await getAllIndexedDBData();
            
            const dataToDownload = {
                localStorageBackup: localData,
                indexedDBBackup: indexedData,
            };
            
            hideLoading();
            
            const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], {
                type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "4sp_saves.json"; // Changed name
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function handleFileUpload() {
            const uploadMessage = document.getElementById('uploadMessage');
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async evt => {
                    const content = evt.target.result;
                    let parsedData;
                    try {
                        parsedData = JSON.parse(content);
                    } catch (error) {
                        showMessage(uploadMessage, 'Invalid JSON file.', 'error');
                        return;
                    }

                    if (!parsedData || (!parsedData.localStorageBackup && !parsedData.indexedDBBackup)) {
                        showMessage(uploadMessage, 'Invalid save file format.', 'error');
                        return;
                    }

                    const confirm = await showModal(
                        'This will overwrite all your current local data (games saves, etc.). Are you sure you want to proceed?', 
                        [
                            { text: 'Cancel', value: false, style: '' },
                            { text: 'Overwrite', value: true, style: 'btn-primary-override-danger' }
                        ]
                    );

                    if (!confirm) return;

                    showLoading("Importing data...");
                    try {
                        const localBackup = parsedData.localStorageBackup || {};
                        const indexedBackup = parsedData.indexedDBBackup || {};

                        // 1. Import localStorage data
                        for (const key in localBackup) {
                            if (key !== THEME_STORAGE_KEY && key !== URL_CHANGER_KEY) { 
                                localStorage.setItem(key, localBackup[key]);
                            }
                        }

                        // 2. Import IndexedDB data
                        await setAllIndexedDBData(indexedBackup);

                        hideLoading();
                        showMessage(uploadMessage, 'Data successfully imported! Refreshing page...', 'success');
                        // ADDED: Refresh page after 1.5 seconds
                        setTimeout(() => location.reload(), 1500); 

                    } catch (e) {
                        console.error("Data import failed:", e);
                        hideLoading();
                        showMessage(uploadMessage, 'An unexpected error occurred during import.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function deleteAllLocalData() {
            const deleteDataMessage = document.getElementById('deleteDataMessage');
            
            const confirm = await showModal(
                'This will permanently delete ALL your local data, including game saves and preferences, except for your theme and tab disguise settings. Are you absolutely sure?', 
                [
                    { text: 'Cancel', value: false, style: '' },
                    { text: 'DELETE ALL', value: true, style: 'btn-primary-override-danger' }
                ]
            );

            if (!confirm) return;

            showLoading("Deleting all local data...");
            
            try {
                // 1. Clear localStorage keys (excluding theme/url changer settings)
                const keysToRemove = Object.keys(getAllLocalStorageData());
                keysToRemove.forEach(key => localStorage.removeItem(key));

                // 2. Delete IndexedDB databases
                if (indexedDB.databases) {
                    const dbList = await indexedDB.databases();
                    for (const dbInfo of dbList) {
                        if (dbInfo.name && dbInfo.name !== DB_NAME) { // Skip our own settings DB
                            await new Promise(resolve => {
                                const deleteRequest = indexedDB.deleteDatabase(dbInfo.name);
                                deleteRequest.onsuccess = () => resolve();
                                deleteRequest.onerror = () => resolve();
                                deleteRequest.onblocked = () => resolve();
                            });
                        }
                    }
                }
                
                hideLoading();
                showMessage(deleteDataMessage, 'All local data successfully deleted!', 'success');
                setTimeout(() => location.reload(), 1500);
            
            } catch (e) {
                console.error("Data deletion failed:", e);
                hideLoading();
                showMessage(deleteDataMessage, 'An unexpected error occurred during deletion.', 'error');
            }
        }


        // --- HTML Content Generation Functions ---

        /**
         * Generates the HTML for the General section.
         * @param {string} currentUsername - The user's current display name.
         * @param {number} changesRemaining - The number of username changes remaining.
         * @param {number} changesThisMonth - The number of changes this month.
         * @param {string} currentMonthName - The current month name.
         * @param {boolean} isEmailPasswordUser - True if the user has an Email/Password account.
         * @param {Array} providerData - Array of linked providers.
         * @returns {string} The HTML string.
         */
        function getGeneralContent(currentUsername, changesRemaining, changesThisMonth, currentMonthName, isEmailPasswordUser, providerData) {
            
            // --- Username Section ---
            const usernameSectionHtml = `
            <h3 class="text-xl font-bold text-white mb-2">Username</h3>
            <div id="usernameSection" class="settings-box transition-all duration-300">
                <div id="viewMode" class="flex justify-between items-center p-4">
                    <p class="text-lg text-white font-medium">${currentUsername}</p>
                    <button id="editUsernameBtn" class="btn-toolbar-style" style="padding: 0.5rem 0.75rem;">
                        <i class="fa-solid fa-pen-to-square mr-1"></i> Edit
                    </button>
                </div>
                <div id="editMode" class="hidden flex-col p-4">
                    <input type="text" id="newUsernameInput" class="input-text-style" value="${currentUsername}" placeholder="Enter new username">
                    <div class="flex justify-between items-center text-xs text-gray-500 font-light px-1">
                        <p>Length: <span id="charCount">${currentUsername.length}</span> (Min: <span id="minLength">${MIN_LENGTH}</span>, Max: <span id="maxLength">${MAX_LENGTH}</span>)</p>
                        <p>Allowed Symbols: .,-+\\_!?$</p>
                    </div>
                    <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                        <p id="usernameChangeMessage" class="general-message-area text-sm"></p>
                        <div>
                            <button id="cancelEditBtn" class="btn-toolbar-style mr-3"> Cancel </button>
                            <button id="applyUsernameBtn" class="btn-toolbar-style btn-primary-override w-36" disabled>
                                <i class="fa-solid fa-check mr-1"></i> Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <p class="text-sm font-light text-gray-400 mt-2">
                You have <span id="changesRemaining" class="text-emphasis">${changesRemaining}</span> of ${MAX_CHANGES} username changes remaining for ${currentMonthName}.
            </p>
            `;

            // --- Password Section (Only for Email/Password users) ---
            let passwordSectionHtml = '';
            if (isEmailPasswordUser) {
                passwordSectionHtml = `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Change Password</h3>
                <div id="passwordSection" class="settings-box p-4">
                    <p class="text-sm font-light text-gray-400 mb-4">You can change your password here. Must be at least 6 characters.</p>
                    <div class="flex flex-col gap-3">
                        <div>
                            <label for="currentPassword" class="block text-sm font-light text-gray-400 mb-1">Current Password</label>
                            <input type="password" id="currentPassword" class="input-text-style" placeholder="Enter current password">
                        </div>
                        <div>
                            <label for="newPassword" class="block text-sm font-light text-gray-400 mb-1">New Password</label>
                            <input type="password" id="newPassword" class="input-text-style" placeholder="Enter new password">
                        </div>
                        <div>
                            <label for="confirmPassword" class="block text-sm font-light text-gray-400 mb-1">Confirm New Password</label>
                            <input type="password" id="confirmPassword" class="input-text-style" placeholder="Confirm new password">
                        </div>
                    </div>
                    <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                        <p id="passwordMessage" class="general-message-area text-sm"></p>
                        <button id="applyPasswordBtn" class="btn-toolbar-style btn-primary-override w-48" disabled style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-key mr-1"></i> Change Password
                        </button>
                    </div>
                </div>
                `;
            }

            // --- Account Management Section (Provider Linking) ---
            const getAccountManagementContent = (providerData) => {
                const primaryProviderId = auth.currentUser.providerData[0].providerId;
                
                // Linked Accounts
                const linkedAccountsHtml = providerData.map(p => {
                    const id = p.providerId;
                    const config = PROVIDER_CONFIG[id] || { name: id, icon: '<i class="fa-solid fa-puzzle-piece fa-lg mr-3"></i>' };
                    
                    // Determine if this provider can be unlinked
                    const canUnlink = providerData.length > 1 && !(id === 'password' && primaryProviderId === 'password');

                    // Determine if icon is an image or a FontAwesome icon
                    let iconHtml = config.icon.startsWith('<i') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-5 h-5 mr-3">`;
                    
                    let linkButton = '';
                    if (canUnlink) {
                        linkButton = `<button class="btn-toolbar-style text-red-400 hover:border-red-600 hover:text-red-600 unlink-btn" data-provider-id="${id}" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-unlink mr-1"></i> Unlink
                        </button>`;
                    } else if (id === 'password' && primaryProviderId !== 'password') {
                        // For a password account that is not primary, we don't allow unlinking
                        linkButton = `<p class="text-sm text-gray-500">Unlink other accounts first</p>`;
                    } else if (id === primaryProviderId && providerData.length > 1) {
                         linkButton = `<p class="text-sm text-gray-500">Primary account</p>`;
                    } else if (id === primaryProviderId && providerData.length === 1) {
                         linkButton = `<p class="text-sm text-gray-500">Must keep one linked account</p>`;
                    }
                    
                    return `
                        <div class="flex justify-between items-center px-4 py-4 border-b border-[#252525] last:border-b-0">
                            <div class="flex items-center text-lg text-white">
                                ${iconHtml}
                                ${config.name}
                                ${id === primaryProviderId ? '<span class="text-xs text-yellow-400 ml-2 font-normal">(Primary)</span>' : ''}
                            </div>
                            ${linkButton}
                        </div>
                    `;
                }).join('');

                // Get a list of providers that are *not* currently linked
                const linkedProviderIds = providerData.map(p => p.providerId);
                const availableProvidersHtml = Object.keys(PROVIDER_CONFIG)
                    .filter(id => id !== primaryProviderId && !linkedProviderIds.includes(id))
                    .filter(id => id !== 'password') // Don't show "Link Email/Password" here
                    .map(id => {
                        const config = PROVIDER_CONFIG[id];
                        return `
                            <button class="btn-toolbar-style settings-tab w-full link-btn" data-provider-id="${id}">
                                ${config.isCredential ? config.icon : `<img src="${config.icon}" alt="${config.name} icon" class="w-5 h-5 mr-3">`}
                                <span class="flex-grow text-left">Link with ${config.name}</span>
                            </button>
                        `;
                    }).join('');
                
                // Deletion Content
                let deletionContent = '';
                // Only show deletion section if user is logged in
                if (auth.currentUser) {
                    deletionContent = `
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                    <div id="deletionSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                        <p class="text-sm font-light text-red-300 mb-3">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> WARNING: Deleting your account is permanent. You must re-authenticate with ${PROVIDER_CONFIG[primaryProviderId].name} to proceed.
                        </p>
                        <div class="flex justify-between items-center pt-2">
                            <p id="deleteMessage" class="general-message-area text-sm"></p>
                            <button id="reauthenticateBtn" class="btn-toolbar-style w-48 btn-primary-override" data-provider-id="${primaryProviderId}" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-key mr-1"></i> Re-authenticate
                            </button>
                            <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48 hidden" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-trash mr-1"></i> Permanently Delete
                            </button>
                        </div>
                    </div>
                    `;
                }


                return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Linked Accounts</h3>
                <div id="linkedAccountsSection" class="settings-box w-full mb-8">
                    ${linkedAccountsHtml}
                </div>

                ${availableProvidersHtml.length > 0 ? `
                <h3 class="text-xl font-bold text-white mb-2">Link New Accounts</h3>
                <div id="availableAccountsSection" class="flex flex-col gap-3">
                    ${availableProvidersHtml}
                </div>
                ` : ''}

                ${deletionContent}
                `;
            };
            

            return `
                <h2 class="text-3xl font-bold text-white mb-6">General Account Settings</h2>
                <div class="w-full">
                    ${usernameSectionHtml}
                    ${passwordSectionHtml}
                    ${getAccountManagementContent(providerData)}
                </div>
            `;
        }

        /**
         * NEW: Generates the HTML for the "Privacy & Security" section.
         * @returns {string} The HTML string.
         */
        function getPrivacySecurityContent(panicKeySettings, urlChangerSetting) {
            // Generate panic key input groups (up to 3)
            const panicKeyInputs = Array(3).fill(null).map((_, index) => {
                const setting = panicKeySettings[index] || { key: '', url: '' };
                const keyId = `panicKey-${index}`;
                const urlId = `panicUrl-${index}`;
                
                return `
                    <div class="flex items-center gap-4 px-2 mb-2">
                        <label class="block text-gray-400 text-sm font-light w-12 text-center">Key ${index + 1}</label>
                        <input type="text" id="${keyId}" class="input-key-style" maxlength="1" placeholder="N/A" value="${setting.key}" data-index="${index}">
                        <input type="url" id="${urlId}" class="input-text-style flex-grow" placeholder="Enter URL to redirect to (e.g., https://www.google.com)" value="${setting.url}" data-index="${index}">
                    </div>
                `;
            }).join('');
            
            // Generate preset options
            const presetOptions = urlChangerPresets.map(preset => 
                `<option value="${preset.id}" ${urlChangerSetting.type === 'preset' && urlChangerSetting.id === preset.id ? 'selected' : ''}>${preset.name}</option>`
            ).join('');

            // Set initial state for URL changer
            const isCustom = urlChangerSetting.type === 'custom';
            const presetHidden = isCustom ? 'hidden' : '';
            const customHidden = !isCustom ? 'hidden' : '';
            const customTitleValue = isCustom ? urlChangerSetting.title : '';
            const customFaviconUrl = isCustom && urlChangerSetting.favicon ? urlChangerSetting.favicon : '';
            const customFaviconDisplay = customFaviconUrl ? 'block' : 'none';

            return `
                <h2 class="text-3xl font-bold text-white mb-6">Privacy & Security</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Panic Key Settings</h3>
                    <div id="panicKeySection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Configure up to 3 panic keys. Pressing the specified key (without Shift, Ctrl, or Alt) on any page will redirect you to the URL you set.
                            <br>
                            <span class="text-yellow-400">Valid keys:</span> a-z, 0-9, and \` - = [ ] \\ ; ' , . /
                        </p>
                        ${panicKeyInputs}
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                            <button id="applyPanicKeyBtn" class="btn-toolbar-style btn-primary-override w-48" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Keys
                            </button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Tab Disguise (URL Changer)</h3>
                    <div id="urlChangerSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Disguise the current tab with a new title and favicon to appear as another website or document (e.g., Google Classroom). 
                            <br>
                            <span class="text-yellow-400">Note:</span> This takes effect on the next page load.
                        </p>
                        
                        <div class="flex items-center justify-between p-2 mb-4 bg-[#111] rounded-lg border border-[#252525]">
                            <p class="text-white font-medium">Mode:</p>
                            <div class="flex gap-4">
                                <button id="modePreset" class="btn-toolbar-style w-28 ${isCustom ? '' : 'active'}" data-mode="preset">Preset</button>
                                <button id="modeCustom" class="btn-toolbar-style w-28 ${isCustom ? 'active' : ''}" data-mode="custom">Custom</button>
                            </div>
                        </div>

                        <div id="presetGroup" class="transition-all duration-300 ${presetHidden} settings-box p-4 border-[#4f46e5]/20">
                            <label for="presetSelect" class="block text-sm font-light text-gray-400 mb-1">Select Preset</label>
                            <select id="presetSelect" class="input-select-style">
                                ${presetOptions}
                            </select>
                        </div>
                        
                        <div id="customGroup" class="transition-all duration-300 ${customHidden} settings-box p-4 border-[#4f46e5]/20">
                            <h4 class="text-lg font-bold text-white mb-3">Custom Tab Details</h4>
                            <div class="flex flex-col gap-3">
                                <div>
                                    <label for="customTitle" class="block text-sm font-light text-gray-400 mb-1">Custom Tab Title</label>
                                    <input type="text" id="customTitle" class="input-text-style" placeholder="e.g., Google Classroom" value="${customTitleValue}">
                                </div>
                                <div class="flex items-center gap-4">
                                    <label for="faviconFile" class="block text-sm font-light text-gray-400 flex-grow">Favicon (Optional)</label>
                                    <input type="file" id="faviconFile" accept="image/*" class="hidden">
                                    <button id="uploadFaviconBtn" class="btn-toolbar-style w-48">
                                        <i class="fa-solid fa-upload mr-1"></i> Upload Image
                                    </button>
                                    <button id="clearFaviconBtn" class="btn-toolbar-style w-24 text-red-400 hover:border-red-600 hover:text-red-600" style="${customFaviconUrl ? '' : 'display: none;'}">
                                        <i class="fa-solid fa-xmark mr-1"></i> Clear
                                    </button>
                                </div>
                                <div class="flex justify-center items-center h-20 border border-[#252525] rounded-lg mt-2">
                                    <p id="previewText" class="text-gray-500 ${customFaviconUrl ? 'hidden' : ''}">Favicon Preview</p>
                                    <img id="faviconPreview" src="${customFaviconUrl}" alt="Preview" class="w-full h-full object-contain" style="display: ${customFaviconDisplay};">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="urlChangerMessage" class="general-message-area text-sm"></p>
                            <button id="applyUrlChangerBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Tab
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * NEW: Generates the HTML for the "Personalization" section.
         */
        function getPersonalizationContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Personalization</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Navigation Bar Theme</h3>
                    <div id="themePickerContainer" class="settings-box p-4">
                        </div>
                    <p id="themeMessage" class="general-message-area text-sm mt-4"></p>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Coming Soon</h3>
                    <div class="settings-box p-4">
                        <p class="text-sm font-light text-gray-400">More personalization options will be available soon!</p>
                    </div>
                </div>
            `;
        }


        /**
         * NEW: Generates the HTML for the "Data Management" section.
         */
        function getDataManagementContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Data Management</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Backup and Restore Local Data</h3>
                    <div class="settings-box p-4 mb-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Download a JSON file containing all your local data, primarily game saves. This is useful for backing up data when switching browsers or computers. 
                            <br>
                            Data covered by this includes:
                            <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-300">
                                <li>StrongdogXP Games data</li>
                                <li>GN-Math games data (for saving compatibility)</li>
                            </ul>
                        </p>
                        <div class="flex justify-end">
                            <button id="downloadSavesBtn" class="btn-toolbar-style btn-primary-override w-48">
                                <i class="fa-solid fa-download mr-1"></i> Download Save
                            </button>
                        </div>
                    </div>
                    
                    <div class="settings-box p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Upload a previously downloaded save file to restore your local data. This will overwrite existing local data.
                            <br>
                            Data covered by this import includes:
                            <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-300">
                                <li>StrongdogXP Games data</li>
                                <li>GN-Math games data (for saving compatibility)</li>
                            </ul>
                        </p>
                        <div class="flex justify-end">
                            <button id="uploadSavesBtn" class="btn-toolbar-style btn-primary-override w-48">
                                <i class="fa-solid fa-upload mr-1"></i> Upload Save
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete All Local Data</h3>
                    <div id="deleteDataSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                        <p class="text-sm font-light text-red-300 mb-4">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> DANGER: This action is irreversible. It will clear all local data (game saves, etc.) stored in your browser for this website, but it will NOT delete your user account or your settings for this page (theme/tab disguise).
                        </p>
                        <div class="flex justify-between items-center pt-2">
                            <p id="deleteDataMessage" class="general-message-area text-sm"></p>
                            <button id="deleteAllDataBtn" class="btn-toolbar-style btn-primary-override-danger w-48" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-trash mr-1"></i> Delete Local Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "About 4SP" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">About 4 Simple Problems (4SP)</h2>
                <div class="about-section-content">
                    <p class="text-lg text-gray-400 leading-relaxed">
                        4SP is a student-focused, secure, and private online utility and leisure platform created in 2024 to provide unrestricted access to educational resources and entertainment, primarily addressing school network limitations.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>

                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>

                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Connect</h3>
                    <div class="social-link-group">
                        <a href="https://www.buymeacoffee.com/v54simpleproblems" target="_blank" class="btn-toolbar-style" title="Buy Me a Coffee">
                            <i class="fa-solid fa-mug-hot fa-lg mr-2"></i> Buy Me a Coffee
                        </a>
                        <a href="https://github.com/v5-4simpleproblems" target="_blank" class="btn-toolbar-style" title="GitHub">
                            <i class="fa-brands fa-github fa-lg mr-2"></i> GitHub
                        </a>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Legal</h3>
                    <div class="legal-buttons">
                        <a href="../privacy.html" target="_blank" class="btn-toolbar-style">Privacy Policy</a>
                        <a href="../terms.html" target="_blank" class="btn-toolbar-style">Terms of Service</a>
                        <a href="../dmca.html" target="_blank" class="btn-toolbar-style">DMCA</a>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for a "Coming Soon" section.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">${title}</h2>
                <div class="w-full">
                    <div class="settings-box p-8 text-center">
                        <i class="fa-solid fa-hourglass-half fa-4x text-gray-600 mb-4"></i>
                        <h3 class="text-2xl font-bold text-white mb-2">Coming Soon!</h3>
                        <p class="text-lg text-gray-400">This feature is currently under development. Please check back later.</p>
                    </div>
                </div>
            `;
        }

        // --- Tab Content Mapping ---

        const tabContent = {
            'general': { title: 'General Account Settings' },
            'privacy': { title: 'Privacy & Security' },
            'personalization': { title: 'Personalization' },
            'data': { title: 'Data Management' },
            'about': { title: 'About 4SP' }
        };

        // --- Logic Handlers for Specific Tabs ---

        /**
         * Loads data and adds event listeners for the General tab.
         */
        async function loadGeneralTab() {
            if (!currentUser) return;
            
            // --- Fetch User Data from Firestore ---
            const userDocRef = getUserDocRef(currentUser.uid);
            let userDocSnap = await getDoc(userDocRef);
            
            if (!userDocSnap.exists()) {
                mainView.innerHTML = `<p class="error-message">User data not found. Please log out and back in.</p>`;
                return;
            }
            
            let userData = userDocSnap.data();

            const today = new Date();
            const currentMonthNumber = today.getMonth() + 1;
            const currentMonthName = today.toLocaleDateString('en-US', { month: 'long' });
            
            let changesThisMonth = userData.usernameChangesThisMonth || 0;
            let lastChangeMonth = userData.lastUsernameChangeMonth || 0;
            
            // --- Monthly Reset Logic ---
            if (currentMonthNumber !== lastChangeMonth) {
                changesThisMonth = 0;
                await updateDoc(userDocRef, {
                    usernameChangesThisMonth: 0,
                    lastUsernameChangeMonth: currentMonthNumber
                });
                userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.data();
            }

            const changesRemaining = MAX_CHANGES - changesThisMonth;
            const isEmailPasswordUser = currentUser.providerData.some(p => p.providerId === 'password');

            // 1. Render the General Content
            mainView.innerHTML = getGeneralContent(
                userData.username, 
                changesRemaining, 
                changesThisMonth, 
                currentMonthName, 
                isEmailPasswordUser, 
                currentUser.providerData // Pass provider info
            );

            // 2. Element References (Username Section)
            const viewMode = document.getElementById('viewMode');
            const editMode = document.getElementById('editMode');
            const editUsernameBtn = document.getElementById('editUsernameBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const newUsernameInput = document.getElementById('newUsernameInput');
            const applyUsernameBtn = document.getElementById('applyUsernameBtn');
            const charCount = document.getElementById('charCount');
            const usernameChangeMessage = document.getElementById('usernameChangeMessage');
            const changesRemainingDisplay = document.getElementById('changesRemaining');
            const usernameSection = document.getElementById('usernameSection');
            
            // --- Username Event Handlers ---

            editUsernameBtn.addEventListener('click', () => {
                if (changesRemaining <= 0) {
                    showMessage(usernameChangeMessage, `You have used all ${MAX_CHANGES} changes for ${currentMonthName}.`, 'error');
                    return;
                }
                viewMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                newUsernameInput.focus();
                usernameSection.classList.add('p-4');
                newUsernameInput.value = userData.username; // Reset to current username on edit
                charCount.textContent = newUsernameInput.value.length;
                applyUsernameBtn.disabled = true;
                showMessage(usernameChangeMessage, '', 'warning'); // Clear previous message
            });

            cancelEditBtn.addEventListener('click', () => {
                editMode.classList.add('hidden');
                viewMode.classList.remove('hidden');
                usernameSection.classList.remove('p-4');
                showMessage(usernameChangeMessage, '', 'warning');
            });
            
            newUsernameInput.addEventListener('input', () => {
                const newUsername = newUsernameInput.value.trim();
                charCount.textContent = newUsername.length;
                
                let valid = true;
                showMessage(usernameChangeMessage, '', 'warning');

                if (newUsername === userData.username) {
                    applyUsernameBtn.disabled = true;
                    return;
                }

                if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                    showMessage(usernameChangeMessage, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'warning');
                    valid = false;
                } else if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                    showMessage(usernameChangeMessage, 'Username contains invalid characters.', 'warning');
                    valid = false;
                }
                
                applyUsernameBtn.disabled = !valid;
            });
            
            applyUsernameBtn.addEventListener('click', async () => {
                applyUsernameBtn.disabled = true;
                const newUsername = newUsernameInput.value.trim();
                
                if (changesRemaining <= 0) {
                    showMessage(usernameChangeMessage, `You have used all ${MAX_CHANGES} changes for ${currentMonthName}.`, 'error');
                    applyUsernameBtn.disabled = false;
                    return;
                }
                
                if (newUsername === userData.username) {
                    showMessage(usernameChangeMessage, 'New username is the same as the current one.', 'warning');
                    applyUsernameBtn.disabled = false;
                    return;
                }

                // Final client-side validation check
                if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                    showMessage(usernameChangeMessage, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error');
                    return;
                }
                if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                    showMessage(usernameChangeMessage, 'Username contains invalid characters (Allowed symbols: .,-+\\_!?$).', 'error');
                    return;
                }

                showMessage(usernameChangeMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Checking username...', 'warning');

                try {
                    // --- Checks ---
                    if (await checkProfanity(newUsername)) {
                        showMessage(usernameChangeMessage, 'This username is not allowed (Profanity filter triggered).', 'error');
                        applyUsernameBtn.disabled = false;
                        return;
                    }
                    if (await isUsernameTaken(newUsername)) {
                        showMessage(usernameChangeMessage, 'This username is already taken.', 'error');
                        applyUsernameBtn.disabled = false;
                        return;
                    }

                    // --- Update Logic ---
                    const newChangesCount = changesThisMonth + 1;
                    await updateDoc(userDocRef, {
                        username: newUsername,
                        usernameChangesThisMonth: newChangesCount,
                        lastUsernameChangeMonth: currentMonthNumber
                    });

                    // Update local state and UI
                    userData.username = newUsername;
                    changesThisMonth = newChangesCount;
                    const newChangesRemaining = MAX_CHANGES - newChangesCount;
                    
                    document.querySelector('#viewMode p').textContent = newUsername;
                    changesRemainingDisplay.textContent = newChangesRemaining;

                    // Switch back to view mode
                    editMode.classList.add('hidden');
                    viewMode.classList.remove('hidden');
                    usernameSection.classList.remove('p-4');
                    
                    showMessage(usernameChangeMessage, `Username successfully changed to ${newUsername}! (${newChangesRemaining} changes remaining)`, 'success');

                } catch (e) {
                    console.error("Error updating username:", e);
                    showMessage(usernameChangeMessage, 'Failed to update username. Please try again.', 'error');
                } finally {
                    applyUsernameBtn.disabled = true; // Still disable because it's set to the new name now
                }
            });


            // 3. Element References (Password Section - only for email/password users)
            if (isEmailPasswordUser) {
                const currentPasswordInput = document.getElementById('currentPassword');
                const newPasswordInput = document.getElementById('newPassword');
                const confirmPasswordInput = document.getElementById('confirmPassword');
                const applyPasswordBtn = document.getElementById('applyPasswordBtn');
                const passwordMessage = document.getElementById('passwordMessage');
                
                // --- Password Input Validation ---
                const validatePasswordInputs = () => {
                    const currentPass = currentPasswordInput.value;
                    const newPass = newPasswordInput.value;
                    const confirmPass = confirmPasswordInput.value;
                    
                    let valid = true;
                    showMessage(passwordMessage, '', 'warning');

                    if (!currentPass || !newPass || !confirmPass) {
                        valid = false;
                    } else if (newPass.length < 6) {
                        showMessage(passwordMessage, 'New password must be at least 6 characters.', 'warning');
                        valid = false;
                    } else if (newPass !== confirmPass) {
                        showMessage(passwordMessage, 'New passwords do not match.', 'warning');
                        valid = false;
                    } else if (newPass === currentPass) {
                         showMessage(passwordMessage, 'New password cannot be the same as your current password.', 'warning');
                        valid = false;
                    }

                    applyPasswordBtn.disabled = !valid;
                };

                currentPasswordInput.addEventListener('input', validatePasswordInputs);
                newPasswordInput.addEventListener('input', validatePasswordInputs);
                confirmPasswordInput.addEventListener('input', validatePasswordInputs);
                
                // --- Change Password Handler ---
                applyPasswordBtn.addEventListener('click', async () => {
                    applyPasswordBtn.disabled = true;
                    const currentPass = currentPasswordInput.value;
                    const newPass = newPasswordInput.value;
                    
                    if (newPass.length < 6) {
                        showMessage(passwordMessage, 'New password must be at least 6 characters.', 'error');
                        applyPasswordBtn.disabled = false;
                        return;
                    }
                    if (newPass === currentPass) {
                        showMessage(passwordMessage, 'New password cannot be the same as your current password.', 'error');
                        applyPasswordBtn.disabled = false;
                        return;
                    }
                    
                    showMessage(passwordMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Changing password...', 'warning');

                    try {
                        // 1. Re-authenticate the user
                        const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
                        await reauthenticateWithCredential(currentUser, credential);
                        
                        // 2. Update the password
                        await updatePassword(currentUser, newPass);

                        showMessage(passwordMessage, 'Password successfully changed!', 'success');
                        
                        // Clear inputs
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        applyPasswordBtn.disabled = true; // Re-disable
                        
                    } catch (error) {
                        console.error("Error changing password:", error);
                        let msg = 'Failed to change password. Please ensure your current password is correct.';
                        if (error.code === 'auth/wrong-password') {
                            msg = 'Incorrect current password.';
                        } else if (error.code === 'auth/weak-password') {
                             msg = 'New password is too weak (must be at least 6 characters).';
                        }
                        showMessage(passwordMessage, msg, 'error');
                        applyPasswordBtn.disabled = false;
                    }
                });
            }

            // 4. Element References (Account Management/Linking)
            const unlinkButtons = document.querySelectorAll('.unlink-btn');
            const linkButtons = document.querySelectorAll('.link-btn');
            const primaryProviderId = auth.currentUser.providerData[0].providerId;

            // --- Unlink Handler ---
            unlinkButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const providerId = button.dataset.providerId;
                    
                    const confirm = await showModal(
                        `Are you sure you want to unlink your ${PROVIDER_CONFIG[providerId].name} account? You will still be able to log in with your other linked accounts.`, 
                        [
                            { text: 'Cancel', value: false, style: '' },
                            { text: 'Unlink', value: true, style: 'btn-primary-override-danger' }
                        ]
                    );
                    
                    if (!confirm) return;

                    showLoading("Unlinking account...");
                    
                    try {
                        await unlink(currentUser, providerId);
                        hideLoading();
                        // Reload the tab to reflect the change
                        await switchTab('general'); 
                    } catch (error) {
                        hideLoading();
                        console.error("Error unlinking account:", error);
                        // auth/no-linked-account is a common one if it's the last non-password account
                        let msg = 'Failed to unlink account.';
                        if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please log out and log back in to perform this action.';
                        } else if (error.code === 'auth/no-linked-account') {
                            msg = 'You must have at least one authentication method linked to your account.';
                        } else if (error.code === 'auth/unauthorized-domain') {
                            // This might happen if a browser extension is messing with things, or a setup issue
                             msg = 'Authentication domain error. Please try again.';
                        }
                        
                        showModal(msg, [{ text: 'OK', value: true }]);
                    }
                });
            });

            // --- Link Handler ---
            linkButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const providerId = button.dataset.providerId;
                    const provider = PROVIDER_CONFIG[providerId].instance();
                    
                    showLoading(`Linking with ${PROVIDER_CONFIG[providerId].name}...`);

                    try {
                        // Use linkWithPopup for linking new providers
                        await linkWithPopup(currentUser, provider); 
                        hideLoading();
                        // Reload the tab to reflect the change
                        await switchTab('general');
                    } catch (error) {
                        hideLoading();
                        console.error("Error linking account:", error);
                        let msg = 'Failed to link account. This can happen if the account is already linked to another 4SP user.';
                        
                        if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Account linking was canceled.';
                        } else if (error.code === 'auth/credential-already-in-use') {
                            msg = 'This account is already linked to another 4SP user.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please log out and log back in to perform this action.';
                        } else if (error.code === 'auth/account-exists-with-different-credential') {
                            msg = 'An account already exists with this email address using a different login method.';
                        }
                        
                        showModal(msg, [{ text: 'OK', value: true }]);
                    }
                });
            });


            // 5. Element References (Account Deletion)
            const reauthenticateBtn = document.getElementById('reauthenticateBtn');
            const finalDeleteBtn = document.getElementById('finalDeleteBtn');
            const deleteMessage = document.getElementById('deleteMessage');
            
            let reauthenticated = false;

            // --- Re-authenticate Handler ---
            reauthenticateBtn.addEventListener('click', async () => {
                const providerId = reauthenticateBtn.dataset.providerId;
                const config = PROVIDER_CONFIG[providerId];
                
                // For password-based auth, we use a modal prompt instead of a popup
                if (providerId === 'password') {
                    const password = await showModal(
                        'Please enter your current password to re-authenticate for account deletion.', 
                        [
                            { text: 'Cancel', value: false },
                            { text: 'Verify', value: true, style: 'btn-primary-override' }
                        ]
                    );

                    if (password) {
                        showLoading("Verifying credentials...");
                        try {
                            const credential = EmailAuthProvider.credential(currentUser.email, password);
                            await reauthenticateWithCredential(currentUser, credential);
                            reauthenticated = true;
                            hideLoading();
                            showMessage(deleteMessage, 'Re-authentication successful. Click "Permanently Delete" to continue.', 'success');
                            reauthenticateBtn.classList.add('hidden');
                            finalDeleteBtn.classList.remove('hidden');
                        } catch (error) {
                            hideLoading();
                            console.error("Password re-auth failed:", error);
                            showMessage(deleteMessage, 'Verification failed. Incorrect password or account state.', 'error');
                        }
                    }
                    return; // Exit after handling password auth
                }

                // For OAuth providers (Google, GitHub, Microsoft)
                const provider = config.instance();
                showLoading(`Re-authenticating with ${config.name}...`);
                
                try {
                    // This uses a fresh login to update the user's re-authentication time
                    await reauthenticateWithCredential(currentUser, provider); 
                    reauthenticated = true;
                    hideLoading();
                    showMessage(deleteMessage, 'Re-authentication successful. Click "Permanently Delete" to continue.', 'success');
                    reauthenticateBtn.classList.add('hidden');
                    finalDeleteBtn.classList.remove('hidden');
                } catch (error) {
                    hideLoading();
                    console.error("Re-authentication failed:", error);
                    let msg = 'Re-authentication failed. Please try again.';
                    if (error.code === 'auth/popup-closed-by-user') {
                        msg = 'Re-authentication was canceled.';
                    } else if (error.code === 'auth/requires-recent-login') {
                         msg = 'Please try re-authenticating again.';
                    }
                    showModal(msg, [{ text: 'OK', value: true }]);
                }
            });

            // --- Final Delete Handler ---
            finalDeleteBtn.addEventListener('click', async () => {
                if (!reauthenticated) {
                    showMessage(deleteMessage, 'Please re-authenticate first.', 'error');
                    return;
                }

                const confirm = await showModal(
                    'This is your last chance. Account deletion is permanent and cannot be reversed. ALL your data will be wiped (account, settings, game saves, etc.). Are you absolutely sure?', 
                    [
                        { text: 'Cancel', value: false, style: '' },
                        { text: 'WIPE DATA & DELETE', value: true, style: 'btn-primary-override-danger' }
                    ]
                );

                if (!confirm) return;

                showLoading("Permanently deleting account...");
                
                try {
                    // 1. Delete user's Firestore document
                    await userDocRef.delete();
                    
                    // 2. Delete the user (this will sign them out)
                    await deleteUser(currentUser);
                    
                    hideLoading();
                    // Firebase Auth will handle the redirect after deletion (via onAuthStateChanged listener)
                } catch (error) {
                    hideLoading();
                    console.error("Account deletion failed:", error);
                    let msg = 'Failed to delete account. You may need to re-authenticate again.';
                    if (error.code === 'auth/requires-recent-login') {
                        msg = 'Account deletion failed. Please click "Re-authenticate" again and try immediately after.';
                    }
                    showModal(msg, [{ text: 'OK', value: true }]);
                }
            });
        }


        // --- IndexedDB for Panic Key Functions ---

        /** Opens the IndexedDB and creates the object store if needed. */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);

                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        /** Fetches all panic key settings from IndexedDB. */
        async function getPanicKeySettings() {
            try {
                const db = await openDB();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            } catch (e) {
                console.error("Error fetching panic key settings:", e);
                return [];
            }
        }

        /** Saves the panic key settings to IndexedDB. */
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                // Use a write transaction
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                // Clear existing data
                store.clear(); 

                // Add new settings
                settingsArray.forEach((setting, index) => {
                    if (setting.key || setting.url) { // Only store non-empty settings
                        store.put({ 
                            id: index, // Use index as keyPath
                            key: setting.key, 
                            url: setting.url
                        });
                    }
                });

                transaction.oncomplete = () => resolve(true);
                transaction.onerror = () => reject(transaction.error);
            });
        }

        // --- LocalStorage for URL Changer Functions ---

        function getUrlChangerSetting() {
            try {
                const stored = localStorage.getItem(URL_CHANGER_KEY);
                if (stored) {
                    const setting = JSON.parse(stored);
                    if (setting.type === 'preset' && urlChangerPresets.some(p => p.id === setting.id)) {
                        return setting; // Valid preset
                    }
                    if (setting.type === 'custom' && (setting.title || setting.favicon)) {
                         return setting; // Valid custom setting
                    }
                }
            } catch (e) {
                console.error("Error reading URL Changer setting:", e);
                localStorage.removeItem(URL_CHANGER_KEY);
            }
            // Default to HAC preset if no valid setting is found
            return { type: 'preset', id: 'hac' }; 
        }

        function saveUrlChangerSetting(setting) {
            try {
                localStorage.setItem(URL_CHANGER_KEY, JSON.stringify(setting));
                return true;
            } catch (e) {
                console.error("Error saving URL Changer setting:", e);
                return false;
            }
        }
        
        // --- Favicon Utility ---

        /** Converts a file to a data URL (Base64). */
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }


        /**
         * NEW: Loads data and adds event listeners for the Privacy tab.
         */
        async function loadPrivacyTab() {
            // 1. Load Panic Key Settings
            let panicKeySettings = await getPanicKeySettings();
            // Ensure we have an array of up to 3 settings objects
            panicKeySettings = Array(3).fill(null).map((_, index) => panicKeySettings.find(s => s.id === index) || { key: '', url: '' });

            // 2. Load URL Changer Settings
            const urlChangerSetting = getUrlChangerSetting();

            // 3. Render HTML
            mainView.innerHTML = getPrivacySecurityContent(panicKeySettings, urlChangerSetting);

            // 4. Element References (Panic Key)
            const panicKeyMessage = document.getElementById('panicKeyMessage');
            const applyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
            const keyInputs = Array.from(document.querySelectorAll('.input-key-style'));
            const urlInputs = Array.from(document.querySelectorAll('[id^="panicUrl-"]'));

            // --- Panic Key Input Logic ---
            keyInputs.forEach(input => {
                input.addEventListener('keydown', (e) => {
                    // Prevent default for all keys except Backspace, Delete, Tab, Arrow keys
                    if (e.key.length === 1 && !e.metaKey && !e.ctrlKey && !e.altKey) {
                        // Prevent all input except for allowed single keys
                        const allowedChars = /^[a-z0-9\-\=\[\]\\\;\',\.\/\`]$/i;
                        if (!allowedChars.test(e.key)) {
                            e.preventDefault();
                            return;
                        }
                        
                        // Set the input value to the pressed key (always uppercase in display)
                        input.value = e.key.toUpperCase();
                        e.preventDefault(); 
                        
                        // Move focus to the corresponding URL input
                        const index = input.dataset.index;
                        document.getElementById(`panicUrl-${index}`).focus();
                    } else if (e.key === 'Backspace' || e.key === 'Delete') {
                        // Clear on backspace/delete
                        input.value = '';
                    } else if (e.key === 'Tab' || e.key.startsWith('Arrow')) {
                        // Allow navigation
                        return;
                    } else {
                        // Prevent other modifier keys
                        e.preventDefault();
                    }
                });
                
                // Ensure only one character is saved
                input.addEventListener('input', () => {
                    input.value = input.value.slice(-1).toUpperCase();
                });
            });

            // --- Apply Panic Key Handler ---
            applyPanicKeyBtn.addEventListener('click', async () => {
                const settingsToSave = [];
                let hasError = false;
                
                showMessage(panicKeyMessage, '', 'warning');
                
                keyInputs.forEach((keyInput, index) => {
                    const urlInput = urlInputs[index];
                    const key = keyInput.value.trim().toLowerCase();
                    const url = urlInput.value.trim();
                    
                    if (key || url) {
                        // Validate key format (must be a single allowed character)
                        const allowedChars = /^[a-z0-9\-\=\[\]\\\;\',\.\/\`]$/;
                        if (key && !allowedChars.test(key)) {
                            showMessage(panicKeyMessage, `Key ${index + 1} (${keyInput.value}) is not a valid panic key.`, 'error');
                            hasError = true;
                            return;
                        }
                        
                        // Validate URL format (must be a non-empty, valid URL if key is set)
                        if (key && !url) {
                            showMessage(panicKeyMessage, `Key ${index + 1} is set, but the URL is missing.`, 'error');
                            hasError = true;
                            return;
                        }

                        // Validate URL structure (simple check)
                        if (url && !url.startsWith('http')) {
                            showMessage(panicKeyMessage, `URL for Key ${index + 1} must start with http:// or https://.`, 'error');
                            hasError = true;
                            return;
                        }
                        
                        settingsToSave.push({ id: index, key: key, url: url });
                    }
                });
                
                if (hasError) return;
                
                // Check for duplicate keys
                const filledKeys = settingsToSave.map(s => s.key).filter(k => k);
                if (new Set(filledKeys).size !== filledKeys.length) {
                    showMessage(panicKeyMessage, 'Duplicate panic keys found. Each key must be unique.', 'error');
                    return;
                }
                
                // Save to IndexedDB
                try {
                    applyPanicKeyBtn.disabled = true;
                    showMessage(panicKeyMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...', 'warning');
                    await savePanicKeySettings(settingsToSave);
                    showMessage(panicKeyMessage, 'Panic key settings saved successfully!', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000); 
                } catch (e) {
                    console.error("Error saving panic key settings:", e);
                    showMessage(panicKeyMessage, 'An unexpected error occurred while saving.', 'error');
                } finally {
                    applyPanicKeyBtn.disabled = false;
                }
            });


            // 5. Element References (URL Changer)
            const modePresetBtn = document.getElementById('modePreset');
            const modeCustomBtn = document.getElementById('modeCustom');
            const presetGroup = document.getElementById('presetGroup');
            const customGroup = document.getElementById('customGroup');
            const presetSelect = document.getElementById('presetSelect');
            const customTitle = document.getElementById('customTitle');
            const uploadFaviconBtn = document.getElementById('uploadFaviconBtn');
            const faviconFile = document.getElementById('faviconFile');
            const faviconPreview = document.getElementById('faviconPreview');
            const previewText = document.getElementById('previewText');
            const clearFaviconBtn = document.getElementById('clearFaviconBtn');
            const applyUrlChangerBtn = document.getElementById('applyUrlChangerBtn');
            const urlChangerMessage = document.getElementById('urlChangerMessage');
            
            let currentMode = urlChangerSetting.type;

            // --- Mode Toggle Handler ---
            const switchMode = (mode) => {
                currentMode = mode;
                
                modePresetBtn.classList.remove('active');
                modeCustomBtn.classList.remove('active');
                
                if (mode === 'preset') {
                    modePresetBtn.classList.add('active');
                    presetGroup.classList.remove('hidden');
                    customGroup.classList.add('hidden');
                } else {
                    modeCustomBtn.classList.add('active');
                    customGroup.classList.remove('hidden');
                    presetGroup.classList.add('hidden');
                }
                
                showMessage(urlChangerMessage, '', 'warning');
            };
            
            modePresetBtn.addEventListener('click', () => switchMode('preset'));
            modeCustomBtn.addEventListener('click', () => switchMode('custom'));
            

            // --- Favicon Upload Handler ---
            uploadFaviconBtn.addEventListener('click', () => faviconFile.click());

            faviconFile.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    showMessage(urlChangerMessage, 'Invalid file type. Please select an image.', 'error');
                    return;
                }
                
                if (file.size > 500 * 1024) { // Max 500KB
                    showMessage(urlChangerMessage, 'Image is too large (max 500KB).', 'error');
                    return;
                }

                try {
                    showLoading("Processing image...");
                    const dataUrl = await fileToDataUrl(file);
                    
                    faviconPreview.src = dataUrl;
                    faviconPreview.style.display = 'block';
                    previewText.classList.add('hidden');
                    clearFaviconBtn.style.display = 'inline-flex';
                    hideLoading();
                } catch (error) {
                    console.error("Favicon processing failed:", error);
                    showMessage(urlChangerMessage, 'Failed to process image.', 'error');
                    hideLoading();
                }
            });
            
            // --- Clear Favicon Handler ---
            clearFaviconBtn.addEventListener('click', () => {
                faviconPreview.src = '';
                faviconPreview.style.display = 'none';
                previewText.classList.remove('hidden');
                clearFaviconBtn.style.display = 'none';
                faviconFile.value = ''; // Clear file input
            });

            // --- Apply URL Changer Handler ---
            applyUrlChangerBtn.addEventListener('click', () => {
                let settingsToSave = null;
                showMessage(urlChangerMessage, '', 'warning');

                if (currentMode === 'preset') {
                    const presetId = presetSelect.value;
                    if (!presetId) {
                        showMessage(urlChangerMessage, 'Please select a preset.', 'error');
                        return;
                    }
                    settingsToSave = { type: 'preset', id: presetId };
                } else if (currentMode === 'custom') {
                    const title = customTitle.value.trim();
                    // NEW: Get favicon from preview image
                    const favicon = (faviconPreview.src && faviconPreview.style.display !== 'none') ? faviconPreview.src : '';

                    if (!title && !favicon) {
                        // Check against new favicon variable
                        showMessage(urlChangerMessage, 'Please provide at least a custom title or fetch a favicon.', 'error');
                        // Update message
                        return;
                    }

                    settingsToSave = { type: 'custom', title: title, favicon: favicon }; // Use new favicon variable
                }

                // Save to localStorage
                if (saveUrlChangerSetting(settingsToSave)) {
                    showMessage(urlChangerMessage, 'Tab Disguise settings saved! They will be applied on the next page you load.', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(urlChangerMessage, 'An error occurred while saving.', 'error');
                }
            });
        }


        /**
         * NEW: Loads data and adds event listeners for the Personalization tab.
         */
        async function loadPersonalizationTab() {
            const themePickerContainer = document.getElementById('theme-picker-container');
            const themeMessage = document.getElementById('themeMessage');
            if (!themePickerContainer) return;

            // From navigation.js
            const lightThemeNames = ['Light', 'Lavender', 'Rose Gold', 'Mint'];

            try {
                // 1. Fetch themes
                const response = await fetch('../themes.json');
                if (!response.ok) {
                    throw new Error("Failed to fetch themes.json");
                }
                const themes = await response.json();

                // 2. Get current theme from storage
                const currentThemeName = localStorage.getItem(THEME_STORAGE_KEY) || 'Default'; 

                // 3. Generate HTML for theme buttons
                let themeButtonsHtml = '';
                for (const themeName in themes) {
                    const theme = themes[themeName];
                    const isActive = themeName === currentThemeName;
                    
                    // === MODIFICATION START: Use theme variables for preview ===
                    // Determine text color for preview (based on if it's a "light" theme)
                    const previewText = lightThemeNames.includes(themeName) ? '#0f0f0f' : '#e0e0e0'; 
                    // Get the theme's background color (fallback to black/dark gray)
                    const previewBg = theme['body-background'] || '#070707'; 
                    // Get the theme's accent border color
                    const previewBorder = theme['tab-active-border'] || '#4f46e5'; 

                    themeButtonsHtml += `
                        <button class="theme-button ${isActive ? 'active' : ''}" data-theme-name="${theme.name}" style="background-color: ${previewBg}; border-color: ${previewBorder};" >
                            <div class="theme-button-name" style="color: ${previewText};">${theme.name}</div>
                        </button>
                    `;
                    // === MODIFICATION END ===
                }

                // Inject buttons into the DOM
                themePickerContainer.innerHTML = themeButtonsHtml;

                // 4. Add event listeners
                const themeButtons = themePickerContainer.querySelectorAll('.theme-button');
                themeButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        const themeName = button.dataset.themeName;
                        
                        // 1. Save to localStorage
                        localStorage.setItem(THEME_STORAGE_KEY, themeName);
                        
                        // 2. Apply the change immediately by setting the class on <html>
                        const htmlElement = document.documentElement;
                        // Assuming theme is 'Default' or matches the key in the JSON
                        // Note: The navigation.js script typically handles injecting the CSS variables
                        // We will rely on a full page reload or the external script to fully apply the theme. 
                        // For a quick visual change, we can just update the active state.
                        
                        // 3. Update button active state
                        themeButtons.forEach(b => b.classList.remove('active'));
                        button.classList.add('active');
                        
                        showMessage(themeMessage, `Theme set to ${themeName}! Refreshing page to fully apply...`, 'success');
                        
                        // Reload the page to load the new theme variables via navigation.js
                        setTimeout(() => location.reload(), 1000);
                    });
                });

            } catch (e) {
                console.error("Error loading personalization tab:", e);
                themePickerContainer.innerHTML = `<p class="error-message">Failed to load theme options.</p>`;
            }
        }


        /**
         * NEW: Loads data and adds event listeners for the Data tab.
         */
        async function loadDataTab() {
            // 1. Element References
            const downloadSavesBtn = document.getElementById('downloadSavesBtn');
            const uploadSavesBtn = document.getElementById('uploadSavesBtn');
            const deleteAllDataBtn = document.getElementById('deleteAllDataBtn');
            
            // 2. Add Listeners
            downloadSavesBtn.addEventListener('click', downloadAllSaves);
            uploadSavesBtn.addEventListener('click', handleFileUpload);
            deleteAllDataBtn.addEventListener('click', deleteAllLocalData);
        }


        // --- Main Tab Switching Logic ---

        async function switchTab(tabId) {
            // 1. Update UI (Active state)
            sidebarTabs.forEach(tab => tab.classList.remove('active'));
            const activeTab = document.getElementById(`tab-${tabId}`);
            if (activeTab) {
                activeTab.classList.add('active');
            }

            // 2. Render content and add listeners
            if (tabId === 'general') {
                await loadGeneralTab();
            } else if (tabId === 'privacy') {
                await loadPrivacyTab();
            } else if (tabId === 'personalization') {
                mainView.innerHTML = getPersonalizationContent(); // Render HTML
                await loadPersonalizationTab(); // Load data and add listeners
            } else if (tabId === 'data') {
                mainView.innerHTML = getDataManagementContent();
                await loadDataTab();
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

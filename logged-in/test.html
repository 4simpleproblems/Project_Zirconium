<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - Settings</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="../test-navigation.js"></script> 

    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        :root {
            /* The color variable has been removed as navigation.js manages it via --navbar-background */
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* The body padding-top is now handled by the CSS injected in test-navigation.js to account for the fixed navbar height */
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* Full-screen content wrapper */
        .settings-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 0 1rem; 
        }

        /* Header Styling */
        .page-header {
            padding: 2rem 1rem 1rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Settings Grid Layout */
        .settings-layout {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
            flex-grow: 1;
        }

        /* --- UPDATED: Sidebar Styling --- */
        .settings-sidebar {
            width: 100%;
            min-width: 200px;
            max-width: 280px;
            flex-shrink: 0;
            
            /* NEW: Sticky Sidebar Implementation */
            position: sticky;
            /* 4rem for main navbar + 1rem desired gap */
            top: 5rem; 
            /* Aligns item to the start of the flex container, crucial for sticky */
            align-self: flex-start;
            /* Set a MAX-height based on viewport, minus the sticky offset */
            max-height: calc(100vh - 5rem);
            /* Allow sidebar to scroll internally if its content is too tall */
            overflow-y: auto;
        }

        /* Sidebar Item Styling */
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #c0c0c0;
        }
        
        /* FIX: Ensure icon is centered in its box */
        .sidebar-item i {
            text-align: center;
            line-height: 1.5rem; /* Matches h-6 (1.5rem) */
        }

        .sidebar-item:hover {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .sidebar-item.active {
            background-color: #3b82f6; /* Blue-500 */
            color: #ffffff;
            font-weight: 500;
        }

        /* Main Content Panel */
        .settings-panel {
            flex-grow: 1;
            background-color: #111111;
            border: 1px solid #252525;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 70vh;
        }
        
        /* --- General Settings UI --- */
        .settings-section {
            border-bottom: 1px solid #252525;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .settings-label {
            display: block;
            font-medium text-white mb-2;
        }
        .settings-input {
            width: 100%;
            max-width: 400px;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-input:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #3b82f640;
        }
        .settings-input:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .settings-button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .settings-button:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .settings-button:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .settings-button-danger {
            background-color: #dc2626; /* red-600 */
        }
        .settings-button-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .settings-button-secondary {
            background-color: #374151; /* gray-700 */
        }
        .settings-button-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .settings-description {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.5rem;
            max-width: 600px;
        }
        .message-area {
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }
        .message-error { color: #f87171; /* red-400 */ }
        .message-success { color: #4ade80; /* green-400 */ }
        .message-warning { color: #facc15; /* yellow-400 */ }

        /* Standard loading screen style */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #070707;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* Mobile adjustments: Hide sidebar and adjust layout */
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
                gap: 1rem;
            }
            .settings-sidebar {
                max-width: 100%;
                margin-bottom: 0;
                /* On mobile, un-stick the sidebar */
                position: static;
                height: auto;
                max-height: none; /* Reset max-height for mobile */
                overflow-y: visible;
            }
        }

        /* --- UPDATED THEME BUTTON STYLES (New Theme Cards) --- */
        .theme-card {
            cursor: pointer;
            background-color: #1a1a1a; /* darker than panel, lighter than background */
            border: 2px solid #252525;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.2s ease;
            width: 100%; /* Full width in grid cell */
            height: 100%;
        }
        .theme-card:hover {
            border-color: #3b82f6; /* Blue-500 hover effect */
            background-color: #252525;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
        }
        .theme-card.selected {
            border-color: #3b82f6; /* Blue-500 active state */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4); /* Blue-500 shadow */
            background-color: #111111;
            transform: none;
        }
        /* Re-purpose or modify .color-option for the swatch *inside* the card */
        .color-option {
            width: 100%; /* Make swatch wide */
            height: 2rem;
            border-radius: 0.5rem;
            /* Reset all previous box-shadow, border, and transform properties */
            border: none;
            transition: none;
            transform: none;
            cursor: default; /* Remove pointer on swatch itself */
            margin-bottom: 0.5rem;
            /* Ensure content inside (checkmark) is centered */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .color-option i {
            color: white; /* Ensures checkmark is visible */
            font-size: 1.5rem;
            text-shadow: 0 0 5px #000;
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <p class="text-xl text-gray-400">Verifying authentication and loading settings...</p>
    </div>

    <main id="page-content" class="settings-wrapper hidden">
        
        <header class="page-header">
            <h1 id="main-title" class="text-3xl text-white font-bold mb-3 tracking-wide">Settings</h1>
            <div class="h-px bg-white/20 w-full"></div>
        </header>

        <div class="settings-layout">
            
            <nav id="settings-sidebar" class="settings-sidebar"></nav>

            <section class="settings-panel">
                <h2 id="panel-title" class="text-2xl font-semibold text-indigo-400 mb-6">General</h2>
                <div id="panel-content" class="text-gray-400">
                    <p>Loading account details...</p>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        // --- NEW: Firebase v10 (Modular) Imports ---
        // NOTE: These are stubbed out since the actual config and files are not available.
        // For the purpose of getting the settings page to load, we define the necessary functions.
        
        // Stubbed Firebase functions
        function initializeApp(config) { return { name: 'stubApp' }; }
        function getAuth(app) { return { name: 'stubAuth' }; }
        function onAuthStateChanged(auth, callback) { 
            // Simulate a logged-in user immediately for the settings page to load
            const stubUser = { uid: 'stub-uid-123', email: 'user@example.com' };
            callback(stubUser); 
            // Return a cleanup function
            return () => console.log('Auth listener detached.');
        }
        function getFirestore(app) { return { name: 'stubDB' }; }
        function getDoc(ref) { 
             // Simulate returning user data immediately
             return Promise.resolve({
                 exists: () => true,
                 data: () => ({ 
                     username: 'TestUser', 
                     email: 'user@example.com',
                     // Simulate an initial user setting if needed
                     settings: { theme: 'Dark' }
                 })
             });
         }
        function doc(db, collectionName, id) { return { path: `${collectionName}/${id}` }; }
        function onSnapshot(ref, callback) {
             // Simulate initial data snapshot immediately
             callback({
                 exists: true,
                 data: () => ({ username: 'TestUser', settings: { theme: 'Dark' } })
             });
             // Return a cleanup function
             return () => console.log('Firestore listener detached.');
         }

        // Stub config for code completion
        const firebaseConfig = {}; 
        
        // --- NEW: Firebase v10 Initialization (Stubbed) ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: Global State Variables ---
        let currentUser = null;         // Firebase Auth User object
        let currentUserData = null;     // Firestore 'users' document data
        let unsubscribeUserDoc = null;  // Function to stop the onSnapshot listener
        let activeSection = 'general';  // Track the currently loaded section

        // --- CONSTANTS AND DOM ELEMENTS ---
        const BASE_TITLE = "Settings";
        // Key for Local Storage - MUST MATCH THEME_STORAGE_KEY in navigation.js
        const NAVBAR_SETTINGS_KEY = 'user-navbar-theme'; 
        const root = document.documentElement;
        
        // --- START OF THEME PALETTE DEFINITION ---
        const themePalettes = [
            // 1. Dark (Index 0 is the default) - RENAMED FROM 'Default Dark'
            {
                name: 'Dark',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#000000',
                'navbar-border': 'rgb(31 41 55)',
                'avatar-gradient': 'linear-gradient(135deg, #374151 0%, #111827 100%)',
                'avatar-border': '#4b5563',
                'menu-bg': '#000000',
                'menu-border': 'rgb(55 65 81)',
                'menu-divider': '#374151',
                'menu-text': '#d1d5db',
                'menu-item-hover-bg': 'rgb(55 65 81)',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(10, 10, 10, 0.8)',
                'glass-menu-border': 'rgba(55, 65, 81, 0.8)',
                'logged-out-icon-bg': '#010101',
                'logged-out-icon-border': '#374151',
                'logged-out-icon-color': '#DADADA',
                'glide-icon-color': '#ffffff',
                'glide-gradient-left': 'linear-gradient(to right, #000000, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #000000, transparent)',
                'tab-text': '#9ca3af',
                'tab-hover-text': '#ffffff',
                'tab-hover-border': '#d1d5db',
                'tab-hover-bg': 'rgba(79, 70, 229, 0.05)',
                'tab-active-text': '#4f46e5',
                'tab-active-border': '#4f46e5',
                'tab-active-bg': 'rgba(79, 70, 229, 0.1)',
                'tab-active-hover-text': '#6366f1',
                'tab-active-hover-border': '#6366f1',
                'tab-active-hover-bg': 'rgba(79, 70, 229, 0.15)',
                'pin-btn-border': '#4b5563',
                'pin-btn-hover-bg': '#374151',
                'pin-btn-icon-color': '#d1d5db',
                'hint-bg': '#010101',
                'hint-border': '#374151',
                'hint-text': '#ffffff'
            },
            // 2. Light Theme (with logo swap)
            {
                name: 'Light',
                'logo-src': '/images/logo-dark.png', // <-- LOGO SWAP
                'navbar-bg': '#ffffff',
                'navbar-border': '#e5e7eb', // gray-200
                'avatar-gradient': 'linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%)',
                'avatar-border': '#d1d5db', // gray-300
                'menu-bg': '#ffffff',
                'menu-border': '#e5e7eb', // gray-200
                'menu-divider': '#e5e7eb', // gray-200
                'menu-text': '#374151', // gray-700
                'menu-item-hover-bg': '#f3f4f6', // gray-100
                'menu-item-hover-text': '#111827', // gray-900
                'glass-menu-bg': 'rgba(255, 255, 255, 0.8)',
                'glass-menu-border': 'rgba(229, 231, 235, 0.8)',
                'logged-out-icon-bg': '#f9fafb', // gray-50
                'logged-out-icon-border': '#d1d5db', // gray-300
                'logged-out-icon-color': '#4b5563', // gray-600
                'glide-icon-color': '#111827', // gray-900
                'glide-gradient-left': 'linear-gradient(to right, #ffffff, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #ffffff, transparent)',
                'tab-text': '#4b5563', // gray-600
                'tab-hover-text': '#000000',
                'tab-hover-border': '#9ca3af', // gray-400
                'tab-hover-bg': 'rgba(79, 70, 229, 0.05)',
                'tab-active-text': '#4f46e5', // indigo-600
                'tab-active-border': '#4f46e5', // indigo-600
                'tab-active-bg': 'rgba(79, 70, 229, 0.1)',
                'tab-active-hover-text': '#4338ca', // indigo-700
                'tab-active-hover-border': '#4338ca', // indigo-700
                'tab-active-hover-bg': 'rgba(79, 70, 229, 0.15)',
                'pin-btn-border': '#d1d5db', // gray-300
                'pin-btn-hover-bg': '#f3f4f6', // gray-100
                'pin-btn-icon-color': '#4b5563', // gray-600
                'hint-bg': '#ffffff',
                'hint-border': '#e5e7eb',
                'hint-text': '#111827'
            },
            // 3. Matrix Green
            {
                name: 'Matrix',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#020a04',
                'navbar-border': '#003b00',
                'avatar-gradient': 'linear-gradient(135deg, #003b00 0%, #020a04 100%)',
                'avatar-border': '#005f00',
                'menu-bg': '#020a04',
                'menu-border': '#003b00',
                'menu-divider': '#003b00',
                'menu-text': '#00ff00',
                'menu-item-hover-bg': '#002500',
                'menu-item-hover-text': '#9fff9f',
                'glass-menu-bg': 'rgba(2, 10, 4, 0.8)',
                'glass-menu-border': 'rgba(0, 59, 0, 0.8)',
                'logged-out-icon-bg': '#010502',
                'logged-out-icon-border': '#003b00',
                'logged-out-icon-color': '#00ff00',
                'glide-icon-color': '#00ff00',
                'glide-gradient-left': 'linear-gradient(to right, #020a04, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #020a04, transparent)',
                'tab-text': '#008f00',
                'tab-hover-text': '#00ff00',
                'tab-hover-border': '#00ff00',
                'tab-hover-bg': 'rgba(0, 255, 0, 0.05)',
                'tab-active-text': '#32ff32',
                'tab-active-border': '#32ff32',
                'tab-active-bg': 'rgba(0, 255, 0, 0.1)',
                'tab-active-hover-text': '#9fff9f',
                'tab-active-hover-border': '#9fff9f',
                'tab-active-hover-bg': 'rgba(0, 255, 0, 0.15)',
                'pin-btn-border': '#005f00',
                'pin-btn-hover-bg': '#002500',
                'pin-btn-icon-color': '#00ff00',
                'hint-bg': '#010502',
                'hint-border': '#003b00',
                'hint-text': '#00ff00'
            },
            // 4. Deep Blue
            {
                name: 'Deep Blue',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#0a192f',
                'navbar-border': '#172a45',
                'avatar-gradient': 'linear-gradient(135deg, #172a45 0%, #0a192f 100%)',
                'avatar-border': '#304a6d',
                'menu-bg': '#0a192f',
                'menu-border': '#172a45',
                'menu-divider': '#172a45',
                'menu-text': '#ccd6f6',
                'menu-item-hover-bg': '#172a45',
                'menu-item-hover-text': '#64ffda',
                'glass-menu-bg': 'rgba(10, 25, 47, 0.8)',
                'glass-menu-border': 'rgba(23, 42, 69, 0.8)',
                'logged-out-icon-bg': '#071323',
                'logged-out-icon-border': '#172a45',
                'logged-out-icon-color': '#ccd6f6',
                'glide-icon-color': '#ccd6f6',
                'glide-gradient-left': 'linear-gradient(to right, #0a192f, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #0a192f, transparent)',
                'tab-text': '#8892b0',
                'tab-hover-text': '#64ffda',
                'tab-hover-border': '#64ffda',
                'tab-hover-bg': 'rgba(100, 255, 218, 0.05)',
                'tab-active-text': '#64ffda',
                'tab-active-border': '#64ffda',
                'tab-active-bg': 'rgba(100, 255, 218, 0.1)',
                'tab-active-hover-text': '#baffea',
                'tab-active-hover-border': '#baffea',
                'tab-active-hover-bg': 'rgba(100, 255, 218, 0.15)',
                'pin-btn-border': '#304a6d',
                'pin-btn-hover-bg': '#172a45',
                'pin-btn-icon-color': '#ccd6f6',
                'hint-bg': '#071323',
                'hint-border': '#172a45',
                'hint-text': '#ccd6f6'
            },
            // 5. Royal Purple
            {
                name: 'Royal',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#1a0033',
                'navbar-border': '#3c0066',
                'avatar-gradient': 'linear-gradient(135deg, #3c0066 0%, #1a0033 100%)',
                'avatar-border': '#5e0099',
                'menu-bg': '#1a0033',
                'menu-border': '#3c0066',
                'menu-divider': '#3c0066',
                'menu-text': '#e6ccff',
                'menu-item-hover-bg': '#3c0066',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(26, 0, 51, 0.8)',
                'glass-menu-border': 'rgba(60, 0, 102, 0.8)',
                'logged-out-icon-bg': '#110022',
                'logged-out-icon-border': '#3c0066',
                'logged-out-icon-color': '#e6ccff',
                'glide-icon-color': '#e6ccff',
                'glide-gradient-left': 'linear-gradient(to right, #1a0033, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #1a0033, transparent)',
                'tab-text': '#b366ff',
                'tab-hover-text': '#e6ccff',
                'tab-hover-border': '#e6ccff',
                'tab-hover-bg': 'rgba(230, 204, 255, 0.05)',
                'tab-active-text': '#d2a6ff',
                'tab-active-border': '#d2a6ff',
                'tab-active-bg': 'rgba(230, 204, 255, 0.1)',
                'tab-active-hover-text': '#f0e6ff',
                'tab-active-hover-border': '#f0e6ff',
                'tab-active-hover-bg': 'rgba(230, 204, 255, 0.15)',
                'pin-btn-border': '#5e0099',
                'pin-btn-hover-bg': '#3c0066',
                'pin-btn-icon-color': '#e6ccff',
                'hint-bg': '#110022',
                'hint-border': '#3c0066',
                'hint-text': '#e6ccff'
            },
            // 6. Sunset Orange
            {
                name: 'Sunset',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#260c00',
                'navbar-border': '#661f00',
                'avatar-gradient': 'linear-gradient(135deg, #661f00 0%, #260c00 100%)',
                'avatar-border': '#993d00',
                'menu-bg': '#260c00',
                'menu-border': '#661f00',
                'menu-divider': '#661f00',
                'menu-text': '#ffddcc',
                'menu-item-hover-bg': '#661f00',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(38, 12, 0, 0.8)',
                'glass-menu-border': 'rgba(102, 31, 0, 0.8)',
                'logged-out-icon-bg': '#1a0800',
                'logged-out-icon-border': '#661f00',
                'logged-out-icon-color': '#ffddcc',
                'glide-icon-color': '#ffddcc',
                'glide-gradient-left': 'linear-gradient(to right, #260c00, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #260c00, transparent)',
                'tab-text': '#ff9966',
                'tab-hover-text': '#ffddcc',
                'tab-hover-border': '#ffddcc',
                'tab-hover-bg': 'rgba(255, 221, 204, 0.05)',
                'tab-active-text': '#ffb380',
                'tab-active-border': '#ffb380',
                'tab-active-bg': 'rgba(255, 221, 204, 0.1)',
                'tab-active-hover-text': '#ffebe0',
                'tab-active-hover-border': '#ffebe0',
                'tab-active-hover-bg': 'rgba(255, 221, 204, 0.15)',
                'pin-btn-border': '#993d00',
                'pin-btn-hover-bg': '#661f00',
                'pin-btn-icon-color': '#ffddcc',
                'hint-bg': '#1a0800',
                'hint-border': '#661f00',
                'hint-text': '#ffddcc'
            },
            // 7. Crimson Red
            {
                name: 'Crimson',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#2a0000',
                'navbar-border': '#550000',
                'avatar-gradient': 'linear-gradient(135deg, #550000 0%, #2a0000 100%)',
                'avatar-border': '#800000',
                'menu-bg': '#2a0000',
                'menu-border': '#550000',
                'menu-divider': '#550000',
                'menu-text': '#ffcccc',
                'menu-item-hover-bg': '#550000',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(42, 0, 0, 0.8)',
                'glass-menu-border': 'rgba(85, 0, 0, 0.8)',
                'logged-out-icon-bg': '#1f0000',
                'logged-out-icon-border': '#550000',
                'logged-out-icon-color': '#ffcccc',
                'glide-icon-color': '#ffcccc',
                'glide-gradient-left': 'linear-gradient(to right, #2a0000, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #2a0000, transparent)',
                'tab-text': '#ff6666',
                'tab-hover-text': '#ffcccc',
                'tab-hover-border': '#ffcccc',
                'tab-hover-bg': 'rgba(255, 204, 204, 0.05)',
                'tab-active-text': '#ff8080',
                'tab-active-border': '#ff8080',
                'tab-active-bg': 'rgba(255, 204, 204, 0.1)',
                'tab-active-hover-text': '#ffe6e6',
                'tab-active-hover-border': '#ffe6e6',
                'tab-active-hover-bg': 'rgba(255, 204, 204, 0.15)',
                'pin-btn-border': '#800000',
                'pin-btn-hover-bg': '#550000',
                'pin-btn-icon-color': '#ffcccc',
                'hint-bg': '#1f0000',
                'hint-border': '#550000',
                'hint-text': '#ffcccc'
            },
            // 8. Slate
            {
                name: 'Slate',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#0f172a', // slate-900
                'navbar-border': '#1e293b', // slate-800
                'avatar-gradient': 'linear-gradient(135deg, #1e293b 0%, #0f172a 100%)',
                'avatar-border': '#334155', // slate-700
                'menu-bg': '#0f172a',
                'menu-border': '#1e293b',
                'menu-divider': '#1e293b',
                'menu-text': '#cbd5e1', // slate-300
                'menu-item-hover-bg': '#1e293b',
                'menu-item-hover-text': '#f1f5f9', // slate-100
                'glass-menu-bg': 'rgba(15, 23, 42, 0.8)',
                'glass-menu-border': 'rgba(30, 41, 59, 0.8)',
                'logged-out-icon-bg': '#0b111e',
                'logged-out-icon-border': '#1e293b',
                'logged-out-icon-color': '#cbd5e1',
                'glide-icon-color': '#f1f5f9',
                'glide-gradient-left': 'linear-gradient(to right, #0f172a, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #0f172a, transparent)',
                'tab-text': '#94a3b8', // slate-400
                'tab-hover-text': '#e2e8f0', // slate-200
                'tab-hover-border': '#e2e8f0',
                'tab-hover-bg': 'rgba(226, 232, 240, 0.05)',
                'tab-active-text': '#7dd3fc', // sky-300
                'tab-active-border': '#7dd3fc',
                'tab-active-bg': 'rgba(125, 211, 252, 0.1)',
                'tab-active-hover-text': '#e0f2fe', // sky-100
                'tab-active-hover-border': '#e0f2fe',
                'tab-active-hover-bg': 'rgba(125, 211, 252, 0.15)',
                'pin-btn-border': '#334155',
                'pin-btn-hover-bg': '#1e293b',
                'pin-btn-icon-color': '#cbd5e1',
                'hint-bg': '#0b111e',
                'hint-border': '#1e293b',
                'hint-text': '#cbd5e1'
            },
            // ... Adding 8 more distinct themes
            // 9. Rose Gold
            {
                name: 'Rose Gold',
                'logo-src': '/images/logo-dark.png',
                'navbar-bg': '#fff5f2',
                'navbar-border': '#ffe0d6',
                'avatar-gradient': 'linear-gradient(135deg, #ffe0d6 0%, #fff5f2 100%)',
                'avatar-border': '#ffbfa8',
                'menu-bg': '#fff5f2',
                'menu-border': '#ffe0d6',
                'menu-divider': '#ffe0d6',
                'menu-text': '#8c2d04',
                'menu-item-hover-bg': '#ffe0d6',
                'menu-item-hover-text': '#611f03',
                'glass-menu-bg': 'rgba(255, 245, 242, 0.8)',
                'glass-menu-border': 'rgba(255, 224, 214, 0.8)',
                'logged-out-icon-bg': '#fffaf8',
                'logged-out-icon-border': '#ffe0d6',
                'logged-out-icon-color': '#8c2d04',
                'glide-icon-color': '#611f03',
                'glide-gradient-left': 'linear-gradient(to right, #fff5f2, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #fff5f2, transparent)',
                'tab-text': '#c43e0a',
                'tab-hover-text': '#8c2d04',
                'tab-hover-border': '#8c2d04',
                'tab-hover-bg': 'rgba(196, 62, 10, 0.05)',
                'tab-active-text': '#e6710f',
                'tab-active-border': '#e6710f',
                'tab-active-bg': 'rgba(230, 113, 15, 0.1)',
                'tab-active-hover-text': '#c43e0a',
                'tab-active-hover-border': '#c43e0a',
                'tab-active-hover-bg': 'rgba(230, 113, 15, 0.15)',
                'pin-btn-border': '#ffbfa8',
                'pin-btn-hover-bg': '#ffe0d6',
                'pin-btn-icon-color': '#8c2d04',
                'hint-bg': '#fffaf8',
                'hint-border': '#ffe0d6',
                'hint-text': '#8c2d04'
            },
            // 10. Forest
            {
                name: 'Forest',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#0f1f1a',
                'navbar-border': '#1a382c',
                'avatar-gradient': 'linear-gradient(135deg, #1a382c 0%, #0f1f1a 100%)',
                'avatar-border': '#2a5743',
                'menu-bg': '#0f1f1a',
                'menu-border': '#1a382c',
                'menu-divider': '#1a382c',
                'menu-text': '#bfe3d5',
                'menu-item-hover-bg': '#1a382c',
                'menu-item-hover-text': '#e6f5ef',
                'glass-menu-bg': 'rgba(15, 31, 26, 0.8)',
                'glass-menu-border': 'rgba(26, 56, 44, 0.8)',
                'logged-out-icon-bg': '#0a1411',
                'logged-out-icon-border': '#1a382c',
                'logged-out-icon-color': '#bfe3d5',
                'glide-icon-color': '#e6f5ef',
                'glide-gradient-left': 'linear-gradient(to right, #0f1f1a, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #0f1f1a, transparent)',
                'tab-text': '#6abf9a',
                'tab-hover-text': '#bfe3d5',
                'tab-hover-border': '#bfe3d5',
                'tab-hover-bg': 'rgba(191, 227, 213, 0.05)',
                'tab-active-text': '#8cdec4',
                'tab-active-border': '#8cdec4',
                'tab-active-bg': 'rgba(140, 222, 196, 0.1)',
                'tab-active-hover-text': '#e6f5ef',
                'tab-active-hover-border': '#e6f5ef',
                'tab-active-hover-bg': 'rgba(140, 222, 196, 0.15)',
                'pin-btn-border': '#2a5743',
                'pin-btn-hover-bg': '#1a382c',
                'pin-btn-icon-color': '#bfe3d5',
                'hint-bg': '#0a1411',
                'hint-border': '#1a382c',
                'hint-text': '#bfe3d5'
            },
            // 11. Oceanic
            {
                name: 'Oceanic',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#001a2e',
                'navbar-border': '#00335c',
                'avatar-gradient': 'linear-gradient(135deg, #00335c 0%, #001a2e 100%)',
                'avatar-border': '#004d8a',
                'menu-bg': '#001a2e',
                'menu-border': '#00335c',
                'menu-divider': '#00335c',
                'menu-text': '#cce0ff',
                'menu-item-hover-bg': '#00335c',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(0, 26, 46, 0.8)',
                'glass-menu-border': 'rgba(0, 51, 92, 0.8)',
                'logged-out-icon-bg': '#00111f',
                'logged-out-icon-border': '#00335c',
                'logged-out-icon-color': '#cce0ff',
                'glide-icon-color': '#cce0ff',
                'glide-gradient-left': 'linear-gradient(to right, #001a2e, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #001a2e, transparent)',
                'tab-text': '#66a3ff',
                'tab-hover-text': '#cce0ff',
                'tab-hover-border': '#cce0ff',
                'tab-hover-bg': 'rgba(204, 224, 255, 0.05)',
                'tab-active-text': '#99c2ff',
                'tab-active-border': '#99c2ff',
                'tab-active-bg': 'rgba(204, 224, 255, 0.1)',
                'tab-active-hover-text': '#e6f0ff',
                'tab-active-hover-border': '#e6f0ff',
                'tab-active-hover-bg': 'rgba(204, 224, 255, 0.15)',
                'pin-btn-border': '#004d8a',
                'pin-btn-hover-bg': '#00335c',
                'pin-btn-icon-color': '#cce0ff',
                'hint-bg': '#00111f',
                'hint-border': '#00335c',
                'hint-text': '#cce0ff'
            },
            // 12. Hot Pink
            {
                name: 'Hot Pink',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#2a0013',
                'navbar-border': '#55002a',
                'avatar-gradient': 'linear-gradient(135deg, #55002a 0%, #2a0013 100%)',
                'avatar-border': '#800040',
                'menu-bg': '#2a0013',
                'menu-border': '#55002a',
                'menu-divider': '#55002a',
                'menu-text': '#ffcce6',
                'menu-item-hover-bg': '#55002a',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(42, 0, 19, 0.8)',
                'glass-menu-border': 'rgba(85, 0, 42, 0.8)',
                'logged-out-icon-bg': '#1f000e',
                'logged-out-icon-border': '#55002a',
                'logged-out-icon-color': '#ffcce6',
                'glide-icon-color': '#ffcce6',
                'glide-gradient-left': 'linear-gradient(to right, #2a0013, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #2a0013, transparent)',
                'tab-text': '#ff66b3',
                'tab-hover-text': '#ffcce6',
                'tab-hover-border': '#ffcce6',
                'tab-hover-bg': 'rgba(255, 204, 230, 0.05)',
                'tab-active-text': '#ff80c0',
                'tab-active-border': '#ff80c0',
                'tab-active-bg': 'rgba(255, 204, 230, 0.1)',
                'tab-active-hover-text': '#ffe6f2',
                'tab-active-hover-border': '#ffe6f2',
                'tab-active-hover-bg': 'rgba(255, 204, 230, 0.15)',
                'pin-btn-border': '#800040',
                'pin-btn-hover-bg': '#55002a',
                'pin-btn-icon-color': '#ffcce6',
                'hint-bg': '#1f000e',
                'hint-border': '#55002a',
                'hint-text': '#ffcce6'
            },
            // 13. Gold
            {
                name: 'Gold',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#2b1d00',
                'navbar-border': '#573a00',
                'avatar-gradient': 'linear-gradient(135deg, #573a00 0%, #2b1d00 100%)',
                'avatar-border': '#825800',
                'menu-bg': '#2b1d00',
                'menu-border': '#573a00',
                'menu-divider': '#573a00',
                'menu-text': '#ffeeb3',
                'menu-item-hover-bg': '#573a00',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(43, 29, 0, 0.8)',
                'glass-menu-border': 'rgba(87, 58, 0, 0.8)',
                'logged-out-icon-bg': '#201600',
                'logged-out-icon-border': '#573a00',
                'logged-out-icon-color': '#ffeeb3',
                'glide-icon-color': '#ffeeb3',
                'glide-gradient-left': 'linear-gradient(to right, #2b1d00, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #2b1d00, transparent)',
                'tab-text': '#ffcc33',
                'tab-hover-text': '#ffeeb3',
                'tab-hover-border': '#ffeeb3',
                'tab-hover-bg': 'rgba(255, 238, 179, 0.05)',
                'tab-active-text': '#ffd65c',
                'tab-active-border': '#ffd65c',
                'tab-active-bg': 'rgba(255, 238, 179, 0.1)',
                'tab-active-hover-text': '#fff5cc',
                'tab-active-hover-border': '#fff5cc',
                'tab-active-hover-bg': 'rgba(255, 238, 179, 0.15)',
                'pin-btn-border': '#825800',
                'pin-btn-hover-bg': '#573a00',
                'pin-btn-icon-color': '#ffeeb3',
                'hint-bg': '#201600',
                'hint-border': '#573a00',
                'hint-text': '#ffeeb3'
            },
            // 14. Silver
            {
                name: 'Silver',
                'logo-src': '/images/logo-dark.png',
                'navbar-bg': '#f3f4f6', // gray-100
                'navbar-border': '#e5e7eb', // gray-200
                'avatar-gradient': 'linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%)',
                'avatar-border': '#d1d5db', // gray-300
                'menu-bg': '#f3f4f6',
                'menu-border': '#e5e7eb',
                'menu-divider': '#e5e7eb',
                'menu-text': '#4b5563', // gray-600
                'menu-item-hover-bg': '#e5e7eb',
                'menu-item-hover-text': '#1f2937', // gray-800
                'glass-menu-bg': 'rgba(243, 244, 246, 0.8)',
                'glass-menu-border': 'rgba(229, 231, 235, 0.8)',
                'logged-out-icon-bg': '#ffffff',
                'logged-out-icon-border': '#e5e7eb',
                'logged-out-icon-color': '#4b5563',
                'glide-icon-color': '#1f2937',
                'glide-gradient-left': 'linear-gradient(to right, #f3f4f6, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #f3f4f6, transparent)',
                'tab-text': '#6b7280', // gray-500
                'tab-hover-text': '#1f2937',
                'tab-hover-border': '#1f2937',
                'tab-hover-bg': 'rgba(31, 41, 55, 0.05)',
                'tab-active-text': '#3b82f6', // blue-500
                'tab-active-border': '#3b82f6',
                'tab-active-bg': 'rgba(59, 130, 246, 0.1)',
                'tab-active-hover-text': '#2563eb', // blue-600
                'tab-active-hover-border': '#2563eb',
                'tab-active-hover-bg': 'rgba(59, 130, 246, 0.15)',
                'pin-btn-border': '#d1d5db',
                'pin-btn-hover-bg': '#e5e7eb',
                'pin-btn-icon-color': '#4b5563',
                'hint-bg': '#ffffff',
                'hint-border': '#e5e7eb',
                'hint-text': '#1f2937'
            },
            // 15. Warm Sepia
            {
                name: 'Sepia',
                'logo-src': '/images/logo.png',
                'navbar-bg': '#29211d',
                'navbar-border': '#4c3933',
                'avatar-gradient': 'linear-gradient(135deg, #4c3933 0%, #29211d 100%)',
                'avatar-border': '#6f5247',
                'menu-bg': '#29211d',
                'menu-border': '#4c3933',
                'menu-divider': '#4c3933',
                'menu-text': '#e3d7d0',
                'menu-item-hover-bg': '#4c3933',
                'menu-item-hover-text': '#ffffff',
                'glass-menu-bg': 'rgba(41, 33, 29, 0.8)',
                'glass-menu-border': 'rgba(76, 57, 51, 0.8)',
                'logged-out-icon-bg': '#1e1613',
                'logged-out-icon-border': '#4c3933',
                'logged-out-icon-color': '#e3d7d0',
                'glide-icon-color': '#e3d7d0',
                'glide-gradient-left': 'linear-gradient(to right, #29211d, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #29211d, transparent)',
                'tab-text': '#9e7d6b',
                'tab-hover-text': '#e3d7d0',
                'tab-hover-border': '#e3d7d0',
                'tab-hover-bg': 'rgba(227, 215, 208, 0.05)',
                'tab-active-text': '#c39e88',
                'tab-active-border': '#c39e88',
                'tab-active-bg': 'rgba(227, 215, 208, 0.1)',
                'tab-active-hover-text': '#f0e9e4',
                'tab-active-hover-border': '#f0e9e4',
                'tab-active-hover-bg': 'rgba(227, 215, 208, 0.15)',
                'pin-btn-border': '#6f5247',
                'pin-btn-hover-bg': '#4c3933',
                'pin-btn-icon-color': '#e3d7d0',
                'hint-bg': '#1e1613',
                'hint-border': '#4c3933',
                'hint-text': '#e3d7d0'
            },
            // 16. Pastel
            {
                name: 'Pastel',
                'logo-src': '/images/logo-dark.png',
                'navbar-bg': '#f7f2fb',
                'navbar-border': '#e8dfff',
                'avatar-gradient': 'linear-gradient(135deg, #e8dfff 0%, #f7f2fb 100%)',
                'avatar-border': '#d8c7ff',
                'menu-bg': '#f7f2fb',
                'menu-border': '#e8dfff',
                'menu-divider': '#e8dfff',
                'menu-text': '#5a3d7d',
                'menu-item-hover-bg': '#e8dfff',
                'menu-item-hover-text': '#3a2552',
                'glass-menu-bg': 'rgba(247, 242, 251, 0.8)',
                'glass-menu-border': 'rgba(232, 223, 255, 0.8)',
                'logged-out-icon-bg': '#ffffff',
                'logged-out-icon-border': '#e8dfff',
                'logged-out-icon-color': '#5a3d7d',
                'glide-icon-color': '#3a2552',
                'glide-gradient-left': 'linear-gradient(to right, #f7f2fb, transparent)',
                'glide-gradient-right': 'linear-gradient(to left, #f7f2fb, transparent)',
                'tab-text': '#7a5a9e',
                'tab-hover-text': '#5a3d7d',
                'tab-hover-border': '#5a3d7d',
                'tab-hover-bg': 'rgba(90, 61, 125, 0.05)',
                'tab-active-text': '#9a7edb',
                'tab-active-border': '#9a7edb',
                'tab-active-bg': 'rgba(154, 126, 219, 0.1)',
                'tab-active-hover-text': '#7a5a9e',
                'tab-active-hover-border': '#7a5a9e',
                'tab-active-hover-bg': 'rgba(154, 126, 219, 0.15)',
                'pin-btn-border': '#d8c7ff',
                'pin-btn-hover-bg': '#e8dfff',
                'pin-btn-icon-color': '#5a3d7d',
                'hint-bg': '#ffffff',
                'hint-border': '#e8dfff',
                'hint-text': '#3a2552'
            }
        ];
        // --- END OF THEME PALETTE DEFINITION ---

        // --- NEW: applyTheme function (Stubbed/Simplified) ---
        /**
         * Applies the selected theme by setting CSS variables on the root element.
         * In a real application, this function would typically be in navigation.js or a global script.
         */
        window.applyTheme = function(theme) {
            // Check for the theme property and apply it to the root
            if (theme && typeof theme === 'object') {
                for (const [key, value] of Object.entries(theme)) {
                    if (key !== 'name') {
                         // Convert 'navbar-bg' to '--navbar-bg'
                         root.style.setProperty(`--${key}`, value);
                    }
                }
                // Also set the main body/html background to match the chosen theme for a seamless look
                const bodyBg = theme['navbar-bg'] === '#000000' ? '#070707' : theme['navbar-bg'];
                document.body.style.backgroundColor = bodyBg;
                
                console.log(`Theme applied: ${theme.name}`);
            }
        };

        // Helper function to get the current selected theme index from Local Storage
        const getCurrentThemeIndex = () => {
            const storedTheme = localStorage.getItem(NAVBAR_SETTINGS_KEY);
            if (storedTheme) {
                try {
                    const theme = JSON.parse(storedTheme);
                    // Find the index of the stored theme in the palette array
                    const index = themePalettes.findIndex(p => p.name === theme.name);
                    // If a non-default theme is found, return its index. Otherwise, return default (0).
                    return index >= 0 ? index : 0; 
                } catch (e) {
                    // Default if parsing fails
                    return 0; 
                }
            }
            // Default theme is index 0
            return 0; 
        };

        // --- SECTION RENDERING FUNCTIONS ---
        // Placeholder function for General Settings
        window.renderGeneralSettings = function() {
            document.getElementById('panel-title').textContent = 'General';
            document.getElementById('panel-content').innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl text-white mb-3">Profile Details</h3>
                    <p class="settings-description">Manage your basic account information.</p>
                </div>
                <div class="settings-section">
                    <h3 class="text-xl text-white mb-3">Language & Region</h3>
                    <p class="settings-description">Set your preferred language and location format.</p>
                </div>
            `;
            // Set active section for sidebar logic
            activeSection = 'general';
            updateSidebarActiveState();
        };

        // This function will be called when 'personalization' sidebar item is clicked
        window.renderPersonalizationSettings = function() {
            document.getElementById('panel-title').textContent = 'Personalization';
            
            const currentThemeIndex = getCurrentThemeIndex();
            
            // HTML Structure: Removed Apply and Reset buttons
            document.getElementById('panel-content').innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl text-white mb-4">Navbar Theme</h3>
                    <p class="settings-description mb-6">Select a color scheme. The new theme will be applied immediately.</p>
                    
                    <div id="theme-palette" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                        </div>
                    
                    <div id="theme-message-area" class="message-area mt-4"></div>
                </div>
            `;
            
            const themePaletteEl = document.getElementById('theme-palette');
            const messageEl = document.getElementById('theme-message-area');

            themePalettes.forEach((theme, index) => {
                const isSelected = index === currentThemeIndex;
                
                // Use navbar-bg as the main color swatch preview
                const mainColor = theme['navbar-bg'];
                
                const themeCard = document.createElement('div');
                themeCard.className = `theme-card ${isSelected ? 'selected' : ''}`;
                themeCard.setAttribute('data-theme-index', index);
                
                themeCard.innerHTML = `
                    <div class="color-option" style="background-color: ${mainColor};">
                        ${isSelected ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                    <span class="text-sm text-white font-medium">${theme.name}</span>
                `;
                
                themePaletteEl.appendChild(themeCard);
                
                // Instant Apply Listener
                themeCard.addEventListener('click', () => {
                    // Prevent applying if already selected
                    if (themeCard.classList.contains('selected')) {
                        return;
                    }

                    // 1. Apply theme instantly using the global function
                    if (window.applyTheme) {
                        window.applyTheme(theme);
                    }

                    // 2. Update Local Storage and Message
                    try {
                        // Special handling for the default 'Dark' theme (index 0): remove from storage
                        if (index === 0) {
                             localStorage.removeItem(NAVBAR_SETTINGS_KEY);
                             messageEl.textContent = 'Theme reset to Dark (Default).';
                             messageEl.className = 'message-area message-success';
                             // Also remove body styles to revert to CSS defaults
                             document.body.style.removeProperty('background-color');
                        } else {
                            localStorage.setItem(NAVBAR_SETTINGS_KEY, JSON.stringify(theme));
                            messageEl.textContent = `Theme '${theme.name}' applied successfully.`;
                            messageEl.className = 'message-area message-success';
                        }
                    } catch (error) {
                        console.error("Error saving theme to Local Storage:", error);
                        messageEl.textContent = 'Failed to save theme. Storage might be full.';
                        messageEl.className = 'message-area message-error';
                    }

                    // 3. Update UI selected state
                    document.querySelectorAll('#theme-palette .theme-card').forEach(s => s.classList.remove('selected'));
                    themeCard.classList.add('selected');
                    
                    // Update checkmark icon
                    document.querySelectorAll('#theme-palette .color-option i').forEach(i => i.remove());
                    themeCard.querySelector('.color-option').innerHTML = '<i class="fas fa-check"></i>';
                });
            });
            
            // Set active section for sidebar logic
            activeSection = 'personalization';
            updateSidebarActiveState();
        };

        // Placeholder for security settings
        window.renderSecuritySettings = function() {
            document.getElementById('panel-title').textContent = 'Security';
            document.getElementById('panel-content').innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl text-white mb-3">Password Change</h3>
                    <p class="settings-description">Update your account password securely.</p>
                </div>
            `;
            activeSection = 'security';
            updateSidebarActiveState();
        };

        // --- SIDEBAR & NAVIGATION LOGIC ---
        
        const sidebarNavigation = [
            { id: 'general', icon: 'fa-user', name: 'General', handler: window.renderGeneralSettings },
            { id: 'personalization', icon: 'fa-palette', name: 'Personalization', handler: window.renderPersonalizationSettings },
            { id: 'security', icon: 'fa-lock', name: 'Security', handler: window.renderSecuritySettings },
            // Add more sections here
        ];

        function buildSidebar() {
            const sidebarEl = document.getElementById('settings-sidebar');
            sidebarEl.innerHTML = sidebarNavigation.map(item => `
                <div id="sidebar-${item.id}" class="sidebar-item" data-section="${item.id}">
                    <i class="fas ${item.icon} w-6 h-6 mr-3"></i>
                    <span>${item.name}</span>
                </div>
            `).join('');

            // Add click listeners
            sidebarNavigation.forEach(item => {
                document.getElementById(`sidebar-${item.id}`).addEventListener('click', item.handler);
            });
            
            // Load the initial section
            const initialSection = sidebarNavigation.find(item => item.id === activeSection);
            if (initialSection) {
                 initialSection.handler();
            }
        }

        function updateSidebarActiveState() {
            document.querySelectorAll('.sidebar-item').forEach(item => {
                if (item.getAttribute('data-section') === activeSection) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        // --- CORE APPLICATION FLOW (Fixes Loading Issue) ---
        /**
         * The original code was stuck because it was waiting for onAuthStateChanged and onSnapshot, 
         * but did not define a final function to hide the loading screen and show content.
         * This function completes that flow using the stubbed Firebase functions.
         */
        window.startAuthFlow = function() {
            const loadingScreen = document.getElementById('loading-screen');
            const pageContent = document.getElementById('page-content');
            
            // 1. Start Auth Listener (using stubbed onAuthStateChanged)
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    
                    // 2. Load User Data (using stubbed getDoc)
                    const userDocRef = doc(db, "users", user.uid);
                    const docSnap = await getDoc(userDocRef);

                    if (docSnap.exists()) {
                        currentUserData = docSnap.data();
                    } else {
                        // Handle new user case or missing doc
                        currentUserData = {}; 
                    }
                    
                    // 3. Build UI
                    buildSidebar();

                    // 4. Hide Loading Screen and Show Content
                    loadingScreen.classList.add('hidden');
                    pageContent.classList.remove('hidden');
                    
                    console.log("Settings page loaded successfully.");

                } else {
                    // If no user, redirect to login (or show an error/message)
                    loadingScreen.innerHTML = '<p class="text-xl text-red-400">Authentication Required. Please log in.</p>';
                    // Optionally: window.location.href = '/login.html';
                }
            });
        };


        // --- START APPLICATION ---
        // This will start the Firebase Auth listener
        document.addEventListener('DOMContentLoaded', window.startAuthFlow);
    </script>
</body>
</html>

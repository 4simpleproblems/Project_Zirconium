<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js" defer></script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p class="text-lg font-light" id="loadingText">Loading...</p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, GithubAuthProvider, OAuthProvider, signOut, EmailAuthProvider, reauthenticateWithPopup, reauthenticateWithCredential, deleteUser } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, updateDoc, getDoc, runTransaction, query, collection, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config (Copied from authentication.html) ---
        const firebaseConfig = {
            apiKey: "[API_KEY_OMITTED]",
            authDomain: "[AUTH_DOMAIN_OMITTED]",
            projectId: "[PROJECT_ID_OMITTED]",
            storageBucket: "[STORAGE_BUCKET_OMITTED]",
            messagingSenderId: "[MESSAGING_SENDER_ID_OMITTED]",
            appId: "[APP_ID_OMITTED]",
            measurementId: "[MEASUREMENT_ID_OMITTED]"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- CONSTANTS ---
        let currentUser = null; // Stores the current authenticated user object
        const MAX_CHANGES = 2; // Max username changes per month
        const MIN_LENGTH = 3;
        const MAX_LENGTH = 20;

        // Provider mapping for UI
        const PROVIDER_CONFIG = {
            'google.com': { name: 'Google', icon: '../images/google.png', instance: () => new GoogleAuthProvider() },
            'github.com': { name: 'GitHub', icon: '../images/github.png', instance: () => new GithubAuthProvider() },
            'microsoft.com': { name: 'Microsoft', icon: '../images/microsoft.png', instance: () => new OAuthProvider('microsoft.com') },
            'password': { name: 'Email & Password', icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', isCredential: true }
        };

        // --- NEW: Constants for Privacy Settings ---
        // IndexedDB Config for Panic Key
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';

        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';

        // Presets copied from url-changer.js
        const urlChangerPresets = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'google', name: 'Google', title: 'Google', favicon: '../favicons/google.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'khanacademy', name: 'Khan Academy', title: 'Dashboard', favicon: '../favicons/khanacademy.png', category: 'educational' },
            { id: 'desmos', name: 'Desmos', title: 'Desmos | Graphing Calculator', favicon: '../favicons/desmos.png', category: 'educational' },
            { id: 'nytimes', name: 'New York Times', title: 'The New York Times - Breaking News, US News, World News and Videos', favicon: '../favicons/nytimes.png', category: 'news' },
        ];


        // --- DOM Elements ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');

        // --- Utility Functions ---
        function getUserDocRef(uid) {
            return doc(db, 'users', uid);
        }

        let loadingTimeout = null;

        /**
         * Shows a message in a dedicated message area.
         */
        function showMessage(element, message, type = 'success') {
            element.classList.remove('success-message', 'error-message', 'warning-message');
            element.classList.add(`${type}-message`);
            element.innerHTML = message;

            // Clear after 5 seconds unless it's a persistent message
            if (type !== 'error' && type !== 'warning') {
                setTimeout(() => {
                    element.textContent = '';
                }, 5000);
            }
        }
        
        /**
         * NEW: Shows a confirmation modal.
         * @returns {Promise<boolean>} Resolves to true if confirmed, false otherwise.
         */
        function showModalPrompt(text, confirmText = "Confirm", cancelText = "Cancel", confirmClass = "btn-primary-override-danger") {
            return new Promise(resolve => {
                const modal = document.getElementById('modalPrompt');
                const modalText = document.getElementById('modalText');
                const modalButtons = document.getElementById('modalButtons');
                const modalClose = document.getElementById('modalClose');

                // Clear previous buttons/listeners
                modalButtons.innerHTML = '';
                const oldCloseListener = modalClose.onclick;
                if (oldCloseListener) modalClose.removeEventListener('click', oldCloseListener);


                modalText.textContent = text;
                
                // Confirm Button
                const confirmBtn = document.createElement('button');
                confirmBtn.classList.add('btn-toolbar-style', 'w-36', confirmClass);
                confirmBtn.textContent = confirmText;
                confirmBtn.onclick = () => {
                    modal.style.display = "none";
                    resolve(true);
                };

                // Cancel Button
                const cancelBtn = document.createElement('button');
                cancelBtn.classList.add('btn-toolbar-style', 'w-36');
                cancelBtn.textContent = cancelText;
                cancelBtn.onclick = () => {
                    modal.style.display = "none";
                    resolve(false);
                };

                modalButtons.appendChild(cancelBtn);
                modalButtons.appendChild(confirmBtn);

                modalClose.onclick = () => {
                    modal.style.display = "none";
                    resolve(false);
                };
                
                // Clicking outside the modal
                window.onclick = function(event) {
                    if (event.target == modal) {
                        modal.style.display = "none";
                        resolve(false);
                    }
                }
                
                modal.style.display = "flex";
            });
        }
        
        function showLoading(text = "Loading...") {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000); // 5 second timeout
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }


        // --- NEW: Core Data Functions (from index.html) ---
        function getAllLocalStorageData() { 
            const data = {}; 
            for (let i = 0; i < localStorage.length; i++) { 
                const key = localStorage.key(i); 
                // Skip theme key 
                if (key !== THEME_STORAGE_KEY) { 
                    data[key] = localStorage.getItem(key); 
                } 
            } 
            return data; 
        }

        async function getAllIndexedDBData() {
            const databases = await indexedDB.databases();
            const data = {};
            for (const dbInfo of databases) {
                if (dbInfo.name && dbInfo.name !== DB_NAME) { // Skip our own settings DB
                    data[dbInfo.name] = await getDBContent(dbInfo.name);
                }
            }
            return data;

            async function getDBContent(dbName) {
                const openRequest = indexedDB.open(dbName);
                const dbInstance = await new Promise((resolve, reject) => {
                    openRequest.onsuccess = event => { resolve(event.target.result); };
                    openRequest.onerror = event => { reject(event.target.error); };
                });

                const content = {};
                const storeNames = Array.from(dbInstance.objectStoreNames);

                for (const storeName of storeNames) {
                    await new Promise(resolve => {
                        const transaction = dbInstance.transaction(storeName, "readonly");
                        const store = transaction.objectStore(storeName);
                        const request = store.getAll();
                        request.onsuccess = () => {
                            content[storeName] = request.result;
                            resolve();
                        };
                        request.onerror = () => {
                            content[storeName] = { error: "Failed to read store" };
                            resolve();
                        };
                    });
                }
                dbInstance.close();
                return content;
            }
        }

        async function setAllIndexedDBData(storesData) {
            if (Object.keys(storesData).length === 0) return;

            showLoading("Restoring IndexedDB...");

            // Clear existing databases first (except our own settings DB)
            const dbList = await indexedDB.databases();
            for (const dbInfo of dbList) {
                if (dbInfo.name && dbInfo.name !== DB_NAME) {
                    await new Promise(resolve => {
                        const deleteRequest = indexedDB.deleteDatabase(dbInfo.name);
                        deleteRequest.onsuccess = () => resolve();
                        deleteRequest.onerror = () => resolve();
                        deleteRequest.onblocked = () => resolve();
                    });
                }
            }

            for (const dbName in storesData) {
                // Recreate the database with the correct store structure
                const openRequest = indexedDB.open(dbName, 1);
                openRequest.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    for (const storeName in storesData[dbName]) {
                        if (!db.objectStoreNames.contains(storeName)) {
                            db.createObjectStore(storeName, { autoIncrement: false });
                        }
                    }
                };
                
                const dbInstance = await new Promise((resolve, reject) => {
                    openRequest.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    openRequest.onerror = event => {
                        reject(event.target.error);
                    };
                });

                // Put data into the stores
                for (const storeName in storesData[dbName]) {
                    await new Promise(resolve => {
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = (event) => {
                            console.error(`Error in transaction for store ${storeName} in DB ${dbName}`, event.target.error);
                            resolve();
                        };
                        const store = transaction.objectStore(storeName);
                        
                        const items = storesData[dbName][storeName];
                        if (Array.isArray(items)) {
                            items.forEach(item => {
                                // If the item has a 'key' property (like StrongdogXP), use it as the key.
                                // Otherwise, assume it's for an object store that uses auto-increment or has no keyPath.
                                if (item.key) {
                                    store.put(item, item.key);
                                } else {
                                    store.put(item); 
                                }
                            });
                        }
                    });
                }
                dbInstance.close();
            }
            hideLoading();
        }

        // --- Data Download/Upload/Deletion Handlers (from index.html) ---
        async function downloadAllSaves() {
            showLoading("Preparing download...");
            const localData = getAllLocalStorageData();
            const indexedData = await getAllIndexedDBData();

            const dataToDownload = {
                localStorageBackup: localData,
                indexedDBBackup: indexedData,
            };
            
            hideLoading();

            const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], {
                type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "4sp-game-data.json"; // This name is used in test (3).html
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function handleFileUpload() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async evt => {
                    const content = evt.target.result;
                    let parsed;
                    try {
                        parsed = JSON.parse(content);
                    } catch (err) {
                        showMessage(document.getElementById('deleteDataMessage'), 'Error: Invalid JSON file.', 'error');
                        return;
                    }

                    if (!parsed.localStorageBackup || !parsed.indexedDBBackup) {
                        showMessage(document.getElementById('deleteDataMessage'), 'Error: File structure is incorrect.', 'error');
                        return;
                    }

                    showLoading("Restoring data...");
                    try {
                        // 1. Clear existing non-theme localStorage
                        const keysToRemove = Object.keys(getAllLocalStorageData());
                        keysToRemove.forEach(key => localStorage.removeItem(key));
                        
                        // 2. Restore localStorage
                        for (const key in parsed.localStorageBackup) {
                            localStorage.setItem(key, parsed.localStorageBackup[key]);
                        }

                        // 3. Restore IndexedDB
                        await setAllIndexedDBData(parsed.indexedDBBackup);
                        
                        hideLoading();
                        showMessage(document.getElementById('deleteDataMessage'), 'Data successfully imported! Reloading...', 'success');
                        setTimeout(() => location.reload(), 1500); // Reload after import

                    } catch (e) {
                        console.error("Data import failed:", e);
                        hideLoading();
                        showMessage(document.getElementById('deleteDataMessage'), 'An unexpected error occurred during import.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function deleteAllLocalData() {
            const confirmed = await showModalPrompt('Are you sure you want to permanently delete ALL local game data? This action is irreversible.');
            if (!confirmed) return;

            showLoading("Deleting all local data...");
            try {
                // 1. Clear localStorage keys (excluding theme/url changer settings)
                const keysToRemove = Object.keys(getAllLocalStorageData());
                keysToRemove.forEach(key => localStorage.removeItem(key));

                // 2. Delete IndexedDB databases
                if (indexedDB.databases) {
                    const dbList = await indexedDB.databases();
                    for (const dbInfo of dbList) {
                        if (dbInfo.name && dbInfo.name !== DB_NAME) { // Skip our own settings DB
                            await new Promise(resolve => {
                                const deleteRequest = indexedDB.deleteDatabase(dbInfo.name);
                                deleteRequest.onsuccess = () => resolve();
                                deleteRequest.onerror = () => resolve();
                                deleteRequest.onblocked = () => resolve();
                            });
                        }
                    }
                }

                hideLoading();
                showMessage(document.getElementById('deleteDataMessage'), 'All local data successfully deleted!', 'success');
                setTimeout(() => location.reload(), 1500);
            } catch (e) {
                console.error("Data deletion failed:", e);
                hideLoading();
                showMessage(document.getElementById('deleteDataMessage'), 'An unexpected error occurred during deletion.', 'error');
            }
        }


        // --- HTML Content Generation Functions ---

        /**
         * Generates the HTML for the General Settings section.
         * (This is a simplified version for display, the full implementation requires real Firebase data)
         */
        function getGeneralContent(currentUsername, changesRemaining, changesThisMonth, currentMonthName, isEmailPasswordUser, providerData) {
            // ... (Content generation function for General Tab remains unchanged)
            const primaryProviderId = providerData.find(p => p.uid === currentUser.uid).providerId;
            const passwordSectionHtml = isEmailPasswordUser ? `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Password Management</h3>
                <div id="passwordSection" class="settings-box w-full p-4">
                    <p class="text-sm font-light text-gray-400 mb-4">
                        <i class="fa-solid fa-triangle-exclamation mr-1 text-yellow-400"></i> You must use the link sent to your email to change your password. This ensures your account security.
                    </p>
                    <div class="flex justify-end">
                        <button id="sendPasswordResetBtn" class="btn-toolbar-style btn-primary-override w-48">
                            <i class="fa-solid fa-envelope mr-1"></i> Send Password Link
                        </button>
                    </div>
                    <p id="passwordResetMessage" class="general-message-area text-sm"></p>
                </div>
            ` : '';

            /**
             * Generates the HTML for the Account Management section (Linked Providers)
             */
            function getAccountManagementContent(providerData) {
                const primaryProviderId = providerData.find(p => p.uid === currentUser.uid).providerId;
                const linkedProvidersHtml = providerData.map(p => {
                    const id = p.providerId;
                    // Fallback to PROVIDER_CONFIG if providerData doesn't contain the full config (e.g., from an old session)
                    const config = PROVIDER_CONFIG[id] || { name: id, icon: '<i class="fa-solid fa-puzzle-piece fa-lg mr-3"></i>' };
                    // Determine if this provider can be unlinked
                    const canUnlink = providerData.length > 1 && !(id === 'password' && primaryProviderId === 'password');
                    // Determine if icon is an image or a FontAwesome icon
                    let iconHtml = config.icon.startsWith('<i') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-5 h-5 mr-3">`;

                    let linkButton = '';
                    if (canUnlink) {
                        linkButton = `
                            <button class="btn-toolbar-style text-red-400 hover:border-red-600 hover:text-red-600" data-provider-id="${id}" data-action="unlink">
                                <i class="fa-solid fa-chain-broken"></i> Unlink
                            </button>
                        `;
                    } else if (id !== primaryProviderId) {
                         linkButton = `
                            <button class="btn-toolbar-style text-gray-400 hover:border-gray-600 hover:text-gray-600" data-provider-id="${id}" disabled>
                                <i class="fa-solid fa-arrow-up-right-from-square"></i> Set Primary
                            </button>
                        `;
                    }

                    return `
                    <div class="flex justify-between items-center px-4 py-4 border-b border-[#252525] last:border-b-0">
                        <div class="flex items-center text-lg text-white">
                            ${iconHtml}
                            ${config.name}
                            ${id === primaryProviderId ? '<span class="text-xs text-yellow-400 ml-2 font-normal">(Primary)</span>' : ''}
                        </div>
                        ${linkButton}
                    </div>
                    `;
                }).join('');

                // Get a list of providers that are *not* currently linked
                const linkedProviderIds = providerData.map(p => p.providerId);
                const availableProvidersHtml = Object.keys(PROVIDER_CONFIG)
                    .filter(id => id !== primaryProviderId && !linkedProviderIds.includes(id))
                    .filter(id => id !== 'password') // Don't show "Link Email/Password" here
                    .map(id => {
                        const config = PROVIDER_CONFIG[id];
                        return `
                            <button class="btn-toolbar-style settings-tab w-full link-btn" data-provider-id="${id}">
                                ${config.isCredential ? config.icon : `<img src="${config.icon}" alt="${config.name} icon" class="w-5 h-5 mr-3">`}
                                <span class="flex-grow text-left">Link with ${config.name}</span>
                            </button>
                        `;
                    }).join('');

                // Deletion Content
                let deletionContent = '';
                // Only show deletion section if user is logged in
                if (auth.currentUser) {
                    deletionContent = `
                        <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                        <div id="deletionSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                            <p class="text-sm font-light text-red-300 mb-3">
                                <i class="fa-solid fa-triangle-exclamation mr-1"></i> WARNING: Deleting your account is permanent. You must re-authenticate with ${PROVIDER_CONFIG[primaryProviderId].name} to proceed.
                            </p>
                            <div class="flex justify-between items-center pt-2">
                                <p id="deleteMessage" class="general-message-area text-sm"></p>
                                <button id="reauthenticateBtn" class="btn-toolbar-style w-48 btn-primary-override" data-provider-id="${primaryProviderId}" style="padding: 0.5rem 0.75rem;">
                                    <i class="fa-solid fa-key mr-1"></i> Re-authenticate
                                </button>
                                <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48 hidden" style="padding: 0.5rem 0.75rem;">
                                    <i class="fa-solid fa-trash mr-1"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    `;
                }


                return `
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Linked Accounts</h3>
                    <div id="linkedProvidersSection" class="settings-box w-full">
                        ${linkedProvidersHtml}
                    </div>

                    ${availableProvidersHtml.length > 0 ? `
                        <h3 class="text-xl font-bold text-white mb-2 mt-8">Link New Account</h3>
                        <div id="availableProvidersSection" class="w-full flex flex-col gap-3">
                            ${availableProvidersHtml}
                        </div>
                    ` : ''}

                    ${deletionContent}
                `;
            }


            // The main General tab HTML structure
            return `
                <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Username</h3>
                    <div id="usernameSection" class="settings-box w-full p-4">
                        <div id="viewMode" class="flex justify-between items-center">
                            <p class="text-lg text-white font-medium">${currentUsername}</p>
                            <button id="editUsernameBtn" class="btn-toolbar-style w-36">
                                <i class="fa-solid fa-pen-to-square mr-1"></i> Edit
                            </button>
                        </div>
                        <div id="editMode" class="hidden">
                            <input type="text" id="usernameInput" class="input-text-style" value="${currentUsername}" placeholder="Enter new username">
                            <div class="flex justify-between items-center text-xs text-gray-500 font-light px-1">
                                <p>Length: <span id="charCount">${currentUsername.length}</span> (Min: <span id="minLength">${MIN_LENGTH}</span>, Max: <span id="maxLength">${MAX_LENGTH}</span>)</p>
                                <p>Allowed Symbols: .,-+\\_!?$</p>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="usernameChangeMessage" class="general-message-area text-sm"></p>
                            <div>
                                <button id="cancelEditBtn" class="btn-toolbar-style mr-3">
                                    Cancel
                                </button>
                                <button id="applyUsernameBtn" class="btn-toolbar-style btn-primary-override w-36" disabled>
                                    <i class="fa-solid fa-check mr-1"></i> Apply
                                </button>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 font-light mt-4 text-center">
                            You have <span class="text-emphasis">${changesRemaining}</span> of <span class="text-emphasis">${MAX_CHANGES}</span> username changes left for ${currentMonthName}.
                        </p>
                    </div>
                    ${passwordSectionHtml}
                    ${getAccountManagementContent(providerData)}
                </div>
            `;
        }

        /**
         * Generates the HTML for the "Privacy & Security" section.
         */
        function getPrivacyContent(panicKeySettings) {
            // Panic Key Inputs HTML
            const panicKeyHtml = panicKeySettings.map((setting, index) => {
                const id = setting.id || `panic-key-${index + 1}`;
                const key = setting.key || '';
                const url = setting.url || '';
                return `
                    <div class="flex items-center gap-4 px-2 mb-2" data-panic-id="${id}">
                        <label class="block text-gray-400 text-sm font-light" style="width: 3.5rem;">Key ${index + 1}:</label>
                        <input type="text" data-type="key" class="input-key-style" placeholder="Key" maxlength="1" value="${key}">
                        <input type="text" data-type="url" class="input-text-style" placeholder="Enter URL (e.g., google.com)" value="${url}">
                    </div>
                `;
            }).join('');

            // Generate preset options
            const presetOptions = urlChangerPresets.map(preset => `<option value="${preset.id}">${preset.name}</option>` ).join('');

            return `
                <h2 class="text-3xl font-bold text-white mb-6">Privacy & Security</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Panic Key Settings</h3>
                    <div id="panicKeySection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Configure up to 3 panic keys. Pressing the specified key (without Shift, Ctrl, or Alt) on any page will redirect you to the URL you set.
                            <br>
                            <span class="text-yellow-400">Valid keys:</span> a-z, 0-9, and \` - = [ ] \\ ; ' , . /
                        </p>
                        ${panicKeyHtml}
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                            <button id="applyPanicKeyBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Tab Disguise (URL Changer)</h3>
                    <div id="urlChangerSection" class="settings-box w-full p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Change the page title and favicon to mimic an educational or popular website, hiding your activity from quick glances.
                        </p>

                        <label for="modeSelect" class="block text-sm font-light text-gray-400 mb-1">Disguise Mode</label>
                        <select id="modeSelect" class="input-select-style mb-4">
                            <option value="none">None (Default 4SP Title/Favicon)</option>
                            <option value="preset">Preset Disguise (e.g., Google, HAC)</option>
                            <option value="custom">Custom Disguise</option>
                        </select>
                        
                        <div id="presetGroup" class="hidden transition-all duration-300">
                            <label for="presetSelect" class="block text-sm font-light text-gray-400 mb-1">Select Preset</label>
                            <select id="presetSelect" class="input-select-style">
                                ${presetOptions}
                            </select>
                        </div>

                        <div id="customGroup" class="hidden transition-all duration-300 settings-box p-4 border-[#4f46e5]/20">
                            <h4 class="text-lg font-bold text-white mb-3">Custom Tab Details</h4>
                            <div class="flex flex-col gap-3">
                                <div>
                                    <label for="customTitle" class="block text-sm font-light text-gray-400 mb-1">Custom Tab Title</label>
                                    <input type="text" id="customTitle" class="input-text-style" placeholder="e.g., Google Classroom">
                                </div>
                                <div class="flex items-center gap-4">
                                    <label for="faviconFile" class="block text-sm font-light text-gray-400 flex-grow">Favicon (Optional)</label>
                                    <button id="fetchFaviconBtn" class="btn-toolbar-style w-40">
                                        <i class="fa-solid fa-search mr-1"></i> Fetch from URL
                                    </button>
                                    <input type="file" id="faviconFile" accept="image/*" class="hidden">
                                </div>
                                <div class="flex items-center gap-4">
                                    <p class="text-xs text-gray-500 font-light flex-grow">
                                        You can either upload a favicon file or attempt to fetch one from a URL.
                                    </p>
                                    <div class="w-10 h-10 border border-[#252525] flex items-center justify-center p-1 rounded-md bg-white">
                                        <img id="faviconPreview" src="" alt="Preview" class="w-full h-full object-contain" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="urlChangerMessage" class="general-message-area text-sm"></p>
                            <button id="applyUrlChangerBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Tab
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }


        /**
         * NEW: Generates the HTML for the "Personalization" section.
         */
        function getPersonalizationContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Personalization</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Navigation Bar Theme</h3>
                    <div id="theme-picker-section" class="settings-box w-full p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Change the color scheme of the navigation bar across all pages. The theme of the settings page will update automatically.
                        </p>
                        <div id="theme-picker-container">
                            </div>
                        <p id="themeMessage" class="general-message-area text-sm"></p>
                    </div>
                </div>
            `;
        }

        /**
         * NEW: Generates the HTML for the "Data Management" section.
         */
        function getDataManagementContent() {
            return `
        <h2 class="text-3xl font-bold text-white mb-6">Data Management</h2>
        <div class="w-full">
            <h3 class="text-xl font-bold text-white mb-2">Backup and Restore</h3>
            <div id="backupRestoreSection" class="settings-box w-full p-4 mb-8">
                <p class="text-sm font-light text-gray-400 mb-4">
                    You can download a backup of your local save data (localStorage and IndexedDB). This can be used to transfer your data between browsers or devices.
                    <br>
                    <span class="text-yellow-400 font-medium">Important:</span> This does not include your online account information.
                </p>
                <div class="flex justify-between items-center pb-4 border-b border-[#252525]">
                    <p class="text-sm font-light text-gray-300">Download your data now.</p>
                    <button id="downloadSavesBtn" class="btn-toolbar-style btn-primary-override w-48">
                        <i class="fa-solid fa-download mr-1"></i> Download Save
                    </button>
                </div>
                <h4 class="text-lg font-bold text-white mt-4 mb-2">Import Data</h4>
                <p class="text-sm font-light text-gray-400 mb-4">
                    <i class="fa-solid fa-triangle-exclamation mr-1 text-yellow-400"></i> Uploading a save file will overwrite your existing local data.
                    Data covered by this import includes:
                    <ul class="list-disc list-inside ml-4 mt-2 text-sm text-gray-300">
                        <li>StrongdogXP Games data</li>
                        <li>GN-Math games data (for saving compatibility)</li>
                    </ul>
                </p>
                <div class="flex justify-end">
                    <button id="uploadSavesBtn" class="btn-toolbar-style btn-primary-override w-48">
                        <i class="fa-solid fa-upload mr-1"></i> Upload Save
                    </button>
                </div>
            </div>

            <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete All Local Data</h3>
            <div id="deleteDataSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                <p class="text-sm font-light text-red-300 mb-4">
                    <i class="fa-solid fa-triangle-exclamation mr-1"></i> WARNING: This action will permanently delete all local game data (localStorage and IndexedDB) on this browser. This action is irreversible.
                </p>
                <p id="deleteDataMessage" class="general-message-area text-sm"></p>
                <div class="flex justify-end">
                    <button id="deleteAllDataBtn" class="btn-toolbar-style btn-primary-override-danger w-48">
                        <i class="fa-solid fa-trash-can mr-1"></i> Delete All Data
                    </button>
                </div>
            </div>
        </div>
        `;
        }

        /**
         * Generates the HTML for the "About" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">About 4SP</h2>
                <div class="about-section-content">
                    <h3 class="text-xl font-bold text-white mb-2">Our Mission & Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>
                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>

                    <h3 class="text-xl font-bold text-white mt-6 mb-2">Version</h3>
                    <p class="text-lg text-gray-400">4SP v5.2 (Beta)</p>
                    <p class="text-sm text-gray-500 mt-1">Last Update: November 15, 2025</p>

                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Connect</h3>
                    <div class="social-link-group">
                        <a href="https://discord.gg/4simpleproblems" target="_blank" class="btn-toolbar-style" title="Discord">
                            <i class="fa-brands fa-discord fa-lg mr-2"></i> Discord
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="Buy Me a Coffee">
                            <i class="fa-solid fa-mug-hot fa-lg mr-2"></i> Buy Me a Coffee
                        </a>
                        <a href="https://github.com/v5-4simpleproblems" target="_blank" class="btn-toolbar-style" title="GitHub">
                            <i class="fa-brands fa-github fa-lg mr-2"></i> GitHub
                        </a>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Legal</h3>
                    <div class="legal-buttons">
                        <a href="../privacy.html" target="_blank" class="btn-toolbar-style">Privacy Policy</a>
                        <a href="../terms.html" target="_blank" class="btn-toolbar-style">Terms of Service</a>
                        <a href="../dmca.html" target="_blank" class="btn-toolbar-style">DMCA</a>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for a "Coming Soon" section.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">${title}</h2>
                <div class="w-full settings-box p-8 text-center">
                    <i class="fa-solid fa-screwdriver-wrench fa-4x text-gray-500 mb-4"></i>
                    <p class="text-xl text-gray-400 font-medium">Coming Soon!</p>
                    <p class="text-md text-gray-500 mt-2">This feature is currently under development.</p>
                </div>
            `;
        }

        // --- Load Tab Data & Event Listener Functions ---

        /**
         * NEW: Loads data and adds event listeners for the General tab.
         */
        async function loadGeneralTab() {
            // Check if user data exists in firestore
            if (!currentUser) return;
            const userDocRef = getUserDocRef(currentUser.uid);
            let userDocSnap = await getDoc(userDocRef);
            if (!userDocSnap.exists()) {
                mainView.innerHTML = `<p class="error-message">User data not found. Please log out and back in.</p>`;
                return;
            }
            let userData = userDocSnap.data();

            const today = new Date();
            const currentMonthNumber = today.getMonth() + 1;
            const currentMonthName = today.toLocaleDateString('en-US', { month: 'long' });
            let changesThisMonth = userData.usernameChangesThisMonth || 0;
            let lastChangeMonth = userData.lastUsernameChangeMonth || 0;

            // --- Monthly Reset Logic ---
            if (currentMonthNumber !== lastChangeMonth) {
                changesThisMonth = 0;
                await updateDoc(userDocRef, {
                    usernameChangesThisMonth: 0,
                    lastUsernameChangeMonth: currentMonthNumber
                });
                userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.data();
            }

            const changesRemaining = MAX_CHANGES - changesThisMonth;
            const isEmailPasswordUser = currentUser.providerData.some(p => p.providerId === 'password');
            

            // 1. Render the General Content
            mainView.innerHTML = getGeneralContent(
                userData.username,
                changesRemaining,
                changesThisMonth,
                currentMonthName,
                isEmailPasswordUser,
                currentUser.providerData // Pass provider info
            );
            

            // 2. Element References (Username Section)
            const viewMode = document.getElementById('viewMode');
            const editMode = document.getElementById('editMode');
            const enterEditModeBtn = document.getElementById('editUsernameBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const usernameInput = document.getElementById('usernameInput');
            const applyUsernameBtn = document.getElementById('applyUsernameBtn');
            const messageElement = document.getElementById('usernameChangeMessage');
            const charCount = document.getElementById('charCount');

            // 3. Setup Username Section
            // Edit button handler
            enterEditModeBtn.addEventListener('click', () => {
                viewMode.classList.add('hidden');
                editMode.classList.remove('hidden');
                usernameInput.focus();
            });

            // Cancel button handler
            cancelEditBtn.addEventListener('click', () => {
                editMode.classList.add('hidden');
                viewMode.classList.remove('hidden');
                usernameInput.value = userData.username; // Reset value
                applyUsernameBtn.disabled = true; // Disable apply button
                messageElement.innerHTML = ''; // Clear message
                charCount.textContent = userData.username.length; // Reset char count
            });

            // Input validation and change handler
            usernameInput.addEventListener('input', () => {
                const newUsername = usernameInput.value.trim();
                charCount.textContent = newUsername.length;
                let valid = true;
                messageElement.innerHTML = ''; // Clear previous messages

                if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                    messageElement.innerHTML = `<span class="error-message">Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.</span>`;
                    valid = false;
                } else if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                    messageElement.innerHTML = `<span class="error-message">Username contains invalid characters.</span>`;
                    valid = false;
                } else if (newUsername === userData.username) {
                    valid = false;
                } else if (changesRemaining <= 0) {
                    messageElement.innerHTML = `<span class="error-message">You have reached the limit of username changes for this month.</span>`;
                    valid = false;
                }

                applyUsernameBtn.disabled = !valid;
            });


            // Apply button handler (runs the transaction)
            applyUsernameBtn.addEventListener('click', async () => {
                const newUsername = usernameInput.value.trim();
                applyUsernameBtn.disabled = true; // Disable immediately
                showMessage(messageElement, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Checking username...', 'warning');

                try {
                    // Validation (re-run as a final check)
                    if (newUsername === userData.username) {
                        showMessage(messageElement, 'New username is the same as the current one.', 'warning');
                        applyUsernameBtn.disabled = false;
                        return;
                    }
                    if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                        showMessage(messageElement, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error');
                        return;
                    }
                    if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                        showMessage(messageElement, 'Username contains invalid characters (Allowed symbols: .,-+\\_!?$).', 'error');
                        return;
                    }

                    // --- Checks ---
                    // 1. Check for profanity
                    if (await checkProfanity(newUsername)) {
                        showMessage(messageElement, 'This username is blocked by our profanity filter.', 'error');
                        return;
                    }

                    // 2. Check for existence
                    const usernameQuery = query(collection(db, 'users'), where('username', '==', newUsername));
                    const querySnapshot = await getDocs(usernameQuery);
                    if (!querySnapshot.empty) {
                        showMessage(messageElement, 'This username is already taken.', 'error');
                        return;
                    }

                    // --- Transaction to Update Username and Change Count ---
                    await runTransaction(db, async (transaction) => {
                        const sfDoc = await transaction.get(userDocRef);
                        if (!sfDoc.exists) {
                            throw "Document does not exist!";
                        }

                        // Re-check count (in case another device updated it)
                        const currentChanges = (sfDoc.data().usernameChangesThisMonth || 0);
                        if (currentChanges >= MAX_CHANGES) {
                            throw "Change limit reached.";
                        }

                        // Update the document
                        transaction.update(userDocRef, {
                            username: newUsername,
                            usernameChangesThisMonth: currentChanges + 1,
                            lastUsernameChangeMonth: currentMonthNumber
                        });
                    });

                    // Success!
                    showMessage(messageElement, 'Username updated successfully! Reloading...', 'success');
                    setTimeout(() => location.reload(), 1000);

                } catch (error) {
                    console.error("Username change failed:", error);
                    let displayMessage = 'An unexpected error occurred. Please try again.';
                    if (error === "Change limit reached.") {
                        displayMessage = `You have reached the limit of username changes for ${currentMonthName}.`;
                    } else if (error.code && error.code === 'unavailable') {
                         displayMessage = 'Server is currently unavailable. Please try again later.';
                    } else if (error.message && error.message.includes('already taken')) { // Catch duplicate check that might happen right after
                         displayMessage = 'This username is already taken.';
                    }

                    showMessage(messageElement, displayMessage, 'error');
                    applyUsernameBtn.disabled = false;
                }
            });

            // 4. Setup Password Section
            const sendPasswordResetBtn = document.getElementById('sendPasswordResetBtn');
            const passwordResetMessage = document.getElementById('passwordResetMessage');

            if (sendPasswordResetBtn) {
                sendPasswordResetBtn.addEventListener('click', async () => {
                    sendPasswordResetBtn.disabled = true;
                    showMessage(passwordResetMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Sending email...', 'warning');

                    try {
                        const authModule = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                        await authModule.sendPasswordResetEmail(auth, currentUser.email);
                        showMessage(passwordResetMessage, `Password reset link sent to ${currentUser.email}!`, 'success');
                    } catch (error) {
                        console.error("Error sending password reset:", error);
                        showMessage(passwordResetMessage, 'Error sending reset email. Please try again.', 'error');
                    }
                    sendPasswordResetBtn.disabled = false;
                });
            }

            // 5. Setup Linked Accounts Section
            const unlinkButtons = document.querySelectorAll('[data-action="unlink"]');
            unlinkButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const providerId = btn.dataset.providerId;
                    const providerName = PROVIDER_CONFIG[providerId].name;

                    const confirmed = await showModalPrompt(`Are you sure you want to unlink your ${providerName} account?`);
                    if (!confirmed) return;

                    showLoading(`Unlinking ${providerName}...`);
                    try {
                        const authModule = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                        await authModule.unlink(currentUser, providerId);
                        hideLoading();
                        showMessage(messageElement, `${providerName} successfully unlinked! Reloading...`, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        console.error(`Error unlinking ${providerName}:`, error);
                        hideLoading();
                        showMessage(messageElement, `Failed to unlink ${providerName}. Please try again.`, 'error');
                    }
                });
            });

            // 6. Setup Link New Account Buttons
            const linkButtons = document.querySelectorAll('.link-btn');
            linkButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    const providerId = btn.dataset.providerId;
                    const providerConfig = PROVIDER_CONFIG[providerId];
                    const provider = providerConfig.instance();
                    showLoading(`Linking with ${providerConfig.name}...`);
                    try {
                        const authModule = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                        await authModule.linkWithPopup(currentUser, provider);
                        hideLoading();
                        showMessage(messageElement, `${providerConfig.name} successfully linked! Reloading...`, 'success');
                        setTimeout(() => location.reload(), 1000);
                    } catch (error) {
                        console.error(`Error linking ${providerConfig.name}:`, error);
                        hideLoading();
                        let msg = `Failed to link ${providerConfig.name}. Please try again.`;
                        if (error.code === 'auth/credential-already-in-use') {
                            msg = 'This account is already linked to another user.';
                        } else if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Link operation cancelled by user.';
                        } else if (error.code === 'auth/operation-not-allowed') {
                             msg = 'Account linking is not enabled for this provider.';
                        }
                        showMessage(messageElement, msg, 'error');
                    }
                });
            });


            // 7. Setup Delete Account Section
            const reauthenticateBtn = document.getElementById('reauthenticateBtn');
            const finalDeleteBtn = document.getElementById('finalDeleteBtn');
            const deleteMessage = document.getElementById('deleteMessage');

            if (reauthenticateBtn) {
                reauthenticateBtn.addEventListener('click', async () => {
                    const providerId = reauthenticateBtn.dataset.providerId;
                    const providerConfig = PROVIDER_CONFIG[providerId];
                    showLoading(`Re-authenticating with ${providerConfig.name}...`);

                    try {
                        let credential = null;
                        let reauthenticateFunc = null;

                        if (providerId === 'password') {
                            // If primary is Email/Password, we must prompt for password
                            const password = await showPasswordPrompt(); // Placeholder for actual password prompt logic
                            if (!password) {
                                hideLoading();
                                showMessage(deleteMessage, 'Authentication cancelled.', 'error');
                                return;
                            }
                            credential = EmailAuthProvider.credential(currentUser.email, password);
                            reauthenticateFunc = (user, cred) => reauthenticateWithCredential(user, cred);
                        } else {
                            // Social login re-authentication via popup
                            const provider = providerConfig.instance();
                            const authModule = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                            const result = await authModule.reauthenticateWithPopup(currentUser, provider);
                            credential = result.credential;
                            reauthenticateFunc = (user, cred) => authModule.reauthenticateWithCredential(user, cred);
                        }

                        // Re-authenticate (if credential was needed)
                        if (reauthenticateFunc && credential) {
                             await reauthenticateFunc(currentUser, credential);
                        }
                        
                        hideLoading();

                        // successful re-auth, change button to final delete button
                        reauthenticateBtn.classList.add('hidden');
                        finalDeleteBtn.classList.remove('hidden');
                        showMessage(deleteMessage, 'Authentication successful. Click "Delete Account" one last time to confirm.', 'success');

                    } catch (error) {
                        console.error("Error during social re-authentication for deletion:", error);
                        hideLoading();
                        let msg = 'Re-authentication failed. Please try again.';
                        if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Re-authentication cancelled by user.';
                        } else if (error.code === 'auth/wrong-password') {
                            msg = 'Incorrect password.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please log out and log back in before attempting to delete.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                    }
                });

                finalDeleteBtn.addEventListener('click', async () => {
                    const confirmed = await showModalPrompt('This action is irreversible. All your account data will be permanently deleted.', 'DELETE ACCOUNT', 'Cancel', 'btn-primary-override-danger');
                    if (!confirmed) return;
                    
                    showLoading("Deleting account...");
                    try {
                        // Delete the user's Firestore document
                        const { deleteDoc } = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js");
                        await deleteDoc(userDocRef);

                        // Delete the user from Firebase Auth
                        const authModule = await import("https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js");
                        await authModule.deleteUser(currentUser);
                        
                        hideLoading();
                        // Redirect on success (which also happens on auth.deleteUser)
                        window.location.href = '../authentication.html';
                    } catch (error) {
                        console.error("Error deleting account:", error);
                        hideLoading();
                        let msg = 'Failed to delete account. Please try logging in again and re-authenticating.';
                        if (error.code === 'auth/requires-recent-login') {
                            msg = 'Authentication session timed out. Please re-authenticate via the blue button.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                    }
                });
            }

            // TEMP: Placeholder for actual password prompt for email/password re-auth
            async function showPasswordPrompt() {
                const modal = document.getElementById('modalPrompt');
                const modalText = document.getElementById('modalText');
                const modalButtons = document.getElementById('modalButtons');
                const modalClose = document.getElementById('modalClose');

                modalButtons.innerHTML = '';
                modalText.textContent = "Enter your password to confirm account deletion:";
                
                const input = document.createElement('input');
                input.type = 'password';
                input.classList.add('input-text-style', 'mt-4');
                input.placeholder = 'Your Password';
                modalText.appendChild(input);

                return new Promise(resolve => {
                    const confirmBtn = document.createElement('button');
                    confirmBtn.classList.add('btn-toolbar-style', 'w-36', 'btn-primary-override-danger');
                    confirmBtn.textContent = 'Confirm';
                    confirmBtn.onclick = () => {
                        modal.style.display = "none";
                        resolve(input.value);
                    };

                    const cancelBtn = document.createElement('button');
                    cancelBtn.classList.add('btn-toolbar-style', 'w-36');
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.onclick = () => {
                        modal.style.display = "none";
                        resolve(null);
                    };

                    modalButtons.appendChild(cancelBtn);
                    modalButtons.appendChild(confirmBtn);

                    modalClose.onclick = () => {
                        modal.style.display = "none";
                        resolve(null);
                    };
                    
                    window.onclick = function(event) {
                        if (event.target == modal) {
                            modal.style.display = "none";
                            resolve(null);
                        }
                    }
                    
                    modal.style.display = "flex";
                });
            }

            // TEMP: Placeholder for a simple profanity check (replace with real service later)
            async function checkProfanity(username) {
                // For now, very simple check to prevent common bad words
                const lowerUsername = username.toLowerCase();
                if (lowerUsername.includes('fuck') || lowerUsername.includes('shit') || lowerUsername.includes('cunt')) {
                    return true;
                }
                return false;
            }
        }


        /**
         * NEW: Loads data and adds event listeners for the Privacy tab.
         */
        async function loadPrivacyTab() {
            // 1. Element References
            const panicKeySection = document.getElementById('panicKeySection');
            const panicKeyMessage = document.getElementById('panicKeyMessage');
            const applyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
            const urlChangerSection = document.getElementById('urlChangerSection');
            const modeSelect = document.getElementById('modeSelect');
            const presetGroup = document.getElementById('presetGroup');
            const presetSelect = document.getElementById('presetSelect');
            const customGroup = document.getElementById('customGroup');
            const customTitle = document.getElementById('customTitle');
            const faviconFile = document.getElementById('faviconFile');
            const faviconPreview = document.getElementById('faviconPreview');
            const fetchFaviconBtn = document.getElementById('fetchFaviconBtn');
            const applyUrlChangerBtn = document.getElementById('applyUrlChangerBtn');
            const urlChangerMessage = document.getElementById('urlChangerMessage');


            // --- 2. Load Panic Key Settings ---
            let panicKeySettings = [];
            try {
                panicKeySettings = await getPanicKeySettings();
            } catch (e) {
                console.error("Error loading panic key settings:", e);
                showMessage(panicKeyMessage, 'Error loading panic key settings.', 'error');
            }


            // --- 3. Load URL Changer Settings ---
            const savedUrlSettings = getSavedUrlChangerSetting();
            modeSelect.value = savedUrlSettings.type;
            if (savedUrlSettings.type === 'preset') {
                presetGroup.classList.remove('hidden');
                presetSelect.value = savedUrlSettings.id;
            } else if (savedUrlSettings.type === 'custom') {
                customGroup.classList.remove('hidden');
                customTitle.value = savedUrlSettings.title || '';
                // NEW logic to load saved custom favicon into the preview
                if (savedUrlSettings.favicon) {
                    faviconPreview.src = savedUrlSettings.favicon;
                    faviconPreview.style.display = 'block';
                }
            }


            // --- 4. Add Event Listeners ---

            // Panic Key Input Validation (Whitelist)
            const validKeyRegex = /^[a-z0-9`=\-\[\]\\;',./]$/i; // Valid keys: a-z, 0-9, and ` - = [ ] \ ; ' , . /
            const allKeyInputs = panicKeySection.querySelectorAll('[data-type="key"]');
            allKeyInputs.forEach(input => {
                input.addEventListener('input', () => {
                    const originalValue = input.value;
                    const cleanedValue = originalValue.toLowerCase().replace(/[^a-z0-9`=\-\[\]\\;',./]/g, '');
                    if (originalValue !== cleanedValue) {
                        input.value = cleanedValue.charAt(0); // Ensure only the first valid char remains
                        showMessage(panicKeyMessage, 'Only a-z, 0-9, and symbols ` - = [ ] \\ ; \' , . / are allowed.', 'warning');
                    } else if (originalValue.length > 1) {
                         input.value = originalValue.charAt(0);
                    }
                    
                    // Clear message on valid input
                    if (input.value.length === 1 && validKeyRegex.test(input.value)) {
                         panicKeyMessage.innerHTML = '';
                    }

                    // Re-enable apply button
                    applyPanicKeyBtn.disabled = false;
                });
            });
            
            // Panic Key Input Change (URL input validation is done on apply)
            panicKeySection.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', () => {
                    applyPanicKeyBtn.disabled = false;
                });
            });


            // Panic Key Apply Button Handler
            applyPanicKeyBtn.addEventListener('click', async () => {
                let settingsToSave = [];
                let hasError = false;

                for (let i = 0; i < panicKeySettings.length; i++) {
                    const row = panicKeySection.querySelector(`[data-panic-id="panic-key-${i + 1}"]`);
                    const keyInput = row.querySelector('[data-type="key"]');
                    const urlInput = row.querySelector('[data-type="url"]');
                    
                    let key = keyInput.value.trim().toLowerCase();
                    let url = urlInput.value.trim();
                    const id = `panic-key-${i + 1}`;
                    
                    // Skip if both are empty (allows for gaps)
                    if (!key && !url) continue;

                    // Validation: Must have both key and URL
                    if ((key && !url) || (!key && url)) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} must have both a key and a URL, or neither.`, 'error');
                        hasError = true;
                        break;
                    }

                    // Validation: Key format
                    if (key && !validKeyRegex.test(key)) {
                         showMessage(panicKeyMessage, `Panic Key ${i+1} has an invalid key character.`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // Validation: URL cannot be a relative path.
                    if (url.startsWith('../') || url.startsWith('./') || url.startsWith('/')) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} URL cannot be a relative path.`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // NEW: Prepend https:// if it's missing
                    if (!url.startsWith('https://') && !url.startsWith('http://')) {
                        url = 'https://' + url;
                    }

                    // NEW: Validate URL
                    try {
                        new URL(url); // This will validate "https://google.com" and "https://youtube.com/page.html"
                    } catch (e) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} has an invalid URL. Please enter a valid web address (e.g., google.com).`, 'error');
                        hasError = true;
                        break;
                    }

                    // Add valid setting
                    settingsToSave.push({ id, key, url }); // Push the (potentially modified) URL
                }

                if (hasError) return;

                // Check for duplicate keys
                const filledKeys = settingsToSave.map(s => s.key).filter(k => k);
                if (new Set(filledKeys).size !== filledKeys.length) {
                    showMessage(panicKeyMessage, 'Duplicate panic keys found. Each key must be unique.', 'error');
                    return;
                }


                // Save to IndexedDB
                try {
                    applyPanicKeyBtn.disabled = true;
                    showMessage(panicKeyMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...', 'warning');
                    await savePanicKeySettings(settingsToSave);
                    showMessage(panicKeyMessage, 'Panic key settings saved successfully!', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000);
                } catch (e) {
                    console.error("Error saving panic key settings:", e);
                    showMessage(panicKeyMessage, 'Error saving panic key settings.', 'error');
                    applyPanicKeyBtn.disabled = false;
                }
            });

            // URL Changer Mode Change Handler
            modeSelect.addEventListener('change', () => {
                presetGroup.classList.add('hidden');
                customGroup.classList.add('hidden');
                if (modeSelect.value === 'preset') {
                    presetGroup.classList.remove('hidden');
                } else if (modeSelect.value === 'custom') {
                    customGroup.classList.remove('hidden');
                }
                urlChangerMessage.innerHTML = '';
            });

            // URL Changer File Input Handler (Upload)
            faviconFile.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 50 * 1024) { // Limit to 50KB
                        showMessage(urlChangerMessage, 'Favicon size must be less than 50KB.', 'error');
                        faviconFile.value = ''; // Clear the input
                        faviconPreview.style.display = 'none';
                        faviconPreview.src = '';
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        faviconPreview.src = event.target.result;
                        faviconPreview.style.display = 'block';
                        urlChangerMessage.innerHTML = '';
                    };
                    reader.readAsDataURL(file);
                }
            });

            // URL Changer Fetch Favicon Button Handler
            fetchFaviconBtn.addEventListener('click', async () => {
                const url = customTitle.value.trim();
                if (!url) {
                    showMessage(urlChangerMessage, 'Please enter a URL (e.g., google.com) in the Custom Tab Title field to fetch the favicon.', 'error');
                    return;
                }

                // Temporary message
                showMessage(urlChangerMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Attempting to fetch favicon...', 'warning');
                faviconPreview.style.display = 'none';
                faviconPreview.src = '';

                try {
                    // Check if the input is a valid URL and ensure it has http/https for the API
                    let fullUrl = url;
                    if (!fullUrl.startsWith('http://') && !fullUrl.startsWith('https://')) {
                        fullUrl = 'https://' + fullUrl;
                    }
                    new URL(fullUrl); // Validate format

                    // This is where the actual favicon fetching logic would go, which needs a backend service.
                    // For a client-side environment without CORS, we use the Google service as a common fallback.
                    const faviconUrl = `https://www.google.com/s2/favicons?domain=${encodeURIComponent(url)}&sz=64`;
                    
                    // Use a simple fetch to see if the image loads
                    const response = await fetch(faviconUrl, { mode: 'cors' });
                    if (!response.ok || response.headers.get("content-type").indexOf("image") === -1) {
                         throw new Error("Favicon not found or blocked.");
                    }

                    // Set the image source
                    faviconPreview.src = faviconUrl;
                    faviconPreview.style.display = 'block';
                    showMessage(urlChangerMessage, 'Favicon fetched successfully! Click Apply Tab to save.', 'success');

                } catch (e) {
                    console.error("Favicon fetch failed:", e);
                    showMessage(urlChangerMessage, 'Failed to fetch favicon. Please try a different URL or upload a file.', 'error');
                    faviconPreview.style.display = 'none';
                    faviconPreview.src = '';
                }
            });


            // URL Changer Apply Button Handler
            applyUrlChangerBtn.addEventListener('click', () => {
                const mode = modeSelect.value;
                let settingsToSave = null;
                urlChangerMessage.innerHTML = '';

                if (mode === 'none') {
                    settingsToSave = { type: 'none' };
                } else if (mode === 'preset') {
                    const presetId = presetSelect.value;
                    if (!presetId) {
                        showMessage(urlChangerMessage, 'Please select a preset.', 'error');
                        return;
                    }
                    settingsToSave = { type: 'preset', id: presetId };
                } else if (mode === 'custom') {
                    const title = customTitle.value.trim();
                    // NEW: Get favicon from preview image
                    const favicon = (faviconPreview.src && faviconPreview.style.display !== 'none') ? faviconPreview.src : '';

                    if (!title && !favicon) { // Check against new favicon variable
                        showMessage(urlChangerMessage, 'Please provide at least a custom title or fetch a favicon.', 'error'); // Update message
                        return;
                    }

                    settingsToSave = { type: 'custom', title: title, favicon: favicon }; // Use new favicon variable
                }

                // Save to localStorage
                if (saveUrlChangerSetting(settingsToSave)) {
                    showMessage(urlChangerMessage, 'Tab Disguise settings saved! They will be applied on the next page you load.', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(urlChangerMessage, 'An error occurred while saving.', 'error');
                }
            });
        }


        /**
         * NEW: Loads data and adds event listeners for the Personalization tab.
         */
        async function loadPersonalizationTab() {
            const themePickerContainer = document.getElementById('theme-picker-container');
            const themeMessage = document.getElementById('themeMessage');
            if (!themePickerContainer) return;

            // From navigation.js
            const lightThemeNames = ['Light', 'Lavender', 'Rose Gold', 'Mint'];
            const savedThemeName = localStorage.getItem(THEME_STORAGE_KEY) || 'Dark';

            try {
                // 1. Fetch themes
                const response = await fetch('../themes.json');
                if (!response.ok) throw new Error('Failed to load themes.json');
                const themes = await response.json();

                // 2. Generate HTML buttons
                let themeButtonsHtml = '';
                for (const theme of themes) {
                    const isActive = theme.name === savedThemeName;

                    // === MODIFICATION START: Inline Styles for Preview ===
                    // Use CSS variables defined in the theme object for a preview
                    const previewBg = theme['--background-color'] || '#070707'; 
                    // Determine text color based on if it's a light theme
                    const isLightTheme = lightThemeNames.includes(theme.name);
                    const previewText = isLightTheme ? '#1a1a1a' : '#e0e0e0'; 
                    // Get the theme's accent border color
                    const previewBorder = theme['tab-active-border'] || '#4f46e5';

                    themeButtonsHtml += `
                        <button class="theme-button ${isActive ? 'active' : ''}" data-theme-name="${theme.name}" style="background-color: ${previewBg}; border-color: ${previewBorder};" >
                            <div class="theme-button-name" style="color: ${previewText};">${theme.name}</div>
                        </button>
                    `;
                    // === MODIFICATION END ===
                }

                // Inject buttons into the DOM
                themePickerContainer.innerHTML = themeButtonsHtml;

                // 4. Add event listeners
                const themeButtons = themePickerContainer.querySelectorAll('.theme-button');
                themeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const themeName = button.dataset.themeName;

                        // 1. Save to localStorage
                        localStorage.setItem(THEME_STORAGE_KEY, themeName);
                        
                        // 2. Update the navbar (via navigation.js function, which should exist)
                        if (typeof window.applyThemeToNavbar === 'function') {
                            window.applyThemeToNavbar(themeName);
                        } else {
                            console.warn('applyThemeToNavbar function not found.');
                        }

                        // 3. Update button active state
                        themeButtons.forEach(b => b.classList.remove('active'));
                        button.classList.add('active');

                        showMessage(themeMessage, `Theme set to ${themeName}!`, 'success');
                    });
                });

            } catch (error) {
                console.error("Error loading personalization tab:", error);
                themePickerContainer.innerHTML = `<p class="error-message">Failed to load themes. Please try again later.</p>`;
            }
        }


        /**
         * NEW: Loads data and adds event listeners for the Data Management tab.
         */
        async function loadDataManagementTab() {
            const downloadSavesBtn = document.getElementById('downloadSavesBtn');
            const uploadSavesBtn = document.getElementById('uploadSavesBtn');
            const deleteAllDataBtn = document.getElementById('deleteAllDataBtn');
            
            // 2. Add Listeners
            downloadSavesBtn.addEventListener('click', downloadAllSaves);
            uploadSavesBtn.addEventListener('click', handleFileUpload);
            deleteAllDataBtn.addEventListener('click', deleteAllLocalData);
        }

        // --- Tab Content Mapping (For "Coming Soon" tabs) ---
        const tabContent = {
            // 'general': { title: 'General' }, // Handled separately
            // 'privacy': { title: 'Privacy & Security' }, // Handled separately
            // 'personalization': { title: 'Personalization' }, // Handled separately
            // 'data': { title: 'Data Management' }, // Handled separately
            // 'about': { title: 'About 4SP' }, // Handled separately
            'premium': { title: 'Premium' },
        };

        // --- Main Tab Switching Logic ---
        async function switchTab(tabId) {
            // 1. Update active classes on sidebar
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });

            // 2. Inject content
            if (tabId === 'general') {
                await loadGeneralTab();
            } else if (tabId === 'privacy') {
                // Must ensure getPanicKeySettings is available globally or imported
                // It is defined in ../panic-key.js which is loaded as a script tag
                // Assuming getPanicKeySettings is a global function from panic-key.js
                const { getPanicKeySettings, getSavedUrlChangerSetting, saveUrlChangerSetting } = window;
                if (!getPanicKeySettings) {
                    mainView.innerHTML = `<p class="error-message">Error: Panic Key functions not loaded.</p>`;
                    return;
                }
                mainView.innerHTML = getPrivacyContent(await getPanicKeySettings());
                await loadPrivacyTab(); // Load data and add listeners
            } else if (tabId === 'personalization') {
                mainView.innerHTML = getPersonalizationContent(); // Render HTML
                await loadPersonalizationTab(); // Load data and add listeners
            } else if (tabId === 'data') {
                mainView.innerHTML = getDataManagementContent();
                await loadDataManagementTab();
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // FIX: Remove setTimeout to prevent race condition on session load.
        initializeAuth();
    </script>
</body>
</html>

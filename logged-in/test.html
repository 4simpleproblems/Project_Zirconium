<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        
        .btn-toolbar-style {
            background: var(--menu-bg, #0000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: var(--menu-bg, #000000);
            border-color: var(--menu-border, #fff);
            color: var(--tab-hover-text, #ffffff);
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* Full Width button override for general settings */
            width: 100%; 
            justify-content: center;
            
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .settings-tab.active:hover {
             background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        /* NEW: Main Settings Container - Takes all remaining height */
        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            /* Added min-height to ensure it respects the full viewport minus header */
            min-height: calc(100vh - 4rem - 40px); 
        }

        /* NEW: Sidebar Styling - MADE STICKY */
        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            /* New properties for sticky behavior */
            position: sticky; 
            top: 4.5rem; /* Increased from 1rem to 4.5rem to clear the injected navigation bar */
            align-self: flex-start; /* Important for sticky behavior inside a flex container */
        }

        /* MODIFIED: Main View Styling */
        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        /* MODIFIED: About Section specific styles - REMOVED max-width */
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        /* Grouping container for social links - styling is minimal now */
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        
        /* Grouping container for legal links - styling is minimal now */
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            /* Removed max-width to allow w-full inside the max-w-xl parent */
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="loading-screen" class="fixed inset-0 bg-[#070707] flex items-center justify-center z-50">
        <i class="fa-duotone fa-spinner fa-spin fa-2x"></i>
    </div>

    <div id="page-content" class="hidden">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // **IMPORTANT NOTE**: The external import for firebase-config.js was kept here from the
        // file you provided, but remember this line may cause a 404 error if that file is not
        // in the correct relative path. 
        import { firebaseConfig } from "../firebase-config.js"; 

        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object

        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            element.innerHTML = text;
            element.className = `general-message-area text-sm ${type}-message`;
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            // New function, similar to the one in authentication.html
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };


        /**
         * Generates the HTML for the "General Settings" section, including Username Change.
         * MODIFIED to include currentMonthName and new UI styles.
         */
        function getGeneralContent(currentUsername, changesRemaining, currentMonthName) {
             const MAX_CHANGES = 3;
             const changesUsed = MAX_CHANGES - changesRemaining;
             const isDisabled = changesRemaining <= 0;
             const buttonText = isDisabled ? 'Limit Reached' : 'Change Username';
             
             return `
                 <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                 
                 <div class="w-full max-w-xl">
                    <h3 class="text-xl font-bold text-white mb-2">Account Username</h3>
                    <p class="text-lg text-gray-400 leading-relaxed mb-4">
                        Your current 4SP username is: <span class="text-emphasis text-blue-400">${currentUsername}</span>
                    </p>

                    <div class="flex justify-between items-center mb-4 p-3 rounded-lg border border-yellow-800/20 bg-yellow-900/10">
                        <p class="text-sm font-light text-gray-300">
                           <i class="fa-solid fa-calendar-alt mr-2 text-yellow-500"></i>
                           Username change limit for:
                           <span class="text-emphasis text-yellow-300">${currentMonthName}</span>
                        </p>
                        <span class="text-lg font-semibold ${changesRemaining > 0 ? 'text-green-400' : 'text-red-400'}">
                            ${changesUsed}/${MAX_CHANGES} used
                        </span>
                    </div>
                    
                    <form id="usernameChangeForm" novalidate class="flex flex-col gap-4"> 
                        <div class="w-full">
                            <label for="newUsername" class="block mb-2 text-gray-400 text-sm font-light">New Username</label>
                            <input type="text" id="newUsername" placeholder="4-24 characters, only allowed symbols" required 
                                class="input-text-style w-full" ${isDisabled ? 'disabled' : ''}>
                            <p class="text-xs text-gray-500 mt-2 font-light">
                                Allowed symbols: .,-+\\_!?$
                            </p>
                        </div>
                        
                        <div id="usernameChangeMessage" class="general-message-area text-sm"></div>

                        <button type="submit" id="changeUsernameBtn" 
                            class="py-3 text-lg rounded-lg font-normal transition 
                            ${isDisabled ? 'ring-1 ring-gray-600 text-gray-600 bg-gray-900/50 cursor-not-allowed' : 'btn-primary-override'}"
                            ${isDisabled ? 'disabled' : ''}>
                            <i class="fa-solid fa-user-pen mr-2"></i> 
                            ${buttonText}
                        </button>
                    </form>
                 </div>
             `;
         }


        /**
         * Generates the HTML for the "About 4SP" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-4">About 4SP (4simpleproblems)</h2>
                
                <div class="about-section-content">
                    <p class="text-lg text-gray-400 leading-relaxed">
                        <span class="text-emphasis">4SP (4simpleproblems)</span> is a <span class="text-emphasis">Student Toolkit and Entertainment website</span> designed to boost student productivity and provide useful resources. We aim to solve four core challenges that students face every day by integrating essential tools and engaging digital content into one seamless platform.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">The Four Simple Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>

                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">Version</h3>
                    <p class="text-gray-400">
                        Current Version: <span class="text-blue-400 text-emphasis">5.0 Beta 9</span>
                    </p>

                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Connect & Support</h3>
                    <div class="social-link-group">
                        <a href="https://www.youtube.com/@4simpleproblems" target="_blank" class="btn-toolbar-style" title="YouTube">
                            <i class="fa-brands fa-youtube fa-lg mr-2"></i> YouTube
                        </a>
                        <a href="https://x.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="X (Twitter)">
                            <i class="fa-brands fa-x-twitter fa-lg mr-2"></i>X
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="Buy Me a Coffee">
                            <i class="fa-solid fa-mug-hot fa-lg mr-2"></i> Buy Me a Coffee
                        </a>
                        <a href="https://github.com/v5-4simpleproblems" target="_blank" class="btn-toolbar-style" title="GitHub">
                            <i class="fa-brands fa-github fa-lg mr-2"></i> Github
                        </a>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Legal Information</h3>
                    <div class="legal-buttons">
                        <a href="../legal.html#terms-of-service" class="btn-toolbar-style">Terms of Service</a>
                        <a href="../legal.html#privacy-policy" class="btn-toolbar-style">Privacy Policy</a>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "Coming Soon" sections.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-2">${title}</h2>
                <div style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
                    <p class="text-xl text-gray-500 italic">...Coming Soon...</p>
                    <i class="fa-solid fa-hourglass-start fa-5x text-gray-700 mt-4"></i>
                </div>
            `;
        }


        /**
         * Loads user data, checks rate limit, and renders the General tab.
         * MODIFIED to get the current month name.
         */
        async function loadGeneralTab() {
            if (!currentUser) return; // Should not happen if auth check passes

            const userDocRef = getUserDocRef(currentUser.uid);
            let userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                mainView.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">General Settings</h2><p class="text-red-400">Error: User data not found. Please log out and back in.</p>`;
                return;
            }

            let userData = userDocSnap.data();
            const today = new Date();
            const currentMonthNumber = today.getMonth() + 1; // 1-12
            const currentMonthName = today.toLocaleDateString('en-US', { month: 'long' }); // e.g., "November"
            const MAX_CHANGES = 3;

            let changesThisMonth = userData.usernameChangesThisMonth || 0;
            let lastChangeMonth = userData.lastUsernameChangeMonth || 0;

            // --- Monthly Reset Logic ---
            if (currentMonthNumber !== lastChangeMonth) {
                // It's a new month, reset the counter
                changesThisMonth = 0;
                await updateDoc(userDocRef, {
                    usernameChangesThisMonth: 0,
                    lastUsernameChangeMonth: currentMonthNumber
                });
                // Re-fetch or update data structure after reset
                userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.data(); 
            }
            
            const changesRemaining = MAX_CHANGES - changesThisMonth;

            // 1. Render the General Content - PASS THE MONTH NAME
            mainView.innerHTML = getGeneralContent(userData.username, changesRemaining, currentMonthName);
            
            // 2. Attach Event Listener for Username Change
            const usernameChangeForm = document.getElementById('usernameChangeForm');
            const messageElement = document.getElementById('usernameChangeMessage');
            
            if (usernameChangeForm && changesRemaining > 0) {
                usernameChangeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newUsername = document.getElementById('newUsername').value.trim();
                    const changeBtn = document.getElementById('changeUsernameBtn');
                    
                    changeBtn.disabled = true;
                    showMessage(messageElement, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Processing...', 'warning');

                    try {
                        // --- Validation ---
                        if (newUsername === userData.username) { 
                            showMessage(messageElement, 'New username is the same as your current username.', 'warning');
                            return;
                        }
                        if (newUsername.length < 4 || newUsername.length > 24) { 
                            showMessage(messageElement, 'Username must be 4-24 characters.', 'error'); 
                            return; 
                        }
                        if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) { 
                            showMessage(messageElement, 'Username contains invalid characters (Allowed symbols: .,-+\\_!?$).', 'error'); 
                            return; 
                        }
                        
                        // --- Checks ---
                        if (await checkProfanity(newUsername)) { 
                            showMessage(messageElement, 'This username is not allowed.', 'error'); 
                            return; 
                        }
                        if (await isUsernameTaken(newUsername)) { 
                            showMessage(messageElement, 'This username is already taken.', 'error'); 
                            return; 
                        }
                        
                        // --- Update Logic ---
                        const newChangesCount = changesThisMonth + 1;
                        await updateDoc(userDocRef, {
                            username: newUsername,
                            usernameChangesThisMonth: newChangesCount,
                            lastUsernameChangeMonth: currentMonthNumber // Ensure month is current even if it was reset
                        });

                        showMessage(messageElement, `Username successfully changed to ${newUsername}!`, 'success');
                        
                        // Re-render the tab content to update the display and counter
                        // A short delay before re-load gives the user time to read the success message
                        setTimeout(() => { switchTab('general'); }, 1500);

                    } catch (error) {
                        console.error("Error updating username:", error);
                        showMessage(messageElement, `An unexpected error occurred: ${error.message}`, 'error');
                    } finally {
                        // The button will be re-enabled/disabled by the re-render in the success path
                        // If there was an error, re-enable it immediately for the user to try again
                        if (messageElement.innerHTML.includes('Error') || messageElement.innerHTML.includes('not allowed') || messageElement.innerHTML.includes('taken')) {
                            changeBtn.disabled = false;
                        }
                    }
                });
            }
        }


        /**
         * Handles the switching of tabs and updating the main content view.
         */
        async function switchTab(tabId) {
            // 1. Update active class on sidebar tabs
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // 2. Update the main view content and alignment
            mainView.style.justifyContent = 'flex-start';
            mainView.style.alignItems = 'flex-start';

            if (tabId === 'general') {
                // NEW: Call the function that handles data fetching and rendering for General
                await loadGeneralTab(); 
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                // Must be async to handle data fetching for 'general' tab
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---\
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');

        function initializeAuth() {
            // onAuthStateChanged is the standard Firebase way to check login status
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to index (login page)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; // Store the user object globally
                    loadingScreen.style.display = 'none';
                    pageContent.classList.remove('hidden');
                    pageContent.style.display = 'flex';
                    
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

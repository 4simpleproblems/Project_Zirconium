<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - Settings</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <!-- Fonts, Icons, and Tailwind CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- navigation.js and injector.js must be loaded here if they are external files -->
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
        }
        .dark { color-scheme: dark; }

        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #777; }

        /* Custom active state for sidebar items */
        .sidebar-item {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background-color: #1a1a1a;
        }
        .sidebar-item.active {
            background-color: #1f2937; /* Tailwind gray-800 */
            border-left: 4px solid #4f46e5; /* Tailwind indigo-600 */
            color: #ffffff;
        }
        
        /* Utility class for visually distinct labels */
        .label-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: 500;
            font-size: 0.875rem;
            color: #e0e0e0;
            background-color: #1f2937; /* default gray background */
            border: 1px solid #374151; /* default gray border */
        }
        
        /* Styles for the loading overlay */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(7, 7, 7, 0.9);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

    </style>
</head>
<body class="min-h-screen">
    <!-- Navigation Bar will be injected here by navigation.js -->
    
    <div id="loading-overlay" class="text-white">
        <i class="fas fa-spinner fa-spin text-4xl mb-4 text-indigo-500"></i>
        <p>Loading user settings...</p>
    </div>

    <main id="settings-content" class="container mx-auto p-4 md:p-8 pt-24 hidden">
        <h1 class="text-3xl md:text-4xl font-extrabold mb-8 text-white tracking-tight">Application Settings</h1>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar Navigation -->
            <div id="sidebar-container" class="lg:w-1/4 bg-gray-900 rounded-xl shadow-2xl p-4 h-fit sticky top-24">
                <!-- Sidebar items will be dynamically added here -->
            </div>

            <!-- Settings Panel -->
            <div id="panel-container" class="lg:w-3/4">
                <div id="panel-header" class="mb-6 pb-4 border-b border-gray-800">
                    <h2 id="panel-title" class="text-3xl font-bold text-white"></h2>
                </div>
                <div id="panel-content">
                    <!-- Section-specific content will be loaded here -->
                </div>
            </div>
        </div>
    </main>

    <!-- Firebase Imports and Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- GLOBAL SETUP ---
        setLogLevel('debug');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null;
        let isAuthReady = false;
        
        // Default labels for demonstration purposes
        let currentLabels = []; 
        let pendingLabelChanges = false; 

        const sections = [
            { id: 'profile', title: 'Profile Information', icon: 'fa-user-circle', content: 'Manage your personal details, name, and profile picture.', color: 'text-blue-400' },
            { id: 'security', title: 'Security & Authentication', icon: 'fa-shield-alt', content: 'Change your password, enable two-factor authentication, and view active sessions.', color: 'text-red-400' },
            { id: 'notifications', title: 'Notification Preferences', icon: 'fa-bell', content: 'Customize how and when you receive alerts and email updates.', color: 'text-yellow-400' },
            { id: 'labels', title: 'Custom Labels', icon: 'fa-tags', content: 'Define and manage custom labels for organizing your data.', color: 'text-green-400' },
            { id: 'advanced', title: 'Advanced Settings', icon: 'fa-cogs', content: 'Configure system-wide and experimental settings.', color: 'text-purple-400' },
        ];

        // --- FIREBASE INITIALIZATION & AUTH ---

        async function initFirebaseAndAuth() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Listener to track auth state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Authenticated with user ID:", userId);
                    } else {
                        // For this application, we expect a user object from the token or anonymous sign-in
                        console.log("Authentication state changed: User is null.");
                        userId = crypto.randomUUID(); // Fallback to a random ID
                    }
                    isAuthReady = true;
                    // Proceed to app logic once auth is ready
                    setupApp(); 
                });

            } catch (error) {
                console.error("Firebase Initialization or Authentication Error:", error);
            }
        }
        
        /**
         * Fetches initial data (like labels) from Firestore.
         */
        async function fetchInitialData() {
            if (!db || !userId) {
                console.error("Database or User ID not initialized.");
                return;
            }

            const dataPath = `/artifacts/${appId}/users/${userId}/app_settings/config`;
            const docRef = doc(db, dataPath);

            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Deserialize labels from JSON string if necessary, or assume array/default
                    currentLabels = data.labels || [];
                    console.log("Initial labels loaded:", currentLabels);
                } else {
                    console.log("Settings document not found. Using default labels.");
                    // Initialize with some default placeholder labels if none exist
                    currentLabels = ['Urgent', 'Low Priority', 'In Review'];
                }
            } catch (e) {
                console.error("Error loading initial data:", e);
                // Fallback to defaults on error
                currentLabels = ['Urgent', 'Low Priority', 'In Review'];
            }
        }
        
        /**
         * Saves the currentLabels array to Firestore.
         */
        async function saveLabelsToFirestore() {
            if (!db || !userId) {
                console.error("Cannot save: Database or User ID not initialized.");
                return;
            }

            const saveButton = document.getElementById('saveLabelsButton');
            if(saveButton) {
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
                saveButton.disabled = true;
            }
            
            const dataPath = `/artifacts/${appId}/users/${userId}/app_settings/config`;
            const docRef = doc(db, dataPath);

            try {
                // Prepare data for storage
                const dataToSave = { 
                    labels: currentLabels 
                };
                
                // Use setDoc with merge: true to avoid overwriting other settings
                await setDoc(docRef, dataToSave, { merge: true });

                console.log("Labels saved successfully.");
                pendingLabelChanges = false;
                
                const messageEl = document.getElementById('labelsSaveMessage');
                if (messageEl) {
                    messageEl.textContent = 'Labels saved successfully!';
                    messageEl.classList.remove('text-orange-400', 'hidden');
                    messageEl.classList.add('text-green-400');
                    setTimeout(() => {
                        messageEl.classList.add('hidden');
                        messageEl.classList.remove('text-green-400');
                    }, 3000);
                }

            } catch (e) {
                console.error("Error saving labels:", e);
                const messageEl = document.getElementById('labelsSaveMessage');
                if (messageEl) {
                    messageEl.textContent = 'Error saving labels: ' + e.message;
                    messageEl.classList.remove('text-orange-400', 'hidden');
                    messageEl.classList.add('text-red-400');
                }
            } finally {
                if(saveButton) {
                    saveButton.innerHTML = '<i class="fas fa-save mr-2"></i> Save All Labels Changes';
                    saveButton.disabled = false;
                }
            }
        }


        // --- UI RENDERING FUNCTIONS ---

        function setupSidebar() {
            const sidebarContainer = document.getElementById('sidebar-container');
            sidebarContainer.innerHTML = '';
            
            sections.forEach((section) => {
                const item = document.createElement('div');
                item.className = 'sidebar-item flex items-center p-3 rounded-lg text-gray-400 hover:text-white';
                item.id = `sidebar-${section.id}`;
                item.innerHTML = `<i class="fas ${section.icon} mr-3 ${section.color}"></i> ${section.title}`;
                item.addEventListener('click', () => displaySection(section.id));
                sidebarContainer.appendChild(item);
            });

            // Display the first section by default
            if (sections.length > 0) {
                displaySection(sections[0].id);
            }
        }
        
        /**
         * Renders the list of currentLabels in the Labels section UI.
         */
        function renderLabels() {
            const container = document.getElementById('existingLabelsContainer');
            if (!container) return;

            container.innerHTML = '';
            if (currentLabels.length === 0) {
                 container.innerHTML = '<p class="text-gray-500 italic">No custom labels defined yet. Add one above!</p>';
                 return;
            }

            currentLabels.forEach((label, index) => {
                // Simple hash function for consistent (but random-looking) colors
                const hashColor = (str) => {
                    let hash = 0;
                    for (let i = 0; i < str.length; i++) {
                        hash = str.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    // Select from a predefined set of Tailwind color classes for aesthetics
                    const colors = [
                        { text: 'text-purple-300', bg: 'bg-purple-900/30' },
                        { text: 'text-green-300', bg: 'bg-green-900/30' },
                        { text: 'text-blue-300', bg: 'bg-blue-900/30' },
                        { text: 'text-yellow-300', bg: 'bg-yellow-900/30' },
                        { text: 'text-pink-300', bg: 'bg-pink-900/30' }
                    ];
                    return colors[Math.abs(hash) % colors.length];
                };

                const color = hashColor(label);
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'flex justify-between items-center p-3 bg-gray-800 rounded-lg border border-gray-700 hover:border-indigo-600 transition duration-150';
                labelDiv.innerHTML = `
                    <span class="text-sm font-medium ${color.text} ${color.bg} px-3 py-1 rounded-full shadow-inner">${label}</span>
                    <button data-label="${label}" class="remove-label-btn text-red-400 hover:text-red-500 transition-colors duration-150 p-1 rounded-full hover:bg-red-900/20" title="Remove label">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                container.appendChild(labelDiv);
            });

            // Attach listeners to remove buttons
            document.querySelectorAll('.remove-label-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const labelToRemove = e.currentTarget.getAttribute('data-label');
                    currentLabels = currentLabels.filter(label => label !== labelToRemove);
                    pendingLabelChanges = true;
                    renderLabels(); // Re-render the list
                });
            });
        }

        /**
         * Handles content rendering and event setup for the selected section.
         */
        function displaySection(sectionId) {
            const section = sections.find(s => s.id === sectionId);
            if (!section) return;

            const panelTitle = document.getElementById('panel-title');
            const panelContent = document.getElementById('panel-content');
            
            panelTitle.innerHTML = `<i class="fas ${section.icon} mr-2 ${section.color}"></i> ${section.title}`;

            let htmlContent = '';

            if (sectionId === 'labels') {
                // --- CUSTOM CONTENT FOR LABELS SECTION ---
                htmlContent = `
                    <div class="flex flex-col space-y-6">
                        <p class="text-lg text-gray-400">${section.content}</p>

                        <!-- Label Management Form -->
                        <div class="p-6 rounded-xl bg-gray-900 border border-indigo-500/20 shadow-xl">
                            <h3 class="text-xl font-semibold mb-4 text-white flex items-center">
                                <i class="fas fa-plus-circle mr-3 text-indigo-400"></i> Add New Label
                            </h3>
                            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                                <input type="text" id="newLabelInput" placeholder="Enter new label name (max 30 characters)"
                                       class="flex-grow p-3 bg-gray-800 text-white rounded-lg border border-gray-700 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition duration-150"
                                       maxlength="30">
                                <button id="addLabelButton"
                                        class="bg-indigo-600 hover:bg-indigo-500 text-white font-medium py-3 px-5 rounded-lg shadow-md transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-plus mr-2"></i> Add
                                </button>
                            </div>
                        </div>

                        <!-- Existing Labels List -->
                        <div class="p-6 rounded-xl bg-gray-900 border border-gray-700">
                            <h3 class="text-xl font-semibold mb-4 text-white flex items-center">
                                <i class="fas fa-list-ul mr-3 text-gray-400"></i> Existing Labels
                            </h3>
                            <div id="existingLabelsContainer" class="space-y-3">
                                <!-- Labels will be rendered here by JavaScript -->
                            </div>
                            <p id="labelsSaveMessage" class="text-sm mt-4 text-orange-400 hidden">You have unsaved changes!</p>
                        </div>
                        
                        <button id="saveLabelsButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg shadow-lg transition-all duration-200 mt-4 self-start flex items-center">
                            <i class="fas fa-save mr-2"></i> Save All Labels Changes
                        </button>
                    </div>
                `;
            } else {
                // --- GENERIC CONTENT FOR ALL OTHER SECTIONS ---
                htmlContent = `
                    <div class="flex flex-col space-y-4">
                        <p class="text-lg text-gray-400">${section.content}</p>
                        <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                            <h3 class="text-xl font-semibold mb-2 text-white">Section Details</h3>
                            <p class="text-sm text-gray-500">
                                This is where the detailed controls, forms, and toggles for the 
                                ${section.title} section would be implemented. 
                                <i class="fas fa-magic text-purple-400 ml-1"></i>
                            </p>
                        </div>
                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-3 px-6 rounded-lg shadow-lg transition-all duration-200 mt-4 self-start flex items-center">
                            <i class="fas fa-save mr-2"></i> Save Changes
                        </button>
                    </div>
                `;
            }

            panelContent.innerHTML = htmlContent;

            // 1. Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sidebar-${sectionId}`).classList.add('active');


            // 2. Setup dynamic functionality for the LABELS section
            if (sectionId === 'labels') {
                renderLabels(); // Initial render of the existing labels

                const input = document.getElementById('newLabelInput');
                const addButton = document.getElementById('addLabelButton');
                const saveButton = document.getElementById('saveLabelsButton');
                const messageEl = document.getElementById('labelsSaveMessage');
                
                // Function to add a label
                const addLabel = () => {
                    const newLabel = input.value.trim();
                    if (newLabel && newLabel.length <= 30 && !currentLabels.includes(newLabel)) {
                        currentLabels.push(newLabel);
                        input.value = '';
                        pendingLabelChanges = true;
                        messageEl.classList.remove('hidden', 'text-green-400', 'text-red-400');
                        messageEl.classList.add('text-orange-400');
                        messageEl.textContent = 'You have unsaved changes!';
                        renderLabels();
                    } else if (currentLabels.includes(newLabel)) {
                        console.warn("Label already exists.");
                    } else if (!newLabel) {
                        console.warn("Label cannot be empty.");
                    }
                };

                // Event listener for the Add button
                addButton.addEventListener('click', addLabel);
                
                // Event listener for 'Enter' key press in the input
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent form submission if it were a form
                        addLabel();
                    }
                });

                // Event listener for the Save button
                saveButton.addEventListener('click', saveLabelsToFirestore);
            }
        }
        
        // --- START APPLICATION FLOW ---

        async function setupApp() {
            // 1. Fetch data (including labels)
            await fetchInitialData(); 
            // 2. Setup UI
            setupSidebar();
            // 3. Hide loading overlay and show content
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('settings-content').classList.remove('hidden');
        }

        // Initialize Firebase and start the process
        initFirebaseAndAuth();

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js" defer></script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p id="loadingText">Loading...</p>
    </div>
    
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider, 
            reauthenticateWithCredential, 
            updatePassword,
            // NEW AUTH IMPORTS
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            reauthenticateWithPopup,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            deleteDoc // NEW FIREBASE IMPORT
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config (Assumed to exist in a relative file) ---
        import { firebaseConfig } from "../firebase-config.js"; 
        
        // --- NEW: Import Site Mapping (from index.html logic) ---
        // This file MUST exist at ../site-mapping.js for import/export to work
        import { siteMapping } from "../site-mapping.js";


        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object
        
        // --- NEW: Global var for loading overlay (from index.html) ---
        let loadingTimeout = null;
        
        // Constants for validation and limits
        const MIN_LENGTH = 6; 
        const MAX_LENGTH = 24;
        const MAX_CHANGES = 5; 


        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // Constants for providers (NEW)
        const PROVIDER_CONFIG = {
            'google.com': { 
                name: 'Google', 
                icon: '../images/google-icon.png', 
                instance: () => new GoogleAuthProvider() 
            },
            'github.com': { 
                name: 'GitHub', 
                icon: '../images/github-mark-white.png', 
                instance: () => new GithubAuthProvider() 
            },
            'microsoft.com': { 
                name: 'Microsoft', 
                icon: '../images/microsoft.png', 
                instance: () => new OAuthProvider('microsoft.com') 
            },
            'password': { 
                name: 'Email & Password', 
                icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', 
                isCredential: true
            }
        };

        // --- NEW: Constants for Privacy Settings ---
        
        // IndexedDB Config for Panic Key
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';
        
        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';


        // Presets copied from url-changer.js
        const urlChangerPresets = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'gmm', name: 'GMM', title: 'Get More Math!', favicon: '../favicons/gmm.png', category: 'websites' },
            { id: 'kahoot', name: 'Kahoot', title: 'Kahoot! | Learning games | Make learning awesome!', favicon: '../favicons/kahoot.png', category: 'websites' },
            { id: 'g_classroom', name: 'Google Classroom', title: 'Home', favicon: '../favicons/google-classroom.png', category: 'websites' },
            { id: 'g_docs', name: 'Google Docs', title: 'Google Docs', favicon: '../favicons/google-docs.png', category: 'websites' },
            { id: 'g_slides', name: 'Google Slides', title: 'Google Slides', favicon: '../favicons/google-slides.png', category: 'websites' },
            { id: 'g_drive', name: 'Google Drive', title: 'Home - Google Drive', favicon: '../favicons/google-drive.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'clever', name: 'Clever', title: 'Clever | Connect every student to a world of learning', favicon: '../favicons/clever.png', category: 'websites' },
            { id: '_LIVE_CURRENT_TIME', name: 'Current Time', title: 'Live Time', favicon: '', category: 'live', live: true }
        ];

        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            // Prevent clearing a success message if a warning is generated elsewhere
            if (element && element.innerHTML.includes('success') && type !== 'error') return;
            if (element) {
                element.innerHTML = text;
                element.className = `general-message-area text-sm ${type}-message`;
            }
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };
        
        // --- NEW: IndexedDB Helper Functions ---

        /**
         * Opens the IndexedDB and creates the object store if needed.
         */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        /**
         * Fetches all panic key settings from IndexedDB.
         */
        async function getPanicKeySettings() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const settingsMap = new Map(request.result.map(item => [item.id, item]));
                    db.close();
                    resolve(settingsMap);
                };
                request.onerror = () => {
                     db.close();
                    reject(request.error);
                };
            });
        }
        
        /**
         * Saves panic key settings to IndexedDB.
         */
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                let completed = 0;
                const total = settingsArray.length;

                settingsArray.forEach(setting => {
                    const request = store.put(setting);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = () => {
                         db.close();
                        reject(request.error); // Stop on first error
                    };
                });
                
                // Handle case where array is empty
                if (total === 0) {
                     db.close();
                    resolve();
                }
            });
        }

        // --- NEW: localStorage Helper Functions ---
        
        function getSavedUrlChangerSetting() {
            const savedSettingsJSON = localStorage.getItem(URL_CHANGER_KEY);
            let savedSettings = { type: 'none' };
            if (savedSettingsJSON) {
                try { 
                    savedSettings = JSON.parse(savedSettingsJSON); 
                } catch (e) { 
                    console.error("Failed to parse saved tab settings, reverting to default.", e); 
                }
            }
            return savedSettings;
        }

        function saveUrlChangerSetting(settings) {
            try {
                localStorage.setItem(URL_CHANGER_KEY, JSON.stringify(settings));
                return true;
            } catch (e) {
                console.error("Failed to save URL changer settings:", e);
                return false;
            }
        }
        
        // --- NEW: Modal and Loading Functions (from index.html) ---
        
        function openModal(text, buttons = []) {
            const modal = document.getElementById('modalPrompt');
            const modalText = document.getElementById('modalText');
            const modalButtons = document.getElementById('modalButtons');
            
            modalText.textContent = text;
            modalButtons.innerHTML = "";
            buttons.forEach(btn => {
                const buttonEl = document.createElement("button");
                // MODIFICATION: Use settings page button styles
                buttonEl.className = "btn-toolbar-style";
                if (btn.text.toLowerCase() === 'yes') {
                    buttonEl.classList.add('btn-primary-override-danger'); // Make 'Yes' destructive
                } else {
                    buttonEl.classList.add('btn-primary-override');
                }
                buttonEl.textContent = btn.text;
                buttonEl.onclick = btn.onclick;
                modalButtons.appendChild(buttonEl);
            });
            modal.style.display = "flex";
        }
        
        function showLoading(text = "Loading...") {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000); // 5 second timeout
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }
        
        // --- NEW: Core Data Functions (from index.html) ---
        
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Skip theme key
                if (key === THEME_STORAGE_KEY) continue;
                // Skip URL changer key
                if (key === URL_CHANGER_KEY) continue;
                
                const value = localStorage.getItem(key);
                data[key] = value;
            }
            return data;
        }

        function setAllLocalStorageData(data) {
            // Don't clear *everything*, just the keys in the data
            // This avoids wiping the user's theme setting
            for (const [key, value] of Object.entries(data)) {
                localStorage.setItem(key, value);
            }
        }

        async function getAllIndexedDBData() {
            if (!indexedDB.databases) return {};
            let dbList = [];
            try {
                dbList = await indexedDB.databases();
            } catch (error) {
                console.error("Error fetching IndexedDB databases:", error);
                return {};
            }
            const result = {};
            for (const dbInfo of dbList) {
                if (!dbInfo.name) continue;
                // Skip our own settings DB
                if (dbInfo.name === DB_NAME) continue; 
                
                result[dbInfo.name] = await getDataFromDatabase(dbInfo.name);
            }
            return result;
        }

        function getDataFromDatabase(dbName) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName);
                request.onsuccess = event => {
                    const db = event.target.result;
                    const storeNames = Array.from(db.objectStoreNames);
                    const dbData = {};
                    let pending = storeNames.length;
                    if (pending === 0) {
                        db.close();
                        resolve(dbData);
                        return;
                    }
                    storeNames.forEach(storeName => {
                        const transaction = db.transaction(storeName, "readonly");
                        const store = transaction.objectStore(storeName);
                        const items = [];
                        const cursorRequest = store.openCursor();
                        cursorRequest.onsuccess = evt => {
                            const cursor = evt.target.result;
                            if (cursor) {
                                items.push({ key: cursor.key, value: cursor.value });
                                cursor.continue();
                            } else {
                                dbData[storeName] = items;
                                pending--;
                                if (pending === 0) {
                                    db.close();
                                    resolve(dbData);
                                }
                            }
                        };
                        cursorRequest.onerror = evt => {
                            pending--;
                            if (pending === 0) {
                                db.close();
                                resolve(dbData);
                            }
                        };
                    });
                };
                request.onerror = event => {
                    reject(event.target.error);
                };
            });
        }

        async function setAllIndexedDBData(indexedData) {
            for (const dbName in indexedData) {
                const storesData = indexedData[dbName];
                await new Promise(resolve => {
                    const request = indexedDB.open(dbName);
                    request.onupgradeneeded = event => {
                        const db = event.target.result;
                        // Create stores if they don't exist
                        for (const storeName in storesData) {
                            if (!db.objectStoreNames.contains(storeName)) {
                                db.createObjectStore(storeName, { keyPath: 'key' });
                            }
                        }
                    };
                    request.onsuccess = event => {
                        const db = event.target.result;
                        const storeNames = Object.keys(storesData);
                        const transaction = db.transaction(storeNames, "readwrite");
                        let completed = 0;
                        const totalStores = storeNames.length;
                        
                        storeNames.forEach(storeName => {
                            const store = transaction.objectStore(storeName);
                            // Clear existing data in the store
                            store.clear().onsuccess = () => {
                                // Add new data
                                storesData[storeName].forEach(item => {
                                    store.put(item.value, item.key);
                                });
                                
                                // On transaction completion for this store (implied by success/error of puts/clears)
                                // We wait for the overall transaction to complete
                                completed++;
                            };
                        });
                        
                        transaction.oncomplete = () => {
                            db.close();
                            resolve();
                        };
                        transaction.onerror = (e) => {
                            console.error(`Error importing data for DB ${dbName}:`, e.target.error);
                            db.close();
                            resolve(); // Resolve anyway to move to the next DB
                        };
                        
                        // If no stores exist, resolve immediately
                        if (totalStores === 0) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = event => {
                        console.error(`Error opening DB ${dbName} for import:`, event.target.error);
                        resolve(); // Resolve to move to the next DB
                    };
                });
            }
        }

        /**
         * Collects all local storage and IndexedDB data (excluding settings/theme), 
         * bundles it into a JSON file, and initiates a download.
         */
        async function downloadAllSaves() {
            const messageElement = document.getElementById('dataTransferMessage');
            try {
                showLoading("Collecting and preparing data for export...");
                
                const localStorageData = getAllLocalStorageData();
                const indexedDBData = await getAllIndexedDBData();
                
                const data = {
                    metadata: {
                        timestamp: new Date().toISOString(),
                        version: '1.0.0', // Arbitrary version number
                    },
                    localStorage: localStorageData,
                    indexedDB: indexedDBData,
                };
                
                const json = JSON.stringify(data, null, 2);
                
                // Create a download link
                const blob = new Blob([json], { 
                    type: "application/json", 
                });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = `4sp_backup_${new Date().getTime()}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                
                hideLoading();
                showMessage(messageElement, '4SP data successfully exported!', 'success');
            } catch (e) {
                hideLoading();
                console.error("Export Error:", e);
                showMessage(messageElement, 'An error occurred during export. Check console for details.', 'error');
            }
        }

        /**
         * Sets up the file input and handles the general 4SP data upload/import.
         */
        function handleFileUpload() {
            const messageElement = document.getElementById('dataTransferMessage');
            
            // Create a temporary file input element
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    showLoading("Importing data. Please wait...");
                    try {
                        const content = e.target.result;
                        const data = JSON.parse(content);
                        
                        if (data.localStorage) {
                            setAllLocalStorageData(data.localStorage);
                        }
                        
                        if (data.indexedDB) {
                            await setAllIndexedDBData(data.indexedDB);
                        }
                        
                        hideLoading();
                        showMessage(messageElement, '4SP data imported successfully! Refreshing the page to apply changes...', 'success');
                        
                        // Force refresh after a short delay
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);

                    } catch (error) {
                        hideLoading();
                        console.error("Import Error:", error);
                        showMessage(messageElement, `Failed to import data: Invalid file format or data structure.`, 'error');
                    }
                };
                reader.readAsText(file);
            };

            input.click(); // Trigger the file selection dialog
            input.remove(); // Clean up the temporary element
        }
        
        // --- NEW GN-Math Data Transfer Functions (Requirement 2 & 3) ---

        /**
         * NEW: Handles the export of GN-Math games data.
         * Assumes a global saveData() function exists from gnmath.js/script.js 
         * that returns the JSON data string for GN-Math.
         */
        function downloadGnMathData() {
            const messageElement = document.getElementById('gnMathDataTransferMessage');
            try {
                // Check for global function availability
                if (typeof saveData !== 'function') {
                    showMessage(messageElement, 'GN-Math export function (saveData) is not globally available. Ensure gnmath.js/script.js is loaded outside the module.', 'error');
                    return;
                }
                
                showLoading("Exporting GN-Math data...");
                // Call the global function (data source from index (1).html)
                const gnMathData = saveData(); 
                
                if (!gnMathData || gnMathData.length < 20) { 
                    hideLoading();
                    showMessage(messageElement, 'No significant GN-Math data found to export.', 'warning');
                    return;
                }

                // Use the download logic from the general export function
                const blob = new Blob([gnMathData], { type: "application/json", });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "game-data.json"; // REQUIREMENT 5: "game-data.json"
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
                
                hideLoading();
                showMessage(messageElement, 'GN-Math data successfully exported as "game-data.json"!', 'success');
            } catch (e) {
                hideLoading();
                console.error("GN-Math Export Error:", e);
                showMessage(messageElement, 'An error occurred during export. Check console for details.', 'error');
            }
        }

        /**
         * NEW: Sets up the event listeners for GN-Math data import using the global loadData(event) function.
         */
        function setupGnMathImportLogic(importBtn, importInput, messageElement) {
            // Check for global function availability
            if (typeof loadData !== 'function') {
                 showMessage(messageElement, 'GN-Math import function (loadData) is not globally available. Ensure gnmath.js/script.js is loaded outside the module.', 'error');
                 return;
            }

            // 1. Link button click to hidden file input click
            importBtn.addEventListener('click', () => {
                importInput.click();
            });

            // 2. Link file input change to global loadData function
            importInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                showLoading("Importing GN-Math data...");
                
                try {
                    // Call the global function with the event object as seen in index (1).html
                    loadData(e); 
                    
                    // Since loadData is external, we assume it works and show a temporary message
                    setTimeout(() => {
                        hideLoading();
                        showMessage(messageElement, 'GN-Math data import initiated. Please refresh the page in the game area to see changes.', 'warning');
                        importInput.value = ''; // Clear the input value
                    }, 1500); 
                    
                } catch (error) {
                    hideLoading();
                    console.error("GN-Math Import Error:", error);
                    showMessage(messageElement, `An error occurred during import: ${error.message}`, 'error');
                    importInput.value = ''; 
                }
            });
        }


        // --- Tab Content Generator Functions ---
        
        /**
         * Generates the HTML for the "General" section.
         */
        function getGeneralContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">User Profile</h3>
                    <div id="profileSection" class="settings-box transition-all duration-300 p-4">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center text-white text-2xl font-semibold">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            <div>
                                <p class="text-lg font-semibold text-white" id="userEmailDisplay">Loading Email...</p>
                                <p class="text-sm text-gray-400">UID: <span id="userUidDisplay">Loading UID...</span></p>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                             <div>
                                <label for="usernameInput" class="block text-sm font-medium text-gray-300 mb-1">Username (Display Name)</label>
                                <input type="text" id="usernameInput" placeholder="Enter your username" class="input-text-style" maxlength="${MAX_LENGTH}">
                                <p class="text-xs text-gray-500 mt-1">Between ${MIN_LENGTH} and ${MAX_LENGTH} characters. Avoid offensive language.</p>
                            </div>
                            
                            <p class="text-sm text-gray-400 font-semibold mt-4">
                                Username change limit: 
                                <span id="usernameChangesLeft" class="text-emphasis text-blue-400">Loading...</span> changes left (resets annually).
                            </p>
                            
                            <div class="flex justify-end pt-2">
                                <button id="saveProfileBtn" class="btn-toolbar-style btn-primary-override w-full sm:w-auto">
                                    <i class="fa-solid fa-save mr-2"></i> Save Profile
                                </button>
                            </div>
                        </div>
                        <p id="profileMessage" class="general-message-area text-sm"></p>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "Privacy & Security" section.
         */
        function getPrivacyContent() {
             return `
                <h2 class="text-3xl font-bold text-white mb-6">Privacy & Security</h2>
                <div class="w-full space-y-8">
                    
                    <div class="w-full">
                        <h3 class="text-xl font-bold text-white mb-2">Account Security</h3>
                        <div id="securitySection" class="settings-box transition-all duration-300 p-4">
                            <p class="text-sm font-light text-gray-400 mb-4">
                                Manage your login methods and update your password.
                            </p>
                            
                            <h4 class="text-lg font-bold text-white mb-3 border-b border-gray-700 pb-2">Linked Accounts</h4>
                            <div id="linkedProviders" class="space-y-3 mb-6">
                                </div>
                            
                            <div id="passwordChangeContainer" class="space-y-4 pt-4 border-t border-gray-700">
                                <h4 class="text-lg font-bold text-white mb-3">Change Password</h4>
                                <p class="text-sm font-light text-red-400">Requires a linked Email & Password account.</p>
                                
                                <div>
                                    <label for="currentPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">Current Password</label>
                                    <input type="password" id="currentPasswordInput" class="input-text-style" autocomplete="current-password">
                                </div>
                                
                                <div>
                                    <label for="newPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">New Password (Min 6 characters)</label>
                                    <input type="password" id="newPasswordInput" class="input-text-style" autocomplete="new-password">
                                </div>
                                
                                <div>
                                    <label for="confirmNewPasswordInput" class="block text-sm font-medium text-gray-300 mb-1">Confirm New Password</label>
                                    <input type="password" id="confirmNewPasswordInput" class="input-text-style" autocomplete="new-password">
                                </div>
                                
                                <div class="flex justify-end pt-2">
                                    <button id="changePasswordBtn" class="btn-toolbar-style btn-primary-override w-full sm:w-auto">
                                        <i class="fa-solid fa-key mr-2"></i> Update Password
                                    </button>
                                </div>
                            </div>
                            <p id="securityMessage" class="general-message-area text-sm"></p>
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <h3 class="text-xl font-bold text-white mb-2">Panic Key</h3>
                        <div id="panicKeySection" class="settings-box transition-all duration-300 p-4">
                            <p class="text-sm font-light text-gray-400 mb-4">
                                Set a key to immediately redirect to a safe page (e.g., Google) when pressed. Stored locally.
                            </p>
                            
                            <div class="flex items-center gap-4">
                                <div class="flex-shrink-0">
                                    <label for="panicKeyInput" class="block text-sm font-medium text-gray-300 mb-1">Key (A-Z, 0-9)</label>
                                    <input type="text" id="panicKeyInput" class="input-key-style" maxlength="1" placeholder="KEY">
                                </div>
                                
                                <div class="flex-grow">
                                    <label for="panicUrlSelect" class="block text-sm font-medium text-gray-300 mb-1">Redirect URL</label>
                                    <select id="panicUrlSelect" class="input-select-style">
                                        <option value="https://google.com">https://google.com</option>
                                        <option value="https://wikipedia.org">https://wikipedia.org</option>
                                        <option value="custom">Custom URL...</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div id="customPanicUrlContainer" class="mt-4 hidden">
                                <label for="customPanicUrlInput" class="block text-sm font-medium text-gray-300 mb-1">Custom Redirect URL</label>
                                <input type="url" id="customPanicUrlInput" class="input-text-style" placeholder="e.g., https://safe-site.com">
                            </div>
                            
                            <div class="flex justify-end pt-4">
                                <button id="savePanicKeyBtn" class="btn-toolbar-style btn-primary-override w-full sm:w-auto">
                                    <i class="fa-solid fa-save mr-2"></i> Save Panic Key
                                </button>
                            </div>
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <h3 class="text-xl font-bold text-white mb-2">Delete Account</h3>
                        <div id="deleteAccountSection" class="settings-box transition-all duration-300 p-4">
                            <p class="text-sm font-light text-gray-400 mb-4">
                                Permanently delete your 4SP account and all associated data in Firebase. 
                                This action is <span class="text-emphasis text-red-400">irreversible</span>.
                            </p>
                            <div class="flex justify-start">
                                <button id="deleteAccountBtn" class="btn-toolbar-style btn-primary-override-danger w-48">
                                    <i class="fa-solid fa-user-xmark mr-1"></i> Delete Account
                                </button>
                            </div>
                            <p id="deleteAccountMessage" class="general-message-area text-sm"></p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        /**
         * Generates the HTML for the "Personalization" section.
         */
        function getPersonalizationContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Personalization</h2>
                <div class="w-full space-y-8">
                    
                    <div class="w-full">
                        <h3 class="text-xl font-bold text-white mb-2">Color Theme</h3>
                        <div id="themePickerSection" class="settings-box transition-all duration-300 p-4">
                            <p class="text-sm font-light text-gray-400 mb-4">
                                Select a color theme for the site's navigation and interactive elements. (Stored locally).
                            </p>
                            <div id="theme-picker-container">
                                </div>
                            <p id="themeMessage" class="general-message-area text-sm"></p>
                        </div>
                    </div>
                    
                    <div class="w-full">
                        <h3 class="text-xl font-bold text-white mb-2">Tab Disguise (URL Changer)</h3>
                        <div id="urlChangerSection" class="settings-box transition-all duration-300 p-4">
                            <p class="text-sm font-light text-gray-400 mb-4">
                                Change the tab's title and favicon to disguise the site. (Stored locally).
                            </p>
                            
                            <div class="space-y-4">
                                <div class="flex items-center gap-4">
                                    <div class="flex-grow">
                                        <label for="presetSelect" class="block text-sm font-medium text-gray-300 mb-1">Select Disguise Preset</label>
                                        <select id="presetSelect" class="input-select-style">
                                            <option value="none">None (Default 4SP)</option>
                                            <optgroup label="Websites" id="websitesGroup"></optgroup>
                                            <optgroup label="Live Data" id="liveGroup"></optgroup>
                                            <option value="custom">Custom Title/Favicon...</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div id="customDisguiseContainer" class="space-y-4 hidden">
                                    <h4 class="text-lg font-bold text-white pt-2 border-t border-gray-700">Custom Settings</h4>
                                    <div>
                                        <label for="customTitleInput" class="block text-sm font-medium text-gray-300 mb-1">Custom Tab Title</label>
                                        <input type="text" id="customTitleInput" class="input-text-style" placeholder="e.g., School Portal">
                                    </div>
                                    <div>
                                        <label for="customFaviconInput" class="block text-sm font-medium text-gray-300 mb-1">Custom Favicon URL (Optional)</label>
                                        <input type="url" id="customFaviconInput" class="input-text-style" placeholder="e.g., https://example.com/favicon.ico">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex justify-end pt-4">
                                <button id="applyDisguiseBtn" class="btn-toolbar-style btn-primary-override w-full sm:w-auto">
                                    <i class="fa-solid fa-mask mr-2"></i> Apply Tab Disguise
                                </button>
                            </div>
                            <p id="urlChangerMessage" class="general-message-area text-sm"></p>
                        </div>
                    </div>
                    
                </div>
            `;
        }

        /**
         * Generates the HTML for the "Data Management" section.
         */
        function getDataManagementContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Data Management</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">4SP Settings & General Saves Backup</h3>
                    <div id="dataTransferSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-2">
                            Backup and restore your local settings and saves (excluding the theme and tab disguise). 
                            The following types of data are included in this general backup:
                        </p>
                        <ul class="list-disc list-inside ml-4 text-sm font-light text-gray-400 mb-4">
                            <li>Your general 4SP local settings and saves (e.g., Notes App data, Firebase connection tokens).</li>
                            <li>Data for <span class="text-emphasis">StrongdogXP Games</span>.</li>
                            <li>Data for <span class="text-emphasis">GN-Math Games</span>.</li>
                        </ul>
                        <div class="flex gap-4 justify-between mt-4">
                            <button id="importDataBtn" class="btn-toolbar-style btn-primary-override flex-grow">
                                <i class="fa-solid fa-file-import mr-2"></i> Import 4SP Data
                            </button>
                            <button id="exportDataBtn" class="btn-toolbar-style btn-primary-override flex-grow">
                                <i class="fa-solid fa-file-export mr-2"></i> Export 4SP Data
                            </button>
                        </div>
                        <p id="dataTransferMessage" class="general-message-area text-sm"></p>

                        <div class="border-t border-[#252525] pt-4 mt-4">
                            <h4 class="text-lg font-bold text-white mb-3">GN-Math Games Backup</h4>
                            <p class="text-sm font-light text-gray-400 mb-3">
                                Use this section to import or export save data specifically for GN-Math games from the main page. 
                                The exported file will be named "<span class="text-emphasis">game-data.json</span>".
                            </p>
                            <div class="flex gap-4 justify-between">
                                <button id="importGnMathDataBtn" class="btn-toolbar-style btn-primary-override flex-grow">
                                    <i class="fa-solid fa-file-import mr-2"></i> Import GN-Math Data
                                </button>
                                <button id="exportGnMathDataBtn" class="btn-toolbar-style btn-primary-override flex-grow">
                                    <i class="fa-solid fa-file-export mr-2"></i> Export GN-Math Data
                                </button>
                            </div>
                            <p id="gnMathDataTransferMessage" class="general-message-area text-sm"></p>
                            <input type="file" id="importGnMathDataInput" style="display: none;" accept=".json">
                        </div>
                        </div>

                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Reset All Local Data</h3>
                    <div id="resetDataSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Completely clear all non-Firebase stored data (Local Storage, IndexedDB) 
                            including game saves and local settings like the Panic Key. 
                            This action is <span class="text-emphasis text-red-400">irreversible</span>.
                        </p>
                        <div class="flex justify-start">
                            <button id="resetDataBtn" class="btn-toolbar-style btn-primary-override-danger w-40">
                                <i class="fa-solid fa-trash-can mr-1"></i> Reset All Data
                            </button>
                        </div>
                        <p id="resetMessage" class="general-message-area text-sm"></p>
                    </div>
                    
                     <h3 class="text-xl font-bold text-white mb-2 mt-8">Clear Site Data</h3>
                    <div id="resetAllSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            This is an emergency option to clear ALL browser storage for this site (Cache, Cookies, Local Storage, IndexedDB). 
                            This forces a complete refresh and is only needed if other reset options fail.
                        </p>
                        <div class="flex justify-start">
                            <button id="resetAllBtn" class="btn-toolbar-style btn-primary-override-danger w-40">
                                <i class="fa-solid fa-bomb mr-1"></i> Clear All Site Data
                            </button>
                        </div>
                    </div>

                </div>
            `;
        }

        /**
         * Generates the HTML for the "About" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">About 4SP</h2>
                <div class="about-section-content">
                    
                    <h3 class="text-xl font-bold text-white mb-2">Project Information</h3>
                    <div class="settings-box transition-all duration-300 p-4 mb-8">
                        <p class="text-sm font-light text-gray-400 mb-2">
                            <strong>Version:</strong> <span class="text-emphasis">1.2.0</span>
                        </p>
                        <p class="text-sm font-light text-gray-400 mb-4">
                            <strong>Last Updated:</strong> <span class="text-emphasis">October 2024</span>
                        </p>
                        <p class="text-sm font-light text-gray-400">
                            4SP is a personal project designed to provide a secure and customizable platform for various web applications and tools.
                        </p>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2">Legal & Documentation</h3>
                    <div class="settings-box transition-all duration-300 p-4 mb-8">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            View our policies and external licenses.
                        </p>
                        <div class="legal-buttons">
                            <a href="../privacy.html" target="_blank" class="btn-toolbar-style">
                                <i class="fa-solid fa-file-contract mr-2"></i> Privacy Policy
                            </a>
                            <a href="../terms.html" target="_blank" class="btn-toolbar-style">
                                <i class="fa-solid fa-clipboard-list mr-2"></i> Terms of Service
                            </a>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2">Connect</h3>
                    <div class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Follow us and contribute to the project.
                        </p>
                        <div class="social-link-group">
                            <a href="https://github.com/4sp-dev" target="_blank" class="text-white hover:text-blue-400 transition-colors">
                                <i class="fa-brands fa-github fa-2x"></i>
                            </a>
                            <a href="mailto:support@4sp.dev" class="text-white hover:text-blue-400 transition-colors">
                                <i class="fa-solid fa-envelope fa-2x"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * Generates placeholder content for tabs that aren't fully implemented.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">${title}</h2>
                <div class="w-full">
                    <div class="settings-box transition-all duration-300 p-10 text-center">
                        <i class="fa-solid fa-cogs fa-4x text-gray-600 mb-4"></i>
                        <h3 class="text-2xl font-bold text-white mb-2">Coming Soon!</h3>
                        <p class="text-md font-light text-gray-400">
                            This settings panel is currently under development. Check back later for updates!
                        </p>
                    </div>
                </div>
            `;
        }

        // --- Tab Initialization Functions ---
        
        // General Tab
        async function loadGeneralTab() {
            // Element references
            const userEmailDisplay = document.getElementById('userEmailDisplay');
            const userUidDisplay = document.getElementById('userUidDisplay');
            const usernameInput = document.getElementById('usernameInput');
            const usernameChangesLeft = document.getElementById('usernameChangesLeft');
            const saveProfileBtn = document.getElementById('saveProfileBtn');
            const profileMessage = document.getElementById('profileMessage');
            
            // 1. Display base user info
            if (currentUser) {
                userEmailDisplay.textContent = currentUser.email || 'N/A';
                userUidDisplay.textContent = currentUser.uid;
            }
            
            // 2. Fetch Firestore data (username and changes left)
            let userData = { username: '', changesLeft: MAX_CHANGES };
            try {
                const docRef = getUserDocRef(currentUser.uid);
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    userData = docSnap.data();
                    usernameInput.value = userData.username || '';
                } else {
                    console.warn("User document not found, creating a new one on first save.");
                    usernameInput.value = '';
                }
            } catch (e) {
                console.error("Error fetching user data:", e);
                showMessage(profileMessage, "Failed to load user profile data.", 'error');
            }
            
            usernameChangesLeft.textContent = userData.changesLeft;
            if (userData.changesLeft === 0) {
                 usernameChangesLeft.classList.add('text-red-400');
                 saveProfileBtn.disabled = true;
            }
            
            // 3. Add event listener
            saveProfileBtn.onclick = async () => {
                const newUsername = usernameInput.value.trim();
                showMessage(profileMessage, "", 'error'); // Clear previous messages
                
                if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                    showMessage(profileMessage, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error');
                    return;
                }
                
                if (newUsername === userData.username) {
                    showMessage(profileMessage, "Username is already set to this value.", 'warning');
                    return;
                }
                
                if (userData.changesLeft <= 0) {
                    showMessage(profileMessage, `You have reached the maximum of ${MAX_CHANGES} username changes for this year.`, 'error');
                    saveProfileBtn.disabled = true;
                    return;
                }
                
                showLoading("Validating and saving username...");
                
                try {
                    // Check for profanity
                    if (await checkProfanity(newUsername)) {
                        hideLoading();
                        showMessage(profileMessage, "The chosen username contains inappropriate language.", 'error');
                        return;
                    }
                    
                    // Check if username is taken
                    if (await isUsernameTaken(newUsername)) {
                        hideLoading();
                        showMessage(profileMessage, "This username is already taken by another user.", 'error');
                        return;
                    }

                    const newChangesLeft = userData.changesLeft - 1;
                    
                    // Update Firestore
                    const docRef = getUserDocRef(currentUser.uid);
                    await updateDoc(docRef, {
                        username: newUsername,
                        usernameLowercase: newUsername.toLowerCase(),
                        changesLeft: newChangesLeft,
                        lastUsernameChange: serverTimestamp()
                    }, { merge: true }); // Use merge:true to create if not exists

                    // Update local state
                    userData.username = newUsername;
                    userData.changesLeft = newChangesLeft;
                    usernameChangesLeft.textContent = newChangesLeft;
                    
                    if (newChangesLeft === 0) {
                        usernameChangesLeft.classList.add('text-red-400');
                        saveProfileBtn.disabled = true;
                    }

                    hideLoading();
                    showMessage(profileMessage, 'Username updated successfully!', 'success');
                    
                } catch (e) {
                    hideLoading();
                    console.error("Error updating profile:", e);
                    showMessage(profileMessage, `Failed to update username: ${e.message}`, 'error');
                }
            };
        }

        // Privacy & Security Tab
        async function loadPrivacyTab() {
            // Element References
            const securityMessage = document.getElementById('securityMessage');
            const linkedProvidersContainer = document.getElementById('linkedProviders');
            const passwordChangeContainer = document.getElementById('passwordChangeContainer');
            const changePasswordBtn = document.getElementById('changePasswordBtn');
            const currentPasswordInput = document.getElementById('currentPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
            
            const panicKeyInput = document.getElementById('panicKeyInput');
            const panicUrlSelect = document.getElementById('panicUrlSelect');
            const customPanicUrlContainer = document.getElementById('customPanicUrlContainer');
            const customPanicUrlInput = document.getElementById('customPanicUrlInput');
            const savePanicKeyBtn = document.getElementById('savePanicKeyBtn');
            const panicKeyMessage = document.getElementById('panicKeyMessage');
            
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            const deleteAccountMessage = document.getElementById('deleteAccountMessage');

            // --- 1. Account Security & Providers ---
            
            const providers = currentUser.providerData.map(p => p.providerId);
            const isPasswordUser = providers.includes('password');
            
            // Clear and hide password container by default
            passwordChangeContainer.style.display = 'none'; 
            
            // Display linked providers
            linkedProvidersContainer.innerHTML = '';
            
            providers.forEach(providerId => {
                const config = PROVIDER_CONFIG[providerId];
                if (!config) return;
                
                const providerEl = document.createElement('div');
                providerEl.className = 'flex items-center justify-between p-3 border border-gray-700 rounded-lg';
                
                // Left side: Icon and Name
                const leftDiv = document.createElement('div');
                leftDiv.className = 'flex items-center';
                const icon = document.createElement('span');
                icon.innerHTML = config.icon.startsWith('<') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-6 h-6 mr-3">`;
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-white font-semibold';
                nameSpan.textContent = config.name;
                leftDiv.appendChild(icon);
                leftDiv.appendChild(nameSpan);
                
                providerEl.appendChild(leftDiv);
                
                // Right side: Status/Action button
                const actionDiv = document.createElement('div');
                
                if (providers.length === 1) {
                    // If only one provider, cannot unlink
                    const statusSpan = document.createElement('span');
                    statusSpan.className = 'text-sm text-red-400 font-medium';
                    statusSpan.textContent = config.isCredential ? 'Primary Login' : 'Required (Cannot Unlink)';
                    actionDiv.appendChild(statusSpan);
                } else if (providerId === 'password') {
                    // Password link has special rules (password change is visible, unlink is handled by unlink button)
                    const unlinkBtn = document.createElement('button');
                    unlinkBtn.className = 'btn-toolbar-style btn-primary-override-danger text-sm py-1 px-3';
                    unlinkBtn.textContent = 'Unlink';
                    unlinkBtn.onclick = () => handleUnlinkProvider(providerId, securityMessage, linkedProvidersContainer);
                    actionDiv.appendChild(unlinkBtn);
                    passwordChangeContainer.style.display = 'block'; // Show password change form
                } else {
                    const unlinkBtn = document.createElement('button');
                    unlinkBtn.className = 'btn-toolbar-style btn-primary-override-danger text-sm py-1 px-3';
                    unlinkBtn.textContent = 'Unlink';
                    unlinkBtn.onclick = () => handleUnlinkProvider(providerId, securityMessage, linkedProvidersContainer);
                    actionDiv.appendChild(unlinkBtn);
                }
                
                providerEl.appendChild(actionDiv);
                linkedProvidersContainer.appendChild(providerEl);
            });
            
            // Add Link Provider buttons (only show unlinked providers)
            Object.keys(PROVIDER_CONFIG).filter(id => !providers.includes(id) && id !== 'password').forEach(providerId => {
                const config = PROVIDER_CONFIG[providerId];
                const linkBtn = document.createElement('button');
                linkBtn.className = 'btn-toolbar-style btn-primary-override text-sm py-2 px-3 mr-3';
                linkBtn.innerHTML = (config.icon.startsWith('<') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-4 h-4 mr-2">`) + `Link ${config.name}`;
                linkBtn.onclick = () => handleLinkProvider(providerId, config.instance(), securityMessage, linkedProvidersContainer);
                linkedProvidersContainer.appendChild(linkBtn);
            });
            
            if (!isPasswordUser && providers.length < 3) {
                // Option to add Email/Password if not already primary and not max providers
                const addPasswordBtn = document.createElement('button');
                addPasswordBtn.className = 'btn-toolbar-style btn-primary-override text-sm py-2 px-3';
                addPasswordBtn.innerHTML = PROVIDER_CONFIG['password'].icon + `Add Email/Password Login`;
                addPasswordBtn.onclick = () => {
                    // Prompt user for email and password, then link
                    openModal("Add Email and Password", [
                        { text: "Cancel", onclick: () => document.getElementById('modalPrompt').style.display = 'none' },
                        { text: "Confirm", onclick: () => { /* Handle creation/link logic here */ } }
                    ]);
                    // NOTE: Full implementation requires a more complex modal, placeholder for now.
                    showMessage(securityMessage, "Feature to link Email/Password is a placeholder. You must currently log in with it to link.", 'warning');
                };
                // linkedProvidersContainer.appendChild(addPasswordBtn);
            }
            
            // Password Change Listener
            if (isPasswordUser) {
                 passwordChangeContainer.style.display = 'block'; 
            }
            changePasswordBtn.onclick = () => handleChangePassword(
                currentPasswordInput.value, 
                newPasswordInput.value, 
                confirmNewPasswordInput.value, 
                securityMessage
            );
            
            // Account Deletion Listener
            deleteAccountBtn.onclick = () => handleDeleteAccount(deleteAccountMessage);


            // --- 2. Panic Key Logic ---
            
            // Set up URL dropdown
            urlChangerPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = `url:${preset.id}`; // Prefix with 'url:' for consistency/safety
                option.textContent = `Tab Disguise: ${preset.name}`;
                panicUrlSelect.appendChild(option);
            });

            // Load saved settings
            const savedSettings = await getPanicKeySettings();
            let currentKey = '';
            let currentUrl = 'https://google.com';
            
            if (savedSettings.has('panicKey')) {
                const keySetting = savedSettings.get('panicKey');
                currentKey = keySetting.key || '';
                currentUrl = keySetting.url || 'https://google.com';
            }
            
            // Set input values
            panicKeyInput.value = currentKey.toUpperCase();
            
            // Select the current URL or "custom"
            if (currentUrl === 'https://google.com' || currentUrl === 'https://wikipedia.org' || currentUrl.startsWith('url:')) {
                panicUrlSelect.value = currentUrl;
                customPanicUrlContainer.classList.add('hidden');
            } else {
                panicUrlSelect.value = 'custom';
                customPanicUrlContainer.classList.remove('hidden');
                customPanicUrlInput.value = currentUrl;
            }

            // Listener for dropdown change
            panicUrlSelect.onchange = () => {
                if (panicUrlSelect.value === 'custom') {
                    customPanicUrlContainer.classList.remove('hidden');
                } else {
                    customPanicUrlContainer.classList.add('hidden');
                }
            };
            
            // Listener for key input (enforce single uppercase char)
            panicKeyInput.oninput = (e) => {
                const value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 1);
                e.target.value = value;
            };

            // Save Panic Key
            savePanicKeyBtn.onclick = async () => {
                const key = panicKeyInput.value.trim().toUpperCase();
                let url;
                const selected = panicUrlSelect.value;
                
                showMessage(panicKeyMessage, "", 'error'); // Clear previous messages
                
                if (selected === 'custom') {
                    url = customPanicUrlInput.value.trim();
                    if (!url || !url.startsWith('http')) {
                        showMessage(panicKeyMessage, 'Custom URL must be a valid, complete URL (starting with http or https).', 'error');
                        return;
                    }
                } else {
                    url = selected;
                }
                
                if (!key && selected === 'none') {
                    // If no key and no redirect, assume user wants to clear it
                    try {
                        await savePanicKeySettings([]); // Clear all settings
                        showMessage(panicKeyMessage, 'Panic Key setting cleared successfully.', 'success');
                        // Reset UI
                        panicKeyInput.value = '';
                        panicUrlSelect.value = 'https://google.com';
                        customPanicUrlContainer.classList.add('hidden');
                        
                    } catch (e) {
                        console.error("Error clearing panic key:", e);
                        showMessage(panicKeyMessage, 'Failed to clear settings.', 'error');
                    }
                    return;
                } else if (!key) {
                    showMessage(panicKeyMessage, 'Please enter a single key (A-Z or 0-9) to activate the panic function.', 'error');
                    return;
                }

                try {
                    const settingsToSave = [{ id: 'panicKey', key: key, url: url }];
                    await savePanicKeySettings(settingsToSave);
                    showMessage(panicKeyMessage, `Panic Key set to "${key}" and redirect URL saved!`, 'success');
                } catch (e) {
                    console.error("Error saving panic key:", e);
                    showMessage(panicKeyMessage, 'Failed to save settings.', 'error');
                }
            };
        }

        // Personalization Tab
        async function loadPersonalizationTab() {
            // Element References
            const themePickerContainer = document.getElementById('theme-picker-container');
            const themeMessage = document.getElementById('themeMessage');
            
            const presetSelect = document.getElementById('presetSelect');
            const websitesGroup = document.getElementById('websitesGroup');
            const liveGroup = document.getElementById('liveGroup');
            const customDisguiseContainer = document.getElementById('customDisguiseContainer');
            const customTitleInput = document.getElementById('customTitleInput');
            const customFaviconInput = document.getElementById('customFaviconInput');
            const applyDisguiseBtn = document.getElementById('applyDisguiseBtn');
            const urlChangerMessage = document.getElementById('urlChangerMessage');
            
            // --- 1. Theme Picker Logic ---
            
            // Available themes (must match themes defined in navigation.js)
            const themes = [
                { id: 'dark', name: 'Dark Default', color: '#4f46e5' }, 
                { id: 'red', name: 'Red Accent', color: '#dc2626' },
                { id: 'green', name: 'Green Accent', color: '#16a34a' },
                { id: 'yellow', name: 'Yellow Accent', color: '#ca8a04' },
                { id: 'teal', name: 'Teal Accent', color: '#0d9488' },
                { id: 'pink', name: 'Pink Accent', color: '#db2777' },
                { id: 'purple', name: 'Purple Accent', color: '#9333ea' },
            ];
            
            const currentTheme = localStorage.getItem(THEME_STORAGE_KEY) || 'dark';
            
            themePickerContainer.innerHTML = '';
            
            themes.forEach(theme => {
                const button = document.createElement('button');
                button.className = `theme-button ${theme.id === currentTheme ? 'active' : ''}`;
                
                // Inline styles for preview (using CSS variables where appropriate)
                button.style.setProperty('--tab-active-border', theme.color);
                button.style.setProperty('--tab-active-shadow', `${theme.color}33`); // 33 is 20% opacity
                button.style.borderColor = theme.color;
                
                button.innerHTML = `
                    <div style="background-color: ${theme.color}; height: 1.5rem; border-radius: 0.25rem; margin-bottom: 0.5rem;"></div>
                    <span class="theme-button-name">${theme.name}</span>
                `;
                button.onclick = () => {
                    // Update classes
                    document.querySelectorAll('.theme-button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Save to local storage and update body
                    localStorage.setItem(THEME_STORAGE_KEY, theme.id);
                    document.body.className = theme.id;
                    showMessage(themeMessage, `Theme set to ${theme.name}!`, 'success');
                    
                    // Note: navigation.js is expected to handle the full theme application on load/change
                    
                };
                themePickerContainer.appendChild(button);
            });
            
            // --- 2. URL Changer Logic ---
            
            // Populate select options
            websitesGroup.innerHTML = '';
            liveGroup.innerHTML = '';
            urlChangerPresets.forEach(preset => {
                const option = document.createElement('option');
                option.value = preset.id;
                option.textContent = preset.name;
                
                if (preset.category === 'websites') {
                    websitesGroup.appendChild(option);
                } else if (preset.category === 'live') {
                    liveGroup.appendChild(option);
                }
            });
            
            // Load saved settings
            const savedSettings = getSavedUrlChangerSetting();
            
            // Set select value
            presetSelect.value = savedSettings.type === 'preset' ? savedSettings.id : savedSettings.type;
            
            // Show/Hide custom container
            if (presetSelect.value === 'custom') {
                customDisguiseContainer.classList.remove('hidden');
                customTitleInput.value = savedSettings.title || '';
                customFaviconInput.value = savedSettings.favicon || '';
            } else {
                 customDisguiseContainer.classList.add('hidden');
            }
            
            // Listener for dropdown change
            presetSelect.onchange = () => {
                if (presetSelect.value === 'custom') {
                    customDisguiseContainer.classList.remove('hidden');
                } else {
                    customDisguiseContainer.classList.add('hidden');
                }
            };
            
            // Save/Apply listener
            applyDisguiseBtn.onclick = () => {
                const selected = presetSelect.value;
                let settings = { type: 'none' };
                
                showMessage(urlChangerMessage, "", 'error'); // Clear previous messages
                
                if (selected === 'custom') {
                    const customTitle = customTitleInput.value.trim();
                    const customFavicon = customFaviconInput.value.trim();
                    
                    if (!customTitle) {
                        showMessage(urlChangerMessage, 'Custom setting requires a tab title.', 'error');
                        return;
                    }
                    
                    settings = { 
                        type: 'custom', 
                        title: customTitle,
                        favicon: customFavicon,
                        url: '', // Custom URL not needed for just title/favicon
                    };
                } else if (selected !== 'none') {
                    // Apply preset
                    const preset = urlChangerPresets.find(p => p.id === selected);
                    if (!preset) {
                        showMessage(urlChangerMessage, 'Invalid preset selected.', 'error');
                        return;
                    }
                    
                    settings = { 
                        type: 'preset', 
                        id: preset.id,
                    };
                }
                
                // Save settings to local storage
                if (saveUrlChangerSetting(settings)) {
                    showMessage(urlChangerMessage, 'Tab disguise applied successfully! The change will take effect immediately.', 'success');
                    // NOTE: The separate url-changer.js script is expected to pick this up and apply the disguise immediately.
                } else {
                    showMessage(urlChangerMessage, 'Failed to save tab disguise settings.', 'error');
                }
            };
        }

        // Data Management Tab (Uses custom content)
        async function loadDataTab() {
            // 1. Element References (4SP General Data)
            const importDataBtn = document.getElementById('importDataBtn');
            const exportDataBtn = document.getElementById('exportDataBtn');
            const messageElement = document.getElementById('dataTransferMessage');
            const resetDataBtn = document.getElementById('resetDataBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            
            // NEW: Element References (GN-Math Data)
            const importGnMathDataBtn = document.getElementById('importGnMathDataBtn');
            const exportGnMathDataBtn = document.getElementById('exportGnMathDataBtn');
            const importGnMathDataInput = document.getElementById('importGnMathDataInput');
            const gnMathMessageElement = document.getElementById('gnMathDataTransferMessage');

            // 2. Add Event Listeners (4SP General Data)
            exportDataBtn.addEventListener('click', downloadAllSaves);
            importDataBtn.addEventListener('click', handleFileUpload);
            
            // 3. Add Event Listeners (Reset Buttons)
            resetDataBtn.addEventListener('click', () => {
                openModal("Are you sure you want to completely wipe all local 4SP data (saves, settings, etc.)? This action cannot be undone.", [
                    { text: "No", onclick: () => document.getElementById('modalPrompt').style.display = 'none' },
                    { text: "Yes, Delete Data", onclick: () => { document.getElementById('modalPrompt').style.display = 'none'; resetLocalData(); } }
                ]);
            });
            
            resetAllBtn.addEventListener('click', () => {
                 openModal("WARNING: This will clear virtually all browser data (cache, storage, cookies) for this site. You will need to log back in. Continue?", [
                    { text: "No", onclick: () => document.getElementById('modalPrompt').style.display = 'none' },
                    { text: "Yes, Clear All Site Data", onclick: () => { document.getElementById('modalPrompt').style.display = 'none'; resetAllSiteData(); } }
                ]);
            });
            
            // NEW: Step 4 - Add Event Listeners (GN-Math Data)
            if (importGnMathDataBtn && exportGnMathDataBtn && importGnMathDataInput) {
                // Export Handler (Requirement 5: filename is set inside downloadGnMathData)
                exportGnMathDataBtn.addEventListener('click', downloadGnMathData);

                // Import Setup (Requirement 2 & 4)
                setupGnMathImportLogic(importGnMathDataBtn, importGnMathDataInput, gnMathMessageElement);
            }
        }
        
        // --- Reset/Wipe Functions (Called from Data Tab) ---
        
        async function resetLocalData() {
            showLoading("Wiping local data...");
            try {
                // Clear Local Storage (excluding theme and URL changer)
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key !== THEME_STORAGE_KEY && key !== URL_CHANGER_KEY) {
                        localStorage.removeItem(key);
                    }
                }

                // Clear IndexedDB (our settings DB and game saves DBs)
                if (indexedDB.databases) {
                    const dbList = await indexedDB.databases();
                    for (const dbInfo of dbList) {
                        await new Promise((resolve, reject) => {
                            const request = indexedDB.deleteDatabase(dbInfo.name);
                            request.onsuccess = () => resolve();
                            request.onerror = (e) => {
                                console.error(`Failed to delete IndexedDB ${dbInfo.name}:`, e.target.error);
                                resolve(); // Resolve anyway to continue with other DBs
                            };
                        });
                    }
                }
                
                hideLoading();
                const resetMessage = document.getElementById('resetMessage');
                showMessage(resetMessage, 'All local data cleared successfully! Refreshing page in 2 seconds...', 'success');
                setTimeout(() => window.location.reload(), 2000);

            } catch (e) {
                hideLoading();
                const resetMessage = document.getElementById('resetMessage');
                console.error("Error during full reset:", e);
                showMessage(resetMessage, `An error occurred during the reset process: ${e.message}`, 'error');
            }
        }
        
        function resetAllSiteData() {
            // This is an extreme measure, essentially forcing a hard cache/storage clear.
            if (navigator.serviceWorker && navigator.serviceWorker.controller) {
                navigator.serviceWorker.controller.postMessage({ type: 'CLEAR_CACHE' });
            }
            // Clear all local storage and session storage
            localStorage.clear();
            sessionStorage.clear();
            
            // Delete all IndexedDBs (handled by resetLocalData logic, but here for completeness)
            // A simple refresh will usually clear cache/cookies but this is safer.
            
            alert("Site data is being reset. The page will now reload.");
            window.location.reload(true); // Force a hard refresh
        }

        // --- Helper for Linking/Unlinking Providers ---
        
        function handleUnlinkProvider(providerId, messageElement, container) {
            openModal(`Are you sure you want to unlink your ${PROVIDER_CONFIG[providerId].name} account? You will no longer be able to log in with it.`, [
                { text: "Cancel", onclick: () => document.getElementById('modalPrompt').style.display = 'none' },
                { text: "Unlink", onclick: async () => { 
                    document.getElementById('modalPrompt').style.display = 'none';
                    showLoading("Unlinking account...");
                    try {
                        await unlink(currentUser, providerId);
                        hideLoading();
                        showMessage(messageElement, `${PROVIDER_CONFIG[providerId].name} account unlinked successfully.`, 'success');
                        await switchTab('privacy'); // Re-render the tab
                    } catch (e) {
                        hideLoading();
                        console.error("Unlink error:", e);
                        showMessage(messageElement, `Failed to unlink: ${e.message}`, 'error');
                    }
                } }
            ]);
        }
        
        function handleLinkProvider(providerId, providerInstance, messageElement, container) {
            showLoading(`Linking ${PROVIDER_CONFIG[providerId].name}...`);
            linkWithPopup(currentUser, providerInstance)
                .then(async (result) => {
                    hideLoading();
                    // The new user info should be in result.user
                    showMessage(messageElement, `${PROVIDER_CONFIG[providerId].name} linked successfully!`, 'success');
                    await switchTab('privacy'); // Re-render the tab
                })
                .catch((error) => {
                    hideLoading();
                    console.error("Link error:", error);
                    // Handle specific errors like "auth/credential-already-in-use"
                    let errorMessage = error.message;
                    if (error.code === 'auth/credential-already-in-use') {
                        errorMessage = "This account is already linked to another user. You must unlink it first.";
                    }
                    showMessage(messageElement, `Failed to link ${PROVIDER_CONFIG[providerId].name}: ${errorMessage}`, 'error');
                });
        }
        
        function handleChangePassword(currentPassword, newPassword, confirmPassword, messageElement) {
            showMessage(messageElement, "", 'error'); // Clear messages

            if (newPassword.length < MIN_LENGTH) {
                showMessage(messageElement, `New password must be at least ${MIN_LENGTH} characters.`, 'error');
                return;
            }
            if (newPassword !== confirmPassword) {
                showMessage(messageElement, 'New passwords do not match.', 'error');
                return;
            }
            
            showLoading("Changing password...");

            const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
            
            reauthenticateWithCredential(currentUser, credential)
                .then(() => {
                    return updatePassword(currentUser, newPassword);
                })
                .then(() => {
                    hideLoading();
                    showMessage(messageElement, 'Password updated successfully!', 'success');
                    // Clear fields
                    document.getElementById('currentPasswordInput').value = '';
                    document.getElementById('newPasswordInput').value = '';
                    document.getElementById('confirmNewPasswordInput').value = '';
                })
                .catch((error) => {
                    hideLoading();
                    console.error("Password change error:", error);
                    let errorMessage = 'Failed to change password. Please ensure your current password is correct.';
                    if (error.code === 'auth/wrong-password') {
                        errorMessage = 'The current password you entered is incorrect.';
                    } else if (error.code === 'auth/requires-recent-login') {
                         errorMessage = 'Please log out and log back in to verify your identity before changing your password.';
                    }
                    showMessage(messageElement, errorMessage, 'error');
                });
        }
        
        function handleDeleteAccount(messageElement) {
            openModal("FINAL WARNING: Deleting your account will permanently erase your user data in Firebase. All linked data will be lost. Are you absolutely sure?", [
                { text: "No, Cancel", onclick: () => document.getElementById('modalPrompt').style.display = 'none' },
                { text: "Yes, Delete Account", onclick: async () => { 
                    document.getElementById('modalPrompt').style.display = 'none';
                    showLoading("Permanently deleting account...");
                    try {
                        await deleteUser(currentUser);
                        // If successful, the onAuthStateChanged listener will handle the redirect
                        hideLoading();
                        alert("Account successfully deleted. You will now be redirected.");
                    } catch (error) {
                        hideLoading();
                        console.error("Account deletion error:", error);
                        let errorMessage = 'Failed to delete account. Please log out and log back in to verify your identity, then try again.';
                        if (error.code === 'auth/requires-recent-login') {
                             errorMessage = 'Your login session is too old. Please log out and log back in before attempting to delete your account.';
                        }
                        showMessage(messageElement, errorMessage, 'error');
                    }
                } }
            ]);
        }
        

        // --- Core Tab Switching Logic ---
        
        /**
         * Switches the active settings tab and loads content.
         * @param {string} tabId - The ID of the tab to switch to.
         */
        async function switchTab(tabId) {
            // 1. Update sidebar active state
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });

            // 2. Load content into the main view
            mainView.innerHTML = ''; // Clear previous content
            
            // Set the main view content based on the tab
            if (tabId === 'general') {
                mainView.innerHTML = getGeneralContent();
                await loadGeneralTab();
            } else if (tabId === 'privacy') {
                mainView.innerHTML = getPrivacyContent();
                await loadPrivacyTab();
            } else if (tabId === 'personalization') {
                mainView.innerHTML = getPersonalizationContent();
                await loadPersonalizationTab();
            } else if (tabId === 'data') {
                mainView.innerHTML = getDataManagementContent();
                await loadDataTab(); // Setup listeners
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

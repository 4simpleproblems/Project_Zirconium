<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - Settings</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <!-- Fonts, Icons, and Tailwind CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- navigation.js and injector.js must be loaded here if they are external files -->
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
        }

        /* --- LAYOUT --- */
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr;
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
            gap: 2rem;
        }
        @media (min-width: 768px) {
            .settings-grid {
                grid-template-columns: 280px 1fr;
            }
        }
        
        /* --- SIDEBAR --- */
        .sidebar {
            background-color: #111111;
            border-radius: 1rem;
            padding: 0.5rem;
            border: 1px solid #1f1f1f;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #a0a0a0;
            font-weight: 500;
        }
        .sidebar-item:hover {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        .sidebar-item.active {
            background-color: #1a1a1a;
            color: #4f46e5;
            box-shadow: inset 3px 0 0 #4f46e5;
        }
        .sidebar-item.active i {
            color: #4f46e5 !important;
        }
        .sidebar-item i {
            width: 1.5rem;
            text-align: center;
            margin-right: 0.75rem;
            color: #a0a0a0;
        }

        /* --- MAIN PANEL --- */
        .main-panel {
            background-color: #111111;
            border-radius: 1rem;
            padding: 2rem;
            border: 1px solid #1f1f1f;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .main-panel-title {
            font-size: 1.875rem; /* 3xl */
            font-weight: 700;
            color: #ffffff;
            border-bottom: 2px solid #1f1f1f;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        .main-panel-title i {
            color: #4f46e5; /* Default blue for icons */
        }

        /* --- COLOR PICKER --- */
        .color-selector {
            width: 40px;
            height: 40px;
            border-radius: 9999px; /* full rounded */
            cursor: pointer;
            border: 3px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.1s, border-color 0.2s;
        }
        .color-selector:hover {
            transform: scale(1.1);
        }
        .color-selector.active {
            border-color: #4f46e5;
            transform: scale(1.05);
            box-shadow: 0 0 0 2px #4f46e5, 0 2px 8px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <!-- Navigation Bar will be prepended here by navigation.js -->

    <div class="settings-grid">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <h2 class="text-xl font-bold p-4 text-white">App Settings</h2>
            <div id="sidebar-nav" class="flex flex-col space-y-1">
                <!-- Sidebar items will be dynamically generated -->
            </div>
        </div>

        <!-- Main Content Panel -->
        <div class="main-panel">
            <h1 id="panel-title" class="main-panel-title"></h1>
            <div id="panel-content">
                <!-- Content will be dynamically generated -->
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js";

        // Global Firebase variables populated by navigation.js
        const FIREBASE_CONFIG = window.FIREBASE_CONFIG || { apiKey: "MOCK_KEY" };
        const USER_SETTINGS_KEY = '4sp_navbar_color';

        let auth, db;
        let userId;

        // --- Data Definitions ---

        // Map of colors to display names for hover effect (Goal #4)
        const COLOR_NAMES = {
            '#000000': 'Pure Obsidian',
            '#ffffff': 'Industrial White',
            '#facc15': 'Solar Flare Yellow',
            '#6b21a8': 'Deep Violet',
            '#1e40af': 'Cerulean Deep',
            '#ef4444': 'Emergency Red',
            '#10b981': 'Emerald Green',
            '#374151': 'Gunmetal Gray',
            '#8b5cf6': 'Vaporwave Purple',
            '#f97316': 'Electric Orange',
            '#4b5563': 'Slate Gray',
            '#059669': 'Forest Teal',
        };

        // HEX colors to display in the palette (must match keys in COLOR_NAMES)
        const PALETTE_COLORS = Object.keys(COLOR_NAMES); 


        // Setting sections configuration
        const SECTIONS = {
            'profile': {
                title: "User Profile",
                icon: "fa-user-circle",
                color: "text-blue-500",
                content: "Manage your username, profile picture, and display information.",
                render: renderProfileSection
            },
            'appearance': {
                title: "Appearance",
                icon: "fa-palette",
                color: "text-purple-500",
                content: "Customize the look and feel of the application, including the navigation bar color.",
                render: renderAppearanceSection
            },
            'security': {
                title: "Security & Privacy",
                icon: "fa-lock",
                color: "text-red-500",
                content: "Update your password, manage linked accounts, and configure two-factor authentication.",
                render: renderDefaultSection
            },
            'notifications': {
                title: "Notifications",
                icon: "fa-bell",
                color: "text-yellow-500",
                content: "Configure your email and in-app notification preferences.",
                render: renderDefaultSection
            },
            'advanced': {
                title: "Advanced Settings",
                icon: "fa-cogs",
                color: "text-gray-500",
                content: "Access advanced configuration options, including data export and account deletion.",
                render: renderDefaultSection
            }
        };

        // --- Firebase Initialization and Auth Check ---

        const startAuthFlow = () => {
            try {
                const app = initializeApp(FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);

                // Wait for navigation.js to load the auth state.
                const authUnsub = auth.onAuthStateChanged(user => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        renderSidebar();
                        displaySection('appearance'); // Default to Appearance section
                    } else {
                        console.log("User not authenticated. Redirecting.");
                        // Redirect to home or login page if not logged in
                        window.location.href = "../../index.html"; 
                    }
                    // Unsubscribe after the first check to prevent multiple calls
                    authUnsub(); 
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        };

        // --- Rendering Functions ---

        const renderSidebar = () => {
            const sidebarNav = document.getElementById('sidebar-nav');
            sidebarNav.innerHTML = Object.entries(SECTIONS).map(([id, section]) => `
                <div 
                    id="sidebar-${id}" 
                    class="sidebar-item" 
                    data-section-id="${id}"
                    onclick="displaySection('${id}')"
                >
                    <i class="fa-solid ${section.icon} ${section.color}"></i>
                    <span>${section.title}</span>
                </div>
            `).join('');

            // Add click listeners (already handled by onclick attribute)
            window.displaySection = displaySection;
        };

        const displaySection = (sectionId) => {
            const section = SECTIONS[sectionId];
            if (!section) return;

            const panelTitle = document.getElementById('panel-title');
            const panelContent = document.getElementById('panel-content');

            // 1. Update panel title
            panelTitle.innerHTML = `<i class="fa-solid ${section.icon} mr-2 ${section.color}"></i> ${section.title}`;

            // 2. Render section specific content
            section.render(panelContent);

            // 3. Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sidebar-${sectionId}`).classList.add('active');
        };

        // --- Section Renderers ---

        const renderDefaultSection = (panelContent) => {
            const sectionId = panelContent.closest('.main-panel').querySelector('#panel-title').textContent.trim().toLowerCase().replace(/\s/g, '-');
            const section = SECTIONS[sectionId.replace('-section', '')]; // Simple lookup
            
            panelContent.innerHTML = `
                <div class="flex flex-col space-y-4">
                    <p class="text-lg text-gray-400">${section.content}</p>
                    <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                        <h3 class="text-xl font-semibold mb-2 text-white">Under Development</h3>
                        <p class="text-sm text-gray-500">
                            This section is currently under construction. Please check back later for detailed controls and configuration options.
                            <i class="fa-solid fa-code text-indigo-400 ml-1"></i>
                        </p>
                    </div>
                    <button class="bg-gray-600 cursor-not-allowed text-white font-medium py-2 px-4 rounded-lg shadow-lg transition-all duration-200 mt-4 self-start flex items-center">
                        <i class="fa-solid fa-save mr-2"></i> Save Changes (Disabled)
                    </button>
                </div>
            `;
        };

        const renderProfileSection = (panelContent) => {
            const section = SECTIONS['profile'];
            
            panelContent.innerHTML = `
                <div class="flex flex-col space-y-4">
                    <p class="text-lg text-gray-400">${section.content}</p>
                    <div class="bg-gray-800 p-6 rounded-lg border border-gray-700 space-y-4">
                        <h3 class="text-xl font-semibold text-white">Profile Details</h3>
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-400 mb-1">Username</label>
                            <input type="text" id="username" value="${auth.currentUser?.displayName || 'User'}" class="w-full p-2 rounded-lg bg-gray-900 border border-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500">
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-400 mb-1">Email (Read Only)</label>
                            <input type="email" id="email" value="${auth.currentUser?.email || 'N/A'}" readonly class="w-full p-2 rounded-lg bg-gray-700 border border-gray-600 text-gray-400 cursor-not-allowed">
                        </div>
                    </div>
                    <button id="save-profile-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition-all duration-200 mt-4 self-start flex items-center">
                        <i class="fa-solid fa-save mr-2"></i> Save Profile
                    </button>
                </div>
            `;
            // Add listeners for profile saving (omitted for brevity, but structure is here)
        };

        const renderAppearanceSection = (panelContent) => {
            const currentNavbarColor = localStorage.getItem(USER_SETTINGS_KEY) || '#000000';
            const section = SECTIONS['appearance'];
            
            const colorPaletteHtml = PALETTE_COLORS.map(color => {
                const isActive = color.toLowerCase() === currentNavbarColor.toLowerCase();
                const name = COLOR_NAMES[color.toLowerCase()] || 'Custom Color';
                
                return `
                    <div 
                        class="color-selector ${isActive ? 'active' : ''}" 
                        style="background-color: ${color};" 
                        data-color="${color}" 
                        onclick="selectNavbarColor('${color}')"
                        title="${name}"
                    ></div>
                `;
            }).join('');


            panelContent.innerHTML = `
                <div class="flex flex-col space-y-6">
                    <p class="text-lg text-gray-400">${section.content}</p>
                    
                    <!-- Navbar Color Palette -->
                    <div class="bg-gray-900 p-6 rounded-lg border border-gray-800">
                        <h3 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <i class="fa-solid fa-box-tissue mr-2 text-pink-400"></i> Navbar Background Color
                        </h3>
                        <p class="text-sm text-gray-500 mb-4">
                            Select a preset color for the application's top navigation bar. The text/icon color adjusts automatically for maximum contrast and subtle tinting. Hover over a color for its name!
                        </p>
                        <div id="color-palette" class="flex flex-wrap gap-4 p-2">
                            ${colorPaletteHtml}
                        </div>
                    </div>

                    <!-- Custom Color Input -->
                    <div class="bg-gray-900 p-6 rounded-lg border border-gray-800">
                        <h3 class="text-xl font-semibold mb-4 text-white flex items-center">
                            <i class="fa-solid fa-tint mr-2 text-cyan-400"></i> Custom Color (HEX)
                        </h3>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="custom-color-picker" value="${currentNavbarColor}" class="w-10 h-10 p-0 rounded-lg border-none overflow-hidden cursor-pointer" title="Custom Color Picker">
                            <input type="text" id="custom-color-hex" value="${currentNavbarColor}" maxlength="7" class="p-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:ring-indigo-500 focus:border-indigo-500 w-32 uppercase" placeholder="#123456">
                            <button id="apply-custom-color" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-lg shadow-lg transition-all duration-200 flex items-center">
                                Apply Custom
                            </button>
                        </div>
                        <p id="color-error" class="text-red-500 text-sm mt-2 hidden">Invalid HEX color code.</p>
                    </div>

                </div>
            `;
            
            const customHexInput = document.getElementById('custom-color-hex');
            const customPicker = document.getElementById('custom-color-picker');
            const applyButton = document.getElementById('apply-custom-color');

            // Sync Hex Input to Picker
            customHexInput.addEventListener('input', (e) => {
                const hex = e.target.value.toUpperCase();
                if (/^#?([0-9A-F]{6})$/.test(hex)) {
                    customPicker.value = hex.startsWith('#') ? hex : '#' + hex;
                    document.getElementById('color-error').classList.add('hidden');
                }
            });

            // Sync Picker to Hex Input
            customPicker.addEventListener('input', (e) => {
                customHexInput.value = e.target.value.toUpperCase();
                document.getElementById('color-error').classList.add('hidden');
            });

            // Apply Custom Color
            applyButton.addEventListener('click', () => {
                const hex = customHexInput.value.toUpperCase().startsWith('#') ? customHexInput.value : '#' + customHexInput.value;
                if (/^#[0-9A-F]{6}$/.test(hex)) {
                    selectNavbarColor(hex);
                    document.getElementById('color-error').classList.add('hidden');
                } else {
                    document.getElementById('color-error').classList.remove('hidden');
                }
            });

            window.selectNavbarColor = selectNavbarColor; // Expose to global scope for onclick
        };

        const selectNavbarColor = (color) => {
            const hexColor = color.toUpperCase();
            
            // 1. Save to Local Storage
            try {
                localStorage.setItem(USER_SETTINGS_KEY, hexColor);
                console.log(`Navbar color saved: ${hexColor}`);
            } catch (e) {
                console.error("Could not save to Local Storage:", e);
                // Fallback: use global variable if available
                if (window.USER_SETTINGS_KEY) {
                    window.USER_SETTINGS_KEY = hexColor;
                }
            }
            
            // 2. Refresh Navigation Bar (which relies on localStorage)
            if (typeof window.startNavigationBootstrap === 'function') {
                window.startNavigationBootstrap();
            } else {
                console.warn("startNavigationBootstrap function not found. Navbar update requires page refresh.");
            }

            // 3. Update active state in settings UI
            const palette = document.getElementById('color-palette');
            if (palette) {
                palette.querySelectorAll('.color-selector').forEach(selector => {
                    selector.classList.remove('active');
                    if (selector.getAttribute('data-color').toUpperCase() === hexColor) {
                        selector.classList.add('active');
                    }
                });
            }
            
            // 4. Update custom input fields
            const customHexInput = document.getElementById('custom-color-hex');
            const customPicker = document.getElementById('custom-color-picker');
            if (customHexInput) customHexInput.value = hexColor;
            if (customPicker) customPicker.value = hexColor;
        };
        
        // --- START APPLICATION ---\
        startAuthFlow();
    </script>
</body>
</html>

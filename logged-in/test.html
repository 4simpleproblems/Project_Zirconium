<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - SETTINGS</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <!-- 
      Added the url-tab-title-changer.js script. 
      It's loaded here so the global `urlChanger` object is available
      to the settings page's <script type="module">.
    -->
    <script src="../url-tab-title-changer.js"></script>
    
    <!-- 
      Note: panic-key.js is NOT included here. 
      That script is loaded by your injector on other pages.
      This settings page will instead write to the *same IndexedDB*
      that panic-key.js reads from.
    -->

    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        :root {
            /* The color variable has been removed as navigation.js manages it via --navbar-background */
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* The body padding-top is now handled by the CSS injected in test-navigation.js to account for the fixed navbar height */
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* Full-screen content wrapper */
        .settings-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 0 1rem; 
        }

        /* Header Styling */
        .page-header {
            padding: 2rem 1rem 1rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Settings Grid Layout */
        .settings-layout {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
            flex-grow: 1;
        }

        /* --- UPDATED: Sidebar Styling --- */
        .settings-sidebar {
            width: 100%;
            min-width: 200px;
            max-width: 280px;
            flex-shrink: 0;
            
            /* NEW: Sticky Sidebar Implementation */
            position: sticky;
            /* 4rem for main navbar + 1rem desired gap */
            top: 5rem; 
            /* Aligns item to the start of the flex container, crucial for sticky */
            align-self: flex-start;
            /* Set a MAX-height based on viewport, minus the sticky offset */
            max-height: calc(100vh - 5rem);
            /* Allow sidebar to scroll internally if its content is too tall */
            overflow-y: auto;
        }

        /* --- STYLING UPDATE: Replaced .sidebar-item styles with .nav-tab styles --- */
        .sidebar-item {
            flex-shrink: 0;
            padding: 8px 14px; /* from nav-tab */
            color: var(--tab-text, #9ca3af); /* from nav-tab */
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s, color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
            text-decoration: none;
            line-height: 1.5;
            display: flex; /* keep this */
            align-items: center; /* keep this */
            margin-bottom: 0.25rem; /* keep this */
            border: 1px solid transparent; /* from nav-tab */
            cursor: pointer; /* keep this */
        }
        
        /* FIX: Ensure icon is centered in its box */
        .sidebar-item i {
            text-align: center;
            line-height: 1.5rem; /* Matches h-6 (1.5rem) */
        }

        .sidebar-item:not(.active):hover {
            color: var(--tab-hover-text, #ffffff);
            border-color: var(--tab-hover-border, #d1d5db);
            background-color: var(--tab-hover-bg, rgba(79, 70, 229, 0.05));
        }

        .sidebar-item.active {
            color: var(--tab-active-text, #4f46e5);
            border-color: var(--tab-active-border, #4f46e5);
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            font-weight: 500;
        }
        .sidebar-item.active:hover { /* Add active hover */
            color: var(--tab-active-hover-text, #6366f1);
            border-color: var(--tab-active-hover-border, #6366f1);
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
        }
        /* --- END STYLING UPDATE --- */

        /* Main Content Panel */
        .settings-panel {
            flex-grow: 1;
            background-color: #111111;
            border: 1px solid #252525;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 70vh;
        }
        
        /* --- General Settings UI --- */
        .settings-section {
            border-bottom: 1px solid #252525;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .settings-label {
            display: block;
            font-medium text-white mb-2;
        }
        .settings-input {
            width: 100%;
            max-width: 400px;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-input:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #3b82f640;
        }
        .settings-input:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- STYLING UPDATE: Removed all old button styles --- */
        /* .settings-button, .settings-button-danger, .settings-button-secondary, */
        /* .btn-primary, .btn-secondary, .btn-danger and all hover/disabled states removed */

        /* --- STYLING UPDATE: Added new button styles from notes.html --- */
        .btn-base {
            background: var(--menu-bg, #000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.6rem 1.25rem; /* from old .settings-button */
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Added */
            gap: 0.5rem;
        }
        .btn-base:hover {
            background-color: var(--menu-bg, #000000);
            border-color: var(--menu-border, #fff); 
            color: var(--tab-hover-text, #ffffff);
        }
        .btn-base:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #374151;
            color: #9ca3af;
        }

        .btn-primary-style {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .btn-primary-style:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }
        
        .btn-danger-style {
            color: #dc2626; /* red-600 - Darker Red */
        }
        .btn-danger-style:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-600 with 15% opacity */
            border-color: #ef4444; /* red-500 */
            color: #f87171; /* red-400 - Brighter on hover */
        }
        
        /* NEW: Secondary button style with accent */
        .btn-secondary-style {
            color: #60a5fa; /* blue-400 */
        }
        .btn-secondary-style:hover {
            background-color: rgba(96, 165, 250, 0.1); /* blue-400 with 10% opacity */
            border-color: #60a5fa; /* blue-400 */
            color: #93c5fd; /* blue-300 */
        }
        /* --- END STYLING UPDATE --- */


        .settings-description {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.5rem;
            max-width: 600px;
        }
        .message-area {
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }
        .message-error { color: #f87171; /* red-400 */ }
        .message-success { color: #4ade80; /* green-400 */ }
        .message-warning { color: #facc15; /* yellow-400 */ }

        /* Standard loading screen style */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #070707;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* Mobile adjustments: Hide sidebar and adjust layout */
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
                gap: 1rem;
            }
            .settings-sidebar {
                max-width: 100%;
                margin-bottom: 0;
                /* On mobile, un-stick the sidebar */
                position: static;
                height: auto;
                max-height: none; /* Reset max-height for mobile */
                overflow-y: visible;
            }
        }

        /* --- UPDATED CSS for .color-option (Text Centered) --- */

        .color-option {
            /* 1. Wide but not tall / Spacious */
            width: 100%;
            padding: 0.75rem 1.25rem; 
            height: auto; 
            
            /* 2. Slightly more rounded (12px) */
            border-radius: 12px;
            
            /* 3. Less spacing between them */
            margin-bottom: 4px; 
            
            /* Standard button styling */
            cursor: pointer;
            border: 3px solid #374151; /* gray-700 */
            transition: background-color 0.2s, border-color 0.2s; 
            display: flex;
            align-items: center;
            /* CHANGE: Sets the horizontal alignment of the flex items to the center */
            justify-content: center; 
            
            font-size: 0.9rem; 
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
            font-weight: 500;
        }

        .color-option:hover {
            border-color: #6b7280; /* gray-500 */
            background-color: #1f1f1f; 
        }

        .color-option.selected {
            border-color: #3b82f6; /* Blue-500 */
            box-shadow: 0 0 0 3px #3b82f680;
            background-color: #18202d;
        }

        /* NEW: Avatar and Personalization Styles */
        .avatar-preview {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .avatar-options {
            flex: 1;
        }

        .form-select, .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Specific max-width for settings inputs */
        .form-input.settings-input-width, .form-select.settings-input-width {
            max-width: 400px;
        }

        .emoji-btn {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .emoji-btn:hover {
            background-color: #374151;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-header {
            flex: 1;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Compact mode styles */
        body.compact-mode {
            --spacing-scale: 0.8;
        }

        body.compact-mode .setting-item {
            padding: 12px;
        }

        body.compact-mode .settings-section {
            margin-bottom: 20px;
        }

        /* Crop canvas styles */
        #crop-canvas {
            max-width: 200px;
            max-height: 200px;
        }

        .hidden {
            display: none !important;
        }
        
        /* --- START: NEW STYLES FOR TAB DISGUISER --- */
        
        /* Style for the custom favicon pickers */
        .favicon-picker-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
            padding: 10px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            background-color: #374151; /* gray-700 */
            max-height: 150px;
            overflow-y: auto;
        }

        .favicon-picker-item {
            position: relative; /* For the delete button */
            width: 40px;
            height: 40px;
            padding: 5px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 8px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            background-color: #4b5563; /* gray-600 */
        }

        .favicon-picker-item:hover {
            background-color: #6b7280; /* gray-500 */
        }

        .favicon-picker-item.selected {
            border-color: #3b82f6; /* blue-500 */
            background-color: #1f2937; /* gray-800 */
        }

        .favicon-picker-item img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
        }

        /* NEW: Delete button for custom favicons */
        .favicon-delete-btn {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 16px;
            height: 16px;
            background-color: #dc2626; /* red-600 */
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 10px;
            line-height: 16px;
            text-align: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }

        .favicon-picker-item:hover .favicon-delete-btn {
            opacity: 1;
        }
        .favicon-delete-btn:hover {
            background-color: #b91c1c; /* red-700 */
        }
        
        /* Style for the favicon fetch preview */
        .favicon-fetch-preview {
            width: 46px;
            height: 46px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #374151; /* gray-700 */
            flex-shrink: 0;
            padding: 5px; /* Added padding */
        }
        
        .favicon-fetch-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        /* --- END: NEW STYLES FOR TAB DISGUISER --- */
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body>

    <div id="loading-screen">
        <p class="text-xl text-gray-400">Verifying authentication and loading settings...</p>
    </div>

    <main id="page-content" class="settings-wrapper hidden">
        
        <header class="page-header">
            <h1 id="main-title" class="text-3xl text-white font-bold mb-3 tracking-wide">Settings</h1>
            <div class="h-px bg-white/20 w-full"></div>
        </header>

        <div class="settings-layout">
            
            <nav id="settings-sidebar" class="settings-sidebar"></nav>

            <section class="settings-panel">
                <h2 id="panel-title" class="text-2xl font-semibold text-indigo-400 mb-6">General</h2>
                <div id="panel-content" class="text-gray-400">
                    <!-- Content is rendered here by JavaScript -->
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        // --- NEW: Firebase v10 (Modular) Imports ---
        import { firebaseConfig } from '../firebase-config.js';
        // --- Removed JSON import ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            reauthenticateWithCredential,
            reauthenticateWithPopup,
            EmailAuthProvider,
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            updatePassword,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            serverTimestamp,
            collection,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- NEW: Firebase v10 Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: Global State Variables ---
        let currentUser = null;         // Firebase Auth User object
        let currentUserData = null;     // Firestore 'users' document data
        let unsubscribeUserDoc = null;  // Function to stop the onSnapshot listener
        let activeSection = 'general';  // Track the currently loaded section
        
        // --- MODIFICATION: themePalettes and a promise to track its loading ---
        let themePalettes = null;       // Will be populated by fetch()
        let themesPromise = null;       // Will hold the fetch promise

        // --- CONSTANTS AND DOM ELEMENTS ---
        const BASE_TITLE = "Settings";
        // Key for Local Storage - MUST MATCH THEME_STORAGE_KEY in navigation.js
        const NAVBAR_SETTINGS_KEY = 'user-navbar-theme'; 
        const GAME_SAVE_FILENAME = 'strongdog_saves.json'; // New constant for the save file name
        
        // --- [NEW] CONSTANTS FOR PANIC KEY (from panic-key.js) ---
        const PANIC_KEY_DB_NAME = 'userLocalSettingsDB';
        const PANIC_KEY_STORE_NAME = 'panicKeyStore';

        // --- [NEW] CONSTANTS FOR TAB DISGUISER (from url-tab-title-changer.js) ---
        // These are presets *built-in* to the settings page, matching url-tab-title-changer.js
        const TAB_PRESETS_INTERNAL = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'gmm', name: 'GMM', title: 'Get More Math!', favicon: '../favicons/gmm.png', category: 'websites' },
            { id: 'kahoot', name: 'Kahoot', title: 'Kahoot! | Learning games | Make learning awesome!', favicon: '../favicons/kahoot.png', category: 'websites' },
            { id: 'g_classroom', name: 'Google Classroom', title: 'Home', favicon: '../favicons/google-classroom.png', category: 'websites' },
            { id: 'g_docs', name: 'Google Docs', title: 'Google Docs', favicon: '../favicons/google-docs.png', category: 'websites' },
            { id: 'g_slides', name: 'Google Slides', title: 'Google Slides', favicon: '../favicons/google-slides.png', category: 'websites' },
            { id: 'g_drive', name: 'Google Drive', title: 'Home - Google Drive', favicon: '../favicons/google-drive.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'clever', name: 'Clever', title: 'Clever | Connect every student to a world of learning', favicon: '../favicons/clever.png', category: 'websites' },
            // Note: The 'live' preset from url-tab-title-changer.js is also handled.
        ];
        
        const FOURSP_ICONS = [
             { name: '4SP Dark', url: '../images/logo-dark.png' },
             { name: '4SP Light', url: '../images/logo.png' }
        ];
        // --- [END NEW CONSTANTS] ---

        const settingsSections = [
            { id: 'general', title: 'General', icon: 'fa-cog', content: 'Manage your core account settings, username, and password.', color: 'text-yellow-400' },
            { id: 'privacy', title: 'Privacy & Security', icon: 'fa-shield-alt', content: 'Manage your data permissions, account security, and two-factor authentication. Strong security is a priority!', color: 'text-red-400' },
            { id: 'personalization', title: 'Personalization', icon: 'fa-palette', content: 'Customize the look and feel of the application, including colors and layout. Make it truly yours!', color: 'text-pink-400' },
            { id: 'tab-disguiser', title: 'Tab Disguiser', icon: 'fa-mask', content: 'Customize your tab appearance to hide your activity.', color: 'text-purple-400' },
            { id: 'panic-key', title: 'Panic Key', icon: 'fa-hand-paper', content: 'Set up a panic key to quickly hide your current activity.', color: 'text-orange-400' },
            { id: 'notifications', title: 'Notifications', icon: 'fa-bell', content: 'Set your preferences for alerts and communication methods. Never miss an important update.', color: 'text-green-400' },
            { id: 'data', title: 'Data Management', icon: 'fa-database', content: 'View, export, or request deletion of your stored data.', color: 'text-blue-400' },
            { id: 'about', title: 'About 4SP', icon: 'fa-info-circle', content: 'Application version, legal notices, and credits.', color: 'text-gray-400' }
        ];
        
        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const mainTitle = document.getElementById('main-title');
        const sidebarNav = document.getElementById('settings-sidebar');
        const panelTitle = document.getElementById('panel-title');
        const panelContent = document.getElementById('panel-content');
        const pageHtmlTitle = document.getElementById('page-title');

        // --- NEW: AUTHENTICATION & DATA FLOW ---

        function startAuthFlow() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    currentUser = user;
                    
                    // Stop any previous listener
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }
                    
                    // Get the user's document reference
                    const userDocRef = doc(db, 'users', user.uid);
                    
                    // Set up a real-time listener for the user's data
                    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentUserData = docSnap.data();
                        } else {
                            // This case should ideally not happen for a logged-in user
                            // But if it does, we have their basic auth data
                            currentUserData = {
                                email: user.email,
                                username: user.displayName || 'User',
                                authMethod: user.providerData[0]?.providerId || 'unknown'
                            };
                            console.warn("Firestore document not found for user:", user.uid);
                        }
                        
                        // Initial page setup
                        if (loadingScreen.style.display !== 'none') {
                            initializePage();
                        } else {
                            // If page is already loaded, just refresh the active panel
                            // This is for real-time updates (e.g., username cooldown)
                            loadSection(activeSection);
                        }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        // Show page even if Firestore listener fails
                        currentUserData = { email: user.email, username: user.displayName || 'User' };
                        initializePage();
                    });

                } else {
                    // User is signed out.
                    currentUser = null;
                    currentUserData = null;
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }
                    // Redirect to login page
                    console.log("User is not authenticated. Redirecting to login.");
                    window.location.href = '../authentication.html';
                }
            });
        }
        
        /**
         * Runs once after the first successful auth check and data load.
         */
        function initializePage() {
            renderSidebar();
            loadSection('general'); // Load 'general' by default
            
            // Hide loading screen and show content
            loadingScreen.style.display = 'none';
            pageContent.classList.remove('hidden');

            // --- MODIFICATION: Start loading themes AFTER auth is complete ---
            // Start loading theme data in the background
            themesPromise = fetch('../themes.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch themes: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    themePalettes = data;
                    // If user somehow got to personalization tab before this finished, re-render it.
                    if (activeSection === 'personalization') {
                        renderPersonalizationSettings();
                    }
                    return data;
                })
                .catch(error => {
                    console.error("Error loading theme data:", error);
                    // If on personalization tab, show an error
                    if (activeSection === 'personalization') {
                        panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                    }
                });
        }
        
        // --- SETTINGS UI LOGIC ---

        function renderSidebar() {
            sidebarNav.innerHTML = ''; // Clear existing content
            settingsSections.forEach(section => {
                const item = document.createElement('div');
                item.className = 'sidebar-item group';
                item.id = `sidebar-${section.id}`;
                item.setAttribute('data-section', section.id);
                item.innerHTML = `
                    <i class="fas ${section.icon} w-6 h-6 mr-3 ${section.color} transition-transform group-hover:scale-110"></i>
                    <span class="text-sm font-medium">${section.title}</span>
                `;
                // --- MODIFICATION: Make click listener async ---
                item.addEventListener('click', async () => await loadSection(section.id));
                sidebarNav.appendChild(item);
            });
        }

        // --- MODIFICATION: Make loadSection async to await theme loading ---
        async function loadSection(sectionId) {
            activeSection = sectionId; // Update global state
            const section = settingsSections.find(s => s.id === sectionId);
            if (!section) return;

            // 1. Update main title and HTML title
            mainTitle.textContent = `${BASE_TITLE} - ${section.title}`;
            pageHtmlTitle.textContent = `4SP - ${BASE_TITLE} - ${section.title}`;

            // 2. Update content panel header
            panelTitle.innerHTML = `<i class="fas ${section.icon} mr-2 ${section.color}"></i> ${section.title}`;
            
            // 3. Render content based on section ID
            if (sectionId === 'general') {
                renderGeneralSettings();
            } 
            else if (sectionId === 'personalization') { 
                // Show loading message while themes are fetched
                panelContent.innerHTML = '<p>Loading themes...</p>';
                
                try {
                    // Wait for the theme data to be loaded (it might already be loaded)
                    if (!themesPromise) {
                        // This should not happen if initializePage ran, but it's a safe fallback.
                        console.warn("Themes promise not initialized, cannot load section.");
                        throw new Error("Theme loading was not initiated.");
                    }
                    
                    await themesPromise; // Wait for the fetch to complete
                    
                    // Now that themePalettes is populated, render the section
                    renderPersonalizationSettings();
                    
                } catch (error) {
                    console.error("Failed to render personalization settings:", error);
                    panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                }
            }
            // --- [MODIFICATION START] ---
            else if (sectionId === 'tab-disguiser') {
                renderTabDisguiserSettings();
            }
            else if (sectionId === 'panic-key') {
                renderPanicKeySettings();
            }
            // NEW: Privacy & Security section rendering
            else if (sectionId === 'privacy') {
                renderPrivacySettings();
            }
            // ADDED: Data Management section rendering
            else if (sectionId === 'data') {
                renderDataManagement();
            }
            // NEW: About section rendering
            else if (sectionId === 'about') {
                renderAboutSection();
            }
            // --- [MODIFICATION END] ---
            else {
                // Render placeholder for all other sections
                // --- [MODIFICATION] Replaced placeholder with "Coming Soon" ---
                panelContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center space-y-4 p-8 min-h-[40vh]">
                        <i class="fas ${section.icon} text-6xl ${section.color} opacity-50"></i>
                        <h3 class="text-2xl font-semibold text-white">${section.title}</h3>
                        <p class="text-lg text-gray-400">This section is coming soon!</p>
                    </div>
                `;
            }
            
            // 4. Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sidebar-${sectionId}`).classList.add('active');
        }
        
        // --- NEW: General Settings Implementation (omitted for brevity, remains unchanged) ---
        // ... (General Settings functions are here) ...
        
        /**
         * Renders the content for the "General" tab
         */
        function renderGeneralSettings() {
            if (!currentUser || !currentUserData) {
                panelContent.innerHTML = '<p>Loading account data...</p>';
                return;
            }

            const primaryAuthMethod = currentUserData.authMethod || 'unknown';
            const isEmailUser = primaryAuthMethod === 'email';
            
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Username</h3>
                    <label for="username-input" class="settings-label">Change Username</label>
                    <div class="flex flex-col sm:flex-row sm:items-start sm:gap-4">
                        <input type="text" id="username-input" class="settings-input" value="${currentUserData.username || ''}" placeholder="Enter new username">
                        <button id="username-save-btn" class="btn-base btn-primary-style mt-3 sm:mt-0 sm:flex-shrink-0">
                            <i class="fas fa-save mr-2"></i> Save
                        </button>
                    </div>
                    <div id="username-message" class="message-area"></div>
                    <p class="settings-description">
                        You can change your username once every 7 days. 
                        Your username must be 4-24 characters and can include: .,-+\\_!?$
                    </p>
                </div>

                ${isEmailUser ? `
                <div class="settings-section" id="password-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Change Password</h3>
                    <form id="password-change-form">
                        <div class="mb-4">
                            <label for="current-password" class="settings-label">Current Password</label>
                            <input type="password" id="current-password" class="settings-input" required autocomplete="current-password">
                            <p class="settings-description">Required to confirm your identity.</p>
                        </div>
                        <div class="mb-4">
                            <label for="new-password" class="settings-label">New Password</label>
                            <input type="password" id="new-password" class="settings-input" required autocomplete="new-password">
                        </div>
                        <div class="mb-4">
                            <label for="confirm-password" class="settings-label">Confirm New Password</label>
                            <input type="password" id="confirm-password" class="settings-input" required autocomplete="new-password">
                        </div>
                        <button type="submit" id="password-save-btn" class="btn-base btn-primary-style">
                            <i class="fas fa-key mr-2"></i> Change Password
                        </button>
                    </form>
                    <div id="password-message" class="message-area"></div>
                </div>
                ` : ''}

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Link Providers</h3>
                    <p class="settings-description mb-4">
                        Link multiple social accounts to sign in.
                    </p>
                    <div id="linking-container" class="space-y-3">
                        </div>
                    <div id="linking-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-red-400 mb-4">Danger Zone</h3>
                    <p class="settings-description mb-4">
                        Deleting your account is permanent and cannot be undone. All your data will be removed.
                    </p>
                    <button id="delete-account-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-trash-alt mr-2"></i> Delete My Account
                    </button>
                    <div id="delete-message" class="message-area"></div>
                </div>
            `;
            // --- END STYLING UPDATE ---
            
            // Now that HTML is in the DOM, attach listeners and update UI states
            attachGeneralSettingsListeners(isEmailUser);
            updateUsernameUI();
            updateAccountLinkingUI(); // Update linking UI unconditionally
        }

        // --- Helper functions for General (attachGeneralSettingsListeners, updateUsernameUI, updateAccountLinkingUI, handleAccountLink, handleAccountUnlink, checkProfanity, isUsernameTaken, handleUsernameChange, handlePasswordChange, handleAccountDelete) are omitted for brevity, they remain unchanged from the previous version. ---

        /**
         * Attaches all event listeners for the General Settings panel
         */
        function attachGeneralSettingsListeners(isEmailUser) {
            // Username
            const usernameSaveBtn = document.getElementById('username-save-btn');
            if (usernameSaveBtn) {
                usernameSaveBtn.addEventListener('click', handleUsernameChange);
            }

            // Password (only attach if it exists)
            if (isEmailUser) {
                const passwordForm = document.getElementById('password-change-form');
                if (passwordForm) {
                    passwordForm.addEventListener('submit', handlePasswordChange);
                }
            }

            // Account Deletion
            const deleteBtn = document.getElementById('delete-account-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleAccountDelete);
            }
        }
        
        /**
         * Updates the username input and button based on the cooldown
         */
        function updateUsernameUI() {
            const input = document.getElementById('username-input');
            const button = document.getElementById('username-save-btn');
            const message = document.getElementById('username-message');
            if (!input || !button || !message) return;
            
            const lastChanged = currentUserData?.usernameLastChanged?.toDate();
            if (lastChanged) {
                const now = new Date();
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                const timeSinceChange = now.getTime() - lastChanged.getTime();
                
                if (timeSinceChange < sevenDays) {
                    const remainingTime = sevenDays - timeSinceChange;
                    const days = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
                    input.disabled = true;
                    button.disabled = true;
                    message.textContent = `You can change your username again in ${days} day(s).`;
                    message.className = 'message-area message-warning';
                } else {
                    input.disabled = false;
                    button.disabled = false;
                    message.textContent = '';
                    message.className = 'message-area';
                }
            } else {
                // No timestamp, user can change it
                input.disabled = false;
                button.disabled = false;
                message.textContent = '';
                message.className = 'message-area';
            }
        }
        
        /**
         * Renders the list of linked accounts and link/unlink buttons
         */
        function updateAccountLinkingUI() {
            const container = document.getElementById('linking-container');
            if (!container) return; // Exit if the container doesn't exist
            
            const providerData = currentUser.providerData;
            const linkedProviders = providerData.map(p => p.providerId);
            
            const allProviders = [
                { id: 'google.com', name: 'Google', icon: 'fa-brands fa-google', btnClass: 'bg-[#4285F4] hover:bg-[#357afe]' },
                { id: 'github.com', name: 'GitHub', icon: 'fa-brands fa-github', btnClass: 'bg-[#333] hover:bg-[#444]' },
                { id: 'microsoft.com', name: 'Microsoft', icon: 'fa-brands fa-microsoft', btnClass: 'bg-[#00A4EF] hover:bg-[#0093d8]' }
            ];

            let html = '';
            // --- STYLING UPDATE: Replaced button classes ---
            allProviders.forEach(p => {
                const isLinked = linkedProviders.includes(p.id);
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="${p.icon} text-xl w-6 text-center"></i>
                            <span class="font-medium text-white">${p.name}</span>
                        </div>
                        ${isLinked ? `
                            <button class="btn-base text-xs" 
                                    data-provider-id="${p.id}" 
                                    onclick="window.handleAccountUnlink('${p.id}')"
                                    ${linkedProviders.length <= 1 ? 'disabled title="Cannot unlink the only sign-in method"' : ''}>
                                <i class="fas fa-times mr-2"></i> Unlink
                            </button>
                        ` : `
                            <button class="btn-base text-xs ${p.btnClass}" 
                                    data-provider-id="${p.id}"
                                    onclick="window.handleAccountLink('${p.id}')">
                                <i class="fas fa-link mr-2"></i> Link
                            </button>
                        `}
                    </div>
                `;
            });
            // --- END STYLING UPDATE ---
            container.innerHTML = html;
        }

        // Make link/unlink functions globally accessible to inline 'onclick'
        window.handleAccountLink = async (providerId) => {
            const message = document.getElementById('linking-message');
            message.textContent = 'Opening provider popup...';
            message.className = 'message-area message-warning';
            
            let provider;
            if (providerId === 'google.com') provider = new GoogleAuthProvider();
            else if (providerId === 'github.com') provider = new GithubAuthProvider();
            else if (providerId === 'microsoft.com') provider = new OAuthProvider('microsoft.com');
            else return;
            
            try {
                await linkWithPopup(currentUser, provider);
                message.textContent = 'Successfully linked account!';
                message.className = 'message-area message-success';
                // The onAuthStateChanged listener *should* pick up the new
                // providerData, but we can force a UI refresh.
                updateAccountLinkingUI(); 
            } catch (error) {
                console.error("Link error:", error);
                message.textContent = `Error: ${error.message}`;
                message.className = 'message-area message-error';
            }
        };

        window.handleAccountUnlink = async (providerId) => {
            if (currentUser.providerData.length <= 1) {
                // Use a custom modal or message instead of alert
                const message = document.getElementById('linking-message');
                message.textContent = 'You cannot unlink your only sign-in method.';
                message.className = 'message-area message-error';
                return;
            }
            
            // Re-implement confirm with a simple prompt
            const confirmed = prompt(`To unlink your ${providerId} account, type "UNLINK":`);
            if (confirmed !== 'UNLINK') {
                const message = document.getElementById('linking-message');
                message.textContent = 'Unlink cancelled.';
                message.className = 'message-area message-warning';
                return;
            }

            const message = document.getElementById('linking-message');
            message.textContent = 'Unlinking account...';
            message.className = 'message-area message-warning';

            try {
                await unlink(currentUser, providerId);
                message.textContent = 'Successfully unlinked account!';
                message.className = 'message-area message-success';
                updateAccountLinkingUI(); // Force refresh
            } catch (error) {
                console.error("Unlink error:", error);
                message.textContent = `Error: ${error.message}`;
                message.className = 'message-area message-error';
            }
        };

        // Re-usable helper for profanity/uniqueness (copied from authentication.html)
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };
        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            // Check if any document exists that IS NOT the current user's document
            let isTaken = false;
            querySnapshot.forEach(doc => {
                if (doc.id !== currentUser.uid) {
                    isTaken = true;
                }
            });
            return isTaken;
        };

        async function handleUsernameChange() {
            const input = document.getElementById('username-input');
            const button = document.getElementById('username-save-btn');
            const message = document.getElementById('username-message');
            const newUsername = input.value.trim();
            
            button.disabled = true;
            message.textContent = 'Checking...';
            message.className = 'message-area message-warning';

            // 1. Check cooldown (client-side check, server-side rules should enforce)
            const lastChanged = currentUserData?.usernameLastChanged?.toDate();
            if (lastChanged) {
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                if (new Date().getTime() - lastChanged.getTime() < sevenDays) {
                    message.textContent = 'You cannot change your username yet.';
                    message.className = 'message-area message-error';
                    button.disabled = false;
                    return;
                }
            }
            
            // 2. Check if username is the same
            if (newUsername.toLowerCase() === (currentUserData.username || '').toLowerCase()) {
                message.textContent = 'This is already your username.';
                message.className = 'message-area message-warning';
                button.disabled = false;
                return;
            }

            // 3. Validate new username
            if (newUsername.length < 4 || newUsername.length > 24) {
                message.textContent = 'Username must be 4-24 characters.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }
            if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                message.textContent = 'Username contains invalid characters.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }
            if (await checkProfanity(newUsername)) {
                message.textContent = 'This username is not allowed.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }
            if (await isUsernameTaken(newUsername)) {
                message.textContent = 'This username is already taken.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }

            // 4. All checks passed, update Firestore
            try {
                message.textContent = 'Updating username...';
                message.className = 'message-area message-warning';
                
                const userDocRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userDocRef, {
                    username: newUsername,
                    usernameLastChanged: serverTimestamp(),
                    // Store timezone and timestamp for user reference
                    usernameChangeDetails: {
                        timestamp: new Date().toISOString(),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                });

                message.textContent = 'Username successfully updated!';
                message.className = 'message-area message-success';
                // The onSnapshot listener will automatically update the UI state
                
            } catch (error) {
                console.error("Username update error:", error);
                message.textContent = 'An error occurred. Please try again.';
                message.className = 'message-area message-error';
                button.disabled = false;
            }
        }
        
        async function handlePasswordChange(e) {
            e.preventDefault();
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const button = document.getElementById('password-save-btn');
            const message = document.getElementById('password-message');
            
            message.textContent = '';
            
            if (newPass !== confirmPass) {
                message.textContent = 'New passwords do not match.';
                message.className = 'message-area message-error';
                return;
            }
            
            // Basic password validation (from authentication.html)
            if (newPass.length < 8 || newPass.length > 48) {
                message.textContent = 'Password must be 8-48 characters.';
                message.className = 'message-area message-error';
                return;
            }
            if (!/[A-Z]/.test(newPass)) {
                message.textContent = 'Password must contain an uppercase letter.';
                message.className = 'message-area message-error';
                return;
            }
            // ... (add other password rules if needed) ...

            button.disabled = true;
            message.textContent = 'Verifying identity...';
            message.className = 'message-area message-warning';
            
            try {
                // 1. Re-authenticate
                const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
                await reauthenticateWithCredential(currentUser, credential);
                
                // 2. Update password
                message.textContent = 'Changing password...';
                await updatePassword(currentUser, newPass);
                
                message.textContent = 'Password successfully updated!';
                message.className = 'message-area message-success';
                document.getElementById('password-change-form').reset();
                
            } catch (error) {
                console.error("Password change error:", error);
                if (error.code === 'auth/wrong-password') {
                    message.textContent = 'Incorrect current password.';
                } else {
                    message.textContent = `Error: ${error.message}`;
                }
                message.className = 'message-area message-error';
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleAccountDelete() {
            const message = document.getElementById('delete-message');
            const confirmed = prompt(
                'This action is permanent and cannot be undone.\n' +
                'To confirm, please type "DELETE" in all caps:'
            );
            
            if (confirmed !== 'DELETE') {
                message.textContent = 'Account deletion cancelled.';
                message.className = 'message-area message-warning';
                return;
            }
            
            message.textContent = 'Please verify your identity to proceed...';
            message.className = 'message-area message-warning';
            
            try {
                // 1. Re-authenticate
                const primaryMethod = currentUserData.authMethod || 'unknown';
                if (primaryMethod === 'email') {
                    const password = prompt("Please enter your password to confirm deletion:");
                    if (!password) {
                        message.textContent = 'Deletion cancelled.';
                        message.className = 'message-area message-warning';
                        return;
                    }
                    const credential = EmailAuthProvider.credential(currentUser.email, password);
                    await reauthenticateWithCredential(currentUser, credential);
                } else {
                    // Social provider re-auth
                    let provider;
                    if (primaryMethod === 'google.com') provider = new GoogleAuthProvider();
                    else if (primaryMethod === 'github.com') provider = new GithubAuthProvider();
                    else if (primaryMethod === 'microsoft.com') provider = new OAuthProvider('microsoft.com');
                    else throw new Error('Unknown social provider for re-authentication');
                    
                    await reauthenticateWithPopup(currentUser, provider);
                }
                
                // 2. Re-authentication successful, proceed with deletion
                message.textContent = 'Deleting account data...';
                const userDocRef = doc(db, 'users', currentUser.uid);
                
                // We should delete the Firestore doc *before* deleting the auth user
                // (or use a Cloud Function trigger)
                await setDoc(userDocRef, { _deleted: true, deletedAt: serverTimestamp() }); // Soft delete, or use deleteDoc()
                
                // 3. Delete the auth user
                await deleteUser(currentUser);
                
                // This will trigger the onAuthStateChanged listener,
                // which will redirect to the login page.
                // alert('Account successfully deleted.'); // Cannot use alert
                
            } catch (error) {
                console.error("Account deletion error:", error);
                if (error.code === 'auth/wrong-password') {
                    message.textContent = 'Incorrect password. Deletion cancelled.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                     message.textContent = 'Verification cancelled. Deletion cancelled.';
                } else {
                    message.textContent = `Error: ${error.message}`;
                }
                message.className = 'message-area message-error';
            }
        }

        /* --- START PRIVACY & SECURITY FUNCTIONS --- */

        /**
         * Renders the content for the "Privacy & Security" tab
         */
        function renderPrivacySettings() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Account Security</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Two-Factor Authentication</h4>
                                <p class="text-sm text-gray-400">Add an extra layer of security to your account</p>
                            </div>
                            <div class="setting-control">
                                <button class="btn-base btn-secondary-style" id="show-sessions-btn">
                                    <i class="fas fa-devices mr-2"></i>View Active Sessions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Data Privacy</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Analytics & Usage Data</h4>
                                <p class="text-sm text-gray-400">Help improve 4SP by sharing anonymous usage statistics</p>
                            </div>
                            <div class="setting-control">
                                <button class="btn-base btn-secondary-style" id="request-download-btn">
                                    <i class="fas fa-download mr-2"></i>Request Download
                                </button>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-red-400">Delete Account</h4>
                                <p class="text-sm text-gray-400">Permanently delete your account and all associated data</p>
                            </div>
                            <div class="setting-control">
                                <button class="btn-base btn-danger-style" id="initiate-delete-btn">
                                    <i class="fas fa-trash mr-2"></i>Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // --- END STYLING UPDATE ---

            // Add event listeners for privacy settings
            setupPrivacyEventListeners();
        }

        function setupPrivacyEventListeners() {
            // Load saved privacy settings
            loadPrivacySettings();

            // Add change listeners
            document.getElementById('login-notifications-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('analytics-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('location-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('ai-processing-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('marketing-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('research-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('data-retention-select').addEventListener('change', savePrivacySettings);

            // Button listeners
            document.getElementById('show-sessions-btn').addEventListener('click', showActiveSessions);
            document.getElementById('request-download-btn').addEventListener('click', requestDataDownload);
            document.getElementById('initiate-delete-btn').addEventListener('click', initiateAccountDeletion);
        }

        function loadPrivacySettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('privacy-settings') || '{}');

                // Set toggle states
                document.getElementById('login-notifications-toggle').checked = settings.loginNotifications !== false;
                document.getElementById('analytics-toggle').checked = settings.analytics !== false;
                document.getElementById('location-toggle').checked = settings.location === true;
                document.getElementById('ai-processing-toggle').checked = settings.aiProcessing !== false;
                document.getElementById('marketing-toggle').checked = settings.marketing === true;
                document.getElementById('research-toggle').checked = settings.research === true;

                // Set data retention
                if (settings.dataRetention) {
                    document.getElementById('data-retention-select').value = settings.dataRetention;
                }
            } catch (error) {
                console.error('Error loading privacy settings:', error);
            }
        }

        function savePrivacySettings() {
            try {
                const settings = {
                    loginNotifications: document.getElementById('login-notifications-toggle').checked,
                    analytics: document.getElementById('analytics-toggle').checked,
                    location: document.getElementById('location-toggle').checked,
                    aiProcessing: document.getElementById('ai-processing-toggle').checked,
                    marketing: document.getElementById('marketing-toggle').checked,
                    research: document.getElementById('research-toggle').checked,
                    dataRetention: document.getElementById('data-retention-select').value
                };

                localStorage.setItem('privacy-settings', JSON.stringify(settings));

                // Show success message briefly
                showPrivacyMessage('Privacy settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving privacy settings:', error);
                showPrivacyMessage('Error saving privacy settings', 'error');
            }
        }

        function showPrivacyMessage(message, type) {
            // Create or update message element
            let messageEl = document.getElementById('privacy-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'privacy-message';
                messageEl.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300';
                document.body.appendChild(messageEl);
            }

            messageEl.textContent = message;
            messageEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;

            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (messageEl) {
                    messageEl.remove();
                }
            }, 3000);
        }

        function showActiveSessions() {
            // Cannot use alert
            showPrivacyMessage('Active Sessions feature coming soon!', 'warning');
        }

        function requestDataDownload() {
            // Cannot use alert
            showPrivacyMessage('Data download feature coming soon!', 'warning');
        }

        function initiateAccountDeletion() {
            // Cannot use alert, redirect to general tab's delete button
            showPrivacyMessage('Please use the "Delete My Account" button in the General tab.', 'error');
            loadSection('general');
            // Scroll to the bottom
            setTimeout(() => {
                document.getElementById('delete-account-btn').scrollIntoView({ behavior: 'smooth' });
                document.getElementById('delete-account-btn').focus();
            }, 100);
        }

        /* --- START PERSONALIZATION FUNCTIONS (EXACTLY AS REQUESTED) --- */
        
        /**
         * Renders the content for the "Personalization" tab
         * (This function now assumes themePalettes is already populated)
         */
        function renderPersonalizationSettings() {
            // Helper function to get the currently saved theme
            function getCurrentTheme() {
                try {
                    const savedThemeString = localStorage.getItem(NAVBAR_SETTINGS_KEY);
                    if (savedThemeString) {
                        return JSON.parse(savedThemeString);
                    }
                } catch (e) {
                    console.error("Could not parse saved theme:", e);
                }
                // Use the (now loaded) themePalettes
                return themePalettes ? themePalettes[0] : {}; // Return default or empty
            }

            // Helper to compare two theme objects (by name, which should be unique)
            function areThemesEqual(themeA, themeB) {
                return themeA && themeB && themeA.name === themeB.name;
            }

            const currentTheme = getCurrentTheme();
            
            let swatchesHtml = '';
            // Check if themePalettes is loaded
            if (!themePalettes) {
                panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                return;
            }

            themePalettes.forEach((theme, index) => {
                const isSelected = areThemesEqual(theme, currentTheme);
                swatchesHtml += `
                    <div class="color-option ${isSelected ? 'selected' : ''}" 
                         data-theme-index="${index}"
                         title="${theme.name}"
                         style="background-color: ${theme['navbar-bg']}; border-color: ${theme['navbar-border']};">
                         <span style="color: ${theme['tab-active-text']}; text-shadow: 0 1px 2px ${theme['navbar-bg']};">${theme.name}</span>
                    </div>
                `;
            });
            
            // --- STYLING UPDATE: Replaced button classes ---
            // Enhanced personalization with user profile customization
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">User Profile</h3>
                    <div class="space-y-6">
                        <div class="profile-avatar-section">
                            <h4 class="text-lg font-medium text-white mb-3">Profile Avatar</h4>
                            <div class="flex items-center space-x-6">
                                <div class="avatar-preview">
                                    <div id="current-avatar" class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center text-2xl font-bold text-white">
                                        ${getCurrentAvatar()}
                                    </div>
                                </div>
                                <div class="avatar-options space-y-3">
                                    <div class="avatar-type-selector">
                                        <label class="text-sm text-gray-300 mb-2 block">Avatar Type:</label>
                                        <select id="avatar-type-select" class="form-select">
                                            <option value="letter">Letter</option>
                                            <option value="number">Number</option>
                                            <option value="emoji">Emoji</option>
                                            <option value="image">Custom Image</option>
                                        </select>
                                    </div>
                                    <div id="avatar-input-container" class="avatar-input">
                                        </div>
                                    <div id="image-upload-container" class="hidden">
                                        <input type="file" id="avatar-image-input" accept="image/*" class="hidden">
                                        <button class="btn-base btn-secondary-style" onclick="document.getElementById('avatar-image-input').click()">
                                            <i class="fas fa-upload mr-2"></i>Upload Image
                                        </button>
                                        <div id="image-crop-container" class="hidden mt-4">
                                            <canvas id="crop-canvas" class="border border-gray-600 rounded"></canvas>
                                            <div class="mt-2 space-x-2">
                                                <button class="btn-base btn-primary-style" onclick="applyCroppedImage()">Apply</button>
                                                <button class="btn-base btn-secondary-style" onclick="cancelImageCrop()">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-display-section">
                            <h4 class="text-lg font-medium text-white mb-3">Display Preferences</h4>
                            <div class="space-y-4">
                                <div class="setting-item">
                                    <div class="setting-header">
                                        <h5 class="text-md font-medium text-white">Show Avatar in Navigation</h5>
                                        <p class="text-sm text-gray-400">Display your avatar in the top navigation bar</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="show-avatar-nav-toggle" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-header">
                                        <h5 class="text-md font-medium text-white">Avatar Background Color</h5>
                                        <p class="text-sm text-gray-400">Choose a background color for letter/number avatars</p>
                                    </div>
                                    <div class="setting-control">
                                        <input type="color" id="avatar-bg-color" value="#6b7280" class="w-12 h-8 rounded border-0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Navigation Bar Theme</h3>
                    <p class="settings-description mb-4">
                        Choose a theme for the top navigation bar. Your selection will be applied instantly and saved locally in your browser.
                    </p>
                    <div id="theme-palette" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                        ${swatchesHtml}
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Interface Preferences</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Animations</h4>
                                <p class="text-sm text-gray-400">Enable smooth animations and transitions</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="animations-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Compact Mode</h4>
                                <p class="text-sm text-gray-400">Use a more compact layout to fit more content</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compact-mode-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Font Size</h4>
                                <p class="text-sm text-gray-400">Adjust the base font size for better readability</p>
                            </div>
                            <div class="setting-control">
                                <select id="font-size-select" class="form-select">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                    <option value="extra-large">Extra Large</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            // --- END STYLING UPDATE ---
            
            // Attach event listeners
            attachPersonalizationListeners();
        }

        /**
         * Gets the current avatar display value
         */
        function getCurrentAvatar() {
            try {
                const avatarSettings = JSON.parse(localStorage.getItem('user-avatar-settings') || '{}');
                return avatarSettings.display || currentUserData?.username?.charAt(0)?.toUpperCase() || 'U';
            } catch (error) {
                return currentUserData?.username?.charAt(0)?.toUpperCase() || 'U';
            }
        }

        /**
         * Attaches event listeners for the Personalization panel
         */
        function attachPersonalizationListeners() {
            // Load saved personalization settings
            loadPersonalizationSettings();

            // Avatar type selector
            document.getElementById('avatar-type-select').addEventListener('change', updateAvatarInput);

            // Avatar input changes
            document.getElementById('avatar-bg-color').addEventListener('change', updateAvatarPreview);

            // Interface preference toggles
            document.getElementById('show-avatar-nav-toggle').addEventListener('change', savePersonalizationSettings);
            document.getElementById('animations-toggle').addEventListener('change', savePersonalizationSettings);
            document.getElementById('compact-mode-toggle').addEventListener('change', savePersonalizationSettings);
            document.getElementById('font-size-select').addEventListener('change', savePersonalizationSettings);

            // Image upload
            document.getElementById('avatar-image-input').addEventListener('change', handleImageUpload);

            // Initialize avatar input
            updateAvatarInput();

            // Swatch click listener (for live preview AND immediate save)
            document.querySelectorAll('#theme-palette .color-option').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    // 1. Remove 'selected' from all and add to clicked
                    document.querySelectorAll('#theme-palette .color-option').forEach(s => s.classList.remove('selected'));
                    const selectedSwatch = e.currentTarget;
                    selectedSwatch.classList.add('selected');
                    
                    // 2. Get theme data
                    const themeIndex = selectedSwatch.dataset.themeIndex;
                    const theme = themePalettes[themeIndex];
                    
                    if (window.applyTheme) {
                        // 3. Apply theme for live preview
                        window.applyTheme(theme);
                        
                        // 4. Save theme to local storage immediately
                        try {
                            // If it's the default theme (index 0), just remove the key (effectively setting default)
                            if (parseInt(themeIndex) === 0) {
                                localStorage.removeItem(NAVBAR_SETTINGS_KEY);
                            } else {
                                // Save the selected theme object
                                localStorage.setItem(NAVBAR_SETTINGS_KEY, JSON.stringify(theme));
                            }
                        } catch (error) {
                            console.error("Error saving theme to Local Storage:", error);
                            // In a full implementation, you might want a non-blocking temporary message here
                        }
                        
                    } else {
                        console.error("window.applyTheme is not defined. Make sure navigation.js is loaded.");
                    }
                });
            });
            
            // REMOVED event listeners for 'theme-save-btn' and 'theme-reset-btn'
        }

        /**
         * Updates the avatar input based on selected type
         */
        function updateAvatarInput() {
            const avatarType = document.getElementById('avatar-type-select').value;
            const container = document.getElementById('avatar-input-container');
            const imageContainer = document.getElementById('image-upload-container');

            // Hide image upload by default
            imageContainer.classList.add('hidden');

            switch (avatarType) {
                case 'letter':
                    container.innerHTML = `
                        <label class="text-sm text-gray-300 mb-1 block">Letter:</label>
                        <input type="text" id="avatar-letter-input" maxlength="1"
                               class="form-input w-16 text-center uppercase"
                               placeholder="A" value="${getCurrentAvatar()}">
                    `;
                    document.getElementById('avatar-letter-input').addEventListener('input', updateAvatarPreview);
                    break;
                case 'number':
                    container.innerHTML = `
                        <label class="text-sm text-gray-300 mb-1 block">Number:</label>
                        <input type="number" id="avatar-number-input" min="0" max="99"
                               class="form-input w-16 text-center"
                               placeholder="1" value="${getCurrentAvatar()}">
                    `;
                    document.getElementById('avatar-number-input').addEventListener('input', updateAvatarPreview);
                    break;
                case 'emoji':
                    container.innerHTML = `
                        <label class="text-sm text-gray-300 mb-1 block">Emoji:</label>
                        <div class="emoji-picker">
                            <input type="text" id="avatar-emoji-input" maxlength="2"
                                   class="form-input w-16 text-center"
                                   placeholder="" value="${getCurrentAvatar()}">
                            <div class="emoji-suggestions mt-2 grid grid-cols-6 gap-1">
                                ${['', '', '', '', '', '', '', '', '', '', '', ''].map(emoji =>
                                    `<button class="emoji-btn p-1 hover:bg-gray-700 rounded" onclick="selectEmoji('${emoji}')">${emoji}</button>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('avatar-emoji-input').addEventListener('input', updateAvatarPreview);
                    break;
                case 'image':
                    container.innerHTML = `<p class="text-sm text-gray-400">Upload a custom image below:</p>`;
                    imageContainer.classList.remove('hidden');
                    break;
            }

            updateAvatarPreview();
        }

        /**
         * Updates the avatar preview
         */
        function updateAvatarPreview() {
            const avatarType = document.getElementById('avatar-type-select').value;
            const preview = document.getElementById('current-avatar');
            const bgColor = document.getElementById('avatar-bg-color').value;

            let displayValue = '';

            switch (avatarType) {
                case 'letter':
                    const letterInput = document.getElementById('avatar-letter-input');
                    displayValue = letterInput ? letterInput.value.toUpperCase() : 'A';
                    break;
                case 'number':
                    const numberInput = document.getElementById('avatar-number-input');
                    displayValue = numberInput ? numberInput.value : '1';
                    break;
                case 'emoji':
                    const emojiInput = document.getElementById('avatar-emoji-input');
                    displayValue = emojiInput ? emojiInput.value : '';
                    break;
                case 'image':
                    // Handle image preview separately
                    return;
            }

            preview.textContent = displayValue;
            preview.style.backgroundColor = bgColor;

            // Save avatar settings
            saveAvatarSettings(avatarType, displayValue, bgColor);
        }

        /**
         * Selects an emoji for the avatar
         */
        // Make sure it's globally accessible for the onclick attribute
        window.selectEmoji = (emoji) => {
            document.getElementById('avatar-emoji-input').value = emoji;
            updateAvatarPreview();
        }

        /**
         * Handles image upload for avatar
         */
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                // Cannot use alert
                showPersonalizationMessage('Please select a valid image file.', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                showImageCropper(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        /**
         * Shows the image cropper
         */
        function showImageCropper(imageSrc) {
            const container = document.getElementById('image-crop-container');
            const canvas = document.getElementById('crop-canvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() {
                // Set canvas size
                const size = 200;
                canvas.width = size;
                canvas.height = size;

                // Calculate crop dimensions (center square)
                const minDim = Math.min(img.width, img.height);
                const x = (img.width - minDim) / 2;
                const y = (img.height - minDim) / 2;

                // Draw cropped image
                ctx.drawImage(img, x, y, minDim, minDim, 0, 0, size, size);

                container.classList.remove('hidden');
            };
            img.src = imageSrc;
        }

        /**
         * Applies the cropped image as avatar
         */
        window.applyCroppedImage = () => {
            const canvas = document.getElementById('crop-canvas');
            const dataURL = canvas.toDataURL('image/png');

            // Update preview
            const preview = document.getElementById('current-avatar');
            preview.innerHTML = `<img src="${dataURL}" class="w-full h-full rounded-full object-cover">`;
            preview.style.backgroundColor = 'transparent'; // Remove bg color for image

            // Save avatar settings
            saveAvatarSettings('image', dataURL, null);

            // Hide cropper
            cancelImageCrop();
        }

        /**
         * Cancels image cropping
         */
        window.cancelImageCrop = () => {
            document.getElementById('image-crop-container').classList.add('hidden');
            document.getElementById('avatar-image-input').value = '';
        }

        /**
         * Saves avatar settings to localStorage
         */
        function saveAvatarSettings(type, display, bgColor) {
            try {
                const settings = {
                    type: type,
                    display: display,
                    bgColor: bgColor,
                    timestamp: Date.now()
                };
                localStorage.setItem('user-avatar-settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving avatar settings:', error);
            }
        }

        /**
         * Loads personalization settings
         */
        function loadPersonalizationSettings() {
            try {
                // Load avatar settings
                const avatarSettings = JSON.parse(localStorage.getItem('user-avatar-settings') || '{}');
                if (avatarSettings.type) {
                    document.getElementById('avatar-type-select').value = avatarSettings.type;
                }
                if (avatarSettings.bgColor) {
                    document.getElementById('avatar-bg-color').value = avatarSettings.bgColor;
                }
                
                // If type is image, update preview
                if(avatarSettings.type === 'image' && avatarSettings.display) {
                    const preview = document.getElementById('current-avatar');
                    preview.innerHTML = `<img src="${avatarSettings.display}" class="w-full h-full rounded-full object-cover">`;
                    preview.style.backgroundColor = 'transparent';
                }

                // Load interface settings
                const interfaceSettings = JSON.parse(localStorage.getItem('interface-settings') || '{}');
                document.getElementById('show-avatar-nav-toggle').checked = interfaceSettings.showAvatarNav !== false;
                document.getElementById('animations-toggle').checked = interfaceSettings.animations !== false;
                document.getElementById('compact-mode-toggle').checked = interfaceSettings.compactMode === true;

                if (interfaceSettings.fontSize) {
                    document.getElementById('font-size-select').value = interfaceSettings.fontSize;
                }

                // Apply settings on load
                applyInterfaceSettings(interfaceSettings);

            } catch (error) {
                console.error('Error loading personalization settings:', error);
            }
        }

        /**
         * Saves personalization settings
         */
        function savePersonalizationSettings() {
            try {
                const settings = {
                    showAvatarNav: document.getElementById('show-avatar-nav-toggle').checked,
                    animations: document.getElementById('animations-toggle').checked,
                    compactMode: document.getElementById('compact-mode-toggle').checked,
                    fontSize: document.getElementById('font-size-select').value
                };

                localStorage.setItem('interface-settings', JSON.stringify(settings));

                // Apply settings immediately
                applyInterfaceSettings(settings);

                // Show success message
                showPersonalizationMessage('Interface settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving interface settings:', error);
                showPersonalizationMessage('Error saving interface settings', 'error');
            }
        }

        /**
         * Applies interface settings to the page
         */
        function applyInterfaceSettings(settings) {
            const body = document.body;

            // Apply animations
            if (!settings.animations) {
                body.style.setProperty('--transition-duration', '0s');
            } else {
                body.style.removeProperty('--transition-duration');
            }

            // Apply compact mode
            if (settings.compactMode) {
                body.classList.add('compact-mode');
            } else {
                body.classList.remove('compact-mode');
            }

            // Apply font size
            const fontSizeMap = {
                'small': '14px',
                'medium': '16px',
                'large': '18px',
                'extra-large': '20px'
            };
            body.style.fontSize = fontSizeMap[settings.fontSize] || '16px';
        }

        /**
         * Shows a personalization message
         */
        function showPersonalizationMessage(message, type) {
            let messageEl = document.getElementById('personalization-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'personalization-message';
                messageEl.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300';
                document.body.appendChild(messageEl);
            }

            messageEl.textContent = message;
            messageEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;

            setTimeout(() => {
                if (messageEl) {
                    messageEl.remove();
                }
            }, 3000);
        }

        /* --- END PERSONALIZATION FUNCTIONS --- */
        
        /* --- [START] UPDATED TAB DISGUISER FUNCTIONS (to work with url-tab-title-changer.js) --- */

        /**
         * Renders the Tab Disguiser settings
         */
        function renderTabDisguiserSettings() {
            // Check if urlChanger object is available
            if (typeof window.urlChanger === 'undefined') {
                panelContent.innerHTML = `<p class="message-area message-error">Error: <code>url-tab-title-changer.js</code> script not loaded. Tab Disguiser settings cannot be managed.</p>`;
                return;
            }

            // Build options from the live urlChanger object
            let selectOptions = `
                <option value="none" data-favicon="../favicon.ico">None (Default)</option>
            `;

            // Get presets from urlChanger
            const websitePresets = window.urlChanger.presets.filter(p => p.category === 'websites');
            const livePresets = window.urlChanger.presets.filter(p => p.category === 'live');

            if (websitePresets.length > 0) {
                selectOptions += `<optgroup label="Websites">`;
                websitePresets.forEach(preset => {
                    selectOptions += `<option value="${preset.id}" data-favicon="${preset.favicon}">${preset.name}</option>`;
                });
                selectOptions += `</optgroup>`;
            }
            
            if (livePresets.length > 0) {
                selectOptions += `<optgroup label="Live">`;
                livePresets.forEach(preset => {
                    selectOptions += `<option value="${preset.id}" data-favicon="">${preset.name}</option>`;
                });
                selectOptions += `</optgroup>`;
            }

            selectOptions += `
                <optgroup label="4SP">
            `;
            FOURSP_ICONS.forEach((icon, index) => {
                // Use a unique ID for 4SP icons
                const id = `4sp-${index}`;
                selectOptions += `<option value="${id}" data-favicon="${icon.url}">${icon.name}</option>`;
            });
            selectOptions += `</optgroup>`;
            
            selectOptions += `<option value="custom" data-favicon="">Custom</option>`;

            let fourspPickerHtml = FOURSP_ICONS.map((icon) => `
                <div class="favicon-picker-item" data-favicon-url="${icon.url}" data-picker="4sp" title="${icon.name}">
                    <img src="${icon.url}" alt="${icon.name}">
                </div>
            `).join('');
            
            let presetPickerHtml = websitePresets.map(preset => `
                <div class="favicon-picker-item" data-favicon-url="${preset.favicon}" data-picker="preset" title="${preset.name}">
                    <img src="${preset.favicon}" alt="${preset.name}">
                </div>
            `).join('');

            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Tab Disguiser</h3>
                    <p class="settings-description mb-4">
                        Change the appearance of the browser tab to blend in. This setting is applied instantly and saved locally on this browser.
                    </p>
                    
                    <div class="setting-item">
                        <div class="setting-header">
                            <h4 class="text-lg font-medium text-white">Preset Selection</h4>
                            <p class="text-sm text-gray-400">Choose a preset disguise or create a custom one.</p>
                        </div>
                        <div class="setting-control">
                            <select id="disguise-preset-select" class="form-select settings-input-width">
                                ${selectOptions}
                            </select>
                        </div>
                    </div>
                </div>

                <div id="custom-disguise-options" class="settings-section hidden">
                    <h3 class="text-xl font-semibold text-white mb-4">Customize Your Tab</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label for="custom-title-input" class="settings-label">Custom Title</label>
                            <input type="text" id="custom-title-input" class="form-input settings-input-width" placeholder="Enter a title...">
                        </div>
                        
                        <div>
                            <label class="settings-label">Custom Favicon</label>
                            <p class="settings-description mb-2">
                                Choose a 4SP icon, fetch a new one, or select a preset/previously fetched icon.
                            </p>
                            
                            <label class="settings-label text-sm text-gray-300">4SP Icons</label>
                            <div id="favicon-picker-4sp" class="favicon-picker-grid settings-input-width mb-4">
                                ${fourspPickerHtml}
                            </div>
                            
                            <label for="favicon-fetch-input" class="settings-label text-sm text-gray-300">Fetch New Favicon from URL</label>
                            <div class="flex items-center gap-2" style="max-width: 500px;">
                                <input type="text" id="favicon-fetch-input" class="form-input flex-grow" placeholder="e.g., google.com">
                                <button id="fetch-favicon-btn" class="btn-base btn-primary-style">Fetch</button>
                                <div id="favicon-fetch-preview" class="favicon-fetch-preview">
                                    <img src="" alt="Preview" class="hidden">
                                </div>
                            </div>
                            <p class="settings-description mb-4">Not all website icons may be available to fetch.</p>

                            <label class="settings-label text-sm text-gray-300">Preset & Saved Icons</label>
                            <div id="favicon-picker-custom" class="favicon-picker-grid settings-input-width">
                                ${presetPickerHtml}
                                <!-- Custom fetched icons will be added here by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <button id="save-tab-disguise-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-save mr-2"></i> Apply Changes
                    </button>
                    <div id="tab-disguise-message" class="message-area"></div>
                </div>
            `;
            // --- END STYLING UPDATE ---

            renderCustomFaviconGrid(); // Render the grid of custom/preset icons
            attachTabDisguiserListeners();
        }
        
        /**
         * Renders the grid of custom-fetched and preset favicons
         */
        function renderCustomFaviconGrid() {
            if (typeof window.urlChanger === 'undefined') return;

            const container = document.getElementById('favicon-picker-custom');
            if (!container) return; // Not on the tab disguiser page

            container.innerHTML = ''; // Clear it
            let html = '';

            // 1. Add presets first
            const websitePresets = window.urlChanger.presets.filter(p => p.category === 'websites');
            html += websitePresets.map(preset => `
                <div class="favicon-picker-item" data-favicon-url="${preset.favicon}" data-picker="preset" title="${preset.name}">
                    <img src="${preset.favicon}" alt="${preset.name}">
                </div>
            `).join('');

            // 2. Add custom favicons from urlChanger
            // Ensure customFavicons is loaded (it should be by init)
            if (!window.urlChanger.customFavicons) {
                window.urlChanger.loadCustomFavicons();
            }
            
            html += window.urlChanger.customFavicons.map(iconUrl => `
                <div class="favicon-picker-item" data-favicon-url="${iconUrl}" data-picker="custom" title="Custom Icon">
                    <img src="${iconUrl}" alt="Custom Icon">
                    <button class="favicon-delete-btn" data-favicon-url="${iconUrl}" title="Remove">&times;</button>
                </div>
            `).join('');
            
            container.innerHTML = html;
            
            // Re-attach listeners for these new items
            attachPickerItemListeners(container);
        }
        
        /**
         * Attaches click listeners to all favicon picker items
         */
        function attachPickerItemListeners(container) {
             container.querySelectorAll('.favicon-picker-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.classList.contains('favicon-delete-btn')) {
                        // Handle delete click
                        const url = e.target.dataset.faviconUrl;
                        if (window.urlChanger) {
                            window.urlChanger.removeCustomFavicon(url);
                            renderCustomFaviconGrid(); // Re-render grid
                        }
                        return; // Stop propagation
                    }
                    
                    // Deselect other selected items in *all* pickers
                    document.querySelectorAll('.favicon-picker-item.selected').forEach(selected => {
                        selected.classList.remove('selected');
                    });
                    // Select this item
                    item.classList.add('selected');
                    
                    // Clear fetch input
                    document.getElementById('favicon-fetch-input').value = '';
                    document.getElementById('favicon-fetch-preview').querySelector('img').classList.add('hidden');
                });
            });
        }

        /**
         * Attaches listeners for the new Tab Disguiser UI
         */
        function attachTabDisguiserListeners() {
            const presetSelect = document.getElementById('disguise-preset-select');
            const customOptions = document.getElementById('custom-disguise-options');
            const saveBtn = document.getElementById('save-tab-disguise-btn');
            const fetchBtn = document.getElementById('fetch-favicon-btn');

            presetSelect.addEventListener('change', () => {
                if (presetSelect.value === 'custom') {
                    customOptions.classList.remove('hidden');
                } else {
                    customOptions.classList.add('hidden');
                }
            });

            saveBtn.addEventListener('click', saveTabDisguiserSettings);
            fetchBtn.addEventListener('click', handleFaviconFetch);

            // Add click listeners to 4SP picker items
            attachPickerItemListeners(document.getElementById('favicon-picker-4sp'));

            loadTabDisguiserSettings();
        }

        /**
         * Loads the saved Tab Disguiser settings from localStorage
         */
        function loadTabDisguiserSettings() {
            if (typeof window.urlChanger === 'undefined') return;

            try {
                // Read from the key url-tab-title-changer.js uses
                const savedSettingsJSON = localStorage.getItem('selectedUrlPreset');
                const presetSelect = document.getElementById('disguise-preset-select');
                
                let settings = { type: 'none' };
                if (savedSettingsJSON) {
                    try { settings = JSON.parse(savedSettingsJSON); } catch(e) {}
                }

                if (settings.type === 'custom') {
                    presetSelect.value = 'custom';
                    document.getElementById('custom-disguise-options').classList.remove('hidden');
                    document.getElementById('custom-title-input').value = settings.title || '';
                    
                    if (settings.favicon) {
                        // Check all pickers for this favicon
                        const item = document.querySelector(`.favicon-picker-item[data-favicon-url="${settings.favicon}"]`);
                        if (item) {
                            item.classList.add('selected');
                        } else {
                            // If it was a fetched icon not in the lists, show it in the preview
                            const previewImg = document.getElementById('favicon-fetch-preview').querySelector('img');
                            previewImg.src = settings.favicon;
                            previewImg.classList.remove('hidden');
                        }
                    }
                } else if (settings.type === 'preset' && settings.id) {
                    // Check if it's a 4SP icon
                    const fourspIcon = FOURSP_ICONS.find(icon => icon.url === settings.favicon);
                    if (fourspIcon) {
                        const fourspIndex = FOURSP_ICONS.indexOf(fourspIcon);
                        presetSelect.value = `4sp-${fourspIndex}`;
                    } else {
                        // Check standard presets
                         const option = presetSelect.querySelector(`option[value="${settings.id}"]`);
                        if (option) {
                            presetSelect.value = settings.id;
                        } else {
                            presetSelect.value = 'none';
                        }
                    }
                } else {
                    presetSelect.value = 'none';
                }
            } catch (error) {
                console.error('Error loading tab disguiser settings:', error);
            }
        }

        /**
         * Saves the Tab Disguiser settings using urlChanger object
         */
        function saveTabDisguiserSettings() {
            const messageEl = document.getElementById('tab-disguise-message');
            if (typeof window.urlChanger === 'undefined') {
                messageEl.textContent = 'Error: urlChanger script not found.';
                messageEl.className = 'message-area message-error';
                return;
            }

            try {
                const presetSelect = document.getElementById('disguise-preset-select');
                const selectedOption = presetSelect.options[presetSelect.selectedIndex];
                const value = presetSelect.value;
                
                let settingsToSave = {};

                if (value === 'custom') {
                    settingsToSave.type = 'custom';
                    settingsToSave.title = document.getElementById('custom-title-input').value.trim();
                    
                    const selectedPickerItem = document.querySelector('.favicon-picker-item.selected');
                    const fetchedPreviewImg = document.getElementById('favicon-fetch-preview').querySelector('img');

                    if (selectedPickerItem) {
                        settingsToSave.favicon = selectedPickerItem.dataset.faviconUrl;
                    } else if (!fetchedPreviewImg.classList.contains('hidden') && fetchedPreviewImg.src) {
                        settingsToSave.favicon = fetchedPreviewImg.src;
                    } else {
                        settingsToSave.favicon = ''; // Use original favicon
                    }

                } else if (value === 'none') {
                    settingsToSave.type = 'none';
                    settingsToSave.id = 'none';
                } else {
                    // It's a preset (from urlChanger, or one of our 4SP icons)
                    settingsToSave.type = 'preset';
                    settingsToSave.id = value;
                    
                    // Re-find the preset/icon from the loaded data
                    let preset = window.urlChanger.presets.find(p => p.id === value);
                    if (!preset) {
                        // Check 4SP icons
                        if (value.startsWith('4sp-')) {
                            const index = parseInt(value.split('-')[1]);
                            const icon = FOURSP_ICONS[index];
                            if (icon) {
                                preset = { id: value, name: icon.name, title: window.urlChanger.originalTitle, favicon: icon.url };
                            }
                        }
                    }
                    
                    if(preset) {
                        // Use the title from the preset, or original title for 4SP icons
                        settingsToSave.title = preset.title || window.urlChanger.originalTitle;
                        settingsToSave.favicon = preset.favicon;
                    } else {
                         throw new Error("Could not find preset data for: " + value);
                    }
                }

                // Use the urlChanger's save method to apply AND save
                window.urlChanger.savePreset(settingsToSave);

                messageEl.textContent = 'Tab disguiser settings applied!';
                messageEl.className = 'message-area message-success';

            } catch (error) {
                console.error('Error saving tab disguiser settings:', error);
                messageEl.textContent = 'Error saving settings: ' + error.message;
                messageEl.className = 'message-area message-error';
            }
        }

        /**
         * Handles the "Fetch Favicon" button click
         */
        async function handleFaviconFetch() {
            if (typeof window.urlChanger === 'undefined') return;

            const input = document.getElementById('favicon-fetch-input');
            const button = document.getElementById('fetch-favicon-btn');
            const previewImg = document.getElementById('favicon-fetch-preview').querySelector('img');
            const messageEl = document.getElementById('tab-disguise-message');
            let domain = input.value.trim();
            
            if (!domain) {
                messageEl.textContent = 'Please enter a website URL.';
                messageEl.className = 'message-area message-error';
                return;
            }
            
            button.disabled = true;
            button.textContent = '...';
            messageEl.textContent = 'Fetching...';
            messageEl.className = 'message-area message-warning';
            
            try {
                // Use the fetchFavicon method from url-tab-title-changer.js
                const faviconUrl = await window.urlChanger.fetchFavicon(domain);

                previewImg.src = faviconUrl;
                previewImg.classList.remove('hidden');
                
                // Deselect any picker items
                document.querySelectorAll('.favicon-picker-item.selected').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Add to custom favicons and re-render grid
                window.urlChanger.addCustomFavicon(faviconUrl);
                renderCustomFaviconGrid();

                messageEl.textContent = 'Favicon found! It has been added to your saved icons.';
                messageEl.className = 'message-area message-success';

            } catch (error) {
                console.error('Fetch favicon error:', error);
                messageEl.textContent = `Could not fetch favicon: ${error.message}`;
                messageEl.className = 'message-area message-error';
                previewImg.classList.add('hidden');
            } finally {
                button.disabled = false;
                button.textContent = 'Fetch';
            }
        }

        /* --- [END] UPDATED TAB DISGUISER FUNCTIONS --- */


        /* --- [START] UPDATED PANIC KEY FUNCTIONS (to work with panic-key.js IndexedDB) --- */

        /**
         * Opens the IndexedDB specified in panic-key.js
         * @returns {Promise<IDBDatabase>} A promise that resolves with the database object.
         */
        function openPanicKeyDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(PANIC_KEY_DB_NAME);

                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(PANIC_KEY_STORE_NAME)) {
                        db.createObjectStore(PANIC_KEY_STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        /**
         * Renders the Panic Key settings
         */
        function renderPanicKeySettings() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Panic Key Configuration</h3>
                    <p class="settings-description mb-4">
                        Configure up to 3 single-key shortcuts that will instantly redirect you to a specified URL.
                        These settings are stored locally in this browser's IndexedDB.
                    </p>
                    
                    <div class="setting-item">
                        <div class="setting-header">
                            <h4 class="text-lg font-medium text-white">Number of Panic Keys</h4>
                            <p class="text-sm text-gray-400">Select how many keys you want to activate.</p>
                        </div>
                        <div class="setting-control">
                            <select id="panic-key-count" class="form-select w-32">
                                <option value="0">None</option>
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="panic-key-group-1" class="settings-section hidden space-y-4">
                    <h4 class="text-lg font-semibold text-white">Panic Key 1</h4>
                    <div class="setting-item">
                        <label for="panicKey1" class="setting-header">Key (Single, non-special character)</label>
                        <input type="text" id="panicKey1" class="form-input w-24 text-center" placeholder="e.g., p" maxlength="1">
                    </div>
                    <div class="setting-item">
                        <label for="panicUrl1" class="setting-header">Redirect URL</label>
                        <input type="text" id="panicUrl1" class="form-input settings-input-width" placeholder="e.g., google.com">
                    </div>
                </div>
                
                <div id="panic-key-group-2" class="settings-section hidden space-y-4">
                    <h4 class="text-lg font-semibold text-white">Panic Key 2</h4>
                    <div class="setting-item">
                        <label for="panicKey2" class="setting-header">Key (Single, non-special character)</label>
                        <input type="text" id="panicKey2" class="form-input w-24 text-center" placeholder="e.g., q" maxlength="1">
                    </div>
                    <div class="setting-item">
                        <label for="panicUrl2" class="setting-header">Redirect URL</label>
                        <input type="text" id="panicUrl2" class="form-input settings-input-width" placeholder="e.g., wikipedia.org">
                    </div>
                </div>
                
                <div id="panic-key-group-3" class="settings-section hidden space-y-4">
                    <h4 class="text-lg font-semibold text-white">Panic Key 3</h4>
                    <div class="setting-item">
                        <label for="panicKey3" class="setting-header">Key (Single, non-special character)</label>
                        <input type="text" id="panicKey3" class="form-input w-24 text-center" placeholder="e.g., \`" maxlength="1">
                    </div>
                    <div class="setting-item">
                        <label for="panicUrl3" class="setting-header">Redirect URL</label>
                        <input type="text" id="panicUrl3" class="form-input settings-input-width" placeholder="e.g., clever.com">
                    </div>
                </div>
                
                <div class="settings-section">
                    <button id="save-panic-keys-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-save mr-2"></i> Save Panic Keys
                    </button>
                    <div id="panic-key-message" class="message-area"></div>
                </div>
            `;
            // --- END STYLING UPDATE ---
            attachPanicKeyListeners();
        }

        /**
         * Helper to show/hide panic key groups based on selection
         */
        function updatePanicKeyVisibility() {
            const count = parseInt(document.getElementById('panic-key-count').value, 10);
            for (let i = 1; i <= 3; i++) {
                const group = document.getElementById(`panic-key-group-${i}`);
                if (group) {
                    group.classList.toggle('hidden', i > count);
                }
            }
        }

        /**
         * Attaches listeners for the new Panic Key UI
         */
        function attachPanicKeyListeners() {
            document.getElementById('panic-key-count').addEventListener('change', updatePanicKeyVisibility);
            document.getElementById('save-panic-keys-btn').addEventListener('click', savePanicKeySettings);
            
            loadPanicKeySettings();
        }

        /**
         * Loads panic key settings from IndexedDB
         */
        async function loadPanicKeySettings() {
            try {
                const db = await openPanicKeyDB();
                const transaction = db.transaction(PANIC_KEY_STORE_NAME, 'readonly');
                const store = transaction.objectStore(PANIC_KEY_STORE_NAME);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const settings = request.result || [];
                    db.close();

                    document.getElementById('panic-key-count').value = settings.length;
                    
                    // Sort settings by ID (panicKey1, panicKey2, ...) to ensure correct order
                    settings.sort((a, b) => a.id.localeCompare(b.id));

                    for (let i = 1; i <= 3; i++) {
                        const keyInput = document.getElementById(`panicKey${i}`);
                        const urlInput = document.getElementById(`panicUrl${i}`);
                        
                        const setting = settings[i - 1];
                        if (setting) {
                            keyInput.value = setting.key || '';
                            // Remove https:// prefix for display, matching old file's behavior
                            const displayUrl = (setting.url || '').replace(/^https?:\/\//, '');
                            urlInput.value = displayUrl;
                        } else {
                            keyInput.value = '';
                            urlInput.value = '';
                        }
                    }
                    updatePanicKeyVisibility();
                };
                request.onerror = (e) => {
                    db.close();
                    throw e.target.error;
                }
            } catch (error) {
                console.error('Error loading panic key settings:', error);
                document.getElementById('panic-key-message').textContent = 'Error loading settings from database.';
                document.getElementById('panic-key-message').className = 'message-area message-error';
            }
        }

        /**
         * Saves panic key settings to IndexedDB
         */
        async function savePanicKeySettings() {
            const messageEl = document.getElementById('panic-key-message');
            const count = parseInt(document.getElementById('panic-key-count').value, 10);
            const settingsToSave = [];
            const keys = new Set();
            
            for (let i = 1; i <= count; i++) {
                const key = document.getElementById(`panicKey${i}`).value.trim().toLowerCase();
                let url = document.getElementById(`panicUrl${i}`).value.trim();
                
                if (!key || !url) {
                    messageEl.textContent = `Panic Key ${i} is incomplete.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }
                
                if (key.length !== 1 || /[^a-z0-9`\-=\[\];',.\/\\ ]/.test(key)) {
                    messageEl.textContent = `Key for Panic Key ${i} is invalid. Use a single, non-special character.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }
                
                if (keys.has(key)) {
                    messageEl.textContent = `Duplicate key "${key}" found.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }
                
                // Simple URL regex check (matching old file)
                if (!/^(https?:\/\/)?((www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b)([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/i.test(url)) {
                    messageEl.textContent = `URL for Panic Key ${i} is invalid.`;
                    messageEl.className = 'message-area message-error';
                    return;
                }
                
                keys.add(key);
                
                if (!/^https?:\/\//i.test(url)) {
                    url = 'https://' + url;
                }
                
                // Store in the format panic-key.js expects
                settingsToSave.push({ id: `panicKey${i}`, key, url });
            }

            try {
                // Save to IndexedDB
                const db = await openPanicKeyDB();
                const transaction = db.transaction(PANIC_KEY_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(PANIC_KEY_STORE_NAME);
                
                // Clear all old settings first
                await new Promise((resolve, reject) => {
                   const req = store.clear();
                   req.onsuccess = resolve;
                   req.onerror = reject;
                });
                
                // Add all new settings
                for (const setting of settingsToSave) {
                    await new Promise((resolve, reject) => {
                        const req = store.put(setting);
                        req.onsuccess = resolve;
                        req.onerror = reject;
                    });
                }
                
                await new Promise((resolve, reject) => {
                    transaction.oncomplete = resolve;
                    transaction.onerror = reject;
                });
                
                db.close();
                
                // Show message
                messageEl.textContent = 'Panic key settings saved. Reload any open 4SP pages for changes to take effect.';
                messageEl.className = 'message-area message-success';
                
            } catch (error) {
                console.error('Error saving panic key settings:', error);
                messageEl.textContent = 'Error saving settings to database.';
                messageEl.className = 'message-area message-error';
            }
        }

        /* --- [END] UPDATED PANIC KEY FUNCTIONS --- */
        
        
        /* --- START DATA MANAGEMENT FUNCTIONS --- */
        
        /**
         * Renders the content for the "Data Management" tab
         */
        function renderDataManagement() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Export Game Data (strongdogxp)</h3>
                    <p class="settings-description mb-4">
                        Download a local JSON file containing your game's data stored in this browser's Local Storage. This file can be used to restore your progress on another device or browser.
                    </p>
                    <button id="export-data-btn" class="btn-base btn-secondary-style">
                        <i class="fas fa-download mr-2"></i> Download ${GAME_SAVE_FILENAME}
                    </button>
                    <div id="export-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Import Game Data (strongdogxp)</h3>
                    <p class="settings-description mb-4">
                        Upload a previously downloaded <code>${GAME_SAVE_FILENAME}</code> file to restore your game progress. <strong>Warning: This will overwrite your current local save for the game.</strong>
                    </p>
                    <div class="flex items-center gap-4">
                        <input type="file" id="import-file-input" accept="application/json" class="settings-input flex-grow">
                        <button id="import-data-btn" class="btn-base btn-primary-style" disabled>
                            <i class="fas fa-upload mr-2"></i> Import
                        </button>
                    </div>
                    <div id="import-message" class="message-area"></div>
                </div>
            `;
            // --- END STYLING UPDATE ---
            attachDataManagementListeners();
        }

        /**
         * Attaches event listeners for the Data Management panel
         */
        function attachDataManagementListeners() {
            const exportBtn = document.getElementById('export-data-btn');
            const importInput = document.getElementById('import-file-input');
            const importBtn = document.getElementById('import-data-btn');

            if (exportBtn) {
                exportBtn.addEventListener('click', downloadSaveFile);
            }

            if (importInput && importBtn) {
                // Enable/disable import button based on file selection
                importInput.addEventListener('change', () => {
                    importBtn.disabled = !importInput.files.length;
                });
                // Attach file upload handler
                importBtn.addEventListener('click', handleUploadFile);
            }
        }
        
        /**
         * Collects all keys and values from localStorage to prepare the export file.
         */
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Exclude settings keys that should not be part of a game save file
                // UPDATED: Also exclude tab disguiser and avatar keys
                const excludedKeys = [
                    NAVBAR_SETTINGS_KEY, 
                    'user-avatar-settings', 
                    'interface-settings',
                    'privacy-settings',
                    'selectedUrlPreset', // Handled by url-tab-title-changer.js
                    'tabDisguiseCustomFavicons' // Handled by url-tab-title-changer.js
                ];
                
                if (!excludedKeys.includes(key)) { 
                    try {
                        // Attempt to parse to see if it's JSON, otherwise keep as string
                        data[key] = JSON.parse(localStorage.getItem(key));
                    } catch {
                        data[key] = localStorage.getItem(key);
                    }
                }
            }
            return {
                localStorageBackup: data,
                exportedAt: new Date().toISOString()
            };
        }
        
        /**
         * Initiates the download of the game save file.
         */
        function downloadSaveFile() {
            const message = document.getElementById('export-message');
            message.textContent = 'Preparing download...';
            message.className = 'message-area message-warning';

            try {
                const dataToDownload = getAllLocalStorageData();
                const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], {
                    type: "application/json",
                });
                
                // Create a hidden link to trigger the download
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = GAME_SAVE_FILENAME;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url); // Clean up the URL object

                message.textContent = 'Game data successfully downloaded!';
                message.className = 'message-area message-success';

            } catch (error) {
                console.error("Error during download:", error);
                message.textContent = 'Error: Failed to create or download file.';
                message.className = 'message-area message-error';
            }
        }
        
        /**
         * Handles the file selection and parsing for import.
         */
        function handleUploadFile() {
            const input = document.getElementById('import-file-input');
            const button = document.getElementById('import-data-btn');
            const message = document.getElementById('import-message');

            if (!input.files.length) {
                message.textContent = 'Please select a file to import.';
                message.className = 'message-area message-error';
                return;
            }

            const confirmed = prompt(`This will overwrite all local game data. To confirm, type "IMPORT":`);
            if (confirmed !== 'IMPORT') {
                message.textContent = 'Import cancelled.';
                message.className = 'message-area message-warning';
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            message.textContent = `Reading ${file.name}...`;
            message.className = 'message-area message-warning';
            button.disabled = true;

            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.localStorageBackup) {
                         throw new Error('Invalid save file format. Missing "localStorageBackup" field.');
                    }
                    
                    applyImportedData(importedData.localStorageBackup);
                    
                    message.textContent = 'Game data successfully imported! Please reload the game page to see changes.';
                    message.className = 'message-area message-success';
                    // Optional: force a reload or redirect
                    // setTimeout(() => window.location.href = '../index.html', 1500);

                } catch (error) {
                    console.error("Import error:", error);
                    message.textContent = `Error importing file: ${error.message}`;
                    message.className = 'message-area message-error';
                } finally {
                    button.disabled = false;
                    input.value = ''; // Reset file input
                }
            };

            reader.onerror = () => {
                message.textContent = 'Error reading file.';
                message.className = 'message-area message-error';
                button.disabled = false;
            };

            reader.readAsText(file);
        }

        /**
         * Clears all game-related localStorage keys and applies imported data.
         * NOTE: This is a destructive operation.
         */
        function applyImportedData(data) {
            // Exclude settings keys that should not be part of a game save file
            const excludedKeys = [
                NAVBAR_SETTINGS_KEY, 
                'user-avatar-settings', 
                'interface-settings',
                'privacy-settings',
                'selectedUrlPreset',
                'tabDisguiseCustomFavicons'
            ];

            // 1. (Safer) Clear only game-related keys
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (!excludedKeys.includes(key)) {
                    localStorage.removeItem(key);
                }
            }
            
            // 2. Apply new data
            for (const key in data) {
                // Ensure we don't accidentally import a settings key
                if (excludedKeys.includes(key)) {
                    console.warn(`Skipped importing reserved key: ${key}`);
                    continue;
                }
                
                const value = data[key];
                // localStorage only stores strings, so convert objects back to JSON strings
                if (typeof value === 'object' && value !== null) {
                    localStorage.setItem(key, JSON.stringify(value));
                } else {
                    localStorage.setItem(key, value);
                }
            }
        }

        /* --- END DATA MANAGEMENT FUNCTIONS --- */
        
        /* --- [START] NEW ABOUT 4SP FUNCTION --- */
        
        /**
         * Renders the content for the "About 4SP" tab
         */
        function renderAboutSection() {
            // --- STYLING UPDATE: Replaced button classes ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-2xl font-semibold text-white mb-2">(4SP) 4simpleproblems</h3>
                    <p class="text-sm text-gray-400 mb-4">Version 4.0 beta 4</p>
                    <p class="text-lg text-gray-300 italic mb-6">
                        "A student toolkit without ads, <strong>ever</strong>."
                    </p>
                </div>
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Connect with 4SP</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <a href="https://github.com/v5-4simpleproblems/" target="_blank" rel="noopener noreferrer" class="btn-base btn-secondary-style text-center flex items-center justify-center py-4 text-base">
                            <i class="fab fa-github fa-fw mr-3 text-lg"></i> GitHub
                        </a>
                        <a href="https://youtube.com/@4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #CD201F; border-color: #CD201F; color: white;">
                            <i class="fab fa-youtube fa-fw mr-3 text-lg"></i> YouTube
                        </a>
                        <a href="https://x.com/4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #1DA1F2; border-color: #1DA1F2; color: white;">
                            <i class="fab fa-twitter fa-fw mr-3 text-lg"></i> Twitter (X)
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" rel="noopener noreferrer" class="btn-base text-center flex items-center justify-center py-4 text-base" style="background-color: #FFDD00; border-color: #FFDD00; color: #000000;">
                            <i class="fas fa-coffee fa-fw mr-3 text-lg"></i> Buy Me a Coffee
                        </a>
                    </div>
                </div>
            `;
            // --- END STYLING UPDATE ---
        }
        
        /* --- [END] NEW ABOUT 4SP FUNCTION --- */


        // --- START APPLICATION ---
        document.addEventListener('DOMContentLoaded', startAuthFlow);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        
        .btn-toolbar-style {
            background: var(--menu-bg, #0000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: var(--menu-bg, #000000);
            border-color: var(--menu-border, #fff);
            color: var(--tab-hover-text, #ffffff);
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .settings-tab.active:hover {
             background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        .settings-box { 
            border: 1px solid var(--menu-border, #333); 
            /* MODIFICATION: Changed border-radius from 0.75rem to 1rem for increased rounding */
            border-radius: 1rem; 
            background-color: var(--menu-bg, #0000000); 
            padding: 0.75rem 1rem;
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider, 
            reauthenticateWithCredential, 
            updatePassword,
            // NEW AUTH IMPORTS
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            reauthenticateWithPopup,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            deleteDoc // NEW FIREBASE IMPORT
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config (Assumed to exist in a relative file) ---
        import { firebaseConfig } from "../firebase-config.js"; 

        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object
        
        // Constants for validation and limits
        const MIN_LENGTH = 6; 
        const MAX_LENGTH = 24;
        const MAX_CHANGES = 5; 


        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // Constants for providers (NEW)
        const PROVIDER_CONFIG = {
            'google.com': { 
                name: 'Google', 
                icon: '../images/google-icon.png', 
                instance: () => new GoogleAuthProvider() 
            },
            'github.com': { 
                name: 'GitHub', 
                icon: '../images/github-mark-white.png', 
                instance: () => new GithubAuthProvider() 
            },
            'microsoft.com': { 
                name: 'Microsoft', 
                icon: '../images/microsoft.png', 
                instance: () => new OAuthProvider('microsoft.com') 
            },
            'password': { 
                name: 'Email & Password', 
                icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', 
                isCredential: true
            }
        };

        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            // Prevent clearing a success message if a warning is generated elsewhere
            if (element.innerHTML.includes('success') && type !== 'error') return;
            element.innerHTML = text;
            element.className = `general-message-area text-sm ${type}-message`;
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };

        /**
         * Generates the HTML for the "Change Password" section.
         */
        function getChangePasswordSection() {
            // max-w-xl changed to max-w-2xl
            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Change Password</h3>
                <div id="passwordChangeSection" class="settings-box p-4 w-full max-w-2xl">
                    <p class="text-sm font-light text-gray-400 mb-3">
                        Change your password. You must provide your current password for security.
                    </p>
                    
                    <div class="flex flex-col gap-3">
                        <input type="password" id="currentPasswordInput" placeholder="Current Password" class="input-text-style">
                        <input type="password" id="newPasswordInput" placeholder="New Password (min 6 characters)" class="input-text-style">
                        <input type="password" id="confirmPasswordInput" placeholder="Confirm New Password" class="input-text-style">
                    </div>
                    
                    <div class="flex justify-between items-center pt-4">
                        <p id="passwordMessage" class="general-message-area text-sm"></p>
                        <button id="applyPasswordBtn" class="btn-toolbar-style btn-primary-override w-32" disabled style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-lock mr-1"></i> Apply
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Linked Providers and Account Deletion section. (NEW FUNCTION)
         */
        function getAccountManagementContent(providerData) {
            // Determine the Primary Provider (the first one in the list)
            const primaryProviderId = providerData[0].providerId;
            
            let linkedProvidersHtml = providerData.map(info => {
                const id = info.providerId;
                const config = PROVIDER_CONFIG[id] || { name: id, icon: '<i class="fa-solid fa-puzzle-piece fa-lg mr-3"></i>' };
                
                // Determine if this provider can be unlinked
                // Cannot unlink if: 
                // 1. It's the only provider left (length === 1).
                // 2. It's the primary 'password' provider (the user can't remove their only password login).
                const canUnlink = providerData.length > 1 && !(id === 'password' && primaryProviderId === 'password');
                
                // Determine if icon is an image or a FontAwesome icon
                let iconHtml = config.icon.startsWith('<i') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-5 h-5 mr-3">`;

                return `
                    <div class="flex justify-between items-center py-2 px-1 last:pb-0">
                        <div class="flex items-center text-lg text-white">
                            ${iconHtml}
                            ${config.name}
                            ${id === primaryProviderId ? '<span class="text-xs text-yellow-400 ml-2 font-normal">(Primary)</span>' : ''}
                        </div>
                        ${canUnlink ? 
                            `<button class="btn-toolbar-style text-red-400 hover:border-red-600 hover:text-red-600" data-provider-id="${id}" data-action="unlink" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-unlink mr-1"></i> Unlink
                            </button>` : 
                            `<span class="text-xs text-custom-light-gray font-light ml-4">Cannot Unlink</span>`
                        }
                    </div>
                `;
            }).join('');

            // Filter out already linked social providers for the linking list
            const linkedIds = providerData.map(p => p.providerId);
            let availableProvidersHtml = Object.keys(PROVIDER_CONFIG)
                .filter(id => id !== 'password' && !linkedIds.includes(id))
                .map(id => {
                    const config = PROVIDER_CONFIG[id];
                    let iconHtml = config.icon.startsWith('<i') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-5 h-5 mr-3">`;

                    return `
                        <button class="btn-toolbar-style settings-box flex items-center justify-start w-full" data-provider-id="${id}" data-action="link" style="padding: 0.5rem 1rem;">
                            ${iconHtml}
                            Link with ${config.name}
                        </button>
                    `;
                }).join('');
                
            if (availableProvidersHtml === '') {
                availableProvidersHtml = `<p class="text-sm text-gray-500 text-center py-2">All available social providers are linked.</p>`;
            }


            // --- Account Deletion Section ---
            let deletionContent = '';
            
            if (primaryProviderId === 'password') {
                // Email/Password Deletion (max-w-xl changed to max-w-2xl)
                deletionContent = `
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                    <div id="deletionSection" class="settings-box p-4 w-full max-w-2xl bg-red-900/10 border-red-700/50">
                        <p class="text-sm font-light text-red-300 mb-3">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                            WARNING: Deleting your account is permanent and cannot be undone.
                        </p>
                        
                        <div id="passwordDeletionStep1">
                            <label for="deletePasswordInput" class="block text-red-300 text-sm font-light mb-2">Confirm Current Password</label>
                            <input type="password" id="deletePasswordInput" placeholder="Current Password" class="input-text-style w-full bg-red-900/20 border-red-700/50 mb-3">
                            
                            <label for="deleteConfirmText" class="block text-red-300 text-sm font-light mb-2">Type "Delete My Account" to confirm (Case-insensitive)</label>
                            <input type="text" id="deleteConfirmText" placeholder="Delete My Account" class="input-text-style w-full bg-red-900/20 border-red-700/50">
                            
                            <div class="flex justify-between items-center pt-4">
                                <p id="deleteMessage" class="general-message-area text-sm"></p>
                                <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48" disabled style="padding: 0.5rem 0.75rem;">
                                     <i class="fa-solid fa-trash mr-1"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Social Provider Deletion (max-w-xl changed to max-w-2xl)
                deletionContent = `
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                    <div id="deletionSection" class="settings-box p-4 w-full max-w-2xl bg-red-900/10 border-red-700/50">
                        <p class="text-sm font-light text-red-300 mb-3">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                            WARNING: Deleting your account is permanent. You must re-authenticate with ${PROVIDER_CONFIG[primaryProviderId].name} to proceed.
                        </p>
                        
                        <div class="flex justify-between items-center pt-2">
                            <p id="deleteMessage" class="general-message-area text-sm"></p>
                            <button id="reauthenticateBtn" class="btn-toolbar-style w-48 btn-primary-override" data-provider-id="${primaryProviderId}" style="padding: 0.5rem 0.75rem;">
                                 <i class="fa-solid fa-key mr-1"></i> Re-authenticate
                            </button>
                            <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48 hidden" style="padding: 0.5rem 0.75rem;">
                                 <i class="fa-solid fa-trash mr-1"></i> Delete Account
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- Combined HTML for Account Management ---
            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Linked Providers</h3>
                <div class="settings-box p-4 w-full max-w-2xl mb-4" data-section="linked-providers">
                    ${linkedProvidersHtml}
                </div>
                
                <h3 class="text-xl font-bold text-white mb-2">Link New Providers</h3>
                <div class="w-full max-w-2xl flex flex-col gap-3">
                    ${availableProvidersHtml}
                </div>
                
                ${deletionContent}
            `;
        }


        /**
         * Generates the HTML for the "General Settings" section.
         */
        function getGeneralContent(currentUsername, changesRemaining, changesThisMonth, currentMonthName, isEmailPasswordUser, providerData) {
             const changesUsed = changesThisMonth;
             
             // Conditionally generate the password section HTML
             let passwordSectionHtml = '';
             if (isEmailPasswordUser) {
                 passwordSectionHtml = getChangePasswordSection();
             }

             return `
                 <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                 
                 <div class="w-full max-w-2xl">
                    
                    <div class="flex justify-between items-center mb-4 settings-box">
                        <p class="text-sm font-light text-gray-300">
                           <i class="fa-solid fa-calendar-alt mr-2 text-yellow-500"></i>
                           Changes this month (<span class="text-emphasis text-yellow-300">${currentMonthName}</span>):
                        </p>
                        <span class="text-lg font-semibold ${changesRemaining > 0 ? 'text-green-400' : 'text-red-400'}">
                            ${changesUsed}/${MAX_CHANGES} used
                        </span>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Account Username</h3>
                    
                    <div id="usernameSection" class="settings-box p-3 transition-all duration-300">
                        
                        <div id="viewMode" class="flex justify-between items-center">
                            <p class="text-lg text-gray-400 leading-relaxed">
                                Current: <span id="currentUsernameText" class="text-emphasis text-blue-400">${currentUsername}</span>
                            </p>
                            <button id="enterEditModeBtn" class="btn-toolbar-style" style="padding: 0.5rem 0.75rem;">
                                 <i class="fa-solid fa-pen-to-square mr-1"></i> Change
                            </button>
                        </div>

                        <div id="editMode" class="hidden flex-col gap-3">
                            <label for="newUsernameInput" class="block text-gray-400 text-sm font-light">New Username</label>
                            <input type="text" id="newUsernameInput" value="${currentUsername}" maxlength="${MAX_LENGTH}"
                                   class="input-text-style w-full" 
                                   placeholder="${MIN_LENGTH}-${MAX_LENGTH} characters, only allowed symbols">
                            
                            <div class="flex justify-between items-center pt-2">
                                <p class="text-xs text-gray-500 font-light whitespace-nowrap">
                                    Length: <span id="minLength" class="font-semibold text-gray-400">${MIN_LENGTH}</span>/<span id="charCount" class="font-semibold text-gray-400">${currentUsername.length}</span>/<span id="maxLength" class="font-semibold text-gray-400">${MAX_LENGTH}</span>
                                </p>
                                
                                <div class="flex gap-2">
                                    <button id="applyUsernameBtn" class="btn-toolbar-style btn-primary-override w-24 transition-opacity duration-300" disabled style="padding: 0.5rem 0.75rem;">
                                        <i class="fa-solid fa-check"></i> Apply
                                    </button>
                                    <button id="cancelEditBtn" class="btn-toolbar-style w-24 transition-opacity duration-300" style="padding: 0.5rem 0.75rem;">
                                        <i class="fa-solid fa-xmark"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="usernameChangeMessage" class="general-message-area text-sm"></div>
                </div>
                
                ${passwordSectionHtml}
                
                ${getAccountManagementContent(providerData)}
             `;
         }


        /**
         * Generates the HTML for the "About 4SP" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-4">About 4SP (4simpleproblems)</h2>
                
                <div class="about-section-content">
                    <p class="text-lg text-gray-400 leading-relaxed">
                        <span class="text-emphasis">4SP (4simpleproblems)</span> is a <span class="text-emphasis">Student Toolkit and Entertainment website</span> designed to boost student productivity and provide useful resources. We aim to solve four core challenges that students face every day by integrating essential tools and engaging digital content into one seamless platform.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">The Four Simple Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>

                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">Version</h3>
                    <p class="text-gray-400">
                        Current Version: <span class="text-blue-400 text-emphasis">5.0 Beta 9</span>
                    </p>

                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Connect & Support</h3>
                    <div class="social-link-group">
                        <a href="https://www.youtube.com/@4simpleproblems" target="_blank" class="btn-toolbar-style" title="YouTube">
                            <i class="fa-brands fa-youtube fa-lg mr-2"></i> YouTube
                        </a>
                        <a href="https://x.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="X (Twitter)">
                            <i class="fa-brands fa-x-twitter fa-lg mr-2"></i>X
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="Buy Me a Coffee">
                            <i class="fa-solid fa-mug-hot fa-lg mr-2"></i> Buy Me a Coffee
                        </a>
                        <a href="https://github.com/v5-4simpleproblems" target="_blank" class="btn-toolbar-style" title="GitHub">
                            <i class="fa-brands fa-github fa-lg mr-2"></i> Github
                        </a>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Legal Information</h3>
                    <div class="legal-buttons">
                        <a href="../legal.html#terms-of-service" class="btn-toolbar-style">Terms of Service</a>
                        <a href="../legal.html#privacy-policy" class="btn-toolbar-style">Privacy Policy</a>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "Coming Soon" sections.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-2">${title}</h2>
                <div style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
                    <p class="text-xl text-gray-500 italic">...Coming Soon...</p>
                    <i class="fa-solid fa-hourglass-start fa-5x text-gray-700 mt-4"></i>
                </div>
            `;
        }
        
        // Helper for refreshing the General Tab
        const refreshGeneralTab = () => {
            // Clear the current view state and re-render the General tab
            // This is necessary because currentUser.providerData needs to be fresh
            switchTab('general');
        };

        /**
         * Loads user data, checks rate limit, and renders the General tab.
         */
        async function loadGeneralTab() {
            if (!currentUser) return; 

            // Check if user is using email/password authentication (providerId 'password')
            const isEmailPasswordUser = currentUser.providerData.some(
                (info) => info.providerId === 'password'
            );
            
            const userDocRef = getUserDocRef(currentUser.uid);
            let userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                mainView.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">General Settings</h2><p class="text-red-400">Error: User data not found. Please log out and back in.</p>`;
                return;
            }

            let userData = userDocSnap.data();
            const today = new Date();
            const currentMonthNumber = today.getMonth() + 1; 
            const currentMonthName = today.toLocaleDateString('en-US', { month: 'long' }); 
            
            let changesThisMonth = userData.usernameChangesThisMonth || 0;
            let lastChangeMonth = userData.lastUsernameChangeMonth || 0;

            // --- Monthly Reset Logic ---
            if (currentMonthNumber !== lastChangeMonth) {
                changesThisMonth = 0;
                await updateDoc(userDocRef, {
                    usernameChangesThisMonth: 0,
                    lastUsernameChangeMonth: currentMonthNumber
                });
                userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.data(); 
            }
            
            const changesRemaining = MAX_CHANGES - changesThisMonth;

            // 1. Render the General Content
            mainView.innerHTML = getGeneralContent(
                userData.username, 
                changesRemaining, 
                changesThisMonth, 
                currentMonthName,
                isEmailPasswordUser, 
                currentUser.providerData // Pass provider info
            );
            
            // 2. Element References (Username Section)
            const viewMode = document.getElementById('viewMode');
            const editMode = document.getElementById('editMode');
            const enterEditModeBtn = document.getElementById('enterEditModeBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const applyUsernameBtn = document.getElementById('applyUsernameBtn');
            const newUsernameInput = document.getElementById('newUsernameInput');
            const messageElement = document.getElementById('usernameChangeMessage');
            const charCountElement = document.getElementById('charCount');
            const minLengthElement = document.getElementById('minLength');
            const maxLengthElement = document.getElementById('maxLength');

            // --- Username UI State Management Functions ---
            const setEditMode = (isEditing) => {
                messageElement.innerHTML = ''; // Clear message
                
                if (isEditing) {
                    if (changesRemaining <= 0) {
                        showMessage(messageElement, `You have reached your limit of ${MAX_CHANGES} username changes for the current month.`, 'error'); 
                        return;
                    }
                    viewMode.classList.add('hidden');
                    editMode.classList.remove('hidden');
                    newUsernameInput.focus();
                    updateCounterAndValidation(); 
                } else {
                    editMode.classList.add('hidden');
                    viewMode.classList.remove('hidden');
                    newUsernameInput.value = userData.username; // Reset input value
                    applyUsernameBtn.disabled = true;
                }
            };

            const updateCounterAndValidation = () => {
                const newUsername = newUsernameInput.value.trim();
                const count = newUsername.length;
                
                charCountElement.textContent = count;
                
                const isValidLength = count >= MIN_LENGTH && count <= MAX_LENGTH;
                const isChanged = newUsername !== userData.username;
                
                // 1. Update counter colors
                minLengthElement.classList.toggle('text-red-400', count < MIN_LENGTH);
                maxLengthElement.classList.toggle('text-red-400', count > MAX_LENGTH);
                
                minLengthElement.classList.toggle('text-gray-400', count >= MIN_LENGTH);
                maxLengthElement.classList.toggle('text-gray-400', count <= MAX_LENGTH);
                
                charCountElement.classList.toggle('text-red-400', !isValidLength);
                charCountElement.classList.toggle('text-gray-400', isValidLength);


                // 2. Update button state
                applyUsernameBtn.disabled = !isChanged || !isValidLength || changesRemaining <= 0;
            };

            // --- Username Event Listeners ---
            enterEditModeBtn.addEventListener('click', () => setEditMode(true));
            cancelEditBtn.addEventListener('click', () => setEditMode(false));
            newUsernameInput.addEventListener('input', updateCounterAndValidation);


            applyUsernameBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const newUsername = newUsernameInput.value.trim();
                
                if (applyUsernameBtn.disabled || changesRemaining <= 0) {
                    showMessage(messageElement, 'Cannot apply changes due to validation errors, rate limit, or no change was made.', 'error');
                    return;
                }

                applyUsernameBtn.disabled = true;
                showMessage(messageElement, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Checking availability and profanity...', 'warning');

                try {
                    // --- Validation ---
                    if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) { 
                        showMessage(messageElement, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error'); 
                        return; 
                    }
                    if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) { 
                        showMessage(messageElement, 'Username contains invalid characters (Allowed symbols: .,-+\\_!?$).', 'error'); 
                        return; 
                    }
                    
                    // --- Checks ---
                    if (await checkProfanity(newUsername)) { 
                        showMessage(messageElement, 'This username is not allowed (Profanity filter triggered).', 'error'); 
                        return; 
                    }
                    if (await isUsernameTaken(newUsername)) { 
                        showMessage(messageElement, 'This username is already taken.', 'error'); 
                        return; 
                    }
                    
                    // --- Update Logic ---
                    const newChangesCount = changesThisMonth + 1;
                    await updateDoc(userDocRef, {
                        username: newUsername,
                        usernameChangesThisMonth: newChangesCount,
                        lastUsernameChangeMonth: currentMonthNumber 
                    });

                    showMessage(messageElement, `Username successfully changed to ${newUsername}!`, 'success');
                    
                    // Re-render the tab content to update the display, counter, and state
                    setTimeout(() => { switchTab('general'); }, 1500);

                } catch (error) {
                    console.error("Error updating username:", error);
                    showMessage(messageElement, `An unexpected error occurred: ${error.message}`, 'error');
                } finally {
                    if (messageElement.innerHTML.includes('Error') || messageElement.innerHTML.includes('not allowed') || messageElement.innerHTML.includes('taken')) {
                        applyUsernameBtn.disabled = false;
                    }
                }
            });
            
            
            // =================================================================
            // --- PASSWORD CHANGE LOGIC (Conditional) ---
            // =================================================================
            if (isEmailPasswordUser) {
                const currentPasswordInput = document.getElementById('currentPasswordInput');
                const newPasswordInput = document.getElementById('newPasswordInput');
                const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                const applyPasswordBtn = document.getElementById('applyPasswordBtn');
                const passwordMessage = document.getElementById('passwordMessage');
                
                // Input handler for enabling/disabling apply button
                const checkPasswordFields = () => {
                    const currentPass = currentPasswordInput.value;
                    const newPass = newPasswordInput.value;
                    const confirmPass = confirmPasswordInput.value;
                    
                    const MIN_PASS_LENGTH = 6;
                    
                    const isLengthValid = newPass.length >= MIN_PASS_LENGTH;
                    const isMatch = newPass === confirmPass;
                    const isCurrentProvided = currentPass.length > 0;
                    
                    // Enable if all requirements are met
                    applyPasswordBtn.disabled = !(isLengthValid && isMatch && isCurrentProvided);
                    
                    // Provide gentle feedback
                    passwordMessage.innerHTML = '';
                    if (newPass.length > 0 && newPass.length < MIN_PASS_LENGTH) {
                        showMessage(passwordMessage, `New password must be at least ${MIN_PASS_LENGTH} characters.`, 'warning');
                    } else if (newPass.length >= MIN_PASS_LENGTH && newPass !== confirmPass) {
                         showMessage(passwordMessage, 'New and confirmation passwords do not match.', 'warning');
                    } else if (newPass === currentPass && isLengthValid && isMatch) {
                         showMessage(passwordMessage, 'New password cannot be the same as your current password.', 'warning');
                         applyPasswordBtn.disabled = true;
                    }
                };

                currentPasswordInput.addEventListener('input', checkPasswordFields);
                newPasswordInput.addEventListener('input', checkPasswordFields);
                confirmPasswordInput.addEventListener('input', checkPasswordFields);
                
                applyPasswordBtn.addEventListener('click', async () => {
                    applyPasswordBtn.disabled = true;
                    passwordMessage.innerHTML = ''; // Clear prior message
                    showMessage(passwordMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Attempting password change...', 'warning');

                    const currentPass = currentPasswordInput.value;
                    const newPass = newPasswordInput.value;
                    
                    if (newPass.length < 6) {
                         showMessage(passwordMessage, 'New password must be at least 6 characters.', 'error');
                         applyPasswordBtn.disabled = false;
                         return;
                    }
                    if (newPass === currentPass) {
                        showMessage(passwordMessage, 'New password cannot be the same as your current password.', 'error');
                        applyPasswordBtn.disabled = false;
                        return;
                    }

                    try {
                        // 1. Re-authenticate the user
                        const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
                        await reauthenticateWithCredential(currentUser, credential);

                        // 2. Update the password
                        await updatePassword(currentUser, newPass);

                        showMessage(passwordMessage, 'Password successfully updated!', 'success');
                        
                        // Clear fields on success
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        // Re-check fields to disable the button
                        checkPasswordFields(); 

                    } catch (error) {
                        console.error("Error changing password:", error);
                        let errorMessage = "An unknown error occurred.";
                        
                        switch (error.code) {
                            case 'auth/requires-recent-login':
                                errorMessage = 'Password change failed. Please sign out and sign in again to change your password.';
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'The current password you provided is incorrect.';
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'The new password is too weak. Please use a stronger one (min 6 characters).';
                                break;
                            default:
                                errorMessage = `Password change failed. (${error.message})`;
                        }
                        showMessage(passwordMessage, errorMessage, 'error');
                    } finally {
                        // Re-enable button if there was an error
                        if (!passwordMessage.innerHTML.includes('success')) {
                            applyPasswordBtn.disabled = false;
                        }
                    }
                });
            }
            
            // =================================================================
            // --- LINKING / UNLINKING PROVIDERS LOGIC (NEW) ---
            // =================================================================

            const linkProviderButtons = mainView.querySelectorAll('button[data-action="link"]');
            const unlinkProviderButtons = mainView.querySelectorAll('button[data-action="unlink"]');

            // --- LINKING Providers ---
            linkProviderButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const providerId = button.dataset.providerId;
                    const config = PROVIDER_CONFIG[providerId];
                    const providerInstance = config.instance();
                    
                    showMessage(messageElement, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Attempting to link with ${config.name}...`, 'warning');
                    
                    try {
                        await linkWithPopup(auth.currentUser, providerInstance);
                        showMessage(messageElement, `${config.name} successfully linked to your account!`, 'success');
                        setTimeout(refreshGeneralTab, 1500); // Refresh UI
                    } catch (error) {
                        console.error("Error linking provider:", error);
                        let msg = `Failed to link ${config.name}.`;
                        if (error.code === 'auth/credential-already-in-use') {
                            msg = `This ${config.name} account is already linked to another user.`;
                        } else if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Link cancelled by user.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please sign out and sign in again to link a new provider.';
                        }
                        showMessage(messageElement, msg, 'error');
                    }
                });
            });

            // --- UNLINKING Providers ---
            unlinkProviderButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const providerId = button.dataset.providerId;
                    const config = PROVIDER_CONFIG[providerId];
                    
                    showMessage(messageElement, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Unlinking ${config.name}...`, 'warning');
                    
                    try {
                        await unlink(auth.currentUser, providerId);
                        showMessage(messageElement, `${config.name} successfully unlinked.`, 'success');
                        setTimeout(refreshGeneralTab, 1500); // Refresh UI
                    } catch (error) {
                        console.error("Error unlinking provider:", error);
                        let msg = `Failed to unlink ${config.name}.`;
                        if (error.code === 'auth/no-such-provider') {
                            msg = 'Provider not found on this account.';
                        } else if (error.code === 'auth/requires-recent-login') {
                             msg = 'Please sign out and sign in again to unlink this provider.';
                        } else if (error.code === 'auth/provider-already-linked') {
                            // This can happen if attempting to unlink the last provider
                            msg = "Cannot unlink the last remaining sign-in method.";
                        }
                        
                        showMessage(messageElement, msg, 'error');
                    }
                });
            });

            // =================================================================
            // --- ACCOUNT DELETION LOGIC (NEW) ---
            // =================================================================
            const deletePasswordInput = document.getElementById('deletePasswordInput');
            const deleteConfirmText = document.getElementById('deleteConfirmText');
            const reauthenticateBtn = document.getElementById('reauthenticateBtn');
            const finalDeleteBtn = document.getElementById('finalDeleteBtn');
            const deleteMessage = document.getElementById('deleteMessage');
            const primaryProviderId = currentUser.providerData[0].providerId;


            const performAccountDeletion = async () => {
                deleteMessage.innerHTML = '';
                showMessage(deleteMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Deleting account...', 'warning');

                try {
                    // Delete user's Firestore document first (to prevent orphaned data)
                    await deleteDoc(userDocRef); 
                    
                    // Delete Firebase Auth user
                    await deleteUser(auth.currentUser);

                    // Sign out and redirect to authentication page
                    await signOut(auth);
                    window.location.href = '../authentication.html';

                } catch (error) {
                    console.error("Error deleting account:", error);
                    let msg = "Failed to delete account. Please try again or sign in again.";
                    if (error.code === 'auth/requires-recent-login') {
                        msg = 'Deletion failed: Please sign out and sign in again immediately to proceed with deletion.';
                    }
                    showMessage(deleteMessage, msg, 'error');
                    // Re-enable/reset UI elements
                    if (reauthenticateBtn) reauthenticateBtn.classList.remove('hidden');
                    if (finalDeleteBtn) finalDeleteBtn.classList.add('hidden');
                }
            };


            // --- Email/Password Primary Deletion Logic ---
            if (primaryProviderId === 'password' && deletePasswordInput) {
                const checkDeletionInputs = () => {
                    const passwordMatch = deletePasswordInput.value.length > 0;
                    const textConfirmed = deleteConfirmText.value.trim().toLowerCase() === 'delete my account';
                    
                    finalDeleteBtn.disabled = !(passwordMatch && textConfirmed);
                };

                deletePasswordInput.addEventListener('input', checkDeletionInputs);
                deleteConfirmText.addEventListener('input', checkDeletionInputs);
                
                finalDeleteBtn.addEventListener('click', async () => {
                    if (finalDeleteBtn.disabled) return;
                    
                    finalDeleteBtn.disabled = true;
                    deleteMessage.innerHTML = '';
                    showMessage(deleteMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating...', 'warning');
                    
                    try {
                        // Re-authenticate using email/password credential
                        const credential = EmailAuthProvider.credential(auth.currentUser.email, deletePasswordInput.value);
                        await reauthenticateWithCredential(auth.currentUser, credential);

                        // If re-auth is successful, proceed to final deletion
                        await performAccountDeletion();

                    } catch (error) {
                        console.error("Error during password re-authentication for deletion:", error);
                        let msg = 'Re-authentication failed. Incorrect password.';
                        if (error.code === 'auth/requires-recent-login') {
                             msg = 'Please sign out and sign in again immediately to proceed with deletion.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                        finalDeleteBtn.disabled = false;
                    }
                });
            } 
            // --- Social Provider Primary Deletion Logic ---
            else if (reauthenticateBtn) {
                
                reauthenticateBtn.addEventListener('click', async () => {
                    const providerInstance = PROVIDER_CONFIG[primaryProviderId].instance();
                    
                    reauthenticateBtn.disabled = true;
                    deleteMessage.innerHTML = '';
                    showMessage(deleteMessage, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating with ${PROVIDER_CONFIG[primaryProviderId].name}...`, 'warning');
                    
                    try {
                        // Re-authenticate using the social provider popup
                        await reauthenticateWithPopup(auth.currentUser, providerInstance);
                        
                        // Re-authentication successful: change button to final delete button
                        reauthenticateBtn.classList.add('hidden');
                        finalDeleteBtn.classList.remove('hidden');
                        showMessage(deleteMessage, 'Authentication successful. Click "Delete Account" one last time to confirm.', 'success');

                    } catch (error) {
                        console.error("Error during social re-authentication for deletion:", error);
                        let msg = 'Re-authentication failed. Please try again.';
                         if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Re-authentication cancelled by user.';
                        } else if (error.code === 'auth/requires-recent-login') {
                             msg = 'Please sign out and sign in again immediately to proceed with deletion.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                        reauthenticateBtn.disabled = false;
                    }
                    if (reauthenticateBtn.classList.contains('hidden') === false) {
                        reauthenticateBtn.disabled = false;
                    }
                });
                
                // Final Delete button click
                finalDeleteBtn.addEventListener('click', performAccountDeletion);
            }
        }


        /**
         * Handles the switching of tabs and updating the main content view.
         */
        async function switchTab(tabId) {
            // 1. Update active class on sidebar tabs
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // 2. Update the main view content and alignment
            mainView.style.justifyContent = 'flex-start';
            mainView.style.alignItems = 'flex-start';

            if (tabId === 'general') {
                await loadGeneralTab(); 
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

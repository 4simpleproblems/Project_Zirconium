<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notification Test Page</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        button { padding: 10px 20px; background-color: #4f46e5; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .status-box { margin-top: 15px; padding: 10px; border: 1px solid #ccc; background-color: #e9e9e9; word-break: break-all; }
        .status-success { color: green; }
        .status-error { color: red; }
    </style>
    <script type="module">
        // 1. Core Firebase/Messaging Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";

        // 2. Configuration (Using data from your dailyphoto.html and sw.js)
        const VAPID_KEY = 'BHYM9iOhL3KZqDwYo-_Qx9Nh7bksKoZT-XZ0IJa6RN-vqJ0DT-2EM1Y7V0fMpjyseMNszEj-CU0e3pj87z3lcbw';
        
        // This config is only necessary for app initialization
        const firebaseConfig = {
            apiKey: "AIzaSyAZBKAckVa4IMvJGjcyndZx6Y1XD52lgro", // Placeholder or actual API key
            messagingSenderId: "1096564243475" // Your actual Messaging Sender ID
        };
        
        // 3. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);

        const statusDiv = document.getElementById('status-message');
        const tokenDisplay = document.getElementById('fcm-token-display');
        const testNotificationBtn = document.getElementById('test-notification-btn');

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = 'status-box ' + (type === 'success' ? 'status-success' : (type === 'error' ? 'status-error' : ''));
        }

        /**
         * Core setup function: Register SW, get permission, get token.
         */
        async function setupFCM() {
            if (!('serviceWorker' in navigator) || !('Notification' in window)) {
                return updateStatus('Service Workers or Notifications are not supported in this browser.', 'error');
            }

            try {
                updateStatus('Registering Service Worker...');
                // IMPORTANT: This requires your sw.js file to be in the root directory (/).
                const registration = await navigator.serviceWorker.register('/sw.js'); 
                updateStatus('Service Worker registered. Requesting permission...');

                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    return updateStatus('Notification permission denied by user.', 'error');
                }
                updateStatus('Permission granted. Retrieving FCM Token...');

                const currentToken = await getToken(messaging, { 
                    vapidKey: VAPID_KEY, 
                    serviceWorkerRegistration: registration 
                });
                
                if (currentToken) {
                    updateStatus('FCM Setup Complete!', 'success');
                    tokenDisplay.textContent = currentToken;
                    console.log('FCM Token:', currentToken);

                    // Handle foreground messages if they arrive
                    onMessage(messaging, (payload) => {
                        console.log('Foreground Message received:', payload);
                        alert(`Foreground Notification: ${payload.notification?.title || 'New Message'}`);
                    });

                } else {
                    updateStatus('Failed to retrieve FCM Token.', 'error');
                }
            } catch (err) {
                console.error('FCM Setup Error:', err);
                updateStatus(`FCM Setup failed. Check console. Error: ${err.message}`, 'error');
            }
        }

        /**
         * Simulates a background notification being displayed by the Service Worker.
         */
        async function sendTestNotification() {
            try {
                const registration = await navigator.serviceWorker.getRegistration();
                if (!registration) {
                    return updateStatus('Service Worker not found. Re-run setup.', 'error');
                }

                // Manually trigger the Service Worker to show a notification
                registration.showNotification('Friend Action Test', {
                    body: 'Someone just sent or accepted a friend request!',
                    icon: '../images/logo.png', 
                    // Use the `data` payload structure your sw.js expects from the server
                    data: {
                        action: 'VIEW_REQUESTS', 
                        test: true 
                    }
                });
                updateStatus('Test notification triggered successfully. Check your desktop notifications.', 'success');

            } catch (error) {
                console.error('Test Notification Error:', error);
                updateStatus(`Failed to display test notification: ${error.message}`, 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupFCM();
            testNotificationBtn.addEventListener('click', sendTestNotification);
        });

    </script>
</head>
<body>
    <div class="container">
        <h1>FCM Notification Test</h1>
        <p>This page tests if your Service Worker can register and display notifications.</p>
        
        <button id="test-notification-btn">Trigger Local Test Notification</button>

        <div id="status-message" class="status-box">Loading FCM setup...</div>
        
        <h2>Retrieved FCM Token (Send this to your server):</h2>
        <div id="fcm-token-display" class="status-box">Waiting for token...</div>

        <p class="status-error">
            If this button works, your client-side setup is correct. The problem is in your **Cloud Function/Backend** code which sends the actual notification payload to the FCM server using this token.
        </p>
    </div>
</body>
</html>

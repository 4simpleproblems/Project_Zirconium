<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - SETTINGS</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <script src="../url-tab-title-changer.js"></script>
    
    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        :root {
            /* The color variable has been removed as navigation.js manages it via --navbar-background */
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* The body padding-top is now handled by the CSS injected in test-navigation.js to account for the fixed navbar height */
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* Full-screen content wrapper */
        .settings-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 0 1rem; 
        }

        /* Header Styling */
        .page-header {
            padding: 2rem 1rem 1rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Settings Grid Layout */
        .settings-layout {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
            flex-grow: 1;
        }

        /* --- UPDATED: Sidebar Styling --- */
        .settings-sidebar {
            width: 100%;
            min-width: 200px;
            max-width: 280px;
            flex-shrink: 0;
            
            /* NEW: Sticky Sidebar Implementation */
            position: sticky;
            /* 4rem for main navbar + 1rem desired gap */
            top: 5rem; 
            /* Aligns item to the start of the flex container, crucial for sticky */
            align-self: flex-start;
            /* Set a MAX-height based on viewport, minus the sticky offset */
            max-height: calc(100vh - 5rem);
            /* Allow sidebar to scroll internally if its content is too tall */
            overflow-y: auto;
        }

        /* --- STYLING UPDATE: Replaced .sidebar-item styles with .nav-tab styles --- */
        .sidebar-item {
            flex-shrink: 0;
            padding: 8px 14px; /* from nav-tab */
            color: var(--tab-text, #9ca3af); /* from nav-tab */
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            transition: all 0.2s, color 0.3s ease, border-color 0.3s ease, background-color 0.3s ease;
            text-decoration: none;
            line-height: 1.5;
            display: flex; /* keep this */
            align-items: center; /* keep this */
            margin-bottom: 0.25rem; /* keep this */
            border: 1px solid transparent; /* from nav-tab */
            cursor: pointer; /* keep this */
        }
        
        /* FIX: Ensure icon is centered in its box */
        .sidebar-item i {
            text-align: center;
            line-height: 1.5rem; /* Matches h-6 (1.5rem) */
        }

        .sidebar-item:not(.active):hover {
            color: var(--tab-hover-text, #ffffff);
            border-color: var(--tab-hover-border, #d1d5db);
            background-color: var(--tab-hover-bg, rgba(79, 70, 229, 0.05));
        }

        .sidebar-item.active {
            color: var(--tab-active-text, #4f46e5);
            border-color: var(--tab-active-border, #4f46e5);
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            font-weight: 500;
        }
        .sidebar-item.active:hover { /* Add active hover */
            color: var(--tab-active-hover-text, #6366f1);
            border-color: var(--tab-active-hover-border, #6366f1);
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
        }
        /* --- END STYLING UPDATE --- */

        /* Main Content Panel */
        .settings-panel {
            flex-grow: 1;
            background-color: #111111;
            border: 1px solid #252525;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 70vh;
        }
        
        /* --- General Settings UI --- */
        .settings-section {
            border-bottom: 1px solid #252525;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .settings-label {
            display: block;
            font-medium text-white mb-2;
        }
        .settings-input {
            width: 100%;
            max-width: 400px;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-input:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #3b82f640;
        }
        .settings-input:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }

        /* --- STYLING UPDATE: Added new button styles from notes.html and dictionary.html --- */
        .btn-base {
            background: var(--menu-bg, #000000);
            border: 1px solid var(--menu-border, #333);
            border-radius: 0.75rem;
            color: var(--menu-text, #d1d5db);
            padding: 0.6rem 1.25rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center; /* Added */
            gap: 0.5rem;
        }
        .btn-base:hover {
            background-color: var(--menu-bg, #000000);
            border-color: var(--menu-border, #fff); 
            color: var(--tab-hover-text, #ffffff);
        }
        .btn-base:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #374151;
            color: #9ca3af;
        }

        .btn-primary-style {
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
        }
        .btn-primary-style:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }
        
        .btn-danger-style {
            color: #dc2626; /* red-600 - Darker Red */
        }
        .btn-danger-style:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-600 with 15% opacity */
            border-color: #ef4444; /* red-500 */
            color: #f87171; /* red-400 - Brighter on hover */
        }
        
        /* NEW: Secondary button style with accent */
        .btn-secondary-style {
            color: #60a5fa; /* blue-400 */
        }
        .btn-secondary-style:hover {
            background-color: rgba(96, 165, 250, 0.1); /* blue-400 with 10% opacity */
            border-color: #60a5fa; /* blue-400 */
            color: #93c5fd; /* blue-300 */
        }
        /* --- END STYLING UPDATE --- */
        
        /* --- START: CUSTOM STYLING FOR FILE CHOOSER (Saves Category) --- */

        /* Style the file input itself (the container) */
        input[type="file"] {
            display: block;
            width: 100%;
            max-width: 400px;
            background-color: #111111; /* Match the panel background */
            border: 1px solid #252525; /* Match the panel border */
            color: #c0c0c0;
            border-radius: 0.75rem;
            padding: 0.5rem; 
            font-size: 0.9rem;
        }

        /* Style the file selection button pseudo-element to look like the primary button */
        input[type="file"]::-webkit-file-upload-button,
        input[type="file"]::file-selector-button {
            /* Use the primary button styling */
            background-color: var(--tab-active-bg, rgba(79, 70, 229, 0.1));
            border: 1px solid var(--tab-active-border, #4f46e5);
            color: var(--tab-active-text, #4f46e5);
            padding: 0.5rem 1rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            /* Spacing */
            margin-right: 1rem; 
            /* Reset browser default look */
            -webkit-appearance: none;
            appearance: none;
        }

        /* Add hover state to the button part */
        input[type="file"]::-webkit-file-upload-button:hover,
        input[type="file"]::file-selector-button:hover {
            background-color: var(--tab-active-hover-bg, rgba(79, 70, 229, 0.15));
            border-color: var(--tab-active-hover-border, #6366f1);
            color: var(--tab-active-hover-text, #6366f1);
        }

        /* --- END: CUSTOM STYLING FOR FILE CHOOSER (Saves Category) --- */


        .settings-description {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.5rem;
            max-width: 600px;
        }
        .message-area {
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }
        .message-error { color: #f87171; /* red-400 */ }
        .message-success { color: #4ade80; /* green-400 */ }
        .message-warning { color: #facc15; /* yellow-400 */ }

        /* Standard loading screen style */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #070707;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* Mobile adjustments: Hide sidebar and adjust layout */
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
                gap: 1rem;
            }
            .settings-sidebar {
                max-width: 100%;
                margin-bottom: 0;
                /* On mobile, un-stick the sidebar */
                position: static;
                height: auto;
                max-height: none; /* Reset max-height for mobile */
                overflow-y: visible;
            }
        }

        /* --- REMOVED: .color-option and related theme picker styles --- */


        .form-select, .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 6px;
            color: white;
            padding: 8px 12px;
            font-size: 14px;
        }

        .form-select:focus, .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        
        /* Specific max-width for settings inputs */
        .form-input.settings-input-width, .form-select.settings-input-width {
            max-width: 400px;
        }
        
        /* --- REMOVED: emoji-btn styles --- */

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .setting-header {
            flex: 1;
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 48px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b8...
        }

        .favicon-picker-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background-color: #1f2937; /* gray-800 */
            border-radius: 8px;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            padding: 4px;
        }
        .favicon-picker-item:hover {
            border-color: #6b7280; /* gray-500 */
        }
        .favicon-picker-item.selected {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 1px #4f46e5;
        }
        .favicon-picker-item img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .favicon-fetch-preview {
            width: 60px;
            height: 60px;
            border: 1px solid #4b5563; /* gray-600 */
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #374151; /* gray-700 */
            flex-shrink: 0;
            padding: 5px; /* Added padding */
        }
        .favicon-fetch-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        } 
        /* --- END: NEW STYLES FOR TAB DISGUISER --- */
    </style>
    <script async src="https://www.googagletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1D4F692C1Q');
    </script>
</head>
<body class="dark:text-gray-300 dark:bg-gray-900">
    <div id="navigation-bar-placeholder"></div>
    <div class="settings-wrapper" id="page-content">
        <header class="page-header">
            <h1 class="text-3xl font-semibold text-white tracking-wide" id="main-title">SETTINGS</h1>
        </header>

        <div class="settings-layout">
            <nav class="settings-sidebar rounded-lg p-2 flex flex-col space-y-1 bg-[#111111] border border-[#252525]">
                <div id="settings-sidebar"></div>
            </nav>

            <main class="settings-panel">
                <h2 class="text-2xl font-semibold mb-6 text-white" id="panel-title"></h2>
                <div id="panel-content">
                    </div>
            </main>
        </div>
    </div>
    
    <div id="loading-screen" class="fixed inset-0 bg-[#070707] flex items-center justify-center z-50">
        <i class="fas fa-spinner fa-spin text-4xl text-indigo-500"></i>
    </div>

    <script type="module">
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        
        // Firebase Config (Replace with your actual config)
        const firebaseConfig = {
            apiKey: "...",
            authDomain: "...",
            projectId: "...",
            storageBucket: "...",
            messagingSenderId: "...",
            appId: "...",
            measurementId: "..."
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Constants
        const PANIC_KEY_DB_NAME = 'panicKeyDB';
        const PANIC_KEY_STORE_NAME = 'panicKeys';
        const NAVBAR_SETTINGS_KEY = 'navbarTheme';
        
        let currentUser = null;
        let unsubscribeUserDoc = null;

        // Mock theme data (REMOVED: Theme syncing is gone, but we keep default variables)
        const mockThemes = [
            { name: "Dark", "navbar-bg": "#000000", "tab-active-text": "#4f46e5" },
        ];


        // --- SECTION CONFIGURATION ---
        const settingsSections = [
            { id: 'general', title: 'General', icon: 'fa-cog', color: 'text-indigo-400' },
            { id: 'saves', title: 'Saves', icon: 'fa-database', color: 'text-green-400' },
            { id: 'tab-disguiser', title: 'Tab Disguiser', icon: 'fa-mask', color: 'text-blue-400' },
            { id: 'panic-key', title: 'Panic Key', icon: 'fa-hand-paper', color: 'text-red-400' },
            // REMOVED: The 'personalization' section to eliminate theme syncing/selection
            { id: 'security', title: 'Privacy & Security', icon: 'fa-shield-alt', color: 'text-yellow-400' },
            { id: 'about', title: 'About 4SP', icon: 'fa-info-circle', color: 'text-gray-400' },
        ];


        const pageContent = document.getElementById('page-content');
        const mainTitle = document.getElementById('main-title');
        const sidebarNav = document.getElementById('settings-sidebar');
        const panelTitle = document.getElementById('panel-title');
        const panelContent = document.getElementById('panel-content');
        const pageHtmlTitle = document.getElementById('page-title');

        // --- NEW: AUTHENTICATION & DATA FLOW ---
        function startAuthFlow() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    currentUser = user;

                    // Stop any previous listener
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }

                    // Get the user's document reference
                    const userDocRef = doc(db, 'users', user.uid);

                    // Set up a real-time listener for the user's data
                    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            // Data found
                            const userData = docSnap.data();
                            // Theme logic removed
                        } else {
                            // Document doesn't exist, create it (Theme logic removed)
                            console.log("User document not found, assuming default settings.");
                        }
                    }, (error) => {
                        console.error("Error fetching user data:", error);
                    });

                    // Finish loading UI
                    renderSidebar();
                    // Load the default section if no hash is present, or load from hash
                    const initialSection = window.location.hash ? window.location.hash.substring(1) : settingsSections[0].id;
                    navigateToSection(initialSection);

                    loadingScreen.style.display = 'none';
                    pageContent.classList.remove('hidden');
                    pageContent.style.display = 'flex';

                } else {
                    // User is signed out. Redirect to login/index page.
                    window.location.href = '../index.html';
                }
            });
        }
        
        // --- REMOVED: loadThemeData() function (no longer needed) ---


        // --- SETTINGS UI LOGIC ---
        function renderSidebar() {
            sidebarNav.innerHTML = ''; // Clear existing content
            settingsSections.forEach(section => {
                const item = document.createElement('div');
                item.className = 'sidebar-item group';
                item.id = `sidebar-${section.id}`;
                item.setAttribute('data-section', section.id);
                item.innerHTML = `
                    <i class="fas ${section.icon} w-6 h-6 mr-3 ${section.color} transition-transform group-hover:scale-110"></i>
                    <span>${section.title}</span>
                `;
                
                item.addEventListener('click', () => {
                    navigateToSection(section.id);
                });

                sidebarNav.appendChild(item);
            });
        }

        function navigateToSection(sectionId) {
            const section = settingsSections.find(s => s.id === sectionId);
            if (!section) {
                sectionId = settingsSections[0].id;
                // Find default section
                const defaultSection = settingsSections[0];
                panelTitle.textContent = defaultSection.title;
                pageHtmlTitle.textContent = `4SP - ${defaultSection.title.toUpperCase()}`;
            } else {
                panelTitle.textContent = section.title;
                pageHtmlTitle.textContent = `4SP - ${section.title.toUpperCase()}`;
            }
            
            // 2. Render the panel content
            // Clear content first
            panelContent.innerHTML = '';

            // 3. Call specific render function
            const activeSection = sectionId;
            if (sectionId === 'general') {
                renderGeneralSettings();
            } else if (sectionId === 'security') {
                renderPrivacySecurity();
            } else if (sectionId === 'saves') {
                renderSaves();
            } else if (sectionId === 'tab-disguiser') {
                renderTabDisguiserSettings();
            } else if (sectionId === 'panic-key') {
                renderPanicKeySettings();
            } 
            // REMOVED: The 'personalization' check (theme syncing)
            else if (sectionId === 'about') {
                renderAboutSection();
            } else {
                // Render placeholder for all other sections
                panelContent.innerHTML = `
                    <div class="flex flex-col items-center justify-center space-y-4 p-8 min-h-[40vh]">
                        <i class="fas ${section.icon} text-6xl ${section.color} opacity-50"></i>
                        <h3 class="text-2xl font-semibold text-white">${section.title}</h3>
                        <p class="text-lg text-gray-400">This section is coming soon!</p>
                    </div>
                `;
            }

            // 4. Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sidebar-${sectionId}`).classList.add('active');

            // --- NEW: Hash Routing ---
            // Set hash in URL
            if (window.location.hash !== `#${sectionId}`) {
                history.pushState(null, null, `#${sectionId}`);
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('hashchange', () => {
            const sectionId = window.location.hash ? window.location.hash.substring(1) : settingsSections[0].id;
            const sectionExists = settingsSections.some(s => s.id === sectionId);
            if (sectionExists) {
                 navigateToSection(sectionId);
            }
        });


        // --- RENDERING FUNCTIONS ---

        /**
         * Renders the General Settings panel.
         */
        function renderGeneralSettings() {
            // Placeholder for General Settings content
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Account</h3>
                    <div id="general-messages" class="message-area hidden"></div>
                    
                    <label for="username-input" class="settings-label text-white">Display Name</label>
                    <input type="text" id="username-input" placeholder="Enter your display name" class="settings-input settings-input-width mb-4" />
                    
                    <label for="email-input" class="settings-label text-white">Email Address</label>
                    <input type="email" id="email-input" placeholder="Your current email" class="settings-input settings-input-width mb-4" disabled />
                    
                    <button id="save-general-btn" class="btn-base btn-primary-style">Save Changes</button>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Linked Providers</h3>
                    <div id="linked-providers-list" class="space-y-3">
                        </div>
                </div>
            `;
            setupGeneralEventListeners();
            renderLinkedProviders();
        }

        /**
         * Renders the Privacy & Security panel.
         */
        function renderPrivacySecurity() {
            // --- UPDATED: Modified introductory text to remove 'data management' cross-category mention ---
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-red-400 mb-4">Danger Zone</h3>
                    <p class="settings-description mb-4">
                        Deleting your account is permanent and cannot be undone. All your data will be removed.
                    </p>
                    <button id="delete-account-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-trash-alt mr-2"></i> Delete Account
                    </button>
                </div>
                
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Privacy</h3>
                    <p class="settings-description mt-4"> 
                        We respect your privacy and are committed to protecting your data.
                    </p>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Security</h3>
                    <div class="setting-item">
                        <div class="setting-header">
                            <h4 class="text-lg font-medium text-white">Two-Factor Authentication (2FA)</h4>
                            <p class="text-sm text-gray-400">Add an extra layer of security to your account. <strong>(Coming Soon)</strong></p>
                        </div>
                        <div class="setting-control">
                            <button class="btn-base" disabled>Setup 2FA</button>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3 class="text-xl font-semibold text-white mb-4">Active Sessions</h3>
                        <p class="settings-description mb-4">
                            View and manage all devices currently logged into your account.
                            </p>
                        <button id="logout-all-btn" class="btn-base btn-secondary-style">
                            <i class="fas fa-sign-out-alt mr-2"></i> Log out of all other devices
                        </button>
                    </div>
                </div>
            `; 
            // No listeners needed for this placeholder function.
        }

        /**
         * Renders the Saves panel.
         */
        function renderSaves() {
            // Placeholder for Saves content (Import/Export/Clear)
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Export Data</h3>
                    <p class="settings-description mb-4">
                        Download a copy of your application data (like notes, dictionary history, etc.) for backup.
                    </p>
                    <button id="export-data-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-file-export mr-2"></i> Export All Data
                    </button>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Import Data</h3>
                    <p class="settings-description mb-4">
                        Upload a previously exported file to restore your application data. This will overwrite existing local data.
                    </p>
                    <input type="file" id="import-file-input" accept=".json" class="mb-4">
                    <button id="import-data-btn" class="btn-base btn-secondary-style">
                        <i class="fas fa-file-import mr-2"></i> Import Data
                    </button>
                    <div id="import-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-danger mb-4">Clear Local Storage</h3>
                    <p class="settings-description mb-4">
                        Permanently delete all local, un-synced data from this device (notes, settings, etc.).
                    </p>
                    <button id="clear-local-data-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-eraser mr-2"></i> Clear Data
                    </button>
                </div>
            `;
            setupSavesEventListeners();
        }

        /**
         * Renders the Tab Disguiser settings panel.
         */
        function renderTabDisguiserSettings() {
            // ... (Tab Disguiser content remains the same)
            
            // Re-use existing content:
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Title Disguise</h3>
                    <p class="settings-description mb-4">
                        Select a preset or enter a custom title to change the browser tab's name.
                    </p>
                    
                    <label for="disguise-preset-select" class="settings-label text-white">Select Preset</label>
                    <select id="disguise-preset-select" class="form-select settings-input-width mb-4">
                        </select>

                    <div id="custom-disguise-options" class="hidden space-y-4">
                        <label for="custom-title-input" class="settings-label text-white">Custom Title</label>
                        <input type="text" id="custom-title-input" placeholder="e.g., Google Docs" class="settings-input settings-input-width" />
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Favicon Disguise</h3>
                    <p class="settings-description mb-4">
                        Choose an icon from a preset or paste a URL to disguise the tab icon.
                    </p>

                    <div id="favicon-upload-section" class="space-y-4">
                        <label for="favicon-fetch-input" class="settings-label text-white">Favicon Image URL</label>
                        <div class="flex items-center gap-4">
                            <div class="favicon-fetch-preview">
                                <img id="favicon-fetch-preview-img" src="" alt="Preview" class="hidden w-full h-full" />
                            </div>
                            <input type="url" id="favicon-fetch-input" placeholder="Paste image URL here" class="settings-input flex-grow" />
                            <button id="fetch-favicon-btn" class="btn-base btn-secondary-style flex-shrink-0" style="padding: 0.75rem 1.25rem;">
                                Preview
                            </button>
                        </div>
                    </div>
                    
                    <h4 class="text-lg font-semibold text-white mt-6 mb-3">Preset Icons</h4>
                    <div id="preset-favicon-grid" class="grid grid-cols-5 gap-3 max-w-lg">
                        </div>
                </div>
                
                <div class="flex items-center gap-4 mt-6">
                    <button id="save-disguise-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-save mr-2"></i> Save Settings
                    </button>
                    <button id="clear-disguise-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-times mr-2"></i> Clear Disguise
                    </button>
                </div>
                
                <div id="tab-disguise-message" class="message-area"></div>
            `;
            loadTabDisguiserSettings();
            setupTabDisguiserEventListeners();
            renderCustomFaviconGrid();
        }

        /**
         * Renders the Panic Key settings panel.
         */
        function renderPanicKeySettings() {
            // Re-use existing content:
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Panic Key Configuration</h3>
                    <p class="settings-description mb-4">
                        Set one or more keys and target URLs. When you press the key on any application page, it will instantly redirect to the specified URL. The settings page itself is excluded.
                    </p>
                    <div id="panic-key-list" class="space-y-4">
                    </div>
                    <div class="flex items-center gap-4 mt-6">
                        <label for="panic-key-count" class="settings-label mb-0">Number of Panic Keys (1-5):</label>
                        <select id="panic-key-count" class="form-select w-20">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center gap-4 mt-6">
                    <button id="save-panic-key-btn" class="btn-base btn-primary-style">
                        <i class="fas fa-save mr-2"></i> Save Key Settings
                    </button>
                    <button id="clear-panic-key-btn" class="btn-base btn-danger-style">
                        <i class="fas fa-times mr-2"></i> Clear All Keys
                    </button>
                </div>
                
                <div id="panic-key-message" class="message-area"></div>
            `;
            loadPanicKeySettings();
            setupPanicKeyEventListeners();
        }
        
        // --- UPDATED: About 4SP Function for custom buttons ---
        function renderAboutSection() {
            // Uses btn-primary-style as the base look, but overrides background/border/color
            // to match platform hues, as requested. X (Twitter) is black.

            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Support & Community</h3>
                    <p class="settings-description mb-6">
                        Connect with the developer and support the project's ongoing development.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-4">
                        
                        <a href="https://x.com/4simpleproblems" target="_blank" rel="noopener noreferrer" 
                            class="btn-base btn-primary-style text-center flex items-center justify-center py-4 text-base" 
                            style="background-color: #000000; border-color: #000000; color: white;"
                        >
                            <i class="fab fa-x-twitter fa-fw mr-3 text-lg"></i> X
                        </a>
                        
                        <a href="https://youtube.com/@4simpleproblems" target="_blank" rel="noopener noreferrer" 
                            class="btn-base btn-primary-style text-center flex items-center justify-center py-4 text-base" 
                            style="background-color: #CD201F; border-color: #CD201F; color: white;"
                        >
                            <i class="fab fa-youtube fa-fw mr-3 text-lg"></i> YouTube
                        </a>

                        <a href="https://github.com/4simpleproblems" target="_blank" rel="noopener noreferrer" 
                            class="btn-base btn-primary-style text-center flex items-center justify-center py-4 text-base" 
                            style="background-color: #181717; border-color: #181717; color: white;"
                        >
                            <i class="fab fa-github fa-fw mr-3 text-lg"></i> GitHub
                        </a>
                        
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" rel="noopener noreferrer" 
                            class="btn-base btn-primary-style text-center flex items-center justify-center py-4 text-base" 
                            style="background-color: #FFDD00; border-color: #FFDD00; color: #000000;"
                        >
                            <i class="fas fa-coffee fa-fw mr-3 text-lg"></i> Buy Me a Coffee
                        </a>
                    </div>
                </div>
            `;
            // --- END STYLING UPDATE ---
        }
        
        /* --- [END] NEW ABOUT 4SP FUNCTION --- */


        // --- START APPLICATION ---
        document.addEventListener('DOMContentLoaded', startAuthFlow);
    </script>
</body>
</html>

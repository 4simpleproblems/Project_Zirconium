<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DAILYPHOTO</title>
    <meta name="description" content="Share your day with friends through three daily photos.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script> 

    <style>
        /* BUBBLY ANIMATIONS: Keyframes for cute/bubbly effects */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes particleGlow {
            0% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
            50% { box-shadow: 0 0 15px #4f46e5, 0 0 20px #4f46e5; }
            100% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
        }
        
        /* Custom Styles for friend code input and tabs */
        .tab-btn.active {
            color: #818cf8; /* indigo-300 */
            border-bottom-color: #818cf8;
        }
        .tab-btn:not(.active) {
            color: #9ca3af; /* custom-light-gray */
            border-bottom-color: transparent;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#070707',
                        'custom-dark-gray': '#111111',
                        'custom-medium-gray': '#252525',
                        'custom-light-gray': '#9ca3af', // Updated from #505050 to be lighter text
                    },
                }
            },
        }
    </script>
</head>
<body class="bg-custom-darkest-gray text-white min-h-screen pt-16 font-geist">
    <main class="container mx-auto p-4 max-w-4xl">
        <h1 class="text-3xl font-bold mb-6 text-center text-indigo-400">4SP - Daily Photo</h1>
        <div id="auth-status" class="text-center text-custom-light-gray mb-6"></div>

        <section id="daily-posts-section" class="mb-8 p-4 bg-custom-dark-gray rounded-xl shadow-lg animate-popIn">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-camera mr-3 text-indigo-400"></i>Daily Posts
            </h2>

            <div id="post-tabs" class="flex border-b border-custom-medium-gray mb-4">
                <button data-post="post1" class="tab-btn text-lg py-2 px-4 transition-colors font-medium focus:outline-none">Post 1</button>
                <button data-post="post2" class="tab-btn text-lg py-2 px-4 transition-colors font-medium focus:outline-none">Post 2</button>
                <button data-post="post3" class="tab-btn text-lg py-2 px-4 transition-colors font-medium focus:outline-none">Post 3</button>
            </div>

            <input type="file" id="image-upload" accept="image/*" class="hidden">
            
            <div id="post-editor" class="p-4 border border-custom-medium-gray rounded-lg">
                <p id="current-post-display" class="text-sm text-custom-light-gray mb-4">Select an image to start or view your current post details for <span class="font-bold text-indigo-300" id="current-tab-name">Post 1</span>.</p>
                
                <button id="upload-image-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                    <i class="fas fa-image mr-2"></i> Select Image
                </button>
                
                <div id="post-preview-form" class="hidden mt-4 p-4 border border-indigo-500/50 rounded-lg bg-custom-medium-gray/30">
                    <p class="text-sm font-semibold mb-2 text-indigo-300">Image Preview:</p>
                    <img id="image-preview" class="w-full h-48 object-cover rounded-lg mb-4 border border-custom-medium-gray">
                    
                    <label for="post-title" class="block text-sm font-medium mb-1">Title:</label>
                    <input type="text" id="post-title" placeholder="Enter title (required)" maxlength="50" class="w-full p-2 mb-4 rounded bg-custom-darkest-gray border border-custom-medium-gray focus:border-indigo-500 focus:outline-none">
                    
                    <label for="post-caption" class="block text-sm font-medium mb-1">Caption:</label>
                    <textarea id="post-caption" rows="3" placeholder="Enter caption (optional)" maxlength="200" class="w-full p-2 mb-4 rounded bg-custom-darkest-gray border border-custom-medium-gray focus:border-indigo-500 focus:outline-none"></textarea>
                    
                    <button id="confirm-post-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded transition duration-200 w-full disabled:opacity-50" disabled>
                        <i class="fas fa-check mr-2"></i> Confirm Post
                    </button>
                </div>
                
                <div id="post-message" class="mt-3 text-sm hidden"></div>

                <div id="recent-daily-posts" class="mt-6">
                    <h3 class="text-lg font-semibold mb-3 text-indigo-300">Your Recent Daily Posts</h3>
                    <div id="daily-posts-list" class="space-y-4">
                        <p class="text-custom-light-gray text-center p-4">Loading your posts...</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="feed-section" class="mb-8 p-4 bg-custom-dark-gray rounded-xl shadow-lg animate-popIn">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-users mr-3 text-indigo-400"></i>Friend Feed
            </h2>
            <div id="feed-container" class="space-y-6">
                <p id="feed-status" class="text-center text-custom-light-gray p-4">Loading feed...</p>
            </div>
        </section>

        <section id="friends-section" class="mb-8 p-4 bg-custom-dark-gray rounded-xl shadow-lg animate-popIn">
            <h2 class="text-2xl font-bold mb-4 flex items-center">
                <i class="fas fa-handshake mr-3 text-indigo-400"></i>Friends
            </h2>

            <div id="add-friend-form" class="mb-6 p-4 bg-custom-medium-gray rounded-lg">
                <h3 class="text-xl font-semibold mb-3 text-indigo-300">Add Friend by Code</h3>
                <div class="flex flex-col sm:flex-row gap-2">
                    <input type="text" id="friend-code-input" placeholder="8-DIGIT CODE" maxlength="8"
                           style="font-family: 'Geist', sans-serif;"
                           class="flex-grow p-2 rounded bg-custom-darkest-gray border border-custom-dark-gray focus:border-indigo-500 focus:outline-none text-xl tracking-[0.2em] uppercase placeholder-custom-light-gray/50"
                           oninput="this.value = this.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase();"
                           aria-label="Friend Code">
                    
                    <button id="add-friend-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded transition duration-200 disabled:opacity-50">
                        <i class="fas fa-user-plus mr-1"></i> Add
                    </button>
                </div>
                <div id="add-friend-message" class="mt-2 text-sm"></div>
            </div>

            <h3 class="text-xl font-semibold mb-3 text-indigo-300">Your Friends (<span id="friend-count">0</span>)</h3>
            <div id="friend-list-container" class="space-y-2">
                <p class="text-custom-light-gray text-center p-4">Loading friends...</p>
            </div>
        </section>

    </main>

    <script type="module">
        // Import necessary Firebase modules (assuming Firebase is initialized in navigation.js and global to window)
        import { getAuth } from 'https://www.gstatic.com/firebase/9.6.10/firebase-auth.js';
        import { getFirestore, doc, collection, onSnapshot, query, where, orderBy, limit, getDoc, writeBatch, arrayRemove, arrayUnion, serverTimestamp } from 'https://www.gstatic.com/firebase/9.6.10/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebase/9.6.10/firebase-storage.js';

        // Check for global Firebase objects initialized by navigation.js
        if (!window.firebaseApp) {
            console.error("Firebase app not initialized. Ensure navigation.js runs first.");
            // Halt script execution if Firebase is not available
            document.getElementById('auth-status').textContent = 'Error: Firebase not initialized.';
            throw new Error("Firebase not initialized.");
        }

        const auth = getAuth(window.firebaseApp);
        const db = getFirestore(window.firebaseApp);
        const storage = getStorage(window.firebaseApp);

        // --- Helper Functions ---
        const getUserProfileDocRef = (uid) => doc(db, 'profiles', uid);
        const showMessage = (element, message, type = 'error') => {
            element.textContent = message;
            element.className = type === 'success' ? 'mt-2 text-sm text-green-400' : 'mt-2 text-sm text-red-400';
            element.style.display = 'block';
            setTimeout(() => element.style.display = 'none', 5000);
        };

        // --- GLOBAL STATE ---
        let currentPostKey = 'post1'; // post1, post2, or post3
        let uploadedFile = null;
        let currentFeedUnsubscribe = null; // To manage the dynamic feed listener

        // --- DAILY POSTS LOGIC (TABS, UPLOAD, CONFIRM) ---
        
        const tabs = document.querySelectorAll('.tab-btn');
        const uploadImageBtn = document.getElementById('upload-image-btn');
        const imageUploadInput = document.getElementById('image-upload');
        const postPreviewForm = document.getElementById('post-preview-form');
        const imagePreview = document.getElementById('image-preview');
        const postTitleInput = document.getElementById('post-title');
        const postCaptionInput = document.getElementById('post-caption');
        const confirmPostBtn = document.getElementById('confirm-post-btn');
        const postMessageDiv = document.getElementById('post-message');
        const currentTabName = document.getElementById('current-tab-name');

        const switchTab = (newKey) => {
            currentPostKey = newKey;
            currentTabName.textContent = newKey.replace('post', 'Post ');
            
            tabs.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.post === newKey);
                btn.classList.toggle('text-indigo-400', btn.dataset.post === newKey);
                btn.classList.toggle('border-indigo-400', btn.dataset.post === newKey);
                btn.classList.toggle('text-custom-light-gray', btn.dataset.post !== newKey);
                btn.classList.toggle('border-transparent', btn.dataset.post !== newKey);
            });
            // Reset form for new tab
            uploadedFile = null;
            postPreviewForm.classList.add('hidden');
            postTitleInput.value = '';
            postCaptionInput.value = '';
            confirmPostBtn.disabled = true;
            postMessageDiv.style.display = 'none';

            // In a real app, you would load the current saved post data for this tab here.
        };

        tabs.forEach(btn => {
            btn.addEventListener('click', () => switchTab(btn.dataset.post));
        });

        uploadImageBtn.addEventListener('click', () => imageUploadInput.click());

        // Single Image Upload logic
        imageUploadInput.addEventListener('change', (e) => {
            uploadedFile = e.target.files[0];
            if (uploadedFile) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    imagePreview.src = e.target.result;
                    postPreviewForm.classList.remove('hidden'); // Show the preview menu/form
                    confirmPostBtn.disabled = !postTitleInput.value.trim();
                };
                reader.readAsDataURL(uploadedFile);
            } else {
                postPreviewForm.classList.add('hidden');
                confirmPostBtn.disabled = true;
            }
        });

        postTitleInput.addEventListener('input', () => {
            confirmPostBtn.disabled = !postTitleInput.value.trim() || !uploadedFile;
        });

        // Post Confirmation (Upload to Storage & Save to Firestore)
        confirmPostBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !uploadedFile || !postTitleInput.value.trim()) {
                showMessage(postMessageDiv, 'Missing image or title.', 'error');
                return;
            }

            confirmPostBtn.disabled = true;
            confirmPostBtn.textContent = 'Uploading...';

            try {
                // 1. Upload image to Storage
                const storagePath = `users/${user.uid}/posts/${currentPostKey}-${Date.now()}`;
                const imageRef = ref(storage, storagePath);
                await uploadBytes(imageRef, uploadedFile);
                const imageUrl = await getDownloadURL(imageRef);

                // 2. Save metadata to Firestore
                const postData = {
                    uid: user.uid,
                    postKey: currentPostKey,
                    title: postTitleInput.value.trim(),
                    caption: postCaptionInput.value.trim(),
                    imageUrl: imageUrl,
                    timestamp: serverTimestamp(),
                    // In a production app, you might use an 'id' based on postKey to ensure only one of each is saved per day.
                };
                // Assuming you use a document ID that ensures only one post per key
                await doc(collection(db, 'posts'), `${user.uid}_${currentPostKey}_${new Date().toISOString().split('T')[0]}`).set(postData);

                showMessage(postMessageDiv, `${currentPostKey.toUpperCase()} confirmed successfully!`, 'success');
                // Reset form state after successful post
                uploadedFile = null;
                imageUploadInput.value = null; // Clear file input
                postTitleInput.value = '';
                postCaptionInput.value = '';
                postPreviewForm.classList.add('hidden');

            } catch (error) {
                console.error("Error confirming post:", error);
                showMessage(postMessageDiv, `Error posting: ${error.message}`, 'error');
            } finally {
                confirmPostBtn.textContent = 'Confirm Post';
                confirmPostBtn.disabled = false;
            }
        });

        // --- ON-SNAPSHOT LISTENERS ---

        /**
         * Setup listener for the user's three most recent daily posts.
         */
        const setupDailyPostsListener = (user) => {
            const postsListDiv = document.getElementById('daily-posts-list');
            const q = query(collection(db, 'posts'), 
                where('uid', '==', user.uid), 
                orderBy('timestamp', 'desc'), 
                limit(3)
            );

            return onSnapshot(q, (snapshot) => {
                postsListDiv.innerHTML = ''; // Clear existing list
                
                if (snapshot.empty) {
                    postsListDiv.innerHTML = '<p class="text-custom-light-gray text-center p-4">You have not made any daily posts yet.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const post = doc.data();
                    const postElement = document.createElement('div');
                    postElement.className = 'p-3 bg-custom-medium-gray rounded-lg flex items-center shadow-md';
                    const postTime = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleTimeString() : '...';
                    
                    postElement.innerHTML = `
                        <img src="${post.imageUrl}" alt="${post.title}" class="w-12 h-12 object-cover rounded mr-4">
                        <div>
                            <p class="font-semibold text-white">${post.title}</p>
                            <p class="text-sm text-custom-light-gray">${post.caption || 'No caption'}</p>
                            <p class="text-xs text-custom-light-gray">${postTime}</p>
                        </div>
                    `;
                    postsListDiv.appendChild(postElement);
                });
            }, (error) => {
                console.error("Error setting up daily posts listener:", error);
                postsListDiv.innerHTML = '<p class="text-red-400 text-center p-4">Error loading posts.</p>';
            });
        };

        /**
         * Setup listener for the friend feed (user's posts + friends' posts).
         * This listener is dynamic and must be re-run if the friend list changes.
         */
        const setupFeedListener = (user, friendUids) => {
            if (currentFeedUnsubscribe) {
                currentFeedUnsubscribe(); // Unsubscribe from the previous listener
            }

            const feedContainer = document.getElementById('feed-container');
            const allUids = [...friendUids, user.uid];
            
            feedContainer.innerHTML = '<p id="feed-status" class="text-center text-custom-light-gray p-4">Loading feed...</p>';

            if (allUids.length === 0) {
                feedContainer.innerHTML = '<p class="text-custom-light-gray text-center p-4">Add friends to see their daily posts here!</p>';
                return;
            }
            
            // NOTE: Firestore 'in' query limit is 10 items.
            const UidList = allUids.slice(0, 10);
            
            // Query the 'posts' collection using the list of UIDs
            const q = query(
                collection(db, 'posts'),
                where('uid', 'in', UidList),
                orderBy('timestamp', 'desc'),
                limit(20)
            );

            currentFeedUnsubscribe = onSnapshot(q, async (snapshot) => {
                feedContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    feedContainer.innerHTML = '<p class="text-custom-light-gray text-center p-4">No recent posts from you or your friends.</p>';
                    return;
                }

                // Fetch usernames for post authors
                const authorUids = [...new Set(snapshot.docs.map(doc => doc.data().uid))];
                const authorPromises = authorUids.map(uid => getDoc(getUserProfileDocRef(uid)));
                const authorDocs = await Promise.all(authorPromises);
                const authorMap = authorDocs.reduce((map, doc) => {
                    if (doc.exists()) {
                        // Use username as display name
                        map[doc.id] = doc.data().username || 'Unknown User'; 
                    }
                    return map;
                }, {});
                
                snapshot.forEach(doc => {
                    const post = doc.data();
                    const username = authorMap[post.uid] || 'Unknown User';
                    const postDate = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : '...';

                    const postElement = document.createElement('div');
                    postElement.className = 'post-card bg-custom-medium-gray rounded-xl shadow-xl overflow-hidden';
                    postElement.innerHTML = `
                        <div class="p-3 border-b border-custom-dark-gray flex items-center">
                            <i class="fas fa-user-circle text-indigo-400 text-2xl mr-2"></i>
                            <span class="font-semibold">${username}</span>
                        </div>
                        <img src="${post.imageUrl}" alt="${post.title}" class="w-full h-80 object-cover">
                        <div class="p-4">
                            <h4 class="text-xl font-bold mb-1">${post.title}</h4>
                            <p class="text-custom-light-gray mb-2">${post.caption || 'No caption.'}</p>
                            <p class="text-xs text-custom-light-gray">${postDate}</p>
                        </div>
                    `;
                    feedContainer.appendChild(postElement);
                });
            }, (error) => {
                console.error("Error setting up feed listener:", error);
                feedContainer.innerHTML = '<p class="text-red-400 text-center p-4">Error loading feed.</p>';
            });
        };

        /**
         * Setup listener for the user's friends list and trigger feed update.
         */
        const setupFriendsListListener = (user) => {
            const friendListContainer = document.getElementById('friend-list-container');
            const friendCountSpan = document.getElementById('friend-count');
            const userProfileRef = getUserProfileDocRef(user.uid);

            return onSnapshot(userProfileRef, async (docSnap) => {
                friendListContainer.innerHTML = ''; // Clear existing list
                
                const friendUids = docSnap.exists() ? docSnap.data().friends || [] : [];
                friendCountSpan.textContent = friendUids.length;

                // 1. Update the Feed Listener based on the new friend list
                setupFeedListener(user, friendUids); 

                if (friendUids.length === 0) {
                    friendListContainer.innerHTML = '<p class="text-custom-light-gray text-center p-4">Your friends list is empty. Add a friend!</p>';
                    return;
                }

                // 2. Fetch and display friend usernames
                const friendPromises = friendUids.map(uid => getDoc(getUserProfileDocRef(uid)));
                const friendDocs = await Promise.all(friendPromises);

                friendDocs.forEach(friendDoc => {
                    if (friendDoc.exists()) {
                        const friendData = friendDoc.data();
                        const username = friendData.username || 'Unknown User'; 
                        const friendUid = friendDoc.id;

                        const div = document.createElement('div');
                        div.className = 'friend-item flex justify-between items-center p-3 bg-custom-medium-gray hover:bg-custom-medium-gray/70 rounded-lg shadow-md transition';
                        div.innerHTML = `
                            <span class="font-semibold">${username}</span>
                            <button data-uid="${friendUid}" class="remove-friend-btn text-red-400 hover:text-red-500 transition px-2 py-1" title="Remove Friend">
                                <i class="fas fa-user-minus"></i>
                            </button>
                        `;
                        friendListContainer.appendChild(div);
                    }
                });

                // 3. Re-attach listeners for remove button after list rebuild
                friendListContainer.querySelectorAll('.remove-friend-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const friendUidToRemove = e.target.closest('button').dataset.uid;
                        const removeFriendMessage = document.getElementById('add-friend-message');
                        
                        try {
                            const batch = writeBatch(db);
                            batch.update(getUserProfileDocRef(user.uid), { friends: arrayRemove(friendUidToRemove) });
                            batch.update(getUserProfileDocRef(friendUidToRemove), { friends: arrayRemove(user.uid) });
                            await batch.commit();
                            showMessage(removeFriendMessage, 'Friend removed successfully!', 'success');
                        } catch (err) {
                            console.error("Error removing friend:", err);
                            showMessage(removeFriendMessage, 'Error removing friend.', 'error');
                        }
                    });
                });

            }, (error) => {
                console.error("Error setting up friends list listener:", error);
                friendListContainer.innerHTML = '<p class="text-red-400 text-center p-4">Error loading friends list.</p>';
            });
        };


        // --- ADD FRIEND LOGIC ---
        const friendCodeInput = document.getElementById('friend-code-input');
        const addFriendBtn = document.getElementById('add-friend-btn');
        const addFriendMessage = document.getElementById('add-friend-message');

        addFriendBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showMessage(addFriendMessage, 'You must be logged in.', 'error');
                return;
            }

            const code = friendCodeInput.value.trim();
            if (code.length !== 8) {
                showMessage(addFriendMessage, 'Friend code must be 8 characters.', 'error');
                return;
            }

            addFriendBtn.disabled = true;

            try {
                // Find user profile by friend code (assuming 'friendCode' field exists in 'profiles' collection)
                const profilesRef = collection(db, 'profiles');
                const q = query(profilesRef, where('friendCode', '==', code.toUpperCase()), limit(1));
                const querySnapshot = await getDocs(q);
                
                if (querySnapshot.empty) {
                    showMessage(addFriendMessage, 'No user found with that code.', 'error');
                    return;
                }

                const friendDoc = querySnapshot.docs[0];
                const friendUid = friendDoc.id;
                
                if (friendUid === user.uid) {
                    showMessage(addFriendMessage, "You can't add yourself!", 'error');
                    return;
                }

                // Atomically update both users' friend arrays
                const batch = writeBatch(db);
                batch.update(getUserProfileDocRef(user.uid), { friends: arrayUnion(friendUid) });
                batch.update(getUserProfileDocRef(friendUid), { friends: arrayUnion(user.uid) });
                await batch.commit();

                showMessage(addFriendMessage, 'Friend added successfully!', 'success');
                friendCodeInput.value = ''; // Clear input on success

            } catch (error) {
                console.error("Error adding friend:", error);
                showMessage(addFriendMessage, 'An error occurred while adding friend.', 'error');
            } finally {
                addFriendBtn.disabled = false;
            }
        });

        // --- AUTH STATE CHANGE HANDLER ---
        auth.onAuthStateChanged(user => {
            const authStatusDiv = document.getElementById('auth-status');
            if (user) {
                authStatusDiv.innerHTML = `<span class="text-green-400 font-semibold">Logged in as ${user.email}</span>`;
                
                // Initialize Listeners on successful login
                switchTab('post1'); // Initialize the daily posts tab view
                setupDailyPostsListener(user); // Start listening for user's recent posts
                setupFriendsListListener(user); // Start listening for friends list (which triggers feed update)
            } else {
                authStatusDiv.innerHTML = '<span class="text-red-400 font-semibold">Not logged in. <a href="/login.html" class="text-indigo-400 hover:underline">Log in</a> to use features.</span>';
                
                // Stop all listeners on logout
                if (currentFeedUnsubscribe) currentFeedUnsubscribe();
            }
        });
        
    </script>
</body>
</html>

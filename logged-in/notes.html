<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Notes App</title>
    <meta name="description" content="A simple, password-encrypted note-taking application for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
        }

        /* Full-screen Textarea Styling */
        #note-textarea {
            width: 100%;
            height: calc(100vh - 80px); /* Full viewport height minus header space */
            padding: 20px;
            box-sizing: border-box;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            color: #c0c0c0;
            resize: none; /* Disable manual resize */
            outline: none;
            line-height: 1.5;
            font-size: 1rem;
            /* Add some padding to the bottom to prevent the counter from obscuring text */
            padding-bottom: 50px; 
        }

        /* Floating Counter Styling (Bottom Right Corner) */
        #stat-counter {
            position: fixed; /* Makes it scroll with the screen */
            bottom: 20px; /* New position */
            right: 20px; /* New position */
            z-index: 1000;
            background-color: rgba(13, 13, 13, 0.9); /* More opaque for visibility */
            backdrop-filter: blur(5px);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #1a1a1a;
            font-size: 0.85rem;
            display: flex;
            gap: 15px; /* Compacted display */
            user-select: none;
        }
        
        /* Compacted display: "L: 0 | W: 0 | C: 0" */
        .stat-group {
            display: flex;
            align-items: center;
        }

        .stat-label {
            color: #707070;
            margin-right: 4px;
        }
        .stat-value {
            color: #ffffff;
            font-weight: 500;
        }
        .separator {
            color: #333;
            margin: 0 5px;
        }

        /* Dropdown Menu Styling */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background-color: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 10;
            min-width: 200px;
            /* Scrollable for Local Saves */
            max-height: 400px; 
            overflow-y: auto;
        }

        /* Files button pointy style */
        #file-menu-btn, #local-saves-btn {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }

        /* Local Saves Item Styling */
        .save-slot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .save-slot-item:hover {
            background-color: #2a2a2a;
        }
        .save-slot-item:not(:last-child) {
            border-bottom: 1px solid #333;
        }

        /* Marquee setup for long titles */
        .slot-title {
            flex-grow: 1;
            overflow: hidden;
            white-space: nowrap;
            margin-right: 10px;
            max-width: 130px; /* Constrain width for marquee */
        }
        .slot-title marquee {
            display: inline-block;
            width: max-content;
        }

        .dropdown-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dropdown-item:hover {
            background-color: #2a2a2a;
        }

        /* Tailwind classes for buttons */
        .btn-primary {
            padding: 8px 16px;
            border-radius: 6px;
            background-color: #4f46e5;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #374151; /* gray-600 */
        }
        .btn-secondary:hover {
            background-color: #4b5563; /* gray-700 */
        }
        .slot-action-btn {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            margin-left: 5px;
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="loading-screen" class="fixed inset-0 bg-[#070707] flex items-center justify-center z-50">
        <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
    </div>

    <div id="page-content" class="hidden container mx-auto p-4">
        <header class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-white">4SP Notes</h1>
            
            <div class="flex space-x-2">

                <div id="local-saves-container" class="relative">
                    <button id="local-saves-btn" class="btn-primary bg-gray-700 hover:bg-gray-600">
                        <i class="fa-solid fa-floppy-disk"></i> Local Saves
                    </button>

                    <div id="local-saves-dropdown" class="dropdown-menu hidden">
                        </div>
                </div>


                <div id="file-menu-container" class="relative">
                    <button id="file-menu-btn" class="btn-primary bg-gray-700 hover:bg-gray-600">
                        <i class="fa-solid fa-file"></i> Files
                    </button>

                    <div id="file-dropdown" class="dropdown-menu hidden">
                        <div class="p-2 border-b border-gray-700 text-gray-400 text-xs uppercase">Export</div>
                        <div id="save-text-btn" class="dropdown-item">
                            <i class="fa-solid fa-file-export"></i> Save Standard Text
                        </div>
                        <div id="save-encrypted-btn" class="dropdown-item">
                            <i class="fa-solid fa-lock"></i> Save Encrypted (.4spnote)
                        </div>
                        
                        <div class="p-2 border-y border-gray-700 text-gray-400 text-xs uppercase">Import</div>
                        <div id="load-file-btn" class="dropdown-item">
                            <i class="fa-solid fa-file-import"></i> Load File
                        </div>
                    </div>
                </div>

            </div>
        </header>

        <textarea id="note-textarea" placeholder="Start typing your notes here..."></textarea>
    </div>

    <input type="file" id="file-input" style="display: none;" accept=".txt, .js, .html, .4spnote">

    <div id="stat-counter">
        <div class="stat-group">
            <span class="stat-label">L:</span>
            <span id="line-count" class="stat-value">0</span>
        </div>
        <span class="separator">|</span>
        <div class="stat-group">
            <span class="stat-label">W:</span>
            <span id="word-count" class="stat-value">0</span>
        </div>
        <span class="separator">|</span>
        <div class="stat-group">
            <span class="stat-label">C:</span>
            <span id="char-count" class="stat-value">0</span>
        </div>
    </div>
    
    <script type="text/javascript">
        // Global element references
        const textarea = document.getElementById('note-textarea');
        const lineDisplay = document.getElementById('line-count');
        const wordDisplay = document.getElementById('word-count');
        const charDisplay = document.getElementById('char-count');
        const fileMenuBtn = document.getElementById('file-menu-btn');
        const fileDropdown = document.getElementById('file-dropdown');
        const saveTextBtn = document.getElementById('save-text-btn');
        const saveEncryptedBtn = document.getElementById('save-encrypted-btn');
        const loadFileBtn = document.getElementById('load-file-btn');
        const fileInput = document.getElementById('file-input');
        
        // New Local Saves element references
        const localSavesBtn = document.getElementById('local-saves-btn');
        const localSavesDropdown = document.getElementById('local-saves-dropdown');
        const LOCAL_STORAGE_KEY = '4sp-note-slots';
        const MAX_SLOTS = 50;


        // --- Utility Functions ---

        /**
         * Real-time function to update the line, word, and character counts.
         */
        function updateCounts() {
            const content = textarea.value;

            // 1. Character Count
            charDisplay.textContent = content.length;

            // 2. Line Count (by actual newlines)
            const lineCount = content.split('\n').length;
            lineDisplay.textContent = lineCount;

            // 3. Word Count
            // Trims whitespace and splits by one or more whitespace characters (\s+).
            const words = content.trim().split(/\s+/).filter(word => word.length > 0);
            wordDisplay.textContent = words.length;
        }

        /**
         * Triggers the file download in the browser.
         */
        function downloadFile(data, filename, mimeType = 'text/plain') {
            const blob = new Blob([data], { type: `${mimeType};charset=utf-8` });
            const url = URL.createObjectURL(blob);
            
            // Create a temporary link element for the download
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url); // Clean up the object URL
        }

        // --- Local Storage Functions ---

        /**
         * Retrieves all note slots from local storage.
         * @returns {Array<{title: string, content: string, date: string}>}
         */
        function getLocalNotes() {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                return data ? JSON.parse(data) : Array(MAX_SLOTS).fill(null);
            } catch (e) {
                console.error("Error reading local storage:", e);
                return Array(MAX_SLOTS).fill(null);
            }
        }

        /**
         * Updates a specific note slot in local storage.
         * @param {number} slotIndex 
         * @param {string} content - The note content to save.
         * @param {string} title - The display title.
         */
        function saveLocalNote(slotIndex, content, title) {
            const notes = getLocalNotes();
            notes[slotIndex] = {
                title: title,
                content: content,
                date: new Date().toLocaleDateString()
            };
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(notes));
                renderLocalSavesDropdown(); // Re-render to show update
                alert(`Note saved to Slot ${slotIndex + 1} as '${title}'!`);
            } catch (e) {
                alert("Failed to save to local storage. Storage limit may be reached.");
                console.error("Error saving to local storage:", e);
            }
        }

        /**
         * Clears a specific note slot.
         * @param {number} slotIndex 
         */
        function clearLocalNote(slotIndex) {
            if (!confirm(`Are you sure you want to clear Slot ${slotIndex + 1}? This action cannot be undone.`)) {
                return;
            }
            const notes = getLocalNotes();
            notes[slotIndex] = null;
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(notes));
                renderLocalSavesDropdown();
                alert(`Slot ${slotIndex + 1} cleared!`);
            } catch (e) {
                console.error("Error clearing local storage:", e);
            }
        }

        /**
         * Populates the local saves dropdown with 50 slots.
         */
        function renderLocalSavesDropdown() {
            const notes = getLocalNotes();
            localSavesDropdown.innerHTML = ''; // Clear existing list
            
            for (let i = 0; i < MAX_SLOTS; i++) {
                const slot = notes[i];
                const slotDiv = document.createElement('div');
                slotDiv.classList.add('save-slot-item');
                slotDiv.dataset.slotIndex = i;

                let titleHtml;
                if (slot) {
                    const titleText = `${slot.title} (${slot.date})`;
                    // Marquee for long titles
                    if (titleText.length > 20) { 
                        titleHtml = `<div class="slot-title"><marquee behavior="scroll" direction="left" scrollamount="3">${titleText}</marquee></div>`;
                    } else {
                        titleHtml = `<div class="slot-title">${titleText}</div>`;
                    }
                } else {
                    titleHtml = `<div class="slot-title text-gray-500">Slot ${i + 1}: Empty</div>`;
                }

                slotDiv.innerHTML = `
                    ${titleHtml}
                    <div>
                        <button class="slot-action-btn btn-primary ${slot ? 'btn-secondary' : ''}" data-action="${slot ? 'load' : 'save'}">
                            <i class="fa-solid fa-${slot ? 'arrow-right-to-bracket' : 'floppy-disk'}"></i> ${slot ? 'Load' : 'Save'}
                        </button>
                        ${slot ? `<button class="slot-action-btn bg-red-700 hover:bg-red-600 text-white" data-action="clear"><i class="fa-solid fa-trash"></i> Clear</button>` : ''}
                    </div>
                `;

                localSavesDropdown.appendChild(slotDiv);
            }
        }

        // --- Event Listeners and Handlers ---

        // Toggle the Local Saves Dropdown
        localSavesBtn.addEventListener('click', (event) => {
            event.stopPropagation(); 
            // Close other dropdown
            fileDropdown.classList.add('hidden');
            // Toggle this one
            localSavesDropdown.classList.toggle('hidden');
            if (!localSavesDropdown.classList.contains('hidden')) {
                renderLocalSavesDropdown();
            }
        });

        // Toggle the File Menu Dropdown
        fileMenuBtn.addEventListener('click', (event) => {
            // Stop propagation to prevent immediate closing by document click
            event.stopPropagation(); 
            // Close other dropdown
            localSavesDropdown.classList.add('hidden');
            // Toggle this one
            fileDropdown.classList.toggle('hidden');
        });

        // Handle actions within the Local Saves Dropdown
        localSavesDropdown.addEventListener('click', (event) => {
            const button = event.target.closest('button');
            if (!button) return;

            const slotItem = button.closest('.save-slot-item');
            const slotIndex = parseInt(slotItem.dataset.slotIndex);
            const action = button.dataset.action;
            const notes = getLocalNotes();
            const slot = notes[slotIndex];

            localSavesDropdown.classList.add('hidden'); // Close menu after action

            if (action === 'save') {
                let title = prompt(`Enter a title for Slot ${slotIndex + 1}:`, `Note ${slotIndex + 1}`);
                if (title !== null) {
                    const content = textarea.value;
                    saveLocalNote(slotIndex, content, title.trim() || `Untitled Note ${slotIndex + 1}`);
                }
            } else if (action === 'load' && slot) {
                if (textarea.value && textarea.value.trim() !== "" && !confirm("Loading this note will overwrite your current text. Continue?")) {
                    return;
                }
                textarea.value = slot.content;
                updateCounts();
                alert(`'${slot.title}' loaded from Slot ${slotIndex + 1}!`);
            } else if (action === 'clear') {
                clearLocalNote(slotIndex);
            }
        });


        // Close both dropdowns when clicking outside
        document.addEventListener('click', (event) => {
            // Check Files dropdown
            if (!fileDropdown.classList.contains('hidden') && 
                !fileMenuBtn.contains(event.target) && 
                !fileDropdown.contains(event.target)) {
                fileDropdown.classList.add('hidden');
            }
            // Check Local Saves dropdown
            if (!localSavesDropdown.classList.contains('hidden') && 
                !localSavesBtn.contains(event.target) && 
                !localSavesDropdown.contains(event.target)) {
                localSavesDropdown.classList.add('hidden');
            }
        });

        // 1. Save Standard Text
        saveTextBtn.addEventListener('click', () => {
            fileDropdown.classList.add('hidden'); // Close menu
            const content = textarea.value;
            let filename = prompt("Enter filename (e.g., 'my-note.js', 'todo.txt'):", 'my-note.txt');

            if (filename) {
                downloadFile(content, filename);
                alert(`Note saved as '${filename}'!`);
            }
        });

        // 2. Save Encrypted .4spnote File
        saveEncryptedBtn.addEventListener('click', () => {
            fileDropdown.classList.add('hidden'); // Close menu
            const content = textarea.value;
            const password = prompt("Enter a password to encrypt your note:");

            if (password) {
                try {
                    // Use CryptoJS.AES.encrypt with the content and password
                    const encrypted = CryptoJS.AES.encrypt(content, password).toString();

                    let filename = prompt("Enter a filename for your encrypted note:", 'my-secret-note.4spnote');
                    
                    if (filename && !filename.endsWith('.4spnote')) {
                         filename += '.4spnote';
                    }

                    if (filename) {
                        downloadFile(encrypted, filename, 'application/octet-stream');
                        alert(`Note encrypted and saved as '${filename}'!`);
                    }

                } catch (e) {
                    alert("Encryption failed. Check the console for details.");
                    console.error("Encryption error:", e);
                }
            } else {
                alert("Save cancelled. Encryption requires a password.");
            }
        });

        // 3. Load File Handler
        loadFileBtn.addEventListener('click', () => {
            fileDropdown.classList.add('hidden'); // Close menu
            fileInput.click(); // Open the system file dialog
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();

            reader.onload = (e) => {
                const fileContent = e.target.result;
                const filename = file.name;
                
                if (filename.endsWith('.4spnote')) {
                    // Handle Decryption
                    const password = prompt(`Enter the password to decrypt '${filename}':`);
                    if (password) {
                        try {
                            const decryptedBytes = CryptoJS.AES.decrypt(fileContent, password);
                            const decryptedText = decryptedBytes.toString(CryptoJS.enc.Utf8);
                            
                            if (decryptedText) {
                                textarea.value = decryptedText;
                                alert(`'${filename}' loaded and decrypted successfully!`);
                            } else {
                                alert("Decryption failed. Incorrect password or corrupted file.");
                                textarea.value = fileContent; // Show raw encrypted content if decryption fails
                            }
                        } catch (err) {
                            alert("Decryption error: File content could be corrupted or an incorrect password was used.");
                            console.error("Decryption error:", err);
                        }
                    } else {
                        alert("File loading cancelled. Password required for decryption.");
                    }
                } else {
                    // Handle Standard Text Load
                    textarea.value = fileContent;
                    alert(`'${filename}' loaded successfully!`);
                }
                updateCounts();
            };

            reader.onerror = () => {
                alert('Error reading file.');
            };

            reader.readAsText(file);
            event.target.value = null; // Reset file input
        });


        // Listen for input changes to update the counter
        textarea.addEventListener('input', updateCounts);

        // Call once on load to initialize counts
        window.addEventListener('load', () => {
            updateCounts();
            renderLocalSavesDropdown(); // Initial rendering of local saves
        });

        
        // --- AUTHENTICATION/TEMPLATE LOGIC (Modified) ---

        // Mocking auth for a simple page based on the previous context
        // NOTE: The user requested to be kicked to ../index.html if logged out.
        // We simulate a check here, where 'false' means logged out.
        const auth = { onAuthStateChanged: (cb) => cb(true) }; // Changed to simulate success for the page to load by default.
        const initialAuthToken = null; 
        
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        
        // --- Core Authentication and Redirection Logic ---
        async function initializeAuth() {
            // Simulate an authentication check
            auth.onAuthStateChanged((user) => {
                if (!user) {
                    // KICK TO INDEX.HTML if not logged in
                    window.location.href = '../index.html'; 
                } else {
                    // Hide loading screen and show content upon successful auth
                    loadingScreen.style.display = 'none';
                    pageContent.classList.remove('hidden');
                }
            });
        }

        // Wait a small moment before running the auth check to allow the page to start rendering
        setTimeout(() => {
            initializeAuth();
        }, 100); 
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - BETA SETTINGS</title>
    <meta name="description" content="Admin page for managing beta tester access list.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="../navigation.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind CSS configuration for a consistent dark theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#070707', // Body background
                        'custom-dark-gray': '#111111',    // Main panel background
                        'custom-medium-gray': '#252525', // Borders, inputs, buttons
                        'custom-light-gray': '#505050',  // Labels and secondary text
                        'custom-lighter-gray': '#808080', // Text
                        'custom-white-gray': '#c0c0c0',  // Main text and headings
                    }
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Geist', sans-serif;
            background-color: #070707;
            color: #c0c0c0;
            transition: all 0.3s ease;
            min-height: 100vh;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem 1rem;
            max-width: 900px;
            margin: 0 auto;
        }
        .input-style {
            padding: 0.75rem;
            border: 1px solid #252525;
            background-color: #111111;
            border-radius: 8px;
            color: #c0c0c0;
            transition: border-color 0.3s;
        }
        .input-style:focus {
            outline: none;
            border-color: #505050;
        }
        .btn-primary {
            background-color: #505050;
            color: #c0c0c0;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #808080;
        }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            background-color: #111111;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #252525;
        }
    </style>
</head>
<body>
    <div id="navbar-container"></div>
    <div id="loading-screen" class="fixed inset-0 bg-custom-darkest-gray z-50 flex items-center justify-center">
        <div class="text-xl flex items-center">
            <i class="fa-solid fa-spinner fa-spin mr-3"></i> Authenticating and loading settings...
        </div>
    </div>
    
    <div id="page-content" class="main-content hidden">
        <h1 class="text-4xl font-extrabold tracking-tighter text-custom-white-gray mb-2">Beta Access Management</h1>
        <p class="text-custom-lighter-gray mb-8">
            Manage the list of user emails authorized to access the 4SP application. This page is restricted to the admin account.
        </p>

        <div class="bg-custom-dark-gray p-6 rounded-xl shadow-lg border border-custom-medium-gray mb-8">
            <h2 class="text-2xl font-bold mb-4">Current Beta Testers (<span id="testerCount">0</span>)</h2>
            <div id="betaTesterList" class="space-y-2 max-h-96 overflow-y-auto pr-2">
                <p id="listPlaceholder" class="text-custom-light-gray text-center p-4">Loading list...</p>
            </div>
            <div id="listMessage" class="mt-4 text-sm font-medium"></div>
        </div>

        <div class="bg-custom-dark-gray p-6 rounded-xl shadow-lg border border-custom-medium-gray">
            <h2 class="text-2xl font-bold mb-4">Add Beta Tester</h2>
            <form id="addTesterForm" class="flex flex-col md:flex-row gap-4">
                <input type="email" id="newTesterEmail" placeholder="Enter email address" required class="flex-grow input-style" pattern="[a-z0-9._%+\-]+@[a-z0-9.\-]+\.[a-z]{2,}$" title="Must be a valid email address">
                <button type="submit" class="btn-primary flex-shrink-0">
                    <i class="fa-solid fa-plus mr-2"></i> Add Email
                </button>
            </form>
            <div id="addMessage" class="mt-4 text-sm font-medium"></div>
        </div>
    </div>

    <script type="module">
        // --- Firebase Imports (Modular SDK) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot,
            arrayUnion,
            arrayRemove
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config ---
        // This is where we correctly load the 'export' from firebase-config.js
        import { firebaseConfig } from "../firebase-config.js"; 

        // --- Canvas Global Variables (MANDATORY USE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Constants (MODIFIED ADMIN EMAIL LIST) ---
        const ADMIN_EMAILS = [
            '4simpleproblems@gmail.com',
            'belkwy30@minerva.sparcc.org'
        ];
        const CONFIG_DOC_PATH = ['artifacts', appId, 'public', 'data', 'app_config', 'beta_testers'];

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const betaTesterList = document.getElementById('betaTesterList');
        const newTesterEmailInput = document.getElementById('newTesterEmail');
        const addMessageDiv = document.getElementById('addMessage');
        const listMessageDiv = document.getElementById('listMessage');
        const testerCountSpan = document.getElementById('testerCount');

        // --- Firebase Initialization ---
        let db = null;
        let auth = null;
        
        try {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            // setLogLevel('debug'); // Uncomment for debugging
        } catch (e) {
            console.error("Firebase Initialization Failed:", e);
            listMessageDiv.className = 'mt-4 text-sm font-medium text-red-400';
            listMessageDiv.textContent = 'ERROR: Firebase configuration is invalid or missing.';
        }


        // --- Helper Functions (MODIFIED checkAdminAuthorization) ---
        const checkAdminAuthorization = (user) => {
            const adminEmailListString = ADMIN_EMAILS.join(', ');
            if (!user || !ADMIN_EMAILS.includes(user.email.toLowerCase())) {
                console.error("Access Denied: Not an authorized Admin Email.");
                loadingScreen.innerHTML = `
                    <div class="text-center p-8 bg-custom-dark-gray rounded-xl shadow-2xl">
                        <i class="fa-solid fa-hand-holding-hand text-red-500 text-4xl mb-4"></i>
                        <h2 class="text-xl font-bold text-red-400 mb-2">ACCESS DENIED</h2>
                        <p class="text-custom-lighter-gray">This page is restricted to the administrators (${adminEmailListString}).</p>
                        <a href="./dashboard.html" class="mt-4 inline-block text-custom-white-gray hover:text-custom-lighter-gray underline">Go to Dashboard</a>
                    </div>
                `;
                // If user is logged in, sign them out if they aren't an admin, just to be safe.
                if (user) {
                    // Note: We don't sign out here because navigation.js handles the primary redirect.
                }
                return false;
            }
            return true;
        };

        const renderTesterList = (emails) => {
            betaTesterList.innerHTML = '';
            testerCountSpan.textContent = emails.length;

            if (emails.length === 0) {
                betaTesterList.innerHTML = '<p class="text-custom-light-gray text-center p-4">No beta testers currently registered.</p>';
                return;
            }

            emails.forEach(email => {
                const item = document.createElement('div');
                item.className = 'list-item';
                item.innerHTML = `
                    <span class="text-custom-white-gray break-all">${email}</span>
                    <button data-email="${email}" class="remove-btn text-red-400 hover:text-red-300 transition ml-4">
                        <i class="fa-solid fa-xmark"></i> Remove
                    </button>
                `;
                betaTesterList.appendChild(item);
            });

            // Attach removal listeners
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (e) => removeTester(e.currentTarget.getAttribute('data-email')));
            });
        };

        // --- Firestore Operations ---

        // Real-time listener for the beta tester list
        const setupRealtimeListener = () => {
            const docRef = doc(db, ...CONFIG_DOC_PATH);

            onSnapshot(docRef, (docSnap) => {
                const emails = docSnap.data()?.emails || [];
                // Sort for cleaner display
                emails.sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()));
                renderTesterList(emails);
            }, (error) => {
                console.error("Firestore realtime listener failed:", error);
                showMessage(listMessageDiv, 'Failed to load beta tester list in real-time.', 'error');
            });
        };

        const addTester = async (email) => {
            if (!email) return;
            showMessage(addMessageDiv, 'Adding email...', 'warning');

            const docRef = doc(db, ...CONFIG_DOC_PATH);
            const normalizedEmail = email.toLowerCase().trim();

            try {
                // Check if document exists, if not, create it
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) {
                     await setDoc(docRef, { emails: [] }, { merge: true });
                }

                // Add the email using arrayUnion for atomicity and to prevent duplicates
                await setDoc(docRef, {
                    emails: arrayUnion(normalizedEmail)
                }, { merge: true });

                showMessage(addMessageDiv, `Successfully added ${email} to the beta list.`, 'success');
                newTesterEmailInput.value = ''; // Clear input
            } catch (error) {
                console.error("Error adding beta tester:", error);
                showMessage(addMessageDiv, `Failed to add email: ${error.message}`, 'error');
            }
        };

        const removeTester = async (email) => {
            if (!email) return;
            
            // Note: We use the list message area for removal status
            showMessage(listMessageDiv, `Removing ${email}...`, 'warning');
            
            const docRef = doc(db, ...CONFIG_DOC_PATH);
            const normalizedEmail = email.toLowerCase().trim();

            try {
                // Remove the email using arrayRemove
                await setDoc(docRef, {
                    emails: arrayRemove(normalizedEmail)
                }, { merge: true });

                showMessage(listMessageDiv, `Successfully removed ${email}.`, 'success');
            } catch (error) {
                console.error("Error removing beta tester:", error);
                showMessage(listMessageDiv, `Failed to remove email: ${error.message}`, 'error');
            }
        };


        // --- Event Listeners ---
        document.getElementById('addTesterForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = newTesterEmailInput.value;
            if (email) {
                addTester(email);
            }
        });

        // --- Main Initialization ---
        
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is logged in. Check for admin authorization.
                if (checkAdminAuthorization(user)) {
                    // Admin is authorized. Start the data listener and show content.
                    console.log("Admin authorized. Starting beta list listener.");
                    setupRealtimeListener();
                    loadingScreen.classList.add('hidden');
                    pageContent.classList.remove('hidden');
                }
            } else {
                // User is not logged in. Redirect logic is handled by navigation.js
                console.log("User not authenticated. Navigation script handles redirection.");
            }
        });

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="page-title">4SP - Settings</title>
    <meta name="description" content="User settings and application configuration for 4SP.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="../navigation.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        :root {
            /* The color variable has been removed as navigation.js manages it via --navbar-background */
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
        }
        
        /* The body padding-top is now handled by the CSS injected in test-navigation.js to account for the fixed navbar height */
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* Full-screen content wrapper */
        .settings-wrapper {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            padding: 0 1rem; 
        }

        /* Header Styling */
        .page-header {
            padding: 2rem 1rem 1rem 1rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Settings Grid Layout */
        .settings-layout {
            display: flex;
            gap: 2rem;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            padding-bottom: 2rem;
            flex-grow: 1;
        }

        /* --- UPDATED: Sidebar Styling --- */
        .settings-sidebar {
            width: 100%;
            min-width: 200px;
            max-width: 280px;
            flex-shrink: 0;
            
            /* NEW: Sticky Sidebar Implementation */
            position: sticky;
            /* 4rem for main navbar + 1rem desired gap */
            top: 5rem; 
            /* Aligns item to the start of the flex container, crucial for sticky */
            align-self: flex-start;
            /* Set a MAX-height based on viewport, minus the sticky offset */
            max-height: calc(100vh - 5rem);
            /* Allow sidebar to scroll internally if its content is too tall */
            overflow-y: auto;
        }

        /* Sidebar Item Styling */
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            color: #c0c0c0;
        }
        
        /* FIX: Ensure icon is centered in its box */
        .sidebar-item i {
            text-align: center;
            line-height: 1.5rem; /* Matches h-6 (1.5rem) */
        }

        .sidebar-item:hover {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .sidebar-item.active {
            background-color: #3b82f6; /* Blue-500 */
            color: #ffffff;
            font-weight: 500;
        }

        /* Main Content Panel */
        .settings-panel {
            flex-grow: 1;
            background-color: #111111;
            border: 1px solid #252525;
            border-radius: 0.75rem;
            padding: 2rem;
            min-height: 70vh;
        }
        
        /* --- General Settings UI --- */
        .settings-section {
            border-bottom: 1px solid #252525;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        .settings-label {
            display: block;
            font-medium text-white mb-2;
        }
        .settings-input {
            width: 100%;
            max-width: 400px;
            background-color: #1f2937; /* gray-800 */
            border: 1px solid #374151; /* gray-700 */
            color: #f3f4f6; /* gray-100 */
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .settings-input:focus {
            outline: none;
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 2px #3b82f640;
        }
        .settings-input:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .settings-button {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.6rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .settings-button:hover {
            background-color: #2563eb; /* blue-600 */
        }
        .settings-button:disabled {
            background-color: #374151; /* gray-700 */
            cursor: not-allowed;
            opacity: 0.7;
        }
        .settings-button-danger {
            background-color: #dc2626; /* red-600 */
        }
        .settings-button-danger:hover {
            background-color: #b91c1c; /* red-700 */
        }
        .settings-button-secondary {
            background-color: #374151; /* gray-700 */
        }
        .settings-button-secondary:hover {
            background-color: #4b5563; /* gray-600 */
        }
        .settings-description {
            font-size: 0.875rem;
            color: #9ca3af; /* gray-400 */
            margin-top: 0.5rem;
            max-width: 600px;
        }
        .message-area {
            font-size: 0.875rem;
            margin-top: 0.75rem;
            font-weight: 500;
        }
        .message-error { color: #f87171; /* red-400 */ }
        .message-success { color: #4ade80; /* green-400 */ }
        .message-warning { color: #facc15; /* yellow-400 */ }

        /* Standard loading screen style */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #070707;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        /* Mobile adjustments: Hide sidebar and adjust layout */
        @media (max-width: 768px) {
            .settings-layout {
                flex-direction: column;
                gap: 1rem;
            }
            .settings-sidebar {
                max-width: 100%;
                margin-bottom: 0;
                /* On mobile, un-stick the sidebar */
                position: static;
                height: auto;
                max-height: none; /* Reset max-height for mobile */
                overflow-y: visible;
            }
        }

        /* --- UPDATED CSS for .color-option (Text Centered) --- */

.color-option {
    /* 1. Wide but not tall / Spacious */
    width: 100%;
    padding: 0.75rem 1.25rem; 
    height: auto; 
    
    /* 2. Slightly more rounded (12px) */
    border-radius: 12px;
    
    /* 3. Less spacing between them */
    margin-bottom: 4px; 
    
    /* Standard button styling */
    cursor: pointer;
    border: 3px solid #374151; /* gray-700 */
    transition: background-color 0.2s, border-color 0.2s; 
    display: flex;
    align-items: center;
    /* CHANGE: Sets the horizontal alignment of the flex items to the center */
    justify-content: center; 
    
    font-size: 0.9rem; 
    color: white;
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    font-weight: 500;
}

.color-option:hover {
    border-color: #6b7280; /* gray-500 */
    background-color: #1f1f1f; 
}

.color-option.selected {
    border-color: #3b82f6; /* Blue-500 */
    box-shadow: 0 0 0 3px #3b82f680;
    background-color: #18202d;
}

/* NEW: Avatar and Personalization Styles */
.avatar-preview {
    display: flex;
    align-items: center;
    justify-content: center;
}

.avatar-options {
    flex: 1;
}

.form-select, .form-input {
    background-color: #374151;
    border: 1px solid #4b5563;
    border-radius: 6px;
    color: white;
    padding: 8px 12px;
    font-size: 14px;
}

.form-select:focus, .form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
}

.emoji-btn {
    background: none;
    border: none;
    font-size: 18px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.emoji-btn:hover {
    background-color: #374151;
}

.btn-primary {
    background-color: #3b82f6;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.btn-primary:hover {
    background-color: #2563eb;
}

.btn-secondary {
    background-color: #6b7280;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.btn-secondary:hover {
    background-color: #4b5563;
}

.btn-danger {
    background-color: #dc2626;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: background-color 0.2s;
}

.btn-danger:hover {
    background-color: #b91c1c;
}

.setting-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px;
    background-color: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.setting-header {
    flex: 1;
}

.setting-control {
    display: flex;
    align-items: center;
    gap: 8px;
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 48px;
    height: 24px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #374151;
    transition: 0.3s;
    border-radius: 24px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.3s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #3b82f6;
}

input:checked + .toggle-slider:before {
    transform: translateX(24px);
}

/* Compact mode styles */
body.compact-mode {
    --spacing-scale: 0.8;
}

body.compact-mode .setting-item {
    padding: 12px;
}

body.compact-mode .settings-section {
    margin-bottom: 20px;
}

/* Crop canvas styles */
#crop-canvas {
    max-width: 200px;
    max-height: 200px;
}

.hidden {
    display: none !important;
}
    </style>
</head>
<body>

    <div id="loading-screen">
        <p class="text-xl text-gray-400">Verifying authentication and loading settings...</p>
    </div>

    <main id="page-content" class="settings-wrapper hidden">
        
        <header class="page-header">
            <h1 id="main-title" class="text-3xl text-white font-bold mb-3 tracking-wide">Settings</h1>
            <div class="h-px bg-white/20 w-full"></div>
        </header>

        <div class="settings-layout">
            
            <nav id="settings-sidebar" class="settings-sidebar"></nav>

            <section class="settings-panel">
                <h2 id="panel-title" class="text-2xl font-semibold text-indigo-400 mb-6">General</h2>
                <div id="panel-content" class="text-gray-400">
                    <p>Loading account details...</p>
                </div>
            </section>
        </div>
    </main>

    <script type="module">
        // --- NEW: Firebase v10 (Modular) Imports ---
        import { firebaseConfig } from '../firebase-config.js';
        // --- Removed JSON import ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            onAuthStateChanged,
            reauthenticateWithCredential,
            reauthenticateWithPopup,
            EmailAuthProvider,
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            updatePassword,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            updateDoc,
            onSnapshot,
            serverTimestamp,
            collection,
            query,
            where,
            getDocs
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- NEW: Firebase v10 Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- NEW: Global State Variables ---
        let currentUser = null;         // Firebase Auth User object
        let currentUserData = null;     // Firestore 'users' document data
        let unsubscribeUserDoc = null;  // Function to stop the onSnapshot listener
        let activeSection = 'general';  // Track the currently loaded section
        
        // --- MODIFICATION: themePalettes and a promise to track its loading ---
        let themePalettes = null;       // Will be populated by fetch()
        let themesPromise = null;       // Will hold the fetch promise

        // --- CONSTANTS AND DOM ELEMENTS ---
        const BASE_TITLE = "Settings";
        // Key for Local Storage - MUST MATCH THEME_STORAGE_KEY in navigation.js
        const NAVBAR_SETTINGS_KEY = 'user-navbar-theme'; 
        const GAME_SAVE_FILENAME = 'strongdog_saves.json'; // New constant for the save file name
        
        // --- FULL THEME PALETTES array removed. ---
        
        const settingsSections = [
            { id: 'general', title: 'General', icon: 'fa-cog', content: 'Manage your core account settings, username, and password.', color: 'text-yellow-400' },
            { id: 'privacy', title: 'Privacy & Security', icon: 'fa-shield-alt', content: 'Manage your data permissions, account security, and two-factor authentication. Strong security is a priority!', color: 'text-red-400' },
            { id: 'personalization', title: 'Personalization', icon: 'fa-palette', content: 'Customize the look and feel of the application, including colors and layout. Make it truly yours!', color: 'text-pink-400' },
            { id: 'notifications', title: 'Notifications', icon: 'fa-bell', content: 'Set your preferences for alerts and communication methods. Never miss an important update.', color: 'text-green-400' },
            // ADDED: Updated content for Data Management
            { id: 'data', title: 'Data Management', icon: 'fa-database', content: 'View, export, or request deletion of your stored data.', color: 'text-blue-400' },
            { id: 'about', title: 'About 4SP', icon: 'fa-info-circle', content: 'Application version, legal notices, and credits.', color: 'text-gray-400' }
        ];
        
        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const mainTitle = document.getElementById('main-title');
        const sidebarNav = document.getElementById('settings-sidebar');
        const panelTitle = document.getElementById('panel-title');
        const panelContent = document.getElementById('panel-content');
        const pageHtmlTitle = document.getElementById('page-title');

        // --- REMOVED old color functions ---
        // ...

        // --- NEW: AUTHENTICATION & DATA FLOW ---

        function startAuthFlow() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is signed in.
                    currentUser = user;
                    
                    // Stop any previous listener
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }
                    
                    // Get the user's document reference
                    const userDocRef = doc(db, 'users', user.uid);
                    
                    // Set up a real-time listener for the user's data
                    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            currentUserData = docSnap.data();
                        } else {
                            // This case should ideally not happen for a logged-in user
                            // But if it does, we have their basic auth data
                            currentUserData = {
                                email: user.email,
                                username: user.displayName || 'User',
                                authMethod: user.providerData[0]?.providerId || 'unknown'
                            };
                            console.warn("Firestore document not found for user:", user.uid);
                        }
                        
                        // Initial page setup
                        if (loadingScreen.style.display !== 'none') {
                            initializePage();
                        } else {
                            // If page is already loaded, just refresh the active panel
                            // This is for real-time updates (e.g., username cooldown)
                            loadSection(activeSection);
                        }
                    }, (error) => {
                        console.error("Error listening to user document:", error);
                        // Show page even if Firestore listener fails
                        currentUserData = { email: user.email, username: user.displayName || 'User' };
                        initializePage();
                    });

                } else {
                    // User is signed out.
                    currentUser = null;
                    currentUserData = null;
                    if (unsubscribeUserDoc) {
                        unsubscribeUserDoc();
                    }
                    // Redirect to login page
                    console.log("User is not authenticated. Redirecting to login.");
                    window.location.href = '../authentication.html';
                }
            });
        }
        
        /**
         * Runs once after the first successful auth check and data load.
         */
        function initializePage() {
            renderSidebar();
            loadSection('general'); // Load 'general' by default
            
            // Hide loading screen and show content
            loadingScreen.style.display = 'none';
            pageContent.classList.remove('hidden');

            // --- MODIFICATION: Start loading themes AFTER auth is complete ---
            // Start loading theme data in the background
            themesPromise = fetch('../themes.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to fetch themes: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(data => {
                    themePalettes = data;
                    // If user somehow got to personalization tab before this finished, re-render it.
                    if (activeSection === 'personalization') {
                        renderPersonalizationSettings();
                    }
                    return data;
                })
                .catch(error => {
                    console.error("Error loading theme data:", error);
                    // If on personalization tab, show an error
                    if (activeSection === 'personalization') {
                        panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                    }
                });
        }
        
        // --- SETTINGS UI LOGIC ---

        function renderSidebar() {
            sidebarNav.innerHTML = ''; // Clear existing content
            settingsSections.forEach(section => {
                const item = document.createElement('div');
                item.className = 'sidebar-item group';
                item.id = `sidebar-${section.id}`;
                item.setAttribute('data-section', section.id);
                item.innerHTML = `
                    <i class="fas ${section.icon} w-6 h-6 mr-3 ${section.color} transition-transform group-hover:scale-110"></i>
                    <span class="text-sm font-medium">${section.title}</span>
                `;
                // --- MODIFICATION: Make click listener async ---
                item.addEventListener('click', async () => await loadSection(section.id));
                sidebarNav.appendChild(item);
            });
        }

        // --- MODIFICATION: Make loadSection async to await theme loading ---
        async function loadSection(sectionId) {
            activeSection = sectionId; // Update global state
            const section = settingsSections.find(s => s.id === sectionId);
            if (!section) return;

            // 1. Update main title and HTML title
            mainTitle.textContent = `${BASE_TITLE} - ${section.title}`;
            pageHtmlTitle.textContent = `4SP - ${BASE_TITLE} - ${section.title}`;

            // 2. Update content panel header
            panelTitle.innerHTML = `<i class="fas ${section.icon} mr-2 ${section.color}"></i> ${section.title}`;
            
            // 3. Render content based on section ID
            if (sectionId === 'general') {
                renderGeneralSettings();
            } 
            else if (sectionId === 'personalization') { 
                // Show loading message while themes are fetched
                panelContent.innerHTML = '<p>Loading themes...</p>';
                
                try {
                    // Wait for the theme data to be loaded (it might already be loaded)
                    if (!themesPromise) {
                        // This should not happen if initializePage ran, but it's a safe fallback.
                        console.warn("Themes promise not initialized, cannot load section.");
                        throw new Error("Theme loading was not initiated.");
                    }
                    
                    await themesPromise; // Wait for the fetch to complete
                    
                    // Now that themePalettes is populated, render the section
                    renderPersonalizationSettings();
                    
                } catch (error) {
                    console.error("Failed to render personalization settings:", error);
                    panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                }
            }
            // NEW: Privacy & Security section rendering
            else if (sectionId === 'privacy') {
                renderPrivacySettings();
            }
            // ADDED: Data Management section rendering
            else if (sectionId === 'data') {
                renderDataManagement();
            }
            // --- END MODIFICATION ---
            else {
                // Render placeholder for all other sections
                panelContent.innerHTML = `
                    <div class="flex flex-col space-y-4">
                        <p class="text-lg">${section.content}</p>
                        <div id="section-details" class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <h3 class="text-xl font-semibold mb-2 text-white">Section Details</h3>
                            <p class="text-sm text-gray-500">
                                This is where the detailed controls, forms, and toggles for the 
                                ${section.title} section would be implemented. 
                                <i class="fas fa-magic text-purple-400 ml-1"></i>
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // 4. Update sidebar active state
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`sidebar-${sectionId}`).classList.add('active');
        }
        
        // --- NEW: General Settings Implementation (omitted for brevity, remains unchanged) ---
        // ... (General Settings functions are here) ...
        
        /**
         * Renders the content for the "General" tab
         */
        function renderGeneralSettings() {
            if (!currentUser || !currentUserData) {
                panelContent.innerHTML = '<p>Loading account data...</p>';
                return;
            }

            const primaryAuthMethod = currentUserData.authMethod || 'unknown';
            const isEmailUser = primaryAuthMethod === 'email';
            
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Username</h3>
                    <label for="username-input" class="settings-label">Change Username</label>
                    <div class="flex flex-col sm:flex-row sm:items-start sm:gap-4">
                        <input type="text" id="username-input" class="settings-input" value="${currentUserData.username || ''}" placeholder="Enter new username">
                        <button id="username-save-btn" class="settings-button mt-3 sm:mt-0 sm:flex-shrink-0">
                            <i class="fas fa-save mr-2"></i> Save
                        </button>
                    </div>
                    <div id="username-message" class="message-area"></div>
                    <p class="settings-description">
                        You can change your username once every 7 days. 
                        Your username must be 4-24 characters and can include: .,-+\\_!?$
                    </p>
                </div>

                ${isEmailUser ? `
                <div class="settings-section" id="password-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Change Password</h3>
                    <form id="password-change-form">
                        <div class="mb-4">
                            <label for="current-password" class="settings-label">Current Password</label>
                            <input type="password" id="current-password" class="settings-input" required autocomplete="current-password">
                            <p class="settings-description">Required to confirm your identity.</p>
                        </div>
                        <div class="mb-4">
                            <label for="new-password" class="settings-label">New Password</label>
                            <input type="password" id="new-password" class="settings-input" required autocomplete="new-password">
                        </div>
                        <div class="mb-4">
                            <label for="confirm-password" class="settings-label">Confirm New Password</label>
                            <input type="password" id="confirm-password" class="settings-input" required autocomplete="new-password">
                        </div>
                        <button type="submit" id="password-save-btn" class="settings-button">
                            <i class="fas fa-key mr-2"></i> Change Password
                        </button>
                    </form>
                    <div id="password-message" class="message-area"></div>
                </div>
                ` : ''}

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Link Providers</h3>
                    <p class="settings-description mb-4">
                        Link multiple social accounts to sign in.
                    </p>
                    <div id="linking-container" class="space-y-3">
                        </div>
                    <div id="linking-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-red-400 mb-4">Danger Zone</h3>
                    <p class="settings-description mb-4">
                        Deleting your account is permanent and cannot be undone. All your data will be removed.
                    </p>
                    <button id="delete-account-btn" class="settings-button settings-button-danger">
                        <i class="fas fa-trash-alt mr-2"></i> Delete My Account
                    </button>
                    <div id="delete-message" class="message-area"></div>
                </div>
            `;
            
            // Now that HTML is in the DOM, attach listeners and update UI states
            attachGeneralSettingsListeners(isEmailUser);
            updateUsernameUI();
            updateAccountLinkingUI(); // Update linking UI unconditionally
        }

        // --- Helper functions for General (attachGeneralSettingsListeners, updateUsernameUI, updateAccountLinkingUI, handleAccountLink, handleAccountUnlink, checkProfanity, isUsernameTaken, handleUsernameChange, handlePasswordChange, handleAccountDelete) are omitted for brevity, they remain unchanged from the previous version. ---

        /**
         * Attaches all event listeners for the General Settings panel
         */
        function attachGeneralSettingsListeners(isEmailUser) {
            // Username
            const usernameSaveBtn = document.getElementById('username-save-btn');
            if (usernameSaveBtn) {
                usernameSaveBtn.addEventListener('click', handleUsernameChange);
            }

            // Password (only attach if it exists)
            if (isEmailUser) {
                const passwordForm = document.getElementById('password-change-form');
                if (passwordForm) {
                    passwordForm.addEventListener('submit', handlePasswordChange);
                }
            }

            // Account Deletion
            const deleteBtn = document.getElementById('delete-account-btn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', handleAccountDelete);
            }
        }
        
        /**
         * Updates the username input and button based on the cooldown
         */
        function updateUsernameUI() {
            const input = document.getElementById('username-input');
            const button = document.getElementById('username-save-btn');
            const message = document.getElementById('username-message');
            if (!input || !button || !message) return;
            
            const lastChanged = currentUserData?.usernameLastChanged?.toDate();
            if (lastChanged) {
                const now = new Date();
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                const timeSinceChange = now.getTime() - lastChanged.getTime();
                
                if (timeSinceChange < sevenDays) {
                    const remainingTime = sevenDays - timeSinceChange;
                    const days = Math.ceil(remainingTime / (1000 * 60 * 60 * 24));
                    input.disabled = true;
                    button.disabled = true;
                    message.textContent = `You can change your username again in ${days} day(s).`;
                    message.className = 'message-area message-warning';
                } else {
                    input.disabled = false;
                    button.disabled = false;
                    message.textContent = '';
                    message.className = 'message-area';
                }
            } else {
                // No timestamp, user can change it
                input.disabled = false;
                button.disabled = false;
                message.textContent = '';
                message.className = 'message-area';
            }
        }
        
        /**
         * Renders the list of linked accounts and link/unlink buttons
         */
        function updateAccountLinkingUI() {
            const container = document.getElementById('linking-container');
            if (!container) return; // Exit if the container doesn't exist
            
            const providerData = currentUser.providerData;
            const linkedProviders = providerData.map(p => p.providerId);
            
            const allProviders = [
                { id: 'google.com', name: 'Google', icon: 'fa-brands fa-google', btnClass: 'bg-[#4285F4] hover:bg-[#357afe]' },
                { id: 'github.com', name: 'GitHub', icon: 'fa-brands fa-github', btnClass: 'bg-[#333] hover:bg-[#444]' },
                { id: 'microsoft.com', name: 'Microsoft', icon: 'fa-brands fa-microsoft', btnClass: 'bg-[#00A4EF] hover:bg-[#0093d8]' }
            ];

            let html = '';
            allProviders.forEach(p => {
                const isLinked = linkedProviders.includes(p.id);
                html += `
                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                        <div class="flex items-center gap-3">
                            <i class="${p.icon} text-xl w-6 text-center"></i>
                            <span class="font-medium text-white">${p.name}</span>
                        </div>
                        ${isLinked ? `
                            <button class="settings-button settings-button-secondary text-xs" 
                                    data-provider-id="${p.id}" 
                                    onclick="window.handleAccountUnlink('${p.id}')"
                                    ${linkedProviders.length <= 1 ? 'disabled title="Cannot unlink the only sign-in method"' : ''}>
                                <i class="fas fa-times mr-2"></i> Unlink
                            </button>
                        ` : `
                            <button class="settings-button text-xs ${p.btnClass}" 
                                    data-provider-id="${p.id}"
                                    onclick="window.handleAccountLink('${p.id}')">
                                <i class="fas fa-link mr-2"></i> Link
                            </button>
                        `}
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        // Make link/unlink functions globally accessible to inline 'onclick'
        window.handleAccountLink = async (providerId) => {
            const message = document.getElementById('linking-message');
            message.textContent = 'Opening provider popup...';
            message.className = 'message-area message-warning';
            
            let provider;
            if (providerId === 'google.com') provider = new GoogleAuthProvider();
            else if (providerId === 'github.com') provider = new GithubAuthProvider();
            else if (providerId === 'microsoft.com') provider = new OAuthProvider('microsoft.com');
            else return;
            
            try {
                await linkWithPopup(currentUser, provider);
                message.textContent = 'Successfully linked account!';
                message.className = 'message-area message-success';
                // The onAuthStateChanged listener *should* pick up the new
                // providerData, but we can force a UI refresh.
                updateAccountLinkingUI(); 
            } catch (error) {
                console.error("Link error:", error);
                message.textContent = `Error: ${error.message}`;
                message.className = 'message-area message-error';
            }
        };

        window.handleAccountUnlink = async (providerId) => {
            if (currentUser.providerData.length <= 1) {
                alert("You cannot unlink your only sign-in method.");
                return;
            }
            
            if (!confirm(`Are you sure you want to unlink your ${providerId} account?`)) {
                return;
            }

            const message = document.getElementById('linking-message');
            message.textContent = 'Unlinking account...';
            message.className = 'message-area message-warning';

            try {
                await unlink(currentUser, providerId);
                message.textContent = 'Successfully unlinked account!';
                message.className = 'message-area message-success';
                updateAccountLinkingUI(); // Force refresh
            } catch (error) {
                console.error("Unlink error:", error);
                message.textContent = `Error: ${error.message}`;
                message.className = 'message-area message-error';
            }
        };

        // Re-usable helper for profanity/uniqueness (copied from authentication.html)
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };
        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            // Check if any document exists that IS NOT the current user's document
            let isTaken = false;
            querySnapshot.forEach(doc => {
                if (doc.id !== currentUser.uid) {
                    isTaken = true;
                }
            });
            return isTaken;
        };

        async function handleUsernameChange() {
            const input = document.getElementById('username-input');
            const button = document.getElementById('username-save-btn');
            const message = document.getElementById('username-message');
            const newUsername = input.value.trim();
            
            button.disabled = true;
            message.textContent = 'Checking...';
            message.className = 'message-area message-warning';

            // 1. Check cooldown (client-side check, server-side rules should enforce)
            const lastChanged = currentUserData?.usernameLastChanged?.toDate();
            if (lastChanged) {
                const sevenDays = 7 * 24 * 60 * 60 * 1000;
                if (new Date().getTime() - lastChanged.getTime() < sevenDays) {
                    message.textContent = 'You cannot change your username yet.';
                    message.className = 'message-area message-error';
                    button.disabled = false;
                    return;
                }
            }
            
            // 2. Check if username is the same
            if (newUsername.toLowerCase() === (currentUserData.username || '').toLowerCase()) {
                message.textContent = 'This is already your username.';
                message.className = 'message-area message-warning';
                button.disabled = false;
                return;
            }

            // 3. Validate new username
            if (newUsername.length < 4 || newUsername.length > 24) {
                message.textContent = 'Username must be 4-24 characters.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }
            if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) {
                message.textContent = 'Username contains invalid characters.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }
            if (await checkProfanity(newUsername)) {
                message.textContent = 'This username is not allowed.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }
            if (await isUsernameTaken(newUsername)) {
                message.textContent = 'This username is already taken.';
                message.className = 'message-area message-error';
                button.disabled = false;
                return;
            }

            // 4. All checks passed, update Firestore
            try {
                message.textContent = 'Updating username...';
                message.className = 'message-area message-warning';
                
                const userDocRef = doc(db, 'users', currentUser.uid);
                await updateDoc(userDocRef, {
                    username: newUsername,
                    usernameLastChanged: serverTimestamp(),
                    // Store timezone and timestamp for user reference
                    usernameChangeDetails: {
                        timestamp: new Date().toISOString(),
                        timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
                    }
                });

                message.textContent = 'Username successfully updated!';
                message.className = 'message-area message-success';
                // The onSnapshot listener will automatically update the UI state
                
            } catch (error) {
                console.error("Username update error:", error);
                message.textContent = 'An error occurred. Please try again.';
                message.className = 'message-area message-error';
                button.disabled = false;
            }
        }
        
        async function handlePasswordChange(e) {
            e.preventDefault();
            const currentPass = document.getElementById('current-password').value;
            const newPass = document.getElementById('new-password').value;
            const confirmPass = document.getElementById('confirm-password').value;
            const button = document.getElementById('password-save-btn');
            const message = document.getElementById('password-message');
            
            message.textContent = '';
            
            if (newPass !== confirmPass) {
                message.textContent = 'New passwords do not match.';
                message.className = 'message-area message-error';
                return;
            }
            
            // Basic password validation (from authentication.html)
            if (newPass.length < 8 || newPass.length > 48) {
                message.textContent = 'Password must be 8-48 characters.';
                message.className = 'message-area message-error';
                return;
            }
            if (!/[A-Z]/.test(newPass)) {
                message.textContent = 'Password must contain an uppercase letter.';
                message.className = 'message-area message-error';
                return;
            }
            // ... (add other password rules if needed) ...

            button.disabled = true;
            message.textContent = 'Verifying identity...';
            message.className = 'message-area message-warning';
            
            try {
                // 1. Re-authenticate
                const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
                await reauthenticateWithCredential(currentUser, credential);
                
                // 2. Update password
                message.textContent = 'Changing password...';
                await updatePassword(currentUser, newPass);
                
                message.textContent = 'Password successfully updated!';
                message.className = 'message-area message-success';
                document.getElementById('password-change-form').reset();
                
            } catch (error) {
                console.error("Password change error:", error);
                if (error.code === 'auth/wrong-password') {
                    message.textContent = 'Incorrect current password.';
                } else {
                    message.textContent = `Error: ${error.message}`;
                }
                message.className = 'message-area message-error';
            } finally {
                button.disabled = false;
            }
        }
        
        async function handleAccountDelete() {
            const message = document.getElementById('delete-message');
            const confirmed = prompt(
                'This action is permanent and cannot be undone.\n' +
                'To confirm, please type "DELETE" in all caps:'
            );
            
            if (confirmed !== 'DELETE') {
                message.textContent = 'Account deletion cancelled.';
                message.className = 'message-area message-warning';
                return;
            }
            
            message.textContent = 'Please verify your identity to proceed...';
            message.className = 'message-area message-warning';
            
            try {
                // 1. Re-authenticate
                const primaryMethod = currentUserData.authMethod || 'unknown';
                if (primaryMethod === 'email') {
                    const password = prompt("Please enter your password to confirm deletion:");
                    if (!password) {
                        message.textContent = 'Deletion cancelled.';
                        message.className = 'message-area message-warning';
                        return;
                    }
                    const credential = EmailAuthProvider.credential(currentUser.email, password);
                    await reauthenticateWithCredential(currentUser, credential);
                } else {
                    // Social provider re-auth
                    let provider;
                    if (primaryMethod === 'google.com') provider = new GoogleAuthProvider();
                    else if (primaryMethod === 'github.com') provider = new GithubAuthProvider();
                    else if (primaryMethod === 'microsoft.com') provider = new OAuthProvider('microsoft.com');
                    else throw new Error('Unknown social provider for re-authentication');
                    
                    await reauthenticateWithPopup(currentUser, provider);
                }
                
                // 2. Re-authentication successful, proceed with deletion
                message.textContent = 'Deleting account data...';
                const userDocRef = doc(db, 'users', currentUser.uid);
                
                // We should delete the Firestore doc *before* deleting the auth user
                // (or use a Cloud Function trigger)
                await setDoc(userDocRef, { _deleted: true, deletedAt: serverTimestamp() }); // Soft delete, or use deleteDoc()
                
                // 3. Delete the auth user
                await deleteUser(currentUser);
                
                // This will trigger the onAuthStateChanged listener,
                // which will redirect to the login page.
                alert('Account successfully deleted.');
                
            } catch (error) {
                console.error("Account deletion error:", error);
                if (error.code === 'auth/wrong-password') {
                    message.textContent = 'Incorrect password. Deletion cancelled.';
                } else if (error.code === 'auth/popup-closed-by-user') {
                     message.textContent = 'Verification cancelled. Deletion cancelled.';
                } else {
                    message.textContent = `Error: ${error.message}`;
                }
                message.className = 'message-area message-error';
            }
        }

        /* --- START PRIVACY & SECURITY FUNCTIONS --- */

        /**
         * Renders the content for the "Privacy & Security" tab
         */
        function renderPrivacySettings() {
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Account Security</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Two-Factor Authentication</h4>
                                <p class="text-sm text-gray-400">Add an extra layer of security to your account</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="two-factor-toggle" disabled>
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="text-sm text-gray-500 ml-2">Coming Soon</span>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Login Notifications</h4>
                                <p class="text-sm text-gray-400">Get notified when someone logs into your account</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="login-notifications-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Session Management</h4>
                                <p class="text-sm text-gray-400">Manage your active sessions and devices</p>
                            </div>
                            <div class="setting-control">
                                <button class="btn-secondary" onclick="showActiveSessions()">
                                    <i class="fas fa-devices mr-2"></i>View Active Sessions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Data Privacy</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Analytics & Usage Data</h4>
                                <p class="text-sm text-gray-400">Help improve 4SP by sharing anonymous usage statistics</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="analytics-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Location Services</h4>
                                <p class="text-sm text-gray-400">Allow location-based features and services</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="location-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">AI Data Processing</h4>
                                <p class="text-sm text-gray-400">Allow AI features to process your data for personalization</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="ai-processing-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Data Retention</h4>
                                <p class="text-sm text-gray-400">Control how long your data is stored</p>
                            </div>
                            <div class="setting-control">
                                <select id="data-retention-select" class="form-select">
                                    <option value="1year">1 Year</option>
                                    <option value="2years" selected>2 Years</option>
                                    <option value="5years">5 Years</option>
                                    <option value="indefinite">Indefinite</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Communication Preferences</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Marketing Communications</h4>
                                <p class="text-sm text-gray-400">Receive updates about new features and improvements</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="marketing-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Research Participation</h4>
                                <p class="text-sm text-gray-400">Participate in user research and feedback programs</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="research-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Account Actions</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Download Your Data</h4>
                                <p class="text-sm text-gray-400">Get a copy of all your data stored in 4SP</p>
                            </div>
                            <div class="setting-control">
                                <button class="btn-secondary" onclick="requestDataDownload()">
                                    <i class="fas fa-download mr-2"></i>Request Download
                                </button>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-red-400">Delete Account</h4>
                                <p class="text-sm text-gray-400">Permanently delete your account and all associated data</p>
                            </div>
                            <div class="setting-control">
                                <button class="btn-danger" onclick="initiateAccountDeletion()">
                                    <i class="fas fa-trash mr-2"></i>Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for privacy settings
            setupPrivacyEventListeners();
        }

        function setupPrivacyEventListeners() {
            // Load saved privacy settings
            loadPrivacySettings();

            // Add change listeners
            document.getElementById('login-notifications-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('analytics-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('location-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('ai-processing-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('marketing-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('research-toggle').addEventListener('change', savePrivacySettings);
            document.getElementById('data-retention-select').addEventListener('change', savePrivacySettings);
        }

        function loadPrivacySettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('privacy-settings') || '{}');

                // Set toggle states
                document.getElementById('login-notifications-toggle').checked = settings.loginNotifications !== false;
                document.getElementById('analytics-toggle').checked = settings.analytics !== false;
                document.getElementById('location-toggle').checked = settings.location === true;
                document.getElementById('ai-processing-toggle').checked = settings.aiProcessing !== false;
                document.getElementById('marketing-toggle').checked = settings.marketing === true;
                document.getElementById('research-toggle').checked = settings.research === true;

                // Set data retention
                if (settings.dataRetention) {
                    document.getElementById('data-retention-select').value = settings.dataRetention;
                }
            } catch (error) {
                console.error('Error loading privacy settings:', error);
            }
        }

        function savePrivacySettings() {
            try {
                const settings = {
                    loginNotifications: document.getElementById('login-notifications-toggle').checked,
                    analytics: document.getElementById('analytics-toggle').checked,
                    location: document.getElementById('location-toggle').checked,
                    aiProcessing: document.getElementById('ai-processing-toggle').checked,
                    marketing: document.getElementById('marketing-toggle').checked,
                    research: document.getElementById('research-toggle').checked,
                    dataRetention: document.getElementById('data-retention-select').value
                };

                localStorage.setItem('privacy-settings', JSON.stringify(settings));

                // Show success message briefly
                showPrivacyMessage('Privacy settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving privacy settings:', error);
                showPrivacyMessage('Error saving privacy settings', 'error');
            }
        }

        function showPrivacyMessage(message, type) {
            // Create or update message element
            let messageEl = document.getElementById('privacy-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'privacy-message';
                messageEl.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300';
                document.body.appendChild(messageEl);
            }

            messageEl.textContent = message;
            messageEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;

            // Auto-hide after 3 seconds
            setTimeout(() => {
                if (messageEl) {
                    messageEl.remove();
                }
            }, 3000);
        }

        function showActiveSessions() {
            alert('Active Sessions feature coming soon! This will show all devices and locations where your account is currently logged in.');
        }

        function requestDataDownload() {
            alert('Data download feature coming soon! You will be able to download all your data in a portable format.');
        }

        function initiateAccountDeletion() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently lost.')) {
                if (confirm('This is your final warning. Are you absolutely sure you want to delete your account?')) {
                    alert('Account deletion feature coming soon! This will permanently delete your account and all associated data.');
                }
            }
        }

        /* --- START PERSONALIZATION FUNCTIONS (EXACTLY AS REQUESTED) --- */
        
        /**
         * Renders the content for the "Personalization" tab
         * (This function now assumes themePalettes is already populated)
         */
        function renderPersonalizationSettings() {
            // Helper function to get the currently saved theme
            function getCurrentTheme() {
                try {
                    const savedThemeString = localStorage.getItem(NAVBAR_SETTINGS_KEY);
                    if (savedThemeString) {
                        return JSON.parse(savedThemeString);
                    }
                } catch (e) {
                    console.error("Could not parse saved theme:", e);
                }
                // Use the (now loaded) themePalettes
                return themePalettes ? themePalettes[0] : {}; // Return default or empty
            }

            // Helper to compare two theme objects (by name, which should be unique)
            function areThemesEqual(themeA, themeB) {
                return themeA && themeB && themeA.name === themeB.name;
            }

            const currentTheme = getCurrentTheme();
            
            let swatchesHtml = '';
            // Check if themePalettes is loaded
            if (!themePalettes) {
                panelContent.innerHTML = '<p class="message-area message-error">Could not load theme data. Please try refreshing the page.</p>';
                return;
            }

            themePalettes.forEach((theme, index) => {
                const isSelected = areThemesEqual(theme, currentTheme);
                swatchesHtml += `
                    <div class="color-option ${isSelected ? 'selected' : ''}" 
                         data-theme-index="${index}"
                         title="${theme.name}"
                         style="background-color: ${theme['navbar-bg']}; border-color: ${theme['navbar-border']};">
                         <span style="color: ${theme['tab-active-text']}; text-shadow: 0 1px 2px ${theme['navbar-bg']};">${theme.name}</span>
                    </div>
                `;
            });
            
            // Enhanced personalization with user profile customization
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">User Profile</h3>
                    <div class="space-y-6">
                        <div class="profile-avatar-section">
                            <h4 class="text-lg font-medium text-white mb-3">Profile Avatar</h4>
                            <div class="flex items-center space-x-6">
                                <div class="avatar-preview">
                                    <div id="current-avatar" class="w-20 h-20 rounded-full bg-gray-600 flex items-center justify-center text-2xl font-bold text-white">
                                        ${getCurrentAvatar()}
                                    </div>
                                </div>
                                <div class="avatar-options space-y-3">
                                    <div class="avatar-type-selector">
                                        <label class="text-sm text-gray-300 mb-2 block">Avatar Type:</label>
                                        <select id="avatar-type-select" class="form-select">
                                            <option value="letter">Letter</option>
                                            <option value="number">Number</option>
                                            <option value="emoji">Emoji</option>
                                            <option value="image">Custom Image</option>
                                        </select>
                                    </div>
                                    <div id="avatar-input-container" class="avatar-input">
                                        <!-- Dynamic content based on avatar type -->
                                    </div>
                                    <div id="image-upload-container" class="hidden">
                                        <input type="file" id="avatar-image-input" accept="image/*" class="hidden">
                                        <button class="btn-secondary" onclick="document.getElementById('avatar-image-input').click()">
                                            <i class="fas fa-upload mr-2"></i>Upload Image
                                        </button>
                                        <div id="image-crop-container" class="hidden mt-4">
                                            <canvas id="crop-canvas" class="border border-gray-600 rounded"></canvas>
                                            <div class="mt-2 space-x-2">
                                                <button class="btn-primary" onclick="applyCroppedImage()">Apply</button>
                                                <button class="btn-secondary" onclick="cancelImageCrop()">Cancel</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-display-section">
                            <h4 class="text-lg font-medium text-white mb-3">Display Preferences</h4>
                            <div class="space-y-4">
                                <div class="setting-item">
                                    <div class="setting-header">
                                        <h5 class="text-md font-medium text-white">Show Avatar in Navigation</h5>
                                        <p class="text-sm text-gray-400">Display your avatar in the top navigation bar</p>
                                    </div>
                                    <div class="setting-control">
                                        <label class="toggle-switch">
                                            <input type="checkbox" id="show-avatar-nav-toggle" checked>
                                            <span class="toggle-slider"></span>
                                        </label>
                                    </div>
                                </div>

                                <div class="setting-item">
                                    <div class="setting-header">
                                        <h5 class="text-md font-medium text-white">Avatar Background Color</h5>
                                        <p class="text-sm text-gray-400">Choose a background color for letter/number avatars</p>
                                    </div>
                                    <div class="setting-control">
                                        <input type="color" id="avatar-bg-color" value="#6b7280" class="w-12 h-8 rounded border-0">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Navigation Bar Theme</h3>
                    <p class="settings-description mb-4">
                        Choose a theme for the top navigation bar. Your selection will be applied instantly and saved locally in your browser.
                    </p>
                    <div id="theme-palette" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
                        ${swatchesHtml}
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Interface Preferences</h3>
                    <div class="space-y-4">
                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Animations</h4>
                                <p class="text-sm text-gray-400">Enable smooth animations and transitions</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="animations-toggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Compact Mode</h4>
                                <p class="text-sm text-gray-400">Use a more compact layout to fit more content</p>
                            </div>
                            <div class="setting-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="compact-mode-toggle">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <div class="setting-item">
                            <div class="setting-header">
                                <h4 class="text-lg font-medium text-white">Font Size</h4>
                                <p class="text-sm text-gray-400">Adjust the base font size for better readability</p>
                            </div>
                            <div class="setting-control">
                                <select id="font-size-select" class="form-select">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                    <option value="extra-large">Extra Large</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Attach event listeners
            attachPersonalizationListeners();
        }

        /**
         * Gets the current avatar display value
         */
        function getCurrentAvatar() {
            try {
                const avatarSettings = JSON.parse(localStorage.getItem('user-avatar-settings') || '{}');
                return avatarSettings.display || currentUserData?.username?.charAt(0)?.toUpperCase() || 'U';
            } catch (error) {
                return currentUserData?.username?.charAt(0)?.toUpperCase() || 'U';
            }
        }

        /**
         * Attaches event listeners for the Personalization panel
         */
        function attachPersonalizationListeners() {
            // Load saved personalization settings
            loadPersonalizationSettings();

            // Avatar type selector
            document.getElementById('avatar-type-select').addEventListener('change', updateAvatarInput);

            // Avatar input changes
            document.getElementById('avatar-bg-color').addEventListener('change', updateAvatarPreview);

            // Interface preference toggles
            document.getElementById('show-avatar-nav-toggle').addEventListener('change', savePersonalizationSettings);
            document.getElementById('animations-toggle').addEventListener('change', savePersonalizationSettings);
            document.getElementById('compact-mode-toggle').addEventListener('change', savePersonalizationSettings);
            document.getElementById('font-size-select').addEventListener('change', savePersonalizationSettings);

            // Image upload
            document.getElementById('avatar-image-input').addEventListener('change', handleImageUpload);

            // Initialize avatar input
            updateAvatarInput();

            // Swatch click listener (for live preview AND immediate save)
            document.querySelectorAll('#theme-palette .color-option').forEach(swatch => {
                swatch.addEventListener('click', (e) => {
                    // 1. Remove 'selected' from all and add to clicked
                    document.querySelectorAll('#theme-palette .color-option').forEach(s => s.classList.remove('selected'));
                    const selectedSwatch = e.currentTarget;
                    selectedSwatch.classList.add('selected');
                    
                    // 2. Get theme data
                    const themeIndex = selectedSwatch.dataset.themeIndex;
                    const theme = themePalettes[themeIndex];
                    
                    if (window.applyTheme) {
                        // 3. Apply theme for live preview
                        window.applyTheme(theme);
                        
                        // 4. Save theme to local storage immediately
                        try {
                            // If it's the default theme (index 0), just remove the key (effectively setting default)
                            if (parseInt(themeIndex) === 0) {
                                localStorage.removeItem(NAVBAR_SETTINGS_KEY);
                            } else {
                                // Save the selected theme object
                                localStorage.setItem(NAVBAR_SETTINGS_KEY, JSON.stringify(theme));
                            }
                        } catch (error) {
                            console.error("Error saving theme to Local Storage:", error);
                            // In a full implementation, you might want a non-blocking temporary message here
                        }
                        
                    } else {
                        console.error("window.applyTheme is not defined. Make sure navigation.js is loaded.");
                    }
                });
            });
            
            // REMOVED event listeners for 'theme-save-btn' and 'theme-reset-btn'
        }

        /**
         * Updates the avatar input based on selected type
         */
        function updateAvatarInput() {
            const avatarType = document.getElementById('avatar-type-select').value;
            const container = document.getElementById('avatar-input-container');
            const imageContainer = document.getElementById('image-upload-container');

            // Hide image upload by default
            imageContainer.classList.add('hidden');

            switch (avatarType) {
                case 'letter':
                    container.innerHTML = `
                        <label class="text-sm text-gray-300 mb-1 block">Letter:</label>
                        <input type="text" id="avatar-letter-input" maxlength="1"
                               class="form-input w-16 text-center uppercase"
                               placeholder="A" value="${getCurrentAvatar()}">
                    `;
                    document.getElementById('avatar-letter-input').addEventListener('input', updateAvatarPreview);
                    break;
                case 'number':
                    container.innerHTML = `
                        <label class="text-sm text-gray-300 mb-1 block">Number:</label>
                        <input type="number" id="avatar-number-input" min="0" max="99"
                               class="form-input w-16 text-center"
                               placeholder="1" value="${getCurrentAvatar()}">
                    `;
                    document.getElementById('avatar-number-input').addEventListener('input', updateAvatarPreview);
                    break;
                case 'emoji':
                    container.innerHTML = `
                        <label class="text-sm text-gray-300 mb-1 block">Emoji:</label>
                        <div class="emoji-picker">
                            <input type="text" id="avatar-emoji-input" maxlength="2"
                                   class="form-input w-16 text-center"
                                   placeholder="😀" value="${getCurrentAvatar()}">
                            <div class="emoji-suggestions mt-2 grid grid-cols-6 gap-1">
                                ${['😀', '😎', '🤖', '🎯', '🚀', '⭐', '🔥', '💎', '🎨', '🎵', '⚡', '🌟'].map(emoji =>
                                    `<button class="emoji-btn p-1 hover:bg-gray-700 rounded" onclick="selectEmoji('${emoji}')">${emoji}</button>`
                                ).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('avatar-emoji-input').addEventListener('input', updateAvatarPreview);
                    break;
                case 'image':
                    container.innerHTML = `<p class="text-sm text-gray-400">Upload a custom image below:</p>`;
                    imageContainer.classList.remove('hidden');
                    break;
            }

            updateAvatarPreview();
        }

        /**
         * Updates the avatar preview
         */
        function updateAvatarPreview() {
            const avatarType = document.getElementById('avatar-type-select').value;
            const preview = document.getElementById('current-avatar');
            const bgColor = document.getElementById('avatar-bg-color').value;

            let displayValue = '';

            switch (avatarType) {
                case 'letter':
                    const letterInput = document.getElementById('avatar-letter-input');
                    displayValue = letterInput ? letterInput.value.toUpperCase() : 'A';
                    break;
                case 'number':
                    const numberInput = document.getElementById('avatar-number-input');
                    displayValue = numberInput ? numberInput.value : '1';
                    break;
                case 'emoji':
                    const emojiInput = document.getElementById('avatar-emoji-input');
                    displayValue = emojiInput ? emojiInput.value : '😀';
                    break;
                case 'image':
                    // Handle image preview separately
                    return;
            }

            preview.textContent = displayValue;
            preview.style.backgroundColor = bgColor;

            // Save avatar settings
            saveAvatarSettings(avatarType, displayValue, bgColor);
        }

        /**
         * Selects an emoji for the avatar
         */
        function selectEmoji(emoji) {
            document.getElementById('avatar-emoji-input').value = emoji;
            updateAvatarPreview();
        }

        /**
         * Handles image upload for avatar
         */
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                showImageCropper(e.target.result);
            };
            reader.readAsDataURL(file);
        }

        /**
         * Shows the image cropper
         */
        function showImageCropper(imageSrc) {
            const container = document.getElementById('image-crop-container');
            const canvas = document.getElementById('crop-canvas');
            const ctx = canvas.getContext('2d');

            const img = new Image();
            img.onload = function() {
                // Set canvas size
                const size = 200;
                canvas.width = size;
                canvas.height = size;

                // Calculate crop dimensions (center square)
                const minDim = Math.min(img.width, img.height);
                const x = (img.width - minDim) / 2;
                const y = (img.height - minDim) / 2;

                // Draw cropped image
                ctx.drawImage(img, x, y, minDim, minDim, 0, 0, size, size);

                container.classList.remove('hidden');
            };
            img.src = imageSrc;
        }

        /**
         * Applies the cropped image as avatar
         */
        function applyCroppedImage() {
            const canvas = document.getElementById('crop-canvas');
            const dataURL = canvas.toDataURL('image/png');

            // Update preview
            const preview = document.getElementById('current-avatar');
            preview.innerHTML = `<img src="${dataURL}" class="w-full h-full rounded-full object-cover">`;

            // Save avatar settings
            saveAvatarSettings('image', dataURL, null);

            // Hide cropper
            cancelImageCrop();
        }

        /**
         * Cancels image cropping
         */
        function cancelImageCrop() {
            document.getElementById('image-crop-container').classList.add('hidden');
            document.getElementById('avatar-image-input').value = '';
        }

        /**
         * Saves avatar settings to localStorage
         */
        function saveAvatarSettings(type, display, bgColor) {
            try {
                const settings = {
                    type: type,
                    display: display,
                    bgColor: bgColor,
                    timestamp: Date.now()
                };
                localStorage.setItem('user-avatar-settings', JSON.stringify(settings));
            } catch (error) {
                console.error('Error saving avatar settings:', error);
            }
        }

        /**
         * Loads personalization settings
         */
        function loadPersonalizationSettings() {
            try {
                // Load avatar settings
                const avatarSettings = JSON.parse(localStorage.getItem('user-avatar-settings') || '{}');
                if (avatarSettings.type) {
                    document.getElementById('avatar-type-select').value = avatarSettings.type;
                }
                if (avatarSettings.bgColor) {
                    document.getElementById('avatar-bg-color').value = avatarSettings.bgColor;
                }

                // Load interface settings
                const interfaceSettings = JSON.parse(localStorage.getItem('interface-settings') || '{}');
                document.getElementById('show-avatar-nav-toggle').checked = interfaceSettings.showAvatarNav !== false;
                document.getElementById('animations-toggle').checked = interfaceSettings.animations !== false;
                document.getElementById('compact-mode-toggle').checked = interfaceSettings.compactMode === true;

                if (interfaceSettings.fontSize) {
                    document.getElementById('font-size-select').value = interfaceSettings.fontSize;
                }
            } catch (error) {
                console.error('Error loading personalization settings:', error);
            }
        }

        /**
         * Saves personalization settings
         */
        function savePersonalizationSettings() {
            try {
                const settings = {
                    showAvatarNav: document.getElementById('show-avatar-nav-toggle').checked,
                    animations: document.getElementById('animations-toggle').checked,
                    compactMode: document.getElementById('compact-mode-toggle').checked,
                    fontSize: document.getElementById('font-size-select').value
                };

                localStorage.setItem('interface-settings', JSON.stringify(settings));

                // Apply settings immediately
                applyInterfaceSettings(settings);

                // Show success message
                showPersonalizationMessage('Interface settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving interface settings:', error);
                showPersonalizationMessage('Error saving interface settings', 'error');
            }
        }

        /**
         * Applies interface settings to the page
         */
        function applyInterfaceSettings(settings) {
            const body = document.body;

            // Apply animations
            if (!settings.animations) {
                body.style.setProperty('--transition-duration', '0s');
            } else {
                body.style.removeProperty('--transition-duration');
            }

            // Apply compact mode
            if (settings.compactMode) {
                body.classList.add('compact-mode');
            } else {
                body.classList.remove('compact-mode');
            }

            // Apply font size
            const fontSizeMap = {
                'small': '14px',
                'medium': '16px',
                'large': '18px',
                'extra-large': '20px'
            };
            body.style.fontSize = fontSizeMap[settings.fontSize] || '16px';
        }

        /**
         * Shows a personalization message
         */
        function showPersonalizationMessage(message, type) {
            let messageEl = document.getElementById('personalization-message');
            if (!messageEl) {
                messageEl = document.createElement('div');
                messageEl.id = 'personalization-message';
                messageEl.className = 'fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300';
                document.body.appendChild(messageEl);
            }

            messageEl.textContent = message;
            messageEl.className = `fixed top-4 right-4 px-4 py-2 rounded-lg z-50 transition-all duration-300 ${
                type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
            }`;

            setTimeout(() => {
                if (messageEl) {
                    messageEl.remove();
                }
            }, 3000);
        }

        /* --- END PERSONALIZATION FUNCTIONS --- */
        
        /* --- START DATA MANAGEMENT FUNCTIONS --- */
        
        /**
         * Renders the content for the "Data Management" tab
         */
        function renderDataManagement() {
            panelContent.innerHTML = `
                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Export Game Data (strongdogxp)</h3>
                    <p class="settings-description mb-4">
                        Download a local JSON file containing your game's data stored in this browser's Local Storage. This file can be used to restore your progress on another device or browser.
                    </p>
                    <button id="export-data-btn" class="settings-button settings-button-secondary">
                        <i class="fas fa-download mr-2"></i> Download ${GAME_SAVE_FILENAME}
                    </button>
                    <div id="export-message" class="message-area"></div>
                </div>

                <div class="settings-section">
                    <h3 class="text-xl font-semibold text-white mb-4">Import Game Data (strongdogxp)</h3>
                    <p class="settings-description mb-4">
                        Upload a previously downloaded <code>${GAME_SAVE_FILENAME}</code> file to restore your game progress. <strong>Warning: This will overwrite your current local save for the game.</strong>
                    </p>
                    <div class="flex items-center gap-4">
                        <input type="file" id="import-file-input" accept="application/json" class="settings-input flex-grow">
                        <button id="import-data-btn" class="settings-button" disabled>
                            <i class="fas fa-upload mr-2"></i> Import
                        </button>
                    </div>
                    <div id="import-message" class="message-area"></div>
                </div>
            `;
            attachDataManagementListeners();
        }

        /**
         * Attaches event listeners for the Data Management panel
         */
        function attachDataManagementListeners() {
            const exportBtn = document.getElementById('export-data-btn');
            const importInput = document.getElementById('import-file-input');
            const importBtn = document.getElementById('import-data-btn');

            if (exportBtn) {
                exportBtn.addEventListener('click', downloadSaveFile);
            }

            if (importInput && importBtn) {
                // Enable/disable import button based on file selection
                importInput.addEventListener('change', () => {
                    importBtn.disabled = !importInput.files.length;
                });
                // Attach file upload handler
                importBtn.addEventListener('click', handleUploadFile);
            }
        }
        
        /**
         * Collects all keys and values from localStorage to prepare the export file.
         */
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Exclude settings keys that should not be part of a game save file
                if (key !== NAVBAR_SETTINGS_KEY) { 
                    try {
                        // Attempt to parse to see if it's JSON, otherwise keep as string
                        data[key] = JSON.parse(localStorage.getItem(key));
                    } catch {
                        data[key] = localStorage.getItem(key);
                    }
                }
            }
            return {
                localStorageBackup: data,
                exportedAt: new Date().toISOString()
            };
        }
        
        /**
         * Initiates the download of the game save file.
         */
        function downloadSaveFile() {
            const message = document.getElementById('export-message');
            message.textContent = 'Preparing download...';
            message.className = 'message-area message-warning';

            try {
                const dataToDownload = getAllLocalStorageData();
                const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], {
                    type: "application/json",
                });
                
                // Create a hidden link to trigger the download
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = GAME_SAVE_FILENAME;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url); // Clean up the URL object

                message.textContent = 'Game data successfully downloaded!';
                message.className = 'message-area message-success';

            } catch (error) {
                console.error("Error during download:", error);
                message.textContent = 'Error: Failed to create or download file.';
                message.className = 'message-area message-error';
            }
        }
        
        /**
         * Handles the file selection and parsing for import.
         */
        function handleUploadFile() {
            const input = document.getElementById('import-file-input');
            const button = document.getElementById('import-data-btn');
            const message = document.getElementById('import-message');

            if (!input.files.length) {
                message.textContent = 'Please select a file to import.';
                message.className = 'message-area message-error';
                return;
            }

            if (!confirm("Are you sure you want to import this save file? Your current local game progress will be overwritten.")) {
                return;
            }

            const file = input.files[0];
            const reader = new FileReader();

            message.textContent = `Reading ${file.name}...`;
            message.className = 'message-area message-warning';
            button.disabled = true;

            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    if (!importedData.localStorageBackup) {
                         throw new Error('Invalid save file format. Missing "localStorageBackup" field.');
                    }
                    
                    applyImportedData(importedData.localStorageBackup);
                    
                    message.textContent = 'Game data successfully imported! Please reload the game page to see changes.';
                    message.className = 'message-area message-success';
                    // Optional: force a reload or redirect
                    // setTimeout(() => window.location.href = '../index.html', 1500);

                } catch (error) {
                    console.error("Import error:", error);
                    message.textContent = `Error importing file: ${error.message}`;
                    message.className = 'message-area message-error';
                } finally {
                    button.disabled = false;
                    input.value = ''; // Reset file input
                }
            };

            reader.onerror = () => {
                message.textContent = 'Error reading file.';
                message.className = 'message-area message-error';
                button.disabled = false;
            };

            reader.readAsText(file);
        }

        /**
         * Clears all game-related localStorage keys and applies imported data.
         * NOTE: This is a destructive operation.
         */
        function applyImportedData(data) {
            // OPTIONAL: Clear specific keys only if needed, but for a full save replace, a more direct approach is:
            // This implementation assumes a full overwrite of game-related keys.
            
            // 1. (Optional but safer) Clear only game-related keys
            // You would need a list of all game keys here. For simplicity, we'll
            // assume that any key NOT the NAVBAR_SETTINGS_KEY is a game key.
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key !== NAVBAR_SETTINGS_KEY) {
                    localStorage.removeItem(key);
                }
            }
            
            // 2. Apply new data
            for (const key in data) {
                const value = data[key];
                // localStorage only stores strings, so convert objects back to JSON strings
                if (typeof value === 'object' && value !== null) {
                    localStorage.setItem(key, JSON.stringify(value));
                } else {
                    localStorage.setItem(key, value);
                }
            }
        }

        /* --- END DATA MANAGEMENT FUNCTIONS --- */
        
        // --- START APPLICATION ---
        document.addEventListener('DOMContentLoaded', startAuthFlow);
    </script>
</body>
</html>

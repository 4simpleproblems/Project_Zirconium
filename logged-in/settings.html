<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SETTINGS</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js" defer></script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #040404; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- Custom Dropdown Styles --- */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 100%;
        }
        .custom-select {
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .custom-select-trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 300;
            color: #c0c0c0;
            background: #111111;
            border: 1px solid #252525;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-select-trigger:hover {
            border-color: #505050;
        }
        .custom-options {
            position: absolute;
            display: block;
            top: 100%;
            left: 0;
            right: 0;
            border: 1px solid #252525;
            border-top: 0;
            border-bottom-left-radius: 0.5rem;
            border-bottom-right-radius: 0.5rem;
            background: #111111;
            transition: all 0.2s;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            z-index: 50;
            margin-top: 2px;
            overflow: hidden;
        }
        .custom-select.open .custom-options {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
            border-color: #505050;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .custom-option {
            position: relative;
            display: block;
            padding: 0.75rem;
            font-size: 1rem;
            font-weight: 300;
            color: #c0c0c0;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-option:hover {
            background-color: #252525;
            color: #ffffff;
        }
        .custom-option.selected {
            background-color: #1a1a1a;
            color: #ffffff;
            font-weight: 400;
        }
        .arrow {
            position: relative;
            height: 10px;
            width: 10px;
        }
        .arrow::before, .arrow::after {
            content: "";
            position: absolute;
            bottom: 0px;
            width: 0.15rem;
            height: 100%;
            transition: all 0.2s;
        }
        .arrow::before {
            left: -3px;
            transform: rotate(-45deg);
            background-color: #6b7280;
        }
        .arrow::after {
            left: 3px;
            transform: rotate(45deg);
            background-color: #6b7280;
        }
        .custom-select.open .arrow::before {
            left: -3px;
            transform: rotate(45deg);
        }
        .custom-select.open .arrow::after {
            left: 3px;
            transform: rotate(-45deg);
        }

        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
        /* --- Cropper Modal Styles --- */
        #cropperModal {
            display: none;
            position: fixed;
            z-index: 2050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.85);
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        #cropperContent {
            background-color: #1a1a1a;
            padding: 20px;
            border-radius: 16px;
            border: 1px solid #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 90%;
            max-width: 600px;
        }
        #cropperCanvasContainer {
            position: relative;
            margin-bottom: 20px;
            overflow: hidden;
            /* Limits for the canvas display */
            max-height: 60vh; 
        }
        #cropperCanvas {
            display: block;
            max-width: 100%;
            max-height: 60vh;
            border: 1px dashed rgba(255, 255, 255, 0.3); /* Thinner dashed outline */
        }
        
        /* --- Color Palette Styles --- */
        .color-palette-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
            gap: 10px;
            width: 100%;
            margin-top: 10px;
        }
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s, border-color 0.2s;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px #4f46e5; /* Ring effect */
        }
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p id="loadingText">Loading...</p>
    </div>
    
    
    <div id="cropperModal">
        <div id="cropperContent">
            <h3 class="text-xl font-bold text-white mb-4">Adjust Profile Picture</h3>
            <p class="text-sm text-gray-400 mb-4">Drag to move. Scroll to resize the selection.</p>
            
            <div id="cropperCanvasContainer">
                <canvas id="cropperCanvas"></canvas>
            </div>
            
            <div class="flex justify-between w-full mt-4">
                <button id="cancelCropBtn" class="btn-toolbar-style">
                    <i class="fa-solid fa-xmark mr-2"></i> Cancel
                </button>
                <button id="submitCropBtn" class="btn-toolbar-style btn-primary-override">
                    <i class="fa-solid fa-check mr-2"></i> Submit
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider, 
            reauthenticateWithCredential, 
            updatePassword,
            // NEW AUTH IMPORTS
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            reauthenticateWithPopup,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            deleteDoc // NEW FIREBASE IMPORT
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config (Assumed to exist in a relative file) ---
        import { firebaseConfig } from "../firebase-config.js"; 
        
        // --- NEW: Import Site Mapping (from index.html logic) ---
        // This file MUST exist at ../site-mapping.js for import/export to work
        import { siteMapping } from "../site-mapping.js";


        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object
        
        // --- NEW: Global var for loading overlay (from index.html) ---
        let loadingTimeout = null;
        
        // Constants for validation and limits
        const MIN_LENGTH = 6; 
        const MAX_LENGTH = 24;
        const MAX_CHANGES = 5; 


        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // Constants for providers (NEW)
        const PROVIDER_CONFIG = {
            'google.com': { 
                name: 'Google', 
                icon: '../images/google-icon.png', 
                instance: () => new GoogleAuthProvider() 
            },
            'github.com': { 
                name: 'GitHub', 
                icon: '../images/github-mark-white.png', 
                instance: () => new GithubAuthProvider() 
            },
            'microsoft.com': { 
                name: 'Microsoft', 
                icon: '../images/microsoft.png', 
                instance: () => new OAuthProvider('microsoft.com') 
            },
            'password': { 
                name: 'Email & Password', 
                icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', 
                isCredential: true
            }
        };

        // --- NEW: Constants for Privacy Settings ---
        
        // IndexedDB Config for Panic Key
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';
        
        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';


        // Presets copied from url-changer.js
        const urlChangerPresets = [
            { id: 'hac', name: 'HAC', title: 'Login', favicon: '../favicons/hac.png', category: 'websites' },
            { id: 'gmm', name: 'GMM', title: 'Get More Math!', favicon: '../favicons/gmm.png', category: 'websites' },
            { id: 'kahoot', name: 'Kahoot', title: 'Kahoot! | Learning games | Make learning awesome!', favicon: '../favicons/kahoot.png', category: 'websites' },
            { id: 'g_classroom', name: 'Google Classroom', title: 'Home', favicon: '../favicons/google-classroom.png', category: 'websites' },
            { id: 'g_docs', name: 'Google Docs', title: 'Google Docs', favicon: '../favicons/google-docs.png', category: 'websites' },
            { id: 'g_slides', name: 'Google Slides', title: 'Google Slides', favicon: '../favicons/google-slides.png', category: 'websites' },
            { id: 'g_drive', name: 'Google Drive', title: 'Home - Google Drive', favicon: '../favicons/google-drive.png', category: 'websites' },
            { id: 'wikipedia', name: 'Wikipedia', title: 'Wikipedia', favicon: '../favicons/wikipedia.png', category: 'websites' },
            { id: 'clever', name: 'Clever', title: 'Clever | Connect every student to a world of learning', favicon: '../favicons/clever.png', category: 'websites' },
            { id: '_LIVE_CURRENT_TIME', name: 'Current Time', title: 'Live Time', favicon: '', category: 'live', live: true }
        ];

        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            // Prevent clearing a success message if a warning is generated elsewhere
            if (element && element.innerHTML.includes('success') && type !== 'error') return;
            if (element) {
                element.innerHTML = text;
                element.className = `general-message-area text-sm ${type}-message`;
            }
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };
        
        // --- NEW: IndexedDB Helper Functions ---

        /**
         * Opens the IndexedDB and creates the object store if needed.
         */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        /**
         * Fetches all panic key settings from IndexedDB.
         */
        async function getPanicKeySettings() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const settingsMap = new Map(request.result.map(item => [item.id, item]));
                    db.close();
                    resolve(settingsMap);
                };
                request.onerror = () => {
                     db.close();
                    reject(request.error);
                };
            });
        }
        
        /**
         * Saves panic key settings to IndexedDB.
         */
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                let completed = 0;
                const total = settingsArray.length;

                settingsArray.forEach(setting => {
                    const request = store.put(setting);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = () => {
                         db.close();
                        reject(request.error); // Stop on first error
                    };
                });
                
                // Handle case where array is empty
                if (total === 0) {
                     db.close();
                    resolve();
                }
            });
        }

        // --- NEW: localStorage Helper Functions ---
        
        function getSavedUrlChangerSetting() {
            const savedSettingsJSON = localStorage.getItem(URL_CHANGER_KEY);
            let savedSettings = { type: 'none' };
            if (savedSettingsJSON) {
                try { 
                    savedSettings = JSON.parse(savedSettingsJSON); 
                } catch (e) { 
                    console.error("Failed to parse saved tab settings, reverting to default.", e); 
                }
            }
            return savedSettings;
        }

        function saveUrlChangerSetting(settings) {
            try {
                localStorage.setItem(URL_CHANGER_KEY, JSON.stringify(settings));
                return true;
            } catch (e) {
                console.error("Failed to save URL changer settings:", e);
                return false;
            }
        }
        
        // --- NEW: Modal and Loading Functions (from index.html) ---
        
        function openModal(text, buttons = []) {
            const modal = document.getElementById('modalPrompt');
            const modalText = document.getElementById('modalText');
            const modalButtons = document.getElementById('modalButtons');
            
            modalText.textContent = text;
            modalButtons.innerHTML = "";
            buttons.forEach(btn => {
                const buttonEl = document.createElement("button");
                // MODIFICATION: Use settings page button styles
                buttonEl.className = "btn-toolbar-style";
                if (btn.text.toLowerCase() === 'yes') {
                    buttonEl.classList.add('btn-primary-override-danger'); // Make 'Yes' destructive
                } else {
                    buttonEl.classList.add('btn-primary-override');
                }
                buttonEl.textContent = btn.text;
                buttonEl.onclick = btn.onclick;
                modalButtons.appendChild(buttonEl);
            });
            modal.style.display = "flex";
        }
        
        function showLoading(text = "Loading...") {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000); // 5 second timeout
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }
        
        // --- NEW: Core Data Functions (from index.html) ---
        
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Skip theme key
                if (key === THEME_STORAGE_KEY) continue;
                // Skip URL changer key
                if (key === URL_CHANGER_KEY) continue;
                
                const value = localStorage.getItem(key);
                data[key] = value;
            }
            return data;
        }

        function setAllLocalStorageData(data) {
            // Don't clear *everything*, just the keys in the data
            // This avoids wiping the user's theme setting
            for (const [key, value] of Object.entries(data)) {
                localStorage.setItem(key, value);
            }
        }

        async function getAllIndexedDBData() {
            if (!indexedDB.databases) return {};
            let dbList = [];
            try {
                dbList = await indexedDB.databases();
            } catch (error) {
                console.error("Error fetching IndexedDB databases:", error);
                return {};
            }
            const result = {};
            for (const dbInfo of dbList) {
                if (!dbInfo.name) continue;
                // Skip our own settings DB
                if (dbInfo.name === DB_NAME) continue; 
                
                result[dbInfo.name] = await getDataFromDatabase(dbInfo.name);
            }
            return result;
        }

        function getDataFromDatabase(dbName) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName);
                request.onsuccess = event => {
                    const db = event.target.result;
                    const storeNames = Array.from(db.objectStoreNames);
                    const dbData = {};
                    let pending = storeNames.length;
                    if (pending === 0) {
                        db.close();
                        resolve(dbData);
                        return;
                    }
                    storeNames.forEach(storeName => {
                        const transaction = db.transaction(storeName, "readonly");
                        const store = transaction.objectStore(storeName);
                        const items = [];
                        const cursorRequest = store.openCursor();
                        cursorRequest.onsuccess = evt => {
                            const cursor = evt.target.result;
                            if (cursor) {
                                items.push({ key: cursor.key, value: cursor.value });
                                cursor.continue();
                            } else {
                                dbData[storeName] = items;
                                pending--;
                                if (pending === 0) {
                                    db.close();
                                    resolve(dbData);
                                }
                            }
                        };
                        cursorRequest.onerror = evt => {
                            pending--;
                            if (pending === 0) {
                                db.close();
                                resolve(dbData);
                            }
                        };
                    });
                };
                request.onerror = event => {
                    reject(event.target.error);
                };
            });
        }

        async function setAllIndexedDBData(indexedData) {
            for (const dbName in indexedData) {
                const storesData = indexedData[dbName];
                await new Promise(resolve => {
                    const deleteRequest = indexedDB.deleteDatabase(dbName);
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => resolve();
                    deleteRequest.onblocked = () => resolve();
                });
                const openRequest = indexedDB.open(dbName, 1);
                openRequest.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    for (const storeName in storesData) {
                        if (!db.objectStoreNames.contains(storeName)) {
                            db.createObjectStore(storeName, { autoIncrement: false });
                        }
                    }
                };
                const dbInstance = await new Promise((resolve, reject) => {
                    openRequest.onsuccess = event => {
                        resolve(event.target.result);
                    };
                    openRequest.onerror = event => {
                        reject(event.target.error);
                    };
                });
                for (const storeName in storesData) {
                    await new Promise(resolve => {
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => resolve();
                        const store = transaction.objectStore(storeName);
                        const clearRequest = store.clear();
                        clearRequest.onsuccess = async () => {
                            for (const record of storesData[storeName]) {
                                await new Promise(r => {
                                    const putRequest = store.put(record.value, record.key);
                                    putRequest.onsuccess = () => r();
                                    putRequest.onerror = () => r();
                                });
                            }
                        };
                    });
                }
                dbInstance.close();
            }
        }
        
        // --- NEW: Domain Key Functions (from index.html) ---
        
        function getCurrentSiteKey() {
            const currentURL = window.location.href;
            const keys = Object.keys(siteMapping);
            keys.sort((a, b) => b.length - a.length);
            for (const key of keys) {
                const normalizedKey = key.replace(/^https?:\/\//, "");
                if (currentURL.includes(normalizedKey)) {
                    return normalizedKey;
                }
            }
            return window.location.host + window.location.pathname.replace(/\/$/, "");
        }
        
        function normalizeDomainKey(str) {
            return str.replace(/^https?:\/\//, "").replace(/\/$/, "");
        }
        
        function replaceDomainsInData(dataObj, currentDomain) {
            const currentDomainKey = getCurrentSiteKey(); // Get current domain
            const keysToCheck = Object.keys(siteMapping).map(k => normalizeDomainKey(k));
            const normalizedCurrentDomain = normalizeDomainKey(currentDomainKey);

            function replaceInString(str) {
                for (const oldDomain of keysToCheck) {
                    if (str.includes(oldDomain)) {
                        const idx = str.indexOf(oldDomain);
                        if (idx === 0) {
                            return normalizedCurrentDomain + str.substring(oldDomain.length);
                        } else {
                            return str.replace(oldDomain, normalizedCurrentDomain);
                        }
                    }
                }
                return str;
            }
            
            // Check if dataObj is the root object {localStorageBackup: ..., indexedDBBackup: ...}
            if (dataObj.localStorageBackup || dataObj.indexedDBBackup) {
                 if (dataObj.localStorageBackup) {
                    const localObj = dataObj.localStorageBackup;
                     for (const k in localObj) {
                        const newKey = replaceInString(k);
                        let newVal = localObj[k];
                        if (typeof newVal === "string") {
                            newVal = replaceInString(newVal);
                        }
                        if (newKey !== k) {
                            delete localObj[k];
                            localObj[newKey] = newVal;
                        } else {
                            localObj[k] = newVal;
                        }
                    }
                 }
                 // Note: IndexedDB data is less likely to contain domain keys in its structure
                 // so we primarily focus on localStorage keys and values.
            }
        }
        
        // --- NEW: Import/Export Handlers (from index.html) ---
        
        async function downloadAllSaves() {
            showLoading("Preparing download...");
            const localData = getAllLocalStorageData();
            const indexedData = await getAllIndexedDBData();
            const dataToDownload = {
                localStorageBackup: localData,
                indexedDBBackup: indexedData,
            };
            hideLoading();
            const blob = new Blob([JSON.stringify(dataToDownload, null, 2)], {
                type: "application/json",
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "4sp_saves.json"; // Changed name
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function handleFileUpload() {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = ".json";
            input.onchange = async e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async evt => {
                    const content = evt.target.result;
                    let parsed;
                    try {
                        parsed = JSON.parse(content);
                    } catch (err) {
                        alert("Invalid file format");
                        return;
                    }
                    
                    // This is the domain key logic from index.html
                    replaceDomainsInData(parsed, ""); // Pass empty string, replaceDomainsInData will get it

                    openModal(
                        "Are you sure you would like to upload this save? It will overwrite all current local data.",
                        [
                            {
                                text: "Yes",
                                onclick: async () => {
                                    modal.style.display = "none";
                                    showLoading("Uploading save...");
                                    
                                    let loadedLocalData = parsed.localStorageBackup;
                                    let loadedIndexedData = parsed.indexedDBBackup;

                                    if (loadedLocalData)
                                        setAllLocalStorageData(loadedLocalData);
                                    if (loadedIndexedData)
                                        await setAllIndexedDBData(loadedIndexedData);
                                        
                                    hideLoading();
                                    alert("Upload complete! Refreshing the page...");
                                    setTimeout(() => location.reload(), 1000);
                                },
                            },
                            {
                                text: "No",
                                onclick: () => {
                                    modal.style.display = "none";
                                },
                            },
                        ]
                    );
                };
                reader.readAsText(file);
            };
            input.click();
        }

        /**
         * Generates the HTML for the "Change Password" section.
         */
        function getChangePasswordSection() {
            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Change Password</h3>
                <div id="passwordChangeSection" class="settings-box w-full p-4">
                    <p class="text-sm font-light text-gray-400 mb-3">
                        Change your password. You must provide your current password for security.
                    </p>
                    
                    <div class="flex flex-col gap-3">
                        <input type="password" id="currentPasswordInput" placeholder="Current Password" class="input-text-style">
                        <input type="password" id="newPasswordInput" placeholder="New Password (min 6 characters)" class="input-text-style">
                        <input type="password" id="confirmPasswordInput" placeholder="Confirm New Password" class="input-text-style">
                    </div>
                    
                    <div class="flex justify-between items-center pt-4">
                        <p id="passwordMessage" class="general-message-area text-sm"></p>
                        <button id="applyPasswordBtn" class="btn-toolbar-style btn-primary-override w-32" disabled style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-lock mr-1"></i> Apply
                        </button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Renders the Linked Providers and Account Deletion section.
         */
        function getAccountManagementContent(providerData) {
            // Determine the Primary Provider (the first one in the list)
            const primaryProviderId = providerData[0].providerId;
            
            let linkedProvidersHtml = providerData.map(info => {
                const id = info.providerId;
                const config = PROVIDER_CONFIG[id] || { name: id, icon: '<i class="fa-solid fa-puzzle-piece fa-lg mr-3"></i>' };
                
                // Determine if this provider can be unlinked
                const canUnlink = providerData.length > 1 && !(id === 'password' && primaryProviderId === 'password');
                
                // Determine if icon is an image or a FontAwesome icon
                let iconHtml = config.icon.startsWith('<i') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-5 h-5 mr-3">`;

                return `
                    <div class="flex justify-between items-center px-4 py-4 border-b border-[#252525] last:border-b-0">
                        <div class="flex items-center text-lg text-white">
                            ${iconHtml}
                            ${config.name}
                            ${id === primaryProviderId ? '<span class="text-xs text-yellow-400 ml-2 font-normal">(Primary)</span>' : ''}
                        </div>
                        ${canUnlink ? 
                            `<button class="btn-toolbar-style text-red-400 hover:border-red-600 hover:text-red-600" data-provider-id="${id}" data-action="unlink" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-unlink mr-1"></i> Unlink
                            </button>` : 
                            `<span class="text-xs text-custom-light-gray font-light ml-4">Cannot Unlink</span>`
                        }
                    </div>
                `;
            }).join('');

            // Filter out already linked social providers for the linking list
            const linkedIds = providerData.map(p => p.providerId);
            let availableProvidersHtml = Object.keys(PROVIDER_CONFIG)
                .filter(id => id !== 'password' && !linkedIds.includes(id))
                .map(id => {
                    const config = PROVIDER_CONFIG[id];
                    let iconHtml = config.icon.startsWith('<i') ? config.icon : `<img src="${config.icon}" alt="${config.name} Icon" class="w-5 h-5 mr-3">`;

                    return `
                        <div class="flex justify-between items-center px-4 py-4 border-b border-[#252525] last:border-b-0">
                            <div class="flex items-center text-lg text-white">
                                ${iconHtml}
                                ${config.name}
                            </div>
                            <button class="btn-toolbar-style btn-primary-override" data-provider-id="${id}" data-action="link" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-link mr-1"></i> Link Provider
                            </button>
                        </div>
                    `;
                }).join('');
                
            if (availableProvidersHtml === '') {
                availableProvidersHtml = `
                    <div class="px-4 py-4">
                        <p class="text-sm text-gray-500 text-center">All available social providers are linked.</p>
                    </div>
                `;
            }


            // --- Account Deletion Section ---
            let deletionContent = '';
            
            if (primaryProviderId === 'password') {
                deletionContent = `
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                    <div id="deletionSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                        <p class="text-sm font-light text-red-300 mb-3">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                            WARNING: Deleting your account is permanent and cannot be undone.
                        </p>
                        
                        <div id="passwordDeletionStep1">
                            <label for="deletePasswordInput" class="block text-red-300 text-sm font-light mb-2">Confirm Current Password</label>
                            <input type="password" id="deletePasswordInput" placeholder="Current Password" class="input-text-style w-full bg-red-900/20 border-red-700/50 mb-3">
                            
                            <label for="deleteConfirmText" class="block text-red-300 text-sm font-light mb-2">Type "Delete My Account" to confirm (Case-insensitive)</label>
                            <input type="text" id="deleteConfirmText" placeholder="Delete My Account" class="input-text-style w-full bg-red-900/20 border-red-700/50">
                            
                            <div class="flex justify-between items-center pt-4">
                                <p id="deleteMessage" class="general-message-area text-sm"></p>
                                <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48" disabled style="padding: 0.5rem 0.75rem;">
                                     <i class="fa-solid fa-trash mr-1"></i> Delete Account
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                deletionContent = `
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Delete Account</h3>
                    <div id="deletionSection" class="settings-box w-full bg-red-900/10 border-red-700/50 p-4">
                        <p class="text-sm font-light text-red-300 mb-3">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                            WARNING: Deleting your account is permanent. You must re-authenticate with ${PROVIDER_CONFIG[primaryProviderId].name} to proceed.
                        </p>
                        
                        <div class="flex justify-between items-center pt-2">
                            <p id="deleteMessage" class="general-message-area text-sm"></p>
                            <button id="reauthenticateBtn" class="btn-toolbar-style w-48 btn-primary-override" data-provider-id="${primaryProviderId}" style="padding: 0.5rem 0.75rem;">
                                 <i class="fa-solid fa-key mr-1"></i> Re-authenticate
                            </button>
                            <button id="finalDeleteBtn" class="btn-toolbar-style btn-primary-override-danger w-48 hidden" style="padding: 0.5rem 0.75rem;">
                                 <i class="fa-solid fa-trash mr-1"></i> Delete Account
                            </button>
                        </div>
                    </div>
                `;
            }

            // --- Combined HTML for Account Management ---
            return `
                <h3 class="text-xl font-bold text-white mb-2 mt-8">Linked Providers</h3>
                <div class="settings-box w-full mb-4 p-0" data-section="linked-providers">
                    ${linkedProvidersHtml}
                </div>
                
                <h3 class="text-xl font-bold text-white mb-2">Link New Providers</h3>
                <div class="settings-box w-full flex flex-col gap-0 p-0">
                    ${availableProvidersHtml}
                </div>
                
                ${deletionContent}
            `;
        }


        /**
         * Generates the HTML for the "General Settings" section.
         */
        function getGeneralContent(currentUsername, changesRemaining, changesThisMonth, currentMonthName, isEmailPasswordUser, providerData) {
             const changesUsed = changesThisMonth;
             
             // Conditionally generate the password section HTML
             let passwordSectionHtml = '';
             if (isEmailPasswordUser) {
                 passwordSectionHtml = getChangePasswordSection();
             }

             return `
                 <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                 
                 <div class="w-full">
                    
                    <div class="flex justify-between items-center mb-4 settings-box p-4">
                        <p class="text-sm font-light text-gray-300">
                           <i class="fa-solid fa-calendar-alt mr-2 text-yellow-500"></i>
                           Changes this month (<span class="text-emphasis text-yellow-300">${currentMonthName}</span>):
                        </p>
                        <span class="text-lg font-semibold ${changesRemaining > 0 ? 'text-green-400' : 'text-red-400'}">
                            ${changesUsed}/${MAX_CHANGES} used
                        </span>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Account Username</h3>
                    
                    <div id="usernameSection" class="settings-box transition-all duration-300 p-4">
                        
                        <div id="viewMode" class="flex justify-between items-center">
                            <p class="text-lg text-gray-400 leading-relaxed">
                                Current: <span id="currentUsernameText" class="text-emphasis text-blue-400">${currentUsername}</span>
                            </p>
                            <button id="enterEditModeBtn" class="btn-toolbar-style" style="padding: 0.5rem 0.75rem;">
                                 <i class="fa-solid fa-pen-to-square mr-1"></i> Change
                            </button>
                        </div>

                        <div id="editMode" class="hidden flex-col gap-3 pt-4 border-t border-[#252525]">
                            <label for="newUsernameInput" class="block text-gray-400 text-sm font-light">New Username</label>
                            <input type="text" id="newUsernameInput" value="${currentUsername}" maxlength="${MAX_LENGTH}"
                                   class="input-text-style w-full" 
                                   placeholder="${MIN_LENGTH}-${MAX_LENGTH} characters, only allowed symbols">
                            
                            <div class="flex justify-between items-center pt-2">
                                <p class="text-xs text-gray-500 font-light whitespace-nowrap">
                                    Length: <span id="minLength" class="font-semibold text-gray-400">${MIN_LENGTH}</span>/<span id="charCount" class="font-semibold text-gray-400">${currentUsername.length}</span>/<span id="maxLength" class="font-semibold text-gray-400">${MAX_LENGTH}</span>
                                </p>
                                
                                <div class="flex gap-2">
                                    <button id="applyUsernameBtn" class="btn-toolbar-style btn-primary-override w-24 transition-opacity duration-300" disabled style="padding: 0.5rem 0.75rem;">
                                        <i class="fa-solid fa-check"></i> Apply
                                    </button>
                                    <button id="cancelEditBtn" class="btn-toolbar-style w-24 transition-opacity duration-300" style="padding: 0.5rem 0.75rem;">
                                        <i class="fa-solid fa-xmark"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="usernameChangeMessage" class="general-message-area text-sm"></div>
                </div>
                
                ${passwordSectionHtml}
                
                ${getAccountManagementContent(providerData)}
             `;
         }

        /**
         * NEW: Generates the HTML for the "Privacy & Security" section.
         */
        function getPrivacyContent() {
            // Generate preset options
            const presetOptions = urlChangerPresets.map(preset => 
                `<option value="${preset.id}">${preset.name}</option>`
            ).join('');

            return `
                <h2 class="text-3xl font-bold text-white mb-6">Privacy & Security</h2>
                
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Panic Key Settings</h3>
                    <div id="panicKeySection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Configure up to 3 panic keys. Pressing the specified key (without Shift, Ctrl, or Alt) on any page will redirect you to the URL you set.
                            <br>
                            <span class="text-yellow-400">Valid keys:</span> a-z, 0-9, and \` - = [ ] \\ ; ' , . /
                        </p>
                        
                        <div class="flex items-center gap-4 px-2 mb-2">
                            <label class="block text-gray-400 text-sm font-light" style="width: 4rem; text-align: center;">Key</label>
                            <label class="block text-gray-400 text-sm font-light flex-grow">Redirect URL</label>
                        </div>

                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey1" data-key-id="1" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl1" class="input-text-style" placeholder="e.g., https://google.com">
                        </div>
                        
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey2" data-key-id="2" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl2" class="input-text-style" placeholder="e.g., https://youtube.com/feed/subscriptions">
                        </div>
                        
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey3" data-key-id="3" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl3" class="input-text-style" placeholder="e.g., https://wikipedia.org">
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 border-t border-[#252525]">
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                            <button id="applyPanicKeyBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Keys
                            </button>
                        </div>
                    </div>
                    
                    <div id="panicKeyGlobalMessage" class="general-message-area text-sm"></div>
                </div>
                
                <div class="w-full mt-8">
                    <h3 class="text-xl font-bold text-white mb-2">Tab Disguise (URL Changer)</h3>
                    <div id="urlChangerSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Change the title and favicon of the website to disguise it. This setting is saved locally in your browser.
                        </p>
                        
                        <div class="flex flex-col gap-4">
                            <div>
                                <label for="tabDisguiseMode" class="block text-gray-400 text-sm font-light mb-2">Mode</label>
                                <select id="tabDisguiseMode" class="input-select-style">
                                    <option value="none">None (Use 4SP Default)</option>
                                    <option value="preset">Use a Preset</option>
                                    <option value="custom">Use Custom Title/Favicon</option>
                                </select>
                            </div>
                            
                            <div id="tabDisguisePresetGroup" class="hidden">
                                <label for="tabDisguisePreset" class="block text-gray-400 text-sm font-light mb-2">Preset</label>
                                <select id="tabDisguisePreset" class="input-select-style">
                                    ${presetOptions}
                                </select>
                            </div>
                            
                            <div id="tabDisguiseCustomGroup" class="hidden flex flex-col gap-4">
                                <div>
                                    <label for="customTabTitle" class="block text-gray-400 text-sm font-light mb-2">Custom Title</label>
                                    <input type="text" id="customTabTitle" class="input-text-style" placeholder="e.g., Google Docs">
                                </div>
                                
                                <div class="form-group">
                                    <label for="faviconFetchInput" class="block text-gray-400 text-sm font-light mb-2">Custom Favicon (Fetch from Domain)</label>
                                    <div class="flex items-center gap-2">
                                        <input type="text" id="faviconFetchInput" class="input-text-style" placeholder="e.g., google.com">
                                        <button type="button" id="fetchFaviconBtn" class="btn-toolbar-style btn-primary-override w-28" style="padding: 0.5rem 0.75rem;">Fetch</button>
                                        <div id="favicon-fetch-preview-container" class="w-10 h-10 border border-[#252525] bg-[#111111] rounded-md flex items-center justify-center p-1 flex-shrink-0">
                                            <img src="" alt="Preview" class="w-full h-full object-contain" style="display: none;">
                                        </div>
                                    </div>
                                </div>
                                </div>
                        </div>

                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="urlChangerMessage" class="general-message-area text-sm"></p>
                            <button id="applyUrlChangerBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Tab
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        
        /**
         * NEW: Generates the HTML for the "Personalization" section.
         */
        function getPersonalizationContent() {
             return `
                <h2 class="text-3xl font-bold text-white mb-6">Personalization</h2>
                
                <div class="w-full">
                    <!-- PROFILE PICTURE SECTION -->
                    <h3 class="text-xl font-bold text-white mb-2">Profile Picture</h3>
                    <div id="pfpSection" class="settings-box transition-all duration-300 p-4 mb-8">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Choose how you appear across the site.
                        </p>
                        
                        <div class="flex flex-col gap-4">
                            <!-- Mode Selection Dropdown -->
                            <div>
                                <label for="pfpModeSelect" class="block text-gray-400 text-sm font-light mb-2">Display Mode</label>
                                <select id="pfpModeSelect" class="input-select-style">
                                    <option value="google">Use Google Profile Picture</option>
                                    <option value="letter">Use Letter Avatar</option>
                                    <option value="custom">Upload Custom Image</option>
                                </select>
                            </div>

                            <!-- Letter Settings (Hidden by default) -->
                            <div id="pfpLetterSettings" class="hidden flex flex-col gap-4 mt-2">
                                <div>
                                    <label for="pfpLetterInput" class="block text-gray-400 text-sm font-light mb-2">Avatar Text (Max 3 Chars)</label>
                                    <div class="flex gap-2">
                                        <input type="text" id="pfpLetterInput" maxlength="3" class="input-text-style w-32" placeholder="ABC">
                                        <button id="saveLetterTextBtn" class="btn-toolbar-style btn-primary-override">
                                            <i class="fa-solid fa-save mr-2"></i> Save Text
                                        </button>
                                    </div>
                                </div>
                                
                                <div>
                                    <p class="text-xs text-gray-500 mb-2">Select Background Gradient:</p>
                                    <div id="letterColorPalette" class="color-palette-grid"></div>
                                </div>
                            </div>

                            <!-- Custom Upload Settings (Hidden by default) -->
                            <div id="pfpCustomSettings" class="hidden mt-2">
                                <div class="flex items-center gap-4">
                                    <!-- Preview -->
                                    <div class="w-16 h-16 rounded-full overflow-hidden border border-gray-600 flex-shrink-0 bg-black relative">
                                        <img id="customPfpPreview" src="" class="w-full h-full object-cover" style="display: none;">
                                        <div id="customPfpPlaceholder" class="w-full h-full flex items-center justify-center text-gray-600">
                                            <i class="fa-solid fa-user"></i>
                                        </div>
                                    </div>
                                    
                                    <!-- Upload Button -->
                                    <div>
                                        <button id="uploadPfpBtn" class="btn-toolbar-style btn-primary-override">
                                            <i class="fa-solid fa-upload mr-2"></i> Upload Image
                                        </button>
                                        <input type="file" id="pfpFileInput" accept="image/*" style="display: none;">
                                        <p class="text-xs text-gray-500 mt-1">Max size: 2MB. Images are cropped to square.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="pfpMessage" class="general-message-area text-sm"></div>
                    </div>

                    <!-- THEME SECTION -->
                    <h3 class="text-xl font-bold text-white mb-2">Navigation Bar Theme</h3>
                    <div id="themeSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Select a theme for your navigation bar. This setting is saved locally and will apply a live preview.
                        </p>
                        
                        <div id="theme-picker-container">
                            <div class="flex items-center justify-center p-8">
                                <i class="fa-solid fa-spinner fa-spin fa-2x text-gray-500"></i>
                            </div>
                        </div>
                        
                        <div id="themeMessage" class="general-message-area text-sm"></div>
                    </div>
                </div>
             `;
        }
        
        // --- NEW: Generates the HTML for the "Data Management" section ---
        function getDataManagementContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Data Management</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Export Data</h3>
                    <div class="settings-box transition-all duration-300 p-4 mb-8">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Export all your local game data (from LocalStorage and IndexedDB) into a single JSON file.
                            This file can be used as a backup or to transfer your data to another browser.
                        </p>
                        <button id="exportDataBtn" class="btn-toolbar-style btn-primary-override w-48">
                            <i class="fa-solid fa-download mr-2"></i> Export Data
                        </button>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Import Data</h3>
                    <div class="settings-box transition-all duration-300 p-4 bg-red-900/10 border-red-700/50">
                        <p class="text-sm font-light text-red-300 mb-4">
                            <i class="fa-solid fa-triangle-exclamation mr-1"></i> 
                            **WARNING:** Importing data will overwrite all existing local game data. This action cannot be undone.
                            Only import a file you have previously exported from this site.
                        </p>
                        <button id="importDataBtn" class="btn-toolbar-style btn-primary-override-danger w-48">
                            <i class="fa-solid fa-upload mr-2"></i> Import Data
                        </button>
                    </div>
                </div>
            `;
        }


        /**
         * Generates the HTML for the "About 4SP" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-4">About 4SP (4simpleproblems)</h2>
                
                <div class="about-section-content">
                    <p class="text-lg text-gray-400 leading-relaxed">
                        <span class="text-emphasis">4SP (4simpleproblems)</span> is a <span class="text-emphasis">Student Toolkit and Entertainment website</span> designed to boost student productivity and provide useful resources. We aim to solve four core challenges that students face every day by integrating essential tools and engaging digital content into one seamless platform.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">The Four Simple Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>

                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">Version</h3>
                    <p class="text-gray-400">
                        Current Version: <span class="text-blue-400 text-emphasis">5.0 Beta 9</span>
                    </p>

                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Connect & Support</h3>
                    <div class="social-link-group">
                        <a href="https://www.youtube.com/@4simpleproblems" target="_blank" class="btn-toolbar-style" title="YouTube">
                            <i class="fa-brands fa-youtube fa-lg mr-2"></i> YouTube
                        </a>
                        <a href="https://x.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="X (Twitter)">
                            <i class="fa-brands fa-x-twitter fa-lg mr-2"></i>X
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="Buy Me a Coffee">
                            <i class="fa-solid fa-mug-hot fa-lg mr-2"></i> Buy Me a Coffee
                        </a>
                        <a href="https://github.com/v5-4simpleproblems" target="_blank" class="btn-toolbar-style" title="GitHub">
                            <i class="fa-brands fa-github fa-lg mr-2"></i> Github
                        </a>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Legal Information</h3>
                    <div class="legal-buttons">
                        <a href="../legal.html#terms-of-service" class="btn-toolbar-style">Terms of Service</a>
                        <a href="../legal.html#privacy-policy" class="btn-toolbar-style">Privacy Policy</a>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "Coming Soon" sections.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-2">${title}</h2>
                <div style="flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%;">
                    <p class="text-xl text-gray-500 italic">...Coming Soon...</p>
                    <i class="fa-solid fa-hourglass-start fa-5x text-gray-700 mt-4"></i>
                </div>
            `;
        }
        
        // Helper for refreshing the General Tab
        const refreshGeneralTab = () => {
            // Clear the current view state and re-render the General tab
            // This is necessary because currentUser.providerData needs to be fresh
            switchTab('general');
        };

        // --- Utility: Custom Dropdown Setup ---
        function setupCustomDropdown(selectElement, onChangeCallback) {
            // Hide original select
            selectElement.style.display = 'none';
            
            // Create wrapper
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-select-wrapper';
            selectElement.parentNode.insertBefore(wrapper, selectElement);
            wrapper.appendChild(selectElement);
            
            // Create custom structure
            const customSelect = document.createElement('div');
            customSelect.className = 'custom-select';
            
            const trigger = document.createElement('div');
            trigger.className = 'custom-select-trigger';
            
            // Get initial text
            const selectedOption = selectElement.options[selectElement.selectedIndex];
            const initialText = selectedOption ? selectedOption.textContent : 'Select...';
            
            trigger.innerHTML = `<span>${initialText}</span><div class="arrow"></div>`;
            
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'custom-options';
            
            // Populate options
            Array.from(selectElement.options).forEach(option => {
                const customOption = document.createElement('div');
                customOption.className = 'custom-option' + (option.selected ? ' selected' : '');
                customOption.dataset.value = option.value;
                customOption.textContent = option.textContent;
                
                customOption.addEventListener('click', function() {
                    // Update Trigger Text
                    trigger.querySelector('span').textContent = this.textContent;
                    
                    // Update Classes
                    customSelect.classList.remove('open');
                    optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    // Update Original Select
                    selectElement.value = this.dataset.value;
                    
                    // Trigger Callback
                    if (onChangeCallback) onChangeCallback(this.dataset.value);
                });
                
                optionsContainer.appendChild(customOption);
            });
            
            customSelect.appendChild(trigger);
            customSelect.appendChild(optionsContainer);
            wrapper.appendChild(customSelect);
            
            // Trigger Event
            trigger.addEventListener('click', function() {
                customSelect.classList.toggle('open');
            });
            
            // Close when clicking outside
            window.addEventListener('click', function(e) {
                if (!customSelect.contains(e.target)) {
                    customSelect.classList.remove('open');
                }
            });
            
            // Return an update function to refresh options dynamically
            return {
                refresh: () => {
                    // Clear existing options
                    optionsContainer.innerHTML = '';
                    // Re-populate
                    Array.from(selectElement.options).forEach(option => {
                        const customOption = document.createElement('div');
                        customOption.className = 'custom-option' + (option.selected ? ' selected' : '');
                        customOption.dataset.value = option.value;
                        customOption.textContent = option.textContent;
                        
                        if (option.selected) {
                             trigger.querySelector('span').textContent = option.textContent;
                        }

                        customOption.addEventListener('click', function() {
                            trigger.querySelector('span').textContent = this.textContent;
                            customSelect.classList.remove('open');
                            optionsContainer.querySelectorAll('.custom-option').forEach(opt => opt.classList.remove('selected'));
                            this.classList.add('selected');
                            selectElement.value = this.dataset.value;
                            if (onChangeCallback) onChangeCallback(this.dataset.value);
                        });
                        optionsContainer.appendChild(customOption);
                    });
                },
                // Helper to manually select value programmatically
                setValue: (value) => {
                    const optionToSelect = Array.from(selectElement.options).find(opt => opt.value === value);
                    if (optionToSelect) {
                        selectElement.value = value;
                        trigger.querySelector('span').textContent = optionToSelect.textContent;
                        optionsContainer.querySelectorAll('.custom-option').forEach(opt => {
                            if (opt.dataset.value === value) opt.classList.add('selected');
                            else opt.classList.remove('selected');
                        });
                    }
                }
            };
        }

        /**
         * Loads user data, checks rate limit, and renders the General tab.
         */
        async function loadGeneralTab() {
            if (!currentUser) return; 

            // Check if user is using email/password authentication (providerId 'password')
            const isEmailPasswordUser = currentUser.providerData.some(
                (info) => info.providerId === 'password'
            );
            
            const userDocRef = getUserDocRef(currentUser.uid);
            let userDocSnap = await getDoc(userDocRef);

            if (!userDocSnap.exists()) {
                mainView.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">General Settings</h2><p class="text-red-400">Error: User data not found. Please log out and back in.</p>`;
                return;
            }

            let userData = userDocSnap.data();
            const today = new Date();
            const currentMonthNumber = today.getMonth() + 1; 
            const currentMonthName = today.toLocaleDateString('en-US', { month: 'long' }); 
            
            let changesThisMonth = userData.usernameChangesThisMonth || 0;
            let lastChangeMonth = userData.lastUsernameChangeMonth || 0;

            // --- Monthly Reset Logic ---
            if (currentMonthNumber !== lastChangeMonth) {
                changesThisMonth = 0;
                await updateDoc(userDocRef, {
                    usernameChangesThisMonth: 0,
                    lastUsernameChangeMonth: currentMonthNumber
                });
                userDocSnap = await getDoc(userDocRef);
                userData = userDocSnap.data(); 
            }
            
            const changesRemaining = MAX_CHANGES - changesThisMonth;

            // 1. Render the General Content
            mainView.innerHTML = getGeneralContent(
                userData.username, 
                changesRemaining, 
                changesThisMonth, 
                currentMonthName,
                isEmailPasswordUser, 
                currentUser.providerData // Pass provider info
            );
            
            // 2. Element References (Username Section)
            const viewMode = document.getElementById('viewMode');
            const editMode = document.getElementById('editMode');
            const enterEditModeBtn = document.getElementById('enterEditModeBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const applyUsernameBtn = document.getElementById('applyUsernameBtn');
            const newUsernameInput = document.getElementById('newUsernameInput');
            const messageElement = document.getElementById('usernameChangeMessage');
            const charCountElement = document.getElementById('charCount');
            const minLengthElement = document.getElementById('minLength');
            const maxLengthElement = document.getElementById('maxLength');

            // --- Username UI State Management Functions ---
            const setEditMode = (isEditing) => {
                showMessage(messageElement, '', 'success'); // Clear message
                
                if (isEditing) {
                    if (changesRemaining <= 0) {
                        showMessage(messageElement, `You have reached your limit of ${MAX_CHANGES} username changes for the current month.`, 'error'); 
                        return;
                    }
                    viewMode.classList.add('hidden');
                    editMode.classList.remove('hidden');
                    newUsernameInput.focus();
                    updateCounterAndValidation(); 
                } else {
                    editMode.classList.add('hidden');
                    viewMode.classList.remove('hidden');
                    newUsernameInput.value = userData.username; // Reset input value
                    applyUsernameBtn.disabled = true;
                }
            };

            const updateCounterAndValidation = () => {
                const newUsername = newUsernameInput.value.trim();
                const count = newUsername.length;
                
                charCountElement.textContent = count;
                
                const isValidLength = count >= MIN_LENGTH && count <= MAX_LENGTH;
                const isChanged = newUsername !== userData.username;
                
                // 1. Update counter colors
                minLengthElement.classList.toggle('text-red-400', count < MIN_LENGTH);
                maxLengthElement.classList.toggle('text-red-400', count > MAX_LENGTH);
                
                minLengthElement.classList.toggle('text-gray-400', count >= MIN_LENGTH);
                maxLengthElement.classList.toggle('text-gray-400', count <= MAX_LENGTH);
                
                charCountElement.classList.toggle('text-red-400', !isValidLength);
                charCountElement.classList.toggle('text-gray-400', isValidLength);


                // 2. Update button state
                applyUsernameBtn.disabled = !isChanged || !isValidLength || changesRemaining <= 0;
            };

            // --- Username Event Listeners ---
            enterEditModeBtn.addEventListener('click', () => setEditMode(true));
            cancelEditBtn.addEventListener('click', () => setEditMode(false));
            newUsernameInput.addEventListener('input', updateCounterAndValidation);


            applyUsernameBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const newUsername = newUsernameInput.value.trim();
                
                if (applyUsernameBtn.disabled || changesRemaining <= 0) {
                    showMessage(messageElement, 'Cannot apply changes due to validation errors, rate limit, or no change was made.', 'error');
                    return;
                }

                applyUsernameBtn.disabled = true;
                showMessage(messageElement, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Checking availability and profanity...', 'warning');

                try {
                    // --- Validation ---
                    if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) { 
                        showMessage(messageElement, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error'); 
                        return; 
                    }
                    if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(newUsername)) { 
                        showMessage(messageElement, 'Username contains invalid characters (Allowed symbols: .,-+\\_!?$).', 'error'); 
                        return; 
                    }
                    
                    // --- Checks ---
                    if (await checkProfanity(newUsername)) { 
                        showMessage(messageElement, 'This username is not allowed (Profanity filter triggered).', 'error'); 
                        return; 
                    }
                    if (await isUsernameTaken(newUsername)) { 
                        showMessage(messageElement, 'This username is already taken.', 'error'); 
                        return; 
                    }
                    
                    // --- Update Logic ---
                    const newChangesCount = changesThisMonth + 1;
                    await updateDoc(userDocRef, {
                        username: newUsername,
                        usernameChangesThisMonth: newChangesCount,
                        lastUsernameChangeMonth: currentMonthNumber 
                    });

                    showMessage(messageElement, `Username successfully changed to ${newUsername}!`, 'success');
                    
                    // Re-render the tab content to update the display, counter, and state
                    setTimeout(() => { switchTab('general'); }, 1500);

                } catch (error) {
                    console.error("Error updating username:", error);
                    showMessage(messageElement, `An unexpected error occurred: ${error.message}`, 'error');
                } finally {
                    if (messageElement.innerHTML.includes('Error') || messageElement.innerHTML.includes('not allowed') || messageElement.innerHTML.includes('taken')) {
                        applyUsernameBtn.disabled = false;
                    }
                }
            });
            
            
            // =================================================================
            // --- PASSWORD CHANGE LOGIC (Conditional) ---
            // =================================================================
            if (isEmailPasswordUser) {
                const currentPasswordInput = document.getElementById('currentPasswordInput');
                const newPasswordInput = document.getElementById('newPasswordInput');
                const confirmPasswordInput = document.getElementById('confirmPasswordInput');
                const applyPasswordBtn = document.getElementById('applyPasswordBtn');
                const passwordMessage = document.getElementById('passwordMessage');
                
                // Input handler for enabling/disabling apply button
                const checkPasswordFields = () => {
                    const currentPass = currentPasswordInput.value;
                    const newPass = newPasswordInput.value;
                    const confirmPass = confirmPasswordInput.value;
                    
                    const MIN_PASS_LENGTH = 6;
                    
                    const isLengthValid = newPass.length >= MIN_PASS_LENGTH;
                    const isMatch = newPass === confirmPass;
                    const isCurrentProvided = currentPass.length > 0;
                    
                    // Enable if all requirements are met
                    applyPasswordBtn.disabled = !(isLengthValid && isMatch && isCurrentProvided);
                    
                    // Provide gentle feedback
                    showMessage(passwordMessage, '', 'success');
                    if (newPass.length > 0 && newPass.length < MIN_PASS_LENGTH) {
                        showMessage(passwordMessage, `New password must be at least ${MIN_PASS_LENGTH} characters.`, 'warning');
                    } else if (newPass.length >= MIN_PASS_LENGTH && confirmPass.length > 0 && newPass !== confirmPass) {
                         showMessage(passwordMessage, 'New and confirmation passwords do not match.', 'warning');
                    } else if (newPass === currentPass && isLengthValid && isMatch) {
                         showMessage(passwordMessage, 'New password cannot be the same as your current password.', 'warning');
                         applyPasswordBtn.disabled = true;
                    }
                };

                currentPasswordInput.addEventListener('input', checkPasswordFields);
                newPasswordInput.addEventListener('input', checkPasswordFields);
                confirmPasswordInput.addEventListener('input', checkPasswordFields);
                
                applyPasswordBtn.addEventListener('click', async () => {
                    applyPasswordBtn.disabled = true;
                    showMessage(passwordMessage, '', 'success'); // Clear prior message
                    showMessage(passwordMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Attempting password change...', 'warning');

                    const currentPass = currentPasswordInput.value;
                    const newPass = newPasswordInput.value;
                    
                    if (newPass.length < 6) {
                         showMessage(passwordMessage, 'New password must be at least 6 characters.', 'error');
                         applyPasswordBtn.disabled = false;
                         return;
                    }
                    if (newPass === currentPass) {
                        showMessage(passwordMessage, 'New password cannot be the same as your current password.', 'error');
                        applyPasswordBtn.disabled = false;
                        return;
                    }

                    try {
                        // 1. Re-authenticate the user
                        const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
                        await reauthenticateWithCredential(currentUser, credential);

                        // 2. Update the password
                        await updatePassword(currentUser, newPass);

                        showMessage(passwordMessage, 'Password successfully updated!', 'success');
                        
                        // Clear fields on success
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmPasswordInput.value = '';
                        // Re-check fields to disable the button
                        checkPasswordFields(); 

                    } catch (error) {
                        console.error("Error changing password:", error);
                        let errorMessage = "An unknown error occurred.";
                        
                        switch (error.code) {
                            case 'auth/requires-recent-login':
                                errorMessage = 'Password change failed. Please sign out and sign in again to change your password.';
                                break;
                            case 'auth/wrong-password':
                                errorMessage = 'The current password you provided is incorrect.';
                                break;
                            case 'auth/weak-password':
                                errorMessage = 'The new password is too weak. Please use a stronger one (min 6 characters).';
                                break;
                            default:
                                errorMessage = `Password change failed. (${error.message})`;
                        }
                        showMessage(passwordMessage, errorMessage, 'error');
                    } finally {
                        // Re-enable button if there was an error
                        if (!passwordMessage.innerHTML.includes('success')) {
                            applyPasswordBtn.disabled = false;
                        }
                    }
                });
            }
            
            // =================================================================
            // --- LINKING / UNLINKING PROVIDERS LOGIC (NEW) ---
            // =================================================================

            const linkProviderButtons = mainView.querySelectorAll('button[data-action="link"]');
            const unlinkProviderButtons = mainView.querySelectorAll('button[data-action="unlink"]');

            // --- LINKING Providers ---
            linkProviderButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const providerId = button.dataset.providerId;
                    const config = PROVIDER_CONFIG[providerId];
                    const providerInstance = config.instance();
                    
                    showMessage(messageElement, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Attempting to link with ${config.name}...`, 'warning');
                    
                    try {
                        await linkWithPopup(auth.currentUser, providerInstance);
                        showMessage(messageElement, `${config.name} successfully linked to your account!`, 'success');
                        setTimeout(refreshGeneralTab, 1500); // Refresh UI
                    } catch (error) {
                        console.error("Error linking provider:", error);
                        let msg = `Failed to link ${config.name}.`;
                        if (error.code === 'auth/credential-already-in-use') {
                            msg = `This ${config.name} account is already linked to another user.`;
                        } else if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Link cancelled by user.';
                        } else if (error.code === 'auth/requires-recent-login') {
                            msg = 'Please sign out and sign in again to link a new provider.';
                        }
                        showMessage(messageElement, msg, 'error');
                    }
                });
            });

            // --- UNLINKING Providers ---
            unlinkProviderButtons.forEach(button => {
                button.addEventListener('click', async () => {
                    const providerId = button.dataset.providerId;
                    const config = PROVIDER_CONFIG[providerId];
                    
                    showMessage(messageElement, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Unlinking ${config.name}...`, 'warning');
                    
                    try {
                        await unlink(auth.currentUser, providerId);
                        showMessage(messageElement, `${config.name} successfully unlinked.`, 'success');
                        setTimeout(refreshGeneralTab, 1500); // Refresh UI
                    } catch (error) {
                        console.error("Error unlinking provider:", error);
                        let msg = `Failed to unlink ${config.name}.`;
                        if (error.code === 'auth/no-such-provider') {
                            msg = 'Provider not found on this account.';
                        } else if (error.code === 'auth/requires-recent-login') {
                             msg = 'Please sign out and sign in again to unlink this provider.';
                        } else if (error.code === 'auth/provider-already-linked') {
                            // This can happen if attempting to unlink the last provider
                            msg = "Cannot unlink the last remaining sign-in method.";
                        }
                        
                        showMessage(messageElement, msg, 'error');
                    }
                });
            });

            // =================================================================
            // --- ACCOUNT DELETION LOGIC (NEW) ---
            // =================================================================
            const deletePasswordInput = document.getElementById('deletePasswordInput');
            const deleteConfirmText = document.getElementById('deleteConfirmText');
            const reauthenticateBtn = document.getElementById('reauthenticateBtn');
            const finalDeleteBtn = document.getElementById('finalDeleteBtn');
            const deleteMessage = document.getElementById('deleteMessage');
            const primaryProviderId = currentUser.providerData[0].providerId;


            const performAccountDeletion = async () => {
                showMessage(deleteMessage, '', 'success');
                showMessage(deleteMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Deleting account...', 'warning');

                try {
                    // Delete user's Firestore document first (to prevent orphaned data)
                    await deleteDoc(userDocRef); 
                    
                    // Delete Firebase Auth user
                    await deleteUser(auth.currentUser);

                    // Sign out and redirect to authentication page
                    await signOut(auth);
                    window.location.href = '../authentication.html';

                } catch (error) {
                    console.error("Error deleting account:", error);
                    let msg = "Failed to delete account. Please try again or sign in again.";
                    if (error.code === 'auth/requires-recent-login') {
                        msg = 'Deletion failed: Please sign out and sign in again immediately to proceed with deletion.';
                    }
                    showMessage(deleteMessage, msg, 'error');
                    // Re-enable/reset UI elements
                    if (reauthenticateBtn) reauthenticateBtn.classList.remove('hidden');
                    if (finalDeleteBtn) finalDeleteBtn.classList.add('hidden');
                }
            };


            // --- Email/Password Primary Deletion Logic ---
            if (primaryProviderId === 'password' && deletePasswordInput) {
                const checkDeletionInputs = () => {
                    const passwordMatch = deletePasswordInput.value.length > 0;
                    const textConfirmed = deleteConfirmText.value.trim().toLowerCase() === 'delete my account';
                    
                    finalDeleteBtn.disabled = !(passwordMatch && textConfirmed);
                };

                deletePasswordInput.addEventListener('input', checkDeletionInputs);
                deleteConfirmText.addEventListener('input', checkDeletionInputs);
                
                finalDeleteBtn.addEventListener('click', async () => {
                    if (finalDeleteBtn.disabled) return;
                    
                    finalDeleteBtn.disabled = true;
                    showMessage(deleteMessage, '', 'success');
                    showMessage(deleteMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating...', 'warning');
                    
                    try {
                        // Re-authenticate using email/password credential
                        const credential = EmailAuthProvider.credential(auth.currentUser.email, deletePasswordInput.value);
                        await reauthenticateWithCredential(auth.currentUser, credential);

                        // If re-auth is successful, proceed to final deletion
                        await performAccountDeletion();

                    } catch (error) {
                        console.error("Error during password re-authentication for deletion:", error);
                        let msg = 'Re-authentication failed. Incorrect password.';
                        if (error.code === 'auth/requires-recent-login') {
                             msg = 'Please sign out and sign in again immediately to proceed with deletion.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                        finalDeleteBtn.disabled = false;
                    }
                });
            } 
            // --- Social Provider Primary Deletion Logic ---
            else if (reauthenticateBtn) {
                
                reauthenticateBtn.addEventListener('click', async () => {
                    const providerInstance = PROVIDER_CONFIG[primaryProviderId].instance();
                    
                    reauthenticateBtn.disabled = true;
                    showMessage(deleteMessage, '', 'success');
                    showMessage(deleteMessage, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Re-authenticating with ${PROVIDER_CONFIG[primaryProviderId].name}...`, 'warning');
                    
                    try {
                        // Re-authenticate using the social provider popup
                        await reauthenticateWithPopup(auth.currentUser, providerInstance);
                        
                        // Re-authentication successful: change button to final delete button
                        reauthenticateBtn.classList.add('hidden');
                        finalDeleteBtn.classList.remove('hidden');
                        showMessage(deleteMessage, 'Authentication successful. Click "Delete Account" one last time to confirm.', 'success');

                    } catch (error) {
                        console.error("Error during social re-authentication for deletion:", error);
                        let msg = 'Re-authentication failed. Please try again.';
                         if (error.code === 'auth/popup-closed-by-user') {
                            msg = 'Re-authentication cancelled by user.';
                        } else if (error.code === 'auth/requires-recent-login') {
                             msg = 'Please sign out and sign in again immediately to proceed with deletion.';
                        }
                        showMessage(deleteMessage, msg, 'error');
                        reauthenticateBtn.disabled = false;
                    }
                    if (reauthenticateBtn.classList.contains('hidden') === false) {
                        reauthenticateBtn.disabled = false;
                    }
                });
                
                // Final Delete button click
                finalDeleteBtn.addEventListener('click', performAccountDeletion);
            }
        }
        
        /**
         * NEW: Loads data and adds event listeners for the Privacy tab.
         */
        async function loadPrivacyTab() {
            // --- 1. Get Element References ---
            // Panic Key
            const panicKeyInputs = document.querySelectorAll('.panic-key-input');
            const panicUrl1 = document.getElementById('panicUrl1');
            const panicUrl2 = document.getElementById('panicUrl2');
            const panicUrl3 = document.getElementById('panicUrl3');
            const applyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
            const panicKeyMessage = document.getElementById('panicKeyMessage');
            
            // URL Changer
            const modeSelect = document.getElementById('tabDisguiseMode');
            const presetGroup = document.getElementById('tabDisguisePresetGroup');
            const presetSelect = document.getElementById('tabDisguisePreset');
            const customGroup = document.getElementById('tabDisguiseCustomGroup');
            const customTitle = document.getElementById('customTabTitle');
            const applyUrlChangerBtn = document.getElementById('applyUrlChangerBtn');
            const urlChangerMessage = document.getElementById('urlChangerMessage');
            
            // NEW Favicon Fetcher Elements
            const faviconFetchInput = document.getElementById('faviconFetchInput');
            const fetchFaviconBtn = document.getElementById('fetchFaviconBtn');
            const previewContainer = document.getElementById('favicon-fetch-preview-container');
            const previewImg = previewContainer.querySelector('img');

            // --- Initialize Custom Dropdowns ---
            const modeDropdown = setupCustomDropdown(modeSelect, (value) => {
                presetGroup.classList.toggle('hidden', value !== 'preset');
                customGroup.classList.toggle('hidden', value !== 'custom');
            });
            
            const presetDropdown = setupCustomDropdown(presetSelect, null);

            
            // --- 2. Load Panic Key Settings ---
            try {
                const settingsMap = await getPanicKeySettings();
                const key1 = settingsMap.get('panicKey1');
                const key2 = settingsMap.get('panicKey2');
                const key3 = settingsMap.get('panicKey3');

                if (key1) {
                    document.getElementById('panicKey1').value = key1.key || '';
                    panicUrl1.value = key1.url || '';
                }
                if (key2) {
                    document.getElementById('panicKey2').value = key2.key || '';
                    panicUrl2.value = key2.url || '';
                }
                if (key3) {
                    document.getElementById('panicKey3').value = key3.key || '';
                    panicUrl3.value = key3.url || '';
                }
            } catch (e) {
                console.error("Error loading panic key settings:", e);
                showMessage(panicKeyMessage, 'Error loading panic key settings.', 'error');
            }
            
            // --- 3. Load URL Changer Settings ---
            const savedUrlSettings = getSavedUrlChangerSetting();
            
            // Set values and update UI
            if (savedUrlSettings.type) {
                modeDropdown.setValue(savedUrlSettings.type);
                // Manually trigger visibility logic
                presetGroup.classList.toggle('hidden', savedUrlSettings.type !== 'preset');
                customGroup.classList.toggle('hidden', savedUrlSettings.type !== 'custom');
            }

            if (savedUrlSettings.type === 'preset' && savedUrlSettings.id) {
                presetDropdown.setValue(savedUrlSettings.id);
            } else if (savedUrlSettings.type === 'custom') {
                customTitle.value = savedUrlSettings.title || '';
                
                // NEW logic to load saved custom favicon into the preview
                if (savedUrlSettings.favicon) {
                    previewImg.src = savedUrlSettings.favicon;
                    previewImg.style.display = 'block';
                }
            }

            // --- 4. Add Event Listeners ---
            
            // Panic Key Input Validation (Whitelist)
            const validKeyRegex = /^[a-z0-9`\-=\[\]\\;',\.\/]$/;
            panicKeyInputs.forEach(input => {
                input.addEventListener('keydown', e => {
                    // Allow control keys like Tab, Backspace, Arrow keys
                    if (e.key.length > 1 && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' && e.key !== 'Tab') {
                        e.preventDefault();
                        return;
                    }
                    
                    const lowerKey = e.key.toLowerCase();
                    
                    if (lowerKey.length === 1 && !validKeyRegex.test(lowerKey)) {
                         e.preventDefault(); // Block invalid key
                         showMessage(panicKeyMessage, `Invalid key. Only a-z, 0-9, and \` - = [ ] \\ ; ' , . / are allowed.`, 'warning');
                    } else if (lowerKey.length === 1) {
                        e.preventDefault(); // Prevent typing
                        input.value = lowerKey; // Set value
                        showMessage(panicKeyMessage, '', 'success'); // Clear message
                    }
                });
            });

            // Panic Key Apply Button
            applyPanicKeyBtn.addEventListener('click', async () => {
                showMessage(panicKeyMessage, '', 'success');
                const keys = [
                    document.getElementById('panicKey1').value,
                    document.getElementById('panicKey2').value,
                    document.getElementById('panicKey3').value
                ];
                const urls = [
                    panicUrl1.value,
                    panicUrl2.value,
                    panicUrl3.value
                ];
                
                const settingsToSave = [];
                let hasError = false;

                for (let i = 0; i < 3; i++) {
                    const key = keys[i];
                    let url = urls[i]; // Make it 'let'
                    const id = `panicKey${i + 1}`;
                    
                    // If either is blank, skip (or save as empty)
                    if (!key && !url) {
                         settingsToSave.push({ id, key: '', url: '' });
                        continue;
                    }
                    
                    // If one is filled but not the other
                    if ( (key && !url) || (!key && url) ) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} is incomplete. Both key and URL must be filled, or both must be empty.`, 'error');
                        hasError = true;
                        break;
                    }

                    // NEW: Check for relative paths and block them to avoid confusion
                    if (url.startsWith('/') || url.startsWith('../') || url.startsWith('./')) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} must be a full web address (e.g., google.com), not a relative path.`, 'error');
                        hasError = true;
                        break;
                    }

                    // NEW: Prepend https:// if it's missing
                    if (!url.startsWith('https://') && !url.startsWith('http://')) {
                        url = 'https://' + url;
                    }

                    // NEW: Validate URL
                    try {
                        new URL(url); // This will validate "https://google.com" and "https://youtube.com/page.html"
                    } catch (e) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} has an invalid URL. Please enter a valid web address (e.g., google.com).`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // Add valid setting
                    settingsToSave.push({ id, key, url }); // Push the (potentially modified) URL
                }

                if (hasError) return;

                // Check for duplicate keys
                const filledKeys = settingsToSave.map(s => s.key).filter(k => k);
                if (new Set(filledKeys).size !== filledKeys.length) {
                    showMessage(panicKeyMessage, 'Duplicate panic keys found. Each key must be unique.', 'error');
                    return;
                }
                
                // Save to IndexedDB
                try {
                    applyPanicKeyBtn.disabled = true;
                    showMessage(panicKeyMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...', 'warning');
                    await savePanicKeySettings(settingsToSave);
                    showMessage(panicKeyMessage, 'Panic key settings saved successfully!', 'success');
                    
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000); 

                } catch (e) {
                    console.error("Error saving panic key settings:", e);
                    showMessage(panicKeyMessage, 'An error occurred while saving.', 'error');
                } finally {
                    applyPanicKeyBtn.disabled = false;
                }
            });

            // Mode Select Event Removed - Handled by setupCustomDropdown callback

            // NEW: Favicon Fetcher Button
            fetchFaviconBtn.addEventListener('click', async () => {
                let domain = faviconFetchInput.value.trim();
                if (!domain) {
                    showMessage(urlChangerMessage, 'Please enter a domain to fetch from.', 'warning');
                    return;
                }
                if (!domain.startsWith('http')) {
                    domain = 'https://' + domain;
                }

                fetchFaviconBtn.disabled = true;
                fetchFaviconBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
                showMessage(urlChangerMessage, 'Fetching favicon...', 'warning');

                try {
                    if (typeof urlChanger === 'undefined' || !urlChanger.fetchFavicon) {
                        throw new Error("URL Changer script not loaded correctly.");
                    }
                    
                    const faviconUrl = await urlChanger.fetchFavicon(domain);
                    
                    // Show preview
                    previewImg.src = faviconUrl;
                    previewImg.style.display = 'block';
                    
                    showMessage(urlChangerMessage, 'Favicon found and set as preview.', 'success');
                    
                } catch (error) {
                    console.error("Error fetching favicon:", error);
                    showMessage(urlChangerMessage, `Failed to find favicon: ${error.message}`, 'error');
                    previewImg.src = '';
                    previewImg.style.display = 'none';
                } finally {
                    fetchFaviconBtn.disabled = false;
                    fetchFaviconBtn.textContent = 'Fetch';
                }
            });

            // URL Changer Apply Button
            applyUrlChangerBtn.addEventListener('click', () => {
                const mode = modeSelect.value;
                let settingsToSave = { type: 'none' };
                
                if (mode === 'preset') {
                    const presetId = presetSelect.value;
                    if (!presetId) {
                         showMessage(urlChangerMessage, 'Please select a preset.', 'error');
                         return;
                    }
                    settingsToSave = { type: 'preset', id: presetId };
                } 
                else if (mode === 'custom') {
                    const title = customTitle.value.trim();
                    // NEW: Get favicon from preview image
                    const favicon = (previewImg.src && previewImg.style.display !== 'none') ? previewImg.src : '';
                    
                    if (!title && !favicon) { // Check against new favicon variable
                         showMessage(urlChangerMessage, 'Please provide at least a custom title or fetch a favicon.', 'error'); // Update message
                        return;
                    }
                    settingsToSave = { type: 'custom', title: title, favicon: favicon }; // Use new favicon variable
                }
                
                // Save to localStorage
                if (saveUrlChangerSetting(settingsToSave)) {
                    showMessage(urlChangerMessage, 'Tab Disguise settings saved! They will be applied on the next page you load.', 'success');
                    
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000); 
                    
                } else {
                    showMessage(urlChangerMessage, 'An error occurred while saving.', 'error');
                }
            });
        }
        
        
        /**
         * NEW: Loads data and adds event listeners for the Personalization tab.
         */
        async function loadPersonalizationTab() {
            const themePickerContainer = document.getElementById('theme-picker-container');
            const themeMessage = document.getElementById('themeMessage');
            const pfpMessage = document.getElementById('pfpMessage'); 
            
            // --- 1. PROFILE PICTURE LOGIC ---
            if (currentUser) {
                const userDocRef = getUserDocRef(currentUser.uid);
                let userData = {};
                try {
                    const snap = await getDoc(userDocRef);
                    if (snap.exists()) userData = snap.data();
                } catch (e) { console.error("Error fetching PFP settings:", e); }

                const currentPfpType = userData.pfpType || 'google';
                const pfpModeSelect = document.getElementById('pfpModeSelect');
                const letterSettings = document.getElementById('pfpLetterSettings');
                const customSettings = document.getElementById('pfpCustomSettings');
                const previewImg = document.getElementById('customPfpPreview');
                const previewPlaceholder = document.getElementById('customPfpPlaceholder');
                
                // Letter inputs
                const letterInput = document.getElementById('pfpLetterInput');
                const saveLetterTextBtn = document.getElementById('saveLetterTextBtn');

                // --- CONDITIONAL GOOGLE OPTION ---
                const hasGoogle = currentUser.providerData.some(p => p.providerId === 'google.com');
                if (!hasGoogle) {
                    const googleOption = Array.from(pfpModeSelect.options).find(opt => opt.value === 'google');
                    if (googleOption) {
                        googleOption.remove();
                    }
                    // If current selection was google (shouldn't happen for new non-google users but possible for legacy), default to letter
                    if (currentPfpType === 'google') {
                        // Wait, we can't update userData here easily without potentially overwriting.
                        // Just let the UI default to the first available option or handle visually.
                    }
                }

                // Function to dispatch instant update event
                const triggerNavbarUpdate = () => {
                    window.dispatchEvent(new CustomEvent('pfp-updated', { 
                        detail: { 
                            pfpType: userData.pfpType, 
                            customPfp: userData.customPfp, 
                            pfpLetterBg: userData.pfpLetterBg,
                            pfpLetters: userData.pfpLetters
                        }
                    }));
                };

                // Function to update UI visibility and the letter avatar preview
                const updatePfpUi = (type) => {
                    letterSettings.classList.toggle('hidden', type !== 'letter');
                    customSettings.classList.toggle('hidden', type !== 'custom');

                    // Update letter avatar preview
                    if (type === 'letter') {
                        const letterText = (userData.pfpLetters || (currentUser?.displayName ? currentUser.displayName.charAt(0) : '')).toUpperCase();
                        const letterBg = userData.pfpLetterBg || 'linear-gradient(135deg, #374151 0%, #111827 100%)';
                        const letterColor = window.pfpColorUtils.getLetterAvatarTextColor(letterBg);
                        const fontSizeClass = letterText.length >= 3 ? 'text-xs' : (letterText.length === 2 ? 'text-sm' : 'text-base');
                        
                        customPfpPlaceholder.textContent = letterText;
                        customPfpPlaceholder.style.background = letterBg;
                        customPfpPlaceholder.style.color = letterColor;
                        customPfpPlaceholder.className = `w-full h-full flex items-center justify-center text-gray-600 font-semibold ${fontSizeClass}`;
                        customPfpPreview.style.display = 'none';
                        customPfpPlaceholder.style.display = 'flex';
                    } else if (type === 'custom' && userData.customPfp) {
                        customPfpPreview.src = userData.customPfp;
                        customPfpPreview.style.display = 'block';
                        customPfpPlaceholder.style.display = 'none';
                    } else {
                        // Default/Google or no custom/letter set
                        customPfpPreview.style.display = 'none';
                        // For Google or empty, show generic user icon
                        customPfpPlaceholder.style.display = 'flex';
                        customPfpPlaceholder.className = `w-full h-full flex items-center justify-center text-gray-600`;
                        customPfpPlaceholder.innerHTML = '<i class="fa-solid fa-user"></i>'; // Reset to default icon
                        customPfpPlaceholder.style.background = ''; // Clear custom background
                        customPfpPlaceholder.style.color = ''; // Clear custom color
                    }
                };

                // Init Custom Dropdown
                const pfpDropdown = setupCustomDropdown(pfpModeSelect, async (type) => {
                    updatePfpUi(type);
                    // Auto-save type change
                    try {
                        await updateDoc(userDocRef, { pfpType: type });
                        userData.pfpType = type; // Update local state
                        triggerNavbarUpdate();
                        showMessage(pfpMessage, 'Preference saved!', 'success');
                    } catch (e) {
                        showMessage(pfpMessage, 'Error saving preference.', 'error');
                    }
                });

                // Init UI with current value
                // Ensure value is valid (e.g. if google was selected but removed)
                let validPfpType = currentPfpType;
                if (!hasGoogle && currentPfpType === 'google') {
                    validPfpType = 'letter'; // Fallback
                }
                pfpDropdown.setValue(validPfpType);
                updatePfpUi(validPfpType);
                

                // --- Letter Logic ---
                // Load existing letters
                if (userData.pfpLetters) {
                    letterInput.value = userData.pfpLetters;
                } else {
                    letterInput.value = userData.username ? userData.username.substring(0, 1).toUpperCase() : '';
                }

                // Save Letter Text
                saveLetterTextBtn.addEventListener('click', async () => {
                    const text = letterInput.value.trim().toUpperCase().substring(0, 3);
                    if (!text) {
                        showMessage(pfpMessage, 'Please enter at least one letter.', 'warning');
                        return;
                    }
                    try {
                        saveLetterTextBtn.disabled = true;
                        await updateDoc(userDocRef, { pfpLetters: text });
                        userData.pfpLetters = text; // Update local
                        triggerNavbarUpdate();
                        showMessage(pfpMessage, 'Avatar text saved!', 'success');
                    } catch (e) {
                        showMessage(pfpMessage, 'Error saving text.', 'error');
                    } finally {
                        saveLetterTextBtn.disabled = false;
                    }
                });

                // Gradient Palette Logic
                const paletteContainer = document.getElementById('letterColorPalette');
                const gradients = [
                    'linear-gradient(135deg, #ef4444, #a020f0)', // Red to Purple
                    'linear-gradient(135deg, #f97316, #f59e0b)', // Orange to Amber
                    'linear-gradient(135deg, #eab308, #84cc16)', // Amber to Lime
                    'linear-gradient(135deg, #22c55e, #10b981)', // Emerald to Teal
                    'linear-gradient(135deg, #14b8a6, #06b6d4)', // Teal to Cyan
                    'linear-gradient(135deg, #0ea5e9, #3b82f6)', // Light Blue to Blue
                    'linear-gradient(135deg, #6366f1, #8b5cf6)', // Indigo to Violet
                    'linear-gradient(135deg, #a855f7, #d946ef)', // Purple to Magenta
                    'linear-gradient(135deg, #ec4899, #f43f5e)', // Pink to Rose
                    'linear-gradient(135deg, #e11d48, #be185d)', // Rose to Ruby
                    'linear-gradient(135deg, #a1a1aa, #71717a)', // Cool Gray
                    'linear-gradient(135deg, #52525b, #27272a)'  // Dark Gray
                ];
                const currentLetterBg = userData.pfpLetterBg || 'linear-gradient(135deg, #374151, #1f2937)';

                gradients.forEach(grad => {
                    const dot = document.createElement('div');
                    dot.className = `color-option ${grad === currentLetterBg ? 'selected' : ''}`;
                    dot.style.background = grad;
                    dot.addEventListener('click', async () => {
                        // Update UI
                        paletteContainer.querySelectorAll('.color-option').forEach(d => d.classList.remove('selected'));
                        dot.classList.add('selected');
                        
                        // Save
                        try {
                            await updateDoc(userDocRef, { pfpLetterBg: grad });
                            userData.pfpLetterBg = grad; // Update local
                            triggerNavbarUpdate();
                            showMessage(pfpMessage, 'Background gradient saved!', 'success');
                        } catch (e) { showMessage(pfpMessage, 'Error saving gradient.', 'error'); }
                    });
                    paletteContainer.appendChild(dot);
                });

                // --- Custom Upload Logic ---
                const uploadBtn = document.getElementById('uploadPfpBtn');
                const fileInput = document.getElementById('pfpFileInput');
                const cropperModal = document.getElementById('cropperModal');
                const cropperCanvas = document.getElementById('cropperCanvas');
                const cancelCropBtn = document.getElementById('cancelCropBtn');
                const submitCropBtn = document.getElementById('submitCropBtn');
                
                // Show existing custom pfp in preview
                if (userData.customPfp) {
                    previewImg.src = userData.customPfp;
                    previewImg.style.display = 'block';
                    previewPlaceholder.style.display = 'none';
                }

                uploadBtn.addEventListener('click', () => fileInput.click());

                let cropperImage = null;
                let cropState = { x: 0, y: 0, radius: 100 };
                let isDragging = false;
                let dragStart = { x: 0, y: 0 };
                const ctx = cropperCanvas.getContext('2d');

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    if (file.size > 2 * 1024 * 1024) {
                        showMessage(pfpMessage, 'File is too large (max 2MB).', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        cropperImage = new Image();
                        cropperImage.onload = () => {
                            // Setup canvas with fixed height for consistency
                            const fixedHeight = 400;
                            const scale = fixedHeight / cropperImage.height;
                            cropperCanvas.height = fixedHeight;
                            cropperCanvas.width = cropperImage.width * scale;
                            
                            // Initial crop state: center, 1/3 min dim
                            cropState = {
                                x: cropperCanvas.width / 2,
                                y: cropperCanvas.height / 2,
                                radius: Math.min(cropperCanvas.width, cropperCanvas.height) / 3
                            };
                            
                            cropperModal.style.display = 'flex';
                            requestAnimationFrame(drawCropper);
                        };
                        cropperImage.src = evt.target.result;
                    };
                    reader.readAsDataURL(file);
                });
                
                const drawCropper = () => {
                    if (!cropperImage) return;
                    const w = cropperCanvas.width;
                    const h = cropperCanvas.height;
                    ctx.clearRect(0, 0, w, h);
                    
                    // Draw image filling canvas
                    ctx.drawImage(cropperImage, 0, 0, w, h);
                    
                    // Draw overlay
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.beginPath();
                    ctx.rect(0, 0, w, h);
                    // Cut hole
                    ctx.arc(cropState.x, cropState.y, cropState.radius, 0, 2 * Math.PI, true);
                    ctx.fill();
                    
                    // Draw dashed border
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 2;
                    ctx.setLineDash([6, 4]); // Dashed pattern
                    ctx.beginPath();
                    ctx.arc(cropState.x, cropState.y, cropState.radius, 0, 2 * Math.PI);
                    ctx.stroke();
                    ctx.setLineDash([]); // Reset
                };

                // Interaction Handlers
                const handleStart = (x, y) => {
                    const dx = x - cropState.x;
                    const dy = y - cropState.y;
                    if (dx*dx + dy*dy < cropState.radius * cropState.radius) {
                        isDragging = true;
                        dragStart = { x, y };
                    }
                };
                
                const handleMove = (x, y) => {
                    if (isDragging) {
                        const dx = x - dragStart.x;
                        const dy = y - dragStart.y;
                        
                        let newX = cropState.x + dx;
                        let newY = cropState.y + dy;
                        
                        // Constraint: Circle must stay within canvas
                        // x - radius >= 0  => x >= radius
                        // x + radius <= w  => x <= w - radius
                        const r = cropState.radius;
                        const w = cropperCanvas.width;
                        const h = cropperCanvas.height;
                        
                        newX = Math.max(r, Math.min(newX, w - r));
                        newY = Math.max(r, Math.min(newY, h - r));
                        
                        cropState.x = newX;
                        cropState.y = newY;
                        
                        dragStart = { x, y };
                        requestAnimationFrame(drawCropper);
                    }
                };

                const handleEnd = () => { isDragging = false; };
                
                const handleScroll = (e) => {
                    e.preventDefault();
                    const delta = e.deltaY > 0 ? -5 : 5;
                    let newRadius = cropState.radius + delta;
                    
                    const w = cropperCanvas.width;
                    const h = cropperCanvas.height;
                    
                    // 1. Absolute Max Radius constraint (half of smallest dimension)
                    const maxPossibleRadius = Math.min(w, h) / 2;
                    
                    // Clamp requested radius to valid range [20, maxPossibleRadius]
                    newRadius = Math.max(20, Math.min(newRadius, maxPossibleRadius));
                    
                    // 2. Calculate required bounds for center (x, y) given newRadius
                    // The center must be at least newRadius away from any edge.
                    const minX = newRadius;
                    const maxX = w - newRadius;
                    const minY = newRadius;
                    const maxY = h - newRadius;
                    
                    // 3. Clamp current center to these new valid bounds
                    // This effectively "pushes" the circle inwards if it was too close to the edge for the new size
                    cropState.x = Math.max(minX, Math.min(cropState.x, maxX));
                    cropState.y = Math.max(minY, Math.min(cropState.y, maxY));
                    
                    cropState.radius = newRadius;
                    requestAnimationFrame(drawCropper);
                };

                cropperCanvas.addEventListener('mousedown', e => handleStart(e.offsetX, e.offsetY));
                cropperCanvas.addEventListener('mousemove', e => handleMove(e.offsetX, e.offsetY));
                cropperCanvas.addEventListener('mouseup', handleEnd);
                cropperCanvas.addEventListener('mouseleave', handleEnd);
                cropperCanvas.addEventListener('wheel', handleScroll);
                
                // Touch support
                cropperCanvas.addEventListener('touchstart', e => {
                    e.preventDefault();
                    const rect = cropperCanvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    // Account for CSS scaling if canvas is displayed smaller than actual size
                    // offsetX = (clientX - left) * (canvas.width / clientWidth)
                    const scaleX = cropperCanvas.width / rect.width;
                    const scaleY = cropperCanvas.height / rect.height;
                    handleStart((touch.clientX - rect.left) * scaleX, (touch.clientY - rect.top) * scaleY);
                });
                cropperCanvas.addEventListener('touchmove', e => {
                    e.preventDefault();
                    const rect = cropperCanvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const scaleX = cropperCanvas.width / rect.width;
                    const scaleY = cropperCanvas.height / rect.height;
                    handleMove((touch.clientX - rect.left) * scaleX, (touch.clientY - rect.top) * scaleY);
                });
                cropperCanvas.addEventListener('touchend', handleEnd);

                cancelCropBtn.addEventListener('click', () => {
                    cropperModal.style.display = 'none';
                    fileInput.value = ''; // Reset
                });

                submitCropBtn.addEventListener('click', async () => {
                    // Create final cropped image
                    const tempCanvas = document.createElement('canvas');
                    const size = 128; // Output size
                    tempCanvas.width = size;
                    tempCanvas.height = size;
                    const tCtx = tempCanvas.getContext('2d');
                    
                    // Mapping back to original image
                    // Canvas was scaled to fixedHeight (400).
                    // scale = 400 / image.height
                    // originalX = cropState.x / scale
                    const scale = cropperCanvas.height / cropperImage.height;
                    
                    const sourceX = (cropState.x - cropState.radius) / scale;
                    const sourceY = (cropState.y - cropState.radius) / scale;
                    const sourceSize = (cropState.radius * 2) / scale;
                    
                    tCtx.drawImage(cropperImage, sourceX, sourceY, sourceSize, sourceSize, 0, 0, size, size);
                    
                    const base64 = tempCanvas.toDataURL('image/jpeg', 0.8);
                    
                    // Save to Firestore
                    try {
                        submitCropBtn.disabled = true;
                        submitCropBtn.textContent = "Saving...";
                        await updateDoc(userDocRef, { 
                            customPfp: base64,
                            pfpType: 'custom'
                        });
                        
                        userData.customPfp = base64;
                        userData.pfpType = 'custom';
                        triggerNavbarUpdate();
                        
                        // Update UI
                        pfpDropdown.setValue('custom'); // Use custom dropdown method
                        updatePfpUi('custom');
                        previewImg.src = base64;
                        previewImg.style.display = 'block';
                        previewPlaceholder.style.display = 'none';
                        
                        cropperModal.style.display = 'none';
                        showMessage(pfpMessage, 'Profile picture updated!', 'success');
                    } catch (e) {
                        console.error(e);
                        alert('Failed to save image.');
                    } finally {
                        submitCropBtn.disabled = false;
                        submitCropBtn.innerHTML = '<i class="fa-solid fa-check mr-2"></i> Submit';
                    }
                });
            }

            // --- 2. THEME LOGIC (Existing) ---
            
            if (!themePickerContainer) return;
            
            // From navigation.js
            const lightThemeNames = ['Light', 'Lavender', 'Rose Gold', 'Mint'];

            try {
                // 1. Fetch themes
                const response = await fetch('../themes.json');
                if (!response.ok) throw new Error('Failed to fetch themes.json');
                const themes = await response.json();
                
                if (!themes || themes.length === 0) {
                     throw new Error('themes.json is empty or invalid');
                }
                
                // 2. Get currently saved theme to set the active state
                let savedTheme = null;
                try {
                    savedTheme = JSON.parse(localStorage.getItem(THEME_STORAGE_KEY));
                } catch (e) {
                    console.warn('Could not parse saved theme.');
                }
                
                // 3. Process and render themes
                const modifiedThemes = []; // Store themes with correct logo paths
                let themeButtonsHtml = '';
                
                for (const theme of themes) {
                    // --- This is the logic requested by the user ---
                    // It modifies the theme object *in memory* before saving/applying
                    // We use root-relative paths as defined in navigation.js
                    if (lightThemeNames.includes(theme.name)) {
                        theme['logo-src'] = '/images/logo-dark.png'; 
                    } else {
                        theme['logo-src'] = '/images/logo.png';
                    }
                    // --- End of user logic ---
                    
                    modifiedThemes.push(theme);
                    
                    const isActive = savedTheme && savedTheme.name === theme.name;
                    
                    // === MODIFICATION START ===
                    // Get the theme's main background and text colors for the button
                    const previewBg = theme['navbar-bg'] || '#000000';
                    const previewText = theme['navbar-text'] || '#c0c0c0';
                    // Get the theme's accent border color
                    const previewBorder = theme['tab-active-border'] || '#4f46e5';


                    themeButtonsHtml += `
                        <button 
                            class="theme-button ${isActive ? 'active' : ''}" 
                            data-theme-name="${theme.name}" 
                            style="background-color: ${previewBg}; border-color: ${previewBorder};"
                        >
                            <div class="theme-button-name" style="color: ${previewText};">${theme.name}</div>
                        </button>
                    `;
                    // === MODIFICATION END ===
                }
                
                // Inject buttons into the DOM
                themePickerContainer.innerHTML = themeButtonsHtml;
                
                // 4. Add event listeners
                const themeButtons = themePickerContainer.querySelectorAll('.theme-button');
                themeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const themeName = button.dataset.themeName;
                        const themeToApply = modifiedThemes.find(t => t.name === themeName);
                        
                        if (themeToApply) {
                            // 1. Save to localStorage
                            localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(themeToApply));
                            
                            // === MODIFICATION START ===
                            // 2. Apply theme for live preview (ENABLED per user request)
                            if (window.applyTheme) {
                                window.applyTheme(themeToApply);
                            } else {
                                console.error('window.applyTheme is not defined. Is navigation.js loaded?');
                                showMessage(themeMessage, 'Error applying theme preview.', 'error');
                                return;
                            }
                            // === MODIFICATION END ===
                            
                            // 3. Update active class
                            themeButtons.forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');
                            
                            // 4. Show success message
                            showMessage(themeMessage, `${themeToApply.name} theme applied!`, 'success');
                        }
                    });
                });

            } catch (error) {
                console.error('Error loading themes:', error);
                themePickerContainer.innerHTML = `<p class="text-red-400">Error: Could not load themes. (${error.message})</p>`;
            }
        }
        
        // --- NEW: Loads data and adds event listeners for the Data tab ---
        async function loadDataTab() {
            // Get elements (buttons, modal)
            const exportBtn = document.getElementById('exportDataBtn');
            const importBtn = document.getElementById('importDataBtn');
            const modal = document.getElementById('modalPrompt');
            const modalClose = document.getElementById('modalClose');
            
            // Wire up buttons
            if (exportBtn) exportBtn.addEventListener('click', downloadAllSaves);
            if (importBtn) importBtn.addEventListener('click', handleFileUpload);
            
            // Wire up modal close events
            if (modalClose) {
                modalClose.addEventListener('click', () => {
                    modal.style.display = "none";
                });
            }
            // Use a new listener specific to this page
            const modalBackground = document.getElementById('modalPrompt');
            if (modalBackground) {
                modalBackground.addEventListener('click', event => {
                    if (event.target === modalBackground) {
                        modal.style.display = "none";
                    }
                });
            }
        }


        /**
         * Handles the switching of tabs and updating the main content view.
         */
        async function switchTab(tabId) {
            // 1. Update active class on sidebar tabs
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(`tab-${tabId}`).classList.add('active');

            // 2. Update the main view content and alignment
            mainView.style.justifyContent = 'flex-start';
            mainView.style.alignItems = 'flex-start';

            if (tabId === 'general') {
                await loadGeneralTab(); 
            }
            else if (tabId === 'privacy') {
                // NEW: Load Privacy Tab
                mainView.innerHTML = getPrivacyContent(); // Render HTML first
                await loadPrivacyTab(); // Then load data and add listeners
            }
            else if (tabId === 'personalization') {
                // --- NEW: Load Personalization Tab ---
                mainView.innerHTML = getPersonalizationContent(); // Render HTML
                await loadPersonalizationTab(); // Load data and add listeners
            }
            else if (tabId === 'data') {
                // --- NEW: Load Data Management Tab ---
                mainView.innerHTML = getDataManagementContent(); // Render HTML
                await loadDataTab(); // Load data and add listeners
            }
            else if (tabId === 'about') {
                mainView.innerHTML = getAboutContent();
            } else {
                const content = tabContent[tabId];
                mainView.innerHTML = getComingSoonContent(content.title);
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

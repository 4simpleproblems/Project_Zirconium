<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Settings and configuration for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>
    <script src="../panic-key.js"></script>
    <script src="../url-changer.js" defer></script> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING template) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }
        
        /* Emphasis class for slightly bolder text */
        .text-emphasis {
            font-weight: 500 !important; 
            color: #ffffff;
        }

        /* --- THEME-AWARE STYLES --- */
        /* MODIFICATION: These styles are now HARD-CODED to the default theme */
        
        .btn-toolbar-style {
            background: #0000000;
            border: 1px solid #333;
            border-radius: 0.75rem;
            color: #d1d5db;
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-toolbar-style:hover {
            background-color: #000000;
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            /* For the Apply button (Blue) */
            justify-content: center;
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* NEW DANGER STYLE - Based on primary style but with red colors */
        .btn-toolbar-style.btn-primary-override-danger {
            /* For the Delete button (Red) */
            justify-content: center;
            
            background-color: rgba(220, 38, 38, 0.1); /* red-700/10 */
            border: 1px solid #dc2626; /* red-600 */
            color: #dc2626; /* red-600 */
        }
        .btn-toolbar-style.btn-primary-override-danger:hover {
            background-color: rgba(220, 38, 38, 0.15); /* red-700/15 */
            border-color: #ef4444; /* red-500 */
            color: #ef4444; /* red-500 */
        }

        .settings-tab {
            width: 100%;
            justify-content: flex-start;
        }
        .settings-tab.active {
            background-color: rgba(79, 70, 229, 0.1);
            border: 1px solid #4f46e5;
            color: #4f46e5;
        }
        .settings-tab.active:hover {
             background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }
        
        /* --- Page Content Layout --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
        }

        #settings-container {
            display: flex;
            flex-grow: 1;
            padding: 20px;
            min-height: calc(100vh - 4rem - 40px); 
        }

        #settings-sidebar {
            width: 250px;
            padding-right: 20px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: sticky; 
            top: 4.5rem; 
            align-self: flex-start; 
        }

        #settings-main-view {
            flex-grow: 1;
            padding: 20px;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 0.75rem;
            min-height: 100%; 
            display: flex;
            flex-direction: column; 
            align-items: flex-start;
        }
        
        .about-section-content {
            width: 100%;
            margin-top: 1rem;
        }
        .social-link-group {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            margin-bottom: 20px;
        }
        .legal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        /* Container style to match tab look (used for rate limit and input wrapper) */
        /* MODIFICATION: Hard-coded default theme */
        .settings-box { 
            border: 1px solid #333; 
            border-radius: 1rem; 
            background-color: #0000000; 
            transition: all 0.2s;
        }
        
        /* Utility styles for form elements */
        .input-text-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
        }
        .input-text-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        /* Style for the Panic Key input (single character) */
        .input-key-style {
            width: 4rem; /* Fixed width for a single key */
            padding: 0.75rem;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 500;
            text-transform: uppercase; /* Show the key as uppercase */
            caret-color: transparent; /* Hide the caret */
        }
        .input-key-style::placeholder {
            font-size: 1rem;
            text-transform: none;
        }
         .input-key-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
         }
        
        .input-select-style {
            width: 100%; 
            padding: 0.75rem; 
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }
        .input-select-style:focus {
            border-color: #505050; 
            outline: none;
            box-shadow: 0 0 0 2px rgba(80, 80, 80, 0.5);
        }
        
        .general-message-area { min-height: 20px; margin-top: 1rem; font-weight: 400; }
        .success-message { color: #4ade80; }
        .error-message { color: #f87171; }
        .warning-message { color: #fbbf24; }
        
        /* --- NEW: Theme Picker Styles --- */
        /* MODIFICATION: These styles ARE theme-aware */
        #theme-picker-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
            width: 100%;
        }
        .theme-button {
            /* MODIFICATION: Border color is now theme-aware */
            border: 2px solid var(--tab-active-border, #4f46e5); 
            background-color: #111; /* This will be overridden by inline style */
            border-radius: 0.75rem; 
            padding: 0.75rem; /* MODIFICATION: Reduced padding */
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease-out;
            opacity: 0.7;
            position: relative;
        }
        .theme-button:hover {
            opacity: 1;
            /* MODIFICATION: Use a consistent hover border */
            border-color: var(--tab-active-hover-border, #6366f1);
            transform: translateY(-2px);
        }
        .theme-button.active {
            opacity: 1;
            /* MODIFICATION: Removed redundant border-color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.3); /* Will use variable shadow */
            box-shadow: 0 0 10px var(--tab-active-shadow, rgba(79, 70, 229, 0.3));
        }
        
        .theme-button-name {
            font-weight: 500;
            color: #e0e0e0; /* This will be overridden by inline style */
        }
        
        /* --- NEW: Modal and Loading Styles (from index.html) --- */
        .modal {
          display: none;
          position: fixed;
          z-index: 2000;
          left: 0;
          top: 0;
          width: 100%;
          height: 100%;
          background-color: rgba(0, 0, 0, 0.7);
          justify-content: center;
          align-items: center;
        }
        .modal-content {
          background-color: #1a1a1a; /* Darker modal */
          padding: 20px;
          border-radius: 10px;
          border: 1px solid #333;
          width: 90%;
          max-width: 400px;
          text-align: center;
          color: white;
          position: relative;
        }
        .modal-close {
          color: #aaa;
          position: absolute;
          top: 10px;
          right: 15px;
          font-size: 28px;
          font-weight: bold;
          cursor: pointer;
        }
        .modal-close:hover {
          color: #fff;
        }
        .modal-buttons {
          display: flex;
          gap: 10px;
          justify-content: center;
          margin-top: 20px;
        }
        /* Style modal buttons to match settings buttons */
        .modal-buttons button { 
            /* This will be styled by btn-toolbar-style */
        }

        .loading-overlay {
          display: none;
          position: fixed;
          z-index: 3000;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          justify-content: center;
          align-items: center;
          flex-direction: column;
          color: white;
        }
        .loading-overlay.active {
          display: flex;
        }
        .loading-animation {
          display: flex;
          align-items: center;
          margin-bottom: 20px;
        }
        .loading-bar {
          background-color: rgba(255, 255, 255, 0.3);
          width: 20px;
          height: 40px;
          margin-right: 5px;
          border-radius: 10px;
          animation: load ease infinite 5s;
        }
        .loading-bar:nth-child(2) {
          animation-delay: 0.1s;
        }
        .loading-bar:nth-child(3) {
          animation-delay: 0.2s;
        }
        .loading-bar:nth-child(4) {
          animation-delay: 0.3s;
        }
        .loading-bar:nth-child(5) {
          animation-delay: 0.4s;
        }
        @keyframes load {
          0%,
          100% {
            transform: rotate(0deg);
          }
          50% {
            transform: rotate(720deg) rotateX(180deg);
          }
        }
        
        /* NEW: Custom Select Dropdown for Tab Disguise Presets */
        .custom-select-container {
            position: relative;
            width: 100%;
        }
        .custom-select-button {
            /* Reuse existing input select style for appearance */
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem; 
            color: #c0c0c0; 
            transition: all 0.2s;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            
            /* Custom appearance */
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 0.75rem;
            padding-right: 2.5rem; /* Ensure arrow doesn't overlap text */
        }
        .custom-select-menu {
            position: absolute;
            top: calc(100% + 4px); /* Position slightly below the button */
            left: 0;
            right: 0;
            z-index: 10;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #252525; 
            background-color: #111111; 
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }
        .custom-select-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            cursor: pointer;
            transition: background-color 0.1s, color 0.1s;
        }
        .custom-select-option:hover {
            background-color: #1a1a1a;
        }
        .custom-select-option.selected {
            background-color: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
        }
        .custom-select-favicon {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            object-fit: contain;
            flex-shrink: 0;
        }
        .custom-select-text {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            font-weight: 300;
        }
        
    </style>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1D4F692C1Q"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-1D4F692C1Q');
</script>
</head>
<body class="min-h-screen">
    <div id="page-content">
        
        <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
            <h1 class="text-2xl font-bold text-white">4SP Settings</h1>
            
            <div class="flex items-center gap-2">
                 </div>
        </header>

        <div id="settings-container">
            <nav id="settings-sidebar">
                <button id="tab-general" class="btn-toolbar-style settings-tab active" data-tab="general">
                    <i class="fa-solid fa-gear w-5"></i> <span>General</span>
                </button>
                <button id="tab-privacy" class="btn-toolbar-style settings-tab" data-tab="privacy">
                    <i class="fa-solid fa-shield-halved w-5"></i> <span>Privacy & Security</span>
                </button>
                <button id="tab-personalization" class="btn-toolbar-style settings-tab" data-tab="personalization">
                    <i class="fa-solid fa-palette w-5"></i> <span>Personalization</span>
                </button>
                <button id="tab-data" class="btn-toolbar-style settings-tab" data-tab="data">
                    <i class="fa-solid fa-database w-5"></i> <span>Data Management</span>
                </button>
                <button id="tab-about" class="btn-toolbar-style settings-tab" data-tab="about">
                    <i class="fa-solid fa-circle-info w-5"></i> <span>About 4SP</span>
                </button>
            </nav>

            <div id="settings-main-view">
                </div>
        </div>
    </div>
    
    <div class="modal" id="modalPrompt">
        <div class="modal-content" id="modalContent">
            <span class="modal-close" id="modalClose">&times;</span>
            <p id="modalText">Modal Text</p>
            <div class="modal-buttons" id="modalButtons"></div>
        </div>
    </div>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-animation">
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
            <div class="loading-bar"></div>
        </div>
        <p id="loadingText">Loading...</p>
    </div>
    
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signOut,
            EmailAuthProvider, 
            reauthenticateWithCredential, 
            updatePassword,
            // NEW AUTH IMPORTS
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            linkWithPopup,
            unlink,
            reauthenticateWithPopup,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            updateDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            deleteDoc // NEW FIREBASE IMPORT
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config (Assumed to exist in a relative file) ---
        import { firebaseConfig } from "../firebase-config.js"; 
        
        // --- NEW: Import Site Mapping (from index.html logic) ---
        // This file MUST exist at ../site-mapping.js for import/export to work
        import { siteMapping } from "../site-mapping.js";


        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State and Element References ---
        const sidebarTabs = document.querySelectorAll('.settings-tab');
        const mainView = document.getElementById('settings-main-view');
        let currentUser = null; // To store the authenticated user object
        
        // --- NEW: Global var for loading overlay (from index.html) ---
        let loadingTimeout = null;
        
        // Constants for validation and limits
        const MIN_LENGTH = 6; 
        const MAX_LENGTH = 24;
        const MAX_CHANGES = 5; 


        // Tab Content Data Structure (can be expanded later)
        const tabContent = {
            'general': { title: 'General Settings', icon: 'fa-gear' },
            'privacy': { title: 'Privacy & Security', icon: 'fa-shield-halved' },
            'personalization': { title: 'Personalization', icon: 'fa-palette' },
            'data': { title: 'Data Management', icon: 'fa-database' },
            'about': { title: 'About 4SP', icon: 'fa-circle-info' },
        };
        
        // Constants for providers (NEW)
        const PROVIDER_CONFIG = {
            'google.com': { 
                name: 'Google', 
                icon: '../images/google-icon.png', 
                instance: () => new GoogleAuthProvider() 
            },
            'github.com': { 
                name: 'GitHub', 
                icon: '../images/github-mark-white.png', 
                instance: () => new GithubAuthProvider() 
            },
            'microsoft.com': { 
                name: 'Microsoft', 
                icon: '../images/microsoft.png', 
                instance: () => new OAuthProvider('microsoft.com') 
            },
            'password': { 
                name: 'Email & Password', 
                icon: '<i class="fa-solid fa-at fa-lg mr-3"></i>', 
                isCredential: true
            }
        };

        // --- NEW: Constants for Privacy Settings ---
        
        // IndexedDB Config for Panic Key
        const DB_NAME = 'userLocalSettingsDB';
        const STORE_NAME = 'panicKeyStore';
        
        // localStorage Key for URL Changer
        const URL_CHANGER_KEY = 'selectedUrlPreset';
        
        // --- NEW: Constant for Theme Storage ---
        // (Copied from navigation.js)
        const THEME_STORAGE_KEY = 'user-navbar-theme';


        // Presets pulled from url-changer.js (now globally exposed)
        // This array will be populated by the global variable set in url-changer.js
        const urlChangerPresets = window.TAB_DISGUISE_PRESETS || []; 

        
        // --- Shared Helper Functions ---
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        
        const showMessage = (element, text, type = 'error') => {
            // Prevent clearing a success message if a warning is generated elsewhere
            if (element && element.innerHTML.includes('success') && type !== 'error') return;
            if (element) {
                element.innerHTML = text;
                element.className = `general-message-area text-sm ${type}-message`;
            }
        };
        
        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };
        
        // --- NEW: IndexedDB Helper Functions ---

        /**
         * Opens the IndexedDB and creates the object store if needed.
         */
        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME);
                request.onupgradeneeded = event => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        /**
         * Fetches all panic key settings from IndexedDB.
         */
        async function getPanicKeySettings() {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => {
                    const settingsMap = new Map(request.result.map(item => [item.id, item]));
                    db.close();
                    resolve(settingsMap);
                };
                request.onerror = () => {
                     db.close();
                    reject(request.error);
                };
            });
        }
        
        /**
         * Saves panic key settings to IndexedDB.
         */
        async function savePanicKeySettings(settingsArray) {
            const db = await openDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                let completed = 0;
                const total = settingsArray.length;

                settingsArray.forEach(setting => {
                    const request = store.put(setting);
                    request.onsuccess = () => {
                        completed++;
                        if (completed === total) {
                            db.close();
                            resolve();
                        }
                    };
                    request.onerror = () => {
                         db.close();
                        reject(request.error); // Stop on first error
                    };
                });
                
                // Handle case where array is empty
                if (total === 0) {
                     db.close();
                    resolve();
                }
            });
        }

        // --- NEW: localStorage Helper Functions ---
        
        function getSavedUrlChangerSetting() {
            const savedSettingsJSON = localStorage.getItem(URL_CHANGER_KEY);
            let savedSettings = { type: 'none' };
            if (savedSettingsJSON) {
                try { 
                    savedSettings = JSON.parse(savedSettingsJSON); 
                } catch (e) { 
                    console.error("Failed to parse saved tab settings, reverting to default.", e); 
                }
            }
            // Ensure a default is set if the saved ID is no longer in the presets list
            if (savedSettings.type === 'preset' && !urlChangerPresets.find(p => p.id === savedSettings.id)) {
                 savedSettings.type = 'none';
                 savedSettings.id = 'none';
            }
            return savedSettings;
        }

        function saveUrlChangerSetting(settings) {
            try {
                localStorage.setItem(URL_CHANGER_KEY, JSON.stringify(settings));
                return true;
            } catch (e) {
                console.error("Failed to save URL changer settings:", e);
                return false;
            }
        }
        
        // --- NEW: Modal and Loading Functions (from index.html) ---
        
        function openModal(text, buttons = []) {
            const modal = document.getElementById('modalPrompt');
            const modalText = document.getElementById('modalText');
            const modalButtons = document.getElementById('modalButtons');
            
            modalText.textContent = text;
            modalButtons.innerHTML = "";
            buttons.forEach(btn => {
                const buttonEl = document.createElement("button");
                // MODIFICATION: Use settings page button styles
                buttonEl.className = "btn-toolbar-style";
                if (btn.text.toLowerCase() === 'yes' || btn.text.toLowerCase().includes('delete') || btn.text.toLowerCase().includes('clear')) {
                    buttonEl.classList.add('btn-primary-override-danger'); // Make 'Yes' destructive
                } else {
                    buttonEl.classList.add('btn-primary-override');
                }
                buttonEl.textContent = btn.text;
                buttonEl.onclick = btn.onclick;
                modalButtons.appendChild(buttonEl);
            });
            modal.style.display = "flex";
        }
        
        function closeModal() {
            document.getElementById('modalPrompt').style.display = "none";
        }
        
        // Listener for modal close button
        document.getElementById('modalClose').addEventListener('click', closeModal);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closeModal();
        });


        function showLoading(text = "Loading...") {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            
            loadingText.textContent = text;
            loadingOverlay.style.display = "flex";
            loadingOverlay.classList.add("active");
            if (loadingTimeout) clearTimeout(loadingTimeout);
            loadingTimeout = setTimeout(() => {
                hideLoading();
            }, 5000); // 5 second timeout
        }

        function hideLoading() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingTimeout) {
                clearTimeout(loadingTimeout);
                loadingTimeout = null;
            }
            loadingOverlay.classList.remove("active");
            loadingOverlay.style.display = "none";
        }
        
        // --- NEW: Core Data Functions (from index.html) ---
        
        function getAllLocalStorageData() {
            const data = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                // Skip theme key
                if (key === THEME_STORAGE_KEY) continue;
                // Skip URL changer key
                if (key === URL_CHANGER_KEY) continue;
                
                const value = localStorage.getItem(key);
                data[key] = value;
            }
            return data;
        }

        function setAllLocalStorageData(data) {
            // Don't clear *everything*, just the keys in the data
            // This avoids wiping the user's theme setting
            for (const [key, value] of Object.entries(data)) {
                localStorage.setItem(key, value);
            }
        }

        async function getAllIndexedDBData() {
            if (!indexedDB.databases) return {};
            let dbList = [];
            try {
                dbList = await indexedDB.databases();
            } catch (error) {
                console.error("Error fetching IndexedDB databases:", error);
                return {};
            }
            const result = {};
            for (const dbInfo of dbList) {
                if (!dbInfo.name) continue;
                // Skip our own settings DB
                if (dbInfo.name === DB_NAME) continue; 
                
                result[dbInfo.name] = await getDataFromDatabase(dbInfo.name);
            }
            return result;
        }

        function getDataFromDatabase(dbName) {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(dbName);
                request.onsuccess = event => {
                    const db = event.target.result;
                    const storeNames = Array.from(db.objectStoreNames);
                    const dbData = {};
                    let pending = storeNames.length;
                    if (pending === 0) {
                        db.close();
                        resolve(dbData);
                        return;
                    }
                    storeNames.forEach(storeName => {
                        const transaction = db.transaction(storeName, "readonly");
                        const store = transaction.objectStore(storeName);
                        const items = [];
                        const cursorRequest = store.openCursor();
                        cursorRequest.onsuccess = evt => {
                            const cursor = evt.target.result;
                            if (cursor) {
                                items.push({ key: cursor.key, value: cursor.value });
                                cursor.continue();
                            } else {
                                dbData[storeName] = items;
                                pending--;
                                if (pending === 0) {
                                    db.close();
                                    resolve(dbData);
                                }
                            }
                        };
                        cursorRequest.onerror = evt => {
                            pending--;
                            if (pending === 0) {
                                db.close();
                                resolve(dbData);
                            }
                        };
                    });
                };
                request.onerror = event => {
                    reject(event.target.error);
                };
            });
        }

        async function setAllIndexedDBData(indexedData) {
            for (const dbName in indexedData) {
                const storesData = indexedData[dbName];
                await new Promise(resolve => {
                    const deleteRequest = indexedDB.deleteDatabase(dbName);
                    deleteRequest.onsuccess = () => resolve();
                    deleteRequest.onerror = () => resolve();
                    deleteRequest.onblocked = () => resolve();
                });
                const openRequest = indexedDB.open(dbName, 1);
                openRequest.onupgradeneeded = function (event) {
                    const db = event.target.result;
                    for (const storeName in storesData) {
                        if (!db.objectStoreNames.contains(storeName)) {
                            // Check if the store needs a keyPath based on the items in the backup
                            const hasKeys = storesData[storeName].every(item => item.key !== undefined);
                            db.createObjectStore(storeName, { keyPath: hasKeys ? 'key' : undefined, autoIncrement: !hasKeys });
                        }
                    }
                };
                const dbInstance = await new Promise((resolve, reject) => {
                    openRequest.onsuccess = event => resolve(event.target.result);
                    openRequest.onerror = event => reject(event.target.error);
                });

                for (const storeName in storesData) {
                    await new Promise((resolve, reject) => {
                        const transaction = dbInstance.transaction(storeName, "readwrite");
                        const store = transaction.objectStore(storeName);
                        const items = storesData[storeName];

                        items.forEach(item => {
                            try {
                                if (store.keyPath) {
                                    // If keyPath is set, the key is part of the value object
                                    store.put(item.value);
                                } else if (item.key !== undefined) {
                                    // If no keyPath, put using the key
                                    store.put(item.value, item.key);
                                } else {
                                    // Auto-increment case
                                    store.put(item.value);
                                }
                            } catch (e) {
                                console.error(`Error putting item in ${storeName}:`, e, item);
                            }
                        });

                        transaction.oncomplete = () => resolve();
                        transaction.onerror = () => reject(transaction.error);
                    });
                }
                dbInstance.close();
            }
        }
        
        // --- Tab Content Generator Functions ---
        
        /**
         * Generates the HTML for the "Coming Soon" section.
         */
        function getComingSoonContent(title) {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">${title}</h2>
                <div class="w-full">
                    <div class="settings-box transition-all duration-300 p-4 text-center">
                        <i class="fa-solid fa-hourglass-half fa-2x text-gray-500 mb-3"></i>
                        <h3 class="text-xl font-bold text-white mb-2">Coming Soon</h3>
                        <p class="text-gray-400">This section is currently under development. Check back later!</p>
                    </div>
                </div>
            `;
        }
        
        /**
         * Generates the HTML for the Change Password section.
         */
        function getChangePasswordSection() {
             return `
                <h3 class="text-xl font-bold text-white mb-2">Change Password</h3>
                <div id="passwordSection" class="settings-box transition-all duration-300 p-4">
                    <p class="text-sm font-light text-gray-400 mb-4">
                        Changing your password requires you to re-enter your current password for security.
                    </p>
                    
                    <div class="mb-4">
                        <label for="currentPasswordInput" class="block text-gray-300 font-medium mb-1">Current Password:</label>
                        <input type="password" id="currentPasswordInput" class="input-text-style" placeholder="Enter current password">
                    </div>
                    
                    <div class="mb-4">
                        <label for="newPasswordInput" class="block text-gray-300 font-medium mb-1">New Password (Min 6 chars):</label>
                        <input type="password" id="newPasswordInput" class="input-text-style" placeholder="Enter new password">
                    </div>
                    
                    <div class="mb-4">
                        <label for="confirmNewPasswordInput" class="block text-gray-300 font-medium mb-1">Confirm New Password:</label>
                        <input type="password" id="confirmNewPasswordInput" class="input-text-style" placeholder="Confirm new password">
                    </div>

                    <div class="flex justify-between items-center pt-2">
                         <p id="passwordMessage" class="general-message-area text-sm"></p>
                        <button id="applyPasswordBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-check mr-1"></i> Apply
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for a single linked provider.
         */
        function getLinkedProviderHtml(providerId, isPrimary) {
            const providerInfo = PROVIDER_CONFIG[providerId];
            if (!providerInfo) return '';
            
            const iconHtml = providerInfo.icon.startsWith('<') 
                ? providerInfo.icon
                : `<img src="${providerInfo.icon}" alt="${providerInfo.name} Icon" class="w-5 h-5 mr-3">`;

            return `
                <div class="flex justify-between items-center p-4 ${!isPrimary ? 'border-t border-[#1a1a1a]' : ''}">
                    <div class="flex items-center">
                        ${iconHtml}
                        <span class="text-lg font-medium text-white">${providerInfo.name}</span>
                        ${isPrimary ? '<span class="ml-3 px-2 py-1 bg-blue-500/30 text-blue-300 text-xs rounded-full font-medium">Primary</span>' : ''}
                    </div>
                    ${!isPrimary ? `<button class="btn-toolbar-style text-red-500 hover:text-red-400" data-provider-id="${providerId}" data-action="unlink">
                        <i class="fa-solid fa-chain-broken mr-1"></i> Unlink
                    </button>` : ''}
                </div>
            `;
        }

        /**
         * Generates the HTML for a single available provider to link.
         */
        function getAvailableProviderHtml(providerId) {
            const providerInfo = PROVIDER_CONFIG[providerId];
             if (!providerInfo || providerInfo.isCredential) return '';
            
            const iconHtml = providerInfo.icon.startsWith('<') 
                ? providerInfo.icon
                : `<img src="${providerInfo.icon}" alt="${providerInfo.name} Icon" class="w-5 h-5 mr-3">`;

            return `
                <div class="flex justify-between items-center p-4 border-t border-[#1a1a1a]">
                    <div class="flex items-center">
                        ${iconHtml}
                        <span class="text-lg font-medium text-white">${providerInfo.name}</span>
                    </div>
                    <button class="btn-toolbar-style btn-primary-override w-36" data-provider-id="${providerId}" data-action="link" style="padding: 0.5rem 0.75rem;">
                        <i class="fa-solid fa-link mr-1"></i> Link
                    </button>
                </div>
            `;
        }
        
        /**
         * Generates the HTML for the "Privacy & Security" section.
         */
        function getPrivacyContent(primaryProviderId) {
            // Find the default (none) preset for initial display
            const defaultPreset = urlChangerPresets.find(p => p.id === 'none') || 
                                 { id: 'none', name: 'Default (4SP)', title: '4SP - Settings', favicon: '../favicon.ico' };
            const initialDisplay = `<img src="${defaultPreset.favicon}" alt="Favicon" class="custom-select-favicon"> <span class="custom-select-text">${defaultPreset.name}</span>`;
            
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Privacy & Security</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Panic Key Settings</h3>
                    <div id="panicKeySection" class="settings-box transition-all duration-300 p-4 mb-8">
                        <p class="text-sm font-light text-gray-400 mb-4"> 
                            Configure up to 3 panic keys. Pressing the specified key (without Shift, Ctrl, or Alt) on any page will redirect you to the URL you set.
                            <br> 
                            <span class="text-yellow-400">Valid keys:</span> a-z, 0-9, and \` - = [ ] \\ ; ' , . / 
                        </p>
                        <div class="flex items-center gap-4 px-2 mb-2">
                            <label class="block text-gray-400 text-sm font-light" style="width: 4rem; text-align: center;">Key</label>
                            <label class="block text-gray-400 text-sm font-light flex-grow">Redirect URL</label>
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey1" data-key-id="1" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl1" class="input-text-style" placeholder="e.g., https://google.com">
                        </div>
                        <div class="flex items-center gap-4 mb-3">
                            <input type="text" id="panicKey2" data-key-id="2" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl2" class="input-text-style" placeholder="e.g., https://youtube.com">
                        </div>
                        <div class="flex items-center gap-4">
                            <input type="text" id="panicKey3" data-key-id="3" class="input-key-style panic-key-input" placeholder="-" maxlength="1">
                            <input type="url" id="panicUrl3" class="input-text-style" placeholder="e.g., https://bing.com">
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="panicKeyMessage" class="general-message-area text-sm"></p>
                            <button id="applyPanicKeyBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Key
                            </button>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Tab Disguiser (URL Changer)</h3>
                    <div id="urlChangerSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Disguise the current tab's title and favicon to look like a common school or work website.
                        </p>

                        <div class="mb-4">
                            <label for="urlChangerMode" class="block text-gray-300 font-medium mb-1">Disguise Mode:</label>
                            <select id="urlChangerMode" class="input-select-style w-full">
                                <option value="none">Default (4SP)</option>
                                <option value="preset">Preset (Select a pre-configured tab)</option>
                                <option value="custom">Custom (Set your own title/favicon)</option>
                            </select>
                        </div>

                        <div id="urlChangerPresetSelection" class="mb-4 hidden">
                            <label for="customPresetSelect" class="block text-gray-300 font-medium mb-1">Select Preset:</label>
                            
                            <div id="customPresetSelectContainer" class="custom-select-container">
                                <button id="customPresetSelectButton" class="custom-select-button w-full" type="button" aria-expanded="false" aria-controls="customPresetSelectMenu">
                                    <span id="selectedPresetDisplay" class="truncate flex items-center">
                                        ${initialDisplay}
                                    </span>
                                </button>
                                <div id="customPresetSelectMenu" class="custom-select-menu hidden" role="listbox">
                                    </div>
                            </div>
                        </div>
                        
                        <div id="customGroup" class="mb-4 hidden">
                            <div class="mb-4">
                                <label for="customTitle" class="block text-gray-300 font-medium mb-1">Custom Title:</label>
                                <input type="text" id="customTitle" class="input-text-style" placeholder="e.g., Google Drive">
                            </div>

                            <div class="flex items-end gap-4">
                                <div class="flex-grow">
                                    <label for="customFaviconUrl" class="block text-gray-300 font-medium mb-1">Favicon URL or Hostname:</label>
                                    <input type="text" id="customFaviconUrl" class="input-text-style" placeholder="e.g., google.com or a URL">
                                </div>
                                <button id="fetchFaviconBtn" class="btn-toolbar-style w-36" style="padding: 0.75rem 0.75rem;">
                                    <i class="fa-solid fa-download mr-1"></i> Fetch
                                </button>
                            </div>
                        </div>

                        <h4 class="text-lg font-bold text-white mb-2 mt-4">Preview:</h4>
                        <div class="settings-box p-3 border-[#4f46e5]/50 flex items-start gap-4" id="presetPreviewBox">
                            <div class="flex-shrink-0 w-8 h-8 flex items-center justify-center border border-[#252525] rounded-lg">
                                <img id="previewImg" src="../favicon.ico" alt="Preview" class="w-full h-full object-contain" style="display: block;">
                            </div>
                            <div class="flex-grow">
                                <p class="text-white text-lg font-semibold" id="previewTitle">4SP - Settings</p>
                                <p class="text-gray-400 text-sm">Preview of what the tab will look like.</p>
                            </div>
                        </div>

                        <div class="flex justify-between items-center pt-4 mt-4 border-t border-[#252525]">
                            <p id="urlChangerMessage" class="general-message-area text-sm"></p>
                            <button id="applyUrlChangerBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                                <i class="fa-solid fa-check mr-1"></i> Apply Tab
                            </button>
                        </div>
                    </div>
                </div> 
            `;
        }

        /**
         * Generates the HTML for the Change Username section.
         */
        function getChangeUsernameSection(currentUsername) {
            // This function is assumed to exist for the General tab, but its implementation is omitted for brevity as it was not part of the request.
             return `
                <h3 class="text-xl font-bold text-white mb-2">Change Username</h3>
                <div id="usernameSection" class="settings-box transition-all duration-300 p-4 mb-8">
                    <p class="text-sm font-light text-gray-400 mb-4">
                        Your current username is: <span class="text-emphasis text-white">${currentUsername}</span>. 
                        Usernames must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters and cannot contain profanity. 
                    </p>
                    
                    <div class="mb-4">
                        <label for="usernameInput" class="block text-gray-300 font-medium mb-1">New Username:</label>
                        <input type="text" id="usernameInput" class="input-text-style" placeholder="Enter new username">
                    </div>

                    <div class="flex justify-between items-center pt-2">
                         <p id="usernameMessage" class="general-message-area text-sm"></p>
                        <button id="applyUsernameBtn" class="btn-toolbar-style btn-primary-override w-36" style="padding: 0.5rem 0.75rem;">
                            <i class="fa-solid fa-check mr-1"></i> Apply
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "General Settings" section.
         */
        function getGeneralContent(userDocSnap) {
             const userData = userDocSnap.data();
             const currentUsername = userData.username || 'N/A';
             const isEmailLinked = currentUser.providerData.some(p => p.providerId === 'password');
             const linkedProviders = currentUser.providerData.map(p => p.providerId);
             const primaryProviderId = currentUser.providerData[0].providerId;
             
             let providerListHtml = '';
             let availableProvidersHtml = '';
             
             // 1. Linked Providers
             linkedProviders.sort((a, b) => {
                 if (a === primaryProviderId) return -1;
                 if (b === primaryProviderId) return 1;
                 return 0;
             }).forEach(id => {
                 // Only show providers we configured
                 if (PROVIDER_CONFIG[id]) { 
                     providerListHtml += getLinkedProviderHtml(id, id === primaryProviderId);
                 }
             });
             
             // 2. Available Providers to Link
             Object.keys(PROVIDER_CONFIG).forEach(id => {
                 if (!linkedProviders.includes(id) && id !== 'password') {
                      // Only offer linking for non-credential providers not already linked
                     availableProvidersHtml += getAvailableProviderHtml(id);
                 }
             });

            return `
                <h2 class="text-3xl font-bold text-white mb-6">General Settings</h2>
                <div class="w-full">
                    ${getChangeUsernameSection(currentUsername)}
                    
                    ${isEmailLinked ? getChangePasswordSection() : ''}
                    
                    <h3 class="text-xl font-bold text-white mb-2">Account Providers</h3>
                    <div id="providerSection" class="settings-box transition-all duration-300 p-0 mb-8">
                        ${providerListHtml}
                        ${availableProvidersHtml.length > 0 ? availableProvidersHtml : '<p class="text-center p-4 text-gray-400">All available providers are linked.</p>'}
                        <p id="providerMessage" class="general-message-area text-sm px-4 pt-2"></p>
                    </div>

                    <h3 class="text-xl font-bold text-white mb-2">Account Deletion</h3>
                    <div id="deletionSection" class="settings-box transition-all duration-300 p-4 bg-red-900/10 border-red-700/50">
                        <p class="text-sm font-light text-red-300 mb-4">
                            Permanently delete your account. This action is irreversible and will remove all associated data.
                            You will need to re-authenticate with your primary provider (${PROVIDER_CONFIG[primaryProviderId].name}).
                        </p>
                        <button id="deleteAccountBtn" class="btn-toolbar-style btn-primary-override-danger w-full" style="padding: 0.75rem 1rem;">
                            <i class="fa-solid fa-user-xmark mr-2"></i> Delete My Account
                        </button>
                    </div>
                </div>
            `;
        }

        
        /**
         * Generates the HTML for the "Personalization" section.
         */
        function getPersonalizationContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Personalization</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Navigation Bar Theme</h3>
                    <div id="themeSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Select a theme for your navigation bar. This setting is saved locally and will apply a live preview.
                        </p>
                        <div id="theme-picker-container">
                            <div class="flex items-center justify-center p-8">
                                <i class="fa-solid fa-spinner fa-spin fa-2x text-gray-500"></i>
                            </div>
                        </div>
                        <div id="themeMessage" class="general-message-area text-sm"></div>
                    </div>
                </div>
            `;
        }
        
        // --- NEW: Generates the HTML for the "Data Management" section ---
        function getDataManagementContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">Data Management</h2>
                <div class="w-full">
                    <h3 class="text-xl font-bold text-white mb-2">Backup & Restore</h3>
                    <div id="backupRestoreSection" class="settings-box transition-all duration-300 p-4">
                        <p class="text-sm font-light text-gray-400 mb-4">
                            Backup all local site data (panic key settings, game saves, custom themes) to a JSON file, or restore from a previously downloaded file.
                        </p>
                        <div class="flex gap-4">
                            <button id="downloadSavesBtn" class="btn-toolbar-style flex-grow" style="padding: 0.75rem 1rem;">
                                <i class="fa-solid fa-download mr-2"></i> Download All Local Saves
                            </button>
                            <button id="uploadSavesBtn" class="btn-toolbar-style flex-grow btn-primary-override" style="padding: 0.75rem 1rem;">
                                <i class="fa-solid fa-upload mr-2"></i> Restore Local Saves
                            </button>
                        </div>
                        <p id="dataManagementMessage" class="general-message-area text-sm"></p>
                    </div>
                    
                    <h3 class="text-xl font-bold text-white mb-2 mt-8">Clear All Local Data</h3>
                    <div id="clearDataSection" class="settings-box transition-all duration-300 p-4 bg-red-900/10 border-red-700/50">
                        <p class="text-sm font-light text-red-300 mb-4">
                            WARNING: This action is irreversible. It will wipe all local data including panic key settings, themes, and game saves for all users on this device.
                        </p>
                        <button id="clearAllLocalDataBtn" class="btn-toolbar-style btn-primary-override-danger w-full" style="padding: 0.75rem 1rem;">
                            <i class="fa-solid fa-eraser mr-2"></i> Clear All Local Data
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * Generates the HTML for the "About 4SP" section.
         */
        function getAboutContent() {
            return `
                <h2 class="text-3xl font-bold text-white mb-6">About 4SP</h2>
                <div class="about-section-content">
                    <p class="text-lg text-gray-400 leading-relaxed">
                        4SP (Four Simple Problems) is a platform dedicated to providing a safe, advertisement-free, and resourceful environment for students. Our mission is to combine essential school tools with curated, enjoyable, and accessible digital content.
                    </p>
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">Challenges We Address</h3>
                    <ul class="list-disc list-inside ml-4 text-lg text-gray-400 leading-relaxed">
                        <li>Providing a <span class="text-emphasis">digital leisure platform free of advertisements</span>.</li>
                        <li>Delivering a <span class="text-emphasis">student toolkit designed for accessibility and consistent availability</span>, bypassing typical institutional network restrictions.</li>
                        <li>Establishing a <span class="text-emphasis">free, comprehensive, and reliable entertainment and resource hub</span>.</li>
                        <li>Enforcing <span class="text-emphasis">internal governance and balance of power</span>: Administrative authority is strictly limited to necessary website management functions, and only the creator holds full administrative power, ensuring neutrality.</li>
                    </ul>
                    <p class="text-lg text-gray-400 mt-4 leading-relaxed">
                        Features currently include an <span class="text-emphasis">online notebook</span> in the Notes App for secure organization, a <span class="text-emphasis">live clock</span> on the dashboard, a <span class="text-emphasis">dictionary</span> for quick lookups, and more tools.
                    </p>
                    <h3 class="text-xl font-bold text-white mt-6 mb-2">Version</h3>
                    <p class="text-gray-400">
                        Current Version: <span class="text-blue-400 text-emphasis">5.0 Beta 9</span>
                    </p>
                    <h3 class="text-xl font-bold text-white mt-6 mb-3">Connect & Support</h3>
                    <div class="social-link-group">
                        <a href="https://www.youtube.com/@4simpleproblems" target="_blank" class="btn-toolbar-style" title="YouTube">
                            <i class="fa-brands fa-youtube fa-lg mr-2"></i> YouTube
                        </a>
                        <a href="https://x.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="X (Twitter)">
                            <i class="fa-brands fa-x-twitter fa-lg mr-2"></i>X
                        </a>
                        <a href="https://buymeacoffee.com/4simpleproblems" target="_blank" class="btn-toolbar-style" title="Buy Me a Coffee">
                            <i class="fa-solid fa-mug-hot fa-lg mr-2"></i> Support
                        </a>
                    </div>
                    <div class="legal-buttons">
                        <a href="../terms.html" target="_blank" class="btn-toolbar-style" style="padding: 0.5rem 0.75rem;">
                            Terms of Service
                        </a>
                        <a href="../privacy.html" target="_blank" class="btn-toolbar-style" style="padding: 0.5rem 0.75rem;">
                            Privacy Policy
                        </a>
                    </div>
                </div>
            `;
        }
        
        
        // --- Tab Loading & Event Handlers ---
        
        /**
         * Loads data and adds event listeners for the General tab.
         */
        async function loadGeneralTab(userDocSnap) {
            // --- 1. Element References ---
            const usernameInput = document.getElementById('usernameInput');
            const applyUsernameBtn = document.getElementById('applyUsernameBtn');
            const usernameMessage = document.getElementById('usernameMessage');
            
            const currentPasswordInput = document.getElementById('currentPasswordInput');
            const newPasswordInput = document.getElementById('newPasswordInput');
            const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
            const applyPasswordBtn = document.getElementById('applyPasswordBtn');
            const passwordMessage = document.getElementById('passwordMessage');
            
            const providerSection = document.getElementById('providerSection');
            const providerMessage = document.getElementById('providerMessage');
            
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            
            const userData = userDocSnap.data();
            const primaryProviderId = currentUser.providerData[0].providerId;
            const primaryProviderInfo = PROVIDER_CONFIG[primaryProviderId];

            // --- 2. Load Initial Settings ---
            if (usernameInput) usernameInput.value = userData.username || '';

            // --- 3. Add Event Listeners ---
            
            // Username Change
            if (applyUsernameBtn) {
                 applyUsernameBtn.addEventListener('click', async () => {
                    const newUsername = usernameInput.value.trim();
                    showMessage(usernameMessage, '', 'success'); // Clear previous messages
                    
                    if (newUsername.length < MIN_LENGTH || newUsername.length > MAX_LENGTH) {
                        showMessage(usernameMessage, `Username must be between ${MIN_LENGTH} and ${MAX_LENGTH} characters.`, 'error');
                        return;
                    }
                    if (newUsername === userData.username) {
                        showMessage(usernameMessage, 'Username is unchanged.', 'warning');
                        return;
                    }

                    applyUsernameBtn.disabled = true;
                    showLoading('Checking username...');
                    
                    try {
                        // 1. Check Profanity
                        if (await checkProfanity(newUsername)) {
                            showMessage(usernameMessage, 'Username contains profanity. Please choose another.', 'error');
                            hideLoading();
                            return;
                        }
                        
                        // 2. Check Uniqueness (if different from current)
                        if (newUsername !== userData.username && await isUsernameTaken(newUsername)) {
                            showMessage(usernameMessage, 'This username is already taken.', 'error');
                            hideLoading();
                            return;
                        }

                        // 3. Apply Limit Check
                        const changesToday = userData.usernameChangesToday || 0;
                        const lastChangeDate = userData.lastUsernameChange ? userData.lastUsernameChange.toDate() : new Date(0);
                        const isSameDay = new Date().toDateString() === lastChangeDate.toDateString();
                        
                        let updatedChanges = changesToday;

                        if (isSameDay && changesToday >= MAX_CHANGES) {
                            showMessage(usernameMessage, `You can only change your username ${MAX_CHANGES} times per day. Try again tomorrow.`, 'error');
                            hideLoading();
                            return;
                        } else if (isSameDay) {
                            updatedChanges++;
                        } else {
                            // New day, reset count
                            updatedChanges = 1;
                        }
                        
                        // 4. Update Firestore
                        const userDocRef = getUserDocRef(currentUser.uid);
                        await updateDoc(userDocRef, {
                            username: newUsername,
                            usernameChangesToday: updatedChanges,
                            lastUsernameChange: serverTimestamp()
                        });
                        
                        // 5. Success
                        showMessage(usernameMessage, 'Username updated successfully!', 'success');
                        usernameInput.value = newUsername; // Update input field
                        // Update the displayed current username
                        document.querySelector('#usernameSection p span.text-emphasis').textContent = newUsername; 
                        
                        if (updatedChanges < MAX_CHANGES) {
                            showMessage(usernameMessage, `Username updated successfully! (${MAX_CHANGES - updatedChanges} changes remaining today)`, 'success');
                        } else {
                            showMessage(usernameMessage, `Username updated successfully! (0 changes remaining today)`, 'success');
                        }
                        
                    } catch (error) {
                        console.error("Error updating username:", error);
                        showMessage(usernameMessage, 'An error occurred while updating the username. Please try again.', 'error');
                    } finally {
                        hideLoading();
                        applyUsernameBtn.disabled = false;
                    }
                });
            }
            
            // Password Change (Only if email is linked)
            if (applyPasswordBtn) {
                 applyPasswordBtn.addEventListener('click', async () => {
                    const currentPassword = currentPasswordInput.value;
                    const newPassword = newPasswordInput.value;
                    const confirmPassword = confirmNewPasswordInput.value;
                    showMessage(passwordMessage, '', 'success');

                    if (!currentPassword || !newPassword || !confirmPassword) {
                        showMessage(passwordMessage, 'All fields are required.', 'error');
                        return;
                    }
                    if (newPassword.length < 6) {
                        showMessage(passwordMessage, 'New password must be at least 6 characters long.', 'error');
                        return;
                    }
                    if (newPassword !== confirmPassword) {
                        showMessage(passwordMessage, 'New password and confirmation do not match.', 'error');
                        return;
                    }
                    if (newPassword === currentPassword) {
                        showMessage(passwordMessage, 'New password cannot be the same as the current password.', 'error');
                        return;
                    }
                    
                    applyPasswordBtn.disabled = true;
                    showLoading('Changing password...');

                    try {
                        const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                        await reauthenticateWithCredential(currentUser, credential);
                        await updatePassword(currentUser, newPassword);

                        showMessage(passwordMessage, 'Password updated successfully! Redirecting in 2 seconds...', 'success');
                        
                        // Clear inputs
                        currentPasswordInput.value = '';
                        newPasswordInput.value = '';
                        confirmNewPasswordInput.value = '';
                        
                        setTimeout(() => {
                            signOut(auth).then(() => {
                                window.location.href = '../authentication.html';
                            });
                        }, 2000);
                        
                    } catch (error) {
                        console.error("Password update error:", error);
                        let msg = 'An error occurred.';
                        if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                            msg = 'Invalid current password.';
                        } else if (error.code === 'auth/weak-password') {
                            msg = 'Password is too weak. Choose a stronger password.';
                        } else {
                            msg = 'Failed to update password. Please check your current password and try again.';
                        }
                        showMessage(passwordMessage, msg, 'error');
                    } finally {
                        hideLoading();
                        applyPasswordBtn.disabled = false;
                    }
                });
            }
            
            // Provider Management
            if (providerSection) {
                 providerSection.addEventListener('click', async (e) => {
                    const providerAction = e.target.dataset.action;
                    const providerId = e.target.dataset.providerId;
                    
                    if (!providerAction || !providerId) return;
                    
                    const providerInfo = PROVIDER_CONFIG[providerId];
                    if (!providerInfo) return;
                    
                    showMessage(providerMessage, '', 'success');
                    
                    if (providerAction === 'unlink') {
                        // Check if unlinking this provider leaves the user with no primary provider
                        if (currentUser.providerData.length === 1) {
                             showMessage(providerMessage, 'Cannot unlink the only sign-in method. Link another provider first.', 'error');
                            return;
                        }
                        
                        openModal(`Are you sure you want to unlink your ${providerInfo.name} account? You will not be able to log in with this method.`, [
                            { text: "Cancel", onclick: closeModal },
                            { text: "Yes, Unlink", onclick: async () => {
                                closeModal();
                                showLoading(`Unlinking ${providerInfo.name}...`);
                                try {
                                    await unlink(currentUser, providerId);
                                    showMessage(providerMessage, `${providerInfo.name} account unlinked successfully! Reloading...`, 'success');
                                    setTimeout(() => switchTab('general'), 1500); // Reload tab content
                                } catch (error) {
                                    console.error("Unlink error:", error);
                                     showMessage(providerMessage, `Failed to unlink ${providerInfo.name}. Error: ${error.message}`, 'error');
                                } finally {
                                    hideLoading();
                                }
                            }}
                        ]);
                        
                    } else if (providerAction === 'link') {
                        showLoading(`Linking ${providerInfo.name}...`);
                        try {
                            const providerInstance = providerInfo.instance();
                            await linkWithPopup(currentUser, providerInstance);
                            showMessage(providerMessage, `${providerInfo.name} account linked successfully! Reloading...`, 'success');
                            setTimeout(() => switchTab('general'), 1500); // Reload tab content
                        } catch (error) {
                            console.error("Link error:", error);
                            let msg = `Failed to link ${providerInfo.name}.`;
                            if (error.code === 'auth/credential-already-in-use' || error.code === 'auth/account-exists-with-different-credential') {
                                msg = `This ${providerInfo.name} account is already linked to another user.`;
                            } else if (error.code === 'auth/cancelled-popup-request' || error.code === 'auth/popup-closed-by-user') {
                                msg = 'Link process cancelled.';
                            } else {
                                msg += ` Error: ${error.message}`;
                            }
                            showMessage(providerMessage, msg, 'error');
                        } finally {
                            hideLoading();
                        }
                    }
                 });
            }
            
            // Account Deletion
            if (deleteAccountBtn) {
                 deleteAccountBtn.addEventListener('click', () => {
                    openModal(`Are you absolutely sure you want to permanently delete your account? This action is irreversible. You will need to re-authenticate with your ${primaryProviderInfo.name} account.`, [
                        { text: "Cancel", onclick: closeModal },
                        { text: "Yes, Delete Account", onclick: async () => {
                            closeModal();
                            showLoading('Preparing for deletion...');
                            
                            try {
                                // 1. Reauthenticate (required for security-sensitive operations)
                                const providerInstance = primaryProviderInfo.instance();
                                await reauthenticateWithPopup(currentUser, providerInstance);
                                
                                showLoading('Deleting user data...');
                                // 2. Delete user's Firestore document
                                await deleteDoc(getUserDocRef(currentUser.uid)); 

                                showLoading('Deleting account...');
                                // 3. Delete the user
                                await deleteUser(currentUser); 
                                
                                // 4. Success and Redirect
                                alert("Your account has been successfully deleted. Redirecting to login.");
                                window.location.href = '../authentication.html';
                                
                            } catch (error) {
                                console.error("Account deletion error:", error);
                                let msg = 'Account deletion failed.';
                                if (error.code === 'auth/requires-recent-login') {
                                    msg = 'You must re-authenticate to delete your account. Please try again.';
                                } else if (error.code === 'auth/popup-closed-by-user') {
                                    msg = 'Authentication window was closed. Deletion cancelled.';
                                } else {
                                    msg += ` Error: ${error.message}`;
                                }
                                showMessage(providerMessage, msg, 'error');
                                hideLoading();
                            }
                        }}
                    ]);
                 });
            }
        }
        
        /**
         * Loads data and adds event listeners for the Privacy & Security tab.
         */
        async function loadPrivacyTab() {
            // --- 1. Element References ---
            const panicKeyInputs = document.querySelectorAll('.panic-key-input');
            const panicUrlInputs = [
                document.getElementById('panicUrl1'),
                document.getElementById('panicUrl2'),
                document.getElementById('panicUrl3'),
            ];
            const panicKeyMessage = document.getElementById('panicKeyMessage');
            const applyPanicKeyBtn = document.getElementById('applyPanicKeyBtn');
            
            const modeSelect = document.getElementById('urlChangerMode');
            const presetSelection = document.getElementById('urlChangerPresetSelection'); // NEW
            const customGroup = document.getElementById('customGroup');
            
            const customTitle = document.getElementById('customTitle');
            const customFaviconUrl = document.getElementById('customFaviconUrl');
            const fetchFaviconBtn = document.getElementById('fetchFaviconBtn');
            
            const previewTitle = document.getElementById('previewTitle');
            const previewImg = document.getElementById('previewImg');
            const urlChangerMessage = document.getElementById('urlChangerMessage');
            const applyUrlChangerBtn = document.getElementById('applyUrlChangerBtn');
            
            // NEW Custom Dropdown Elements
            const customPresetSelectContainer = document.getElementById('customPresetSelectContainer');
            const customPresetSelectButton = document.getElementById('customPresetSelectButton');
            const customPresetSelectMenu = document.getElementById('customPresetSelectMenu');
            const selectedPresetDisplay = document.getElementById('selectedPresetDisplay');
            
            // Internal state for selected preset ID
            let selectedPresetId = 'none';

            // --- Helper Functions ---
            const updatePreview = (title, favicon) => {
                previewTitle.textContent = title;
                if (favicon && favicon.includes('http')) {
                    previewImg.src = favicon;
                    previewImg.style.display = 'block';
                } else {
                    // Default to current favicon or hide
                    const defaultPreset = urlChangerPresets.find(p => p.id === 'none');
                    previewImg.src = defaultPreset ? defaultPreset.favicon : '../favicon.ico'; 
                    previewImg.style.display = 'block';
                }
            };
            
            const getPresetById = (id) => urlChangerPresets.find(p => p.id === id) || 
                                          urlChangerPresets.find(p => p.id === 'none') || 
                                          { id: 'none', name: 'Default (4SP)', title: '4SP - Settings', favicon: '../favicon.ico' };
            
            const toggleGroups = (mode) => {
                presetSelection.classList.add('hidden');
                customGroup.classList.add('hidden');
                // Ensure dropdown menu is hidden when toggling modes
                customPresetSelectMenu.classList.add('hidden'); 
                customPresetSelectButton.setAttribute('aria-expanded', 'false');
                
                if (mode === 'preset') {
                    presetSelection.classList.remove('hidden');
                } else if (mode === 'custom') {
                    customGroup.classList.remove('hidden');
                }
                
                // Always clear messages when switching
                showMessage(urlChangerMessage, '', 'success');
            };
            
            /**
             * Updates the custom select button display and the internal ID.
             * @param {string} id - The ID of the selected preset.
             */
            const updateCustomSelect = (id) => {
                const preset = getPresetById(id);
                selectedPresetId = id;
                const iconPath = preset.favicon || '../favicon.ico';
                
                selectedPresetDisplay.innerHTML = `
                    <img src="${iconPath}" alt="Favicon" class="custom-select-favicon">
                    <span class="custom-select-text">${preset.name}</span>
                `;
                
                // Update preview for the selected preset
                updatePreview(preset.title, preset.favicon);
                
                // Update all options to reflect selection status
                customPresetSelectMenu.querySelectorAll('.custom-select-option').forEach(option => {
                    option.classList.remove('selected');
                    option.setAttribute('aria-selected', 'false');
                    if (option.dataset.id === id) {
                        option.classList.add('selected');
                        option.setAttribute('aria-selected', 'true');
                    }
                });
            };

            // --- Option Rendering ---
            const renderCustomOptions = () => {
                customPresetSelectMenu.innerHTML = ''; // Clear previous options
                
                // Add all presets, ensuring 'none' is always the first
                const sortedPresets = [
                    getPresetById('none'), // Default is always first
                    ...urlChangerPresets.filter(p => p.id !== 'none').sort((a, b) => a.name.localeCompare(b.name)) // Sort others alphabetically
                ];
                
                let html = '';
                
                sortedPresets.forEach(preset => {
                    const iconPath = preset.favicon || '../favicon.ico';
                    const isSelected = selectedPresetId === preset.id;
                    html += `
                        <div class="custom-select-option ${isSelected ? 'selected' : ''}" data-id="${preset.id}" role="option" aria-selected="${isSelected}">
                            <img src="${iconPath}" alt="${preset.name} Favicon" class="custom-select-favicon">
                            <span class="custom-select-text">${preset.name}</span>
                        </div>
                    `;
                });
                
                customPresetSelectMenu.innerHTML = html;
                
                // Add listeners to new options
                customPresetSelectMenu.querySelectorAll('.custom-select-option').forEach(option => {
                    option.addEventListener('click', () => {
                        const id = option.dataset.id;
                        updateCustomSelect(id);
                        customPresetSelectMenu.classList.add('hidden');
                        customPresetSelectButton.setAttribute('aria-expanded', 'false');
                    });
                });
            };

            // --- 2. Load Initial Settings ---
            
            // Panic Key Load Logic (Remains the same)
            try {
                const settingsMap = await getPanicKeySettings();
                for (let i = 1; i <= 3; i++) {
                    const setting = settingsMap.get(`panicKey${i}`) || { key: '', url: '' };
                    document.getElementById(`panicKey${i}`).value = setting.key;
                    document.getElementById(`panicUrl${i}`).value = setting.url;
                }
            } catch (e) {
                console.error("Error loading panic key settings:", e);
                showMessage(panicKeyMessage, 'Error loading panic key settings.', 'error');
            }
            
            // URL Changer Load Logic (Updated)
            const savedUrlSettings = getSavedUrlChangerSetting();
            modeSelect.value = savedUrlSettings.type;

            if (savedUrlSettings.type === 'preset') {
                toggleGroups('preset');
                selectedPresetId = savedUrlSettings.id; // Set internal state
            } else if (savedUrlSettings.type === 'custom') {
                toggleGroups('custom');
                customTitle.value = savedUrlSettings.title || ''; 
                if (savedUrlSettings.favicon) {
                    customFaviconUrl.value = savedUrlSettings.favicon; // Load URL into input
                    updatePreview(savedUrlSettings.title, savedUrlSettings.favicon);
                } else {
                     updatePreview(savedUrlSettings.title, '../favicon.ico');
                }
            } else { // 'none'
                toggleGroups('none');
            }
            
            // After initial load, render the custom options based on state
            renderCustomOptions(); 
            // Update the button display to reflect the loaded preset
            updateCustomSelect(selectedPresetId);


            // --- 3. Add Event Listeners ---
            
            // Panic Key Input Validation (Whitelist) (Remains the same)
            const validKeyRegex = /^[a-z0-9`\-=\[\]\\;',\.\/]$/;
            panicKeyInputs.forEach(input => {
                input.addEventListener('keydown', e => {
                    // Allow control keys like Tab, Backspace, Arrow keys
                    if (e.key.length > 1 && e.key !== 'Backspace' && e.key !== 'Delete' && e.key !== 'ArrowLeft' && e.key !== 'ArrowRight' && e.key !== 'Tab') {
                        e.preventDefault();
                        return;
                    }
                    const lowerKey = e.key.toLowerCase();
                    if (lowerKey.length === 1 && !validKeyRegex.test(lowerKey)) {
                        e.preventDefault(); // Block invalid key
                        showMessage(panicKeyMessage, `Invalid key. Only a-z, 0-9, and \` - = [ ] \\ ; ' , . / are allowed.`, 'error');
                    } else if (lowerKey.length === 1) {
                        input.value = lowerKey; // Set value to the correct single, lowercase key
                        e.preventDefault();
                        showMessage(panicKeyMessage, '', 'success');
                    }
                });
                // Ensure value is normalized on blur/load
                input.addEventListener('blur', () => {
                    input.value = input.value.toLowerCase().trim().slice(0, 1);
                });
            });
            
            // Apply Panic Key Button (Remains the same)
            applyPanicKeyBtn.addEventListener('click', async () => {
                let settingsToSave = [];
                let hasError = false;
                showMessage(panicKeyMessage, '', 'success');

                for (let i = 0; i < 3; i++) {
                    const key = panicKeyInputs[i].value.toLowerCase().trim();
                    let url = panicUrlInputs[i].value.trim();
                    const id = `panicKey${i + 1}`;

                    // Skip empty pairs (not an error)
                    if (!key && !url) continue;

                    if (key && !url) {
                         showMessage(panicKeyMessage, `Panic Key ${i+1} has a key defined but no redirect URL.`, 'error');
                         hasError = true;
                         break;
                    }
                    
                    if (url && !key) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} has a redirect URL but no key defined.`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // Basic key validation
                    if (!validKeyRegex.test(key) && key) {
                         showMessage(panicKeyMessage, `Panic Key ${i+1} has an invalid key. Only a-z, 0-9, and \` - = [ ] \\ ; ' , . / are allowed.`, 'error');
                         hasError = true;
                         break;
                    }

                    // Check for relative path (common error)
                    if (url.startsWith('/')) {
                        showMessage(panicKeyMessage, `Panic Key ${i+1} has an invalid URL. Please use a full web address (e.g., https://google.com) not a relative path.`, 'error');
                        hasError = true;
                        break;
                    }
                    
                    // NEW: Prepend https:// if it's missing
                    if (url && !url.startsWith('https://') && !url.startsWith('http://')) {
                        url = 'https://' + url;
                    }

                    // NEW: Validate URL
                    try {
                         if (url) new URL(url); 
                    } catch (e) { 
                        showMessage(panicKeyMessage, `Panic Key ${i+1} has an invalid URL. Please enter a valid web address (e.g., google.com).`, 'error');
                        hasError = true;
                        break;
                    }
                    // Add valid setting
                    settingsToSave.push({ id, key, url }); // Push the (potentially modified) URL
                }

                if (hasError) return;

                // Check for duplicate keys
                const filledKeys = settingsToSave.map(s => s.key).filter(k => k);
                if (new Set(filledKeys).size !== filledKeys.length) {
                    showMessage(panicKeyMessage, 'Duplicate panic keys found. Each key must be unique.', 'error');
                    return;
                }

                // Save to IndexedDB
                try {
                    applyPanicKeyBtn.disabled = true;
                    showMessage(panicKeyMessage, '<i class="fa-solid fa-spinner fa-spin mr-2"></i> Saving...', 'warning');
                    await savePanicKeySettings(settingsToSave);
                    showMessage(panicKeyMessage, 'Panic key settings saved successfully! Reloading...', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000);
                } catch (e) {
                    console.error("Error saving panic key settings:", e);
                    showMessage(panicKeyMessage, 'An error occurred while saving panic key settings.', 'error');
                    applyPanicKeyBtn.disabled = false;
                }
            });

            // --- URL Changer Listeners (Updated for Custom Dropdown) ---
            
            // Mode Select Change
            modeSelect.addEventListener('change', (e) => {
                const mode = e.target.value;
                toggleGroups(mode);
                
                // Set defaults when switching to preset or none
                if (mode === 'none') {
                    updateCustomSelect('none'); // Update display
                    const preset = getPresetById('none');
                    updatePreview(preset.title, preset.favicon);
                } else if (mode === 'preset') {
                    updateCustomSelect(selectedPresetId); // Restore previously selected preset
                    const preset = getPresetById(selectedPresetId);
                    updatePreview(preset.title, preset.favicon);
                } else if (mode === 'custom') {
                    // Update preview based on current custom inputs
                    const title = customTitle.value.trim() || 'Custom Title';
                    const favicon = (customFaviconUrl.value && customFaviconUrl.value.includes('http')) ? customFaviconUrl.value : '';
                    updatePreview(title, favicon || '../favicon.ico');
                }
            });

            // Custom Preset Select Button Toggle
            customPresetSelectButton.addEventListener('click', () => {
                const isExpanded = customPresetSelectMenu.classList.toggle('hidden');
                customPresetSelectButton.setAttribute('aria-expanded', !isExpanded);
                // Re-render options to update selected state
                renderCustomOptions(); 
            });

            // Close Custom Select Menu when clicking outside
            document.addEventListener('click', (e) => {
                if (customPresetSelectMenu && customPresetSelectContainer && !customPresetSelectContainer.contains(e.target)) {
                    customPresetSelectMenu.classList.add('hidden');
                    customPresetSelectButton.setAttribute('aria-expanded', 'false');
                }
            });
            
            // Custom Title/URL input change (for live preview)
            customTitle.addEventListener('input', () => {
                const title = customTitle.value.trim() || 'Custom Title';
                updatePreview(title, previewImg.src);
            });
            
            // Custom Favicon URL input change
            customFaviconUrl.addEventListener('input', () => {
                showMessage(urlChangerMessage, '', 'success'); // Clear any previous error message
                
                // Live preview for a full URL if it looks like one, otherwise default favicon
                const url = customFaviconUrl.value.trim();
                let favicon = '../favicon.ico';
                if (url.startsWith('http')) {
                    // Simple URL check for live preview
                    favicon = url;
                } else if (urlChanger.findFavicon) { 
                    // If it's a hostname, we rely on the fetch button for accuracy
                }
                
                updatePreview(customTitle.value || 'Custom Title', favicon);
            });


            // Fetch Favicon Button
            fetchFaviconBtn.addEventListener('click', async () => {
                const url = customFaviconUrl.value.trim();
                if (!url) {
                    showMessage(urlChangerMessage, 'Please enter a URL or Hostname to fetch a favicon.', 'error');
                    return;
                }
                
                fetchFaviconBtn.disabled = true;
                showMessage(urlChangerMessage, `<i class="fa-solid fa-spinner fa-spin mr-2"></i> Searching for favicon...`, 'warning');

                try {
                    // urlChanger is available because url-changer.js is loaded
                    // Note: window.urlChanger is assumed to be defined by the defer script
                    const faviconUrl = await window.urlChanger.findFavicon(url); 
                    
                    updatePreview(customTitle.value || 'Custom Title', faviconUrl);
                    showMessage(urlChangerMessage, 'Favicon successfully fetched!', 'success');
                    customFaviconUrl.value = faviconUrl; // Update input with the final resolved URL
                } catch (error) {
                    console.error("Favicon fetch error:", error);
                    showMessage(urlChangerMessage, error.message.replace('Error: ', ''), 'error');
                } finally {
                    fetchFaviconBtn.disabled = false;
                }
            });

            // Apply URL Changer Button
            applyUrlChangerBtn.addEventListener('click', () => {
                const mode = modeSelect.value;
                let settingsToSave = { type: mode };
                showMessage(urlChangerMessage, '', 'success');

                if (mode === 'preset') {
                    const presetId = selectedPresetId; // Use the internal state
                    const preset = getPresetById(presetId);
                    
                    if (presetId === 'none' || !preset) {
                        settingsToSave = { type: 'none', id: 'none' };
                    } else {
                        settingsToSave = { type: 'preset', id: presetId };
                    }
                } else if (mode === 'custom') {
                    const title = customTitle.value.trim();
                    const favicon = customFaviconUrl.value.trim().includes('http') ? customFaviconUrl.value.trim() : ''; 

                    if (!title && !favicon) {
                        showMessage(urlChangerMessage, 'Please provide at least a custom title or a valid favicon URL.', 'error'); 
                        return;
                    }
                    
                    settingsToSave = { type: 'custom', title: title, favicon: favicon }; 
                }

                // Save to localStorage
                if (saveUrlChangerSetting(settingsToSave)) {
                    showMessage(urlChangerMessage, 'Tab Disguise settings saved! Reloading...', 'success');
                    // ADDED: Refresh page after 1 second
                    setTimeout(() => location.reload(), 1000);
                } else {
                    showMessage(urlChangerMessage, 'An error occurred while saving.', 'error');
                }
            });
        }

        
        /**
         * Loads data and adds event listeners for the Personalization tab.
         */
        async function loadPersonalizationTab() {
            const themePickerContainer = document.getElementById('theme-picker-container');
            const themeMessage = document.getElementById('themeMessage');
            if (!themePickerContainer) return;

            // From navigation.js
            const lightThemeNames = ['Light', 'Lavender', 'Rose Gold', 'Mint'];

            try {
                // 1. Fetch themes
                const response = await fetch('../themes.json');
                if (!response.ok) throw new Error('Failed to fetch themes.json');
                const themes = await response.json();

                if (!themes || themes.length === 0) {
                    themePickerContainer.innerHTML = '<p class="text-gray-400 text-center">No themes found.</p>';
                    return;
                }
                
                // Get current saved theme from localStorage
                let currentTheme = localStorage.getItem(THEME_STORAGE_KEY);
                if (currentTheme) {
                    try { currentTheme = JSON.parse(currentTheme); } catch (e) { currentTheme = null; }
                }
                // Default to 'Dark' if nothing is saved or the saved theme is invalid
                if (!currentTheme || !themes.some(t => t.name === currentTheme.name)) {
                    currentTheme = themes.find(t => t.name === 'Dark') || themes[0];
                }

                // 2. Generate HTML buttons
                let themeButtonsHtml = '';
                const modifiedThemes = themes.map(theme => {
                     // Check if it's a "light" theme for text contrast
                    const isLightTheme = lightThemeNames.includes(theme.name);
                    const previewText = isLightTheme ? '#070707' : '#e0e0e0';
                    return { ...theme, previewText: previewText };
                });

                for (const theme of modifiedThemes) {
                    const isActive = currentTheme.name === theme.name;
                    // Get the theme's background and text colors for the preview
                    const previewBg = theme.background || '#070707'; 
                    const previewText = theme.previewText; 
                    // Get the theme's accent border color
                    const previewBorder = theme['tab-active-border'] || '#4f46e5';

                    themeButtonsHtml += `
                        <button class="theme-button ${isActive ? 'active' : ''}" data-theme-name="${theme.name}" style="background-color: ${previewBg}; border-color: ${previewBorder};" >
                            <div class="theme-button-name" style="color: ${previewText};">${theme.name}</div>
                        </button>
                    `;
                }

                // 3. Inject buttons into the DOM
                themePickerContainer.innerHTML = themeButtonsHtml;

                // 4. Add event listeners
                const themeButtons = themePickerContainer.querySelectorAll('.theme-button');
                themeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const themeName = button.dataset.themeName;
                        const themeToApply = modifiedThemes.find(t => t.name === themeName);

                        if (themeToApply) {
                            // 1. Save to localStorage
                            localStorage.setItem(THEME_STORAGE_KEY, JSON.stringify(themeToApply));

                            // 2. Apply theme for live preview
                            if (window.applyTheme) {
                                window.applyTheme(themeToApply);
                            } else {
                                console.error('window.applyTheme is not defined. Ensure navigation.js is loaded correctly.');
                            }

                            // 3. Update active state
                            themeButtons.forEach(btn => btn.classList.remove('active'));
                            button.classList.add('active');

                            showMessage(themeMessage, `Theme set to ${themeName}.`, 'success');
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading personalization tab:', error);
                showMessage(themeMessage, 'Failed to load themes. Please try again later.', 'error');
                themePickerContainer.innerHTML = '<p class="text-red-400 text-center">Error loading themes.</p>';
            }
        }

        /**
         * Loads data and adds event listeners for the Data Management tab.
         */
        async function loadDataTab() {
            // --- 1. Element References ---
            const downloadSavesBtn = document.getElementById('downloadSavesBtn');
            const uploadSavesBtn = document.getElementById('uploadSavesBtn');
            const clearAllLocalDataBtn = document.getElementById('clearAllLocalDataBtn');
            const dataManagementMessage = document.getElementById('dataManagementMessage');
            
            // --- 2. Event Listeners ---
            
            // Download Data
            downloadSavesBtn.addEventListener('click', async () => {
                showMessage(dataManagementMessage, '', 'success');
                downloadSavesBtn.disabled = true;
                showLoading('Preparing local data backup...');
                
                try {
                    const localStorageData = getAllLocalStorageData();
                    const indexedDBData = await getAllIndexedDBData();
                    
                    const backupData = {
                        version: '1.0', // Version for future format changes
                        localStorage: localStorageData,
                        indexedDB: indexedDBData,
                        timestamp: new Date().toISOString()
                    };

                    const dataStr = JSON.stringify(backupData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `4sp_backup_${new Date().toISOString().substring(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    showMessage(dataManagementMessage, 'Local data backup downloaded successfully!', 'success');
                } catch (error) {
                    console.error("Backup error:", error);
                    showMessage(dataManagementMessage, 'Failed to create backup. See console for details.', 'error');
                } finally {
                    hideLoading();
                    downloadSavesBtn.disabled = false;
                }
            });

            // Restore Data
            uploadSavesBtn.addEventListener('click', () => {
                showMessage(dataManagementMessage, '', 'success');
                
                // 1. Create hidden file input
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = 'application/json';
                fileInput.style.display = 'none';

                // 2. Handle file selection
                fileInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    openModal(`Restoring data will overwrite your current panic key settings and game saves. Do you want to continue?`, [
                        { text: "Cancel", onclick: closeModal },
                        { text: "Yes, Restore", onclick: async () => {
                            closeModal();
                            uploadSavesBtn.disabled = true;
                            showLoading('Restoring data...');
                            
                            const reader = new FileReader();
                            reader.onload = async (event) => {
                                try {
                                    const backupData = JSON.parse(event.target.result);

                                    if (backupData.version !== '1.0' && backupData.version) {
                                        showMessage(dataManagementMessage, `Warning: Backup file version ${backupData.version} is not fully compatible with v1.0. Proceeding with caution.`, 'warning');
                                    }

                                    // Restore localStorage
                                    if (backupData.localStorage) {
                                        setAllLocalStorageData(backupData.localStorage);
                                    }

                                    // Restore IndexedDB
                                    if (backupData.indexedDB) {
                                        await setAllIndexedDBData(backupData.indexedDB);
                                    }
                                    
                                    // Special handling for Panic Key DB: clear then save
                                    if (backupData.panicKeyStore) {
                                         await savePanicKeySettings(backupData.panicKeyStore);
                                    }

                                    showMessage(dataManagementMessage, 'Local data restored successfully! Reloading page in 2 seconds...', 'success');
                                    setTimeout(() => location.reload(), 2000);

                                } catch (error) {
                                    console.error("Restore error:", error);
                                    showMessage(dataManagementMessage, 'Failed to restore data. File may be corrupt or invalid. See console for details.', 'error');
                                } finally {
                                    hideLoading();
                                    uploadSavesBtn.disabled = false;
                                }
                            };
                            reader.readAsText(file);
                        }}
                    ]);
                };

                // 3. Trigger file dialog
                document.body.appendChild(fileInput);
                fileInput.click();
                document.body.removeChild(fileInput);
            });
            
            // Clear All Local Data
            clearAllLocalDataBtn.addEventListener('click', () => {
                showMessage(dataManagementMessage, '', 'success');
                openModal('Are you sure you want to clear ALL local data? This includes panic keys, themes, and all game saves for ALL users on this device. This cannot be undone.', [
                    { text: "Cancel", onclick: closeModal },
                    { text: "Clear All", onclick: async () => {
                        closeModal();
                        clearAllLocalDataBtn.disabled = true;
                        showLoading('Wiping local data...');
                        
                        try {
                            // Clear localStorage, excluding the theme key if possible
                            for (let i = localStorage.length - 1; i >= 0; i--) {
                                const key = localStorage.key(i);
                                if (key !== THEME_STORAGE_KEY) {
                                    localStorage.removeItem(key);
                                }
                            }
                            
                            // Clear all IndexedDBs (including the panic key DB)
                            if (indexedDB.databases) {
                                const dbList = await indexedDB.databases();
                                for (const dbInfo of dbList) {
                                    await new Promise(resolve => {
                                        const deleteRequest = indexedDB.deleteDatabase(dbInfo.name);
                                        deleteRequest.onsuccess = () => resolve();
                                        deleteRequest.onerror = () => resolve();
                                        deleteRequest.onblocked = () => resolve();
                                    });
                                }
                            }

                            showMessage(dataManagementMessage, 'All local data successfully cleared! Reloading page in 2 seconds...', 'success');
                            setTimeout(() => location.reload(), 2000);
                            
                        } catch (error) {
                            console.error("Clear data error:", error);
                            showMessage(dataManagementMessage, 'Failed to clear all local data. You may need to clear browser site data manually.', 'error');
                        } finally {
                            hideLoading();
                            clearAllLocalDataBtn.disabled = false;
                        }
                    }}
                ]);
            });
        }

        /**
         * Handles the dynamic display of content based on the selected tab.
         */
        async function switchTab(tabId) {
            // 1. Update active state in sidebar
            sidebarTabs.forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                }
            });

            // 2. Render and load content for the selected tab
            // Always show loading overlay before fetching data and rendering
            showLoading(`Loading ${tabId} settings...`);
            
            try {
                if (tabId === 'general') {
                    const userDocRef = getUserDocRef(currentUser.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    mainView.innerHTML = getGeneralContent(userDocSnap);
                    await loadGeneralTab(userDocSnap);
                } else if (tabId === 'privacy') {
                    mainView.innerHTML = getPrivacyContent(currentUser.providerData[0].providerId); // Pass primary provider ID for deletion section
                    await loadPrivacyTab();
                } else if (tabId === 'personalization') {
                    mainView.innerHTML = getPersonalizationContent(); // Render HTML
                    await loadPersonalizationTab(); // Load data and add listeners
                } else if (tabId === 'data') {
                    mainView.innerHTML = getDataManagementContent(); // Render HTML
                    await loadDataTab(); // Load data and add listeners
                } else if (tabId === 'about') {
                    mainView.innerHTML = getAboutContent();
                } else {
                    const content = tabContent[tabId];
                    mainView.innerHTML = getComingSoonContent(content.title);
                }
            } catch(e) {
                 console.error(`Error loading tab ${tabId}:`, e);
                 mainView.innerHTML = `<h2 class="text-3xl font-bold text-white mb-6">Error</h2>
                                        <div class="settings-box p-4 text-center">
                                            <p class="text-red-400">Failed to load settings. Please check your network connection and try again.</p>
                                        </div>`;
            } finally {
                hideLoading();
            }

            // 3. New: Smoothly scroll the window back to the top (y=0)
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        // --- Initialization on Load ---
        
        // Add listener to each sidebar button
        sidebarTabs.forEach(tab => {
            tab.addEventListener('click', async () => {
                await switchTab(tab.dataset.tab);
            });
        });


        // --- AUTHENTICATION/REDIRECT LOGIC (Retained and Modified) ---
        function initializeAuth() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // No user is logged in, redirect to authentication.html (path corrected)
                    window.location.href = '../authentication.html'; 
                } else {
                    currentUser = user; 
                    // Set initial state to 'General' (or the first tab)
                    switchTab('general'); 
                }
            });
        }
        
        // Use a short timeout to allow the rest of the script to run before auth check
        setTimeout(() => { initializeAuth(); }, 100); 
    </script>
</body>
</html>

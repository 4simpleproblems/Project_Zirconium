<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Settings</title>
    <meta name="description" content="Manage your account profile, security, and application settings.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script> <style>
        /* Base V5 styling */
        body { font-family: 'Geist', sans-serif; background-color: #000000; color: #E5E7EB; }
        
        /* Loading screen styles */
        #loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #000000; z-index: 1000;
            display: flex; justify-content: center; align-items: center;
        }

        /* Settings specific styles */
        .settings-container {
            min-height: calc(100vh - 64px); /* Assuming nav height of 64px */
            display: flex;
            padding-top: 64px; /* Offset for fixed navigation */
        }
        .sidebar {
            width: 280px;
            flex-shrink: 0;
            padding: 2rem 1rem;
            border-right: 1px solid #1f2937;
            background-color: #0a0a0a;
        }
        .main-content {
            flex-grow: 1;
            padding: 2rem;
        }
        .settings-link {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            color: #D1D5DB;
            transition: all 0.2s;
        }
        .settings-link.active {
            background-color: #1f2937;
            color: #FFFFFF;
            font-weight: 600;
        }
        .settings-link:hover:not(.active) {
            background-color: #111827;
        }
    </style>
</head>
<body>
    <div id="loading-screen">
        <p class="text-xl text-gray-400">Authenticating user and loading settings...</p>
    </div>

    <div id="page-content" class="hidden">
        <div class="settings-container">
            <aside class="sidebar">
                <nav>
                    <h3 class="text-lg font-semibold text-gray-400 mb-4">Account</h3>
                    <a href="#profile" class="settings-link active" data-section="profile"><i class="fas fa-user-circle mr-3 w-5"></i> Profile</a>
                    <a href="#security" class="settings-link" data-section="security"><i class="fas fa-shield-alt mr-3 w-5"></i> Security</a>
                    <a href="#providers" class="settings-link" data-section="providers"><i class="fas fa-link mr-3 w-5"></i> Link Providers</a>
                    <h3 class="text-lg font-semibold text-gray-400 mt-6 mb-4">Application</h3>
                    <a href="#qol" class="settings-link" data-section="qol"><i class="fas fa-wrench mr-3 w-5"></i> QOL Features</a>
                    <a href="#delete" class="settings-link text-red-400 hover:text-red-300" data-section="delete"><i class="fas fa-trash-alt mr-3 w-5"></i> Delete Account</a>
                </nav>
            </aside>

            <main class="main-content">
                <div id="settings-sections">
                    
                    <section id="section-profile" class="settings-section">
                        <h2 class="text-3xl font-bold mb-6">Profile Settings</h2>
                        
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg mb-8 border border-gray-800">
                            <h3 class="text-xl font-semibold mb-4">Account Icon</h3>
                            <div class="flex items-center space-x-6">
                                <img id="profile-img-preview" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-500/50" src="https://via.placeholder.com/150/000000/FFFFFF?text=4SP" alt="Profile Picture">
                                <div>
                                    <label for="pfp-upload" class="cursor-pointer inline-block bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg transition">
                                        Upload New Icon
                                    </label>
                                    <input type="file" id="pfp-upload" accept="image/*" class="hidden">
                                    <p class="text-sm text-gray-400 mt-2">Max 2MB. JPG or PNG only.</p>
                                </div>
                            </div>
                            <button id="upload-pfp-btn" class="mt-4 bg-gray-700 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition hidden">Save Icon</button>
                        </div>
                        
                        <form id="update-username-form" class="bg-gray-900 p-6 rounded-lg shadow-lg border border-gray-800">
                            <h3 class="text-xl font-semibold mb-4">Change Username</h3>
                            <div class="space-y-4">
                                <div>
                                    <label for="current-username" class="block text-sm font-medium text-gray-400">Current Username</label>
                                    <input type="text" id="current-username" class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-white" value="Loading..." disabled>
                                </div>
                                <div>
                                    <label for="new-username" class="block text-sm font-medium text-gray-400">New Username</label>
                                    <input type="text" id="new-username" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-white focus:ring-indigo-500 focus:border-indigo-500">
                                </div>
                            </div>
                            <button type="submit" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition">Update Username</button>
                            <p id="username-message" class="mt-3 text-sm text-center"></p>
                        </form>
                    </section>
                    
                    <section id="section-security" class="settings-section hidden">
                        <h2 class="text-3xl font-bold mb-6">Security Settings</h2>
                        
                        <form id="change-password-form" class="bg-gray-900 p-6 rounded-lg shadow-lg border border-gray-800">
                            <h3 class="text-xl font-semibold mb-4">Change Password</h3>
                            <div id="reauth-required" class="p-4 bg-red-900/50 rounded-lg mb-4 hidden">
                                <p class="text-red-300"><i class="fas fa-exclamation-triangle mr-2"></i>Please re-enter your current password to continue.</p>
                                <div class="mt-3">
                                    <input type="password" id="reauth-password" placeholder="Current Password" required class="block w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-white">
                                </div>
                                <button type="button" id="reauth-btn" class="mt-3 bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg transition">Re-authenticate</button>
                            </div>

                            <div id="password-fields" class="space-y-4 hidden">
                                <div>
                                    <label for="current-password" class="block text-sm font-medium text-gray-400">Current Password</label>
                                    <input type="password" id="current-password" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-white">
                                </div>
                                <div>
                                    <label for="new-password" class="block text-sm font-medium text-gray-400">New Password</label>
                                    <input type="password" id="new-password" required class="mt-1 block w-full bg-gray-800 border border-gray-700 rounded-md p-3 text-white">
                                </div>
                            </div>
                            <button type="submit" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg transition">Update Password</button>
                            <p id="password-message" class="mt-3 text-sm text-center"></p>
                        </form>
                    </section>
                    
                    <section id="section-providers" class="settings-section hidden">
                        <h2 class="text-3xl font-bold mb-6">Link External Providers</h2>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg border border-gray-800 space-y-4">
                            <p class="text-gray-400">Link external accounts for easy sign-in.</p>
                            <button id="link-google-btn" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-lg hover:bg-gray-800 transition">
                                <i class="fab fa-google mr-3"></i> Link with Google
                            </button>
                            <button id="link-github-btn" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-lg hover:bg-gray-800 transition">
                                <i class="fab fa-github mr-3"></i> Link with GitHub
                            </button>
                            <p id="providers-message" class="mt-3 text-sm text-center"></p>
                        </div>
                    </section>

                    <section id="section-qol" class="settings-section hidden">
                        <h2 class="text-3xl font-bold mb-6">Quality of Life Features</h2>
                        <div class="bg-gray-900 p-6 rounded-lg shadow-lg border border-gray-800 space-y-4">
                            <p class="text-gray-400">Settings for Panic Key, Tab Disguise, and other utilities.</p>
                            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                <label for="panic-key-toggle" class="text-lg">Enable Panic Key</label>
                                <input type="checkbox" id="panic-key-toggle" class="form-checkbox h-5 w-5 text-indigo-600 bg-gray-700 border-gray-600 rounded">
                            </div>
                            <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                <label for="tab-disguise-toggle" class="text-lg">Enable Tab Disguise</label>
                                <input type="checkbox" id="tab-disguise-toggle" class="form-checkbox h-5 w-5 text-indigo-600 bg-gray-700 border-gray-600 rounded">
                            </div>
                        </div>
                    </section>

                    <section id="section-delete" class="settings-section hidden">
                        <h2 class="text-3xl font-bold mb-6 text-red-400">Delete Account</h2>
                        <div class="bg-red-900/30 p-6 rounded-lg shadow-lg border border-red-800 space-y-4">
                            <p class="text-red-300 font-medium">WARNING: This action is permanent and cannot be undone.</p>
                            
                            <form id="delete-reauth-form" class="space-y-4">
                                <label for="delete-password" class="block text-sm font-medium text-red-300">Enter your password to confirm:</label>
                                <input type="password" id="delete-password" required class="block w-full bg-red-900 border border-red-700 rounded-md p-3 text-white placeholder-red-400">
                                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-lg transition"><i class="fas fa-bomb mr-2"></i> Permanently Delete Account</button>
                            </form>
                            <p id="delete-message" class="mt-3 text-sm text-center"></p>
                        </div>
                    </section>

                </div>
            </main>
        </div>
    </div>

    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>

    <script type="module">
        // Import all necessary Firebase functions and configuration
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { getAuth, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, updatePassword, updateProfile, linkWithPopup, GoogleAuthProvider, GithubAuthProvider, deleteUser } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js';
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';
        
        // Import Firebase configuration from your file
        import { firebaseConfig } from '../firebase-config.js'; 

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const storage = getStorage(app);
        const db = getFirestore(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const sidebarLinks = document.querySelectorAll('.settings-link');
        const settingsSections = document.querySelectorAll('.settings-section');
        const profileImgPreview = document.getElementById('profile-img-preview');
        
        let currentUser = null;

        // Utility function to show messages
        const showMessage = (elementId, text, type = 'info') => {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = 'mt-3 text-sm text-center';
            if (type === 'success') el.classList.add('text-green-400');
            else if (type === 'error') el.classList.add('text-red-400');
            else el.classList.add('text-gray-400');
        };

        // --- Core Authentication and Redirection Logic (Base Template) ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                console.log("User authenticated. UID:", user.uid);
                
                // Show content and hide loading screen
                loadingScreen.style.display = 'none';
                pageContent.classList.remove('hidden');

                // Load initial user data
                loadUserProfileData(user);

            } else {
                // User is NOT authenticated. Redirect to login/index page.
                console.log("User not authenticated. Redirecting to ../index.html...");
                window.location.href = '../index.html'; 
            }
        });

        // --- SECTION NAVIGATION LOGIC ---
        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = `section-${link.dataset.section}`;
                
                // 1. Update active class on sidebar
                sidebarLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // 2. Show/Hide sections
                settingsSections.forEach(section => {
                    section.classList.add('hidden');
                    if (section.id === targetSectionId) {
                        section.classList.remove('hidden');
                    }
                });
            });
        });

        // --- PROFILE DATA LOAD/SAVE LOGIC ---
        async function loadUserProfileData(user) {
            // Load current username and profile picture
            document.getElementById('current-username').value = user.displayName || 'Set Username';
            profileImgPreview.src = user.photoURL || 'https://via.placeholder.com/150/000000/FFFFFF?text=4SP';
        }

        // 1. Profile Picture Upload Logic
        document.getElementById('pfp-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                // Display preview
                profileImgPreview.src = URL.createObjectURL(file);
                document.getElementById('upload-pfp-btn').classList.remove('hidden');
            }
        });

        document.getElementById('upload-pfp-btn').addEventListener('click', async () => {
            const file = document.getElementById('pfp-upload').files[0];
            if (!file || !currentUser) return;
            
            showMessage('username-message', 'Uploading image...', 'info');

            const imageRef = storageRef(storage, `users/${currentUser.uid}/profile.jpg`);
            
            try {
                // Upload file to Firebase Storage
                const snapshot = await uploadBytes(imageRef, file);
                const photoURL = await getDownloadURL(snapshot.ref);

                // Update Firebase Auth profile
                await updateProfile(currentUser, { photoURL: photoURL });

                showMessage('username-message', 'Profile picture updated successfully!', 'success');
                document.getElementById('upload-pfp-btn').classList.add('hidden');

            } catch (error) {
                console.error("PFP Upload Error:", error);
                showMessage('username-message', `Error uploading picture: ${error.message}`, 'error');
            }
        });


        // 2. Update Username Logic
        document.getElementById('update-username-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const newUsername = document.getElementById('new-username').value.trim();
            if (!newUsername) return;

            try {
                // Update Firebase Auth profile
                await updateProfile(currentUser, { displayName: newUsername });

                // Update Firestore profile (optional, but good practice)
                const userDocRef = doc(db, "users", currentUser.uid);
                await updateDoc(userDocRef, { username: newUsername });
                
                // Update display and show success
                document.getElementById('current-username').value = newUsername;
                showMessage('username-message', 'Username updated successfully!', 'success');
            } catch (error) {
                console.error("Username Update Error:", error);
                showMessage('username-message', `Error: ${error.message}`, 'error');
            }
        });


        // --- SECURITY LOGIC ---

        // 1. Change Password Logic
        document.getElementById('section-security').classList.remove('hidden'); // Show reauth by default
        document.getElementById('password-fields').classList.add('hidden');
        document.getElementById('reauth-required').classList.remove('hidden');

        let reauthenticated = false;

        document.getElementById('reauth-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            const currentPassword = document.getElementById('reauth-password').value;
            if (!currentPassword) return showMessage('password-message', 'Please enter your current password.', 'error');

            try {
                const credential = EmailAuthProvider.credential(currentUser.email, currentPassword);
                await reauthenticateWithCredential(currentUser, credential);
                
                reauthenticated = true;
                document.getElementById('reauth-required').classList.add('hidden');
                document.getElementById('password-fields').classList.remove('hidden');
                showMessage('password-message', 'Re-authentication successful. Enter your new password.', 'success');

            } catch (error) {
                console.error("Re-authentication Error:", error);
                showMessage('password-message', 'Re-authentication failed. Incorrect password or email required.', 'error');
            }
        });

        document.getElementById('change-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser || !reauthenticated) return showMessage('password-message', 'Please re-authenticate first.', 'error');
            
            const newPassword = document.getElementById('new-password').value;
            if (newPassword.length < 6) return showMessage('password-message', 'Password must be at least 6 characters.', 'error');

            try {
                await updatePassword(currentUser, newPassword);
                
                // Reset state after successful change
                reauthenticated = false;
                document.getElementById('reauth-required').classList.remove('hidden');
                document.getElementById('password-fields').classList.add('hidden');
                document.getElementById('reauth-password').value = '';
                document.getElementById('new-password').value = '';

                showMessage('password-message', 'Password updated successfully!', 'success');

            } catch (error) {
                console.error("Password Update Error:", error);
                showMessage('password-message', `Error updating password: ${error.message}`, 'error');
            }
        });

        // 2. Link Providers Logic (Placeholder)
        document.getElementById('link-google-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            try {
                const provider = new GoogleAuthProvider();
                await linkWithPopup(currentUser, provider);
                showMessage('providers-message', 'Google account linked successfully!', 'success');
            } catch (error) {
                console.error("Google Link Error:", error);
                showMessage('providers-message', `Error linking Google: ${error.message}`, 'error');
            }
        });
        
        document.getElementById('link-github-btn').addEventListener('click', async () => {
            if (!currentUser) return;
            try {
                const provider = new GithubAuthProvider();
                await linkWithPopup(currentUser, provider);
                showMessage('providers-message', 'GitHub account linked successfully!', 'success');
            } catch (error) {
                console.error("GitHub Link Error:", error);
                showMessage('providers-message', `Error linking GitHub: ${error.message}`, 'error');
            }
        });


        // --- DELETE ACCOUNT LOGIC ---
        document.getElementById('delete-reauth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const password = document.getElementById('delete-password').value;
            if (!password) return showMessage('delete-message', 'Please enter your password.', 'error');

            try {
                // Re-authenticate before deletion
                const credential = EmailAuthProvider.credential(currentUser.email, password);
                await reauthenticateWithCredential(currentUser, credential);
                
                // Delete user
                await deleteUser(currentUser);

                showMessage('delete-message', 'Account permanently deleted. Redirecting...', 'success');
                // Redirect user after successful deletion
                setTimeout(() => {
                    window.location.href = '../index.html'; 
                }, 2000);

            } catch (error) {
                console.error("Delete Account Error:", error);
                showMessage('delete-message', `Deletion failed: ${error.message}. Please check your password.`, 'error');
            }
        });

        // --- QOL FEATURES (Integration of v4 utilities) ---
        // The logic for 'ban-enforcer.js', 'panic-key.js', and 'url-changer.js' from v4 would be integrated here.
        // The toggle state would be stored in Firestore or Local Storage and loaded/saved by this script.
        // Example: load/save logic for toggle buttons is needed.
        // For brevity, the full v4 script logic is not replicated, but the interface is ready.

    </script>
</body>
</html>

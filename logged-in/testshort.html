<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DAILYPHOTO</title>
    <meta name="description" content="Share your day with friends through three daily photos.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>

    <style>
        /* BUBBLY ANIMATIONS: Keyframes for cute/bubbly effects */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes particleGlow {
            0% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
            50% { box-shadow: 0 0 15px #4f46e5, 0 0 30px #4f46e5; }
            100% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
        }

        /* CUSTOM SCROLLBAR FOR MODERN FEEL */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #3b3b3b;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #111111;
        }
        
        .glow-border {
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5); /* indigo-600 with opacity */
        }
        
        /* Apply font and dark mode defaults */
        body {
            font-family: 'Geist', sans-serif;
            background-color: #0d0d0d;
            color: #f3f4f6;
        }

        .card {
            background-color: #1a1a1a;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            animation: popIn 0.3s ease-out;
        }

        .friend-item {
            padding: 1rem;
            border-radius: 0.75rem;
            background-color: #242424;
            transition: background-color 0.2s;
        }
        .friend-item:hover {
            background-color: #2e2e2e;
        }
        
        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.7);
        }
        
        /* Message box styling */
        .message-box {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            opacity: 0;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            transform: translateX(100%);
        }
        .message-box.show {
            opacity: 1;
            transform: translateX(0);
        }
        .message-box.success {
            background-color: #10b981; /* emerald-500 */
            color: white;
        }
        .message-box.error {
            background-color: #ef4444; /* red-500 */
            color: white;
        }
    </style>
</head>
<body class="min-h-screen pt-16 pb-16">
    <!-- Message Box Container -->
    <div id="message-container" class="message-box transition duration-500 ease-in-out"></div>

    <main class="container mx-auto p-4 md:p-8 max-w-4xl">
        <h1 class="text-4xl md:text-5xl font-extrabold text-indigo-400 mb-6 text-center tracking-tight">
            Daily Photo Share <i class="fas fa-camera-retro text-indigo-500"></i>
        </h1>
        <p class="text-gray-400 text-center mb-10">
            Capture three moments of your day and share them with your friends.
        </p>

        <!-- Main Content Grid -->
        <div id="app-content" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Daily Post Card (Left/Top) -->
            <div id="daily-post-card" class="card rounded-2xl p-6 md:p-8 border border-indigo-700/50">
                <h2 class="text-2xl font-bold mb-5 text-indigo-300 flex items-center">
                    <i class="fas fa-sun mr-3"></i> Your Daily Upload
                </h2>
                
                <div id="post-status-message" class="text-center text-sm mb-4 p-3 rounded-xl bg-green-900/40 text-green-300 hidden"></div>

                <div id="photo-upload-area">
                    <!-- Photo Slots will be inserted here by JS -->
                    <div id="photo-slots" class="space-y-4 mb-6"></div>
                    
                    <button id="submit-post-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 rounded-xl transition duration-200 shadow-xl shadow-indigo-900/50 disabled:bg-gray-700 disabled:shadow-none disabled:cursor-not-allowed flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2"></i> Submit Day's Photos
                    </button>
                </div>
            </div>

            <!-- Friends & Activity Card (Right/Bottom) -->
            <div id="friends-card" class="card rounded-2xl p-6 md:p-8 border border-gray-700">
                <h2 class="text-2xl font-bold mb-5 text-gray-300 flex items-center">
                    <i class="fas fa-user-friends mr-3"></i> Friends & Feed
                </h2>
                
                <!-- Add Friend Section -->
                <div class="mb-6 pb-4 border-b border-gray-700">
                    <h3 class="text-xl font-semibold mb-3 text-gray-400">Add Friend by User ID</h3>
                    <div id="add-friend-message" class="text-sm p-3 rounded-xl mb-3 hidden"></div>
                    <form id="add-friend-form" class="flex flex-col sm:flex-row gap-2">
                        <input type="text" id="friend-uid-input" placeholder="Paste friend's User ID" required class="flex-grow p-3 rounded-xl bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 placeholder-gray-400 text-white">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white font-semibold py-3 px-4 rounded-xl transition duration-200 flex items-center justify-center sm:w-auto">
                            <i class="fas fa-user-plus mr-1"></i> Add
                        </button>
                    </form>
                    <p class="text-xs text-gray-500 mt-2">Your User ID (for sharing): <code id="my-user-id" class="select-all font-mono text-indigo-400">Loading...</code></p>
                </div>

                <!-- Friends List -->
                <div class="mb-6">
                    <h3 class="text-xl font-semibold mb-3 text-gray-400">My Friends (<span id="friend-count">0</span>)</h3>
                    <div id="friends-list-container" class="space-y-3 max-h-64 overflow-y-auto pr-2">
                        <p id="friends-list-loading" class="text-gray-500">Loading friends list...</p>
                        <!-- Friends will be loaded here -->
                    </div>
                </div>

                <!-- Daily Feed Preview -->
                <div>
                    <h3 class="text-xl font-semibold mb-3 text-gray-400">Friend Activity</h3>
                    <div id="feed-container" class="space-y-4">
                        <div class="p-4 rounded-xl bg-gray-700 text-gray-400 flex items-center">
                            <i class="fas fa-lock mr-3"></i> Feed requires friends to share their daily posts.
                        </div>
                    </div>
                </div>

            </div>

        </div>
    </main>

    <!-- Modal for Large Image View -->
    <div id="image-modal" class="modal-backdrop fixed inset-0 flex items-center justify-center p-4 hidden transition-opacity duration-300 opacity-0" onclick="closeModal()">
        <div class="relative w-full max-w-2xl max-h-full" onclick="event.stopPropagation()">
            <img id="modal-image" src="" alt="Full-size daily photo" class="w-full h-auto object-contain rounded-xl glow-border">
            <button onclick="closeModal()" class="absolute top-2 right-2 text-white bg-black/50 hover:bg-black/70 rounded-full p-2 transition">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>


    <!-- Firebase/Utility Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            onSnapshot, 
            updateDoc, 
            arrayUnion, 
            arrayRemove,
            collection,
            query,
            where,
            getDocs,
            writeBatch,
            Timestamp 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        
        // --- GLOBAL SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, storage;
        let userId = null;
        let isAuthenticated = false;
        let userProfileCache = {}; // Cache for friend profiles

        // Firestore paths
        const getUserProfileDocRef = (uid) => doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
        const getDailyPostDocRef = (uid, dateKey) => doc(db, 'artifacts', appId, 'public', 'data', 'daily_posts', `${uid}_${dateKey}`);
        
        // Utility Functions
        const todayKey = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        const getFileRef = (uid, fileIndex) => ref(storage, `user_daily_photos/${uid}/${todayKey}_${fileIndex}.png`);

        /**
         * Shows a transient message box notification.
         * @param {HTMLElement} container The element to display the message in.
         * @param {string} message The message text.
         * @param {'success'|'error'|'info'} type The type of message.
         */
        function showMessage(container, message, type = 'info') {
            const messageBox = document.getElementById('message-container');
            messageBox.textContent = message;
            messageBox.className = `message-box ${type} show`;
            
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000); // Hide after 3 seconds
        }

        /**
         * Converts a File object to a data URL (base64 string).
         * @param {File} file 
         * @returns {Promise<string>} Base64 data URL
         */
        function fileToDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }
        
        // --- MODAL HANDLERS ---
        const imageModal = document.getElementById('image-modal');
        const modalImage = document.getElementById('modal-image');

        window.openModal = function(imageUrl) {
            modalImage.src = imageUrl;
            imageModal.classList.remove('hidden', 'opacity-0');
            imageModal.classList.add('flex');
            // Little trick to ensure opacity transition runs after flex is applied
            setTimeout(() => {
                imageModal.classList.remove('opacity-0');
            }, 10);
        }

        window.closeModal = function() {
            imageModal.classList.add('opacity-0');
            setTimeout(() => {
                imageModal.classList.add('hidden');
                imageModal.classList.remove('flex');
                modalImage.src = ''; // Clear image source
            }, 300);
        }


        // --- AUTH & INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            // 1. Initialize Firebase
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);
            } catch (e) {
                console.error("Firebase initialization failed:", e);
                showMessage(document.body, "Failed to initialize the app. Check console for details.", 'error');
                return;
            }

            // 2. Handle Authentication
            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Error signing in with custom token:", error);
                    // Fallback to anonymous sign-in if custom token fails
                    await signInAnonymously(auth);
                }
            } else {
                // If no custom token, sign in anonymously
                await signInAnonymously(auth);
            }

            // 3. Wait for Auth State
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthenticated = !user.isAnonymous; // Assume authenticated if not anonymous
                    document.getElementById('my-user-id').textContent = userId;

                    // Start fetching user-specific data
                    setupDailyPostFeature(user);
                    setupFriendsFeature(user);
                    setupFeedFeature(user);

                } else {
                    // User is signed out (this should rarely happen if we force sign-in)
                    userId = null;
                    isAuthenticated = false;
                    document.getElementById('my-user-id').textContent = 'Please log in.';
                    // Optionally disable features or redirect
                }
            });
        });

        // --- DAILY POST FEATURE ---

        let postState = [null, null, null]; // [File, File, File] or [URL, URL, URL]
        let postIsFinalized = false;
        
        const updatePostButtonState = () => {
            const submitBtn = document.getElementById('submit-post-btn');
            const hasAllThreeFiles = postState.filter(item => item instanceof File).length === 3;
            
            if (postIsFinalized) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-check-circle mr-2"></i> Posted for Today!';
                submitBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-500');
                submitBtn.classList.add('bg-green-600', 'hover:bg-green-500');
            } else if (hasAllThreeFiles) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Submit Day\'s Photos';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            } else {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-camera-retro mr-2"></i> Upload All 3 Photos';
                submitBtn.classList.remove('bg-green-600', 'hover:bg-green-500');
                submitBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-500');
            }
        };
        
        /** Renders the photo slots and their current state (input or preview). */
        const renderPhotoSlots = async (user) => {
            const container = document.getElementById('photo-slots');
            container.innerHTML = '';
            
            const postLabels = ["The Morning Vibe", "Midday Moment", "Evening Reflection"];

            for (let i = 0; i < 3; i++) {
                const currentItem = postState[i];
                const label = postLabels[i];
                const slotDiv = document.createElement('div');
                slotDiv.className = 'p-4 rounded-xl border border-gray-700/50 transition duration-300';
                
                if (postIsFinalized && currentItem) {
                    // Finalized Post: Show Image Preview
                    slotDiv.className += ' bg-indigo-900/10 hover:border-indigo-500/50 cursor-pointer';
                    slotDiv.innerHTML = `
                        <h4 class="text-sm font-medium text-indigo-300 mb-2">${label}</h4>
                        <div class="relative w-full h-32 bg-gray-700 rounded-lg overflow-hidden flex items-center justify-center" onclick="openModal('${currentItem}')">
                            <img src="${currentItem}" alt="Daily Photo ${i + 1}" class="object-cover w-full h-full opacity-0 transition duration-500">
                            <i class="fas fa-expand absolute text-3xl text-white/50 hover:text-white/80 transition"></i>
                        </div>
                    `;
                    // Wait for img to load before showing it and removing the icon
                    const img = slotDiv.querySelector('img');
                    const icon = slotDiv.querySelector('.fa-expand');
                    img.onload = () => {
                        img.classList.remove('opacity-0');
                        icon.classList.add('hidden');
                    };
                } else if (currentItem instanceof File) {
                    // Pending Upload: Show File Preview and Remove Button
                    const dataUrl = await fileToDataUrl(currentItem);
                    slotDiv.className += ' bg-gray-800/50 border-green-500/50';
                    slotDiv.innerHTML = `
                        <h4 class="text-sm font-medium text-green-400 mb-2">${label} <i class="fas fa-check-circle ml-1"></i></h4>
                        <div class="relative flex items-center">
                            <img src="${dataUrl}" alt="Preview" class="w-16 h-16 object-cover rounded-lg mr-4 border border-green-500">
                            <span class="text-white text-sm truncate flex-grow">${currentItem.name}</span>
                            <button data-index="${i}" class="remove-photo-btn text-red-400 hover:text-red-500 transition p-1 rounded-full bg-gray-700/50" title="Remove Photo">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    // Attach removal handler
                    slotDiv.querySelector('.remove-photo-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        const index = parseInt(e.currentTarget.dataset.index);
                        postState[index] = null;
                        renderPhotoSlots(user);
                        updatePostButtonState();
                    });
                } else {
                    // Empty Slot: Show Upload Input
                    slotDiv.className += ' bg-gray-800 hover:border-indigo-500';
                    slotDiv.innerHTML = `
                        <h4 class="text-sm font-medium text-gray-400 mb-2">${label}</h4>
                        <label class="block cursor-pointer border-2 border-dashed border-gray-600 hover:border-indigo-500 p-4 rounded-xl text-center transition duration-200">
                            <i class="fas fa-cloud-upload-alt text-2xl text-indigo-400 mb-1"></i>
                            <p class="text-sm text-gray-300">Click to upload photo ${i + 1}</p>
                            <input type="file" accept="image/*" data-index="${i}" class="photo-input hidden">
                        </label>
                    `;
                    // Attach file input handler
                    slotDiv.querySelector('.photo-input').addEventListener('change', (e) => {
                        const file = e.target.files[0];
                        const index = parseInt(e.target.dataset.index);
                        if (file) {
                            postState[index] = file;
                            renderPhotoSlots(user);
                            updatePostButtonState();
                        }
                    });
                }
                container.appendChild(slotDiv);
            }
        };

        /** Listens for the current user's post for today. */
        const listenForDailyPost = (user) => {
            const postDocRef = getDailyPostDocRef(user.uid, todayKey);
            
            onSnapshot(postDocRef, (docSnap) => {
                const statusMessage = document.getElementById('post-status-message');
                const uploadArea = document.getElementById('photo-upload-area');
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Post exists and is finalized
                    postState = [data.photoUrl1, data.photoUrl2, data.photoUrl3];
                    postIsFinalized = true;
                    
                    statusMessage.classList.remove('hidden');
                    statusMessage.textContent = `âœ… Your daily post is live! Shared at ${new Date(data.timestamp.toDate()).toLocaleTimeString()}.`;
                    
                    // Hide the file input area and show the post
                    renderPhotoSlots(user);
                    updatePostButtonState();
                } else {
                    // No post yet
                    postIsFinalized = false;
                    statusMessage.classList.add('hidden');
                    // Reset or initialize file inputs
                    postState = postState.map(item => item instanceof File ? item : null);
                    renderPhotoSlots(user);
                    updatePostButtonState();
                }
            }, (error) => {
                console.error("Error listening to daily post:", error);
                showMessage(document.getElementById('daily-post-card'), 'Failed to load daily post status.', 'error');
            });
        };
        
        /** Handles the submission process: uploads files and saves Firestore document. */
        const handleSubmitPost = async (user) => {
            if (postIsFinalized) return;
            
            const submitBtn = document.getElementById('submit-post-btn');
            submitBtn.disabled = true;
            const originalHtml = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
            
            const photoUrls = [];

            try {
                // 1. Upload all three files to Storage
                for (let i = 0; i < 3; i++) {
                    const file = postState[i];
                    if (file instanceof File) {
                        const fileRef = getFileRef(user.uid, i + 1);
                        await uploadBytes(fileRef, file);
                        const url = await getDownloadURL(fileRef);
                        photoUrls.push(url);
                    } else {
                        throw new Error(`Photo ${i + 1} is missing.`);
                    }
                }
                
                // 2. Save post document to Firestore
                const postData = {
                    uid: user.uid,
                    dateKey: todayKey,
                    timestamp: Timestamp.now(),
                    photoUrl1: photoUrls[0],
                    photoUrl2: photoUrls[1],
                    photoUrl3: photoUrls[2],
                };
                
                await setDoc(getDailyPostDocRef(user.uid, todayKey), postData);
                
                showMessage(document.getElementById('daily-post-card'), 'Photos posted successfully!', 'success');
                // The onSnapshot listener will handle the UI update (postIsFinalized = true)
                
            } catch (error) {
                console.error("Post submission failed:", error);
                showMessage(document.getElementById('daily-post-card'), 'Error posting photos. See console.', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalHtml;
            }
        };

        const setupDailyPostFeature = (user) => {
            listenForDailyPost(user);
            document.getElementById('submit-post-btn').addEventListener('click', (e) => {
                e.preventDefault();
                handleSubmitPost(user);
            });
        };

        // --- FRIENDS FEATURE ---

        /** Updates the friend count and initiates the friend list listener. */
        const setupFriendsFeature = (user) => {
            const profileDocRef = getUserProfileDocRef(user.uid);
            
            // Listen for changes to the user's friend list
            onSnapshot(profileDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const friendsUids = data.friends || [];
                    document.getElementById('friend-count').textContent = friendsUids.length;
                    
                    // Update the cache and then render the list
                    updateFriendProfileCache(friendsUids).then(() => {
                        renderFriendsList(user, friendsUids);
                    });

                } else {
                    document.getElementById('friend-count').textContent = '0';
                    console.warn("User profile document not found. Cannot load friends list.");
                }
            }, (error) => {
                console.error("Error listening to profile/friends:", error);
            });
            
            // Setup the Add Friend Form
            const addFriendForm = document.getElementById('add-friend-form');
            addFriendForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleFriendRequest(user);
            });
        };

        /** Updates the local cache with the latest profiles of all friends. */
        const updateFriendProfileCache = async (friendsUids) => {
            const promises = friendsUids.map(uid => getDoc(getUserProfileDocRef(uid)));
            const snaps = await Promise.all(promises);

            snaps.forEach(snap => {
                if (snap.exists()) {
                    userProfileCache[snap.id] = snap.data();
                } else {
                    // Remove from cache if profile doesn't exist
                    delete userProfileCache[snap.id];
                }
            });
        };


        /** Renders the list of current friends. */
        const renderFriendsList = (user, friendsUids) => {
            const container = document.getElementById('friends-list-container');
            container.innerHTML = '';
            document.getElementById('friends-list-loading').classList.add('hidden');
            
            if (friendsUids.length === 0) {
                container.innerHTML = '<p class="text-gray-500 p-3 text-center bg-gray-800/50 rounded-lg">You have no friends yet. Add one above!</p>';
                return;
            }

            // Create friend list items
            friendsUids.forEach(friendUid => {
                const profile = userProfileCache[friendUid];
                const username = profile ? profile.username : `User ID: ${friendUid.substring(0, 8)}...`;
                
                const div = document.createElement('div');
                div.className = 'friend-item flex justify-between items-center';
                div.innerHTML = `
                    <span class="font-semibold">${username}</span>
                    <button data-uid="${friendUid}" class="remove-friend-btn text-red-400 hover:text-red-500 transition px-2 py-1" title="Remove Friend">
                        <i class="fas fa-user-minus"></i>
                    </button>
                `;
                container.appendChild(div);
            });

            // Attach remove friend handlers
            container.querySelectorAll('.remove-friend-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    e.preventDefault();
                    // Find the closest button element to ensure the click target is correct
                    const friendUidToRemove = e.target.closest('button').dataset.uid;
                    
                    const batch = writeBatch(db);
                    // Remove from current user's friends list
                    batch.update(getUserProfileDocRef(user.uid), { friends: arrayRemove(friendUidToRemove) });
                    // Remove current user from friend's friends list (symmetric removal)
                    batch.update(getUserProfileDocRef(friendUidToRemove), { friends: arrayRemove(user.uid) });
                    await batch.commit();

                    showMessage(document.getElementById('add-friend-message'), 'Friend removed successfully!', 'success');
                });
            });
        };

        /** Handles the logic for adding a friend by UID. */
        const handleFriendRequest = async (user) => {
            const friendUidInput = document.getElementById('friend-uid-input');
            const addFriendMessage = document.getElementById('add-friend-message');
            const friendUid = friendUidInput.value.trim();
            addFriendMessage.classList.add('hidden');

            if (!friendUid) {
                showMessage(addFriendMessage, 'Please enter a valid User ID.', 'error');
                return;
            }
            if (friendUid === user.uid) {
                showMessage(addFriendMessage, "You can't add yourself as a friend!", 'error');
                return;
            }

            try {
                // 1. Check if the target user exists
                const friendProfileSnap = await getDoc(getUserProfileDocRef(friendUid));

                if (!friendProfileSnap.exists()) {
                    showMessage(addFriendMessage, 'Error: User ID not found.', 'error');
                    return;
                }
                
                const friendProfileData = friendProfileSnap.data();
                const myProfileSnap = await getDoc(getUserProfileDocRef(user.uid));
                const myProfileData = myProfileSnap.data();
                
                // 2. Check if already friends
                if (myProfileData.friends && myProfileData.friends.includes(friendUid)) {
                    showMessage(addFriendMessage, `${friendProfileData.username || friendUid} is already your friend!`, 'info');
                    return;
                }

                // 3. Perform the symmetric friend addition
                const batch = writeBatch(db);
                // Add to current user's friends list
                batch.update(getUserProfileDocRef(user.uid), { friends: arrayUnion(friendUid) });
                // Add current user to friend's friends list (symmetric addition)
                batch.update(getUserProfileDocRef(friendUid), { friends: arrayUnion(user.uid) });
                await batch.commit();

                showMessage(addFriendMessage, `Added ${friendProfileData.username || friendUid} as a friend!`, 'success');
                friendUidInput.value = ''; // Clear input

            } catch (error) {
                console.error("Error adding friend:", error);
                showMessage(addFriendMessage, 'An error occurred while adding the friend.', 'error');
            }
        };
        
        // --- FEED FEATURE ---

        /** Sets up the listener for friends' daily posts. */
        const setupFeedFeature = (user) => {
            const profileDocRef = getUserProfileDocRef(user.uid);
            
            // Listen to the current user's profile to get the list of friends
            onSnapshot(profileDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const friendsUids = data.friends || [];
                    
                    if (friendsUids.length > 0) {
                        listenForFriendsPosts(friendsUids);
                    } else {
                        document.getElementById('feed-container').innerHTML = `
                            <div class="p-4 rounded-xl bg-gray-700 text-gray-400 flex items-center">
                                <i class="fas fa-lock mr-3"></i> Feed requires friends. Add one to see activity!
                            </div>
                        `;
                    }
                }
            }, (error) => {
                console.error("Error getting friend list for feed:", error);
            });
        };

        /** Listens for all friends' daily posts. */
        const listenForFriendsPosts = (friendsUids) => {
            const feedContainer = document.getElementById('feed-container');
            const todayKey = new Date().toISOString().slice(0, 10);
            
            // Create a query to find all posts made today by any of the friends
            // Firestore only allows 'in' queries on a maximum of 10 items. 
            // For a larger number of friends, a different structure (like a 'feed' collection) would be better.
            if (friendsUids.length > 10) {
                 feedContainer.innerHTML = `
                    <div class="p-4 rounded-xl bg-red-900/40 text-red-300">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Only showing posts from the first 10 friends due to technical limitations.
                    </div>
                `;
                friendsUids = friendsUids.slice(0, 10);
            }

            // Create an array of UID_DateKey strings to query
            const postKeysToFetch = friendsUids.map(uid => `${uid}_${todayKey}`);
            
            // This query is less efficient than a dedicated feed collection but works for small friend lists
            const postsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'daily_posts');
            const q = query(postsColRef, where('dateKey', '==', todayKey));
            
            onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    const post = doc.data();
                    // Manually filter to only include posts from friends (since we can't query 'in' on the uid field directly)
                    if (friendsUids.includes(post.uid)) {
                        posts.push(post);
                    }
                });

                renderFeed(posts);
            }, (error) => {
                console.error("Error listening to friend posts:", error);
                feedContainer.innerHTML = `
                    <div class="p-4 rounded-xl bg-red-900/40 text-red-300">
                        <i class="fas fa-exclamation-triangle mr-2"></i> Failed to load friend feed.
                    </div>
                `;
            });
        };
        
        /** Renders the feed from an array of post objects. */
        const renderFeed = (posts) => {
            const feedContainer = document.getElementById('feed-container');
            feedContainer.innerHTML = '';

            if (posts.length === 0) {
                feedContainer.innerHTML = `
                    <div class="p-4 rounded-xl bg-gray-700 text-gray-400 flex items-center">
                        <i class="fas fa-camera mr-3"></i> None of your friends have posted yet today.
                    </div>
                `;
                return;
            }

            // Sort posts by timestamp descending
            posts.sort((a, b) => b.timestamp.toMillis() - a.timestamp.toMillis());

            posts.forEach(post => {
                const friendProfile = userProfileCache[post.uid];
                const username = friendProfile ? friendProfile.username : `User ID: ${post.uid.substring(0, 8)}...`;
                
                const postTime = new Date(post.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                const postElement = document.createElement('div');
                postElement.className = 'card rounded-xl p-4 border border-indigo-900/50';
                postElement.innerHTML = `
                    <div class="flex items-center mb-3">
                        <i class="fas fa-user-circle text-2xl text-indigo-400 mr-2"></i>
                        <span class="font-bold text-indigo-300">${username}</span>
                        <span class="ml-auto text-xs text-gray-500">${postTime}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-2">
                        ${[post.photoUrl1, post.photoUrl2, post.photoUrl3].map((url, index) => `
                            <div class="relative bg-gray-800 rounded-lg overflow-hidden h-24 sm:h-32" onclick="openModal('${url}')">
                                <img src="${url}" alt="Friend's Photo ${index + 1}" class="object-cover w-full h-full cursor-pointer transition duration-300 hover:scale-[1.03]">
                                <span class="absolute top-1 left-1 bg-black/50 text-white text-xs px-1 rounded-md">#${index + 1}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
                feedContainer.appendChild(postElement);
            });
        };
        
    </script>
</body>
</html>

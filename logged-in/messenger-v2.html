<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Messenger V2</title>
    <meta name="description" content="A secure, peer-to-peer messenger with group chat functionality, image sharing, and hybrid message storage.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-SBGEJDRSBZ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-SBGEJDRSBZ');
    </script>

    <style>
        /* --- FONT & BASE STYLING --- */
        :root {
            --padding-base: 1.25rem;
            --highlight-purple: #4f46e5;
            --standard-roundness: 0.5rem; /* rounded-lg (8px) */
        }
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        /* SCROLLBAR STYLING - For a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111111;
        }
        ::-webkit-scrollbar-thumb {
            background: #333333;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555555;
        }

        /* --- Custom Button & Menu Styling (Consistent Roundness: 0.5rem/rounded-lg) --- */
        .custom-btn {
            background-color: #1a1a1a; 
            border: 1px solid #2d2d2d; 
            color: #c0c0c0;
            padding: 0.5rem 1rem;
            border-radius: var(--standard-roundness);
            transition: all 0.15s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 400;
        }
        .custom-btn:hover {
            background-color: #2a2a2a;
            border-color: var(--highlight-purple);
            color: white;
        }
        .custom-btn.primary {
            background-color: var(--highlight-purple);
            border-color: var(--highlight-purple);
            color: white;
        }
        
        .custom-menu {
            background-color: #1a1a1a;
            border: 1px solid #2d2d2d;
            border-radius: var(--standard-roundness);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.5);
            padding: 0.25rem 0;
            z-index: 50;
        }
        .custom-menu-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: background-color 0.1s;
        }

        /* --- Highlight/Active Tab Styling --- */
        .compact-list-item {
            background-color: transparent; 
            border-radius: var(--standard-roundness);
            margin-bottom: 0.25rem;
            padding: 0.75rem 0.75rem; 
            border-left: 3px solid transparent;
        }
        .compact-list-item.active {
            background-color: rgba(79, 70, 229, 0.1);
            border-left: 3px solid var(--highlight-purple);
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border: 1px solid transparent; 
            border-radius: var(--standard-roundness);
        }
        .tab-btn.active {
            background-color: rgba(79, 70, 229, 0.1);
            color: var(--highlight-purple);
            border: 1px solid var(--highlight-purple);
        }

        /* --- Input fields and containers with consistent roundness --- */
        .rounded-container {
             border-radius: var(--standard-roundness);
        }
        input[type="text"], textarea {
            border-radius: var(--standard-roundness) !important;
        }
        input[type="text"], textarea, .custom-textarea {
            border-radius: var(--standard-roundness) !important;
            min-height: 40px; /* Ensure minimum height */
        }
        
        /* Message Bubbles */
        .message-bubble {
            max-width: 80%;
            padding: 0.75rem;
            border-radius: var(--standard-roundness);
            word-break: break-word;
            overflow-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* Outgoing (User's) messages */
        .message-outgoing .message-bubble {
            background-color: var(--highlight-purple); 
            color: white;
            border-bottom-right-radius: 0; 
        }

        /* Incoming (Other user's) messages */
        .message-incoming .message-bubble {
            background-color: #1a1a1a; 
            color: #c0c0c0;
            border-bottom-left-radius: 0;
        }

        /* --- Modal and Backdrop --- */
        .custom-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .custom-modal-backdrop.show {
            opacity: 1;
        }
        .custom-modal-content {
            background-color: #070707;
            border: 1px solid #2d2d2d;
            border-radius: 0.75rem; /* Slightly larger roundness for the main container */
            padding: 1.5rem;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        .custom-modal-backdrop.show .custom-modal-content {
            transform: translateY(0);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <div id="navbar-container" class="sticky top-0 z-10 w-full">
        <nav class="bg-[#0e0e0e] border-b border-[#2d2d2d] p-4 flex items-center justify-between">
            <h1 class="text-xl font-bold text-white">4SP Messenger</h1>
            <div id="auth-status-icon">
                <i class="fas fa-user-circle text-white"></i>
            </div>
        </nav>
    </div>

    <!-- Main Content Area -->
    <main class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar: Chat List -->
        <div id="sidebar" class="w-full md:w-80 border-r border-[#2d2d2d] flex flex-col bg-[#0e0e0e] md:flex-shrink-0">
            
            <!-- User ID and Live Clock (Consistent roundness applied) -->
            <div class="p-4 border-b border-[#2d2d2d] bg-[#111111] space-y-2 rounded-container m-2">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-white">Your Public ID:</span>
                    <span id="user-id-display" class="bg-[#2d2d2d] text-xs px-2 py-1 rounded-lg text-purple-300 font-mono select-all">Loading...</span>
                </div>
                <div class="flex items-center justify-between">
                    <span class="text-sm font-semibold text-white">Current Time:</span>
                    <span id="current-time-display" class="text-lg font-mono text-gray-300">HH:MM:SS</span>
                </div>
            </div>

            <!-- Sidebar Controls -->
            <div class="p-4 border-b border-[#2d2d2d] flex flex-col space-y-3">
                
                <!-- Search Box (Consistent roundness applied) -->
                <div class="relative">
                    <input type="text" id="chat-search-input" placeholder="Search chats..." class="w-full bg-[#1a1a1a] border border-[#2d2d2d] text-sm p-2.5 text-white placeholder-gray-500 focus:ring-purple-500 focus:border-purple-500 transition duration-150">
                    <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>

                <!-- Tabs (DM/Group) & Action Buttons (Consistent roundness applied) -->
                <div class="flex space-x-2 text-sm text-gray-400">
                    <button id="dm-tab-btn" class="tab-btn active">Direct Messages</button>
                    <button id="group-tab-btn" class="tab-btn">Group Chats</button>
                    <!-- Add Friend Button -->
                    <button id="add-friend-btn" class="ml-auto custom-btn !p-2 !text-xs !rounded-lg" title="Add Friend">
                        <i class="fas fa-user-plus"></i>
                    </button>
                    <!-- Create Chat Button -->
                    <button id="create-chat-btn" class="custom-btn !p-2 !text-xs !rounded-lg" title="New Chat/Group">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Chat List Container -->
            <div id="chat-list-container" class="flex-1 overflow-y-auto p-2 space-y-1">
                <div class="text-center p-4 text-gray-500">Authenticating...</div>
            </div>
        </div>

        <!-- Main Chat Container -->
        <div id="chat-main" class="flex-1 flex flex-col bg-[#070707]">
            
            <!-- Chat Header (Consistent roundness applied via container) -->
            <div id="chat-header" class="w-full border-b border-[#2d2d2d] p-4 flex items-center justify-between bg-[#0e0e0e] hidden">
                <div class="flex items-center space-x-3">
                    <div id="chat-avatar" class="w-10 h-10 rounded-lg bg-gray-600 flex items-center justify-center text-white font-semibold">U</div>
                    <div>
                        <div id="chat-title" class="text-white font-semibold text-lg">Chat Title</div>
                        <div id="chat-subtitle" class="text-gray-400 text-xs">Subtitle/Status</div>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="open-settings-btn" class="custom-btn !p-2 !rounded-lg" title="Chat Settings"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <!-- Messages Area -->
            <div id="messages-container" class="flex-1 overflow-y-auto p-4 flex flex-col space-y-3">
                <!-- Initial Placeholder -->
                <div class="flex justify-center items-center h-full">
                    <p class="text-gray-500">Select a chat to begin messaging.</p>
                </div>
            </div>
            
            <!-- Scroll to Bottom Button -->
            <button id="scroll-to-bottom-btn" class="custom-btn !p-3 !rounded-full fixed bottom-24 right-6 shadow-xl hidden transition-opacity duration-300 z-20">
                <i class="fas fa-arrow-down"></i>
            </button>

            <!-- Message Input Area -->
            <div id="message-input-area" class="w-full border-t border-[#2d2d2d] p-4 bg-[#0e0e0e] hidden">
                <div class="flex items-end space-x-3">
                    
                    <!-- File Attachment Button & Menu (Consistent roundness applied) -->
                    <div class="relative">
                        <button id="open-file-menu-btn" class="custom-btn !p-3 !rounded-lg !bg-transparent !border-none !text-gray-400 hover:!text-white" title="Attach File">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <div id="file-menu" class="custom-menu absolute bottom-full left-0 mb-2 w-48 hidden">
                            <label for="image-upload-input" class="custom-menu-item flex items-center space-x-2 rounded-lg">
                                <i class="fas fa-image w-4"></i> <span>Send Image</span>
                                <input type="file" id="image-upload-input" accept="image/*" class="hidden">
                            </label>
                            <label for="file-upload-input" class="custom-menu-item flex items-center space-x-2 rounded-lg">
                                <i class="fas fa-file w-4"></i> <span>Send File</span>
                                <input type="file" id="file-upload-input" class="hidden">
                            </label>
                        </div>
                    </div>

                    <!-- Input Box (Consistent roundness applied) -->
                    <textarea id="message-input" rows="1" placeholder="Type a message..." class="flex-1 bg-[#1a1a1a] border border-[#2d2d2d] text-sm p-3 resize-none text-white placeholder-gray-500 focus:ring-purple-500 focus:border-purple-500 transition duration-150 custom-textarea"></textarea>
                    
                    <!-- Send Button (Consistent roundness applied) -->
                    <button id="send-btn" class="custom-btn primary !p-3 !rounded-lg" disabled title="Send Message">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <!-- Character/Attachment Status -->
                <div class="flex justify-between items-center mt-2 px-2 text-xs text-gray-500">
                    <span id="attached-file-status" class="truncate max-w-[70%] hidden"></span>
                    <span id="character-count-display" class="ml-auto">0/2000</span>
                </div>
            </div>
        </div>
    </main>

    <!-- --- MODALS (CUSTOM UI) --- -->

    <!-- Add Friend Modal -->
    <div id="add-friend-modal-backdrop" class="custom-modal-backdrop">
        <div id="add-friend-modal-content" class="custom-modal-content w-[400px]">
            <h2 class="text-xl font-bold mb-4 text-white">Add Friend by ID</h2>
            <div class="space-y-4">
                <input type="text" id="friend-id-input" placeholder="Enter friend's 8-character ID" maxlength="8" class="w-full bg-[#1a1a1a] border border-[#2d2d2d] text-sm p-2.5 text-white placeholder-gray-500">
                <p id="add-friend-status" class="text-sm text-gray-400">Friend requests are sent using their 8-character Public User ID. (Case-sensitive)</p>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="add-friend-cancel-btn" class="custom-btn">Cancel</button>
                <button id="add-friend-confirm-btn" class="custom-btn primary">Send Request</button>
            </div>
        </div>
    </div>

    <!-- Create Chat Modal -->
    <div id="create-chat-modal-backdrop" class="custom-modal-backdrop">
        <div id="create-chat-modal-content" class="custom-modal-content w-[400px]">
            <h2 class="text-xl font-bold mb-4 text-white">Create New Chat</h2>
            <div class="space-y-4">
                <input type="text" id="new-chat-name" placeholder="Chat Name (e.g., Jane Doe, Study Group)" class="w-full bg-[#1a1a1a] border border-[#2d2d2d] text-sm p-2.5 text-white placeholder-gray-500">
                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="is-group-chat" class="w-4 h-4 text-purple-600 bg-gray-700 border-gray-600 rounded focus:ring-purple-500">
                    <label for="is-group-chat" class="text-sm text-gray-300">Create as Group Chat</label>
                </div>
            </div>
            <div class="flex justify-end mt-6 space-x-3">
                <button id="create-chat-cancel-btn" class="custom-btn">Cancel</button>
                <button id="create-chat-confirm-btn" class="custom-btn primary">Create</button>
            </div>
        </div>
    </div>

    <!-- Chat Settings Modal -->
    <div id="settings-modal-backdrop" class="custom-modal-backdrop">
        <div id="settings-modal-content" class="custom-modal-content w-[400px]">
            <h2 class="text-xl font-bold mb-4 text-white">Chat Settings</h2>
            <div id="settings-content">
                <p>Chat settings will load here...</p>
            </div>
            <div class="flex justify-end mt-6">
                <button id="settings-modal-close-btn" class="custom-btn primary">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Image Lightbox Modal -->
    <div id="image-lightbox" class="custom-modal-backdrop" style="background-color: rgba(0, 0, 0, 0.95);">
        <div class="custom-modal-content !p-0 max-w-[95vw] max-h-[95vh] flex items-center justify-center bg-transparent border-none shadow-none">
            <img id="lightbox-image" src="" alt="Full size attachment" class="max-w-full max-h-full object-contain rounded-lg">
        </div>
    </div>


    <!-- --- JAVASCRIPT LOGIC (Module for Firebase) --- -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: Added setDoc and getDoc for profile creation/retrieval
        import { getFirestore, doc, onSnapshot, collection, query, orderBy, setDoc, getDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- MANDATORY GLOBALS & FIREBASE SETUP ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = {
          apiKey: "AIzaSyASqfiYUPf7xY4wgZ0hLl8_Z0ZkBiwFUO8",
          authDomain: "theamericanmessenger-0.firebaseapp.com",
          databaseURL: "https://theamericanmessenger-0-default-rtdb.firebaseio.com",
          projectId: "theamericanmessenger-0",
          storageBucket: "theamericanmessenger-0.firebasestorage.app",
          messagingSenderId: "963196851685",
          appId: "1:963196851685:web:9f709be8b2888ed4e28b0c",
          measurementId: "G-SBGEJDRSBZ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Set Firebase logging for debugging purposes
        setLogLevel('debug');

        // Global Firebase instances
        let app, db, auth;
        let userId; // This holds the DISPLAYED 8-character ID (publicId stored in Firestore)
        let firestoreUserUid; // This holds the actual Firebase UID for private paths

        // State variables
        let currentUser = null;
        let currentChat = { id: null, type: null };
        let unsubscribeChats = () => {};
        let unsubscribeMessages = () => {};

        // Constants
        const MESSAGE_CHARACTER_LIMIT = 2000;
        
        // DOM Element Mapping
        const dom = {
            chatListContainer: document.getElementById('chat-list-container'),
            messagesContainer: document.getElementById('messages-container'),
            chatHeader: document.getElementById('chat-header'),
            chatTitle: document.getElementById('chat-title'),
            chatSubtitle: document.getElementById('chat-subtitle'),
            messageInputArea: document.getElementById('message-input-area'),
            messageInput: document.getElementById('message-input'),
            sendBtn: document.getElementById('send-btn'),
            dmTabBtn: document.getElementById('dm-tab-btn'),
            groupTabBtn: document.getElementById('group-tab-btn'),
            createChatBtn: document.getElementById('create-chat-btn'),
            addFriendBtn: document.getElementById('add-friend-btn'),
            createChatModalBackdrop: document.getElementById('create-chat-modal-backdrop'),
            addFriendModalBackdrop: document.getElementById('add-friend-modal-backdrop'),
            addFriendCancelBtn: document.getElementById('add-friend-cancel-btn'),
            addFriendConfirmBtn: document.getElementById('add-friend-confirm-btn'),
            friendIdInput: document.getElementById('friend-id-input'),
            createChatCancelBtn: document.getElementById('create-chat-cancel-btn'),
            createChatConfirmBtn: document.getElementById('create-chat-confirm-btn'),
            newChatName: document.getElementById('new-chat-name'),
            isGroupChat: document.getElementById('is-group-chat'),
            openSettingsBtn: document.getElementById('open-settings-btn'),
            settingsModalBackdrop: document.getElementById('settings-modal-backdrop'),
            settingsModalCloseBtn: document.getElementById('settings-modal-close-btn'),
            imageLightbox: document.getElementById('image-lightbox'),
            lightboxImage: document.getElementById('lightbox-image'),
            scrollToBottomBtn: document.getElementById('scroll-to-bottom-btn'),
            openFileMenuBtn: document.getElementById('open-file-menu-btn'),
            fileMenu: document.getElementById('file-menu'),
            imageUploadInput: document.getElementById('image-upload-input'),
            fileUploadInput: document.getElementById('file-upload-input'),
            attachedFileStatus: document.getElementById('attached-file-status'),
            characterCountDisplay: document.getElementById('character-count-display'),
            userIdDisplay: document.getElementById('user-id-display'),
            currentTimeDisplay: document.getElementById('current-time-display'),
        };

        // --- UTILITY FUNCTIONS ---
        
        /**
         * Generates a random 8-character ID (A-Z, a-z, 0-9) as requested.
         */
        function generateRandomId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showModal(backdrop) {
            backdrop.style.display = 'flex';
            requestAnimationFrame(() => { backdrop.classList.add('show'); });
        }
        function hideModal(backdrop) {
            backdrop.classList.remove('show');
            setTimeout(() => { backdrop.style.display = 'none'; }, 300);
        }
        function showCreateChatModal() { hideModal(dom.addFriendModalBackdrop); showModal(dom.createChatModalBackdrop); }
        function closeCreateChatModal() { hideModal(dom.createChatModalBackdrop); }
        function showSettingsModal() { showModal(dom.settingsModalBackdrop); }
        function closeSettingsModal() { hideModal(dom.settingsModalBackdrop); }
        function showAddFriendModal() { hideModal(dom.createChatModalBackdrop); dom.friendIdInput.value = ''; showModal(dom.addFriendModalBackdrop); }
        function closeAddFriendModal() { hideModal(dom.addFriendModalBackdrop); }
        
        function scrollToBottom(smooth = false) {
            const container = dom.messagesContainer;
            if (container) {
                container.scrollTo({ top: container.scrollHeight, behavior: smooth ? 'smooth' : 'auto' });
            }
        }
        
        function isAtBottom(threshold = 50) {
            const container = dom.messagesContainer;
            if (!container) return true;
            return container.scrollHeight - container.scrollTop <= container.clientHeight + threshold;
        }

        function updateScrollButtonVisibility() {
            const container = dom.messagesContainer;
            if (!container) return;
            if (container.scrollHeight > container.clientHeight && !isAtBottom(100)) {
                dom.scrollToBottomBtn.classList.remove('hidden');
            } else {
                dom.scrollToBottomBtn.classList.add('hidden');
            }
        }
        
        function updateCharacterLimitDisplay() {
            const count = dom.messageInput.value.length;
            dom.characterCountDisplay.textContent = `${count}/${MESSAGE_CHARACTER_LIMIT}`;
            dom.characterCountDisplay.classList.toggle('text-red-500', count > MESSAGE_CHARACTER_LIMIT);
            
            const hasContent = count > 0 && count <= MESSAGE_CHARACTER_LIMIT;
            const hasAttachment = dom.imageUploadInput.files.length > 0 || dom.fileUploadInput.files.length > 0;
            
            dom.sendBtn.disabled = !(hasContent || hasAttachment);

            // Auto-resize textarea
            dom.messageInput.style.height = 'auto';
            dom.messageInput.style.height = dom.messageInput.scrollHeight + 'px';
        }
        
        /**
         * Updates the current time display in HH:MM:SS format.
         */
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            dom.currentTimeDisplay.textContent = timeString;
        }


        // --- RENDERING & CORE LOGIC FUNCTIONS ---
        
        function renderChatListItem(chat) {
            const listItem = document.createElement('div');
            listItem.className = `compact-list-item flex items-center space-x-3 ${currentChat.id === chat.id ? 'active' : ''}`;
            listItem.dataset.chatId = chat.id;
            listItem.dataset.action = 'open-chat';

            let displayName = chat.name || 'Untitled Chat';
            let avatarLetter = displayName[0]?.toUpperCase() || 'U';

            listItem.innerHTML = `
                <div class="w-10 h-10 rounded-lg bg-gray-600 flex items-center justify-center text-white font-semibold flex-shrink-0">${avatarLetter}</div>
                <div class="flex-1 min-w-0">
                    <p class="text-white font-semibold truncate">${displayName}</p>
                    <p class="text-gray-400 text-sm truncate">${chat.lastMessage || 'Start a conversation.'}</p>
                </div>
                ${chat.unreadCount > 0 ? `<span class="bg-red-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">${chat.unreadCount}</span>` : ''}
            `;
            
            listItem.onclick = () => openChat(chat.id);
            return listItem;
        }

        function renderMessage(message) {
            if (!message.content && !message.attachmentUrl) return '';

            const isOutgoing = message.senderId === userId; // Use the 8-char ID for display comparison
            const messageClass = isOutgoing ? 'message-outgoing justify-end' : 'message-incoming justify-start';
            const timestamp = message.timestamp ? new Date(message.timestamp.toMillis()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Sending...';

            let contentHTML = '';

            if (message.attachmentUrl) {
                const fileName = message.attachmentName || 'Attachment';
                const fileType = message.attachmentType || '';
                
                if (fileType.startsWith('image/')) {
                    contentHTML += `<a href="#" data-action="lightbox" data-url="${message.attachmentUrl}" class="block mb-2 rounded-lg overflow-hidden cursor-pointer">
                        <img src="${message.attachmentUrl}" alt="${fileName}" class="max-w-xs max-h-60 object-cover rounded-lg transition-transform hover:scale-[1.02] duration-300">
                    </a>`;
                } else {
                    contentHTML += `<a href="${message.attachmentUrl}" target="_blank" class="flex items-center space-x-2 text-sm text-white hover:text-purple-300 transition duration-150 p-2 rounded-lg bg-[#2a2a2a]">
                        <i class="fas fa-file w-4"></i>
                        <span class="truncate">${fileName}</span>
                    </a>`;
                }
            }

            if (message.content) {
                const text = message.content.replace(/(https?:\/\/[^\s]+)/g, (url) => `<a href="${url}" target="_blank" class="${isOutgoing ? 'text-white underline' : 'text-purple-400 underline'}">${url}</a>`);
                contentHTML += `<p class="text-sm break-words whitespace-pre-wrap">${text}</p>`;
            }

            return `
                <div class="flex flex-col ${messageClass}">
                    <div class="flex items-start ${messageClass}">
                        <div class="message-bubble ${isOutgoing ? 'order-2' : 'order-1'}">
                            ${contentHTML}
                            <div class="flex justify-end items-center mt-1 space-x-2 text-xs ${isOutgoing ? 'text-white opacity-80' : 'text-gray-400'}">
                                <span>${timestamp}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // --- FIREBASE ACCOUNT DATA MANAGEMENT ---
        /**
         * Checks if the user's profile document exists in Firestore.
         * If it exists, retrieves the stable publicId.
         * If it doesn't exist, creates the profile with a new publicId.
         * The result is stored in the global 'userId' variable.
         * @param {string} uid - The Firebase Authentication UID.
         */
        async function ensureUserAccountData(uid) {
            if (!db) return;
            
            // Path: /artifacts/{appId}/users/{userId}/profile/info
            const userDocRef = doc(db, `artifacts/${appId}/users/${uid}/profile/info`);

            try {
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    // User data exists, retrieve public ID
                    const data = docSnap.data();
                    // Use the stored publicId, or generate a fallback if data is somehow corrupted
                    userId = data.publicId || generateRandomId(); 
                    console.log(`User profile loaded. Public ID: ${userId}`);
                } else {
                    // User is signing in for the first time, create their profile document
                    const newPublicId = generateRandomId();
                    
                    const profileData = {
                        publicId: newPublicId,
                        createdAt: new Date(),
                        // Can add other profile info here (e.g., username, status)
                    };
                    
                    await setDoc(userDocRef, profileData);
                    userId = newPublicId;
                    console.log(`New user profile created. Public ID: ${userId}`);
                }
            } catch (error) {
                console.error("Error ensuring user account data in Firestore:", error);
                // Fallback to anonymous ID generation if Firestore fails
                userId = generateRandomId();
            }
            // Ensure no old public ID is left in localStorage
            localStorage.removeItem('4sp_public_id');
        }


        // --- CHAT AND MESSAGE LOGIC (Firestore Real-time) ---

        function listenToMessages(chatId) {
            unsubscribeMessages();
            dom.messagesContainer.innerHTML = `<div class="flex justify-center items-center h-full"><p class="text-gray-500">Connecting to messages...</p></div>`;

            if (!db || !firestoreUserUid) return;

            // This is a placeholder path, ideally messages are in a 'chats' collection
            const chatPath = `artifacts/${appId}/public/data/chats/${chatId}/messages`; 
            const messagesQuery = query(collection(db, chatPath)); // NOTE: Avoided orderBy for stable compilation

            unsubscribeMessages = onSnapshot(messagesQuery, (snapshot) => {
                if (currentChat.id !== chatId) return;
                const shouldScroll = isAtBottom();
                
                dom.messagesContainer.innerHTML = '';
                
                if (snapshot.empty) {
                    dom.messagesContainer.innerHTML = `<div class="flex justify-center items-center h-full"><p class="text-gray-500">Say something!</p></div>`;
                    return;
                }
                
                let messages = [];
                snapshot.forEach(doc => {
                    const message = doc.data();
                    // Simulate timestamp if not present (required for sorting)
                    message.timestamp = message.timestamp || { toMillis: () => doc.id.split('-')[0] || Date.now() }; 
                    messages.push({ id: doc.id, ...message });
                });

                // Client-side sorting (since we avoided orderBy)
                messages.sort((a, b) => a.timestamp.toMillis() - b.timestamp.toMillis());
                
                messages.forEach(message => {
                    const messageEl = document.createElement('div');
                    messageEl.innerHTML = renderMessage(message);
                    dom.messagesContainer.appendChild(messageEl.firstChild);
                });
                
                if (shouldScroll) {
                    scrollToBottom(true);
                } else {
                    updateScrollButtonVisibility();
                }

            }, (error) => { 
                console.error("Error listening to messages:", error); 
                dom.messagesContainer.innerHTML = `<p class="text-red-400 text-center">Failed to load messages: ${error.message}</p>`; 
            });
        }

        function listenToChats() {
            unsubscribeChats();
            dom.chatListContainer.innerHTML = '<div class="text-center p-4 text-gray-500">Loading chats...</div>';

            if (!db || !firestoreUserUid) return;

            // Simple demo: fetch a user-specific collection of chats
            const chatsPath = `artifacts/${appId}/users/${firestoreUserUid}/chats`;
            const chatsQuery = query(collection(db, chatsPath));

            unsubscribeChats = onSnapshot(chatsQuery, (snapshot) => {
                dom.chatListContainer.innerHTML = '';
                if (snapshot.empty) {
                    dom.chatListContainer.innerHTML = '<div class="text-center p-4 text-gray-500">No chats found. Use the + button to create one.</div>';
                    return;
                }

                snapshot.forEach(doc => {
                    const chat = { id: doc.id, ...doc.data() };
                    dom.chatListContainer.appendChild(renderChatListItem(chat));
                });

            }, (error) => {
                console.error("Error listening to chats:", error);
                dom.chatListContainer.innerHTML = `<p class="text-red-400 text-center">Failed to load chats: ${error.message}</p>`;
            });
        }

        function openChat(chatId) {
            // Update active state in UI
            document.querySelectorAll('.compact-list-item').forEach(el => { el.classList.remove('active'); });
            const activeEl = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (activeEl) { activeEl.classList.add('active'); }
            
            // Placeholder details (ideally from the chat document)
            const chatDetails = { 
                id: chatId, 
                type: 'dm',
                name: activeEl?.querySelector('p:first-child')?.textContent || chatId, 
            };
            
            currentChat = chatDetails;
            
            dom.chatTitle.textContent = chatDetails.name;
            dom.chatSubtitle.textContent = chatDetails.type === 'group' ? 'Group Chat' : 'Direct Message';
            dom.chatHeader.classList.remove('hidden');
            dom.messageInputArea.classList.remove('hidden');

            listenToMessages(chatId);
        }
        
        async function sendMessage() {
            const content = dom.messageInput.value.trim();
            const file = dom.imageUploadInput.files[0] || dom.fileUploadInput.files[0];
            
            if (!content && !file) return;
            if (content.length > MESSAGE_CHARACTER_LIMIT) {
                console.error("Message exceeds character limit.");
                return;
            }
            if (!db || !currentChat.id || !firestoreUserUid) {
                console.error("Cannot send message: Database not initialized or chat not selected.");
                return;
            }

            // --- REAL SEND MESSAGE LOGIC WOULD GO HERE ---
            // Simplified placeholder to show function flow
            console.log(`Sending message/file to chat ${currentChat.id}`);

            // Clear inputs
            dom.messageInput.value = '';
            updateCharacterLimitDisplay();
            dom.imageUploadInput.value = '';
            dom.fileUploadInput.value = '';
            dom.attachedFileStatus.classList.add('hidden');
            dom.fileMenu.classList.add('hidden');
            
            // Assuming success, scroll down
            scrollToBottom(true);
        }

        async function sendFriendRequest() {
            const friendId = dom.friendIdInput.value.trim();
            
            // Reset status message
            dom.addFriendStatus.textContent = "Friend requests are sent using their 8-character Public User ID. (Case-sensitive)";
            dom.addFriendStatus.classList.remove('text-red-400', 'text-green-400');


            if (friendId.length !== 8 || !/^[a-zA-Z0-9]{8}$/.test(friendId)) {
                dom.addFriendStatus.textContent = "Error: ID must be 8 alphanumeric characters.";
                dom.addFriendStatus.classList.add('text-red-400');
                return;
            }
            if (friendId === userId) {
                dom.addFriendStatus.textContent = "Error: You cannot add yourself.";
                dom.addFriendStatus.classList.add('text-red-400');
                return;
            }
            if (!db || !firestoreUserUid) {
                 dom.addFriendStatus.textContent = "Error: Authentication is not complete. Please wait.";
                 dom.addFriendStatus.classList.add('text-red-400');
                 return;
            }
            
            try {
                // 1. Check if the recipient ID exists (Optional but good practice in a real app)
                // Since we can't search for the publicId easily without creating an index, 
                // we'll skip the recipient check for this demo and rely on the recipient
                // side to filter requests by their public ID.

                // Path: /artifacts/{appId}/public/data/friendRequests
                const requestsCollection = collection(db, `artifacts/${appId}/public/data/friendRequests`);

                const newRequest = {
                    senderPublicId: userId,           // The 8-char ID used for display
                    senderUid: firestoreUserUid,      // The secure Firebase UID of the sender
                    recipientPublicId: friendId,      // The 8-char ID of the intended recipient
                    status: 'pending',
                    timestamp: new Date(),
                };

                await setDoc(doc(requestsCollection), newRequest);
                
                console.log("Sent friend request to:", friendId);
                
                // Show success message
                dom.addFriendStatus.textContent = `Friend request successfully sent to ID: ${friendId}`;
                dom.addFriendStatus.classList.add('text-green-400');
                
                // Close after a brief delay
                setTimeout(() => {
                    closeAddFriendModal();
                    dom.addFriendStatus.textContent = "Friend requests are sent using their 8-character Public User ID. (Case-sensitive)";
                    dom.addFriendStatus.classList.remove('text-green-400');
                }, 1500);

            } catch (error) {
                console.error("Error sending friend request:", error);
                dom.addFriendStatus.textContent = `Error sending request: ${error.message}`;
                dom.addFriendStatus.classList.add('text-red-400');
            }
        }


        function setupEventListeners() {
            dom.dmTabBtn.onclick = () => { dom.dmTabBtn.classList.add('active'); dom.groupTabBtn.classList.remove('active'); };
            dom.groupTabBtn.onclick = () => { dom.groupTabBtn.classList.add('active'); dom.dmTabBtn.classList.remove('active'); };
            
            dom.sendBtn.onclick = sendMessage;
            dom.messageInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            dom.messageInput.addEventListener('input', updateCharacterLimitDisplay);
            
            // Modals
            dom.createChatBtn.onclick = showCreateChatModal;
            dom.createChatCancelBtn.onclick = closeCreateChatModal;
            dom.addFriendBtn.onclick = showAddFriendModal;
            dom.addFriendCancelBtn.onclick = closeAddFriendModal;
            dom.addFriendConfirmBtn.onclick = sendFriendRequest;
            dom.openSettingsBtn.onclick = showSettingsModal;
            dom.settingsModalCloseBtn.onclick = closeSettingsModal;
            dom.imageLightbox.addEventListener('click', () => hideModal(dom.imageLightbox));
            dom.scrollToBottomBtn.onclick = () => scrollToBottom(true);
            dom.messagesContainer.addEventListener('scroll', updateScrollButtonVisibility);

            // File Menu Logic
            dom.openFileMenuBtn.onclick = (e) => { e.stopPropagation(); dom.fileMenu.classList.toggle('hidden'); };
            document.addEventListener('click', (e) => {
                if (!dom.fileMenu.classList.contains('hidden') && !e.target.closest('#file-menu') && !e.target.closest('#open-file-menu-btn')) {
                    dom.fileMenu.classList.add('hidden');
                }
            });

            // Attachment input change listener
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    dom.attachedFileStatus.textContent = `Attached: ${file.name}`;
                    dom.attachedFileStatus.classList.remove('hidden');
                    dom.sendBtn.disabled = false;
                } else {
                    dom.attachedFileStatus.classList.add('hidden');
                    updateCharacterLimitDisplay(); // Re-evaluate send button if text exists
                }
                dom.fileMenu.classList.add('hidden');
                if (e.target.id === 'image-upload-input') { dom.fileUploadInput.value = ''; } else { dom.imageUploadInput.value = ''; }
            };

            dom.imageUploadInput.addEventListener('change', handleFileChange);
            dom.fileUploadInput.addEventListener('change', handleFileChange);
            
            // Lightbox handler
            dom.messagesContainer.addEventListener('click', (e) => {
                const target = e.target.closest('[data-action="lightbox"]');
                if (target) {
                    e.preventDefault();
                    dom.lightboxImage.src = target.dataset.url;
                    showModal(dom.imageLightbox);
                }
            });
        }
        
        async function initializeFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase config is missing.");
                }

                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Sign in using custom token or anonymously (prioritizing custom token if available)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                dom.chatListContainer.innerHTML = `<p class="text-red-400 text-center">Failed to initialize services: ${error.message}</p>`;
            }
        }
        
        function main() {
            // 1. Start clock
            updateClock();
            setInterval(updateClock, 1000);
            
            // 2. Set up event listeners (before auth for UI responsiveness)
            setupEventListeners();
            
            // 3. Initialize Firebase services and authentication
            initializeFirebase();

            // 4. Handle Auth state changes
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    firestoreUserUid = user.uid;
                    currentUser = user;
                    
                    // Retrieve or create the user's stable 8-character public ID in Firestore
                    await ensureUserAccountData(user.uid); 

                    dom.userIdDisplay.textContent = userId;
                    
                    // Start listening for data
                    listenToChats();
                } else {
                    // Signed out state
                    dom.chatListContainer.innerHTML = '<div class="text-center p-4 text-red-400">Not authenticated. Please wait.</div>';
                    dom.userIdDisplay.textContent = '********';
                    firestoreUserUid = null;
                    userId = null;
                }
            });
        }
        
        main();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - COUNTDOWNS</title>
    <meta name="description" content="A smart countdown manager for the 4SP website.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://kit-pro.fontawesome.com/releases/v7.0.1/css/pro.min.css" media="all">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING notes.html) --- */
        :root {
            --menu-bg: #000000;
            --menu-border: #333;
            --menu-text: #d1d5db;
            --menu-item-hover-bg: #2a2a2a;
            --tab-active-bg: rgba(79, 70, 229, 0.1);
            --tab-active-border: #4f46e5;
            --tab-active-text: #4f46e5;
        }

        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-size: 16px;
            overflow-x: hidden;
            font-weight: 300;
        }

        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* --- BUTTONS & TOOLBAR --- */
        .btn-toolbar-style {
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            border-radius: 0.75rem;
            color: var(--menu-text);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-toolbar-style:hover {
            background-color: var(--menu-bg);
            border-color: #fff;
            color: #ffffff;
        }
        
        .btn-toolbar-style.btn-primary-override {
            background-color: var(--tab-active-bg);
            border: 1px solid var(--tab-active-border);
            color: var(--tab-active-text);
        }
        .btn-toolbar-style.btn-primary-override:hover {
            background-color: rgba(79, 70, 229, 0.15);
            border-color: #6366f1;
            color: #6366f1;
        }

        /* NEW SECONDARY BUTTON STYLE (Matching notes.html mode switcher) */
        .btn-secondary-override {
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            color: var(--menu-text);
            padding: 0.5rem 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 0.5rem; /* Simplified for modal use */
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn-secondary-override:hover {
            background-color: var(--menu-item-hover-bg);
            border-color: #555;
            color: #ffffff;
        }

        /* --- DROPDOWN --- */
        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--menu-bg);
            border: 1px solid var(--menu-border);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            z-index: 1010;
            min-width: 200px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        .dropdown-item {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: var(--menu-text);
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.15s, color 0.15s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .dropdown-item:hover {
            background-color: var(--menu-item-hover-bg);
            color: #ffffff;
        }

        /* --- MAIN CONTENT --- */
        #page-content {
            min-height: calc(100vh - 4rem);
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        #countdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        /* --- CARD STYLING (Modified for Trash icon) --- */
        .countdown-card {
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            border-radius: 1rem;
            padding: 1.5rem;
            padding-bottom: 3.5rem; /* Added space for button at bottom */
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: border-color 0.2s;
            position: relative;
        }
        .countdown-card:hover {
            border-color: #333;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .card-title {
            font-size: 1.2rem;
            color: #fff;
        }
        .card-meta {
            font-size: 0.8rem;
            color: #707070;
        }
        .time-display {
            font-family: 'Roboto', sans-serif; /* Monospace-ish look for numbers */
            font-size: 1.5rem;
            color: var(--tab-active-text);
            font-weight: 300;
        }
        .detail-display {
            font-size: 0.85rem;
            color: #9ca3af;
            line-height: 1.4;
        }
        /* Trash Icon Styling: Larger (2rem) and square */
        .delete-btn {
            position: absolute;
            bottom: 1rem; 
            right: 1rem;
            color: #707070;
            cursor: pointer;
            opacity: 0.8; 
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 1rem;
            line-height: 1;
            /* NEW: Larger and enforced square dimensions */
            width: 2rem; 
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .countdown-card:hover .delete-btn {
            opacity: 1;
        }
        .delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.15); /* Reddish Background */
            border: 1px solid rgba(239, 68, 68, 0.5); /* Reddish Outline (Sidebar style adaptation) */
            color: #ef4444; 
            opacity: 1;
        }

        /* --- MODAL STYLING (16:9, 20px Rounded) --- */
        #modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(7, 7, 7, 0.85);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        #modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        #countdown-modal {
            background: #0d0d0d;
            border: 1px solid #333;
            border-radius: 20px; /* Requested */
            width: 80vw;
            max-width: 1000px;
            aspect-ratio: 16 / 9; /* Requested */
            display: flex;
            overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        /* Left Side: Inputs */
        .modal-left {
            width: 45%;
            padding: 2rem;
            border-right: 1px solid #1a1a1a;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            overflow-y: auto;
        }
        /* Right Side: Preview */
        .modal-right {
            width: 55%;
            background: #050505;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
            position: relative;
        }

        /* Form Elements */
        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        label {
            font-size: 0.85rem;
            color: #707070;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Custom Input Display Styles */
        .custom-input-container {
            background: #151515;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #fff;
            outline: none;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: border-color 0.2s;
            font-size: 1rem;
        }
        .custom-input-container:hover {
            border-color: #555;
        }
        .custom-input-container.focus-ring {
            border-color: var(--tab-active-border);
        }
        .custom-input-container span {
            font-weight: 500;
        }
        
        /* Ensure native inputs are hidden but functional */
        .native-hidden-input {
            /* Positioned relative to the form-group, but still hidden */
            position: absolute; 
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        /* Select element styling */
        select {
            background: #151515;
            border: 1px solid #333;
            border-radius: 0.5rem;
            padding: 0.75rem;
            color: #fff;
            outline: none;
            font-family: inherit;
        }
        select:focus {
            border-color: var(--tab-active-border);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .day-checkbox {
            display: none;
        }
        .day-label {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 1px solid #333;
            color: #707070;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }
        .day-checkbox:checked + .day-label {
            background: var(--tab-active-bg);
            border-color: var(--tab-active-border);
            color: var(--tab-active-text);
        }

        /* Preview Text Styles */
        #preview-big-time {
            font-size: 2.5rem;
            font-weight: 300;
            color: #fff;
            margin-bottom: 1rem;
            font-family: 'Roboto', sans-serif;
        }
        #preview-details {
            font-size: 1rem;
            color: #707070;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            text-align: left;
        }
        .preview-stat {
            background: #111;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #222;
        }
        .preview-stat strong {
            color: var(--tab-active-text);
        }

        .modal-actions {
            margin-top: auto;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #070707; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body class="min-h-screen">
    <!-- Removed loading screen entirely -->

    <!-- HEADER -->
    <header class="flex justify-between items-center p-4 border-b border-[#1a1a1a]">
        <h1 class="text-2xl font-bold text-white">4SP Countdowns</h1>
        
        <div class="flex items-center gap-2">
            <div id="add-menu-container" class="relative">
                <button id="add-menu-btn" class="btn-toolbar-style btn-primary-override">
                    <i class="fa-solid fa-plus"></i> <span>Add Countdown</span>
                </button>

                <div id="add-dropdown" class="dropdown-menu hidden">
                    <div class="dropdown-header">Type</div>
                    <div id="btn-add-one-time" class="dropdown-item">
                        <i class="fa-solid fa-hourglass-end w-5"></i> One Time
                    </div>
                    <div id="btn-add-repeating" class="dropdown-item">
                        <i class="fa-solid fa-rotate w-5"></i> Repeating
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <div id="page-content">
        <div id="countdown-grid">
            <!-- Cards injected here -->
        </div>
        <div id="empty-state" class="hidden flex-col items-center justify-center mt-20 text-[#333]">
            <i class="fa-thin fa-clock text-6xl mb-4"></i>
            <p>No countdowns yet.</p>
        </div>
    </div>

    <!-- 16:9 MODAL -->
    <div id="modal-overlay">
        <div id="countdown-modal">
            <!-- LEFT: FORM -->
            <div class="modal-left">
                <h2 id="modal-title-text" class="text-xl text-white mb-2">New Countdown</h2>
                
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="input-title" placeholder="e.g. Project Launch" maxlength="40" 
                           class="bg-[#151515] border border-[#333] rounded-lg p-3 text-white outline-none focus:border-indigo-500">
                </div>

                <!-- Date/Time Row (Custom Selectors) -->
                <div class="flex gap-4">
                    <div class="form-group flex-1">
                        <label>Date</label>
                        <div id="date-display-container" class="custom-input-container relative">
                            <span id="date-display"></span>
                            <i class="fa-regular fa-calendar-day text-[#707070]"></i>
                             <!-- Hidden native input to trigger the picker. Placed inside the container for click handler simplicity. -->
                            <input type="date" id="input-date" class="native-hidden-input">
                        </div>
                       
                    </div>
                    <div class="form-group flex-1">
                        <label>Time</label>
                        <div id="time-display-container" class="custom-input-container relative">
                            <span id="time-display"></span>
                            <i class="fa-regular fa-clock text-[#707070]"></i>
                            <!-- Hidden native input to trigger the picker -->
                            <input type="time" id="input-time" value="12:00" class="native-hidden-input">
                        </div>
                    </div>
                </div>

                <!-- Frequency Section (Hidden for One Time) -->
                <div id="frequency-section" class="hidden">
                    <div class="form-group">
                        <label>Frequency Pattern</label>
                        <select id="input-freq-type" class="bg-[#151515] border border-[#333] rounded-lg p-3 text-white outline-none focus:border-indigo-500">
                            <option value="daily">Daily</option>
                            <option value="weekly">Specific Days (Weekly)</option>
                            <option value="monthly">Monthly (Same Day)</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>

                    <!-- Days of Week Selector -->
                    <div id="days-selector" class="form-group hidden mt-2">
                        <label>Repeats On</label>
                        <div class="checkbox-group">
                            <!-- Sun=0, Mon=1... -->
                            <label><input type="checkbox" class="day-checkbox" value="0"><span class="day-label">S</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="1"><span class="day-label">M</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="2"><span class="day-label">T</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="3"><span class="day-label">W</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="4"><span class="day-label">T</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="5"><span class="day-label">F</span></label>
                            <label><input type="checkbox" class="day-checkbox" value="6"><span class="day-label">S</span></label>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <!-- CANCEL BUTTON (Secondary/Mode Switcher Style) -->
                    <button id="btn-cancel-modal" class="btn-secondary-override">Cancel</button>
                    <!-- SAVE BUTTON (Primary/Add Countdown Style) -->
                    <button id="btn-save-countdown" class="btn-toolbar-style btn-primary-override">Create Countdown</button>
                </div>
            </div>

            <!-- RIGHT: PREVIEW -->
            <div class="modal-right">
                <div class="absolute top-4 right-4 text-xs text-[#555]">PREVIEW</div>
                <h3 id="preview-title" class="text-2xl text-white mb-4 font-light">New Event</h3>
                <div id="preview-big-time">00:00:00</div>
                
                <div id="preview-details">
                    <div class="preview-stat">Decades: <strong id="p-dec">0</strong></div>
                    <div class="preview-stat">Years: <strong id="p-yrs">0</strong></div>
                    <div class="preview-stat">Months: <strong id="p-mos">0</strong></div>
                    <div class="preview-stat">Weeks: <strong id="p-wks">0</strong></div>
                    <div class="preview-stat">Days: <strong id="p-days">0</strong></div>
                    <div class="preview-stat">Target: <span id="p-date-str" class="text-xs">---</span></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE & CONFIG ---
        const MAX_YEARS_FUTURE = 15;
        let appState = {
            countdowns: [] // Array of objects: { id, title, type, targetDate, freqConfig }
        };

        // --- DOM ELEMENTS ---
        const addMenuBtn = document.getElementById('add-menu-btn');
        const addDropdown = document.getElementById('add-dropdown');
        const grid = document.getElementById('countdown-grid');
        const emptyState = document.getElementById('empty-state');
        
        // Modal Elements
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitleText = document.getElementById('modal-title-text');
        const btnCancel = document.getElementById('btn-cancel-modal');
        const btnSave = document.getElementById('btn-save-countdown');
        
        // Inputs
        const inpTitle = document.getElementById('input-title');
        const inpDate = document.getElementById('input-date');
        const inpTime = document.getElementById('input-time');
        const freqSection = document.getElementById('frequency-section');
        const inpFreqType = document.getElementById('input-freq-type');
        const daysSelector = document.getElementById('days-selector');
        
        // Custom Display Elements
        const dateDisplay = document.getElementById('date-display');
        const dateContainer = document.getElementById('date-display-container');
        const timeDisplay = document.getElementById('time-display');
        const timeContainer = document.getElementById('time-display-container');

        // Preview Elements
        const pTitle = document.getElementById('preview-title');
        const pBigTime = document.getElementById('preview-big-time');
        const pDec = document.getElementById('p-dec');
        const pYrs = document.getElementById('p-yrs');
        const pMos = document.getElementById('p-mos');
        const pWks = document.getElementById('p-wks');
        const pDays = document.getElementById('p-days');
        const pDateStr = document.getElementById('p-date-str');

        let currentModalType = 'one-time'; // 'one-time' or 'repeating'
        
        // --- INDEXED DB LAYER ---
        const idbCountdowns = {
            db: null,
            initDB: function() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('4spCountdownDB', 1);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains('data')) {
                            this.db.createObjectStore('data', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve();
                    };
                    request.onerror = (e) => reject(e);
                });
            },
            save: function(data) {
                if(!this.db) return;
                const tx = this.db.transaction(['data'], 'readwrite');
                tx.objectStore('data').put({ id: 'main', countdowns: data });
            },
            load: function() {
                return new Promise((resolve) => {
                    if(!this.db) resolve(null);
                    const tx = this.db.transaction(['data'], 'readonly');
                    const req = tx.objectStore('data').get('main');
                    req.onsuccess = (e) => resolve(e.target.result ? e.target.result.countdowns : []);
                    req.onerror = () => resolve([]);
                });
            }
        };

        // --- LOGIC & HELPERS ---

        function setMaxDate() {
            const today = new Date();
            // Set minimum date to today (or tomorrow if time has passed)
            inpDate.min = today.toISOString().split('T')[0];
            
            // Set maximum date 
            const maxDate = new Date(today.getFullYear() + MAX_YEARS_FUTURE, today.getMonth(), today.getDate());
            inpDate.max = maxDate.toISOString().split('T')[0];
        }

        // Helper to format date string for display
        function formatDisplayDate(dateString) {
            if (!dateString) return 'Select Date';
            try {
                // We add T00:00:00 to avoid timezone issues when parsing only a date string
                const date = new Date(dateString + 'T00:00:00'); 
                return date.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
            } catch {
                return dateString;
            }
        }

        // Calculate duration breakdown
        function getDuration(target) {
            const now = new Date();
            let diff = target - now;

            if (diff <= 0) return { passed: true };

            // Precise calculation
            const msInDecade = 31556952000 * 10;
            const msInYear = 31556952000;
            const msInMonth = 2629746000;
            const msInWeek = 604800000;
            const msInDay = 86400000;
            const msInHour = 3600000;
            const msInMinute = 60000;
            const msInSecond = 1000;

            const decades = Math.floor(diff / msInDecade);
            let remainder = diff % msInDecade;

            const years = Math.floor(remainder / msInYear);
            remainder %= msInYear;

            const months = Math.floor(remainder / msInMonth);
            remainder %= msInMonth;
            
            const weeks = Math.floor(remainder / msInWeek);
            remainder %= msInWeek;
            
            const days = Math.floor(remainder / msInDay);
            remainder %= msInDay;
            
            const hours = Math.floor(remainder / msInHour);
            remainder %= msInHour;

            const minutes = Math.floor(remainder / msInMinute);
            remainder %= msInMinute;
            
            const seconds = Math.floor(remainder / msInSecond);

            return {
                passed: false,
                decades, years, months, weeks, days, hours, minutes, seconds
            };
        }

        // Logic to find the Next occurrence for Repeating events
        function getNextOccurrence(item) {
            const now = new Date();
            const [tHours, tMinutes] = item.timeStr.split(':').map(Number);
            
            let target = new Date(); // Used as a base for calculations
            
            if (item.type === 'one-time') {
                target = new Date(item.dateStr);
                target.setHours(tHours, tMinutes, 0, 0);
                return target;
            }

            // Handling Repeating Logic
            const freq = item.freqConfig;
            
            // Set target's time to the specified time for today
            target.setHours(tHours, tMinutes, 0, 0);

            if (freq.type === 'daily') {
                if (target <= now) {
                    // If target time today passed, set to same time tomorrow
                    target.setDate(target.getDate() + 1);
                }
            }
            else if (freq.type === 'weekly') {
                // freq.days is array of integers [0-6] as strings
                const targetDays = freq.days.map(Number);
                let found = false;

                // Check next 8 days (1 week + 1 day to ensure we catch the next cycle)
                for(let i=0; i<8; i++) {
                    let checkDate = new Date(now);
                    checkDate.setDate(now.getDate() + i);
                    checkDate.setHours(tHours, tMinutes, 0, 0);

                    // Check if:
                    // 1. The day is in the target list AND
                    // 2. The event time has not yet passed (or if i>0, i.e. tomorrow or later)
                    const isToday = i === 0;
                    const isTargetDay = targetDays.includes(checkDate.getDay());
                    const isFutureTime = checkDate > now;

                    if (isTargetDay && (isFutureTime || !isToday)) {
                        target = checkDate;
                        found = true;
                        break;
                    }
                }
                if (!found) target = null;
            }
            else if (freq.type === 'monthly') {
                let setDay = parseInt(item.dateStr.split('-')[2]); // Get the original Day
                target.setDate(setDay);
                target.setFullYear(now.getFullYear(), now.getMonth());

                if (target <= now) {
                    target.setMonth(target.getMonth() + 1);
                    // Handle month end wrapping, e.g., setting day 31 in Feb
                    while (target.getDate() !== setDay && target.getMonth() !== (now.getMonth() + 2) % 12) {
                        target.setDate(target.getDate() - 1); // Go back until you hit a valid date for that day
                    }
                }
            }
            else if (freq.type === 'yearly') {
                let [y, m, d] = item.dateStr.split('-').map(Number);
                target.setMonth(m - 1);
                target.setDate(d);
                target.setFullYear(now.getFullYear());
                target.setHours(tHours, tMinutes, 0, 0);

                if (target <= now) {
                    target.setFullYear(now.getFullYear() + 1);
                }
            }

            return target;
        }

        // --- RENDER UI ---
        function renderCountdowns() {
            grid.innerHTML = '';
            if (appState.countdowns.length === 0) {
                emptyState.classList.remove('hidden');
                emptyState.classList.add('flex');
                return;
            }
            emptyState.classList.add('hidden');
            emptyState.classList.remove('flex');

            appState.countdowns.forEach(item => {
                const target = getNextOccurrence(item);
                const card = document.createElement('div');
                card.className = 'countdown-card';
                
                const dateStr = target ? target.toLocaleDateString(undefined, { weekday:'short', year:'numeric', month:'short', day:'numeric' }) : 'Invalid';
                const typeIcon = item.type === 'repeating' ? '<i class="fa-solid fa-rotate text-xs"></i>' : '';

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title font-bold">${item.title}</div>
                        <div class="card-meta flex items-center gap-2">${typeIcon} ${dateStr}</div>
                    </div>
                    <div class="time-display" id="timer-${item.id}">Loading...</div>
                    <div class="detail-display" id="detail-${item.id}"></div>
                    <!-- Delete button -->
                    <i class="fa-solid fa-trash delete-btn" onclick="deleteCountdown('${item.id}', event)"></i>
                `;
                grid.appendChild(card);
            });
            updateTicks(); // Immediate update
        }

        function updateTicks() {
            appState.countdowns.forEach(item => {
                const elTimer = document.getElementById(`timer-${item.id}`);
                const elDetail = document.getElementById(`detail-${item.id}`);
                if (!elTimer) return;

                const target = getNextOccurrence(item);
                if (!target) {
                    elTimer.textContent = "Error";
                    elDetail.textContent = "Could not calculate next occurrence.";
                    elTimer.style.color = "#ef4444"; // Red
                    return;
                }

                const d = getDuration(target);

                if (d.passed) {
                    elTimer.textContent = "Completed";
                    elTimer.style.color = "#10b981"; // Green
                    elDetail.textContent = item.type === 'one-time' ? "This event has passed." : "Recalculating...";
                    // Trigger a re-render/re-tick for repeating events to find the next one
                    if (item.type === 'repeating') {
                         // Use a slight delay to allow UI to breathe
                         setTimeout(renderCountdowns, 50); 
                    }
                } else {
                    elTimer.style.color = "var(--tab-active-text)";
                    // Format 00:00:00
                    const h = String(d.hours).padStart(2, '0');
                    const m = String(d.minutes).padStart(2, '0');
                    const s = String(d.seconds).padStart(2, '0');
                    elTimer.textContent = `${h}:${m}:${s}`;
                    
                    // Smart detail string
                    let parts = [];
                    if(d.decades > 0) parts.push(`${d.decades} decades`);
                    if(d.years > 0) parts.push(`${d.years} years`);
                    if(d.months > 0) parts.push(`${d.months} months`);
                    if(d.weeks > 0) parts.push(`${d.weeks} weeks`);
                    if(d.days > 0) parts.push(`${d.days} days`);
                    
                    elDetail.textContent = parts.length > 0 ? parts.join(', ') + ' remaining' : 'Less than 24 hours remaining';
                }
            });
        }

        // --- MODAL LOGIC ---
        function openModal(type) {
            currentModalType = type;
            modalTitleText.textContent = type === 'one-time' ? "New One-Time Countdown" : "New Repeating Countdown";
            addDropdown.classList.add('hidden');
            modalOverlay.classList.add('active');
            
            // Reset Inputs
            inpTitle.value = '';
            
            // Set initial date/time values (today + 12:00)
            const today = new Date();
            inpDate.value = today.toISOString().split('T')[0];
            inpTime.value = '12:00';
            
            // Initialize custom displays
            dateDisplay.textContent = formatDisplayDate(inpDate.value);
            timeDisplay.textContent = inpTime.value;
            
            // Toggle Repeating Section
            if (type === 'repeating') {
                freqSection.classList.remove('hidden');
            } else {
                freqSection.classList.add('hidden');
            }
            
            // Reset Checkboxes
            document.querySelectorAll('.day-checkbox').forEach(cb => cb.checked = false);
            daysSelector.classList.add('hidden');
            inpFreqType.value = 'daily';

            updatePreview();
        }

        function closeModal() {
            modalOverlay.classList.remove('active');
            dateContainer.classList.remove('focus-ring');
            timeContainer.classList.remove('focus-ring');
        }

        function updatePreview() {
            // Construct temporary object to feed into calculation logic
            const title = inpTitle.value || 'New Event';
            // Use the actual input values, not the displayed ones
            const dateVal = inpDate.value; 
            const timeVal = inpTime.value;
            
            pTitle.textContent = title;
            pDateStr.textContent = `${formatDisplayDate(dateVal)} @ ${timeVal}`;

            if (!dateVal || !timeVal) {
                pBigTime.textContent = "---";
                pDec.textContent = pYrs.textContent = pMos.textContent = pWks.textContent = pDays.textContent = '---';
                return;
            }

            let freqConfig = null;
            if (currentModalType === 'repeating') {
                freqConfig = { type: inpFreqType.value, days: [] };
                if (inpFreqType.value === 'weekly') {
                    document.querySelectorAll('.day-checkbox:checked').forEach(cb => freqConfig.days.push(cb.value));
                }
            }

            const tempItem = {
                type: currentModalType,
                dateStr: dateVal,
                timeStr: timeVal,
                freqConfig: freqConfig
            };

            const target = getNextOccurrence(tempItem);
            if(!target) {
                pBigTime.textContent = "Error";
                pDec.textContent = pYrs.textContent = pMos.textContent = pWks.textContent = pDays.textContent = '---';
                return;
            }

            const d = getDuration(target);
            
            if (d.passed) {
                pBigTime.textContent = "Passed";
                pDec.textContent = pYrs.textContent = pMos.textContent = pWks.textContent = pDays.textContent = 0;
            } else {
                pBigTime.textContent = `${String(d.hours).padStart(2,'0')}:${String(d.minutes).padStart(2,'0')}:${String(d.seconds).padStart(2,'0')}`;
                pDec.textContent = d.decades;
                pYrs.textContent = d.years;
                pMos.textContent = d.months;
                pWks.textContent = d.weeks;
                pDays.textContent = d.days;
            }
        }

        // --- EVENT LISTENERS ---

        // Toolbar
        addMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            addDropdown.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!addMenuBtn.contains(e.target) && !addDropdown.contains(e.target)) {
                addDropdown.classList.add('hidden');
            }
        });

        document.getElementById('btn-add-one-time').addEventListener('click', () => openModal('one-time'));
        document.getElementById('btn-add-repeating').addEventListener('click', () => openModal('repeating'));
        
        btnCancel.addEventListener('click', closeModal);

        // Custom Date/Time Selectors: Fire click on the hidden native input
        dateContainer.addEventListener('click', () => {
            inpDate.click(); // Opens the native date picker
            dateContainer.classList.add('focus-ring');
        });
        timeContainer.addEventListener('click', () => {
            inpTime.click(); // Opens the native time picker
            timeContainer.classList.add('focus-ring');
        });

        // Native Input Changes -> Update Custom Display and Preview
        inpTitle.addEventListener('input', updatePreview);
        
        // Use 'input' event for real-time update in modern browsers
        inpDate.addEventListener('input', () => {
            dateDisplay.textContent = formatDisplayDate(inpDate.value);
            // We keep focus-ring until it blurs for better UX
            updatePreview();
        });
        inpDate.addEventListener('blur', () => {
            dateContainer.classList.remove('focus-ring');
        });

        // Use 'input' event for real-time update in modern browsers
        inpTime.addEventListener('input', () => {
            timeDisplay.textContent = inpTime.value;
            // We keep focus-ring until it blurs for better UX
            updatePreview();
        });
        inpTime.addEventListener('blur', () => {
            timeContainer.classList.remove('focus-ring');
        });

        inpFreqType.addEventListener('change', () => {
            if (inpFreqType.value === 'weekly') {
                daysSelector.classList.remove('hidden');
            } else {
                daysSelector.classList.add('hidden');
            }
            updatePreview();
        });
        
        document.querySelectorAll('.day-checkbox').forEach(cb => cb.addEventListener('change', updatePreview));

        // Live Preview Interval
        setInterval(() => {
            if (modalOverlay.classList.contains('active')) updatePreview();
        }, 1000);

        // Save Action
        btnSave.addEventListener('click', () => {
            const title = inpTitle.value || 'Untitled';
            const dateStr = inpDate.value;
            const timeStr = inpTime.value;

            if (!dateStr || !timeStr) {
                // IMPORTANT: Do NOT use confirm/alert
                console.error("Please select a valid date and time before saving.");
                return; // Prevent saving if date/time is missing
            }

            let freqConfig = null;
            if (currentModalType === 'repeating') {
                freqConfig = { type: inpFreqType.value, days: [] };
                if (inpFreqType.value === 'weekly') {
                    document.querySelectorAll('.day-checkbox:checked').forEach(cb => freqConfig.days.push(cb.value));
                    if (freqConfig.days.length === 0) {
                        console.warn("No days selected for weekly repeat. The countdown may not behave as expected.");
                    }
                }
            }

            const newItem = {
                id: Date.now().toString(),
                title,
                type: currentModalType,
                dateStr,
                timeStr,
                freqConfig
            };

            appState.countdowns.push(newItem);
            idbCountdowns.save(appState.countdowns);
            renderCountdowns();
            closeModal();
        });

        // Global Tick for Grid
        setInterval(updateTicks, 1000);

        // Delete Function (Exposed to Global Scope for onclick)
        window.deleteCountdown = (id, event) => {
            event.stopPropagation();
            // Since we can't use confirm, we just delete. A better solution would be a custom modal.
            console.log(`Deleting countdown with ID: ${id}`);
            appState.countdowns = appState.countdowns.filter(c => c.id !== id);
            idbCountdowns.save(appState.countdowns);
            renderCountdowns();
        };

        // --- INIT ---
        window.addEventListener('load', async () => {
            setMaxDate();
            await idbCountdowns.initDB();
            const saved = await idbCountdowns.load();
            if (saved) appState.countdowns = saved;
            renderCountdowns();
        });

    </script>
</body>
</html>

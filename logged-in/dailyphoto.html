<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DAILYPHOTO</title>
    <meta name="description" content="Share your day with friends through three daily photos.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>

    <style>
        /* BUBBLY ANIMATIONS: Keyframes for cute/bubbly effects */
        @keyframes popIn {
            0% { transform: scale(0.8); opacity: 0; }
            80% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); }
        }
        @keyframes particleGlow {
            0% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
            50% { box-shadow: 0 0 15px #4f46e5, 0 0 25px #4f46e5; }
            100% { box-shadow: 0 0 5px #4f46e5, 0 0 10px #4f46e5; }
        }

        /* CARD STYLE */
        .card {
            background-color: #1f2937; /* Gray-800 */
            border: 1px solid #374151; /* Gray-700 */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: popIn 0.3s ease-out;
        }

        /* BUTTON STYLE */
        .btn-primary {
            background-color: #4f46e5; /* Indigo-600 */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(79, 70, 229, 0.4);
            position: relative;
            overflow: hidden;
            z-index: 1;
        }

        .btn-primary:hover {
            background-color: #4338ca; /* Indigo-700 */
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(79, 70, 229, 0.5);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(79, 70, 229, 0.5);
        }

        /* Input Focus Ring */
        .input-text:focus {
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
            outline: none;
        }

        /* Custom Scrollbar for better dark mode aesthetics */
        .custom-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #1f2937; /* Gray-800 */
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #4b5563; /* Gray-600 */
            border-radius: 4px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Gray-500 */
        }

        /* Generic Dark Mode Body/Text Styles */
        body {
            font-family: 'Geist', sans-serif;
            background-color: #0f172a; /* Slate-900 for deep dark background */
            color: #d1d5db; /* Gray-300 for general text */
        }
        
        /* Utility for compact list items */
        .compact-list-item {
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid #374151;
        }
        .compact-list-item:last-child {
            border-bottom: none;
        }

        /* Icon styling */
        .nav-icon {
            font-size: 1.5rem;
        }
        
        .nav-link {
            transition: color 0.2s ease-in-out;
        }
        .nav-link.active {
            color: #4f46e5; /* Indigo-600 */
        }
        .nav-link:not(.active):hover {
            color: #9ca3af; /* Gray-400 */
        }

        /* Photo Grid Style */
        .photo-grid {
            display: grid;
            /* Adaptive columns for mobile (2) and desktop (3) */
            grid-template-columns: repeat(3, 1fr); 
            gap: 0.5rem;
        }

        /* Ensure 2 columns on small screens, 3 on medium+ */
        @media (max-width: 640px) {
            .photo-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        .photo-preview {
            aspect-ratio: 1 / 1;
            background-color: #374151; /* Gray-700 */
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .photo-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .photo-preview .placeholder {
            font-size: 2rem;
            color: #6b7280; /* Gray-500 */
        }

    </style>
</head>
<body class="min-h-screen flex flex-col md:flex-row antialiased">

    <!-- Global Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 bg-opacity-95 z-50 flex items-center justify-center transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <i class="fas fa-spinner fa-spin text-indigo-500 text-5xl"></i>
            <p class="mt-4 text-indigo-300 text-lg font-semibold">Loading App...</p>
        </div>
    </div>

    <!-- Message Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2">
        <!-- Toasts will be appended here -->
    </div>

    <!-- Mobile Navigation (Bottom Bar) -->
    <nav class="fixed bottom-0 left-0 right-0 bg-gray-800 border-t border-gray-700 p-2 flex justify-around md:hidden z-40">
        <a href="#feed" data-target="feed-page" class="nav-link p-3 flex flex-col items-center text-gray-400 active">
            <i class="fas fa-camera nav-icon"></i>
            <span class="text-xs mt-1">Daily</span>
        </a>
        <a href="#friends" data-target="friends-page" class="nav-link p-3 flex flex-col items-center text-gray-400">
            <i class="fas fa-users nav-icon"></i>
            <span class="text-xs mt-1">Friends</span>
        </a>
        <a href="#profile" data-target="profile-page" class="nav-link p-3 flex flex-col items-center text-gray-400">
            <i class="fas fa-user-circle nav-icon"></i>
            <span class="text-xs mt-1">Profile</span>
        </a>
    </nav>

    <!-- Desktop Navigation (Side Bar) -->
    <nav class="hidden md:flex md:w-56 bg-gray-800 border-r border-gray-700 flex-col p-4 space-y-6 sticky top-0 h-screen">
        <div class="text-2xl font-bold text-indigo-400 mb-6">4SP</div>
        <a href="#feed" data-target="feed-page" class="nav-link active flex items-center p-3 rounded-xl transition hover:bg-gray-700 text-gray-300">
            <i class="fas fa-camera nav-icon w-6"></i>
            <span class="ml-3 font-semibold">Daily Feed</span>
        </a>
        <a href="#friends" data-target="friends-page" class="nav-link flex items-center p-3 rounded-xl transition hover:bg-gray-700 text-gray-300">
            <i class="fas fa-users nav-icon w-6"></i>
            <span class="ml-3 font-semibold">Friends</span>
        </a>
        <a href="#profile" data-target="profile-page" class="nav-link flex items-center p-3 rounded-xl transition hover:bg-gray-700 text-gray-300">
            <i class="fas fa-user-circle nav-icon w-6"></i>
            <span class="ml-3 font-semibold">Profile</span>
        </a>
    </nav>

    <!-- Main Content Area -->
    <main class="flex-grow p-4 md:p-8 pb-20 md:pb-8">
        <div id="page-container" class="relative">

            <!-- Daily Feed Page -->
            <div id="feed-page" class="page active">
                <h1 class="text-3xl font-extrabold mb-6 text-white">Daily Feed</h1>
                
                <div id="feed-container" class="space-y-8 max-w-2xl mx-auto">
                    <!-- Daily photo posts will be inserted here -->
                </div>

                <!-- Template for a Daily Post -->
                <template id="daily-post-template">
                    <div class="card p-4 rounded-xl">
                        <div class="flex items-center mb-3">
                            <i class="fas fa-user-circle text-2xl text-indigo-400 mr-3"></i>
                            <span class="post-username font-semibold text-white"></span>
                            <span class="ml-auto text-sm text-gray-400 post-time"></span>
                        </div>
                        <div class="photo-grid mb-3">
                            <div class="photo-preview">
                                <img data-idx="0" src="" alt="Photo 1" class="hidden">
                                <i class="fas fa-camera placeholder"></i>
                            </div>
                            <div class="photo-preview">
                                <img data-idx="1" src="" alt="Photo 2" class="hidden">
                                <i class="fas fa-camera placeholder"></i>
                            </div>
                            <div class="photo-preview">
                                <img data-idx="2" src="" alt="Photo 3" class="hidden">
                                <i class="fas fa-camera placeholder"></i>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-gray-400 text-sm">
                            <p class="post-caption italic"></p>
                            <button class="view-comments-btn text-indigo-400 hover:text-indigo-300 transition font-medium">
                                <i class="fas fa-comment"></i> <span class="comment-count">0</span>
                            </button>
                        </div>
                    </div>
                </template>
            </div>

            <!-- Friends Page -->
            <div id="friends-page" class="page hidden">
                <h1 class="text-3xl font-extrabold mb-6 text-white">Friends & Connection</h1>

                <!-- Add Friend Section -->
                <div class="card p-6 rounded-xl mb-8 max-w-xl">
                    <h2 class="text-xl font-bold mb-4 text-white">Add a Friend</h2>
                    <form id="add-friend-form" class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <input type="text" id="friend-uid-input" placeholder="Enter Friend's User ID" required class="input-text flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 transition focus:ring-indigo-500 focus:border-indigo-500">
                        <button type="submit" class="btn-primary">
                            <i class="fas fa-user-plus mr-2"></i> Add Friend
                        </button>
                    </form>
                    <p id="add-friend-message" class="mt-3 text-sm italic"></p>
                </div>

                <!-- Friend List Section -->
                <div class="card p-6 rounded-xl max-w-xl">
                    <h2 class="text-xl font-bold mb-4 text-white">My Friends (<span id="friend-count">0</span>)</h2>
                    <div id="friends-list-container" class="space-y-1 max-h-96 custom-scroll overflow-y-auto divide-y divide-gray-700">
                        <p id="no-friends-msg" class="text-gray-400 italic text-center py-4">You have no friends yet. Add some!</p>
                        <!-- Friends will be dynamically listed here -->
                    </div>
                </div>
            </div>

            <!-- Profile Page -->
            <div id="profile-page" class="page hidden">
                <h1 class="text-3xl font-extrabold mb-6 text-white">Your Profile</h1>

                <div class="space-y-8 max-w-xl">
                    <!-- User ID Section -->
                    <div class="card p-6 rounded-xl">
                        <h2 class="text-xl font-bold mb-4 text-white">Your User ID</h2>
                        <p class="text-gray-400 mb-3">Share this ID with friends so they can add you.</p>
                        <div class="flex items-center bg-gray-700 p-3 rounded-lg border border-gray-600">
                            <code id="user-id-display" class="flex-grow font-mono text-sm text-indigo-300 break-all">Loading...</code>
                            <button id="copy-uid-btn" class="ml-4 text-indigo-400 hover:text-indigo-300 transition" title="Copy ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Daily Post Section (User's own photos) -->
                    <div class="card p-6 rounded-xl">
                        <h2 class="text-xl font-bold mb-4 text-white">Today's Daily Photo</h2>
                        <form id="daily-photo-form">
                            <div class="photo-grid mb-4">
                                <!-- Photo slots 0, 1, 2 -->
                                <div class="photo-slot photo-preview" data-idx="0">
                                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer photo-upload-input" data-idx="0">
                                    <img data-idx="0" src="" alt="Photo 1" class="hidden">
                                    <i class="fas fa-plus placeholder"></i>
                                </div>
                                <div class="photo-slot photo-preview" data-idx="1">
                                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer photo-upload-input" data-idx="1">
                                    <img data-idx="1" src="" alt="Photo 2" class="hidden">
                                    <i class="fas fa-plus placeholder"></i>
                                </div>
                                <div class="photo-slot photo-preview" data-idx="2">
                                    <input type="file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer photo-upload-input" data-idx="2">
                                    <img data-idx="2" src="" alt="Photo 3" class="hidden">
                                    <i class="fas fa-plus placeholder"></i>
                                </div>
                            </div>
                            
                            <textarea id="caption-input" rows="3" placeholder="Add a caption for your daily photos (optional)" class="input-text w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 transition mb-4 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                            
                            <button type="submit" id="post-button" class="btn-primary w-full disabled:opacity-50" disabled>
                                <i class="fas fa-paper-plane mr-2"></i> <span id="post-button-text">Post Daily Photos</span>
                            </button>
                        </form>
                        <p id="post-status-message" class="mt-3 text-sm italic"></p>
                    </div>

                    <!-- Logout Button -->
                    <div class="card p-6 rounded-xl">
                        <button id="logout-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-4 rounded-xl transition">
                            <i class="fas fa-sign-out-alt mr-2"></i> Log Out
                        </button>
                    </div>
                </div>
            </div>

            <!-- Comment Modal (Hidden by default) -->
            <div id="comment-modal" class="fixed inset-0 bg-black bg-opacity-75 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target === this) closeModal('comment-modal')">
                <div class="card w-full max-w-lg md:max-h-[90vh] overflow-hidden flex flex-col rounded-2xl p-0">
                    <!-- Modal Header -->
                    <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-900">
                        <h3 class="text-xl font-bold text-white">Comments</h3>
                        <button onclick="closeModal('comment-modal')" class="text-gray-400 hover:text-white transition">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>

                    <!-- Post Info (Re-display photo/user for context) -->
                    <div id="modal-post-info" class="p-4 border-b border-gray-700 flex items-center bg-gray-800">
                        <i class="fas fa-user-circle text-2xl text-indigo-400 mr-3"></i>
                        <span id="modal-post-username" class="font-semibold text-white"></span>
                    </div>

                    <!-- Comments List -->
                    <div id="comments-list" class="flex-grow overflow-y-auto custom-scroll p-4 space-y-4">
                        <!-- Comments will be dynamically loaded here -->
                        <p id="no-comments-msg" class="text-gray-400 italic text-center">No comments yet. Be the first!</p>
                    </div>
                    
                    <!-- Comment Input Form -->
                    <div class="p-4 border-t border-gray-700 bg-gray-800">
                        <form id="add-comment-form" class="flex space-x-2">
                            <input type="text" id="comment-input" placeholder="Write a comment..." required class="input-text flex-grow p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 transition focus:ring-indigo-500 focus:border-indigo-500">
                            <button type="submit" class="btn-primary px-4">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </main>
    
    <!-- Image Display Modal (For viewing a specific photo) -->
    <div id="image-modal" class="fixed inset-0 bg-black bg-opacity-95 z-50 hidden flex items-center justify-center p-4" onclick="if(event.target === this) closeModal('image-modal')">
        <button onclick="closeModal('image-modal')" class="absolute top-4 right-4 text-white text-3xl z-50 hover:text-gray-300 transition">
            <i class="fas fa-times"></i>
        </button>
        <img id="modal-image-display" src="" alt="Full size photo" class="max-w-full max-h-full rounded-xl object-contain">
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, where, arrayUnion, arrayRemove, writeBatch, serverTimestamp, orderBy, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

        // setLogLevel('Debug'); // Uncomment for Firebase debugging

        // Global Firebase variables
        let app;
        let db;
        let auth;
        let storage;
        let userId = null;
        let username = 'AnonymousUser'; // Default username

        // --- Utility Functions ---

        /** Shows a toast message. */
        function showMessage(container, message, type = 'info') {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 rounded-xl shadow-lg transition-all duration-300 ease-in-out card-sm`;
            toast.style.minWidth = '250px';
            
            let colorClass, iconClass;
            switch (type) {
                case 'success':
                    colorClass = 'bg-green-600';
                    iconClass = 'fas fa-check-circle';
                    break;
                case 'error':
                    colorClass = 'bg-red-600';
                    iconClass = 'fas fa-times-circle';
                    break;
                case 'warning':
                    colorClass = 'bg-yellow-600';
                    iconClass = 'fas fa-exclamation-triangle';
                    break;
                case 'info':
                default:
                    colorClass = 'bg-indigo-600';
                    iconClass = 'fas fa-info-circle';
                    break;
            }
            
            toast.classList.add(colorClass);
            toast.innerHTML = `<div class="flex items-center text-white"><i class="${iconClass} mr-3"></i><span>${message}</span></div>`;
            
            toastContainer.appendChild(toast);

            // Hide and remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.add('opacity-0');
                toast.classList.add('translate-x-full');
                setTimeout(() => toast.remove(), 300); 
            }, 3000);
        }

        /** Opens a modal by setting its display style and optionally preparing content. */
        function openModal(modalId, contentCallback = null) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (contentCallback) {
                    contentCallback();
                }
                modal.classList.remove('hidden');
                document.body.style.overflow = 'hidden'; // Prevent scrolling background
            }
        }

        /** Closes a modal. */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
            }
        }
        
        // --- Firestore Paths & Refs ---

        // MANDATORY: Use __app_id provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        /** Gets the reference for a user's public profile document. */
        function getUserProfileDocRef(uid) {
            return doc(db, `/artifacts/${appId}/public/data/user_profiles/${uid}`);
        }

        /** Gets the reference for a user's daily post document for today. */
        function getDailyPostDocRef(uid) {
            const today = new Date().toISOString().split('T')[0];
            return doc(db, `/artifacts/${appId}/public/data/daily_posts/${uid}_${today}`);
        }
        
        /** Gets the collection reference for daily posts (all users/all dates). */
        function getDailyPostsCollectionRef() {
            return collection(db, `/artifacts/${appId}/public/data/daily_posts`);
        }

        /** Gets the comments collection reference for a specific post. */
        function getPostCommentsCollectionRef(postId) {
            return collection(db, `/artifacts/${appId}/public/data/daily_posts/${postId}/comments`);
        }

        // --- Image Storage ---
        
        /** Uploads an image file to storage. */
        async function uploadImage(file, uid, index) {
            const today = new Date().toISOString().split('T')[0];
            // Using a structured path for clarity
            const filePath = `daily_photos/${uid}/${today}_${index}_${file.name}`; 
            const fileRef = storageRef(storage, filePath);
            
            const snapshot = await uploadBytes(fileRef, file);
            return await getDownloadURL(snapshot.ref);
        }

        // --- Initialization & Auth ---

        window.onload = async () => {
            try {
                // MANDATORY: Parse __firebase_config
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app);

                // Attach navigation listeners
                attachNavigationListeners();

                // Authentication setup
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await initializeUserProfile(user.uid);
                        
                        // User is authenticated and profile is ready
                        document.getElementById('user-id-display').textContent = userId;
                        document.getElementById('loading-overlay').classList.add('opacity-0', 'pointer-events-none');
                        
                        // Start real-time listeners
                        setupProfileListener(userId);
                        setupFriendFeedListener(userId);
                        setupAddFriendFormListener(userId);
                        setupDailyPostFormListener(userId);

                    } else {
                        // User is signed out or first time access
                        await handleInitialSignIn();
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('loading-overlay').innerHTML = `<div class="p-8 rounded-xl bg-red-800 text-white shadow-xl">Initialization Error: ${error.message}</div>`;
            }
        };

        /** Handles initial sign-in, preferring custom token if available, otherwise anonymous. */
        async function handleInitialSignIn() {
            const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            try {
                if (token) {
                    // MANDATORY: Use signInWithCustomToken if token is available
                    await signInWithCustomToken(auth, token);
                } else {
                    // MANDATORY: Use signInAnonymously if token is not available
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth sign-in failed:", error);
                showMessage(null, "Authentication failed. Please try refreshing.", 'error');
            }
        }

        /** Initializes or retrieves the user's public profile. */
        async function initializeUserProfile(uid) {
            const profileRef = getUserProfileDocRef(uid);
            const profileSnap = await getDoc(profileRef);

            if (!profileSnap.exists()) {
                // New user setup
                const defaultUsername = `User-${uid.substring(0, 8)}`;
                await setDoc(profileRef, {
                    uid: uid,
                    username: defaultUsername,
                    friends: [], // Array of friend UIDs
                    createdAt: serverTimestamp()
                });
                username = defaultUsername;
            } else {
                // Existing user
                const data = profileSnap.data();
                username = data.username;
            }
        }

        /** Sets up a real-time listener for the user's own profile data. */
        function setupProfileListener(uid) {
            const profileRef = getUserProfileDocRef(uid);
            // MANDATORY: Use onSnapshot for real-time updates
            onSnapshot(profileRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    username = data.username; // Update global username
                    renderFriendsList(data.friends || []);
                }
            }, (error) => {
                console.error("Error listening to profile:", error);
                showMessage(null, "Could not fetch profile updates.", 'error');
            });
        }
        
        // --- Navigation Logic & UI Events ---

        function attachNavigationListeners() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetPageId = link.getAttribute('data-target');
                    if (targetPageId) {
                        showPage(targetPageId);
                    }
                    
                    document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                    document.querySelectorAll(`.nav-link[data-target="${targetPageId}"]`).forEach(nav => nav.classList.add('active'));
                });
            });
            
            // Handle hash changes
            window.addEventListener('hashchange', () => {
                const hash = window.location.hash.substring(1);
                const defaultPage = 'feed-page';
                const targetPageId = hash && document.getElementById(hash + '-page') ? hash + '-page' : defaultPage;
                showPage(targetPageId);
                
                document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active'));
                document.querySelectorAll(`.nav-link[data-target="${targetPageId}"]`).forEach(nav => nav.classList.add('active'));
            });

            // Initial load check
            const initialHash = window.location.hash.substring(1);
            const initialPageId = initialHash && document.getElementById(initialHash + '-page') ? initialHash + '-page' : 'feed-page';
            showPage(initialPageId);
            document.querySelectorAll(`.nav-link[data-target="${initialPageId}"]`).forEach(nav => nav.classList.add('active'));

            // Setup copy UID button (using execCommand for iFrame compatibility)
            document.getElementById('copy-uid-btn').addEventListener('click', () => {
                const uidText = document.getElementById('user-id-display').textContent;
                const tempInput = document.createElement('textarea');
                tempInput.value = uidText;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    showMessage(null, 'User ID copied to clipboard!', 'success');
                } catch (err) {
                    console.error('Could not copy text: ', err);
                    showMessage(null, 'Failed to copy ID.', 'error');
                }
                document.body.removeChild(tempInput);
            });

            // Setup Logout button
            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    await signOut(auth);
                    showMessage(null, "Logged out successfully. Signing in anonymously...", 'info');
                } catch (error) {
                    console.error("Logout failed:", error);
                    showMessage(null, "Logout failed.", 'error');
                }
            });
        }

        /** Hides all pages and shows the selected one. */
        function showPage(targetPageId) {
            document.querySelectorAll('.page').forEach(page => {
                if (page.id === targetPageId) {
                    page.classList.remove('hidden');
                    page.style.animation = 'popIn 0.3s ease-out';
                } else {
                    page.classList.add('hidden');
                    page.style.animation = 'none';
                }
            });
        }

        // --- Daily Post Form Logic ---

        let uploadedFiles = [null, null, null]; // Stores File objects for indices 0, 1, 2
        const photoPreviewElements = [0, 1, 2].map(i => document.querySelector(`.photo-slot[data-idx="${i}"] img`));
        const photoPlaceholderElements = [0, 1, 2].map(i => document.querySelector(`.photo-slot[data-idx="${i}"] .placeholder`));
        const postButton = document.getElementById('post-button');

        document.querySelectorAll('.photo-upload-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const file = e.target.files[0];
                const index = parseInt(e.target.dataset.idx);

                if (file) {
                    uploadedFiles[index] = file;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        photoPreviewElements[index].src = e.target.result;
                        photoPreviewElements[index].classList.remove('hidden');
                        photoPlaceholderElements[index].classList.add('hidden');
                    };
                    reader.readAsDataURL(file);
                } else {
                    uploadedFiles[index] = null;
                    photoPreviewElements[index].src = "";
                    photoPreviewElements[index].classList.add('hidden');
                    photoPlaceholderElements[index].classList.remove('hidden');
                }
                
                checkPostButtonState();
            });
        });

        /** Checks if at least one photo is uploaded and enables/disables the post button. */
        function checkPostButtonState() {
            const isReady = uploadedFiles.some(f => f !== null);
            postButton.disabled = !isReady;
            document.getElementById('post-button-text').textContent = isReady ? 'Post Daily Photos' : 'Add at least one photo';
        }
        
        /** Sets up the listener for the daily post form submission. */
        function setupDailyPostFormListener(uid) {
            document.getElementById('daily-photo-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!uploadedFiles.some(f => f !== null)) {
                    showMessage(null, "Please upload at least one photo.", 'warning');
                    return;
                }

                postButton.disabled = true;
                document.getElementById('post-button-text').textContent = 'Uploading...';
                const postStatusMessage = document.getElementById('post-status-message');
                postStatusMessage.textContent = 'Starting upload...';

                try {
                    const caption = document.getElementById('caption-input').value.trim();
                    const photoUrls = [];

                    for (let i = 0; i < uploadedFiles.length; i++) {
                        const file = uploadedFiles[i];
                        if (file) {
                            postStatusMessage.textContent = `Uploading photo ${i + 1} of 3...`;
                            const url = await uploadImage(file, uid, i);
                            photoUrls[i] = url;
                        } else {
                            photoUrls[i] = null; // Store null for unused slots
                        }
                    }

                    postStatusMessage.textContent = 'Saving post to Firestore...';

                    const postRef = getDailyPostDocRef(uid);
                    // Use setDoc with merge to ensure the document structure is created/updated
                    await setDoc(postRef, {
                        uid: uid,
                        username: username,
                        caption: caption,
                        photoUrls: photoUrls,
                        timestamp: serverTimestamp(),
                        date: new Date().toISOString().split('T')[0]
                    }, { merge: true });

                    showMessage(null, 'Daily Photos posted successfully!', 'success');
                    postStatusMessage.textContent = 'Post successful!';
                    
                    // Reset form and UI
                    uploadedFiles = [null, null, null];
                    document.getElementById('caption-input').value = '';
                    document.querySelectorAll('.photo-upload-input').forEach(input => input.value = ''); // Clear file inputs
                    photoPreviewElements.forEach(el => el.classList.add('hidden'));
                    photoPlaceholderElements.forEach(el => el.classList.remove('hidden'));
                    checkPostButtonState();

                } catch (error) {
                    console.error("Daily post failed:", error);
                    showMessage(null, `Post failed: ${error.message}`, 'error');
                    postStatusMessage.textContent = `Error: ${error.message}`;
                } finally {
                    checkPostButtonState(); // Re-enable if possible
                }
            });
            
            // Initial check
            checkPostButtonState();
        }

        // --- Daily Feed (Friends' Posts) Logic ---
        
        let friendsListCache = []; // To store the UIDs of current friends
        let postUnsubscribe = null; // Store the unsubscribe function for the feed listener

        /** Sets up the listener for the daily posts of the user and their friends. */
        function setupFriendFeedListener(uid) {
             // Listener logic is deferred to updateFeedListener, which is called by setupProfileListener
        }

        /** Called by the profile listener to update the feed listener. */
        function updateFeedListener(newFriendsList) {
            friendsListCache = newFriendsList;

            // Unsubscribe from previous listener if it exists
            if (postUnsubscribe) {
                postUnsubscribe();
                postUnsubscribe = null;
            }

            const uidsToWatch = [userId, ...newFriendsList].filter(uid => uid);

            if (uidsToWatch.length === 0) {
                document.getElementById('feed-container').innerHTML = '<p class="card p-6 rounded-xl text-center text-gray-400">Add friends on the Friends page to see their daily photos!</p>';
                return;
            }
            
            // 1. Get today's date for document ID format
            const today = new Date().toISOString().split('T')[0];
            const postIds = uidsToWatch.map(uid => `${uid}_${today}`);
            
            // 2. Query for today's posts from the UIDs we are watching
            // Firestore only allows up to 10 'in' clauses
            if (postIds.length > 10) {
                 // For simplicity in this single-file context, we'll cap the list. 
                 // In a production app, you'd handle this with more complex fan-out/timeline logic.
                 postIds.splice(10); 
            }
            
            const q = query(
                getDailyPostsCollectionRef(),
                where('__name__', 'in', postIds) // Querying by full document ID
            );

            // MANDATORY: Use onSnapshot for real-time feed updates
            postUnsubscribe = onSnapshot(q, (snapshot) => {
                const posts = [];
                snapshot.forEach(doc => {
                    const postData = doc.data();
                    posts.push({ id: doc.id, ...postData });
                });

                // Sort the posts by timestamp (newest first, locally)
                // IMPORTANT: Avoid orderBy() in the query to prevent index errors; sort locally.
                posts.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                
                renderFeed(posts);

            }, (error) => {
                console.error("Error listening to feed:", error);
                document.getElementById('feed-container').innerHTML = `<p class="card p-6 rounded-xl text-center text-red-400">Error loading feed: ${error.message}</p>`;
            });
        }

        /** Renders the posts in the feed container. */
        let commentCountListeners = {}; // To hold comment unsubscribers

        function renderFeed(posts) {
            const container = document.getElementById('feed-container');
            container.innerHTML = '';
            
            if (posts.length === 0) {
                container.innerHTML = '<p class="card p-6 rounded-xl text-center text-gray-400">No one has posted today yet. Be the first!</p>';
                // Cleanup all comment listeners
                Object.values(commentCountListeners).forEach(unsub => unsub());
                commentCountListeners = {};
                return;
            }

            const template = document.getElementById('daily-post-template');

            // Cleanup only listeners for posts that are no longer in the list
            const newPostIds = posts.map(p => p.id);
            Object.keys(commentCountListeners).forEach(postId => {
                if (!newPostIds.includes(postId)) {
                    commentCountListeners[postId](); // Unsubscribe
                    delete commentCountListeners[postId];
                }
            });

            posts.forEach(post => {
                const clone = template.content.cloneNode(true);
                const postElement = clone.querySelector('.card');
                const postId = post.id;
                postElement.dataset.postId = postId;

                clone.querySelector('.post-username').textContent = post.username;
                clone.querySelector('.post-caption').textContent = post.caption || 'No caption.';
                
                // Format timestamp
                const date = post.timestamp ? post.timestamp.toDate() : new Date();
                clone.querySelector('.post-time').textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                // Render photos
                const photoPreviews = clone.querySelectorAll('.photo-preview');
                post.photoUrls.forEach((url, index) => {
                    const img = photoPreviews[index].querySelector('img');
                    const placeholder = photoPreviews[index].querySelector('.placeholder');
                    if (url) {
                        img.src = url;
                        img.classList.remove('hidden');
                        placeholder.classList.add('hidden');
                        
                        // Add click listener to open the image modal
                        img.addEventListener('click', () => openImageModal(url));
                    } else {
                        img.classList.add('hidden');
                        placeholder.classList.remove('hidden');
                    }
                });

                // Set up comment listener for this post if not already listening
                if (!commentCountListeners[postId]) {
                    const commentCountElement = clone.querySelector('.comment-count');
                    const commentsRef = getPostCommentsCollectionRef(postId);
                    const commentQuery = query(commentsRef); 

                    commentCountListeners[postId] = onSnapshot(commentQuery, (snapshot) => {
                        commentCountElement.textContent = snapshot.size;
                    });
                }
                
                // Update comment count for existing listeners
                const existingCount = container.querySelector(`.card[data-post-id="${postId}"] .comment-count`);
                if (existingCount) {
                     // If the post is already rendered, update its comment count immediately based on the listener data
                     // (The listener should update this on its own, but this ensures initial state is correct if posts are re-ordered)
                     // Since we clear and re-render the container, the new clone gets the initial count from the listener.
                }


                // Set up the view comments button
                clone.querySelector('.view-comments-btn').addEventListener('click', () => {
                    openCommentModal(postId, post.username);
                });

                container.appendChild(clone);
            });
        }
        
        /** Opens the image modal with a specific URL. */
        function openImageModal(url) {
            document.getElementById('modal-image-display').src = url;
            openModal('image-modal');
        }

        // --- Friend Management Logic ---

        const addFriendMessage = document.getElementById('add-friend-message');

        /** Sets up the listener for the Add Friend form submission. */
        function setupAddFriendFormListener(uid) {
            document.getElementById('add-friend-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                addFriendMessage.textContent = 'Processing...';
                
                const friendUid = document.getElementById('friend-uid-input').value.trim();
                document.getElementById('friend-uid-input').value = ''; // Clear input

                if (friendUid === uid) {
                    showMessage(addFriendMessage, 'You cannot add yourself as a friend.', 'warning');
                    return;
                }
                
                try {
                    const friendProfileRef = getUserProfileDocRef(friendUid);
                    const friendProfileSnap = await getDoc(friendProfileRef);

                    if (!friendProfileSnap.exists()) {
                        showMessage(addFriendMessage, 'User ID not found.', 'error');
                        return;
                    }
                    
                    const friendData = friendProfileSnap.data();
                    if ((friendData.friends || []).includes(uid)) {
                        showMessage(addFriendMessage, `${friendData.username} is already your friend!`, 'info');
                        return;
                    }

                    // Use a batch write for atomic update on both users' profiles
                    const batch = writeBatch(db);
                    
                    // 1. Add friendUid to current user's friends list
                    batch.update(getUserProfileDocRef(uid), { friends: arrayUnion(friendUid) });
                    
                    // 2. Add current user's UID to friend's friends list (mutual follow)
                    batch.update(friendProfileRef, { friends: arrayUnion(uid) });

                    await batch.commit();

                    showMessage(addFriendMessage, `Friend '${friendData.username}' added successfully!`, 'success');

                } catch (error) {
                    console.error("Add friend failed:", error);
                    showMessage(addFriendMessage, 'Failed to add friend.', 'error');
                }
            });
        }

        /** Renders the real-time list of friends based on UIDs from profile listener. */
        let friendProfileListeners = {}; // To hold profile unsubscribers

        async function renderFriendsList(friendUids) {
            const container = document.getElementById('friends-list-container');
            document.getElementById('friend-count').textContent = friendUids.length;
            container.innerHTML = '';
            
            // Clear message
            document.getElementById('no-friends-msg').classList.add('hidden');
            if (friendUids.length === 0) {
                document.getElementById('no-friends-msg').classList.remove('hidden');
                updateFeedListener([]); // Update feed with only own UID
                return;
            }

            // Cleanup old listeners
            Object.values(friendProfileListeners).forEach(unsub => unsub());
            friendProfileListeners = {};

            const friendProfiles = {}; // Map to store current username for each UID

            friendUids.forEach(friendUid => {
                const friendRef = getUserProfileDocRef(friendUid);
                
                // MANDATORY: Use onSnapshot for real-time friend username updates
                friendProfileListeners[friendUid] = onSnapshot(friendRef, (doc) => {
                    if (doc.exists()) {
                        friendProfiles[friendUid] = doc.data().username;
                    } else {
                        friendProfiles[friendUid] = 'Deleted User'; 
                    }
                    
                    // Re-render the list every time a friend's profile updates
                    displayCurrentFriends(friendUids, friendProfiles);
                }, (error) => {
                    console.error(`Error listening to friend ${friendUid} profile:`, error);
                    friendProfiles[friendUid] = 'Error User';
                    displayCurrentFriends(friendUids, friendProfiles);
                });
            });
            
            // This function handles the actual DOM manipulation
            function displayCurrentFriends(uids, profiles) {
                container.innerHTML = '';
                
                const readyFriends = uids
                    .map(uid => ({ uid, username: profiles[uid] || `Loading... (${uid.substring(0, 4)})` }))
                    .sort((a, b) => a.username.localeCompare(b.username)); // Sort locally

                readyFriends.forEach(({ uid: friendUid, username }) => {
                    const div = document.createElement('div');
                    div.className = 'compact-list-item flex justify-between items-center';
                    // MANDATORY: Display full UID for multi-user apps (here we just use the username)
                    div.innerHTML = `
                        <span class="font-semibold text-white">${username}</span>
                        <button data-uid="${friendUid}" class="remove-friend-btn text-red-400 hover:text-red-500 transition px-2 py-1 rounded-lg" title="Remove Friend">
                            <i class="fas fa-user-minus"></i>
                        </button>
                    `;
                    container.appendChild(div);
                });

                container.querySelectorAll('.remove-friend-btn').forEach(button => {
                    button.addEventListener('click', async (e) => {
                        e.preventDefault();
                        const user = auth.currentUser;
                        if (!user) return;

                        // Find the closest button element to ensure the click target is correct
                        const friendUidToRemove = e.target.closest('button').dataset.uid;
                        
                        // Use batch write to ensure mutual removal
                        const batch = writeBatch(db);
                        batch.update(getUserProfileDocRef(user.uid), { friends: arrayRemove(friendUidToRemove) });
                        batch.update(getUserProfileDocRef(friendUidToRemove), { friends: arrayRemove(user.uid) });
                        await batch.commit();

                        showMessage(addFriendMessage, 'Friend removed successfully!', 'success');
                    });
                });
                
                // After displaying friends, update the feed listener
                updateFeedListener(friendUids);
            }
        }
        
        // --- Comment Modal Logic ---
        
        let currentPostId = null;
        let commentUnsubscribe = null;

        /** Opens the comment modal and sets up the listener for comments. */
        function openCommentModal(postId, postUsername) {
            currentPostId = postId;
            
            // 1. Set post info
            document.getElementById('modal-post-username').textContent = postUsername;
            
            // 2. Open the modal
            openModal('comment-modal', () => {
                // Clear previous comments
                document.getElementById('comments-list').innerHTML = '<p id="no-comments-msg" class="text-gray-400 italic text-center">No comments yet. Be the first!</p>';

                // 3. Set up the comment listener
                if (commentUnsubscribe) {
                    commentUnsubscribe(); // Unsubscribe from previous post's comments
                }

                const commentsRef = getPostCommentsCollectionRef(postId);
                // IMPORTANT: Avoid orderBy in the query to prevent index errors; sort locally or rely on server timestamp when adding.
                const q = query(commentsRef);

                // MANDATORY: Use onSnapshot for real-time comment updates
                commentUnsubscribe = onSnapshot(q, (snapshot) => {
                    // Sort locally by timestamp
                    const sortedDocs = snapshot.docs.sort((a, b) => {
                        const timeA = a.data().timestamp?.toMillis() || 0;
                        const timeB = b.data().timestamp?.toMillis() || 0;
                        return timeA - timeB; // Ascending order
                    });
                    renderComments(sortedDocs);
                }, (error) => {
                    console.error("Error listening to comments:", error);
                    document.getElementById('comments-list').innerHTML = `<p class="text-red-400 text-center">Error loading comments.</p>`;
                });
            });
        }
        
        /** Renders comments from the Firestore snapshot. */
        function renderComments(commentDocs) {
            const container = document.getElementById('comments-list');
            container.innerHTML = '';
            
            document.getElementById('no-comments-msg').classList.add('hidden');

            if (commentDocs.length === 0) {
                const msg = document.getElementById('no-comments-msg').cloneNode(true);
                msg.classList.remove('hidden');
                container.appendChild(msg);
                return;
            }

            commentDocs.forEach(doc => {
                const data = doc.data();
                const commentDiv = document.createElement('div');
                commentDiv.className = 'p-3 bg-gray-700 rounded-lg flex flex-col space-y-1';
                
                // Format timestamp
                const date = data.timestamp ? data.timestamp.toDate() : new Date();
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                commentDiv.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-indigo-400">${data.username || 'Anonymous'}</span>
                        <span class="text-xs text-gray-400">${timeString}</span>
                    </div>
                    <p class="text-white">${data.text}</p>
                `;
                container.appendChild(commentDiv);
            });
            
            // Scroll to the bottom of the list when new comments arrive
            container.scrollTop = container.scrollHeight;
        }

        /** Sets up listener for adding a new comment. */
        document.getElementById('add-comment-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentInput = document.getElementById('comment-input');
            const commentText = commentInput.value.trim();

            if (!commentText || !currentPostId) {
                return;
            }

            commentInput.value = ''; // Clear input immediately
            commentInput.disabled = true;

            try {
                const commentsRef = getPostCommentsCollectionRef(currentPostId);
                
                // Add the new comment document
                await addDoc(commentsRef, {
                    uid: userId,
                    username: username, // Use the current authenticated user's profile username
                    text: commentText,
                    timestamp: serverTimestamp()
                });
                
                // Show toast but keep comment box open
                showMessage(null, 'Comment posted!', 'success');

            } catch (error) {
                console.error("Post comment failed:", error);
                showMessage(null, `Failed to post comment: ${error.message}`, 'error');
            } finally {
                commentInput.disabled = false;
            }
        });
        
    </script>
</body>
</html>

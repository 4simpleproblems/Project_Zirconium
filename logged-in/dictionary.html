<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - DICTIONARY</title>
    <meta name="description" content="A simple interactive dictionary with search and definition display using dictionaryapi.dev.">

    <!-- Fonts, Icons, and Tailwind CSS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Geist Font (Main text) -->
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <!-- Playfair Display Italic (Special text: Pronunciation) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@1,400..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>
    <script src="../injector.js"></script>

    <style>
        /* --- FONT & BASE STYLING (MATCHING base-template.html) --- */
        body { 
            font-family: 'Geist', sans-serif; 
            background-color: #070707; 
            color: #c0c0c0; 
            transition: all 0.3s ease;
            font-weight: 300; 
            min-height: 100vh;
        }
        
        h1, h2, h3, .font-bold, .font-semibold, strong, .tracking-widest {
            font-weight: 400 !important;
        }

        /* Styling for the main content container */
        .page-container {
            padding: 2rem 1rem;
            max-width: 900px; /* Narrower for focus */
            margin: 0 auto;
        }

        /* Placeholder content box replaced with a general dictionary card */
        .dictionary-card {
            background-color: #111111; 
            border: 1px solid #252525; 
            border-radius: 0.75rem; 
            padding: 2rem; 
            min-height: 70vh;
        }

        /* Standard loading screen style */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #070707;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        /* --- CUSTOM DICTIONARY STYLING --- */
        .pronunciation-text {
            /* Special font for pronunciation */
            font-family: 'Playfair Display', serif;
            font-style: italic;
            color: #9ca3af; /* Initial muted gray for visibility */
            transition: color 0.2s ease;
            cursor: help; 
        }

        .pronunciation-text:hover {
            /* Cyan color on hover */
            color: #06b6d4; /* Tailwind cyan-500 equivalent */
        }
        
        .highlighted-word {
            /* Styling for clickable words within the definition text */
            text-decoration: underline;
            text-decoration-color: #06b6d480; /* semi-transparent cyan */
            text-underline-offset: 3px;
            cursor: pointer;
            transition: background-color 0.15s ease;
        }
        
        .highlighted-word:hover {
            background-color: #06b6d420; /* light cyan background on hover */
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <!-- Loading Screen (Shown until authentication check is complete) -->
    <div id="loading-screen">
        <p class="text-xl text-gray-400">Verifying authentication...</p>
    </div>

    <!-- Main Page Content (Hidden until authenticated) -->
    <main id="page-content" class="page-container hidden">
        <div class="dictionary-card shadow-xl">
            <h1 class="text-3xl font-bold text-white mb-6 text-center">Interactive Lexicon</h1>

            <!-- Search Bar (Integrated, rounded-xl input, button inside) -->
            <div class="relative mb-8">
                <!-- Input Field (Rounded-xl) -->
                <input 
                    type="text"
                    id="search-input"
                    placeholder="Type a word and press Enter or click the Search icon..."
                    class="w-full p-4 pl-12 pr-20 rounded-xl bg-zinc-800 text-white border border-zinc-700 focus:ring-2 focus:ring-cyan-500 focus:border-cyan-500 transition duration-150"
                    autocomplete="off"
                />
                <!-- Book Icon inside input -->
                <i class="fas fa-book absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                
                <!-- Search Button (Squircle, integrated, right side, using fa-paper-plane) -->
                <button 
                    id="search-button" 
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 w-12 h-12 bg-cyan-600 hover:bg-cyan-700 text-white font-semibold rounded-[1rem] shadow-md transition duration-150 active:scale-[.98] flex items-center justify-center"
                    title="Search Dictionary">
                    <!-- Send Message Icon -->
                    <i class="fas fa-paper-plane text-lg"></i>
                </button>
            </div>

            <!-- Definition Display -->
            <div id="definition-output" class="p-6 bg-zinc-900 border border-zinc-800 rounded-lg min-h-[30vh]">
                <p class="text-lg text-gray-400 text-center">
                    Enter a word above and hit **Search** or **Enter** to look up its definition, pronunciation, and synonyms using the dictionary API.
                </p>
            </div>
            
        </div>
    </main>

    <script type="module">
        // --- Firebase Core Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- CONFIGURATION IMPORT ---
        // NOTE: This assumes you have a firebase-config.js file one level up (../)
        import { firebaseConfig } from "../firebase-config.js"; 
        
        // --- Canvas Global Variables (MANDATORY USE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const rawFirebaseConfig = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let config = firebaseConfig;
        if (rawFirebaseConfig) {
            try {
                config = JSON.parse(rawFirebaseConfig);
            } catch (e) {
                console.error("Failed to parse __firebase_config:", e);
            }
        }

        // --- Initialize Firebase ---
        const app = initializeApp(config);
        const auth = getAuth(app);

        // --- DOM Elements ---
        const loadingScreen = document.getElementById('loading-screen');
        const pageContent = document.getElementById('page-content');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const definitionOutput = document.getElementById('definition-output');
        
        // --- DICTIONARY API LOGIC ---
        
        /**
         * Fetches the definition for a given word using the dictionaryapi.dev API.
         * @param {string} word The word to look up.
         */
        async function fetchDefinition(word) {
            const trimmedWord = word.trim().toLowerCase();
            if (!trimmedWord) return;

            // 1. Set loading state and clear input field
            definitionOutput.innerHTML = `
                <p class="text-xl text-cyan-400 text-center flex items-center justify-center space-x-2">
                    <i class="fas fa-spinner fa-spin mr-2"></i><span>Searching for '${trimmedWord}'...</span>
                </p>
            `;
            searchInput.value = trimmedWord; // Set the input field to the word being searched

            try {
                const url = `https://api.dictionaryapi.dev/api/v2/entries/en/${trimmedWord}`;
                const response = await fetch(url);

                if (!response.ok) {
                    // API returns 404 for words not found
                    if (response.status === 404) {
                        definitionOutput.innerHTML = `
                            <p class="text-xl text-red-400 text-center">
                                Sorry, we couldn't find a definition for <strong>"${trimmedWord}"</strong>. Please check the spelling.
                            </p>
                        `;
                    } else {
                        // Handle other HTTP errors
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return;
                }

                const data = await response.json();
                displayDefinition(trimmedWord, data);

            } catch (error) {
                console.error("Fetch error:", error);
                definitionOutput.innerHTML = `
                    <p class="text-xl text-red-400 text-center">
                        An unexpected error occurred while fetching the definition. Please try again later.
                    </p>
                `;
            }
        }

        /**
         * Replaces standalone words (4+ chars) in the definition text with clickable spans.
         * Excludes an expanded list of common function words.
         * @param {string} text The definition text.
         * @returns {string} The text with clickable links.
         */
        function highlightDefinitionText(text) {
            // List of common words to exclude from linking. Increased for more selective highlighting.
            const commonWords = [
                'the', 'and', 'but', 'not', 'for', 'with', 'from', 'that', 'this', 'have', 
                'when', 'what', 'which', 'will', 'was', 'are', 'you', 'can', 'one', 'use', 
                'any', 'all', 'out', 'into', 'upon', 'like', 'than', 'only', 'much', 'about', 
                'just', 'over', 'under', 'also', 'some', 'they', 'them', 'their', 'your', 
                'most', 'such', 'make', 'take', 'look', 'find', 'away', 'down', 'here', 'more',
                'must', 'once', 'sure', 'into', 'then', 'than'
            ];
            
            // Regex changed to find standalone words that are 4 characters or more ({4,})
            return text.replace(/\b([a-zA-Z]{4,})\b/g, (match) => {
                if (commonWords.includes(match.toLowerCase())) {
                    return match;
                }

                // Wrap the word in a clickable span. Using `data-word` attribute for lookup.
                return `<span 
                            class="highlighted-word text-cyan-400 hover:text-cyan-200 cursor-pointer font-medium" 
                            data-word="${match.toLowerCase()}">${match}</span>`;
            });
        }


        /**
         * Renders the definition data onto the page, with updated styling for definitions and synonyms.
         * @param {string} word The word being displayed.
         * @param {Array<Object>} data The array of definition objects from the API.
         */
        function displayDefinition(word, data) {
            if (!data || data.length === 0) {
                definitionOutput.innerHTML = `<p class="text-xl text-red-400 text-center">No definition data available for "${word}".</p>`;
                return;
            }

            const entry = data[0];
            // Find the best phonetic representation or default to 'N/A'
            const phoneticText = entry.phonetic || entry.phonetics?.find(p => p.text)?.text || 'N/A';
            
            let htmlContent = `
                <div class="space-y-6">
                    <h2 class="text-4xl font-semibold text-cyan-400 capitalize mb-1">${word}</h2>
                    <p class="text-xl text-gray-400">
                        <span class="pronunciation-text" title="Pronunciation">${phoneticText}</span>
                    </p>
                    <hr class="border-zinc-700" />
            `;
            
            // Iterate through all parts of speech (meanings)
            entry.meanings.forEach(meaning => {
                htmlContent += `
                    <div class="space-y-4 mb-8">
                        <h3 class="text-2xl font-semibold text-indigo-300 border-l-4 border-indigo-500 pl-3">
                            ${meaning.partOfSpeech.charAt(0).toUpperCase() + meaning.partOfSpeech.slice(1)}
                        </h3>
                        
                        <!-- Definitions Section Header and Numbered List -->
                        <div class="ml-4">
                            <h4 class="text-xl font-medium text-white mb-2 pb-1 border-b border-zinc-700">Definitions</h4>
                            <ol class="list-decimal list-inside space-y-3 pl-4">
                `;

                // Display up to 3 definitions for brevity
                meaning.definitions.slice(0, 3).forEach((def) => { 
                    // Apply highlighting to the definition text
                    const highlightedDefinition = highlightDefinitionText(def.definition);
                    
                    htmlContent += `
                        <li>
                            <div class="space-y-1">
                                <p class="text-gray-300">${highlightedDefinition}</p>
                    `;
                    
                    // Conditionally add a separator line and use smaller text for the example
                    if (def.example) {
                        htmlContent += `
                            <hr class="border-zinc-800 mt-2 mb-1 w-full" /> 
                            <p class="text-sm text-gray-500 italic">e.g. "${def.example}"</p>
                        `;
                    }
                    
                    htmlContent += `</div></li>`;
                });

                htmlContent += `</ol></div>`; // Close definitions ol and surrounding div
                
                // Display synonyms if available with special pill-shaped styling
                if (meaning.synonyms && meaning.synonyms.length > 0) {
                    // Mapping synonyms into less rounded, clickable pill-shaped span tags
                    const synonymTags = meaning.synonyms.slice(0, 5).map(s => 
                        `<span 
                            class="px-3 py-1 bg-zinc-700 text-cyan-200 rounded-lg text-sm font-semibold cursor-pointer hover:bg-zinc-600 transition synonym-tag"
                            data-word="${s}"
                        >${s}</span>`
                    ).join(' ');

                    htmlContent += `
                        <div class="ml-4 pt-4 p-3 bg-zinc-800 border border-cyan-700 rounded-lg shadow-inner">
                            <p class="text-lg text-white font-bold mb-2">Synonyms:</p>
                            <p class="flex flex-wrap gap-2">${synonymTags}</p>
                        </div>
                    `;
                }

                htmlContent += `</div>`; // Close meaning div
            });

            htmlContent += `</div>`; // Close space-y-6 div
            definitionOutput.innerHTML = htmlContent;
        }

        // --- EVENT HANDLERS ---
        
        /** Handler for Enter key press in the search box */
        function handleInputKeyDown(event) {
            if (event.key === 'Enter') {
                handleSearchClick();
            }
        }
        
        /** Handler for Search button click */
        function handleSearchClick() {
            const query = searchInput.value.trim().toLowerCase();
            if (query) {
                fetchDefinition(query);
            } else {
                definitionOutput.innerHTML = `<p class="text-lg text-gray-400 text-center">Please enter a word to search.</p>`;
            }
        }


        // --- EVENT LISTENERS ---
        searchInput.addEventListener('keydown', handleInputKeyDown);
        searchButton.addEventListener('click', handleSearchClick);

        // --- Event Delegation for Clickable Words (Synonyms and Definition Highlights) ---
        definitionOutput.addEventListener('click', (event) => {
            const target = event.target;
            let wordToSearch = null;

            if (target.classList.contains('synonym-tag')) {
                wordToSearch = target.getAttribute('data-word');
            } else if (target.classList.contains('highlighted-word')) {
                wordToSearch = target.getAttribute('data-word');
            }
            
            if (wordToSearch) {
                // Perform the new search
                fetchDefinition(wordToSearch);
            }
        });


        // --- Core Authentication and Redirection Logic (Copied from base-template.html) ---
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Initial Firebase authentication failed:", error);
            }
        }

        // 1. Listen for the authentication state change
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is authenticated
                console.log("User authenticated. UID:", user.uid);
                
                // Hide loading screen and show content
                loadingScreen.style.display = 'none';
                pageContent.classList.remove('hidden');

            } else {
                // User is NOT authenticated. Redirect to login/index page.
                console.log("User not authenticated. Redirecting to ../index.html...");
                window.location.href = '../index.html'; 
            }
        });

        // 2. Start the authentication process on load
        initializeAuth();
        
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MusicFlow - Personalized Music Platform</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../navigation.js"></script>

    <style>
        /* Apply Geist font universally and dark theme */
        body {
            font-family: 'Geist', sans-serif;
            background-color: #000000;
            color: #FFFFFF;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            padding-bottom: 72px; /* Space for the fixed bottom player */
        }
        /* Style for the fixed bottom player bar */
        #bottom-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 72px;
            z-index: 50;
            transition: transform 0.3s ease-in-out;
            transform: translateY(100%); /* Initially hidden */
        }
        .player-visible {
            transform: translateY(0%) !important;
        }
        /* Style for the full-screen video overlay */
        #fullscreen-video-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #000;
            z-index: 60;
            display: none; /* Initially hidden */
            align-items: center;
            justify-content: center;
            /* Allows closing by clicking outside the video container */
            cursor: pointer;
        }
        #fullscreen-player-container {
            /* Stop click events from bubbling to the overlay's close handler */
            cursor: default;
        }
        /* Custom scrollbar for a sleek look */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; /* Gray-800 */ }
        ::-webkit-scrollbar-thumb { background: #4b5563; /* Gray-600 */ border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; /* Gray-500 */ }
    </style>
</head>
<body>

    <main id="main-content" class="flex-grow p-4 md:p-8 pt-12">
        <h1 class="text-4xl font-semibold mb-6 tracking-tighter">Discover Music</h1>

        <div class="mb-8">
            <input type="text" id="search-input" placeholder="Search artists, songs, or video URLs..."
                   class="w-full p-3 rounded-lg bg-gray-900 border border-gray-700 focus:ring-red-500 focus:border-red-500 text-lg">
            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 mt-2">
                <button id="search-button" class="flex-grow p-3 bg-red-600 hover:bg-red-700 rounded-lg font-medium">Search YouTube Videos/Artists</button>
                <button id="add-url-button" class="flex-grow md:flex-grow-0 p-3 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium" onclick="promptAddUrl()">Add URL to Library</button>
            </div>
        </div>

        <div class="flex border-b border-gray-800 mb-6">
            <button data-view="home" class="nav-tab py-2 px-4 text-lg font-medium border-b-2 border-red-600 text-red-500">Search Results</button>
            <button data-view="library" class="nav-tab py-2 px-4 text-lg font-medium border-b-2 border-transparent hover:border-gray-600 text-gray-400 ml-4">My Library</button>
        </div>

        <section id="music-view" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-5 gap-6">
            <p id="initial-message" class="col-span-full text-gray-500">Securely fetching API key and checking authentication...</p>
        </section>
        
        <div id="youtube-player-placeholder" style="width: 1px; height: 1px; overflow: hidden; position: absolute;">
            <div id="youtube-player"></div>
        </div>

    </main>

    <div id="fullscreen-video-overlay" onclick="window.hideFullscreenPlayer()">
        <div id="fullscreen-player-container" class="w-full h-full max-w-6xl max-h-[80vh] aspect-video m-auto" onclick="event.stopPropagation()">
            </div>
        <button class="absolute top-4 right-4 p-2 bg-gray-800/80 rounded-full text-white text-xl hover:bg-gray-700 transition duration-150" onclick="event.stopPropagation(); window.hideFullscreenPlayer();">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <footer id="bottom-player" class="bg-gray-900 border-t border-gray-800 flex items-center justify-between px-4 py-2">
        <div id="player-info" class="flex items-center space-x-4 flex-grow cursor-pointer" onclick="window.showFullscreenPlayer()">
            <img id="current-thumbnail" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236B7280'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z'/%3E%3C/svg%3E" alt="Album Art" class="w-12 h-12 rounded-lg object-cover bg-gray-700">
            <div>
                <div id="current-title" class="text-sm font-medium truncate w-48">No song playing</div>
                <div id="current-artist" class="text-xs text-gray-400 truncate w-48"></div>
            </div>
        </div>

        <div class="flex items-center space-x-6">
            <button id="skip-back" class="text-gray-400 hover:text-white transition duration-150 disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7" /></svg>
            </button>
            <button id="play-pause" class="text-white hover:text-red-500 transition duration-150 p-2 rounded-full bg-gray-800 disabled:opacity-50" disabled>
                <svg id="play-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.205V10.795a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </button>
            <button id="skip-next" class="text-gray-400 hover:text-white transition duration-150 disabled:opacity-50" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7" /></svg>
            </button>
        </div>

        <button id="add-to-library-btn" class="p-2 ml-4 text-red-500 hover:text-red-400 transition duration-150 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3-7 3V5z" /></svg>
        </button>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // You must create and provide this file:
        // { const firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "..." }; export { firebaseConfig }; }
        import { firebaseConfig } from '../firebase-config.js';

        // --- GLOBAL STATE & INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const redirectPath = '../index.html';
        let youtubeApiKey = null;
        let ytPlayer = null; 
        
        // Player state
        let currentPlaylist = [];
        let currentPlaylistIndex = -1;
        let isPlayingFromLibrary = false;
        
        // Local Library Storage (Simplified: only one playlist)
        const LOCAL_STORAGE_KEY = 'musicflow_library';
        let userLibrary = loadLibrary();

        const ui = {
            musicView: document.getElementById('music-view'),
            bottomPlayer: document.getElementById('bottom-player'),
            currentTitle: document.getElementById('current-title'),
            currentArtist: document.getElementById('current-artist'),
            currentThumbnail: document.getElementById('current-thumbnail'),
            playPauseBtn: document.getElementById('play-pause'),
            playIcon: document.getElementById('play-icon'),
            skipBackBtn: document.getElementById('skip-back'),
            skipNextBtn: document.getElementById('skip-next'),
            fullscreenOverlay: document.getElementById('fullscreen-video-overlay'),
            fullscreenContainer: document.getElementById('fullscreen-player-container'),
            searchInput: document.getElementById('search-input'),
            searchButton: document.getElementById('search-button'),
            addToLibraryBtn: document.getElementById('add-to-library-btn'),
            navTabs: document.querySelectorAll('.nav-tab'),
        };

        // --- FIREBASE AND AUTHENTICATION ---

        /**
         * Fetches the YouTube API Key securely from Firestore (secrets/apis).
         */
        async function fetchApiKey() {
            try {
                // Document path based on the screenshot: 'secrets' collection, 'apis' document
                const apiDocRef = doc(db, 'secrets', 'apis');
                const docSnap = await getDoc(apiDocRef);

                if (docSnap.exists() && docSnap.data().youtubeAPI) {
                    youtubeApiKey = docSnap.data().youtubeAPI;
                    console.log("YouTube API Key successfully fetched.");
                    return true;
                } else {
                    console.error("No 'youtubeAPI' field found in 'secrets/apis' document.");
                    return false;
                }
            } catch (error) {
                console.error("Error fetching API key from Firestore:", error);
                return false;
            }
        }

        /**
         * Handles user authentication state and initialization.
         */
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                console.log("User logged out. Redirecting.");
                window.location.replace(redirectPath);
            } else {
                console.log("User signed in.");
                const keyFetched = await fetchApiKey();

                if (keyFetched) {
                    ui.musicView.innerHTML = '<p class="col-span-full text-gray-500">Enter a query above and click "Search" to find music videos/artists.</p>';
                    loadYouTubeIframeAPI();
                    attachEventListeners(user.uid);
                    renderLibrary(); // Initial library render
                } else {
                    ui.musicView.innerHTML = '<p class="col-span-full text-xl text-red-500">Error: Could not load YouTube API Key securely.</p>';
                }
            }
        });


        // --- YOUTUBE API INTEGRATION ---

        /**
         * Loads the YouTube Iframe Player API script.
         */
        function loadYouTubeIframeAPI() {
            const tag = document.createElement('script');
            tag.src = "https://www.youtube.com/iframe_api";
            const firstScriptTag = document.getElementsByTagName('script')[0];
            firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        }

        // Global function required by the YouTube Iframe API
        window.onYouTubeIframeAPIReady = function() {
            ytPlayer = new YT.Player('youtube-player', {
                height: '1', // Minimal size
                width: '1',
                videoId: '', 
                playerVars: {
                    'controls': 0,
                    'disablekb': 1,
                    'modestbranding': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'fs': 0,
                    'playsinline': 1,
                    'autoplay': 0,
                    'audio_only': 1 // Optimization for audio background play
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
            console.log("YouTube Player API Ready.");
        }

        function onPlayerReady(event) {
            console.log("Background YouTube Player is ready. Controls enabled.");
            ui.playPauseBtn.disabled = false;
            ui.skipBackBtn.disabled = false;
            ui.skipNextBtn.disabled = false;
        }

        function onPlayerStateChange(event) {
            const state = event.data;
            // Update play/pause icon
            if (state === YT.PlayerState.PLAYING) {
                // Pause icon
                ui.playIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />`;
            } else {
                // Play icon
                ui.playIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197 2.132A1 1 0 0110 13.205V10.795a1 1 0 011.555-.832l3.197 2.132a1 1 0 010 1.664z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
            }
            
            // Auto-advance to next song if current one ends
            if (state === YT.PlayerState.ENDED) {
                console.log("Song ended. Skipping to next.");
                skipNext();
            }
        }

        /**
         * Search for YouTube videos/channels using the secured API key.
         */
        async function performSearch(query) {
            if (!youtubeApiKey || !query.trim()) return;

            ui.musicView.innerHTML = '<p class="col-span-full text-xl text-gray-400">Searching YouTube for music...</p>';
            
            // Focus on music videos and artist channels
            const apiUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video,channel&videoCategoryId=10&maxResults=20&key=${youtubeApiKey}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    currentPlaylist = data.items.filter(item => item.id.kind === 'youtube#video').map(item => ({
                        videoId: item.id.videoId,
                        title: item.snippet.title,
                        artist: item.snippet.channelTitle,
                        thumbnail: item.snippet.thumbnails.medium.url,
                        url: `https://www.youtube.com/watch?v=${item.id.videoId}`
                    }));
                    renderSearchResults(data.items);
                } else {
                    ui.musicView.innerHTML = '<p class="col-span-full text-xl text-gray-400">No music videos or artists found for your query.</p>';
                }
            } catch (error) {
                console.error("YouTube API Search Error:", error);
                ui.musicView.innerHTML = '<p class="col-span-full text-xl text-red-500">Search failed. API issue or network error.</p>';
            }
        }

        /**
         * Renders search results (videos and artists) into the main view.
         */
        function renderSearchResults(items) {
            ui.musicView.innerHTML = ''; 
            items.forEach((item, index) => {
                const isVideo = item.id.kind === 'youtube#video';
                const id = isVideo ? item.id.videoId : item.id.channelId;
                const title = item.snippet.title;
                const channelTitle = item.snippet.channelTitle;
                const thumbnail = item.snippet.thumbnails.medium.url;

                const card = document.createElement('div');
                card.className = 'bg-gray-900 rounded-xl overflow-hidden shadow-lg hover:shadow-red-500/50 transition duration-300 cursor-pointer flex flex-col';
                card.dataset.id = id;
                card.dataset.type = isVideo ? 'video' : 'artist';
                
                card.innerHTML = `
                    <div class="relative">
                        <img src="${thumbnail}" alt="${title}" class="w-full h-48 object-cover">
                        ${isVideo ? `<span class="absolute bottom-2 right-2 bg-black/70 text-white text-xs px-2 py-0.5 rounded-full">Video</span>` : `<span class="absolute bottom-2 right-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">Artist</span>`}
                    </div>
                    <div class="p-4 flex-grow">
                        <h3 class="font-medium text-lg mb-1 line-clamp-2">${title}</h3>
                        <p class="text-sm text-gray-400 line-clamp-1">${channelTitle}</p>
                    </div>
                    <div class="p-4 pt-0">
                        ${isVideo 
                            ? `<button data-index="${index}" class="play-video-btn w-full p-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold">Play Now</button>` 
                            : `<button class="view-artist-btn w-full p-2 bg-gray-700 hover:bg-gray-600 rounded-lg text-sm font-semibold">View Channel</button>`
                        }
                    </div>
                `;
                
                // Play button click for videos
                if (isVideo) {
                    card.querySelector('.play-video-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        const videoIndex = parseInt(e.currentTarget.dataset.index);
                        startPlaylist(currentPlaylist, videoIndex, false);
                    });
                }
                
                // Card click listener for playing video or searching artist's channel
                card.addEventListener('click', () => {
                    if (isVideo) {
                        const videoIndex = items.filter(i => i.id.kind === 'youtube#video').findIndex(i => i.id.videoId === id);
                        startPlaylist(currentPlaylist, videoIndex, false);
                    } else {
                        // Search for the artist's videos
                        ui.searchInput.value = channelTitle;
                        performSearch(channelTitle);
                    }
                });

                ui.musicView.appendChild(card);
            });
        }

        // --- PLAYER CONTROLS & LOGIC ---

        /**
         * Starts playback of a new playlist from a specified index.
         */
        function startPlaylist(playlist, index, fromLibrary = false) {
            if (!playlist || playlist.length === 0 || index < 0 || index >= playlist.length) return;
            
            currentPlaylist = playlist;
            currentPlaylistIndex = index;
            isPlayingFromLibrary = fromLibrary;
            
            const currentSong = currentPlaylist[currentPlaylistIndex];
            
            // 1. Load the video in the background player
            ytPlayer.loadVideoById(currentSong.videoId, 0, 'large'); // loadVideoById is generally safer than cueVideoById
            
            // 2. Update the bottom player UI
            ui.currentTitle.textContent = currentSong.title;
            ui.currentArtist.textContent = currentSong.artist;
            ui.currentThumbnail.src = currentSong.thumbnail;
            ui.bottomPlayer.classList.add('player-visible');
            
            ui.addToLibraryBtn.dataset.videoId = currentSong.videoId;
            ui.addToLibraryBtn.dataset.title = currentSong.title;
            ui.addToLibraryBtn.dataset.artist = currentSong.artist;
            ui.addToLibraryBtn.dataset.thumbnail = currentSong.thumbnail;
            ui.addToLibraryBtn.classList.remove('hidden');

            console.log(`Now Playing [${currentPlaylistIndex + 1}/${currentPlaylist.length}]: ${currentSong.title}`);
        }

        /**
         * Toggles play/pause for the current video.
         */
        function togglePlayPause() {
            if (!ytPlayer || currentPlaylistIndex === -1) return;

            const state = ytPlayer.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                ytPlayer.pauseVideo();
            } else if (state === YT.PlayerState.PAUSED || state === YT.PlayerState.BUFFERING || state === YT.PlayerState.CUED) {
                ytPlayer.playVideo();
            }
        }

        /**
         * Skips to the next video in the current playlist.
         */
        function skipNext() {
            if (currentPlaylistIndex === -1) return;

            const nextIndex = currentPlaylistIndex + 1;
            if (nextIndex < currentPlaylist.length) {
                startPlaylist(currentPlaylist, nextIndex, isPlayingFromLibrary);
            } else {
                console.log("End of playlist reached.");
                // Optionally stop or loop
                ytPlayer.stopVideo();
                ui.currentTitle.textContent = "Playlist finished";
                ui.currentArtist.textContent = "";
            }
        }

        /**
         * Skips to the previous video in the current playlist.
         */
        function skipBack() {
            if (currentPlaylistIndex <= 0) return;

            const prevIndex = currentPlaylistIndex - 1;
            startPlaylist(currentPlaylist, prevIndex, isPlayingFromLibrary);
        }

        /**
         * Global function to display the video in a full-screen overlay.
         */
        window.showFullscreenPlayer = function() {
            if (currentPlaylistIndex === -1) return;
            
            const currentSong = currentPlaylist[currentPlaylistIndex];
            
            // Ensure the player is playing before moving it
            if (ytPlayer.getPlayerState() !== YT.PlayerState.PLAYING) {
                ytPlayer.playVideo();
            }

            // Create a temporary div to house the new, larger player instance
            const fullPlayerDiv = document.createElement('div');
            fullPlayerDiv.id = 'temp-fullscreen-player';
            fullPlayerDiv.className = 'w-full h-full'; 
            ui.fullscreenContainer.innerHTML = '';
            ui.fullscreenContainer.appendChild(fullPlayerDiv);
            
            // Get current time to resume playback
            const currentTime = ytPlayer.getCurrentTime();
            
            // Destroy the old, small player instance
            ytPlayer.destroy();
            
            // Create a new, large player instance in the fullscreen container
            ytPlayer = new YT.Player('temp-fullscreen-player', {
                videoId: currentSong.videoId,
                height: '100%',
                width: '100%',
                playerVars: {
                    'controls': 1, // Show controls in fullscreen
                    'autoplay': 1,
                    'start': Math.floor(currentTime) // Resume from where it was
                },
                events: {
                    'onReady': (e) => { e.target.playVideo(); },
                    'onStateChange': onPlayerStateChange
                }
            });

            ui.fullscreenOverlay.style.display = 'flex';
            ui.bottomPlayer.style.display = 'none'; // Hide bottom bar when fullscreen
        }

        /**
         * Global function to hide the full-screen overlay and move the player back.
         */
        window.hideFullscreenPlayer = function() {
            if (currentPlaylistIndex === -1) return;

            const currentSong = currentPlaylist[currentPlaylistIndex];
            const currentTime = ytPlayer.getCurrentTime();
            
            // Destroy the large player instance
            ytPlayer.destroy();
            
            // Hide the overlay and show the bottom bar
            ui.fullscreenOverlay.style.display = 'none';
            ui.bottomPlayer.style.display = 'flex';
            
            // Create the small, background player instance again
            const playerPlaceholder = document.getElementById('youtube-player-placeholder');
            playerPlaceholder.innerHTML = '<div id="youtube-player"></div>';
            
            ytPlayer = new YT.Player('youtube-player', {
                height: '1',
                width: '1',
                videoId: currentSong.videoId,
                playerVars: {
                    'controls': 0,
                    'disablekb': 1,
                    'modestbranding': 1,
                    'rel': 0,
                    'showinfo': 0,
                    'fs': 0,
                    'playsinline': 1,
                    'start': Math.floor(currentTime), // Resume playback
                    'autoplay': 1,
                    'audio_only': 1
                },
                events: {
                    'onReady': (e) => { e.target.playVideo(); },
                    'onStateChange': onPlayerStateChange
                }
            });
        }


        // --- LOCAL LIBRARY & PLAYLIST MANAGEMENT ---

        /**
         * Loads the user's library from local storage.
         */
        function loadLibrary() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                console.error("Error loading library from local storage:", e);
                return [];
            }
        }

        /**
         * Saves the user's library to local storage.
         */
        function saveLibrary() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(userLibrary));
                console.log("Library saved successfully.");
            } catch (e) {
                console.error("Error saving library to local storage:", e);
            }
        }
        
        /**
         * Adds the currently playing video or a specified video to the library.
         */
        function addToLibrary(songData) {
            const videoId = songData.videoId;
            const existing = userLibrary.find(s => s.videoId === videoId);

            if (existing) {
                alert("This song is already in your library!");
                return;
            }

            const newSong = {
                videoId: videoId,
                title: songData.title,
                artist: songData.artist,
                thumbnail: songData.thumbnail,
                url: `https://www.youtube.com/watch?v=${videoId}`,
                added: new Date().toISOString()
            };
            
            userLibrary.push(newSong);
            saveLibrary();
            alert(`"${newSong.title}" added to your library!`);
            
            // If viewing the library, refresh it
            if (ui.navTabs[1].classList.contains('border-red-600')) {
                renderLibrary();
            }
        }

        /**
         * Renders the local library contents.
         */
        function renderLibrary() {
            ui.musicView.innerHTML = '';
            
            if (userLibrary.length === 0) {
                ui.musicView.innerHTML = '<p class="col-span-full text-xl text-gray-500">Your library is empty. Add songs from search results!</p>';
                return;
            }

            userLibrary.forEach((song, index) => {
                const card = document.createElement('div');
                card.className = 'bg-gray-800 rounded-xl overflow-hidden shadow-lg hover:shadow-red-500/50 transition duration-300 flex flex-col';
                
                card.innerHTML = `
                    <div class="relative cursor-pointer" onclick="window.startPlaylist(window.userLibrary, ${index}, true)">
                        <img src="${song.thumbnail}" alt="${song.title}" class="w-full h-48 object-cover">
                        <span class="absolute bottom-2 left-2 bg-red-600/90 text-white text-xs px-2 py-0.5 rounded-full">Library Track</span>
                    </div>
                    <div class="p-4 flex-grow">
                        <h3 class="font-medium text-lg mb-1 line-clamp-2">${song.title}</h3>
                        <p class="text-sm text-gray-400 line-clamp-1">${song.artist}</p>
                    </div>
                    <div class="p-4 pt-0 flex space-x-2">
                        <button class="play-library-btn w-full p-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm font-semibold" 
                            onclick="window.startPlaylist(window.userLibrary, ${index}, true)">Play</button>
                        <button class="remove-library-btn p-2 bg-gray-600 hover:bg-gray-500 rounded-lg text-sm font-semibold"
                            data-index="${index}" title="Remove from Library">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                `;
                
                card.querySelector('.remove-library-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const songIndex = parseInt(e.currentTarget.dataset.index);
                    if (confirm(`Are you sure you want to remove "${userLibrary[songIndex].title}" from your library?`)) {
                        userLibrary.splice(songIndex, 1);
                        saveLibrary();
                        renderLibrary(); // Re-render to update the list
                    }
                });

                ui.musicView.appendChild(card);
            });
        }
        
        /**
         * Prompts the user to enter a YouTube video URL and tries to add it.
         * Note: This is simplified and does not use the API's 'videos' endpoint
         * to fetch full metadata, relying only on the URL/videoId.
         */
        function promptAddUrl() {
            const url = prompt("Enter a YouTube Video URL (e.g., https://www.youtube.com/watch?v=dQw4w9WgXcQ):");
            if (url) {
                const videoIdMatch = url.match(/(?:\?v=|\/embed\/|\/v\/|youtu\.be\/|\/shorts\/)([a-zA-Z0-9_-]{11})[^#&]*/);
                if (videoIdMatch && videoIdMatch[1]) {
                    const videoId = videoIdMatch[1];
                    const songData = {
                        videoId: videoId,
                        title: `Custom URL: ${videoId}`, 
                        artist: 'Unknown Artist',
                        thumbnail: `https://img.youtube.com/vi/${videoId}/mqdefault.jpg` // Generic thumbnail
                    };
                    addToLibrary(songData);
                } else {
                    alert("Invalid YouTube URL format. Please ensure it contains a valid video ID.");
                }
            }
        }


        // --- EVENT LISTENERS ---

        function attachEventListeners() {
            ui.searchButton.addEventListener('click', () => {
                const query = ui.searchInput.value.trim();
                if (query) {
                    performSearch(query);
                    // Switch to search results view
                    switchView('home');
                }
            });
            
            ui.searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    ui.searchButton.click();
                }
            });

            ui.playPauseBtn.addEventListener('click', togglePlayPause);
            ui.skipBackBtn.addEventListener('click', skipBack);
            ui.skipNextBtn.addEventListener('click', skipNext);
            
            ui.addToLibraryBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const btn = e.currentTarget;
                const songData = {
                    videoId: btn.dataset.videoId,
                    title: btn.dataset.title,
                    artist: btn.dataset.artist,
                    thumbnail: btn.dataset.thumbnail
                };
                if (songData.videoId) {
                    addToLibrary(songData);
                }
            });

            // Navigation Tab Listeners
            ui.navTabs.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const view = e.currentTarget.dataset.view;
                    switchView(view);
                });
            });
        }
        
        /**
         * Switches the main content view between 'home' (search) and 'library'.
         */
        function switchView(view) {
            ui.navTabs.forEach(tab => {
                const isActive = tab.dataset.view === view;
                tab.classList.toggle('border-red-600', isActive);
                tab.classList.toggle('text-red-500', isActive);
                tab.classList.toggle('border-transparent', !isActive);
                tab.classList.toggle('text-gray-400', !isActive);
            });

            if (view === 'library') {
                renderLibrary();
                isPlayingFromLibrary = true;
            } else {
                // Return to search results view, or initial message if nothing searched
                if (currentPlaylist.length === 0) {
                     ui.musicView.innerHTML = '<p class="col-span-full text-gray-500">Enter a query above and click "Search" to find music videos/artists.</p>';
                } else {
                    renderSearchResults(currentPlaylist.map(song => ({
                        id: { kind: 'youtube#video', videoId: song.videoId },
                        snippet: { title: song.title, channelTitle: song.artist, thumbnails: { medium: { url: song.thumbnail } } }
                    })));
                }
                isPlayingFromLibrary = false;
            }
        }

        // Expose necessary functions/data globally for HTML onclicks
        window.startPlaylist = startPlaylist;
        window.userLibrary = userLibrary;

    </script>
</body>
</html>

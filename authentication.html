<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - ACCESS ACCOUNT</title>
    <meta name="description" content="Log into or create your 4SP account to access the student toolkit.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="../navigation-mini.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Unified Tailwind CSS configuration for a consistent dark theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#070707', // Body background
                        'custom-dark-gray': '#111111',    // Form container background
                        'custom-medium-gray': '#252525', // Borders, inputs, buttons
                        'custom-light-gray': '#505050',  // Labels and secondary text
                        'custom-lighter-gray': '#808080', // Hover states and subtle text
                        'custom-white-gray': '#c0c0c0',  // Main text and headings
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --geist-foreground: 192, 192, 192; /* custom-white-gray */
            --geist-background: 7, 7, 7;       /* custom-darkest-gray */
        }

        body {
            font-family: 'Geist', sans-serif;
            background-color: rgb(var(--geist-background));
            color: rgb(var(--geist-foreground));
            transition: all 0.3s ease;
        }
        
        /* Layout-specific CSS removed and moved to Tailwind classes for better consistency */
        .btn-social {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .btn-social:hover {
            background-color: rgba(37, 37, 37, 0.7); /* custom-medium-gray with transparency */
            border-color: #383838;
        }
        
        .message-area { min-height: 20px; }
        .error-message { color: #f87171; font-weight: bold; }
        .success-message { color: #4ade80; }
        .warning-message { color: #fbbf24; }
        
        @media (max-width: 767px) {
            /* Keep existing mobile styles */
            .right-col { display: none; }
            .left-col { border-right: none; }
        }
    </style>
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex flex-col">

    <div id="navbar-container"></div>
    <main class="flex-grow flex items-stretch justify-center p-0">
        <div class="auth-split-container bg-custom-darkest-gray flex flex-wrap w-full h-full border-0 overflow-hidden p-0 mx-auto max-w-[1200px]">
            
            <div class="auth-col left-col flex-1 flex flex-col justify-center items-center bg-custom-darkest-gray min-w-[300px] md:border-r md:border-custom-medium-gray h-full">

                <div id="loginContainer" class="w-full flex flex-col items-center px-8 py-16">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Login to Your Account</h2>
                    <form id="loginForm" novalidate class="w-full max-w-md"> 
                        <div class="mb-5">
                            <label for="loginEmail" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Email</label>
                            <input type="email" id="loginEmail" placeholder="Enter your email" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                        </div>
                        <div class="mb-5">
                            <label for="loginPassword" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Password</label>
                            <input type="password" id="loginPassword" placeholder="Enter your password" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                        </div>
                        <button type="submit" class="w-full p-3 bg-custom-medium-gray text-custom-white-gray rounded-lg font-semibold text-lg cursor-pointer transition hover:bg-custom-light-gray">LOGIN</button>
                    </form>
                    <div id="loginMessage" class="message-area w-full max-w-md mt-4 text-center text-sm"></div>
                    <div class="w-full max-w-md mt-4 text-center"> <a id="forgotPasswordLink" class="text-custom-light-gray hover:text-custom-lighter-gray font-medium text-sm cursor-pointer">Forgot Password?</a> </div>
                    <p class="text-sm text-custom-light-gray mt-6 text-center w-full max-w-md">Don't have an account? <a id="showSignupLink" href="#" class="text-custom-light-gray font-semibold hover:text-custom-lighter-gray transition">Sign up here</a></p>
                </div>

                <div id="resetPasswordContainer" class="w-full flex-col items-center px-8 py-16" style="display: none;">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Reset Your Password</h2>
                    <p class="text-custom-light-gray text-base mb-6 text-center max-w-md">Enter your email address and we'll send you a link to reset your password.</p>
                    <form id="resetPasswordForm" novalidate class="w-full max-w-md">
                        <div class="mb-5">
                            <label for="resetEmail" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Email</label>
                            <input type="email" id="resetEmail" placeholder="Enter your registered email" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                        </div>
                        <button type="submit" class="w-full p-3 bg-custom-medium-gray text-custom-white-gray rounded-lg font-semibold text-lg cursor-pointer transition hover:bg-custom-light-gray">SEND RESET LINK</button>
                    </form>
                    <div id="resetMessage" class="message-area w-full max-w-md mt-4 text-center text-sm"></div>
                    <div class="w-full max-w-md mt-6 text-center"> <a id="backToLoginLink" class="text-custom-light-gray hover:text-custom-lighter-gray font-medium text-sm cursor-pointer">&larr; Back to Login</a> </div>
                </div>

                <div id="usernameContainer" class="w-full flex-col items-center px-8 py-16" style="display: none;">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Choose Your Username</h2>
                    <form id="usernameForm" novalidate class="w-full max-w-md"> 
                        <div class="mb-5">
                            <label for="signupUsername" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Username</label>
                            <input type="text" id="signupUsername" placeholder="4-24 characters, including symbols" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                            <p class="text-xs text-custom-lighter-gray mt-2 text-left">Allowed symbols: .,-+\_!?$</p>
                        </div>
                        <button type="submit" class="w-full p-3 bg-custom-medium-gray text-custom-white-gray rounded-lg font-semibold text-lg cursor-pointer transition hover:bg-custom-light-gray">NEXT</button>
                    </form>
                    <div id="usernameMessage" class="message-area w-full max-w-md mt-4 text-center text-sm"></div>
                    <p class="text-sm text-custom-light-gray mt-6 text-center w-full max-w-md">Already have an account? <a id="showLoginLink" href="#" class="text-custom-light-gray font-semibold hover:text-custom-lighter-gray transition">Login here</a></p>
                </div>
                
                <div id="signupContainer" class="w-full flex-col items-center px-8 py-16" style="display: none;">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Set Your Credentials</h2>
                    <form id="signupForm" novalidate class="w-full max-w-md"> 
                        <div class="mb-5">
                            <label for="signupEmail" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Email</label>
                            <input type="email" id="signupEmail" placeholder="Enter your email" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                        </div>
                        <div class="mb-5">
                            <label for="signupPassword" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Password</label>
                            <input type="password" id="signupPassword" placeholder="Enter your password" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                            <p class="text-xs text-custom-lighter-gray mt-2 text-left">8-48 chars, must include 1 uppercase, 1 number, and 1 special symbol.</p>
                        </div>
                        <button type="submit" class="w-full p-3 bg-custom-medium-gray text-custom-white-gray rounded-lg font-semibold text-lg cursor-pointer transition hover:bg-custom-light-gray">CREATE ACCOUNT</button>
                    </form>
                    <div id="signupMessage" class="message-area w-full max-w-md mt-4 text-center text-sm"></div>
                    <div class="w-full max-w-md mt-6 text-center"> <a id="backToUsernameLink" class="text-custom-light-gray hover:text-custom-lighter-gray font-medium text-sm cursor-pointer">&larr; Back to Username</a> </div>
                </div>

            </div>

            <div class="auth-col right-col flex-1 flex flex-col items-center justify-center bg-custom-darkest-gray h-full">
                <div class="w-full flex flex-col items-center justify-start px-8 py-16">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Continue instantly</h2>
                    <p class="text-lg text-custom-light-gray mb-8 text-center max-w-md">
                        Use a trusted provider to sign in or create an account in one click.
                    </p>
                    
                    <button id="googleAuthBtn" class="btn-social flex items-center justify-center w-full max-w-md p-3 bg-custom-dark-gray text-custom-white-gray border border-custom-medium-gray rounded-lg font-medium cursor-pointer mb-3">
                        <img src="images/google-icon.png" alt="Google Logo" class="w-5 h-5 mr-3">
                        Continue with Google
                    </button>
                    <button id="githubAuthBtn" class="btn-social flex items-center justify-center w-full max-w-md p-3 bg-custom-dark-gray text-custom-white-gray border border-custom-medium-gray rounded-lg font-medium cursor-pointer mb-3">
                        <img src="images/github-mark-white.png" alt="GitHub Logo" class="w-5 h-5 mr-3">
                        Continue with GitHub
                    </button>
                    <button id="microsoftAuthBtn" class="btn-social flex items-center justify-center w-full max-w-md p-3 bg-custom-dark-gray text-custom-white-gray border border-custom-medium-gray rounded-lg font-medium cursor-pointer mb-3">
                        <img src="images/microsoft.png" alt="Microsoft Logo" class="w-5 h-5 mr-3">
                        Continue with Microsoft
                    </button>
                    
                    <p class="text-xs italic text-custom-light-gray text-center max-w-md mt-4 leading-relaxed">
                        By continuing, you agree to our <a href="legal.html" target="_blank" class="text-custom-light-gray hover:text-custom-lighter-gray">Terms of Service</a> and <a href="legal.html" target="_blank" class="text-custom-light-gray hover:text-custom-lighter-gray">Privacy Policy</a>.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="w-full py-2 flex items-center justify-center bg-black border-t border-custom-medium-gray">
        <div class="text-center text-custom-light-gray text-xs">
            &copy; 2024 4simpleproblems (4SP). Built for students.
        </div>
    </footer>

    <script type="module">
        // --- Firebase Imports (Combined) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            sendPasswordResetEmail,
            sendEmailVerification,
            fetchSignInMethodsForEmail,
            signOut,
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            signInWithPopup,
            setPersistence,
            browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- Import Firebase Config ---
        import { firebaseConfig } from "./firebase-config.js"; 

        // --- Canvas Global Variables (MANDATORY USE) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        if (!firebaseConfig || !firebaseConfig.apiKey) {
            console.error("FATAL ERROR: Firebase configuration is missing or invalid.");
        }

        // --- Firebase Initialization ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        setLogLevel('debug'); // Enable Firestore logging

        // --- Beta Tester Check Function ---
        const isUserBetaTester = async (email) => {
            if (!email) return false;
            const normalizedEmail = email.toLowerCase();

            // --- ADMIN OVERRIDE ---
            // Hardcoded email to always allow access
            if (normalizedEmail === "4simpleproblems@gmail.com") {
                console.log("Admin override: Access granted for 4simpleproblems@gmail.com");
                return true;
            }
            // --- END ADMIN OVERRIDE ---
            
            // Define the path to the beta testers document
            const betaTestersRef = doc(db, 'artifacts', appId, 'public', 'data', 'app_config', 'beta_testers');
            
            try {
                const docSnap = await getDoc(betaTestersRef);
                
                if (docSnap.exists()) {
                    const emails = docSnap.data()?.emails || [];
                    const normalizedEmails = emails.map(e => String(e).toLowerCase());
                    return normalizedEmails.includes(normalizedEmail);
                } else {
                    // If the list doc doesn't exist, deny access (fail-closed)
                    console.warn("Beta tester list document not found. Access denied.");
                    return false;
                }
            } catch (error) {
                console.error("Error checking beta tester status:", error);
                // If there's an error, deny access (fail-closed)
                return false;
            }
        };

        // --- Unified Data Model ---
        // All user profile data will be stored in a top-level 'users' collection.
        const getUserDocRef = (userId) => doc(db, 'users', userId);
        let selectedUsername = null; // Store username between signup steps

        // --- DOM Elements ---
        const containers = {
            login: document.getElementById('loginContainer'),
            reset: document.getElementById('resetPasswordContainer'),
            username: document.getElementById('usernameContainer'),
            signup: document.getElementById('signupContainer')
        };
        const messageDivs = {
            login: document.getElementById('loginMessage'),
            reset: document.getElementById('resetMessage'),
            username: document.getElementById('usernameMessage'),
            signup: document.getElementById('signupMessage')
        };

        // --- View Management ---
        const showView = (viewName) => {
            Object.values(messageDivs).forEach(div => div.innerHTML = '');
            for (const key in containers) {
                containers[key].style.display = (key === viewName) ? 'flex' : 'none';
                if (key === viewName) {
                    containers[key].style.flexDirection = 'column';
                }
            }
        };

        // --- Helper Functions ---
        const showMessage = (element, text, type = 'error') => {
            element.innerHTML = text;
            element.className = `message-area w-full max-w-md mt-4 text-center text-sm ${type}-message`;
        };

        const navigateToDashboard = () => window.location.href = 'logged-in/dashboard.html';

        const createUserDocument = async (user, authMethod, username) => {
            const isVerified = authMethod !== 'email' || !!user.emailVerified;
            try {
                await setDoc(getUserDocRef(user.uid), {
                    email: user.email, 
                    authMethod: authMethod, 
                    createdAt: serverTimestamp(),
                    username: username, 
                    emailVerified: isVerified
                });
                return true;
            } catch (error) { 
                console.error("Error creating user document:", error); 
                return false; 
            }
        };

        const handleSuccessfulLogin = async (user) => {
            await setPersistence(auth, browserLocalPersistence);
            
            // --- NEW: BETA TESTER CHECK (for Email + Existing Social) ---
            const isBetaTester = await isUserBetaTester(user.email);
            if (!isBetaTester) {
                const googleFormLink = "https://docs.google.com/forms/d/e/1FAIpQLSdWdL4RTE8p7t7gMGYpIHYiYcV__sNa8vOlwOCQyoolKuQimQ/viewform?usp=publish-editor";
                showMessage(messageDivs.login, `This account is not on the beta tester list. <a href="${googleFormLink}" target="_blank" class="underline font-bold text-yellow-300">Apply for beta access here</a>.`, 'warning');
                await signOut(auth); // Log them out.
                return; // Stop further execution.
            }
            // --- End Beta Tester Check ---
            
            const isProviderLogin = user.providerData.some(p => ['google.com', 'github.com', 'microsoft.com'].includes(p.providerId));
            
            if (user.emailVerified || isProviderLogin) {
                navigateToDashboard();
            } else {
                showMessage(messageDivs.login, 'Your email is not verified. Please check your inbox. <a href="#" id="resend-link" class="underline cursor-pointer">Resend email</a>', 'error');
                document.getElementById('resend-link').addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        await sendEmailVerification(user);
                        showMessage(messageDivs.login, 'A new verification link has been sent!', 'success');
                    } catch (err) { showMessage(messageDivs.login, `Error sending email: ${err.message}`); }
                });
                await signOut(auth);
            }
        };

        const checkProfanity = async (text) => {
            try {
                const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                const result = await response.text();
                return result.toLowerCase() === 'true';
            } catch (error) { console.error('Profanity API error:', error); return false; }
        };

        const isUsernameTaken = async (username) => {
            const q = query(collection(db, 'users'), where('username', '==', username));
            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty;
        };

        const validatePassword = (password) => {
            if (password.length < 8 || password.length > 48) return 'Password must be 8-48 characters.';
            if (!/[A-Z]/.test(password)) return 'Password must contain an uppercase letter.';
            if (!/[0-9]/.test(password)) return 'Password must contain a number.';
            if (!/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)) return 'Password must contain a special symbol.';
            return null;
        };

        // --- Event Listener Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial view
            showView('login');

            // --- View Navigation ---
            document.getElementById('showSignupLink').addEventListener('click', (e) => { e.preventDefault(); showView('username'); });
            document.getElementById('showLoginLink').addEventListener('click', (e) => { e.preventDefault(); showView('login'); });
            document.getElementById('forgotPasswordLink').addEventListener('click', () => showView('reset'));
            document.getElementById('backToLoginLink').addEventListener('click', () => showView('login'));
            document.getElementById('backToUsernameLink').addEventListener('click', () => showView('username'));

            // --- Form Handlers ---

            // Login Form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value.trim();
                const password = document.getElementById('loginPassword').value;
                if (!email || !password) { showMessage(messageDivs.login, 'Please enter both email and password.'); return; }

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const userDoc = await getDoc(getUserDocRef(userCredential.user.uid));
                    if (userDoc.exists()) {
                        await handleSuccessfulLogin(userCredential.user);
                    } else {
                        await signOut(auth);
                        showMessage(messageDivs.login, 'Account record is incomplete. Please sign up again or contact support.');
                    }
                } catch (error) {
                    let msg = 'Invalid email or password.';
                    if (error.code === 'auth/too-many-requests') msg = 'Access temporarily disabled due to too many failed login attempts.';
                    else if (error.code === 'auth/user-disabled') msg = 'Your account has been disabled.';
                    showMessage(messageDivs.login, msg);
                }
            });

            // Password Reset Form
            document.getElementById('resetPasswordForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('resetEmail').value.trim();
                if (!email) { showMessage(messageDivs.reset, 'Please enter your email.'); return; }

                try {
                    const methods = await fetchSignInMethodsForEmail(auth, email);
                    if (methods.length === 0) {
                        showMessage(messageDivs.reset, 'No account found with this email.');
                    } else if (methods.some(m => m !== 'password')) {
                        showMessage(messageDivs.reset, 'This account uses a social provider and does not have a password to reset.');
                    } else {
                        await sendPasswordResetEmail(auth, email);
                        showMessage(messageDivs.reset, 'Password reset link sent! Check your inbox.', 'success');
                    }
                } catch (error) {
                    showMessage(messageDivs.reset, 'An error occurred. Please check the email and try again.');
                }
            });

            // Signup Step 1: Username Form
            document.getElementById('usernameForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('signupUsername').value.trim();
                if (username.length < 4 || username.length > 24) { showMessage(messageDivs.username, 'Username must be 4-24 characters.'); return; }
                if (!/^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/.test(username)) { showMessage(messageDivs.username, 'Username contains invalid characters.'); return; }

                showMessage(messageDivs.username, 'Checking username...', 'warning');
                if (await checkProfanity(username)) { showMessage(messageDivs.username, 'This username is not allowed. Please choose another.'); return; }
                if (await isUsernameTaken(username)) { showMessage(messageDivs.username, 'This username is already taken.'); return; }

                selectedUsername = username;
                showView('signup');
                document.getElementById('signupEmail').focus();
            });

            // Signup Step 2: Credentials Form
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value.trim();
                const password = document.getElementById('signupPassword').value;

                // --- NEW: BETA TESTER CHECK (for New Email Signup) ---
                const isBetaTester = await isUserBetaTester(email);
                if (!isBetaTester) {
                    const googleFormLink = "https://docs.google.com/forms/d/e/1FAIpQLSdWdL4RTE8p7t7gMGYpIHYiYcV__sNa8vOlwOCQyoolKuQimQ/viewform?usp=publish-editor";
                    showMessage(messageDivs.signup, `This email is not on the beta tester list. <a href="${googleFormLink}" target="_blank" class="underline font-bold text-yellow-300">Apply for beta access here</a>.`, 'warning');
                    return; // Stop account creation
                }
                // --- End Beta Tester Check ---
                
                const passwordError = validatePassword(password);
                if (passwordError) { showMessage(messageDivs.signup, passwordError); return; }

                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await sendEmailVerification(userCredential.user);
                    const docCreated = await createUserDocument(userCredential.user, 'email', selectedUsername);

                    if (docCreated) {
                        await signOut(auth);
                        showMessage(messageDivs.signup, `Success! A verification email has been sent to ${email}. You can now log in.`, 'success');
                    } else {
                        await userCredential.user.delete();
                        showMessage(messageDivs.signup, 'Failed to create user record. Please try again.');
                    }
                } catch (error) {
                    let msg = 'An unknown error occurred.';
                    if (error.code === 'auth/email-already-in-use') msg = 'This email is already in use. Please log in instead.';
                    else if (error.code === 'auth/invalid-email') msg = 'The email address is not valid.';
                    else if (error.code === 'auth/weak-password') msg = 'Password is too weak.';
                    showMessage(messageDivs.signup, msg);
                }
            });

            // --- Social Authentication Handler (Unified for Login & Signup) ---
            const handleSocialAuth = async (provider) => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    const userDoc = await getDoc(getUserDocRef(user.uid));
                    const providerName = provider.providerId.split('.')[0];

                    if (userDoc.exists()) {
                        // User exists -> Log them in
                        // This will trigger handleSuccessfulLogin, which has the beta check.
                        await handleSuccessfulLogin(user);
                    } else {
                        // New user -> Create account
                        
                        // --- NEW: BETA TESTER CHECK (for New Social) ---
                        const isBetaTester = await isUserBetaTester(user.email);
                        if (!isBetaTester) {
                            const googleFormLink = "https://docs.google.com/forms/d/e/1FAIpQLSdWdL4RTE8p7t7gMGYpIHYiYcV__sNa8vOlwOCQyoolKuQimQ/viewform?usp=publish-editor";
                            const visibleMessageDiv = messageDivs.login.offsetParent ? messageDivs.login : messageDivs.username;
                            showMessage(visibleMessageDiv, `This account is not on the beta tester list. <a href="${googleFormLink}" target="_blank" class="underline font-bold text-yellow-300">Apply for beta access here</a>.`, 'warning');
                            
                            // Important: Delete the just-created auth user and sign out
                            try {
                                await user.delete();
                                console.log("Deleted non-beta social user from Firebase Auth.");
                            } catch (deleteError) {
                                console.error("Error deleting non-beta user:", deleteError);
                                // If deletion fails, at least sign them out.
                                await signOut(auth);
                            }
                            return; // Stop execution
                        }
                        // --- End Beta Tester Check ---
                        
                        let username = (user.displayName || user.email.split('@')[0] || 'User')
                            .replace(/[^a-zA-Z0-9]/g, '').slice(0, 16);
                        if (username.length < 4) username = `User${user.uid.substring(0, 8)}`;
                        if (await checkProfanity(username)) username = `User${user.uid.substring(0, 8)}`;
                        
                        let finalUsername = username;
                        let counter = 1;
                        while (await isUsernameTaken(finalUsername)) {
                            finalUsername = `${username.slice(0, 14)}_${counter++}`;
                        }

                        const docCreated = await createUserDocument(user, providerName, finalUsername);
                        if (docCreated) {
                            // Since this is a new social user, they are already "verified"
                            // and have passed the beta check. Log them in.
                            await setPersistence(auth, browserLocalPersistence);
                            navigateToDashboard();
                        } else {
                            throw new Error('Failed to create user document for social auth.');
                        }
                    }
                } catch (error) {
                    let msg = `A problem occurred during social sign-in.`;
                    if (error.code === 'auth/account-exists-with-different-credential') {
                        msg = 'An account with this email already exists using a different sign-in method.';
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        return; // User cancelled, do nothing.
                    }
                    // Show error on the currently visible panel
                    const visibleMessageDiv = messageDivs.login.offsetParent ? messageDivs.login : messageDivs.username;
                    showMessage(visibleMessageDiv, msg);
                }
            };

            document.getElementById('googleAuthBtn').addEventListener('click', () => handleSocialAuth(new GoogleAuthProvider()));
            document.getElementById('githubAuthBtn').addEventListener('click', () => handleSocialAuth(new GithubAuthProvider()));
            document.getElementById('microsoftAuthBtn').addEventListener('click', () => handleSocialAuth(new OAuthProvider('microsoft.com')));
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - FINALIZING AUTHENTICATION</title>
    <meta name="description" content="Completing your sign-in process with a custom authentication provider.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="../navigation-mini.js"></script>
    <link href="./dist/output.css" rel="stylesheet">
    
    <style>
        :root {
            --geist-foreground: 192, 192, 192;
            --geist-background: 7, 7, 7;
        }

        body {
            font-family: 'Geist', sans-serif;
            background-color: rgb(var(--geist-background));
            color: rgb(var(--geist-foreground));
            transition: all 0.3s ease;
            font-weight: 300;
        }
    </style>
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex items-center justify-center">

    <main class="text-center p-8 max-w-lg">
        <i id="statusIcon" class="fas fa-spinner fa-spin text-5xl text-blue-500 mb-6"></i>
        <h1 id="statusTitle" class="text-3xl font-normal tracking-tighter mb-4">Finalizing Authentication...</h1>
        <p id="statusMessage" class="text-custom-white-gray text-lg font-light">
            We are securely exchanging tokens with Discord and Firebase. Please wait.
        </p>
    </main>

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    // UPDATED: Added 'setDoc' to imports so database writes work
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // --- Import Firebase Config ---
    // NOTE: Ensure your firebase-config.js is in the same directory or adjust the path.
    import { firebaseConfig } from "./firebase-config.js"; 

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const getUserDocRef = (userId) => doc(db, 'users', userId);
    
    // --- DOM Elements ---
    const statusIcon = document.getElementById('statusIcon');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');

    // --- Main Handler ---
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const customToken = params.get('custom_token');
        const error = params.get('error');

        // Function to update the UI for errors
        const displayError = (title, message) => {
            statusIcon.className = 'fas fa-times-circle text-5xl text-red-500 mb-6';
            statusTitle.textContent = title;
            statusMessage.innerHTML = `${message} <br><a href="authentication.html" class="text-blue-400 hover:text-blue-300 font-normal mt-4 inline-block">&larr; Go back to Login</a>`;
        };
        
        // --- 1. Check for Cloud Function Errors ---
        if (error) {
            displayError('Authentication Failed', 'The Discord sign-in process encountered an error. Please try again.');
            return;
        }

        // --- 2. Check for Token ---
        if (!customToken) {
            displayError('Missing Token', 'Did not receive the expected sign-in token. Redirecting error.');
            return;
        }

        // --- 3. Finalize Firebase Sign-In ---
        signInWithCustomToken(auth, customToken)
            .then(async (userCredential) => {
                const user = userCredential.user;
                
                try {
                    // --- KEY FIX: Extract Discord Data from Token Claims ---
                    // This pulls the "claims" object that contains the data sent from your backend
                    const idTokenResult = await user.getIdTokenResult();
                    const claims = idTokenResult.claims || {};
                    
                    // Use claims data first, then fallback to user object, then empty string
                    const finalEmail = claims.email || user.email || "";
                    // Use the Discord username passed in claims
                    const discordUsername = claims.username || user.displayName || `User${user.uid.substring(0, 8)}`;

                    // --- Check for User Document Existence ---
                    const userDoc = await getDoc(getUserDocRef(user.uid));
                    
                    if (!userDoc.exists()) {
                        // Create the document using the data extracted from Discord
                        await setDoc(getUserDocRef(user.uid), {
                            email: finalEmail, 
                            authMethod: 'discord', 
                            createdAt: new Date(),
                            username: discordUsername, 
                            emailVerified: true 
                        });
                        console.log("Created new user doc for:", discordUsername);
                    } else {
                        console.log("User document already exists, skipping creation.");
                    }
                    
                    // --- Success! Redirect ---
                    statusIcon.className = 'fas fa-check-circle text-5xl text-green-500 mb-6';
                    statusTitle.textContent = 'Success!';
                    statusMessage.textContent = 'Sign-in complete. Redirecting to your dashboard...';
                    
                    setTimeout(() => {
                        window.location.href = 'logged-in/dashboard.html';
                    }, 1000);

                } catch (docError) {
                    console.error("Error creating user document:", docError);
                    displayError('Database Error', 'Signed in, but failed to set up user profile.');
                }

            })
            .catch((error) => {
                console.error("Final Firebase Sign-in Failed:", error);
                displayError('Sign-in Error', 'Could not finalize your session. This usually means the custom token was invalid or expired.');
            });
    });
</script>
</body>
</html>

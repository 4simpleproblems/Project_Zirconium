<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - FINALIZING AUTHENTICATION</title>
    <meta name="description" content="Completing your sign-in process.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="../navigation-mini.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Unified Tailwind CSS configuration for a consistent dark theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#040404', 
                        'custom-white-gray': '#c0c0c0', 
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --geist-foreground: 192, 192, 192;
            --geist-background: 7, 7, 7;
        }

        body {
            font-family: 'Geist', sans-serif;
            background-color: rgb(var(--geist-background));
            color: rgb(var(--geist-foreground));
            transition: all 0.3s ease;
            font-weight: 300;
        }
    </style>
    
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex items-center justify-center">

    <main class="text-center p-8 max-w-lg">
        <i id="statusIcon" class="fas fa-spinner fa-spin text-5xl text-blue-500 mb-6"></i>
        <h1 id="statusTitle" class="text-3xl font-normal tracking-tighter mb-4">Finalizing Authentication...</h1>
        <p id="statusMessage" class="text-custom-white-gray text-lg font-light">
            We are securely exchanging tokens with your provider. Please wait.
        </p>
    </main>

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithCustomToken, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, // Re-added for direct DB writing
        serverTimestamp // Re-added for direct DB writing
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // --- Import Firebase Config ---
    import { firebaseConfig } from "./firebase-config.js"; 

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const getUserDocRef = (userId) => doc(db, 'users', userId);
    
    // --- DOM Elements ---
    const statusIcon = document.getElementById('statusIcon');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');

    // --- Removed Helper Functions: checkProfanity and isUsernameTaken are now only in authentication.html ---

    // --- Display Error Helper ---
    const displayError = (title, message) => {
        statusIcon.className = 'fas fa-times-circle text-5xl text-red-500 mb-6';
        statusTitle.textContent = title;
        statusMessage.innerHTML = `${message} <br><a href="authentication.html" class="text-blue-400 hover:text-blue-300 font-normal mt-4 inline-block">&larr; Go back to Login</a>`;
    };

    // --- Unified User Setup Logic ---
    // This function now only determines if the user is new or existing, and redirects accordingly.
    const finalizeUserSetup = async (user, providerId, discordUsername, discordEmail) => {
        try {
            // Check for User Document Existence
            const userDoc = await getDoc(getUserDocRef(user.uid));
            
            if (!userDoc.exists()) {
                // --- NEW USER FLOW: Create User Document in Firestore ---

                const now = serverTimestamp();
                const userEmail = discordEmail || user.email || ''; // Prioritize discordEmail, then user.email
                let username = discordUsername || user.displayName || userEmail.split('@')[0];
                if (username === '') { // Ensure username is not empty
                    username = 'user' + user.uid.substring(0, 8); // Generate a unique placeholder
                }

                const userData = {
                    uid: user.uid,
                    email: userEmail,
                    username: username, // Prioritize Discord username, then display name, then derive from email
                    providerId: providerId,
                    createdAt: now,
                    lastLoginAt: now,
                    // Add any other default fields for new users
                    profilePicture: user.photoURL || '',
                    bio: '',
                    isOnline: true,
                    lastSeen: now,
                };

                await setDoc(getUserDocRef(user.uid), userData);

                statusIcon.className = 'fas fa-check-circle text-5xl text-green-500 mb-6';
                statusTitle.textContent = 'Account Created!';
                statusMessage.textContent = 'Welcome! Redirecting to your dashboard...';

                setTimeout(() => {
                    window.location.href = 'logged-in/dashboard.html';
                }, 1000);

            } else {
                // --- EXISTING USER FLOW: Redirect to Dashboard ---
                console.log("User document already exists, redirecting to dashboard.");
                statusIcon.className = 'fas fa-check-circle text-5xl text-green-500 mb-6';
                statusTitle.textContent = 'Success!';
                statusMessage.textContent = 'Sign-in complete. Redirecting to your dashboard...';
                
                setTimeout(() => {
                    window.location.href = 'logged-in/dashboard.html';
                }, 1000);
            }

        } catch (error) {
            console.error("Error finalizing user setup:", error);
            displayError('Setup Error', 'An error occurred during account finalization. Check console for details.');
        }
    };

    // --- Main Handler ---
    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const customToken = params.get('custom_token');
        const discordUsername = params.get('discord_username');
        const discordEmail = params.get('discord_email');
        const error = params.get('error');

        // --- 1. Check for Cloud Function Errors (Discord) ---
        if (error) {
            displayError('Authentication Failed', 'The sign-in process encountered an error. Please try again.');
            return;
        }

        // --- 2. Handle Custom Token (Discord Flow) ---
        if (customToken) {
            try {
                const userCredential = await signInWithCustomToken(auth, customToken);
                // Provider ID is not strictly needed anymore, but we pass 'discord' for clarity
                await finalizeUserSetup(userCredential.user, 'discord', discordUsername, discordEmail); 
            } catch (error) {
                console.error("Custom Token Sign-in Failed:", error);
                displayError('Sign-in Error', 'Could not finalize your session. The custom token was invalid or expired.');
            }
            return; // Stop here if processing custom token
        }

        // --- 3. Handle Redirect Result (GitHub/Standard Flow) ---
        try {
            const result = await getRedirectResult(auth);
            if (result && result.user) {
                const providerId = result.providerId || 'oauth'; 
                await finalizeUserSetup(result.user, providerId);
            } else {
                // No custom token AND no redirect result found.
                displayError('Missing Authentication', 'No token or login data found. Please try logging in again.');
            }
        } catch (error) {
            console.error("Redirect Sign-in Failed:", error);
            displayError('Login Error', error.message);
        }
    });
</script>
</body>
</html>

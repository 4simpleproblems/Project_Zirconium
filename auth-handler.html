<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - FINALIZING AUTHENTICATION</title>
    <meta name="description" content="Completing your sign-in process.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="../navigation-mini.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Unified Tailwind CSS configuration for a consistent dark theme
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'custom-darkest-gray': '#040404', 
                        'custom-white-gray': '#c0c0c0', 
                    }
                }
            }
        }
    </script>
    
    <style>
        :root {
            --geist-foreground: 192, 192, 192;
            --geist-background: 7, 7, 7;
        }

        body {
            font-family: 'Geist', sans-serif;
            background-color: rgb(var(--geist-background));
            color: rgb(var(--geist-foreground));
            transition: all 0.3s ease;
            font-weight: 300;
        }
    </style>
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex items-center justify-center">

    <main class="text-center p-8 max-w-lg">
        <i id="statusIcon" class="fas fa-spinner fa-spin text-5xl text-blue-500 mb-6"></i>
        <h1 id="statusTitle" class="text-3xl font-normal tracking-tighter mb-4">Finalizing Authentication...</h1>
        <p id="statusMessage" class="text-custom-white-gray text-lg font-light">
            We are securely exchanging tokens with your provider. Please wait.
        </p>
    </main>

<script type="module">
    // --- Firebase Imports ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    // UPDATED: Added getRedirectResult for standard OAuth flows (GitHub etc)
    import { getAuth, signInWithCustomToken, getRedirectResult, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        collection, 
        query, 
        where, 
        getDocs, 
        serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    
    // --- Import Firebase Config ---
    import { firebaseConfig } from "./firebase-config.js"; 

    // --- Firebase Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const getUserDocRef = (userId) => doc(db, 'users', userId);
    
    // --- DOM Elements ---
    const statusIcon = document.getElementById('statusIcon');
    const statusTitle = document.getElementById('statusTitle');
    const statusMessage = document.getElementById('statusMessage');

    // --- Helper Functions (From authentication.html) ---
    const checkProfanity = async (text) => {
        try {
            const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
            const result = await response.text();
            return result.toLowerCase() === 'true';
        } catch (error) { console.error('Profanity API error:', error); return false; }
    };

    const isUsernameTaken = async (username) => {
        const q = query(collection(db, 'users'), where('username', '==', username));
        const querySnapshot = await getDocs(q);
        return !querySnapshot.empty;
    };

    // --- Display Error Helper ---
    const displayError = (title, message) => {
        statusIcon.className = 'fas fa-times-circle text-5xl text-red-500 mb-6';
        statusTitle.textContent = title;
        statusMessage.innerHTML = `${message} <br><a href="authentication.html" class="text-blue-400 hover:text-blue-300 font-normal mt-4 inline-block">&larr; Go back to Login</a>`;
    };

    // --- Unified User Setup Logic ---
    const finalizeUserSetup = async (user, providerId) => {
        try {
            // 1. Get Claims (Crucial for Discord Custom Tokens)
            const idTokenResult = await user.getIdTokenResult();
            const claims = idTokenResult.claims || {};
            
            // 2. Determine Email
            // Priority: Claims (Discord) -> User Object (GitHub/Google) -> Empty
            const finalEmail = claims.email || user.email || "";
            
            // 3. Determine Raw Username Source
            // A. 'username' claim (Discord Custom Token)
            // B. 'screenName' from reloadUserInfo (Crucial for GitHub Handles!)
            // C. 'displayName' (Standard Name)
            // D. Email prefix
            const screenName = user.reloadUserInfo?.screenName; // This captures GitHub handle
            const rawUsername = claims.username || screenName || user.displayName || finalEmail.split('@')[0] || 'User';

            // --- Check for User Document Existence ---
            const userDoc = await getDoc(getUserDocRef(user.uid));
            
            if (!userDoc.exists()) {
                // --- Apply Username Formatting/Uniqueness Logic (Matches authentication.html) ---
                // 1. Sanitize to alphanumeric, max 16 chars
                let username = rawUsername.replace(/[^a-zA-Z0-9]/g, '').slice(0, 16);
                
                // 2. Fallback if too short or profane
                if (username.length < 6) username = `User${user.uid.substring(0, 8)}`;
                if (await checkProfanity(username)) username = `User${user.uid.substring(0, 8)}`;
                
                let finalUsername = username;
                let counter = 1;
                
                // 3. Ensure uniqueness in database
                while (await isUsernameTaken(finalUsername)) {
                    finalUsername = `${username.slice(0, 14)}_${counter++}`;
                }

                // Create the document matching authentication.html schema
                await setDoc(getUserDocRef(user.uid), {
                    email: finalEmail, 
                    authMethod: providerId || 'unknown', 
                    createdAt: serverTimestamp(), 
                    username: finalUsername, 
                    emailVerified: true 
                });
                console.log(`Created new user doc for: ${finalUsername} (${providerId})`);
            } else {
                console.log("User document already exists, skipping creation.");
            }
            
            // --- Success! Redirect ---
            statusIcon.className = 'fas fa-check-circle text-5xl text-green-500 mb-6';
            statusTitle.textContent = 'Success!';
            statusMessage.textContent = 'Sign-in complete. Redirecting to your dashboard...';
            
            setTimeout(() => {
                window.location.href = 'logged-in/dashboard.html';
            }, 1000);

        } catch (docError) {
            console.error("Error setting up user profile:", docError);
            displayError('Database Error', 'Signed in, but failed to set up user profile. Check console for details.');
        }
    };

    // --- Main Handler ---
    document.addEventListener('DOMContentLoaded', async () => {
        const params = new URLSearchParams(window.location.search);
        const customToken = params.get('custom_token');
        const error = params.get('error');

        // --- 1. Check for Cloud Function Errors (Discord) ---
        if (error) {
            displayError('Authentication Failed', 'The sign-in process encountered an error. Please try again.');
            return;
        }

        // --- 2. Handle Custom Token (Discord Flow) ---
        if (customToken) {
            try {
                const userCredential = await signInWithCustomToken(auth, customToken);
                await finalizeUserSetup(userCredential.user, 'discord');
            } catch (error) {
                console.error("Custom Token Sign-in Failed:", error);
                displayError('Sign-in Error', 'Could not finalize your session. The custom token was invalid or expired.');
            }
            return; // Stop here if processing custom token
        }

        // --- 3. Handle Redirect Result (GitHub/Standard Flow) ---
        // If we are here, there is no custom token. Check if we returned from a Firebase Redirect (GitHub).
        try {
            const result = await getRedirectResult(auth);
            if (result && result.user) {
                const providerId = result.providerId || 'oauth'; // e.g. 'github.com'
                await finalizeUserSetup(result.user, providerId);
            } else {
                // No custom token AND no redirect result found.
                displayError('Missing Authentication', 'No token or login data found. Please try logging in again.');
            }
        } catch (error) {
            console.error("Redirect Sign-in Failed:", error);
            displayError('Login Error', error.message);
        }
    });
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SIGN UP</title>
    <meta name="description" content="Sign up for 4simpleproblems (4SP), the essential student toolkit.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS to mimic a modern, dark theme and use the Geist font */
        :root {
            --geist-foreground: 255, 255, 255;
            --geist-background: 0, 0, 0;
        }
        
        .dark {
            color-scheme: dark;
        }

        body {
            /* Applying Geist font */
            font-family: 'Geist', sans-serif;
        }
        
        /* Input Styling */
        input[type="email"], input[type="password"], input[type="text"] {
            background-color: #1a1a1a; /* Darker background */
            border: 1px solid #374151; /* gray-700 */
            color: #ffffff;
        }
        /* Strict Grey Focus */
        input:focus {
            border-color: #4b5563; /* gray-600 */
            outline: none;
            box-shadow: 0 0 0 1px #4b5563; 
        }

        /* Pure Grey Button Style */
        .pure-grey-button {
            background-color: rgba(255, 255, 255, 0.1); /* white/10 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* white/20 */
            transition: all 0.2s ease;
        }
        .pure-grey-button:hover {
            background-color: rgba(255, 255, 255, 0.2); /* white/20 */
        }
        .pure-grey-button:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        /* Wide Frame Styling */
        .signup-frame {
            max-width: 56rem; /* Tailwind 'max-w-4xl' equivalent */
        }
        
        .disclaimer-link {
            color: #d1d5db; /* gray-300 */
            text-decoration: underline;
            transition: color 0.15s;
        }
        .disclaimer-link:hover {
            color: #ffffff; /* white */
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">

    <div id="navbar-container"></div>
    <main class="flex-grow flex items-center justify-center py-12">
        <div class="w-full max-w-4xl p-6 sm:p-8 bg-gray-900/50 backdrop-blur-md rounded-2xl border border-gray-800 shadow-2xl signup-frame">
            
            <h1 class="text-3xl font-semibold text-center mb-1">
                Create Your Account
            </h1>
            <p class="text-center text-gray-400 mb-8">
                Get started with your free student toolkit in seconds.
            </p>

            <div id="status-message" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>

            <div class="lg:grid lg:grid-cols-2 lg:gap-10">

                <!-- Social Sign Up -->
                <div>
                    <h2 class="text-xl font-medium mb-4 text-center lg:text-left text-gray-300">Quick Access</h2>
                    <div class="space-y-3 mb-4">
                        <button id="google-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <!-- Using local image file -->
                            <img src="images/google-icon.png" alt="Google Logo" class="w-5 h-5 mr-3 rounded-full">
                            Sign up with Google
                        </button>
                        <button id="github-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <!-- Using local image file -->
                            <img src="images/github-mark-white.png" alt="GitHub Logo" class="w-5 h-5 mr-3">
                            Sign up with GitHub
                        </button>
                        <button id="microsoft-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <!-- Using local image file -->
                            <img src="images/microsoft.png" alt="Microsoft Logo" class="w-5 h-5 mr-3">
                            Sign up with Microsoft
                        </button>
                    </div>

                    <p class="text-xs text-gray-500 italic text-center mb-6">
                        By logging in or using the platform, you agree to our 
                        <a href="legal.html#terms" class="disclaimer-link">Terms of Service</a> 
                        and 
                        <a href="legal.html#privacy" class="disclaimer-link">Privacy Policy</a>.
                    </p>
                    <div class="flex items-center mb-6 lg:hidden">
                        <div class="flex-grow border-t border-gray-700"></div>
                        <span class="flex-shrink mx-4 text-gray-500 text-sm">or</span>
                        <div class="flex-grow border-t border-gray-700"></div>
                    </div>
                </div>

                <!-- Email/Password Sign Up -->
                <div>
                    <h2 class="text-xl font-medium mb-4 text-center lg:text-left text-gray-300">Email & Password</h2>
                    
                    <form id="email-signup-form" class="space-y-4">
                        <div>
                            <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                            <!-- UPDATED MIN/MAX LENGTH TO 4-24 -->
                            <input type="text" id="username" required autocomplete="username" minlength="4" maxlength="24"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="StudentName">
                            <p id="username-requirements" class="text-xs mt-2 space-y-1 text-gray-400">
                                Username must be 4-24 characters long and cannot contain profanity.
                            </p>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                            <input type="email" id="email" required autocomplete="email"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="you@example.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                            <input type="password" id="password" required autocomplete="new-password"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="••••••••">
                            <p id="password-requirements" class="text-xs mt-2 space-y-1 text-gray-400">
                                Password must be 8-48 characters and contain:
                                <span id="req-number" class="block text-red-500"><i class="fas fa-times mr-1"></i> A number</span>
                                <span id="req-special" class="block text-red-500"><i class="fas fa-times mr-1"></i> A special character (!@#$...)</span>
                                <span id="req-uppercase" class="block text-red-500"><i class="fas fa-times mr-1"></i> An uppercase letter</span>
                            </p>
                        </div>

                        <div class="pt-2">
                            <button type="submit" id="signup-button" disabled
                                    class="pure-grey-button w-full px-4 py-3 text-base font-medium rounded-xl text-white opacity-50 cursor-not-allowed">
                                Sign Up
                            </button>
                        </div>
                    </form>
                </div>
                </div>
            <p class="mt-8 text-center text-sm text-gray-400">
                Already have an account? 
                <a href="login.html" class="font-medium text-gray-300 hover:text-white transition duration-150">
                    Log In here
                </a>
            </p>
        </div>
    </main>

    <footer class="border-t border-gray-900 py-6">
        <div class="mx-auto max-w-7xl px-4 text-center text-gray-500 text-sm">
            &copy; 2024 4simpleproblems (4SP). Built for students.
        </div>
    </footer>
    
    <script src="navigation-mini.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            createUserWithEmailAndPassword, sendEmailVerification, updateProfile, 
            signInWithPopup, GoogleAuthProvider, GithubAuthProvider, OAuthProvider 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP (Canvas Mandated) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        let userId = null;
        let isAuthReady = false;
        let isUsernameCensored = false; // NEW STATE FLAG

        // Initial Authentication and Listener
        onAuthStateChanged(auth, async (user) => {
             if (user) {
                // If a user is already signed in (from a previous session or token), redirect them.
                if (window.location.pathname.endsWith('signup.html')) {
                    if (user.emailVerified || user.providerData.some(p => p.providerId !== 'password')) {
                         window.location.href = '../logged-in/dashboard.html';
                    } else if (user.email && user.providerData.some(p => p.providerId === 'password')) {
                         // Email/password user not verified
                         window.location.href = 'verify.html';
                    }
                }
            } else {
                if (typeof __initial_auth_token !== 'undefined') {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch(e) {
                        console.error("Custom token sign in failed. Signing in anonymously.", e);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            isAuthReady = true;
        });

        /**
         * Checks if a user's Firestore document exists and creates it if not.
         */
        async function checkAndCreateUserDataset(user, provider, username = null) {
            if (!isAuthReady) {
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const uid = user.uid;
            // Canvas Private Data Path: /artifacts/{appId}/users/{userId}/user_data/profile_details
            const userRef = doc(db, `artifacts/${appId}/users/${uid}/user_data/profile_details`);
            
            try {
                const docSnap = await getDoc(userRef);
                
                if (!docSnap.exists()) {
                    const finalUsername = username 
                        || user.displayName 
                        || (user.email ? user.email.split('@')[0] : 'user_' + uid.substring(0, 8));
                        
                    await setDoc(userRef, {
                        username: finalUsername,
                        email: user.email || 'N/A',
                        authenticationMethod: provider,
                        isVerified: user.emailVerified || (provider !== 'Email/Password'),
                        creationDate: serverTimestamp(),
                    }, { merge: true });

                    console.log(`User data created/checked for ${uid} via ${provider}.`);
                }

                // Redirect logic: Social users or verified email users go to dashboard
                if (user.emailVerified || (provider !== 'Email/Password')) {
                     window.location.href = '../logged-in/dashboard.html';
                } else {
                     // For email/password signup, redirect to verification page
                     window.location.href = 'verify.html';
                }

            } catch (error) {
                console.error("Error with user data initialization:", error);
                throw new Error("An error occurred during user data creation/check.");
            }
        }


        // --- UI ELEMENTS ---
        const emailSignupForm = document.getElementById('email-signup-form');
        const usernameInput = document.getElementById('username');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signupButton = document.getElementById('signup-button');
        const statusMessage = document.getElementById('status-message');
        const googleLoginBtn = document.getElementById('google-login');
        const githubLoginBtn = document.getElementById('github-login');
        const microsoftLoginBtn = document.getElementById('microsoft-login');

        const reqNumber = document.getElementById('req-number');
        const reqSpecial = document.getElementById('req-special');
        const reqUppercase = document.getElementById('req-uppercase');
        const checkIcon = '<i class="fas fa-check mr-1"></i>';
        const timesIcon = '<i class="fas fa-times mr-1"></i>';


        // --- UTILITY FUNCTIONS ---
        function showStatus(message, type = 'error') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-900/50', 'text-red-300', 'bg-green-900/50', 'text-green-300', 'bg-gray-900/50', 'text-gray-300');
            if (type === 'success') {
                statusMessage.classList.add('bg-green-900/50', 'text-green-300');
            } else if (type === 'error') {
                statusMessage.classList.add('bg-red-900/50', 'text-red-300');
            } else { // info
                 statusMessage.classList.add('bg-gray-900/50', 'text-gray-300');
            }
        }
        function hideStatus() {
             statusMessage.classList.add('hidden');
        }

        // --- CENSORING API LOGIC ---

        /**
         * Checks a given username string for profanity using Purgomalum API.
         * Uses exponential backoff for retries.
         * @param {string} username - The username to check.
         * @returns {Promise<boolean>} - True if clean (no profanity), False otherwise.
         */
        async function checkProfanity(username, retries = 3) {
            const apiUrl = `https://purgomalum.com/service/containsprofanity?text=${encodeURIComponent(username)}`;
            
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl);
                    if (!response.ok) {
                        // If API fails, default to allowing to prevent blocking signups, but log warning.
                        console.warn(`Purgomalum API failed (Attempt ${i+1}/${retries}). Status: ${response.status}. Allowing username for now.`);
                        return true; 
                    }
                    const result = await response.text();
                    // API returns 'true' or 'false' as a string
                    return result.toLowerCase().trim() === 'false';
                } catch (error) {
                    // Exponential backoff
                    console.error(`Fetch error during profanity check (Attempt ${i+1}/${retries}):`, error);
                    if (i < retries - 1) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            // If all retries fail, default to safe assumption to allow registration 
            return true; 
        }

        /**
         * Handles username length check and profanity check (async).
         */
        async function validateUsername() {
            const username = usernameInput.value.trim();
            hideStatus();

            // 1. Length Check (4-24)
            const minLength = 4;
            const maxLength = 24;
            const lengthValid = username.length >= minLength && username.length <= maxLength;
            
            if (!lengthValid) {
                showStatus(`Username must be between ${minLength} and ${maxLength} characters.`, 'error');
                isUsernameCensored = false;
                return;
            }
            
            // 2. Profanity Check (Async)
            showStatus("Checking username for profanity...", 'info'); 
            
            const isClean = await checkProfanity(username);
            
            if (!isClean) {
                showStatus("Username contains inappropriate language. Please choose a different one.", 'error');
                isUsernameCensored = false;
            } else {
                // If profanity check passed, clear the info status and mark as censored=true (meaning clean)
                hideStatus();
                isUsernameCensored = true;
            }
            updateSignupButtonState();
        }

        // Attach validation events
        usernameInput.addEventListener('blur', validateUsername);
        usernameInput.addEventListener('input', () => {
             // Basic input check to clear status, and allow re-check on blur/submit
            const lengthValid = usernameInput.value.trim().length >= 4 && usernameInput.value.trim().length <= 24;
            if (lengthValid) hideStatus(); 
        });

        // --- PASSWORD VALIDATION LOGIC ---
        function validatePassword(password) {
            // Min 8, Max 48
            const lengthValid = password.length >= 8 && password.length <= 48;
            // Has a number (0-9)
            const numberValid = /\d/.test(password); 
            // Has a special character (e.g., !@#$%^&*)
            const specialValid = /[!@#$%^&*()_+={}[\]:;"'<,>.?/|\\~`]/.test(password);
            // Has an uppercase letter (A-Z)
            const uppercaseValid = /[A-Z]/.test(password); 

            // Update UI for requirements
            function updateRequirementUI(element, isValid) {
                element.innerHTML = (isValid ? checkIcon : timesIcon) + element.textContent.substring(element.textContent.indexOf(' '));
                element.classList.toggle('text-green-500', isValid);
                element.classList.toggle('text-red-500', !isValid);
            }

            updateRequirementUI(reqNumber, numberValid);
            updateRequirementUI(reqSpecial, specialValid);
            updateRequirementUI(reqUppercase, uppercaseValid);
            
            return lengthValid && numberValid && specialValid && uppercaseValid;
        }
        
        // Function to update the signup button state based on ALL valid inputs
        function updateSignupButtonState() {
            const isPasswordValid = validatePassword(passwordInput.value);
            const isUsernameEntered = usernameInput.value.trim().length >= 4; 
            
            // isUsernameCensored is true if the profanity check passed and the length is fine
            const isReady = isPasswordValid && isUsernameEntered && isUsernameCensored; 

            signupButton.disabled = !isReady;
            signupButton.classList.toggle('opacity-100', isReady);
            signupButton.classList.toggle('cursor-not-allowed', !isReady);
            signupButton.classList.toggle('pure-grey-button', isReady);
        }
        
        // Listeners for enabling the button
        passwordInput.addEventListener('input', updateSignupButtonState);
        // The username check runs asynchronously on blur, and calls updateSignupButtonState() upon completion

        // --- EMAIL/PASSWORD SIGN UP ---
        if (emailSignupForm) {
            emailSignupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideStatus();

                const username = usernameInput.value.trim();
                const email = emailInput.value.trim();
                const password = passwordInput.value;
                
                // Perform final validation checks
                await validateUsername(); // Ensure profanity check is complete
                const isPasswordValid = validatePassword(password);
                
                if (!isPasswordValid || !isUsernameCensored) {
                    if (!isPasswordValid) showStatus("Please ensure your password meets all requirements.", 'error');
                    if (!isUsernameCensored) showStatus("Please choose a valid username that is not profane and is 4-24 characters long.", 'error');
                    return;
                }
                
                signupButton.textContent = 'Signing Up...';
                signupButton.disabled = true;

                try {
                    // 1. Create the user
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // 2. Update the user's profile with the chosen username
                    await updateProfile(user, { displayName: username });

                    // 3. Send verification email
                    await sendEmailVerification(user);
                    
                    // 4. Create Firestore dataset (this function handles the redirect to verify.html)
                    await checkAndCreateUserDataset(user, 'Email/Password', username);

                } catch (error) {
                    let errorMessage = "Sign up failed.";
                    if (error.code === 'auth/email-already-in-use') {
                        errorMessage = "This email is already associated with an account.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "The email address is not valid.";
                    }
                    showStatus(errorMessage);
                    signupButton.textContent = 'Sign Up';
                    signupButton.disabled = false;
                    updateSignupButtonState(); // Re-check button state
                }
            });
        }
        
        // --- SOCIAL LOGINS ---
        async function handleSocialLogin(providerInstance, providerName) {
            hideStatus();
            try {
                const result = await signInWithPopup(auth, providerInstance);
                // The checkAndCreateUserDataset handles the user data creation and dashboard redirect
                await checkAndCreateUserDataset(result.user, providerName);
            } catch (error) {
                let errorMessage = `Sign up with ${providerName} failed.`;
                if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `You already have an account with this email. Please log in or use the original method.`;
                } else if (error.code === 'auth/popup-closed-by-user') {
                     errorMessage = `Sign up window closed. Please try again.`;
                }
                showStatus(errorMessage);
            }
        }

        if(googleLoginBtn) googleLoginBtn.addEventListener('click', () => handleSocialLogin(new GoogleAuthProvider(), 'Google'));
        if(microsoftLoginBtn) microsoftLoginBtn.addEventListener('click', () => handleSocialLogin(new OAuthProvider('microsoft.com'), 'Microsoft'));
        if(githubLoginBtn) githubLoginBtn.addEventListener('click', () => handleSocialLogin(new GithubAuthProvider(), 'GitHub'));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SIGN UP</title>
    <meta name="description" content="Sign up for 4simpleproblems (4SP), the essential student toolkit.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS to mimic a modern, dark theme and use the Geist font */
        :root {
            --geist-foreground: 255, 255, 255;
            --geist-background: 0, 0, 0;
        }
        
        .dark {
            color-scheme: dark;
        }

        body {
            /* Applying Geist font */
            font-family: 'Geist', sans-serif;
        }
        
        /* Input Styling */
        input[type="email"], input[type="password"], input[type="text"] {
            background-color: rgb(24 24 27 / var(--tw-bg-opacity)); /* zinc-900 equivalent */
            border-color: rgb(39 39 42 / var(--tw-border-opacity)); /* zinc-800 equivalent */
        }
        
        /* Button Focus Ring */
        .signup-btn:focus-visible {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #000000, 0 0 0 4px #0070f3; /* Black + Vercel Blue */
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div id="navbar-container"></div>

    <main class="flex items-center justify-center min-h-[calc(100vh-64px)] py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-md space-y-8 rounded-xl p-8 bg-gray-900/50 backdrop-blur-md border border-gray-800 shadow-2xl">
            <div class="text-center">
                <h2 class="mt-6 text-3xl font-bold tracking-tight text-white">
                    Create a new account
                </h2>
                <p class="mt-2 text-sm text-gray-400">
                    Already have an account? <a href="login.html" class="font-medium text-blue-400 hover:text-blue-300 transition">Log in</a>
                </p>
            </div>

            <div id="status-message" class="hidden p-3 text-sm rounded-lg text-red-400 bg-red-900/30 border border-red-800/50"></div>

            <form class="mt-8 space-y-6" id="signup-form">
                <div class="-space-y-px rounded-md shadow-sm">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required 
                               class="relative block w-full appearance-none rounded-none rounded-t-lg border border-gray-700 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="new-password" required minlength="6"
                               class="relative block w-full appearance-none rounded-none border border-gray-700 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="Password (min 6 characters)">
                    </div>
                    <div>
                        <label for="confirm-password" class="sr-only">Confirm Password</label>
                        <input id="confirm-password" name="confirm-password" type="password" autocomplete="new-password" required minlength="6"
                               class="relative block w-full appearance-none rounded-none rounded-b-lg border border-gray-700 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="Confirm Password">
                    </div>
                </div>

                <div>
                    <button type="submit" id="signup-button"
                            class="signup-btn group relative flex w-full justify-center rounded-lg border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition"
                            disabled>
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-user-plus h-5 w-5 text-blue-300 group-hover:text-blue-200 transition"></i>
                        </span>
                        Sign up
                    </button>
                </div>
            </form>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-gray-900/50 backdrop-blur-sm px-2 text-gray-500">
                        Or sign up with
                    </span>
                </div>
            </div>

            <div class="flex space-x-3">
                <button id="google-login-btn" type="button" class="signup-btn w-full inline-flex justify-center rounded-lg border border-gray-700 bg-gray-800 py-3 text-sm font-medium text-white hover:bg-gray-700 transition">
                    <i class="fab fa-google h-5 w-5 mr-2"></i> Google
                </button>
                <button id="github-login-btn" type="button" class="signup-btn w-full inline-flex justify-center rounded-lg border border-gray-700 bg-gray-800 py-3 text-sm font-medium text-white hover:bg-gray-700 transition">
                    <i class="fab fa-github h-5 w-5 mr-2"></i> GitHub
                </button>
                <button id="microsoft-login-btn" type="button" class="signup-btn w-full inline-flex justify-center rounded-lg border border-gray-700 bg-gray-800 py-3 text-sm font-medium text-white hover:bg-gray-700 transition">
                    <i class="fab fa-microsoft h-5 w-5 mr-2"></i> Microsoft
                </button>
            </div>
        </div>
    </main>

    <script src="../navigation-mini.js"></script>

    <script type="module">
        // -------------------------------------------------------------
        // NEW: Get the global navigation function into the module's scope
        const initMiniNavigation = window.initMiniNavigation;
        // -------------------------------------------------------------
        
        // 1. IMPORT: Import your local configuration (Loads firebase-config.js)
        import { firebaseConfig } from '../firebase-config.js';

        // 2. IMPORT: Updated Firebase module imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, createUserWithEmailAndPassword, updateProfile, 
            signInWithPopup, GoogleAuthProvider, GithubAuthProvider, OAuthProvider,
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL SETUP ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 
        setLogLevel('debug'); // Keep for debugging if needed
        
        // -------------------------------------------------------------
        // NEW: Call the navigation initialization function, passing the auth object
        if (initMiniNavigation) {
            initMiniNavigation(auth);
        }
        // -------------------------------------------------------------
        
        // --- DOM Elements ---
        const signupForm = document.getElementById('signup-form');
        const signupButton = document.getElementById('signup-button');
        const emailInput = document.getElementById('email-address');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const githubLoginBtn = document.getElementById('github-login-btn');
        const microsoftLoginBtn = document.getElementById('microsoft-login-btn');
        const statusMessage = document.getElementById('status-message');


        // --- Utility Functions ---
        function showStatus(message, isError = true) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            // Ensure status colors are correct
            if (isError) {
                statusMessage.classList.add('text-red-400', 'bg-red-900/30', 'border-red-800/50');
                statusMessage.classList.remove('text-green-400', 'bg-green-900/30', 'border-green-800/50');
            } else {
                statusMessage.classList.add('text-green-400', 'bg-green-900/30', 'border-green-800/50');
                statusMessage.classList.remove('text-red-400', 'bg-red-900/30', 'border-red-800/50');
            }
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        function checkSignupButtonState() {
            const passwordsMatch = passwordInput.value === confirmPasswordInput.value;
            const isEmailValid = emailInput.checkValidity();
            const isPasswordLongEnough = passwordInput.value.length >= 6;
            
            if (isEmailValid && isPasswordLongEnough && passwordsMatch) {
                signupButton.disabled = false;
                signupButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            } else {
                signupButton.disabled = true;
                signupButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            }
        }
        
        // Creates the basic user data entry in Firestore
        async function checkAndCreateUserDataset(user, loginMethod = 'email') {
            const userDocRef = doc(db, "users", user.uid);
            
            // Check if the document already exists (for social sign-in where user might be returning)
            const userDoc = await getDoc(userDocRef);

            if (userDoc.exists()) {
                console.log("Existing user logged in. Redirecting.");
            } else {
                // New user - create the initial data
                const userData = {
                    email: user.email,
                    displayName: user.displayName || user.email.split('@')[0],
                    provider: loginMethod,
                    createdAt: serverTimestamp(),
                    lastLogin: serverTimestamp(),
                    settings: {
                        theme: 'dark',
                        panicKey: 'Shift + Esc'
                    },
                    // Initialize empty or default structures
                    notes: '', 
                    playlists: [],
                };

                await setDoc(userDocRef, userData);
                console.log("New user dataset created.");
            }
            
            // Redirect to the dashboard upon successful sign-up and data creation
            window.location.href = '../logged-in/dashboard.html';
        }

        // --- EVENT HANDLERS ---
        
        // Handle Email/Password Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideStatus();

            const email = emailInput.value;
            const password = passwordInput.value;
            
            if (password !== confirmPasswordInput.value) {
                showStatus("Passwords do not match.");
                return;
            }

            signupButton.disabled = true;
            try {
                // 1. Create User in Firebase Auth
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                // 2. Set Display Name (simple version)
                const defaultDisplayName = email.split('@')[0];
                await updateProfile(user, { displayName: defaultDisplayName });

                // 3. Create Firestore Data and Redirect
                await checkAndCreateUserDataset(user);
                
            } catch (error) {
                let errorMessage = "Sign up failed.";
                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = "This email address is already in use. Please log in instead.";
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = "The email address is not valid.";
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = "Password is too weak. Please use at least 6 characters.";
                }
                
                showStatus(errorMessage);
                console.error("Sign Up Error:", error);
            } finally {
                checkSignupButtonState(); // Re-check button state
            }
        });

        // --- SOCIAL LOGINS ---\
        async function handleSocialLogin(providerInstance, providerName) {
            hideStatus();
            try {
                const result = await signInWithPopup(auth, providerInstance);
                // The checkAndCreateUserDataset handles the user data creation and dashboard redirect
                await checkAndCreateUserDataset(result.user, providerName);
            } catch (error) {
                let errorMessage = `Sign up with ${providerName} failed.`;
                if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `You already have an account with this email. Please log in or use the original method.`;
                } else if (error.code === 'auth/popup-closed-by-user') {
                     errorMessage = `Sign up window closed. Please try again.`;
                }
                showStatus(errorMessage);
            }
        }

        // --- EVENT LISTENERS ---
        signupForm.addEventListener('input', checkSignupButtonState);
        document.addEventListener('DOMContentLoaded', checkSignupButtonState); // Initial check
        
        if(googleLoginBtn) googleLoginBtn.addEventListener('click', () => handleSocialLogin(new GoogleAuthProvider(), 'Google'));
        if(microsoftLoginBtn) microsoftLoginBtn.addEventListener('click', () => handleSocialLogin(new OAuthProvider('microsoft.com'), 'Microsoft'));
        if(githubLoginBtn) githubLoginBtn.addEventListener('click', () => handleSocialLogin(new GithubAuthProvider(), 'GitHub'));
    </script>
</body>
</html>

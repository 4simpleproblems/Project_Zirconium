<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - SIGN UP</title>
    <meta name="description" content="Create your 4SP account to access the student toolkit.">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.1.0/css/all.min.css">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="navigation-mini.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // NEW DARKER PALETTE (Keep consistent with login.html)
                        'custom-darkest-gray': '#070707', // Very Dark Background (Body/Right Half) - Darker
                        'custom-dark-gray': '#1c1c1c',    // Dark Background (Left Half) - Darker
                        'custom-medium-gray': '#252525', // Darker border, input background, and button base
                        'custom-light-gray': '#505050',  // Darker Text, labels, and borders
                        'custom-lighter-gray': '#808080', // Darker Hover states, subtle text, and messages
                        'custom-white-gray': '#c0c0c0',  // Darker Main text, headings
                    }
                }
            }
        }
    </script>

    <script src="panic-key.js"></script>
    <script src="url-changer.js"></script>

    <style>
        /* Updated RGB values for the darker custom colors (Keep consistent with login.html) */
        :root {
            --geist-foreground: 192, 192, 192; /* custom-white-gray */
            --geist-background: 7, 7, 7;    /* custom-darkest-gray: #0f0f0f */
        }

        body {
            font-family: 'Geist', sans-serif;
            background-color: var(--geist-background);
            color: var(--geist-foreground);
        }

        .btn-google {
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .btn-google:hover {
            background-color: rgba(37, 37, 37, 0.7); /* custom-medium-gray with transparency */
            border-color: #383838; /* A slightly darker hover border */
        }
        
        /* Message colors using the new darker custom grays (Keep consistent with login.html) */
        .error-message { color: var(--custom-lighter-gray); font-weight: bold; }
        .success-message { color: var(--custom-light-gray); }
        .warning-message { color: var(--custom-light-gray); }

        /* FOOTER CHANGE: Make background black and remove blur/transparency (Keep consistent with login.html) */
        .fixed-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40px; 
            background-color: black; /* Changed to Black */
            /* Removed backdrop-filter and -webkit-backdrop-filter for pure black */
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            border-top: 1px solid black; /* Changed to Black border for seamless look */
        }
        
        main {
            padding-bottom: 60px;
        }

        /* Added for the two-step process to ensure consistent layout */
        .auth-form-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
        }
    </style>
</head>
<body class="bg-custom-darkest-gray text-custom-white-gray min-h-screen flex flex-col">

    <div id="navbar-container"></div>

    <main class="flex-grow flex items-stretch justify-center p-0">
        <div class="
            auth-split-container
            bg-custom-darkest-gray rounded-none shadow-none
            flex flex-wrap w-full
            border-0 overflow-hidden
            p-0
        ">
            <div class="
                auth-col left-col
                flex-1 p-8 flex flex-col justify-center items-center
                bg-custom-dark-gray border-r border-custom-medium-gray min-w-[300px]
                sm:rounded-none sm:border-r 
            ">

                <div id="usernameContainer" class="auth-form-container">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Choose Your Username</h2>
                    <form id="usernameForm" novalidate class="w-full max-w-md"> 
                        <div class="mb-5">
                            <label for="signupUsername" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Username</label>
                            <input type="text" id="signupUsername" placeholder="4-24 characters, including symbols" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                            <p class="text-xs text-custom-lighter-gray mt-2 text-left">Allowed symbols: .,-+\_!?$</p>
                        </div>
                        <button type="submit" id="nextStepBtn" class="w-full p-3 bg-custom-medium-gray text-custom-white-gray rounded-lg font-semibold text-lg cursor-pointer transition hover:bg-custom-light-gray hover:shadow-lg hover:shadow-custom-medium-gray/30">NEXT</button>
                    </form>
                    <div id="usernameMessage" class="message-area w-full max-w-md mt-4 min-h-[20px] text-center text-sm"></div>
                    <p class="text-sm text-custom-light-gray mt-6 text-center w-full max-w-md">Already have an account? <a href="login.html" class="text-custom-light-gray font-semibold hover:text-custom-lighter-gray transition">Login here</a></p>
                </div>

                <div id="signupContainer" class="auth-form-container" style="display: none;">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Set Your Credentials</h2>
                    <form id="signupForm" novalidate class="w-full max-w-md"> 
                        <div class="mb-5">
                            <label for="signupEmail" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Email</label>
                            <input type="email" id="signupEmail" placeholder="Enter your email" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                        </div>
                        <div class="mb-5">
                            <label for="signupPassword" class="block mb-2 text-custom-light-gray text-sm font-medium text-left">Password</label>
                            <input type="password" id="signupPassword" placeholder="Enter your password" required class="w-full p-3 border border-custom-medium-gray bg-custom-dark-gray rounded-lg text-custom-white-gray transition focus:border-custom-light-gray focus:ring focus:ring-custom-light-gray/50 focus:outline-none">
                            <p class="text-xs text-custom-lighter-gray mt-2 text-left">8-48 chars, must include 1 uppercase, 1 number, and 1 special symbol.</p>
                        </div>
                        <button type="submit" class="w-full p-3 bg-custom-medium-gray text-custom-white-gray rounded-lg font-semibold text-lg cursor-pointer transition hover:bg-custom-light-gray hover:shadow-lg hover:shadow-custom-medium-gray/30">CREATE ACCOUNT</button>
                    </form>
                    <div class="w-full max-w-md mt-6 text-center"> <a id="backToUsernameLink" class="text-custom-light-gray hover:text-custom-lighter-gray font-medium text-sm cursor-pointer">&larr; Back to Username</a> </div>
                    <div id="signupMessage" class="message-area w-full max-w-md mt-4 min-h-[20px] text-center text-sm"></div>
                </div>

            </div>

            <div class="
                auth-col right-col
                flex-1 p-8 flex flex-col justify-center items-center
                bg-custom-darkest-gray
                sm:rounded-none
            ">
                <div class="right-panel-content w-full flex flex-col items-center justify-center">
                    <h2 class="text-3xl font-bold text-custom-white-gray mb-6 text-center w-full tracking-tighter">Sign up instantly</h2>
                    <p class="text-lg text-custom-light-gray mb-8 text-center max-w-md">
                        Use a trusted provider like Google or GitHub to sign up instantly. It's the fastest way to access your account.
                    </p>
                    
                    <button id="googleLoginBtn" class="btn-google flex items-center justify-center w-full max-w-md p-3 bg-custom-dark-gray text-custom-white-gray border border-custom-medium-gray rounded-lg font-medium cursor-pointer transition hover:bg-custom-medium-gray/50 mb-3">
                        <img src="images/google-icon.png" alt="Google Icon" class="w-5 h-5 mr-3"> Sign up with Google
                    </button>
                    <button id="githubLoginBtn" class="btn-google flex items-center justify-center w-full max-w-md p-3 bg-custom-dark-gray text-custom-white-gray border border-custom-medium-gray rounded-lg font-medium cursor-pointer transition hover:bg-custom-medium-gray/50 mb-3">
                        <img src="images/github-mark.png" alt="GitHub Icon" class="w-5 h-5 mr-3 filter invert"> Sign up with GitHub
                    </button>
                    <button id="microsoftLoginBtn" class="btn-google flex items-center justify-center w-full max-w-md p-3 bg-custom-dark-gray text-custom-white-gray border border-custom-medium-gray rounded-lg font-medium cursor-pointer transition hover:bg-custom-medium-gray/50 mb-3">
                        <img src="images/microsoft.png" alt="Microsoft Icon" class="w-5 h-5 mr-3"> Sign up with Microsoft
                    </button>
                    
                    <p class="oauth-agreement-text text-xs italic text-custom-light-gray text-center max-w-md mt-4 leading-relaxed">
                            By signing up with third-party providers or via email, you agree to our <a href="legal.html" target="_blank" class="text-custom-light-gray hover:text-custom-lighter-gray">Terms of Service</a>, and our <a href="legal.html" target="_blank" class="text-custom-light-gray hover:text-custom-lighter-gray">Privacy Policy</a>.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <footer class="fixed-footer">
        <div class="text-center text-custom-light-gray text-xs">
            &copy; 2024 4simpleproblems (4SP). Built for students.
        </div>
    </footer>

    <script type="module">
        // Import your local configuration
        import { firebaseConfig } from '../firebase-config.js';

        // Import the new Firebase Modular SDK functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import {
            getAuth,
            createUserWithEmailAndPassword,
            sendEmailVerification,
            signOut,
            GoogleAuthProvider,
            GithubAuthProvider,
            OAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            collection,
            query,
            where,
            getDocs,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Access the global navigation function you created
        const initMiniNavigation = window.initMiniNavigation;
        if (initMiniNavigation) {
            initMiniNavigation(auth);
        }

        // Global variable to store the selected username
        let selectedUsername = null;

        // --- Signup Page-Specific Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const usernameContainer = document.getElementById('usernameContainer');
            const signupContainer = document.getElementById('signupContainer');
            const usernameMessageDiv = document.getElementById('usernameMessage');
            const signupMessageDiv = document.getElementById('signupMessage');
            const googleLoginBtn = document.getElementById('googleLoginBtn');
            const githubLoginBtn = document.getElementById('githubLoginBtn');
            const microsoftLoginBtn = document.getElementById('microsoftLoginBtn');

            // Initial display setup
            usernameContainer.style.display = 'flex';
            usernameContainer.style.flexDirection = 'column';
            signupContainer.style.display = 'none';

            // Utility function to display messages
            const showMessage = (element, text, type = 'error') => {
                element.innerHTML = text;
                element.className = `message-area w-full max-w-md mt-4 min-h-[20px] text-center text-sm ${type}-message`;
            };

            // Utility function to check for profanity
            const checkProfanity = async (text) => {
                if (!text || !text.trim()) return false;
                try {
                    const response = await fetch(`https://www.purgomalum.com/service/containsprofanity?text=${encodeURIComponent(text)}`);
                    if (!response.ok) throw new Error('API request failed');
                    const result = await response.text();
                    return result.toLowerCase() === 'true';
                } catch (error) { console.error('Error calling profanity API:', error); return false; }
            };
            
            // Utility function to check if username is taken
            const isUsernameTaken = async (username) => {
                try {
                    const q = query(collection(db, 'users'), where('username', '==', username));
                    const querySnapshot = await getDocs(q);
                    return !querySnapshot.empty;
                } catch (error) { console.error("Error checking username uniqueness:", error); return true; }
            };

            // Utility function for password validation
            const validatePassword = (password) => {
                // 8-48 chars, at least 1 uppercase, 1 number, 1 special symbol
                const minLength = 8;
                const maxLength = 48;
                const uppercaseRegex = /[A-Z]/;
                const numberRegex = /[0-9]/;
                // Special symbols: !@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?
                const specialCharRegex = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/; 

                if (password.length < minLength || password.length > maxLength) {
                    return `Password must be between ${minLength} and ${maxLength} characters.`;
                }
                if (!uppercaseRegex.test(password)) {
                    return 'Password must contain at least one uppercase letter.';
                }
                if (!numberRegex.test(password)) {
                    return 'Password must contain at least one number.';
                }
                if (!specialCharRegex.test(password)) {
                    return 'Password must contain at least one special symbol.';
                }
                return null; // Valid
            };

            // Utility function to create a user document
            const createUserDocument = async (user, authMethod, username, explicitEmail = null) => {
                const emailToStore = explicitEmail || (user && user.email) || null;
                const isVerified = (authMethod === 'google' || authMethod === 'github' || authMethod === 'microsoft') ? true : !!(user && user.emailVerified);
                try {
                    await setDoc(doc(db, 'users', user.uid), {
                        email: emailToStore, 
                        authMethod: authMethod, 
                        createdAt: serverTimestamp(),
                        username: username, 
                        emailVerified: isVerified
                    });
                    return true;
                } catch (error) { console.error("Error creating user document:", error); return false; }
            };
            
            // Handler for successful (but unverified) account creation
            const handleSuccessfulSignup = async (user, username) => {
                await signOut(auth); // Immediately sign out the user
                
                let countdown = 8;
                const message = () => {
                    showMessage(signupMessageDiv, 
                        `Success! A verification email has been sent to **${user.email}**.<br>Your username is **${username}**.<br>Redirecting to login in ${countdown}...`, 
                        'success'
                    );
                    countdown--;
                };
                
                message(); 
                const interval = setInterval(() => {
                    if (countdown < 0) {
                        clearInterval(interval);
                        window.location.href = 'login.html';
                    } else {
                        message();
                    }
                }, 1000);
            };

            // Handler for provider login (used for sign up with Google/GitHub/Microsoft)
            const handleProviderSignup = async (provider) => {
                usernameMessageDiv.innerHTML = ''; 
                try {
                    const result = await signInWithPopup(auth, provider);
                    const user = result.user;
                    
                    const userDocSnap = await getDoc(doc(db, 'users', user.uid));

                    if (userDocSnap.exists()) {
                        // User already exists, redirect to dashboard
                        window.location.href = 'logged-in/dashboard.html';
                        return;
                    } 
                    
                    // New user: create a provisional username for the new account
                    let userEmail = user.email;
                    let proposedUsername = user.displayName || userEmail.split('@')[0] || 'User';
                    proposedUsername = proposedUsername.replace(/[^a-zA-Z0-9]/g, '').slice(0, 16); 

                    if (proposedUsername.length < 4) { proposedUsername = `User${user.uid.substring(0, 8)}`; } 
                    if (await checkProfanity(proposedUsername)) { proposedUsername = `User${user.uid.substring(0, 8)}`; }

                    let finalUsername = proposedUsername;
                    let counter = 1;
                    while (await isUsernameTaken(finalUsername)) {
                        const suffix = `_${counter}`;
                        const maxBaseLength = 16 - suffix.length;
                        const baseUsername = proposedUsername.substring(0, maxBaseLength);
                        finalUsername = `${baseUsername}${suffix}`;
                        counter++;
                    }

                    const providerName = provider.providerId.split('.')[0];
                    const documentCreated = await createUserDocument(user, providerName, finalUsername, userEmail);
                    
                    if (documentCreated) {
                         // Sign out the new user and redirect to dashboard with a success/info message
                        await signOut(auth); 
                        let countdown = 8;
                        const message = () => {
                            showMessage(usernameMessageDiv, 
                                `Success! You're signed up with ${providerName.charAt(0).toUpperCase() + providerName.slice(1)}.<br>Your new username is **${finalUsername}**.<br>Redirecting to dashboard in ${countdown}...`, 
                                'success'
                            );
                            countdown--;
                        };
                        
                        message(); 
                        const interval = setInterval(() => {
                            if (countdown < 0) {
                                clearInterval(interval);
                                window.location.href = 'logged-in/dashboard.html';
                            } else {
                                message();
                            }
                        }, 1000);
                    } else {
                        throw new Error('Failed to create user document.');
                    }

                } catch (error) {
                    console.error('Provider Sign-In error:', error);
                    let message = `A problem occurred during sign up. Please try again.`;
                    
                    // Logic for provider signup redirect on existing account
                    if (error.code === 'auth/account-exists-with-different-credential' || error.code === 'auth/credential-already-in-use') {
                        let countdown = 5;
                        const redirectMessage = () => {
                            showMessage(usernameMessageDiv, 
                                `An account with this email already exists! You must use the **Login** page.<br>Redirecting to login in ${countdown}...`, 
                                'error'
                            );
                            countdown--;
                        };
                        
                        redirectMessage(); 
                        const interval = setInterval(() => {
                            if (countdown < 0) {
                                clearInterval(interval);
                                window.location.href = 'login.html'; // Redirect to login
                            } else {
                                redirectMessage();
                            }
                        }, 1000);
                        return; 
                    } else if (error.code === 'auth/popup-closed-by-user') { 
                        return; 
                    }

                    showMessage(usernameMessageDiv, message);
                }
            };

            // Event listener for Step 1 (Username Form)
            document.getElementById('usernameForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                usernameMessageDiv.innerHTML = '';
                const usernameInput = document.getElementById('signupUsername').value.trim();

                // 1. Check length (4-24 chars)
                if (usernameInput.length < 4 || usernameInput.length > 24) {
                    showMessage(usernameMessageDiv, 'Username must be between 4 and 24 characters.');
                    return;
                }

                // 2. Check allowed characters: alphanumeric + .,-+_!?$
                const allowedCharsRegex = /^[a-zA-Z0-9.,\-+_\!\?\$\\]+$/;
                if (!allowedCharsRegex.test(usernameInput)) {
                    showMessage(usernameMessageDiv, 'Username contains unallowed characters. Only letters, numbers, and .,-+_!?$ are permitted.');
                    return;
                }

                // 3. Check for profanity using Purgomalum API
                showMessage(usernameMessageDiv, 'Checking username availability and safety...', 'warning');
                const isProfane = await checkProfanity(usernameInput);
                if (isProfane) {
                    showMessage(usernameMessageDiv, 'Please choose a different username. That one is not allowed.');
                    return;
                }

                // 4. Check if username is already taken (Firestore check)
                const isTaken = await isUsernameTaken(usernameInput);
                if (isTaken) {
                    showMessage(usernameMessageDiv, 'This username is already taken. Please choose another.');
                    return;
                }

                // If all checks pass, move to Step 2
                selectedUsername = usernameInput;
                usernameContainer.style.display = 'none';
                signupContainer.style.display = 'flex';
                signupContainer.style.flexDirection = 'column';
                usernameMessageDiv.innerHTML = ''; // Clear message for step 1
                signupMessageDiv.innerHTML = ''; // Clear message for step 2
                document.getElementById('signupEmail').focus();
            });
            
            // Event listener for Step 2 (Email/Password Form)
            document.getElementById('signupForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                signupMessageDiv.innerHTML = '';

                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;

                // 1. Validate Password
                const passwordError = validatePassword(password);
                if (passwordError) {
                    showMessage(signupMessageDiv, passwordError);
                    return;
                }

                try {
                    // 2. Create user with Email and Password
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;

                    // 3. Send Email Verification
                    await sendEmailVerification(user);

                    // 4. Create User Document in Firestore
                    const documentCreated = await createUserDocument(user, 'email', selectedUsername, email);
                    
                    if (documentCreated) {
                        // 5. Success! Show message and redirect to login
                        await handleSuccessfulSignup(user, selectedUsername);
                    } else {
                        // Crucial fallback: If Firestore fails, delete the Firebase Auth user
                        await user.delete(); 
                        showMessage(signupMessageDiv, 'An internal error occurred (failed to create user record). Please try again or contact support.');
                    }
                } catch (error) {
                    console.error("Signup Error:", error);
                    let message = 'An unknown sign up error occurred. Please try again.';
                    
                    // Logic for email/password signup redirect on existing account
                    if (error.code === 'auth/email-already-in-use') {
                        let countdown = 5;
                        const redirectMessage = () => {
                            showMessage(signupMessageDiv, 
                                `This email is already in use by another account! You must use the **Login** page.<br>Redirecting in ${countdown}...`, 
                                'error'
                            );
                            countdown--;
                        };
                        
                        redirectMessage(); 
                        const interval = setInterval(() => {
                            if (countdown < 0) {
                                clearInterval(interval);
                                window.location.href = 'login.html'; // Redirect to login
                            } else {
                                redirectMessage();
                            }
                        }, 1000);
                        return; 
                    } 

                    // Existing error message switch (only for non-redirect errors)
                    switch (error.code) {
                        case 'auth/invalid-email':
                            message = 'The email address is not valid.'; break;
                        case 'auth/weak-password':
                            message = 'Password is too weak. Please choose a stronger one.'; break;
                    }
                    showMessage(signupMessageDiv, message);
                }
            });

            // Back button listener
            document.getElementById('backToUsernameLink').addEventListener('click', () => {
                signupContainer.style.display = 'none';
                usernameContainer.style.display = 'flex';
                usernameContainer.style.flexDirection = 'column';
                signupMessageDiv.innerHTML = '';
            });

            // Provider (Google/GitHub/Microsoft) sign up listeners
            googleLoginBtn.addEventListener('click', () => handleProviderSignup(new GoogleAuthProvider()));
            githubLoginBtn.addEventListener('click', () => handleProviderSignup(new GithubAuthProvider()));
            microsoftLoginBtn.addEventListener('click', () => handleProviderSignup(new OAuthProvider('microsoft.com')));
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - LOGIN</title>
    <meta name="description" content="Log in to 4simpleproblems (4SP), the essential student toolkit.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS to mimic a modern, dark theme and use the Geist font */
        :root {
            --geist-foreground: 255, 255, 255;
            --geist-background: 0, 0, 0;
            --geist-accent-7: 156, 163, 175; /* gray-400 */
        }
        
        .dark {
            color-scheme: dark;
        }

        body {
            /* Applying Geist font */
            font-family: 'Geist', sans-serif;
        }
        
        /* Input Styling */
        input[type="email"], input[type="password"], input[type="text"] {
            background-color: rgb(24 24 27 / var(--tw-bg-opacity)); /* zinc-900 equivalent */
            border-color: rgb(39 39 42 / var(--tw-border-opacity)); /* zinc-800 equivalent */
        }
        
        /* Button Focus Ring */
        .login-btn:focus-visible {
            outline: 2px solid transparent;
            outline-offset: 2px;
            box-shadow: 0 0 0 2px #000000, 0 0 0 4px #0070f3; /* Black + Vercel Blue */
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen">
    <div id="navbar-container"></div>

    <main class="flex items-center justify-center min-h-[calc(100vh-64px)] py-12 px-4 sm:px-6 lg:px-8">
        <div class="w-full max-w-md space-y-8 rounded-xl p-8 bg-gray-900/50 backdrop-blur-md border border-gray-800 shadow-2xl">
            <div class="text-center">
                <h2 class="mt-6 text-3xl font-bold tracking-tight text-white">
                    Sign in to your account
                </h2>
                <p class="mt-2 text-sm text-gray-400">
                    Or <a href="signup.html" class="font-medium text-blue-400 hover:text-blue-300 transition">create a new one</a>
                </p>
            </div>
            
            <div id="status-message" class="hidden p-3 text-sm rounded-lg text-red-400 bg-red-900/30 border border-red-800/50"></div>

            <form class="mt-8 space-y-6" id="login-form">
                <input type="hidden" name="remember" value="true">
                <div class="-space-y-px rounded-md shadow-sm">
                    <div>
                        <label for="email-address" class="sr-only">Email address</label>
                        <input id="email-address" name="email" type="email" autocomplete="email" required 
                               class="relative block w-full appearance-none rounded-none rounded-t-lg border border-gray-700 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="Email address">
                    </div>
                    <div>
                        <label for="password" class="sr-only">Password</label>
                        <input id="password" name="password" type="password" autocomplete="current-password" required 
                               class="relative block w-full appearance-none rounded-none rounded-b-lg border border-gray-700 px-3 py-3 text-white placeholder-gray-500 focus:z-10 focus:border-blue-500 focus:ring-blue-500 sm:text-sm"
                               placeholder="Password">
                    </div>
                </div>

                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="remember-me" name="remember-me" type="checkbox" 
                               class="h-4 w-4 rounded border-gray-700 bg-gray-900 text-blue-500 focus:ring-blue-500">
                        <label for="remember-me" class="ml-2 block text-sm text-gray-400">
                            Remember me
                        </label>
                    </div>

                    <div class="text-sm">
                        <a href="#" id="forgot-password" class="font-medium text-blue-400 hover:text-blue-300 transition">
                            Forgot your password?
                        </a>
                    </div>
                </div>

                <div>
                    <button type="submit" id="login-button"
                            class="login-btn group relative flex w-full justify-center rounded-lg border border-transparent bg-blue-600 py-3 px-4 text-sm font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:ring-offset-gray-900 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                            <i class="fas fa-lock h-5 w-5 text-blue-300 group-hover:text-blue-200 transition"></i>
                        </span>
                        Sign in
                    </button>
                </div>
            </form>
            
            <div class="relative">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-700"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="bg-gray-900/50 backdrop-blur-sm px-2 text-gray-500">
                        Or continue with
                    </span>
                </div>
            </div>

            <div class="flex space-x-3">
                <button id="google-login-btn" type="button" class="login-btn w-full inline-flex justify-center rounded-lg border border-gray-700 bg-gray-800 py-3 text-sm font-medium text-white hover:bg-gray-700 transition">
                    <i class="fab fa-google h-5 w-5 mr-2"></i> Google
                </button>
                <button id="github-login-btn" type="button" class="login-btn w-full inline-flex justify-center rounded-lg border border-gray-700 bg-gray-800 py-3 text-sm font-medium text-white hover:bg-gray-700 transition">
                    <i class="fab fa-github h-5 w-5 mr-2"></i> GitHub
                </button>
                <button id="microsoft-login-btn" type="button" class="login-btn w-full inline-flex justify-center rounded-lg border border-gray-700 bg-gray-800 py-3 text-sm font-medium text-white hover:bg-gray-700 transition">
                    <i class="fab fa-microsoft h-5 w-5 mr-2"></i> Microsoft
                </button>
            </div>
        </div>
    </main>
    
    <script src="../navigation-mini.js"></script>

    <script type="module">
        // -------------------------------------------------------------
        // NEW: Get the global navigation function into the module's scope
        const initMiniNavigation = window.initMiniNavigation;
        // -------------------------------------------------------------
        
        // 1. IMPORT: Import your local configuration (Loads firebase-config.js)
        import { firebaseConfig } from '../firebase-config.js';

        // 2. IMPORT: Updated Firebase module imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, 
            signInWithPopup, GoogleAuthProvider, GithubAuthProvider, OAuthProvider, 
            onAuthStateChanged
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- GLOBAL SETUP ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app); 
        
        // -------------------------------------------------------------
        // NEW: Call the navigation initialization function, passing the auth object
        if (initMiniNavigation) {
            initMiniNavigation(auth);
        }
        // -------------------------------------------------------------
        
        // --- DOM Elements ---
        const loginForm = document.getElementById('login-form');
        const loginButton = document.getElementById('login-button');
        const forgotPasswordLink = document.getElementById('forgot-password');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const githubLoginBtn = document.getElementById('github-login-btn');
        const microsoftLoginBtn = document.getElementById('microsoft-login-btn');
        const statusMessage = document.getElementById('status-message');

        // --- Utility Functions ---
        function showStatus(message, isError = true) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden');
            // Toggle classes based on whether it's an error or success if needed
            if (isError) {
                statusMessage.classList.add('text-red-400', 'bg-red-900/30', 'border-red-800/50');
            }
        }

        function hideStatus() {
            statusMessage.classList.add('hidden');
        }

        function checkFormValidity() {
            if (loginForm.checkValidity()) {
                loginButton.disabled = false;
                loginButton.classList.remove('disabled:opacity-50', 'disabled:cursor-not-allowed');
            } else {
                loginButton.disabled = true;
                loginButton.classList.add('disabled:opacity-50', 'disabled:cursor-not-allowed');
            }
        }

        // Checks if user data exists in Firestore; redirects if successful
        async function checkAndRedirect(user) {
            if (!user) return; // Should not happen here, but for safety

            try {
                const userDocRef = doc(db, "users", user.uid);
                const userDoc = await getDoc(userDocRef);

                if (userDoc.exists()) {
                    console.log("User data exists. Redirecting to dashboard.");
                    window.location.href = '../logged-in/dashboard.html';
                } else {
                    // This means a new user was created via social login but Firestore setup failed,
                    // or a user signed up on the login page (shouldn't happen).
                    console.warn("User authenticated but missing Firestore data. Logging out.");
                    await auth.signOut();
                    showStatus("Account setup failed. Please contact support.", true);
                }
            } catch (error) {
                console.error("Error during login redirect/check:", error);
                await auth.signOut();
                showStatus("An error occurred during sign-in verification. Please try again.", true);
            }
        }

        // --- EVENT HANDLERS ---
        
        // Handle Email/Password Login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            hideStatus();
            
            const email = loginForm.elements['email'].value;
            const password = loginForm.elements['password'].value;
            
            loginButton.disabled = true;

            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                // checkAndRedirect will handle success and navigation
                await checkAndRedirect(userCredential.user);
            } catch (error) {
                let errorMessage = "Login failed.";
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                    errorMessage = "Invalid email or password.";
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = "Account locked due to too many failed attempts. Try again later.";
                }
                
                showStatus(errorMessage);
                console.error("Login Error:", error);

            } finally {
                loginButton.disabled = false;
            }
        });

        // Handle Forgot Password
        forgotPasswordLink.addEventListener('click', async (e) => {
            e.preventDefault();
            hideStatus();
            
            const email = loginForm.elements['email'].value;

            if (!email) {
                showStatus("Please enter your email in the field above to reset your password.", false);
                return;
            }
            
            try {
                await sendPasswordResetEmail(auth, email);
                showStatus(`Password reset link sent to ${email}! Check your inbox.`, false);
            } catch (error) {
                let errorMessage = "Password reset failed.";
                if (error.code === 'auth/user-not-found') {
                    errorMessage = `No user found with email: ${email}.`;
                }
                showStatus(errorMessage);
            }
        });

        // --- SOCIAL LOGINS ---
        async function handleSocialLogin(providerInstance, providerName) {
            hideStatus();
            try {
                const result = await signInWithPopup(auth, providerInstance);
                // checkAndRedirect will handle existing user logic and redirection
                await checkAndRedirect(result.user);
            } catch (error) {
                let errorMessage = `Login with ${providerName} failed.`;
                if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `You already have an account with this email. Please log in or use the original method.`;
                } else if (error.code === 'auth/popup-closed-by-user') {
                     errorMessage = `Login window closed. Please try again.`;
                } else if (error.code === 'auth/cancelled-popup-request') {
                     errorMessage = `The login popup was blocked or canceled.`;
                }
                console.error("Social Login Error:", error);
                showStatus(errorMessage);
            }
        }

        // EVENT LISTENERS: The original IDs are used here.
        if(googleLoginBtn) googleLoginBtn.addEventListener('click', () => handleSocialLogin(new GoogleAuthProvider(), 'Google'));
        if(githubLoginBtn) githubLoginBtn.addEventListener('click', () => handleSocialLogin(new GithubAuthProvider(), 'GitHub'));
        if(microsoftLoginBtn) microsoftLoginBtn.addEventListener('click', () => {
            const provider = new OAuthProvider('microsoft.com');
            // provider.setCustomParameters({ prompt: 'select_account' }); // Optional: Force account selection
            handleSocialLogin(provider, 'Microsoft');
        });

        // Initial form check
        loginForm.addEventListener('input', checkFormValidity);
        document.addEventListener('DOMContentLoaded', checkFormValidity);
    </script>
</body>
</html>

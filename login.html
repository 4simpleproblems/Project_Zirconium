<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - LOGIN</title>
    <meta name="description" content="Log in or automatically create an account to access 4simpleproblems.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS to mimic a modern, dark theme and use the Geist font */
        :root {
            --geist-foreground: 255, 255, 255;
            --geist-background: 0, 0, 0;
            --geist-accent-7: 156, 163, 175; /* gray-400 */
        }
        
        .dark {
            color-scheme: dark;
        }

        body {
            /* Applying Geist font */
            font-family: 'Geist', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background-color: rgb(var(--geist-background));
            color: rgb(var(--geist-foreground));
        }

        /* Utility class for primary button focus/hover effects */
        .btn-primary {
            transition: transform 0.1s, box-shadow 0.1s, background-color 0.1s;
        }
        .btn-primary:hover {
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.4); /* slate-500 shadow */
        }
        .btn-primary:active {
            transform: scale(0.98);
        }

        /* Main content styling */
        .auth-container {
            max-width: 448px;
            width: 90%;
            padding: 2.5rem;
            background-color: #0d0d0d;
            border: 1px solid #1a1a1a;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            margin-top: -6rem; /* Pull up to overlay the header slightly */
        }

        .input-field {
            background-color: #1a1a1a;
            border: 1px solid #333;
            color: white;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-field:focus {
            border-color: #64748b; /* slate-500 */
            outline: none;
            box-shadow: 0 0 0 2px rgba(100, 116, 139, 0.5);
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    
    <!-- The Mini Navigation Bar will be injected here by navigation-mini.js -->
    <div id="auth-navbar-container"></div>
    
    <main class="flex-grow flex items-center justify-center py-16 px-4">
        
        <div class="auth-container rounded-xl">
            <h1 class="text-3xl font-bold text-center mb-6">Welcome Back</h1>
            <p class="text-center text-gray-400 mb-8">Login with credentials or a provider below.</p>

            <form id="login-form" class="space-y-6">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">Username</label>
                    <input type="text" id="username" required 
                           class="input-field w-full p-3 rounded-lg"
                           placeholder="Enter your username"
                           minlength="4" maxlength="24">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" required 
                           class="input-field w-full p-3 rounded-lg"
                           placeholder="Enter your password"
                           minlength="8" maxlength="48">
                </div>

                <div id="error-message" class="text-red-400 text-sm hidden bg-red-900/30 p-3 rounded-lg border border-red-800"></div>

                <button type="submit" id="login-button" 
                        class="btn-primary w-full bg-slate-600 hover:bg-slate-500 text-white font-semibold py-3 rounded-lg text-lg flex items-center justify-center disabled:opacity-50">
                    <span id="button-text">Log In / Sign Up</span>
                    <i id="loading-spinner" class="fas fa-spinner fa-spin ml-3 hidden"></i>
                </button>
            </form>
            
            <!-- NEW: Social Login Separator and Buttons -->
            <div class="relative flex items-center py-5">
                <div class="flex-grow border-t border-gray-800"></div>
                <span class="flex-shrink mx-4 text-gray-500 text-sm font-medium">OR USE A SOCIAL ACCOUNT</span>
                <div class="flex-grow border-t border-gray-800"></div>
            </div>

            <div class="space-y-4">
                <button id="google-login-button" 
                        class="w-full flex items-center justify-center p-3 rounded-lg border border-gray-700 bg-white/5 text-white hover:bg-white/10 transition duration-150 btn-primary"
                        data-initial-text="Sign in with Google">
                    <i class="fab fa-google text-red-500 text-xl mr-3"></i>
                    Sign in with Google
                </button>
                <button id="github-login-button" 
                        class="w-full flex items-center justify-center p-3 rounded-lg border border-gray-700 bg-white/5 text-white hover:bg-white/10 transition duration-150 btn-primary"
                        data-initial-text="Sign in with GitHub">
                    <i class="fab fa-github text-white text-xl mr-3"></i>
                    Sign in with GitHub
                </button>
            </div>
            <!-- END NEW -->

            <p class="text-center text-gray-500 text-sm mt-6">
                New to 4SP? <a href="signup.html" class="text-slate-400 hover:text-slate-300 font-medium transition duration-150">Sign Up</a>
            </p>
        </div>
        
    </main>

    <footer class="border-t border-gray-900 py-6">
        <div class="mx-auto max-w-7xl px-4 text-center text-gray-500 text-sm">
            &copy; 2024 4simpleproblems (4SP). Built for students.
        </div>
    </footer>

    <script src="../navigation-mini.js"></script>
    
    <script type="module">
        // Global variables for Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig) {
            console.error("Firebase configuration not found.");
            document.getElementById('error-message').textContent = "Application setup error: Missing Firebase config.";
            document.getElementById('error-message').classList.remove('hidden');
        }

        // Import the new Firebase Modular SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            signInWithCustomToken,
            signInAnonymously,
            onAuthStateChanged,
            GoogleAuthProvider,
            GithubAuthProvider,
            signInWithPopup
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        setLogLevel('debug'); // Enable Firestore logs

        // Initialize Firebase
        let app, auth, db;
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        }

        // Access the global navigation function
        const initMiniNavigation = window.initMiniNavigation;
        if (initMiniNavigation) {
            initMiniNavigation(auth);
        }

        // --- Authentication & Firestore Logic ---
        
        const form = document.getElementById('login-form');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const errorDiv = document.getElementById('error-message');
        const loginButton = document.getElementById('login-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        
        // Social Login Buttons
        const googleLoginButton = document.getElementById('google-login-button');
        const githubLoginButton = document.getElementById('github-login-button');


        // Helper to show/hide loading state for the main form
        const toggleLoading = (isLoading) => {
            loginButton.disabled = isLoading;
            loadingSpinner.classList.toggle('hidden', !isLoading);
            buttonText.textContent = isLoading ? 'Processing...' : 'Log In / Sign Up';
            errorDiv.classList.add('hidden');
            // Disable social buttons while form login is active
            googleLoginButton.disabled = isLoading;
            githubLoginButton.disabled = isLoading;
        };
        
        // Helper to show error
        const showError = (message) => {
            errorDiv.textContent = message;
            errorDiv.classList.remove('hidden');
            // Ensure all states are reset when an error occurs
            toggleLoading(false); 
            toggleSocialButtonLoading(googleLoginButton, false);
            toggleSocialButtonLoading(githubLoginButton, false);
        };
        
        // Helper to manage loading state for social buttons
        const toggleSocialButtonLoading = (button, isLoading) => {
            if (!button) return;
            const initialText = button.dataset.initialText || 'Sign in';
            button.disabled = isLoading;
            button.classList.toggle('opacity-50', isLoading);
            if (isLoading) {
                // Store initial text if not already stored
                if (!button.dataset.initialText) button.dataset.initialText = button.textContent.trim();
                // Find and keep the icon, but change the text
                const icon = button.querySelector('i')?.outerHTML || '';
                button.innerHTML = `<i class="fas fa-spinner fa-spin mr-3"></i> Connecting...`;
            } else {
                // Restore original text and icon
                button.innerHTML = button.dataset.initialText === 'Sign in with Google' 
                    ? '<i class="fab fa-google text-red-500 text-xl mr-3"></i> Sign in with Google'
                    : '<i class="fab fa-github text-white text-xl mr-3"></i> Sign in with GitHub';
            }
        };
        
        // Helper to create a user profile in Firestore
        const createFirestoreProfile = async (user, username = null) => {
            if (!db || !user) {
                console.error("Cannot create profile: Missing DB or user data.");
                return;
            }
            
            // Derive username for social/auto-signup if not explicitly passed
            let finalUsername = username;
            if (!finalUsername) {
                // Use display name, or the part of email before @, or a default user ID
                finalUsername = user.displayName || user.email?.split('@')[0] || ('user' + user.uid.substring(0, 8));
                // Sanitize derived username to be alphanumeric for safety
                finalUsername = finalUsername.replace(/[^a-zA-Z0-9]/g, ''); 
                if (finalUsername.length < 4) finalUsername = 'user' + user.uid.substring(0, 4);
            }
            
            try {
                // Private data path: /artifacts/{appId}/users/{userId}/users/profile
                const userProfileRef = doc(db, `artifacts/${appId}/users/${user.uid}/users`, 'profile');
                await setDoc(userProfileRef, {
                    username: finalUsername,
                    email: user.email || 'N/A',
                    provider: user.providerData[0]?.providerId || 'password',
                    createdAt: Date.now()
                });
                console.log("Firestore profile created successfully for user:", finalUsername);
            } catch (e) {
                console.error("Error adding document to Firestore:", e);
            }
        };

        // Check auth status and redirect if already logged in
        onAuthStateChanged(auth, async (user) => {
            if (user && !user.isAnonymous) {
                window.location.href = 'index.html'; 
            } else if (user && user.isAnonymous) {
                await auth.signOut();
            } else if (!user && initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in failed, proceeding with form:", error);
                }
            } else if (!user) {
                try {
                     await signInAnonymously(auth);
                } catch (error) {
                    console.error("Anonymous sign-in failed:", error);
                }
            }
        });

        
        // --- NEW: Social Login Handler ---

        const handleSocialLogin = async (provider, button) => {
            if (!auth) return showError("Firebase not initialized.");

            toggleSocialButtonLoading(button, true);

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const additionalUserInfo = result.additionalUserInfo;

                if (additionalUserInfo && additionalUserInfo.isNewUser) {
                    // Only create the profile document if it's a brand new user
                    await createFirestoreProfile(user); 
                }
                
                console.log("Social login successful!");
                window.location.href = 'index.html';

            } catch (error) {
                let errorMessage = "Social login failed.";
                if (error.code === 'auth/popup-closed-by-user') {
                    errorMessage = "Login cancelled: The pop-up window was closed.";
                } else if (error.code === 'auth/account-exists-with-different-credential') {
                    errorMessage = "An account already exists with this email address using a different login method. Please use that method to sign in.";
                } else {
                    errorMessage = `Login failed: ${error.message}`;
                }
                showError(errorMessage);
            } finally {
                toggleSocialButtonLoading(button, false);
            }
        };

        // --- Event Listeners ---

        // Google Login
        googleLoginButton.addEventListener('click', (e) => {
            e.preventDefault();
            const provider = new GoogleAuthProvider();
            handleSocialLogin(provider, googleLoginButton);
        });

        // GitHub Login
        githubLoginButton.addEventListener('click', (e) => {
            e.preventDefault();
            const provider = new GithubAuthProvider();
            handleSocialLogin(provider, githubLoginButton);
        });
        
        // Form submission handler (existing logic)
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            toggleLoading(true);

            const username = usernameInput.value.trim();
            const password = passwordInput.value;
            // Firebase Auth requires an email format, so we append a fixed domain
            const email = `${username}@4sp.com`;

            if (username.length < 4 || username.length > 24) {
                 showError("Username must be between 4 and 24 characters.");
                 return;
            }

            try {
                // 1. Attempt to log in with the provided credentials
                await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful!");
                window.location.href = 'index.html';

            } catch (loginError) {
                // 2. If login fails, check if the error indicates "user-not-found"
                if (loginError.code === 'auth/user-not-found') {
                    console.log("User not found. Attempting automatic sign-up...");
                    
                    try {
                        // 3. Attempt to create the new account (auto sign-up)
                        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                        
                        // 4. Create the Firestore profile
                        await createFirestoreProfile(userCredential.user, username);
                        
                        console.log("Auto Sign-Up successful!");
                        window.location.href = 'index.html';

                    } catch (signupError) {
                        // 5. Handle sign-up specific errors (e.g., weak password, invalid email format)
                        let errorMessage = "Sign up failed.";
                        if (signupError.code === 'auth/weak-password') {
                            errorMessage = "Password is too weak. Must be at least 6 characters.";
                        } else if (signupError.code === 'auth/email-already-in-use') {
                             errorMessage = "Account already exists (internal error: try logging in again).";
                        } else {
                            errorMessage = `Sign up failed: ${signupError.message}`;
                        }
                        showError(errorMessage);
                    }

                } else if (loginError.code === 'auth/wrong-password') {
                    showError("Invalid username or password.");
                } else if (loginError.code === 'auth/invalid-email') {
                    showError("Invalid username format (should be text).");
                } else {
                    showError(`Login failed: ${loginError.message}`);
                }
            } finally {
                toggleLoading(false);
            }
        });

        // Attach event listeners for input validation feedback
        const validateInput = (input) => {
            if (input.validity.tooShort) {
                input.setCustomValidity(`Must be at least ${input.minLength} characters.`);
            } else if (input.validity.tooLong) {
                input.setCustomValidity(`Must be at most ${input.maxLength} characters.`);
            } else {
                input.setCustomValidity('');
            }
        };

        usernameInput.addEventListener('input', () => validateInput(usernameInput));
        passwordInput.addEventListener('input', () => validateInput(passwordInput));

    </script>
</body>
</html>

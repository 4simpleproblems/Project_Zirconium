<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - LOGIN</title>
    <meta name="description" content="Log in to 4simpleproblems (4SP), the essential student toolkit.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS to mimic a modern, dark theme and use the Geist font */
        :root {
            --geist-foreground: 255, 255, 255;
            --geist-background: 0, 0, 0;
            --geist-accent-7: 156, 163, 175; /* gray-400 */
        }
        
        .dark {
            color-scheme: dark;
        }

        body {
            /* Applying Geist font */
            font-family: 'Geist', sans-serif;
        }
        
        /* Input Styling */
        input[type="email"], input[type="password"], input[type="text"] {
            background-color: #1a1a1a; /* Darker background */
            border: 1px solid #374151; /* gray-700 */
            color: #ffffff;
        }
        /* Strict Grey Focus: Removed the pink/blue focus tint */
        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus {
            border-color: #4b5563; /* gray-600 */
            outline: none;
            box-shadow: 0 0 0 1px #4b5563; 
        }

        /* Pure Grey Button Style */
        .pure-grey-button {
            background-color: rgba(255, 255, 255, 0.1); /* white/10 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* white/20 */
            transition: all 0.2s ease;
        }
        .pure-grey-button:hover {
            background-color: rgba(255, 255, 255, 0.2); /* white/20 */
        }
        .pure-grey-button:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        /* Wide Frame Styling */
        .login-frame {
            max-width: 56rem; /* Tailwind 'max-w-4xl' equivalent */
        }

        /* Divider Visibility for Wide Layout */
        .lg-hidden-divider {
            display: block; /* Default for mobile/smaller screens */
        }
        @media (min-width: 1024px) {
            .lg-hidden-divider {
                display: none; /* Hidden on large screens */
            }
        }
        
        /* Custom style for the grey links in the disclaimer */
        .disclaimer-link {
            color: #d1d5db; /* gray-300 */
            text-decoration: underline;
            transition: color 0.15s;
        }
        .disclaimer-link:hover {
            color: #ffffff; /* white */
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">

    <div id="navbar-container"></div>
    <main class="flex-grow flex items-center justify-center py-12">
        <div class="w-full max-w-4xl p-6 sm:p-8 bg-gray-900/50 backdrop-blur-md rounded-2xl border border-gray-800 shadow-2xl login-frame">
            
            <h1 class="text-3xl font-semibold text-center mb-1">
                Welcome Back
            </h1>
            <p class="text-center text-gray-400 mb-8">
                Log in to access your essential student toolkit.
            </p>

            <div id="status-message" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>

            <div class="lg:grid lg:grid-cols-2 lg:gap-10">

                <div>
                    <h2 class="text-xl font-medium mb-4 text-center lg:text-left text-gray-300">Quick Access</h2>
                    <div class="space-y-3 mb-4">
                        <button id="google-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <!-- Placeholder image URL, replace with your actual Google icon path -->
                            <img src="https://placehold.co/20x20/ffffff/000000?text=G" alt="Google Logo" class="w-5 h-5 mr-3 rounded-full">
                            Log in with Google
                        </button>
                        <button id="github-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                             <!-- Placeholder image URL, replace with your actual GitHub icon path -->
                            <img src="https://placehold.co/20x20/000000/ffffff?text=GH" alt="GitHub Logo" class="w-5 h-5 mr-3">
                            Log in with GitHub
                        </button>
                        <button id="microsoft-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <!-- Placeholder image URL, replace with your actual Microsoft icon path -->
                            <img src="https://placehold.co/20x20/0078D4/ffffff?text=MS" alt="Microsoft Logo" class="w-5 h-5 mr-3">
                            Log in with Microsoft
                        </button>
                    </div>

                    <p class="text-xs text-gray-500 italic text-center mb-6">
                        By logging in or using the platform, you agree to our 
                        <a href="legal.html#terms" class="disclaimer-link">Terms of Service</a> 
                        and 
                        <a href="legal.html#privacy" class="disclaimer-link">Privacy Policy</a>.
                    </p>
                    <div class="flex items-center mb-6 lg-hidden-divider">
                        <div class="flex-grow border-t border-gray-700"></div>
                        <span class="flex-shrink mx-4 text-gray-500 text-sm">or</span>
                        <div class="flex-grow border-t border-gray-700"></div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-medium mb-4 text-center lg:text-left text-gray-300">Email & Password</h2>
                    
                    <form id="email-login-form" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                            <input type="email" id="email" required autocomplete="email"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="you@example.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                            <input type="password" id="password" required autocomplete="current-password"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="••••••••">
                        </div>

                        <div class="pt-2">
                            <button type="submit" id="login-button"
                                    class="pure-grey-button w-full px-4 py-3 text-base font-medium rounded-xl text-white focus:outline-none focus:ring-2">
                                Log In
                            </button>
                        </div>
                    </form>

                    <div class="mt-4 text-center lg:text-left">
                        <button id="forgot-password-toggle" class="text-sm text-gray-400 hover:text-white transition duration-150">
                            Forgot your password?
                        </button>
                    </div>
                    
                    <div id="forgot-password-area" class="mt-4 p-4 border border-gray-700 rounded-xl hidden">
                        <h3 class="text-lg font-medium mb-3">Reset Password</h3>
                        <form id="forgot-password-form" class="space-y-3">
                            <div>
                                <label for="reset-email" class="block text-sm font-medium text-gray-400 mb-1">Enter your email</label>
                                <input type="email" id="reset-email" required
                                       class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                       placeholder="you@example.com">
                            </div>
                            <button type="submit"
                                    class="pure-grey-button w-full px-4 py-2 text-sm font-medium rounded-xl text-white focus:outline-none focus:ring-2">
                                Send Reset Link
                            </button>
                        </form>
                    </div>
                </div>
                </div>
            <p class="mt-8 text-center text-sm text-gray-400">
                Don't have an account? 
                <a href="signup.html" class="font-medium text-gray-300 hover:text-white transition duration-150">
                    Sign Up here
                </a>
            </p>
        </div>
    </main>

    <footer class="border-t border-gray-900 py-6">
        <div class="mx-auto max-w-7xl px-4 text-center text-gray-500 text-sm">
            &copy; 2024 4simpleproblems (4SP). Built for students.
        </div>
    </footer>
    
    <script src="navigation-mini.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            signInWithEmailAndPassword, sendPasswordResetEmail, signInWithPopup, 
            GoogleAuthProvider, GithubAuthProvider, OAuthProvider 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, serverTimestamp, setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP (Canvas Mandated) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        let userId = null;
        let isAuthReady = false;

        // Initial Authentication and Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // If a user is already signed in (from a previous session or token), redirect them.
                if (window.location.pathname.endsWith('login.html')) {
                    // Check if email is verified (only relevant for email/password users)
                    if (user.emailVerified || user.providerData.some(p => p.providerId !== 'password')) {
                         window.location.href = '../logged-in/dashboard.html';
                    } else if (user.email && user.providerData.some(p => p.providerId === 'password')) {
                         // Email/password user not verified
                         window.location.href = 'verify.html';
                    }
                }
            } else {
                // Use the custom token if provided, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined') {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch(e) {
                        console.error("Custom token sign in failed. Signing in anonymously.", e);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            }
            userId = auth.currentUser?.uid || crypto.randomUUID();
            isAuthReady = true;
        });


        /**
         * Checks if a user's Firestore document exists and creates it if not.
         * This function is crucial for creating the user dataset upon login/signup.
         */
        async function checkAndCreateUserDataset(user, provider, username = null) {
            if (!isAuthReady) {
                // Simple wait mechanism to ensure auth context is available
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            const uid = user.uid;
            // Canvas Private Data Path: /artifacts/{appId}/users/{userId}/user_data/profile_details
            const userRef = doc(db, `artifacts/${appId}/users/${uid}/user_data/profile_details`);
            
            try {
                const docSnap = await getDoc(userRef);
                
                if (!docSnap.exists()) {
                    // Determine username: explicit input > provider display name > email prefix > fallback
                    const finalUsername = username 
                        || user.displayName 
                        || (user.email ? user.email.split('@')[0] : 'user_' + uid.substring(0, 8));
                        
                    await setDoc(userRef, {
                        username: finalUsername,
                        email: user.email || 'N/A',
                        authenticationMethod: provider,
                        // Auth users (Google/GitHub/MS) are implicitly verified, email/password users have user.emailVerified status
                        isVerified: user.emailVerified || (provider !== 'Email/Password'), 
                        creationDate: serverTimestamp(),
                    }, { merge: true });

                    console.log(`User data created/checked for ${uid} via ${provider}.`);
                }

                // Redirect logic
                if (user.emailVerified || (provider !== 'Email/Password')) {
                     window.location.href = '../logged-in/dashboard.html';
                } else {
                     // If email/password login and not verified, redirect to verification page
                     window.location.href = 'verify.html';
                }
                
                return true;

            } catch (error) {
                console.error("Error with user data initialization:", error);
                throw new Error("An error occurred during user data creation/check.");
            }
        }
        window.checkAndCreateUserDataset = checkAndCreateUserDataset; // Expose for signup.html if needed

        // --- UI ELEMENTS ---
        const emailLoginForm = document.getElementById('email-login-form');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const statusMessage = document.getElementById('status-message');
        const googleLoginBtn = document.getElementById('google-login');
        const githubLoginBtn = document.getElementById('github-login');
        const microsoftLoginBtn = document.getElementById('microsoft-login');
        const forgotPasswordToggle = document.getElementById('forgot-password-toggle');
        const forgotPasswordArea = document.getElementById('forgot-password-area');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const resetEmailInput = document.getElementById('reset-email');
        const loginButton = document.getElementById('login-button');

        // --- UTILITY FUNCTIONS ---
        function showStatus(message, type = 'error') {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'bg-red-900/50', 'text-red-300', 'bg-green-900/50', 'text-green-300');
            if (type === 'success') {
                statusMessage.classList.add('bg-green-900/50', 'text-green-300');
            } else {
                statusMessage.classList.add('bg-red-900/50', 'text-red-300');
            }
        }
        function hideStatus() {
             statusMessage.classList.add('hidden');
        }
        function toggleLoginButton(isDisabled) {
            loginButton.disabled = isDisabled;
            loginButton.textContent = isDisabled ? 'Logging In...' : 'Log In';
        }

        // --- EMAIL/PASSWORD LOGIN ---
        if (emailLoginForm) {
            emailLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideStatus();
                toggleLoginButton(true);
                
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                if (!email || !password) {
                    showStatus("Please enter both email and password.");
                    toggleLoginButton(false);
                    return;
                }

                try {
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    await checkAndCreateUserDataset(userCredential.user, 'Email/Password');
                    
                } catch (error) {
                    let errorMessage = "Login failed. Please check your credentials.";
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                        errorMessage = "Invalid email or password.";
                    } else if (error.code === 'auth/too-many-requests') {
                        errorMessage = "Account temporarily locked due to too many failed login attempts. Try again later.";
                    }
                    showStatus(errorMessage);
                    toggleLoginButton(false);
                }
            });
        }


        // --- SOCIAL LOGINS ---
        async function handleSocialLogin(providerInstance, providerName) {
            hideStatus();
            try {
                // Use sign-in-with-popup for providers
                const result = await signInWithPopup(auth, providerInstance);
                await checkAndCreateUserDataset(result.user, providerName);
            } catch (error) {
                let errorMessage = `Login with ${providerName} failed.`;
                if (error.code === 'auth/account-exists-with-different-credential') {
                     errorMessage = `You already have an account with this email, but used a different login method. Please log in using the original method.`;
                } else if (error.code === 'auth/popup-closed-by-user') {
                     errorMessage = `Login window closed. Please try again.`;
                }
                showStatus(errorMessage);
            }
        }

        if(googleLoginBtn) googleLoginBtn.addEventListener('click', () => handleSocialLogin(new GoogleAuthProvider(), 'Google'));
        // Note: The OAuthProvider for Microsoft is defined here using the full provider ID.
        if(microsoftLoginBtn) microsoftLoginBtn.addEventListener('click', () => handleSocialLogin(new OAuthProvider('microsoft.com'), 'Microsoft'));
        if(githubLoginBtn) githubLoginBtn.addEventListener('click', () => handleSocialLogin(new GithubAuthProvider(), 'GitHub'));


        // --- FORGOT PASSWORD ---
        if(forgotPasswordToggle) {
            forgotPasswordToggle.addEventListener('click', () => {
                forgotPasswordArea.classList.toggle('hidden');
                if (!forgotPasswordArea.classList.contains('hidden')) {
                     resetEmailInput.focus();
                }
            });
        }

        if(forgotPasswordForm) {
            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideStatus();
                const email = resetEmailInput.value.trim();

                if (!email) {
                    showStatus("Please enter your email to reset your password.");
                    return;
                }

                try {
                    await sendPasswordResetEmail(auth, email);
                    showStatus(`A password reset link has been sent to ${email}. Check your spam folder!`, 'success');
                    forgotPasswordArea.classList.add('hidden');
                } catch (error) {
                    let errorMessage = "Failed to send reset email.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No user found with that email.";
                    }
                    showStatus(errorMessage);
                }
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4SP - Login</title>
    <meta name="description" content="Log in to 4simpleproblems (4SP), the essential student toolkit.">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Geist:wght@100..900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Custom CSS to mimic a modern, dark theme and use the Geist font */
        :root {
            --geist-foreground: 255, 255, 255;
            --geist-background: 0, 0, 0;
            --geist-accent-7: 156, 163, 175; /* gray-400 */
        }
        
        .dark {
            color-scheme: dark;
        }

        body {
            /* Applying Geist font */
            font-family: 'Geist', sans-serif;
        }
        
        /* Gradient Text (Retained for consistency, though not used in login form) */
        .gradient-text {
            background-image: linear-gradient(90deg, #0070f3, #f81ce5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Input Styling */
        input[type="email"], input[type="password"], input[type="text"] {
            background-color: #1a1a1a; /* Darker background */
            border: 1px solid #374151; /* gray-700 */
            color: #ffffff;
        }
        /* Strict Grey Focus: Removed the pink/blue focus tint */
        input[type="email"]:focus, input[type="password"]:focus, input[type="text"]:focus {
            border-color: #4b5563; /* gray-600 */
            outline: none;
            box-shadow: 0 0 0 1px #4b5563; 
        }

        /* Pure Grey Button Style (Replaces all blue/gradient buttons) */
        .pure-grey-button {
            background-color: rgba(255, 255, 255, 0.1); /* white/10 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* white/20 */
            transition: all 0.2s ease;
        }
        .pure-grey-button:hover {
            background-color: rgba(255, 255, 255, 0.2); /* white/20 */
        }
        .pure-grey-button:focus {
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }

        /* Wide Frame Styling */
        .login-frame {
            max-width: 56rem; /* Tailwind 'max-w-4xl' equivalent */
        }

        /* Divider Visibility for Wide Layout */
        .lg-hidden-divider {
            display: block; /* Default for mobile/smaller screens */
        }
        @media (min-width: 1024px) {
            .lg-hidden-divider {
                display: none; /* Hidden on large screens */
            }
        }
        /* Custom style for the grey links in the disclaimer */
        .disclaimer-link {
            color: #d1d5db; /* gray-300 */
            text-decoration: underline;
            transition: color 0.15s;
        }
        .disclaimer-link:hover {
            color: #ffffff; /* white */
        }
        
        /* --- AUTH MENU STYLES (FROM index.html) --- */
        .auth-menu-container {
            /* This is where the magic happens for the morph effect visualization */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
            transform-origin: top right;
        }
        
        .auth-menu-container.open {
            opacity: 1;
            /* Simple scale/translate to give it a smooth drop-down feel */
            transform: translateY(0) scale(1);
        }

        .auth-menu-container.closed {
            opacity: 0;
            pointer-events: none;
            transform: translateY(-10px) scale(0.95);
        }
        /* --- END AUTH MENU STYLES --- */

    </style>
</head>
<body class="bg-black text-white min-h-screen flex flex-col">

    <header class="sticky top-0 z-50 backdrop-blur-md bg-black/80 border-b border-gray-900">
        <nav class="h-16 flex items-center justify-between px-4">
            <a href="index.html" class="flex items-center space-x-2">
                <picture>
                    <source srcset="../images/logo.png" media="(prefers-color-scheme: dark)">
                    <img src="../images/logo.png" alt="4simpleproblems Logo" class="h-8 w-auto">
                </picture>
            </a>
            
            <div class="relative">
                <button 
                    id="auth-toggle"
                    aria-expanded="false"
                    aria-controls="auth-menu-container"
                    class="w-8 h-8 rounded-full border border-white flex items-center justify-center bg-black/50 hover:bg-gray-900/50 transition-colors duration-200 focus:outline-none focus:ring-1 focus:ring-white"
                >
                    <i class="fas fa-user text-white text-base"></i>
                </button>
                
                <div 
                    id="auth-menu-container" 
                    class="auth-menu-container closed absolute right-0 top-10 w-40 p-2 rounded-xl bg-black/70 backdrop-blur-lg border border-gray-800 shadow-xl"
                >
                    <a href="login.html" class="block px-3 py-2 text-sm font-normal text-white hover:bg-gray-800 rounded-lg transition-colors">
                        Login
                    </a>
                    <a href="signup.html" class="block px-3 py-2 text-sm font-normal text-white hover:bg-gray-800 rounded-lg transition-colors mt-1">
                        Sign Up
                    </a>
                </div>
            </div>
        </nav>
    </header>
    <main class="flex-grow flex items-center justify-center py-12">
        <div class="w-full max-w-4xl p-6 sm:p-8 bg-gray-900/50 backdrop-blur-md rounded-2xl border border-gray-800 shadow-2xl login-frame">
            
            <h1 class="text-3xl font-semibold text-center mb-1">
                Welcome Back
            </h1>
            <p class="text-center text-gray-400 mb-8">
                Log in to access your essential student toolkit.
            </p>

            <div id="status-message" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>

            <div class="lg:grid lg:grid-cols-2 lg:gap-10">

                <div>
                    <h2 class="text-xl font-medium mb-4 text-center lg:text-left text-gray-300">Quick Access</h2>
                    <div class="space-y-3 mb-4">
                        <button id="google-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <img src="../images/google-icon.png" alt="Google Logo" class="w-5 h-5 mr-3">
                            Log in with Google
                        </button>
                        <button id="github-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <img src="../images/github-mark-white.png" alt="GitHub Logo" class="w-5 h-5 mr-3">
                            Log in with GitHub
                        </button>
                        <button id="microsoft-login" class="w-full flex items-center justify-center p-3 border border-gray-700 rounded-xl text-white hover:bg-gray-800 transition duration-200">
                            <img src="../images/microsoft.png" alt="Microsoft Logo" class="w-5 h-5 mr-3">
                            Log in with Microsoft
                        </button>
                    </div>

                    <p class="text-xs text-gray-500 italic text-center mb-6">
                        By logging in or using the platform, you agree to our 
                        <a href="legal.html#terms" class="disclaimer-link">Terms of Service</a> 
                        and 
                        <a href="legal.html#privacy" class="disclaimer-link">Privacy Policy</a>.
                    </p>
                    <div class="flex items-center mb-6 lg-hidden-divider">
                        <div class="flex-grow border-t border-gray-700"></div>
                        <span class="flex-shrink mx-4 text-gray-500 text-sm">or</span>
                        <div class="flex-grow border-t border-gray-700"></div>
                    </div>
                </div>

                <div>
                    <h2 class="text-xl font-medium mb-4 text-center lg:text-left text-gray-300">Email & Password</h2>
                    
                    <form id="email-login-form" class="space-y-4">
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-300 mb-1">Email Address</label>
                            <input type="email" id="email" required autocomplete="email"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="you@example.com">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                            <input type="password" id="password" required autocomplete="current-password"
                                   class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                   placeholder="••••••••">
                        </div>

                        <div class="pt-2">
                            <button type="submit" id="login-button"
                                    class="pure-grey-button w-full px-4 py-3 text-base font-medium rounded-xl text-white focus:outline-none focus:ring-2">
                                Log In
                            </button>
                        </div>
                    </form>

                    <div class="mt-4 text-center lg:text-left">
                        <button id="forgot-password-toggle" class="text-sm text-gray-400 hover:text-white transition duration-150">
                            Forgot your password?
                        </button>
                    </div>
                    
                    <div id="forgot-password-area" class="mt-4 p-4 border border-gray-700 rounded-xl hidden">
                        <h3 class="text-lg font-medium mb-3">Reset Password</h3>
                        <form id="forgot-password-form" class="space-y-3">
                            <div>
                                <label for="reset-email" class="block text-sm font-medium text-gray-400 mb-1">Enter your email</label>
                                <input type="email" id="reset-email" required
                                       class="w-full px-4 py-3 rounded-xl focus:ring-1 transition duration-150"
                                       placeholder="you@example.com">
                            </div>
                            <button type="submit"
                                    class="pure-grey-button w-full px-4 py-2 text-sm font-medium rounded-xl text-white focus:outline-none focus:ring-2">
                                Send Reset Link
                            </button>
                        </form>
                    </div>
                </div>
                </div>
            <p class="mt-8 text-center text-sm text-gray-400">
                Don't have an account? 
                <a href="signup.html" class="font-medium text-gray-300 hover:text-white transition duration-150">
                    Sign Up here
                </a>
            </p>
        </div>
    </main>

    <footer class="border-t border-gray-900 py-6">
        <div class="mx-auto max-w-7xl px-4 text-center text-gray-500 text-sm">
            &copy; 2024 4simpleproblems (4SP). Built for students.
        </div>
    </footer>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="../firebase-config.js"></script>

    <script>
        // --- Header Dropdown Logic (From index.html) ---
        document.addEventListener('DOMContentLoaded', () => {
            const toggleButton = document.getElementById('auth-toggle');
            const menuContainer = document.getElementById('auth-menu-container');

            if (toggleButton && menuContainer) {
                toggleButton.addEventListener('click', () => {
                    const isExpanded = toggleButton.getAttribute('aria-expanded') === 'true';
                    
                    toggleButton.setAttribute('aria-expanded', String(!isExpanded));
                    
                    if (isExpanded) {
                        menuContainer.classList.remove('open');
                        menuContainer.classList.add('closed');
                    } else {
                        menuContainer.classList.remove('closed');
                        menuContainer.classList.add('open');
                    }
                });

                document.addEventListener('click', (event) => {
                    if (!menuContainer.contains(event.target) && !toggleButton.contains(event.target)) {
                        if (toggleButton.getAttribute('aria-expanded') === 'true') {
                            toggleButton.setAttribute('aria-expanded', 'false');
                            menuContainer.classList.remove('open');
                            menuContainer.classList.add('closed');
                        }
                    }
                });
            }
            
            // Initialize Firebase services and attach event listeners once DOM is ready
            initializeAuthLogic();
        });
        
        // Function wrapping the Firebase/Auth logic to be called after DOMContentLoaded
        function initializeAuthLogic() {
            // Check if firebase is defined (requires firebase-config.js to be loaded)
            if (typeof firebase === 'undefined') {
                console.error("Firebase is not loaded. Please ensure firebase-config.js is correctly linked and configured.");
                return;
            }

            const auth = firebase.auth();
            const db = firebase.firestore();

            // UI elements
            const emailLoginForm = document.getElementById('email-login-form');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const statusMessage = document.getElementById('status-message');
            const googleLoginBtn = document.getElementById('google-login');
            const githubLoginBtn = document.getElementById('github-login');
            const microsoftLoginBtn = document.getElementById('microsoft-login');
            const forgotPasswordToggle = document.getElementById('forgot-password-toggle');
            const forgotPasswordArea = document.getElementById('forgot-password-area');
            const forgotPasswordForm = document.getElementById('forgot-password-form');
            const resetEmailInput = document.getElementById('reset-email');
            const loginButton = document.getElementById('login-button');

            // Utility function to display status/error messages
            function showStatus(message, type = 'error') {
                statusMessage.textContent = message;
                statusMessage.classList.remove('hidden', 'bg-red-900/50', 'text-red-300', 'bg-green-900/50', 'text-green-300');
                
                // Error/Success colors use red/green for semantic meaning.
                if (type === 'success') {
                    statusMessage.classList.add('bg-green-900/50', 'text-green-300');
                } else {
                    statusMessage.classList.add('bg-red-900/50', 'text-red-300');
                }
            }

            function hideStatus() {
                 statusMessage.classList.add('hidden');
            }

            function toggleLoginButton(isDisabled) {
                loginButton.disabled = isDisabled;
                loginButton.textContent = isDisabled ? 'Logging In...' : 'Log In';
            }

            /**
             * Checks if a user's Firestore document exists and creates it if not.
             * @param {firebase.User} user - The authenticated Firebase user.
             * @param {string} provider - The authentication method used (e.g., 'Email/Password', 'Google').
             */
            async function checkAndCreateUserDataset(user, provider) {
                const userRef = db.collection('users').doc(user.uid);
                
                try {
                    const doc = await userRef.get();
                    
                    if (!doc.exists) {
                        // User exists in Auth but not in Firestore - create dataset
                        await userRef.set({
                            username: user.displayName || user.email.split('@')[0], // Use display name or part of email
                            email: user.email,
                            authenticationMethod: provider,
                            creationDate: firebase.firestore.FieldValue.serverTimestamp(),
                        });
                        console.log("New user dataset created successfully in Firestore.");
                    }
                    
                    // Redirect on success
                    window.location.href = '../logged-in/soundboard.html'; // Assuming this is the main app page

                } catch (error) {
                    console.error("Error checking or creating user dataset:", error);
                    showStatus("An error occurred with user data initialization. Please try again.");
                    await auth.signOut();
                }
            }
            
            // --- Email/Password Login ---
            emailLoginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideStatus();
                toggleLoginButton(true);
                
                const email = emailInput.value.trim();
                const password = passwordInput.value;

                if (!email || !password) {
                    showStatus("Please enter both email and password.");
                    toggleLoginButton(false);
                    return;
                }

                try {
                    const userCredential = await auth.signInWithEmailAndPassword(email, password);
                    const user = userCredential.user;
                    
                    await checkAndCreateUserDataset(user, 'Email/Password');
                    
                } catch (error) {
                    let errorMessage = "Login failed. Please check your credentials.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No account found with this email. Please sign up.";
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = "Incorrect password. Please try again.";
                    }
                    showStatus(errorMessage);
                    toggleLoginButton(false);
                }
            });

            // --- Social Logins ---
            async function handleSocialLogin(providerInstance, providerName) {
                hideStatus();
                try {
                    const result = await auth.signInWithPopup(providerInstance);
                    const user = result.user;
                    await checkAndCreateUserDataset(user, providerName);
                } catch (error) {
                    let errorMessage = `Login with ${providerName} failed: ${error.message}`;
                    if (error.code === 'auth/account-exists-with-different-credential') {
                         errorMessage = `You already have an account with this email. Please log in using the original method.`;
                    }
                    showStatus(errorMessage);
                    console.error(`${providerName} login error:`, error);
                }
            }

            googleLoginBtn.addEventListener('click', () => handleSocialLogin(new firebase.auth.GoogleAuthProvider(), 'Google'));
            githubLoginBtn.addEventListener('click', () => handleSocialLogin(new firebase.auth.GithubAuthProvider(), 'GitHub'));
            microsoftLoginBtn.addEventListener('click', () => handleSocialLogin(new firebase.auth.OAuthProvider('microsoft.com'), 'Microsoft'));

            // --- Forgot Password ---
            forgotPasswordToggle.addEventListener('click', () => {
                forgotPasswordArea.classList.toggle('hidden');
                if (!forgotPasswordArea.classList.contains('hidden')) {
                     resetEmailInput.focus();
                }
            });

            forgotPasswordForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                hideStatus();
                const email = resetEmailInput.value.trim();

                if (!email) {
                    showStatus("Please enter your email to reset your password.");
                    return;
                }

                try {
                    await auth.sendPasswordResetEmail(email);
                    showStatus(`A password reset link has been sent to ${email}. Check your spam folder!`, 'success');
                    forgotPasswordArea.classList.add('hidden'); // Hide on success
                } catch (error) {
                    let errorMessage = "Failed to send reset email.";
                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "No user found with that email.";
                    }
                    showStatus(errorMessage);
                }
            });
            
            // --- Auth State Listener to Handle Existing Sessions ---
            auth.onAuthStateChanged(user => {
                if (user) {
                    // If the user is signed in, redirect them to the main app page.
                    window.location.href = '../logged-in/soundboard.html';
                }
            });
        }
    </script>
</body>
</html>
